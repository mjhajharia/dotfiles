{"version":3,"file":"annotator.bundle.js","sources":["app:///node_modules/focus-visible/dist/focus-visible.js","app:///src/shared/listener-collection.ts","app:///src/shared/random.js","app:///src/shared/messaging/port-util.js","app:///src/shared/messaging/port-finder.js","app:///node_modules/tiny-emitter/index.js","app:///src/shared/frame-error-capture.js","app:///src/shared/messaging/port-provider.js","app:///src/shared/messaging/port-rpc.js","app:///src/shared/type-coercions.js","app:///src/boot/parse-json-config.js","app:///src/shared/has-own.js","app:///src/annotator/config/url-from-link-tag.ts","app:///src/annotator/config/settings.ts","app:///src/annotator/config/config-func-settings-from.ts","app:///src/annotator/config/index.ts","app:///src/annotator/config/is-browser-extension.ts","app:///node_modules/preact/dist/preact.mjs","app:///node_modules/preact/hooks/dist/hooks.mjs","app:///src/shared/shortcut.ts","app:///src/shared/user-agent.js","app:///node_modules/preact/jsx-runtime/dist/jsxRuntime.mjs","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Annotate.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Cancel.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/CaretDown.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/CaretLeft.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/CaretRight.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Caution.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Check.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Hide.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Highlight.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Note.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/PointerDown.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/PointerUp.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/icons/Show.js","app:///node_modules/classnames/index.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/data/ScrollContext.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/data/TableContext.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/data/TableSectionContext.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/layout/Card.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/layout/CardContent.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/input/ButtonBase.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/input/Button.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/input/InputGroup.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/input/IconButton.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/navigation/LinkBase.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/navigation/Link.js","app:///node_modules/@hypothesis/frontend-shared/lib/components/navigation/PointerButton.js","app:///src/annotator/components/AdderToolbar.tsx","app:///src/annotator/util/shadow-root.js","app:///src/annotator/adder.tsx","app:///src/annotator/anchoring/trim-range.ts","app:///src/annotator/anchoring/text-range.ts","app:///src/annotator/anchoring/placeholder.ts","app:///src/annotator/util/node.ts","app:///src/annotator/range-util.ts","app:///src/annotator/highlighter.ts","app:///src/annotator/bucket-bar-client.ts","app:///src/annotator/util/buckets.js","app:///src/shared/warn-once.js","app:///src/annotator/features.ts","app:///src/annotator/components/ClusterToolbar.tsx","app:///src/annotator/highlight-clusters.tsx","app:///node_modules/approx-string-match/build/src/index.js","app:///src/annotator/anchoring/match-quote.ts","app:///src/annotator/anchoring/xpath.js","app:///src/annotator/anchoring/types.js","app:///src/annotator/anchoring/html.ts","app:///src/annotator/util/navigation-observer.js","app:///node_modules/scroll-into-view/scrollIntoView.js","app:///src/annotator/util/scroll.js","app:///src/annotator/util/url.js","app:///src/annotator/integrations/html-metadata.ts","app:///src/annotator/util/geometry.ts","app:///src/annotator/integrations/html-side-by-side.ts","app:///src/annotator/integrations/html.ts","app:///node_modules/lodash.debounce/index.js","app:///src/annotator/util/normalize.js","app:///src/annotator/anchoring/pdf.ts","app:///src/annotator/components/Banners.tsx","app:///src/annotator/components/ContentInfoBanner.tsx","app:///src/annotator/components/WarningBanner.tsx","app:///src/annotator/integrations/pdf-metadata.ts","app:///src/annotator/integrations/pdf.tsx","app:///src/shared/cfi.ts","app:///src/annotator/frame-observer.ts","app:///src/annotator/hypothesis-injector.ts","app:///src/annotator/integrations/image-text-layer.ts","app:///src/annotator/integrations/vitalsource.ts","app:///src/annotator/integrations/index.ts","app:///src/annotator/selection-observer.ts","app:///src/annotator/guest.ts","app:///src/annotator/util/frame.js","app:///src/shared/config-fragment.js","app:///src/annotator/config/app.ts","app:///src/annotator/components/NotebookModal.tsx","app:///src/annotator/notebook.tsx","app:///src/annotator/components/ProfileModal.tsx","app:///src/annotator/profile.tsx","app:///node_modules/hammerjs/hammer.js","app:///src/annotator/components/Buckets.tsx","app:///src/annotator/bucket-bar.tsx","app:///src/shared/components/BaseToastMessages.tsx","app:///src/annotator/components/ToastMessages.tsx","app:///src/annotator/components/Toolbar.tsx","app:///src/annotator/toolbar.tsx","app:///src/annotator/sidebar.tsx","app:///src/annotator/annotation-counts.ts","app:///src/annotator/sidebar-trigger.ts","app:///src/annotator/util/emitter.js","app:///src/annotator/index.ts"],"sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory() :\n  typeof define === 'function' && define.amd ? define(factory) :\n  (factory());\n}(this, (function () { 'use strict';\n\n  /**\n   * Applies the :focus-visible polyfill at the given scope.\n   * A scope in this case is either the top-level Document or a Shadow Root.\n   *\n   * @param {(Document|ShadowRoot)} scope\n   * @see https://github.com/WICG/focus-visible\n   */\n  function applyFocusVisiblePolyfill(scope) {\n    var hadKeyboardEvent = true;\n    var hadFocusVisibleRecently = false;\n    var hadFocusVisibleRecentlyTimeout = null;\n\n    var inputTypesAllowlist = {\n      text: true,\n      search: true,\n      url: true,\n      tel: true,\n      email: true,\n      password: true,\n      number: true,\n      date: true,\n      month: true,\n      week: true,\n      time: true,\n      datetime: true,\n      'datetime-local': true\n    };\n\n    /**\n     * Helper function for legacy browsers and iframes which sometimes focus\n     * elements like document, body, and non-interactive SVG.\n     * @param {Element} el\n     */\n    function isValidFocusTarget(el) {\n      if (\n        el &&\n        el !== document &&\n        el.nodeName !== 'HTML' &&\n        el.nodeName !== 'BODY' &&\n        'classList' in el &&\n        'contains' in el.classList\n      ) {\n        return true;\n      }\n      return false;\n    }\n\n    /**\n     * Computes whether the given element should automatically trigger the\n     * `focus-visible` class being added, i.e. whether it should always match\n     * `:focus-visible` when focused.\n     * @param {Element} el\n     * @return {boolean}\n     */\n    function focusTriggersKeyboardModality(el) {\n      var type = el.type;\n      var tagName = el.tagName;\n\n      if (tagName === 'INPUT' && inputTypesAllowlist[type] && !el.readOnly) {\n        return true;\n      }\n\n      if (tagName === 'TEXTAREA' && !el.readOnly) {\n        return true;\n      }\n\n      if (el.isContentEditable) {\n        return true;\n      }\n\n      return false;\n    }\n\n    /**\n     * Add the `focus-visible` class to the given element if it was not added by\n     * the author.\n     * @param {Element} el\n     */\n    function addFocusVisibleClass(el) {\n      if (el.classList.contains('focus-visible')) {\n        return;\n      }\n      el.classList.add('focus-visible');\n      el.setAttribute('data-focus-visible-added', '');\n    }\n\n    /**\n     * Remove the `focus-visible` class from the given element if it was not\n     * originally added by the author.\n     * @param {Element} el\n     */\n    function removeFocusVisibleClass(el) {\n      if (!el.hasAttribute('data-focus-visible-added')) {\n        return;\n      }\n      el.classList.remove('focus-visible');\n      el.removeAttribute('data-focus-visible-added');\n    }\n\n    /**\n     * If the most recent user interaction was via the keyboard;\n     * and the key press did not include a meta, alt/option, or control key;\n     * then the modality is keyboard. Otherwise, the modality is not keyboard.\n     * Apply `focus-visible` to any current active element and keep track\n     * of our keyboard modality state with `hadKeyboardEvent`.\n     * @param {KeyboardEvent} e\n     */\n    function onKeyDown(e) {\n      if (e.metaKey || e.altKey || e.ctrlKey) {\n        return;\n      }\n\n      if (isValidFocusTarget(scope.activeElement)) {\n        addFocusVisibleClass(scope.activeElement);\n      }\n\n      hadKeyboardEvent = true;\n    }\n\n    /**\n     * If at any point a user clicks with a pointing device, ensure that we change\n     * the modality away from keyboard.\n     * This avoids the situation where a user presses a key on an already focused\n     * element, and then clicks on a different element, focusing it with a\n     * pointing device, while we still think we're in keyboard modality.\n     * @param {Event} e\n     */\n    function onPointerDown(e) {\n      hadKeyboardEvent = false;\n    }\n\n    /**\n     * On `focus`, add the `focus-visible` class to the target if:\n     * - the target received focus as a result of keyboard navigation, or\n     * - the event target is an element that will likely require interaction\n     *   via the keyboard (e.g. a text box)\n     * @param {Event} e\n     */\n    function onFocus(e) {\n      // Prevent IE from focusing the document or HTML element.\n      if (!isValidFocusTarget(e.target)) {\n        return;\n      }\n\n      if (hadKeyboardEvent || focusTriggersKeyboardModality(e.target)) {\n        addFocusVisibleClass(e.target);\n      }\n    }\n\n    /**\n     * On `blur`, remove the `focus-visible` class from the target.\n     * @param {Event} e\n     */\n    function onBlur(e) {\n      if (!isValidFocusTarget(e.target)) {\n        return;\n      }\n\n      if (\n        e.target.classList.contains('focus-visible') ||\n        e.target.hasAttribute('data-focus-visible-added')\n      ) {\n        // To detect a tab/window switch, we look for a blur event followed\n        // rapidly by a visibility change.\n        // If we don't see a visibility change within 100ms, it's probably a\n        // regular focus change.\n        hadFocusVisibleRecently = true;\n        window.clearTimeout(hadFocusVisibleRecentlyTimeout);\n        hadFocusVisibleRecentlyTimeout = window.setTimeout(function() {\n          hadFocusVisibleRecently = false;\n        }, 100);\n        removeFocusVisibleClass(e.target);\n      }\n    }\n\n    /**\n     * If the user changes tabs, keep track of whether or not the previously\n     * focused element had .focus-visible.\n     * @param {Event} e\n     */\n    function onVisibilityChange(e) {\n      if (document.visibilityState === 'hidden') {\n        // If the tab becomes active again, the browser will handle calling focus\n        // on the element (Safari actually calls it twice).\n        // If this tab change caused a blur on an element with focus-visible,\n        // re-apply the class when the user switches back to the tab.\n        if (hadFocusVisibleRecently) {\n          hadKeyboardEvent = true;\n        }\n        addInitialPointerMoveListeners();\n      }\n    }\n\n    /**\n     * Add a group of listeners to detect usage of any pointing devices.\n     * These listeners will be added when the polyfill first loads, and anytime\n     * the window is blurred, so that they are active when the window regains\n     * focus.\n     */\n    function addInitialPointerMoveListeners() {\n      document.addEventListener('mousemove', onInitialPointerMove);\n      document.addEventListener('mousedown', onInitialPointerMove);\n      document.addEventListener('mouseup', onInitialPointerMove);\n      document.addEventListener('pointermove', onInitialPointerMove);\n      document.addEventListener('pointerdown', onInitialPointerMove);\n      document.addEventListener('pointerup', onInitialPointerMove);\n      document.addEventListener('touchmove', onInitialPointerMove);\n      document.addEventListener('touchstart', onInitialPointerMove);\n      document.addEventListener('touchend', onInitialPointerMove);\n    }\n\n    function removeInitialPointerMoveListeners() {\n      document.removeEventListener('mousemove', onInitialPointerMove);\n      document.removeEventListener('mousedown', onInitialPointerMove);\n      document.removeEventListener('mouseup', onInitialPointerMove);\n      document.removeEventListener('pointermove', onInitialPointerMove);\n      document.removeEventListener('pointerdown', onInitialPointerMove);\n      document.removeEventListener('pointerup', onInitialPointerMove);\n      document.removeEventListener('touchmove', onInitialPointerMove);\n      document.removeEventListener('touchstart', onInitialPointerMove);\n      document.removeEventListener('touchend', onInitialPointerMove);\n    }\n\n    /**\n     * When the polfyill first loads, assume the user is in keyboard modality.\n     * If any event is received from a pointing device (e.g. mouse, pointer,\n     * touch), turn off keyboard modality.\n     * This accounts for situations where focus enters the page from the URL bar.\n     * @param {Event} e\n     */\n    function onInitialPointerMove(e) {\n      // Work around a Safari quirk that fires a mousemove on <html> whenever the\n      // window blurs, even if you're tabbing out of the page. ¯\\_(ツ)_/¯\n      if (e.target.nodeName && e.target.nodeName.toLowerCase() === 'html') {\n        return;\n      }\n\n      hadKeyboardEvent = false;\n      removeInitialPointerMoveListeners();\n    }\n\n    // For some kinds of state, we are interested in changes at the global scope\n    // only. For example, global pointer input, global key presses and global\n    // visibility change should affect the state at every scope:\n    document.addEventListener('keydown', onKeyDown, true);\n    document.addEventListener('mousedown', onPointerDown, true);\n    document.addEventListener('pointerdown', onPointerDown, true);\n    document.addEventListener('touchstart', onPointerDown, true);\n    document.addEventListener('visibilitychange', onVisibilityChange, true);\n\n    addInitialPointerMoveListeners();\n\n    // For focus and blur, we specifically care about state changes in the local\n    // scope. This is because focus / blur events that originate from within a\n    // shadow root are not re-dispatched from the host element if it was already\n    // the active element in its own scope:\n    scope.addEventListener('focus', onFocus, true);\n    scope.addEventListener('blur', onBlur, true);\n\n    // We detect that a node is a ShadowRoot by ensuring that it is a\n    // DocumentFragment and also has a host property. This check covers native\n    // implementation and polyfill implementation transparently. If we only cared\n    // about the native implementation, we could just check if the scope was\n    // an instance of a ShadowRoot.\n    if (scope.nodeType === Node.DOCUMENT_FRAGMENT_NODE && scope.host) {\n      // Since a ShadowRoot is a special kind of DocumentFragment, it does not\n      // have a root element to add a class to. So, we add this attribute to the\n      // host element instead:\n      scope.host.setAttribute('data-js-focus-visible', '');\n    } else if (scope.nodeType === Node.DOCUMENT_NODE) {\n      document.documentElement.classList.add('js-focus-visible');\n      document.documentElement.setAttribute('data-js-focus-visible', '');\n    }\n  }\n\n  // It is important to wrap all references to global window and document in\n  // these checks to support server-side rendering use cases\n  // @see https://github.com/WICG/focus-visible/issues/199\n  if (typeof window !== 'undefined' && typeof document !== 'undefined') {\n    // Make the polyfill helper globally available. This can be used as a signal\n    // to interested libraries that wish to coordinate with the polyfill for e.g.,\n    // applying the polyfill to a shadow root:\n    window.applyFocusVisiblePolyfill = applyFocusVisiblePolyfill;\n\n    // Notify interested libraries of the polyfill's presence, in case the\n    // polyfill was loaded lazily:\n    var event;\n\n    try {\n      event = new CustomEvent('focus-visible-polyfill-ready');\n    } catch (error) {\n      // IE11 does not support using CustomEvent as a constructor directly:\n      event = document.createEvent('CustomEvent');\n      event.initCustomEvent('focus-visible-polyfill-ready', false, false, {});\n    }\n\n    window.dispatchEvent(event);\n  }\n\n  if (typeof document !== 'undefined') {\n    // Apply the polyfill to the global document, so that no JavaScript\n    // coordination is required to use the polyfill in the top-level document:\n    applyFocusVisiblePolyfill(document);\n  }\n\n})));\n","type Listener = {\n  eventTarget: EventTarget;\n  eventType: string;\n  listener: (event: Event) => void;\n};\n\n/**\n * Return the event type that a listener will receive.\n *\n * For example `EventType<HTMLElement, 'keydown'>` evaluates to `KeyboardEvent`.\n *\n * The event type is extracted from the target's `on${Type}` property (eg.\n * `HTMLElement.onkeydown` here) If there is no such property, the type defaults\n * to `Event`.\n */\ntype EventType<\n  Target extends EventTarget,\n  Type extends string\n> = `on${Type}` extends keyof Target\n  ? Target[`on${Type}`] extends ((...args: any[]) => void) | null\n    ? Parameters<NonNullable<Target[`on${Type}`]>>[0]\n    : Event\n  : Event;\n\n/**\n * Utility that provides a way to conveniently remove a set of DOM event\n * listeners when they are no longer needed.\n */\nexport class ListenerCollection {\n  private _listeners: Map<symbol, Listener>;\n\n  constructor() {\n    this._listeners = new Map();\n  }\n\n  /**\n   * Add a listener and return an ID that can be used to remove it later\n   */\n  add<Type extends string, Target extends EventTarget>(\n    eventTarget: Target,\n    eventType: Type,\n    listener: (event: EventType<Target, Type>) => void,\n    options?: AddEventListenerOptions\n  ) {\n    eventTarget.addEventListener(eventType, listener as EventListener, options);\n    const symbol = Symbol();\n    this._listeners.set(symbol, {\n      eventTarget,\n      eventType,\n      // eslint-disable-next-line object-shorthand\n      listener: listener as EventListener,\n    });\n    return symbol;\n  }\n\n  /**\n   * Remove a specific listener.\n   */\n  remove(listenerId: symbol) {\n    const event = this._listeners.get(listenerId);\n    if (event) {\n      const { eventTarget, eventType, listener } = event;\n      eventTarget.removeEventListener(eventType, listener);\n      this._listeners.delete(listenerId);\n    }\n  }\n\n  removeAll() {\n    this._listeners.forEach(({ eventTarget, eventType, listener }) => {\n      eventTarget.removeEventListener(eventType, listener);\n    });\n    this._listeners.clear();\n  }\n}\n","/** @param {number} val */\nfunction byteToHex(val) {\n  const str = val.toString(16);\n  return str.length === 1 ? '0' + str : str;\n}\n\n/**\n * Generate a random hex string of `len` chars.\n *\n * @param {number} len - An even-numbered length string to generate.\n * @return {string}\n */\nexport function generateHexString(len) {\n  const bytes = new Uint8Array(len / 2);\n  window.crypto.getRandomValues(bytes);\n  return Array.from(bytes).map(byteToHex).join('');\n}\n","/**\n * Message sent by `PortProvider` and `PortFinder` to establish a\n * MessageChannel-based connection between two frames.\n *\n * @typedef {'guest'|'host'|'notebook'|'profile'|'sidebar'} Frame\n *\n * @typedef Message\n * @prop {Frame} frame1 - Role of the source frame\n * @prop {Frame} frame2 - Role of the target frame\n * @prop {'offer'|'request'} type - Message type. \"request\" messages are sent\n *   by the source frame to the host frame to request a connection. \"offer\"\n *   messages are sent from the host frame back to the source frame and also\n *   to the target frame, accompanied by a MessagePort.\n * @prop {string} requestId - ID of the request. Used to associate \"offer\"\n *   messages with their corresponding \"request\" messages.\n * @prop {string} [sourceId] - Identifier for the source frame. This is useful\n *   in cases where multiple source frames with a given role may connect to\n *   the same destination frame.\n */\n\n/**\n * Return true if an object, eg. from the data field of a `MessageEvent`, is a\n * valid `Message`.\n *\n * @param {any} data\n * @return {data is Message}\n */\nexport function isMessage(data) {\n  if (data === null || typeof data !== 'object') {\n    return false;\n  }\n\n  for (let property of ['frame1', 'frame2', 'type', 'requestId']) {\n    if (typeof data[property] !== 'string') {\n      return false;\n    }\n  }\n\n  return true;\n}\n\n/**\n * Return true if the data payload from a MessageEvent matches `message`.\n *\n * @param {any} data\n * @param {Partial<Message>} message\n */\nexport function isMessageEqual(data, message) {\n  if (!isMessage(data)) {\n    return false;\n  }\n\n  // We assume `JSON.stringify` cannot throw because `isMessage` verifies that\n  // all the fields we serialize here are serializable values.\n  return (\n    JSON.stringify(data, Object.keys(message).sort()) ===\n    JSON.stringify(message, Object.keys(message).sort())\n  );\n}\n\n/**\n * Check that source is of type Window.\n *\n * @param {MessageEventSource|null} source\n * @return {source is Window}\n */\nexport function isSourceWindow(source) {\n  if (\n    // `source` can be of type Window, MessagePort, ServiceWorker, or null.\n    // `source instanceof Window` doesn't work in Chrome if `source` is a\n    // cross-origin window.\n    source === null ||\n    source instanceof MessagePort ||\n    (window.ServiceWorker && source instanceof ServiceWorker)\n  ) {\n    return false;\n  }\n\n  return true;\n}\n","import { ListenerCollection } from '../listener-collection';\nimport { generateHexString } from '../random';\nimport { isMessageEqual } from './port-util';\n\n/** Timeout for waiting for the host frame to respond to a port request. */\nexport const MAX_WAIT_FOR_PORT = 1000 * 20;\n\n/** Polling interval for requests to the host frame for a port. */\nexport const POLLING_INTERVAL_FOR_PORT = 250;\n\n/**\n * @typedef {import('../../types/annotator').Destroyable} Destroyable\n * @typedef {import('./port-util').Message} Message\n * @typedef {import('./port-util').Frame} Frame\n */\n\n/**\n * PortFinder is used by non-host frames in the client to establish a\n * MessagePort-based connection to other frames. It is used together with\n * PortProvider which runs in the host frame. See PortProvider for an overview.\n *\n * @implements {Destroyable}\n */\nexport class PortFinder {\n  /**\n   * @param {object} options\n   *   @param {Exclude<Frame, 'host'>} options.source - the role of this frame\n   *   @param {string} [options.sourceId] - Identifier for this frame\n   *   @param {Window} options.hostFrame - the frame where the `PortProvider` is\n   *     listening for messages.\n   */\n  constructor({ hostFrame, source, sourceId }) {\n    this._hostFrame = hostFrame;\n    this._source = source;\n    this._sourceId = sourceId;\n    this._listeners = new ListenerCollection();\n  }\n\n  destroy() {\n    this._listeners.removeAll();\n  }\n\n  /**\n   * Request a specific port from the host frame\n   *\n   * @param {Frame} target - the frame aiming to be discovered\n   * @return {Promise<MessagePort>}\n   */\n  async discover(target) {\n    let isValidRequest = false;\n    if (\n      (this._source === 'guest' && target === 'host') ||\n      (this._source === 'guest' && target === 'sidebar') ||\n      (this._source === 'sidebar' && target === 'host') ||\n      (this._source === 'notebook' && target === 'sidebar')\n    ) {\n      isValidRequest = true;\n    }\n\n    if (!isValidRequest) {\n      throw new Error('Invalid request of channel/port');\n    }\n\n    const requestId = generateHexString(6);\n\n    return new Promise((resolve, reject) => {\n      const postRequest = () => {\n        this._hostFrame.postMessage(\n          {\n            frame1: this._source,\n            frame2: target,\n            type: 'request',\n            requestId,\n            sourceId: this._sourceId,\n          },\n          '*'\n        );\n      };\n\n      // Because `guest` iframes load in parallel to the `host` frame, we can\n      // not assume that the code in the `host` frame is executed before the\n      // code in a `guest` frame. Hence, we can't assume that `PortProvider` (in\n      // the `host` frame) is initialized before `PortFinder` (in the non-host\n      // frames). Therefore, for the `PortFinder`, we implement a polling\n      // strategy (sending a message every N milliseconds) until a response is\n      // received.\n      const intervalId = setInterval(postRequest, POLLING_INTERVAL_FOR_PORT);\n\n      // The `host` frame maybe busy, that's why we should wait.\n      const timeoutId = setTimeout(() => {\n        clearInterval(intervalId);\n        reject(\n          new Error(\n            `Unable to establish ${this._source}-${target} communication channel`\n          )\n        );\n      }, MAX_WAIT_FOR_PORT);\n\n      const listenerId = this._listeners.add(window, 'message', event => {\n        const { data, ports } = event;\n        if (\n          isMessageEqual(data, {\n            frame1: this._source,\n            frame2: target,\n            type: 'offer',\n            requestId,\n          })\n        ) {\n          clearInterval(intervalId);\n          clearTimeout(timeoutId);\n          this._listeners.remove(listenerId);\n          resolve(ports[0]);\n        }\n      });\n\n      postRequest();\n    });\n  }\n}\n","function E () {\n  // Keep this empty so it's easier to inherit from\n  // (via https://github.com/lipsmack from https://github.com/scottcorgan/tiny-emitter/issues/3)\n}\n\nE.prototype = {\n  on: function (name, callback, ctx) {\n    var e = this.e || (this.e = {});\n\n    (e[name] || (e[name] = [])).push({\n      fn: callback,\n      ctx: ctx\n    });\n\n    return this;\n  },\n\n  once: function (name, callback, ctx) {\n    var self = this;\n    function listener () {\n      self.off(name, listener);\n      callback.apply(ctx, arguments);\n    };\n\n    listener._ = callback\n    return this.on(name, listener, ctx);\n  },\n\n  emit: function (name) {\n    var data = [].slice.call(arguments, 1);\n    var evtArr = ((this.e || (this.e = {}))[name] || []).slice();\n    var i = 0;\n    var len = evtArr.length;\n\n    for (i; i < len; i++) {\n      evtArr[i].fn.apply(evtArr[i].ctx, data);\n    }\n\n    return this;\n  },\n\n  off: function (name, callback) {\n    var e = this.e || (this.e = {});\n    var evts = e[name];\n    var liveEvents = [];\n\n    if (evts && callback) {\n      for (var i = 0, len = evts.length; i < len; i++) {\n        if (evts[i].fn !== callback && evts[i].fn._ !== callback)\n          liveEvents.push(evts[i]);\n      }\n    }\n\n    // Remove event from queue to prevent memory leak\n    // Suggested by https://github.com/lazd\n    // Ref: https://github.com/scottcorgan/tiny-emitter/commit/c6ebfaa9bc973b33d110a84a307742b7cf94c953#commitcomment-5024910\n\n    (liveEvents.length)\n      ? e[name] = liveEvents\n      : delete e[name];\n\n    return this;\n  }\n};\n\nmodule.exports = E;\nmodule.exports.TinyEmitter = E;\n","/** @type {Window|null} */\nlet errorDestination = null;\n\n/**\n * Wrap a callback with an error handler which forwards errors to another frame\n * using {@link sendError}.\n *\n * @template {unknown[]} Args\n * @template Result\n * @param {(...args: Args) => Result} callback\n * @param {string} context - A short message indicating where the error happened.\n * @return {(...args: Args) => Result}\n */\nexport function captureErrors(callback, context) {\n  return (...args) => {\n    try {\n      return callback(...args);\n    } catch (err) {\n      sendError(err, context);\n      throw err;\n    }\n  };\n}\n\n/**\n * @typedef ErrorData\n * @prop {string} message\n * @prop {string} [stack]\n */\n\n/**\n * Return a cloneable representation of an Error.\n *\n * This is needed in browsers that don't support structured-cloning of Error\n * objects, or if the error is not cloneable for some reason.\n *\n * @param {Error|unknown} err\n * @return {ErrorData}\n */\nfunction serializeError(err) {\n  if (!(err instanceof Error)) {\n    return { message: String(err), stack: undefined };\n  }\n\n  return {\n    message: err.message,\n    stack: err.stack,\n  };\n}\n\n/**\n * Convert error data serialized by {@link serializeError} back into an Error.\n *\n * @param {ErrorData} data\n * @return {Error}\n */\nfunction deserializeError(data) {\n  const err = new Error(data.message);\n  err.stack = data.stack;\n  return err;\n}\n\n/**\n * Forward an error to the frame registered with {@link sendErrorsTo}.\n *\n * Errors are delivered on a best-effort basis. If no error handling frame has\n * been registered or the frame is still loading, the error will not be received.\n *\n * Ideally we would use a more robust delivery system which can queue messages\n * until they can be processed (eg. using MessagePort). We use `window.postMessage`\n * for the moment because we are trying to rule out problems with\n * MessageChannel/MessagePort when setting up sidebar <-> host communication.\n *\n * @param {unknown} error\n * @param {string} context - A short message indicating where the error happened.\n */\nexport function sendError(error, context) {\n  if (!errorDestination) {\n    return;\n  }\n\n  const data = {\n    type: 'hypothesis-error',\n    error: error instanceof Error ? error : serializeError(error),\n    context,\n  };\n\n  try {\n    // Try to send the error. If this fails because the browser doesn't support\n    // structured cloning of errors, use a fallback.\n    try {\n      errorDestination.postMessage(data, '*');\n    } catch (postErr) {\n      if (\n        postErr instanceof DOMException &&\n        postErr.name === 'DataCloneError'\n      ) {\n        data.error = serializeError(data.error);\n        errorDestination.postMessage(data, '*');\n      } else {\n        throw postErr;\n      }\n    }\n  } catch (sendErr) {\n    console.warn('Unable to report Hypothesis error', sendErr);\n  }\n}\n\n/**\n * Register a handler for errors sent to the current frame using {@link sendError}\n *\n * @param {(error: unknown, context: string) => void} callback\n * @return {() => void} A function that unregisters the handler\n */\nexport function handleErrorsInFrames(callback) {\n  /** @param {MessageEvent} event */\n  const handleMessage = event => {\n    const { data } = event;\n    if (data && data?.type === 'hypothesis-error') {\n      const { context, error } = data;\n      callback(\n        error instanceof Error ? error : deserializeError(error),\n        context\n      );\n    }\n  };\n  window.addEventListener('message', handleMessage);\n  return () => window.removeEventListener('message', handleMessage);\n}\n\n/**\n * Register a destination frame that {@link sendError} should submit errors to.\n *\n * @param {Window|null} destination\n */\nexport function sendErrorsTo(destination) {\n  errorDestination = destination;\n}\n","import { TinyEmitter } from 'tiny-emitter';\n\nimport { captureErrors, sendError } from '../frame-error-capture';\nimport { ListenerCollection } from '../listener-collection';\nimport { isMessage, isMessageEqual, isSourceWindow } from './port-util';\n\n/**\n * @typedef {import('../../types/annotator').Destroyable} Destroyable\n * @typedef {import('./port-util').Message} Message\n * @typedef {import('./port-util').Frame} Frame\n * @typedef {'guest-host'|'guest-sidebar'|'notebook-sidebar'|'sidebar-host'} Channel\n */\n\n/**\n * PortProvider creates a `MessageChannel` for communication between two\n * frames.\n *\n * There are 4 types of frames:\n * - `host`: frame where the Hypothesis client is initially loaded.\n * - `guest`: frames with annotatable content. In some instances a `guest`\n *    frame can be the same as the `host` frame, in other cases, it is an iframe\n *    where either (1) the hypothesis client has been injected or (2) the\n *    hypothesis client has been configured to act exclusively as a `guest` (not\n *    showing the sidebar).\n * - `notebook` and `profile`: front-end app views that each have their own\n *    iframe.\n * - `sidebar`: the main hypothesis front-end app. It runs in an iframe on a\n *    different origin than the host and is responsible for the communication\n *    with the backend (fetching and saving annotations).\n *\n * This layout represents the current arrangement of frames:\n *\n * `host` frame\n * |-> `sidebar` iframe\n * |-> `notebook` iframe\n * |-> `profile` iframe\n * |-> [`guest` iframes]\n *\n * Currently, we support communication between the following pairs of frames:\n * - `guest-host`\n * - `guest-sidebar`\n * - `notebook-sidebar`\n * - `sidebar-host`\n *\n * `PortProvider` is used only in the `host` frame. The other frames use the\n * companion class, `PortFinder`. `PortProvider` creates a `MessageChannel`\n * for two frames to communicate with each other. It also listens to requests for\n * particular `MessagePort` and dispatches the corresponding `MessagePort`.\n *\n *\n *        PortFinder (non-host frame)                 |       PortProvider (host frame)\n * -----------------------------------------------------------------------------------------------\n * 1. Request `MessagePort` via `window.postMessage` ---> 2. Receive request and create port pair\n *                                                                          |\n *                                                                          V\n * 4. Receive requested port      <---------------------- 3. Send first port to requesting frame\n *                                                        5. Send second port to other frame\n *                                                           (eg. via MessageChannel connection\n *                                                           between host and other frame)\n *\n * @implements {Destroyable}\n */\nexport class PortProvider {\n  /**\n   * Begin listening to port requests from other frames.\n   *\n   * @param {string} hypothesisAppsOrigin - the origin of the hypothesis apps\n   *   is use to send the notebook and sidebar ports to only the frames that\n   *   match the origin.\n   */\n  constructor(hypothesisAppsOrigin) {\n    this._hypothesisAppsOrigin = hypothesisAppsOrigin;\n    this._emitter = new TinyEmitter();\n\n    /**\n     * IDs of port requests that have been handled.\n     *\n     * This is used to avoid responding to the same request multiple times.\n     * Guest frames in particular may send duplicate requests (see comments in\n     * PortFinder).\n     *\n     * @type {Set<string>}\n     */\n    this._handledRequests = new Set();\n\n    // Create the `sidebar-host` channel immediately, while other channels are\n    // created on demand\n    this._sidebarHostChannel = new MessageChannel();\n\n    this._listeners = new ListenerCollection();\n\n    /** @type {Array<Partial<Message> & {allowedOrigin: string}>} */\n    this._allowedMessages = [\n      {\n        allowedOrigin: '*',\n        frame1: 'guest',\n        frame2: 'host',\n        type: 'request',\n      },\n      {\n        allowedOrigin: '*',\n        frame1: 'guest',\n        frame2: 'sidebar',\n        type: 'request',\n      },\n      {\n        allowedOrigin: this._hypothesisAppsOrigin,\n        frame1: 'sidebar',\n        frame2: 'host',\n        type: 'request',\n      },\n      {\n        allowedOrigin: this._hypothesisAppsOrigin,\n        frame1: 'notebook',\n        frame2: 'sidebar',\n        type: 'request',\n      },\n    ];\n\n    this._listen();\n  }\n\n  _listen() {\n    const errorContext = 'Handling port request';\n    const sentErrors = /** @type {Set<string>} */ (new Set());\n\n    /** @param {string} message */\n    const reportError = message => {\n      if (sentErrors.has(message)) {\n        // PortFinder will send requests repeatedly until it gets a response or\n        // a timeout is reached.\n        //\n        // Only send errors once to avoid spamming Sentry.\n        return;\n      }\n      sentErrors.add(message);\n      sendError(new Error(message), errorContext);\n    };\n\n    /** @param {MessageEvent} event */\n    const handleRequest = event => {\n      const { data, origin, source } = event;\n\n      if (!isMessage(data) || data.type !== 'request') {\n        // If this does not look like a message intended for us, ignore it.\n        return;\n      }\n\n      const { frame1, frame2, requestId, sourceId } = data;\n      const channel = /** @type {Channel} */ (`${frame1}-${frame2}`);\n\n      if (!isSourceWindow(source)) {\n        reportError(\n          `Ignored port request for channel ${channel} from non-Window source`\n        );\n        return;\n      }\n\n      const match = this._allowedMessages.find(\n        ({ allowedOrigin, ...allowedMessage }) =>\n          this._messageMatches({\n            allowedMessage,\n            allowedOrigin,\n            data,\n            origin,\n          })\n      );\n\n      if (match === undefined) {\n        reportError(\n          `Ignored invalid port request for channel ${channel} from ${origin}`\n        );\n        return;\n      }\n\n      if (this._handledRequests.has(requestId)) {\n        return;\n      }\n      this._handledRequests.add(requestId);\n\n      // Create the channel for these two frames to communicate and send the\n      // corresponding ports to them.\n      const messageChannel =\n        channel === 'sidebar-host'\n          ? this._sidebarHostChannel\n          : new MessageChannel();\n\n      // The message that is sent to the target frame that the source wants to\n      // connect to, as well as the source frame requesting the connection.\n      // Each message is accompanied by a port for the appropriate end of the\n      // connection.\n      const message = { frame1, frame2, type: 'offer', requestId, sourceId };\n\n      // If the source window has an opaque origin [1], `event.origin` will be\n      // the string \"null\". This is not a legal value for the `targetOrigin`\n      // parameter to `postMessage`, so remap it to \"*\".\n      //\n      // [1] https://html.spec.whatwg.org/multipage/origin.html#origin.\n      //     Documents with opaque origins include file:// URLs and\n      //     sandboxed iframes.\n      const targetOrigin = origin === 'null' ? '*' : origin;\n      source.postMessage(message, targetOrigin, [messageChannel.port1]);\n\n      if (frame2 === 'sidebar') {\n        this._sidebarHostChannel.port2.postMessage(message, [\n          messageChannel.port2,\n        ]);\n      } else if (frame2 === 'host') {\n        this._emitter.emit('frameConnected', frame1, messageChannel.port2);\n      }\n    };\n\n    this._listeners.add(\n      window,\n      'message',\n      captureErrors(handleRequest, errorContext)\n    );\n  }\n\n  /**\n   * @param {object} options\n   *   @param {Partial<Message>} options.allowedMessage - the `data` must match this\n   *     `Message`.\n   *   @param {string} options.allowedOrigin - the `origin` must match this\n   *     value. If `allowedOrigin` is '*', the origin is ignored.\n   *   @param {unknown} options.data - the data to be compared with `allowedMessage`.\n   *   @param {string} options.origin - the origin to be compared with\n   *     `allowedOrigin`.\n   */\n  _messageMatches({ allowedMessage, allowedOrigin, data, origin }) {\n    if (allowedOrigin !== '*' && origin !== allowedOrigin) {\n      return false;\n    }\n\n    return isMessageEqual(data, allowedMessage);\n  }\n\n  /**\n   * @param {'frameConnected'} eventName\n   * @param {(source: 'guest'|'sidebar', port: MessagePort) => void} handler - this handler\n   *   fires when a frame connects to the host frame\n   */\n  on(eventName, handler) {\n    this._emitter.on(eventName, handler);\n  }\n\n  destroy() {\n    this._listeners.removeAll();\n  }\n}\n","import { ListenerCollection } from '../listener-collection';\n\n/*\n  This module was adapted from `index.js` in https://github.com/substack/frame-rpc.\n\n  This software is released under the MIT license:\n\n  Permission is hereby granted, free of charge, to any person obtaining a copy\n  of this software and associated documentation files (the \"Software\"), to deal\n  in the Software without restriction, including without limitation the rights\n  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n  copies of the Software, and to permit persons to whom the Software is\n  furnished to do so, subject to the following conditions:\n\n  The above copyright notice and this permission notice shall be included in\n  all copies or substantial portions of the Software.\n\n  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n  SOFTWARE.\n */\n\nconst VERSION = '1.0.0';\nconst PROTOCOL = 'frame-rpc';\n\n/**\n * Format of messages sent between frames.\n *\n * See https://github.com/substack/frame-rpc#protocol\n *\n * @typedef RequestMessage\n * @prop {unknown[]} arguments\n * @prop {string} method\n * @prop {PROTOCOL} protocol\n * @prop {number} sequence\n * @prop {VERSION} version\n *\n * @typedef ResponseMessage\n * @prop {unknown[]} arguments\n * @prop {PROTOCOL} protocol\n * @prop {number} response\n * @prop {VERSION} version\n *\n * @typedef {RequestMessage|ResponseMessage} Message\n *\n * @typedef {import('../../types/annotator').Destroyable} Destroyable\n */\n\n/**\n * Send a PortRPC method call.\n *\n * @param {MessagePort} port\n * @param {string} method\n * @param {unknown[]} [args]\n * @param {number} [sequence] - Sequence number used for replies\n */\nfunction sendCall(port, method, args = [], sequence = -1) {\n  port.postMessage(\n    /** @type {RequestMessage} */ ({\n      protocol: PROTOCOL,\n      version: VERSION,\n      arguments: args,\n      method,\n      sequence,\n    })\n  );\n}\n\n/**\n * Install a message listener that ensures proper delivery of \"close\" notifications\n * from {@link PortRPC}s in Safari <= 15.\n *\n * This must be called in the _parent_ frame of the frame that owns the port.\n * In Hypothesis this means for example that the workaround would be installed\n * in the host frame to ensure delivery of \"close\" notifications from \"guest\"\n * frames.\n *\n * @param {string} [userAgent] - Test seam\n * @return {() => void} - Callback that removes the listener\n */\nexport function installPortCloseWorkaroundForSafari(\n  /* istanbul ignore next */\n  userAgent = navigator.userAgent\n) {\n  if (!shouldUseSafariWorkaround(userAgent)) {\n    return () => {};\n  }\n\n  /** @param {MessageEvent} event */\n  const handler = event => {\n    if (event.data?.type === 'hypothesisPortClosed' && event.ports[0]) {\n      const port = event.ports[0];\n      sendCall(port, 'close');\n      port.close();\n    }\n  };\n\n  window.addEventListener('message', handler);\n  return () => window.removeEventListener('message', handler);\n}\n\n/**\n * Test whether this browser needs the workaround for https://bugs.webkit.org/show_bug.cgi?id=231167.\n *\n * @param {string} userAgent\n */\nfunction shouldUseSafariWorkaround(userAgent) {\n  const webkitVersionMatch = userAgent.match(/\\bAppleWebKit\\/([0-9]+)\\b/);\n  if (!webkitVersionMatch) {\n    return false;\n  }\n  const version = parseInt(webkitVersionMatch[1]);\n\n  // Chrome's user agent contains the token \"AppleWebKit/537.36\", where the\n  // version number is frozen. This corresponds to a version of Safari from 2013,\n  // which is older than all supported Safari versions.\n  if (version <= 537) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Callback type used for RPC method handlers and result callbacks.\n *\n * @typedef {(...args: unknown[]) => void} Callback\n */\n\n/**\n * @param {any} value\n * @return {value is Callback}\n */\nfunction isCallback(value) {\n  return typeof value === 'function';\n}\n\n/**\n * PortRPC provides remote procedure calls between frames or workers. It uses\n * the Channel Messaging API [1] as a transport.\n *\n * To communicate between two frames with this class, construct a PortRPC\n * instance in each and register method handlers with {@link on}. Create a\n * {@link MessageChannel} and send one of its two ports to each frame. Then call\n * {@link connect} to make the PortRPC instance in each frame use the corresponding\n * port.\n *\n * In addition to the custom methods that a PortRPC handles, there are several\n * built-in events which are sent automatically:\n *\n * - \"connect\" is sent when a PortRPC connects to a port. This event can\n *   be used to confirm that the sending frame has received the port and will\n *   send a \"close\" event when it goes away.\n * - \"close\" is sent when a PortRPC is destroyed or the owning frame is\n *   unloaded. This event may not be dispatched if the guest frame terminates\n *   abnormally (eg. due to an OS process crash).\n *\n * [1] https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\n *\n * @template {string} OnMethod - Names of RPC methods this client responds to\n * @template {string} CallMethod - Names of RPC methods this client invokes\n * @implements {Destroyable}\n */\nexport class PortRPC {\n  /**\n   * @param {object} options\n   *   @param {string} [options.userAgent] - Test seam\n   *   @param {Window} [options.currentWindow] - Test seam\n   */\n  constructor({\n    userAgent = navigator.userAgent,\n    currentWindow = window,\n  } = {}) {\n    /** @type {MessagePort|null} */\n    this._port = null;\n\n    /** @type {Map<string, Callback>} */\n    this._methods = new Map();\n\n    this._sequence = 1;\n\n    /** @type {Map<number, Callback>} */\n    this._callbacks = new Map();\n\n    this._listeners = new ListenerCollection();\n    this._listeners.add(currentWindow, 'unload', () => {\n      if (this._port) {\n        // Send \"close\" notification directly. This works in Chrome, Firefox and\n        // Safari >= 16.\n        sendCall(this._port, 'close');\n\n        // To work around a bug in Safari <= 15 which prevents sending messages\n        // while a window is unloading, try transferring the port to the parent frame\n        // and re-sending the \"close\" event from there.\n        if (\n          currentWindow !== currentWindow.parent &&\n          shouldUseSafariWorkaround(userAgent)\n        ) {\n          currentWindow.parent.postMessage(\n            { type: 'hypothesisPortClosed' },\n            '*',\n            [this._port]\n          );\n        }\n      }\n    });\n\n    /**\n     * Method and arguments of pending RPC calls made before a port was connected.\n     *\n     * @type {Array<[CallMethod, unknown[]]>}\n     */\n    this._pendingCalls = [];\n\n    this._receivedCloseEvent = false;\n  }\n\n  /**\n   * Register a method handler for incoming RPC requests.\n   *\n   * This can also be used to register a handler for the built-in \"connect\"\n   * and \"close\" events.\n   *\n   * All handlers must be registered before {@link connect} is invoked.\n   *\n   * @template {function} Handler\n   * @param {OnMethod|'close'|'connect'} method\n   * @param {Handler} handler\n   */\n  on(method, handler) {\n    if (this._port) {\n      throw new Error('Cannot add a method handler after a port is connected');\n    }\n    this._methods.set(method, /** @type {any} */ (handler));\n  }\n\n  /**\n   * Connect to a MessagePort and process any queued RPC requests.\n   *\n   * @param {MessagePort} port\n   */\n  connect(port) {\n    this._port = port;\n    this._listeners.add(port, 'message', event => this._handle(event));\n    port.start();\n    sendCall(port, 'connect');\n\n    for (let [method, args] of this._pendingCalls) {\n      this.call(method, ...args);\n    }\n    this._pendingCalls = [];\n  }\n\n  /**\n   * Disconnect the RPC channel and close the MessagePort.\n   */\n  destroy() {\n    if (this._port) {\n      sendCall(this._port, 'close');\n      this._port.close();\n    }\n    this._destroyed = true;\n    this._listeners.removeAll();\n  }\n\n  /**\n   * Send an RPC request via the connected port.\n   *\n   * If this client is not yet connected to a port, the call will be queued and\n   * sent when {@link connect} is called.\n   *\n   * If the final argument in `args` is a function, it is treated as a callback\n   * which is invoked with the response in the form of (error, result) arguments.\n   *\n   * @param {CallMethod} method\n   * @param {unknown[]} args\n   */\n  call(method, ...args) {\n    if (!this._port) {\n      this._pendingCalls.push([method, args]);\n    }\n\n    if (!this._port || this._destroyed) {\n      return;\n    }\n\n    const seq = this._sequence++;\n    const finalArg = args[args.length - 1];\n    if (isCallback(finalArg)) {\n      this._callbacks.set(seq, finalArg);\n      args = args.slice(0, -1);\n    }\n\n    sendCall(this._port, method, args, seq);\n  }\n\n  /**\n   * Validate message\n   *\n   * @param {MessageEvent} event\n   * @return {null|Message}\n   */\n  _parseMessage({ data }) {\n    if (!data || typeof data !== 'object') {\n      return null;\n    }\n    if (data.protocol !== PROTOCOL) {\n      return null;\n    }\n    if (data.version !== VERSION) {\n      return null;\n    }\n    if (!Array.isArray(data.arguments)) {\n      return null;\n    }\n\n    return data;\n  }\n\n  /**\n   * @param {MessageEvent} event\n   */\n  _handle(event) {\n    const msg = this._parseMessage(event);\n    const port = this._port;\n\n    if (!msg || !port) {\n      return;\n    }\n\n    if ('method' in msg) {\n      // Only allow close event to fire once.\n      if (msg.method === 'close') {\n        if (this._receivedCloseEvent) {\n          return;\n        } else {\n          this._receivedCloseEvent = true;\n        }\n      }\n\n      const handler = this._methods.get(msg.method);\n      if (!handler) {\n        return;\n      }\n\n      /** @param {unknown[]} args */\n      const callback = (...args) => {\n        /** @type {ResponseMessage} */\n        const message = {\n          arguments: args,\n          protocol: PROTOCOL,\n          response: msg.sequence,\n          version: VERSION,\n        };\n\n        port.postMessage(message);\n      };\n      handler(...msg.arguments, callback);\n    } else if ('response' in msg) {\n      const cb = this._callbacks.get(msg.response);\n      this._callbacks.delete(msg.response);\n      if (cb) {\n        cb(...msg.arguments);\n      }\n    }\n  }\n}\n","/**\n * Type conversion methods that coerce incoming configuration values to an\n * expected type or format that other parts of the UI may make assumptions\n * on. This is needed for incoming configuration values that are otherwise\n * not sanitized.\n *\n * Note that if the values passed are plain javascript values (such as ones\n * produced from JSON.parse), then these methods do not throw errors.\n */\n\n/**\n * Returns a boolean\n *\n * @param {any} value - initial value\n * @return {boolean}\n */\nexport function toBoolean(value) {\n  if (typeof value === 'string') {\n    if (value.trim().toLocaleLowerCase() === 'false') {\n      // \"false\", \"False\", \" false\", \"FALSE\" all return false\n      return false;\n    }\n  }\n  const numericalVal = Number(value);\n  if (!isNaN(numericalVal)) {\n    return Boolean(numericalVal);\n  }\n  // Any non numerical or falsely string should return true, otherwise return false\n  return typeof value === 'string';\n}\n\n/**\n * Returns either an integer or NaN\n *\n * @param {any} value - initial value\n * @return {number}\n */\nexport function toInteger(value) {\n  // Acts as a simple wrapper\n  return parseInt(value);\n}\n\n/**\n * Returns either the value if its an object or an empty object\n *\n * @param {any} value - initial value\n * @return {object}\n */\nexport function toObject(value) {\n  if (typeof value === 'object' && value !== null) {\n    return value;\n  }\n  // Don't attempt to fix the values, just ensure type correctness\n  return {};\n}\n\n/**\n * Returns the value as a string or an empty string if the\n * value undefined, null or otherwise falsely.\n *\n * @param {any} value - initial value\n * @return {string}\n */\nexport function toString(value) {\n  if (value && typeof value.toString === 'function') {\n    return value.toString();\n  }\n  return '';\n}\n\n/**\n * @template T\n * @typedef {import('preact').Ref<T>} Ref\n */\n\n/**\n * Helper for downcasting a ref to a more specific type, where that is safe\n * to do.\n *\n * This is mainly useful to cast a generic `Ref<HTMLElement>` to a more specific\n * element type (eg. `Ref<HTMLDivElement>`) for use with the `ref` prop of a JSX element.\n * Since Preact only writes to the `ref` prop, such a cast is safe.\n *\n * @template T\n * @template {T} U\n * @param {Ref<T>|undefined} ref\n * @return {Ref<U>|undefined}\n */\nexport function downcastRef(ref) {\n  return /** @type {Ref<U>|undefined} */ (ref);\n}\n","/**\n * Return a parsed `js-hypothesis-config` object from the document, or `{}`.\n *\n * Find all `<script class=\"js-hypothesis-config\">` tags in the given document,\n * parse them as JSON, and return the parsed object.\n *\n * If there are no `js-hypothesis-config` tags in the document then return\n * `{}`.\n *\n * If there are multiple `js-hypothesis-config` tags in the document then merge\n * them into a single returned object (when multiple scripts contain the same\n * setting names, scripts further down in the document override those further\n * up).\n *\n * @param {Document|Element} document - The root element to search.\n */\nexport function parseJsonConfig(document) {\n  /** @type {Record<string, unknown>} */\n  const config = {};\n  const settingsElements = document.querySelectorAll(\n    'script.js-hypothesis-config'\n  );\n\n  for (let i = 0; i < settingsElements.length; i++) {\n    let settings;\n    try {\n      settings = JSON.parse(settingsElements[i].textContent || '');\n    } catch (err) {\n      console.warn(\n        'Could not parse settings from js-hypothesis-config tags',\n        err\n      );\n      settings = {};\n    }\n    Object.assign(config, settings);\n  }\n\n  return config;\n}\n","/**\n * Polyfill for `Object.hasOwn`.\n *\n * `hasOwn(someObject, property)` should be used instead of\n * `someObject.hasOwnProperty(name)`.\n *\n * @param {object} object\n * @param {string} property\n */\nexport function hasOwn(object, property) {\n  return Object.prototype.hasOwnProperty.call(object, property);\n}\n","/**\n * Return the URL of a resource related to the Hypothesis client that has been stored in\n * the page via a `<link type=\"application/annotator+{type}\">` tag.\n *\n * These link tags are generally written to the page by the boot script, which may be executed\n * in a separate JavaScript realm (eg. in the browser extension), and thus can share information\n * with the annotator code via the DOM but not JS globals.\n *\n * @param rel - The `rel` attribute to match\n * @param type - Type of resource that the link refers to\n * @throws {Error} - If there's no link with the `rel` indicated, or the first\n *   matching link has no `href`\n */\nexport function urlFromLinkTag(\n  window_: Window,\n  rel: string,\n  type: 'javascript' | 'html'\n) {\n  const link = window_.document.querySelector(\n    `link[type=\"application/annotator+${type}\"][rel=\"${rel}\"]`\n  ) as HTMLLinkElement | undefined;\n\n  if (!link) {\n    throw new Error(\n      `No application/annotator+${type} (rel=\"${rel}\") link in the document`\n    );\n  }\n\n  if (!link.href) {\n    throw new Error(\n      `application/annotator+${type} (rel=\"${rel}\") link has no href`\n    );\n  }\n\n  return link.href;\n}\n","import { parseJsonConfig } from '../../boot/parse-json-config';\nimport { hasOwn } from '../../shared/has-own';\nimport { toBoolean } from '../../shared/type-coercions';\nimport { configFuncSettingsFrom } from './config-func-settings-from';\nimport { urlFromLinkTag } from './url-from-link-tag';\n\nexport type SettingsGetters = {\n  annotations: string | null;\n  query: string | null;\n  group: string | null;\n  showHighlights: string;\n  clientUrl: string;\n  sidebarAppUrl: string;\n  notebookAppUrl: string;\n  profileAppUrl: string;\n  hostPageSetting: (name: string) => unknown;\n};\n\n/**\n * Discard a setting if it is not a string.\n */\nfunction checkIfString(value: unknown): string | null {\n  return typeof value === 'string' ? value : null;\n}\n\nexport function settingsFrom(window_: Window): SettingsGetters {\n  // Prioritize the `window.hypothesisConfig` function over the JSON format\n  // Via uses `window.hypothesisConfig` and makes it non-configurable and non-writable.\n  // In addition, Via sets the `ignoreOtherConfiguration` option to prevent configuration merging.\n  const configFuncSettings = configFuncSettingsFrom(window_);\n\n  const jsonConfigs: Record<string, unknown> = toBoolean(\n    configFuncSettings.ignoreOtherConfiguration\n  )\n    ? {}\n    : parseJsonConfig(window_.document);\n\n  /**\n   * Return the `#annotations:*` ID from the given URL's fragment.\n   *\n   * If the URL contains a `#annotations:<ANNOTATION_ID>` fragment then return\n   * the annotation ID extracted from the fragment. Otherwise return `null`.\n   *\n   * @return The extracted ID, or null.\n   */\n  function annotations(): string | null {\n    /** Return the annotations from the URL, or null. */\n    function annotationsFromURL() {\n      // Annotation IDs are url-safe-base64 identifiers\n      // See https://tools.ietf.org/html/rfc4648#page-7\n      const annotFragmentMatch = window_.location.href.match(\n        /#annotations:([A-Za-z0-9_-]+)$/\n      );\n      if (annotFragmentMatch) {\n        return annotFragmentMatch[1];\n      }\n      return null;\n    }\n\n    return checkIfString(jsonConfigs.annotations) || annotationsFromURL();\n  }\n\n  /**\n   * Return the `#annotations:group:*` ID from the given URL's fragment.\n   *\n   * If the URL contains a `#annotations:group:<GROUP_ID>` fragment then return\n   * the group ID extracted from the fragment. Otherwise return `null`.\n   *\n   * @return The extracted ID, or null.\n   */\n  function group(): string | null {\n    function groupFromURL() {\n      const groupFragmentMatch = window_.location.href.match(\n        /#annotations:group:([A-Za-z0-9_-]+)$/\n      );\n      if (groupFragmentMatch) {\n        return groupFragmentMatch[1];\n      }\n      return null;\n    }\n\n    return checkIfString(jsonConfigs.group) || groupFromURL();\n  }\n\n  function showHighlights() {\n    const value = hostPageSetting('showHighlights');\n\n    switch (value) {\n      case 'always':\n      case 'never':\n      case 'whenSidebarOpen':\n        return value;\n      case true:\n        return 'always';\n      case false:\n        return 'never';\n      default:\n        return 'always';\n    }\n  }\n\n  /**\n   * Return the config.query setting from the host page or from the URL.\n   *\n   * If the host page contains a js-hypothesis-config script containing a\n   * query setting then return that.\n   *\n   * Otherwise if the host page's URL has a `#annotations:query:*` (or\n   * `#annotations:q:*`) fragment then return the query value from that.\n   *\n   * Otherwise return null.\n   *\n   * @return The config.query setting, or null.\n   */\n  function query(): string | null {\n    /** Return the query from the URL, or null. */\n    function queryFromURL() {\n      const queryFragmentMatch = window_.location.href.match(\n        /#annotations:(query|q):(.+)$/i\n      );\n      if (queryFragmentMatch) {\n        try {\n          return decodeURIComponent(queryFragmentMatch[2]);\n        } catch (err) {\n          // URI Error should return the page unfiltered.\n        }\n      }\n      return null;\n    }\n\n    return checkIfString(jsonConfigs.query) || queryFromURL();\n  }\n\n  /**\n   * Returns the first setting value found from the respective sources in order.\n   *\n   *  1. window.hypothesisConfig()\n   *  2. <script class=\"js-hypothesis-config\">\n   *\n   * If the setting is not found in either source, then return undefined.\n   *\n   * @param name - Unique name of the setting\n   */\n  function hostPageSetting(name: string) {\n    if (hasOwn(configFuncSettings, name)) {\n      return configFuncSettings[name];\n    }\n\n    if (hasOwn(jsonConfigs, name)) {\n      return jsonConfigs[name];\n    }\n\n    return undefined;\n  }\n\n  return {\n    get annotations() {\n      return annotations();\n    },\n    get clientUrl() {\n      return urlFromLinkTag(window_, 'hypothesis-client', 'javascript');\n    },\n    get group() {\n      return group();\n    },\n    get notebookAppUrl() {\n      return urlFromLinkTag(window_, 'notebook', 'html');\n    },\n    get profileAppUrl() {\n      return urlFromLinkTag(window_, 'profile', 'html');\n    },\n    get showHighlights() {\n      return showHighlights();\n    },\n    get sidebarAppUrl() {\n      return urlFromLinkTag(window_, 'sidebar', 'html');\n    },\n    get query() {\n      return query();\n    },\n    hostPageSetting,\n  };\n}\n","import { hasOwn } from '../../shared/has-own';\n\ntype HypothesisWindowProps = {\n  /** Function that returns configuration for the Hypothesis client */\n  hypothesisConfig?: () => Record<string, unknown>;\n};\n\n/**\n * Return an object containing config settings from window.hypothesisConfig().\n *\n * Return an object containing config settings returned by the\n * window.hypothesisConfig() function provided by the host page:\n *\n *   {\n *     fooSetting: 'fooValue',\n *     barSetting: 'barValue',\n *     ...\n *   }\n *\n * If there's no window.hypothesisConfig() function then return {}.\n *\n * @param window_ - The window to search for a hypothesisConfig() function\n * @return Any config settings returned by hypothesisConfig()\n */\nexport function configFuncSettingsFrom(\n  window_: Window & HypothesisWindowProps\n): Record<string, unknown> {\n  if (!hasOwn(window_, 'hypothesisConfig')) {\n    return {};\n  }\n\n  if (typeof window_.hypothesisConfig !== 'function') {\n    const docs =\n      'https://h.readthedocs.io/projects/client/en/latest/publishers/config/#window.hypothesisConfig';\n    console.warn('hypothesisConfig must be a function, see: ' + docs);\n    return {};\n  }\n\n  return window_.hypothesisConfig();\n}\n","import { toBoolean } from '../../shared/type-coercions';\nimport { isBrowserExtension } from './is-browser-extension';\nimport { settingsFrom } from './settings';\nimport type { SettingsGetters } from './settings';\nimport { urlFromLinkTag } from './url-from-link-tag';\n\ntype ValueGetter = (settings: SettingsGetters, name: string) => any;\n\ntype ConfigDefinition = {\n  /** Method to retrieve the value from the incoming source */\n  getValue: ValueGetter;\n\n  /**\n   * Allow this setting to be read in the browser extension. If this is false\n   * and browser extension context is true, use `defaultValue` if provided\n   * otherwise ignore the config key\n   */\n  allowInBrowserExt: boolean;\n\n  /** Sets a default if `getValue` returns undefined */\n  defaultValue?: any;\n  /** Transform a value's type, value or both */\n  coerce?: (value: any) => any;\n};\n\ntype ConfigDefinitionMap = Record<string, ConfigDefinition>;\n\n/**\n * Named subset of the Hypothesis client configuration that is relevant in\n * a particular context.\n */\ntype Context = 'sidebar' | 'notebook' | 'profile' | 'annotator' | 'all';\n\n/**\n * Returns the configuration keys that are relevant to a particular context.\n */\nfunction configurationKeys(context: Context): string[] {\n  const contexts = {\n    annotator: ['clientUrl', 'contentInfoBanner', 'subFrameIdentifier'],\n    sidebar: [\n      'appType',\n      'annotations',\n      'branding',\n      'enableExperimentalNewNoteButton',\n      'externalContainerSelector',\n      'focus',\n      'group',\n      'onLayoutChange',\n      'openSidebar',\n      'query',\n      'requestConfigFromFrame',\n      'services',\n      'showHighlights',\n      'sidebarAppUrl',\n      'theme',\n      'usernameUrl',\n    ],\n    notebook: [\n      'branding',\n      'group',\n      'notebookAppUrl',\n      'requestConfigFromFrame',\n      'services',\n      'theme',\n      'usernameUrl',\n    ],\n    profile: ['profileAppUrl'],\n  };\n\n  switch (context) {\n    case 'annotator':\n      return contexts.annotator;\n    case 'sidebar':\n      return contexts.sidebar;\n    case 'notebook':\n      return contexts.notebook;\n    case 'profile':\n      return contexts.profile;\n    case 'all':\n      // Complete list of configuration keys used for testing.\n      return Object.values(contexts).flat();\n    default:\n      throw new Error(`Invalid application context used: \"${context}\"`);\n  }\n}\n\nconst getHostPageSetting: ValueGetter = (settings, name) =>\n  settings.hostPageSetting(name);\n\n/**\n * Definitions of configuration keys\n */\nconst configDefinitions: ConfigDefinitionMap = {\n  annotations: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.annotations,\n  },\n  appType: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  branding: {\n    defaultValue: null,\n    allowInBrowserExt: false,\n    getValue: getHostPageSetting,\n  },\n  // URL of the client's boot script. Used when injecting the client into\n  // child iframes.\n  clientUrl: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.clientUrl,\n  },\n  contentInfoBanner: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  enableExperimentalNewNoteButton: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  group: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.group,\n  },\n  focus: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  theme: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  usernameUrl: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  onLayoutChange: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  openSidebar: {\n    allowInBrowserExt: true,\n    defaultValue: false,\n    coerce: toBoolean,\n    getValue: getHostPageSetting,\n  },\n  query: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.query,\n  },\n  requestConfigFromFrame: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  services: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  showHighlights: {\n    allowInBrowserExt: false,\n    defaultValue: 'always',\n    getValue: settings => settings.showHighlights,\n  },\n  notebookAppUrl: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.notebookAppUrl,\n  },\n  profileAppUrl: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.profileAppUrl,\n  },\n  sidebarAppUrl: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: settings => settings.sidebarAppUrl,\n  },\n  // Sub-frame identifier given when a frame is being embedded into\n  // by a top level client\n  subFrameIdentifier: {\n    allowInBrowserExt: true,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n  externalContainerSelector: {\n    allowInBrowserExt: false,\n    defaultValue: null,\n    getValue: getHostPageSetting,\n  },\n};\n\n/**\n * Return the subset of Hypothesis client configuration that is relevant in\n * a particular context.\n *\n * See https://h.readthedocs.io/projects/client/en/latest/publishers/config/\n * for details of all available configuration and the different ways they\n * can be included on the page. In addition to the configuration provided by\n * the embedder, the boot script also passes some additional configuration\n * to the annotator, such as URLs of the various sub-applications and the\n * boot script itself.\n */\nexport function getConfig(context: Context, window_: Window = window) {\n  const settings = settingsFrom(window_);\n  const config: Record<string, unknown> = {};\n\n  // Filter the config based on the application context as some config values\n  // may be inappropriate or erroneous for some applications.\n  for (const key of configurationKeys(context)) {\n    const configDef = configDefinitions[key];\n    const hasDefault = configDef.defaultValue !== undefined; // A default could be null\n    const isURLFromBrowserExtension = isBrowserExtension(\n      urlFromLinkTag(window_, 'sidebar', 'html')\n    );\n\n    // Only allow certain values in the browser extension context\n    if (!configDef.allowInBrowserExt && isURLFromBrowserExtension) {\n      // If the value is not allowed here, then set to the default if provided, otherwise ignore\n      // the key:value pair\n      if (hasDefault) {\n        config[key] = configDef.defaultValue;\n      }\n      continue;\n    }\n\n    // Get the value from the configuration source\n    const value = configDef.getValue(settings, key);\n    if (value === undefined) {\n      // If there is no value (e.g. undefined), then set to the default if provided,\n      // otherwise ignore the config key:value pair\n      if (hasDefault) {\n        config[key] = configDef.defaultValue;\n      }\n      continue;\n    }\n\n    // Finally, run the value through an optional coerce method\n    config[key] = configDef.coerce ? configDef.coerce(value) : value;\n  }\n\n  return config;\n}\n","/**\n * Returns true if this instance of the Hypothesis client is one distributed in\n * a browser extension, false if it's one embedded in a website.\n */\nexport function isBrowserExtension(url: string): boolean {\n  return !(url.startsWith('http://') || url.startsWith('https://'));\n}\n","var n,l,u,i,t,r,o,f,e,c={},s=[],a=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function h(n,l){for(var u in l)n[u]=l[u];return n}function v(n){var l=n.parentNode;l&&l.removeChild(n)}function y(l,u,i){var t,r,o,f={};for(o in u)\"key\"==o?t=u[o]:\"ref\"==o?r=u[o]:f[o]=u[o];if(arguments.length>2&&(f.children=arguments.length>3?n.call(arguments,2):i),\"function\"==typeof l&&null!=l.defaultProps)for(o in l.defaultProps)void 0===f[o]&&(f[o]=l.defaultProps[o]);return p(l,f,t,r,null)}function p(n,i,t,r,o){var f={type:n,props:i,key:t,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:null==o?++u:o};return null==o&&null!=l.vnode&&l.vnode(f),f}function d(){return{current:null}}function _(n){return n.children}function k(n,l){this.props=n,this.context=l}function b(n,l){if(null==l)return n.__?b(n.__,n.__.__k.indexOf(n)+1):null;for(var u;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e)return u.__e;return\"function\"==typeof n.type?b(n):null}function g(n){var l,u;if(null!=(n=n.__)&&null!=n.__c){for(n.__e=n.__c.base=null,l=0;l<n.__k.length;l++)if(null!=(u=n.__k[l])&&null!=u.__e){n.__e=n.__c.base=u.__e;break}return g(n)}}function m(n){(!n.__d&&(n.__d=!0)&&t.push(n)&&!w.__r++||r!==l.debounceRendering)&&((r=l.debounceRendering)||o)(w)}function w(){var n,l,u,i,r,o,e,c;for(t.sort(f);n=t.shift();)n.__d&&(l=t.length,i=void 0,r=void 0,e=(o=(u=n).__v).__e,(c=u.__P)&&(i=[],(r=h({},o)).__v=o.__v+1,L(c,o,r,u.__n,void 0!==c.ownerSVGElement,null!=o.__h?[e]:null,i,null==e?b(o):e,o.__h),M(i,o),o.__e!=e&&g(o)),t.length>l&&t.sort(f));w.__r=0}function x(n,l,u,i,t,r,o,f,e,a){var h,v,y,d,k,g,m,w=i&&i.__k||s,x=w.length;for(u.__k=[],h=0;h<l.length;h++)if(null!=(d=u.__k[h]=null==(d=l[h])||\"boolean\"==typeof d||\"function\"==typeof d?null:\"string\"==typeof d||\"number\"==typeof d||\"bigint\"==typeof d?p(null,d,null,null,d):Array.isArray(d)?p(_,{children:d},null,null,null):d.__b>0?p(d.type,d.props,d.key,d.ref?d.ref:null,d.__v):d)){if(d.__=u,d.__b=u.__b+1,null===(y=w[h])||y&&d.key==y.key&&d.type===y.type)w[h]=void 0;else for(v=0;v<x;v++){if((y=w[v])&&d.key==y.key&&d.type===y.type){w[v]=void 0;break}y=null}L(n,d,y=y||c,t,r,o,f,e,a),k=d.__e,(v=d.ref)&&y.ref!=v&&(m||(m=[]),y.ref&&m.push(y.ref,null,d),m.push(v,d.__c||k,d)),null!=k?(null==g&&(g=k),\"function\"==typeof d.type&&d.__k===y.__k?d.__d=e=A(d,e,n):e=C(n,d,y,w,k,e),\"function\"==typeof u.type&&(u.__d=e)):e&&y.__e==e&&e.parentNode!=n&&(e=b(y))}for(u.__e=g,h=x;h--;)null!=w[h]&&(\"function\"==typeof u.type&&null!=w[h].__e&&w[h].__e==u.__d&&(u.__d=$(i).nextSibling),S(w[h],w[h]));if(m)for(h=0;h<m.length;h++)O(m[h],m[++h],m[++h])}function A(n,l,u){for(var i,t=n.__k,r=0;t&&r<t.length;r++)(i=t[r])&&(i.__=n,l=\"function\"==typeof i.type?A(i,l,u):C(u,i,i,t,i.__e,l));return l}function P(n,l){return l=l||[],null==n||\"boolean\"==typeof n||(Array.isArray(n)?n.some(function(n){P(n,l)}):l.push(n)),l}function C(n,l,u,i,t,r){var o,f,e;if(void 0!==l.__d)o=l.__d,l.__d=void 0;else if(null==u||t!=r||null==t.parentNode)n:if(null==r||r.parentNode!==n)n.appendChild(t),o=null;else{for(f=r,e=0;(f=f.nextSibling)&&e<i.length;e+=1)if(f==t)break n;n.insertBefore(t,r),o=r}return void 0!==o?o:t.nextSibling}function $(n){var l,u,i;if(null==n.type||\"string\"==typeof n.type)return n.__e;if(n.__k)for(l=n.__k.length-1;l>=0;l--)if((u=n.__k[l])&&(i=$(u)))return i;return null}function H(n,l,u,i,t){var r;for(r in u)\"children\"===r||\"key\"===r||r in l||T(n,r,null,u[r],i);for(r in l)t&&\"function\"!=typeof l[r]||\"children\"===r||\"key\"===r||\"value\"===r||\"checked\"===r||u[r]===l[r]||T(n,r,l[r],u[r],i)}function I(n,l,u){\"-\"===l[0]?n.setProperty(l,null==u?\"\":u):n[l]=null==u?\"\":\"number\"!=typeof u||a.test(l)?u:u+\"px\"}function T(n,l,u,i,t){var r;n:if(\"style\"===l)if(\"string\"==typeof u)n.style.cssText=u;else{if(\"string\"==typeof i&&(n.style.cssText=i=\"\"),i)for(l in i)u&&l in u||I(n.style,l,\"\");if(u)for(l in u)i&&u[l]===i[l]||I(n.style,l,u[l])}else if(\"o\"===l[0]&&\"n\"===l[1])r=l!==(l=l.replace(/Capture$/,\"\")),l=l.toLowerCase()in n?l.toLowerCase().slice(2):l.slice(2),n.l||(n.l={}),n.l[l+r]=u,u?i||n.addEventListener(l,r?z:j,r):n.removeEventListener(l,r?z:j,r);else if(\"dangerouslySetInnerHTML\"!==l){if(t)l=l.replace(/xlink(H|:h)/,\"h\").replace(/sName$/,\"s\");else if(\"width\"!==l&&\"height\"!==l&&\"href\"!==l&&\"list\"!==l&&\"form\"!==l&&\"tabIndex\"!==l&&\"download\"!==l&&l in n)try{n[l]=null==u?\"\":u;break n}catch(n){}\"function\"==typeof u||(null==u||!1===u&&\"-\"!==l[4]?n.removeAttribute(l):n.setAttribute(l,u))}}function j(n){return this.l[n.type+!1](l.event?l.event(n):n)}function z(n){return this.l[n.type+!0](l.event?l.event(n):n)}function L(n,u,i,t,r,o,f,e,c){var s,a,v,y,p,d,b,g,m,w,A,P,C,$,H,I=u.type;if(void 0!==u.constructor)return null;null!=i.__h&&(c=i.__h,e=u.__e=i.__e,u.__h=null,o=[e]),(s=l.__b)&&s(u);try{n:if(\"function\"==typeof I){if(g=u.props,m=(s=I.contextType)&&t[s.__c],w=s?m?m.props.value:s.__:t,i.__c?b=(a=u.__c=i.__c).__=a.__E:(\"prototype\"in I&&I.prototype.render?u.__c=a=new I(g,w):(u.__c=a=new k(g,w),a.constructor=I,a.render=q),m&&m.sub(a),a.props=g,a.state||(a.state={}),a.context=w,a.__n=t,v=a.__d=!0,a.__h=[],a._sb=[]),null==a.__s&&(a.__s=a.state),null!=I.getDerivedStateFromProps&&(a.__s==a.state&&(a.__s=h({},a.__s)),h(a.__s,I.getDerivedStateFromProps(g,a.__s))),y=a.props,p=a.state,a.__v=u,v)null==I.getDerivedStateFromProps&&null!=a.componentWillMount&&a.componentWillMount(),null!=a.componentDidMount&&a.__h.push(a.componentDidMount);else{if(null==I.getDerivedStateFromProps&&g!==y&&null!=a.componentWillReceiveProps&&a.componentWillReceiveProps(g,w),!a.__e&&null!=a.shouldComponentUpdate&&!1===a.shouldComponentUpdate(g,a.__s,w)||u.__v===i.__v){for(u.__v!==i.__v&&(a.props=g,a.state=a.__s,a.__d=!1),a.__e=!1,u.__e=i.__e,u.__k=i.__k,u.__k.forEach(function(n){n&&(n.__=u)}),A=0;A<a._sb.length;A++)a.__h.push(a._sb[A]);a._sb=[],a.__h.length&&f.push(a);break n}null!=a.componentWillUpdate&&a.componentWillUpdate(g,a.__s,w),null!=a.componentDidUpdate&&a.__h.push(function(){a.componentDidUpdate(y,p,d)})}if(a.context=w,a.props=g,a.__P=n,P=l.__r,C=0,\"prototype\"in I&&I.prototype.render){for(a.state=a.__s,a.__d=!1,P&&P(u),s=a.render(a.props,a.state,a.context),$=0;$<a._sb.length;$++)a.__h.push(a._sb[$]);a._sb=[]}else do{a.__d=!1,P&&P(u),s=a.render(a.props,a.state,a.context),a.state=a.__s}while(a.__d&&++C<25);a.state=a.__s,null!=a.getChildContext&&(t=h(h({},t),a.getChildContext())),v||null==a.getSnapshotBeforeUpdate||(d=a.getSnapshotBeforeUpdate(y,p)),H=null!=s&&s.type===_&&null==s.key?s.props.children:s,x(n,Array.isArray(H)?H:[H],u,i,t,r,o,f,e,c),a.base=u.__e,u.__h=null,a.__h.length&&f.push(a),b&&(a.__E=a.__=null),a.__e=!1}else null==o&&u.__v===i.__v?(u.__k=i.__k,u.__e=i.__e):u.__e=N(i.__e,u,i,t,r,o,f,c);(s=l.diffed)&&s(u)}catch(n){u.__v=null,(c||null!=o)&&(u.__e=e,u.__h=!!c,o[o.indexOf(e)]=null),l.__e(n,u,i)}}function M(n,u){l.__c&&l.__c(u,n),n.some(function(u){try{n=u.__h,u.__h=[],n.some(function(n){n.call(u)})}catch(n){l.__e(n,u.__v)}})}function N(l,u,i,t,r,o,f,e){var s,a,h,y=i.props,p=u.props,d=u.type,_=0;if(\"svg\"===d&&(r=!0),null!=o)for(;_<o.length;_++)if((s=o[_])&&\"setAttribute\"in s==!!d&&(d?s.localName===d:3===s.nodeType)){l=s,o[_]=null;break}if(null==l){if(null===d)return document.createTextNode(p);l=r?document.createElementNS(\"http://www.w3.org/2000/svg\",d):document.createElement(d,p.is&&p),o=null,e=!1}if(null===d)y===p||e&&l.data===p||(l.data=p);else{if(o=o&&n.call(l.childNodes),a=(y=i.props||c).dangerouslySetInnerHTML,h=p.dangerouslySetInnerHTML,!e){if(null!=o)for(y={},_=0;_<l.attributes.length;_++)y[l.attributes[_].name]=l.attributes[_].value;(h||a)&&(h&&(a&&h.__html==a.__html||h.__html===l.innerHTML)||(l.innerHTML=h&&h.__html||\"\"))}if(H(l,p,y,r,e),h)u.__k=[];else if(_=u.props.children,x(l,Array.isArray(_)?_:[_],u,i,t,r&&\"foreignObject\"!==d,o,f,o?o[0]:i.__k&&b(i,0),e),null!=o)for(_=o.length;_--;)null!=o[_]&&v(o[_]);e||(\"value\"in p&&void 0!==(_=p.value)&&(_!==l.value||\"progress\"===d&&!_||\"option\"===d&&_!==y.value)&&T(l,\"value\",_,y.value,!1),\"checked\"in p&&void 0!==(_=p.checked)&&_!==l.checked&&T(l,\"checked\",_,y.checked,!1))}return l}function O(n,u,i){try{\"function\"==typeof n?n(u):n.current=u}catch(n){l.__e(n,i)}}function S(n,u,i){var t,r;if(l.unmount&&l.unmount(n),(t=n.ref)&&(t.current&&t.current!==n.__e||O(t,null,u)),null!=(t=n.__c)){if(t.componentWillUnmount)try{t.componentWillUnmount()}catch(n){l.__e(n,u)}t.base=t.__P=null,n.__c=void 0}if(t=n.__k)for(r=0;r<t.length;r++)t[r]&&S(t[r],u,i||\"function\"!=typeof n.type);i||null==n.__e||v(n.__e),n.__=n.__e=n.__d=void 0}function q(n,l,u){return this.constructor(n,u)}function B(u,i,t){var r,o,f;l.__&&l.__(u,i),o=(r=\"function\"==typeof t)?null:t&&t.__k||i.__k,f=[],L(i,u=(!r&&t||i).__k=y(_,null,[u]),o||c,c,void 0!==i.ownerSVGElement,!r&&t?[t]:o?null:i.firstChild?n.call(i.childNodes):null,f,!r&&t?t:o?o.__e:i.firstChild,r),M(f,u)}function D(n,l){B(n,l,D)}function E(l,u,i){var t,r,o,f=h({},l.props);for(o in u)\"key\"==o?t=u[o]:\"ref\"==o?r=u[o]:f[o]=u[o];return arguments.length>2&&(f.children=arguments.length>3?n.call(arguments,2):i),p(l.type,f,t||l.key,r||l.ref,null)}function F(n,l){var u={__c:l=\"__cC\"+e++,__:n,Consumer:function(n,l){return n.children(l)},Provider:function(n){var u,i;return this.getChildContext||(u=[],(i={})[l]=this,this.getChildContext=function(){return i},this.shouldComponentUpdate=function(n){this.props.value!==n.value&&u.some(function(n){n.__e=!0,m(n)})},this.sub=function(n){u.push(n);var l=n.componentWillUnmount;n.componentWillUnmount=function(){u.splice(u.indexOf(n),1),l&&l.call(n)}}),n.children}};return u.Provider.__=u.Consumer.contextType=u}n=s.slice,l={__e:function(n,l,u,i){for(var t,r,o;l=l.__;)if((t=l.__c)&&!t.__)try{if((r=t.constructor)&&null!=r.getDerivedStateFromError&&(t.setState(r.getDerivedStateFromError(n)),o=t.__d),null!=t.componentDidCatch&&(t.componentDidCatch(n,i||{}),o=t.__d),o)return t.__E=t}catch(l){n=l}throw n}},u=0,i=function(n){return null!=n&&void 0===n.constructor},k.prototype.setState=function(n,l){var u;u=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=h({},this.state),\"function\"==typeof n&&(n=n(h({},u),this.props)),n&&h(u,n),null!=n&&this.__v&&(l&&this._sb.push(l),m(this))},k.prototype.forceUpdate=function(n){this.__v&&(this.__e=!0,n&&this.__h.push(n),m(this))},k.prototype.render=_,t=[],o=\"function\"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,f=function(n,l){return n.__v.__b-l.__v.__b},w.__r=0,e=0;export{k as Component,_ as Fragment,E as cloneElement,F as createContext,y as createElement,d as createRef,y as h,D as hydrate,i as isValidElement,l as options,B as render,P as toChildArray};\n//# sourceMappingURL=preact.module.js.map\n","import{options as n}from\"preact\";var t,r,u,i,o=0,f=[],c=[],e=n.__b,a=n.__r,v=n.diffed,l=n.__c,m=n.unmount;function d(t,u){n.__h&&n.__h(r,t,o||u),o=0;var i=r.__H||(r.__H={__:[],__h:[]});return t>=i.__.length&&i.__.push({__V:c}),i.__[t]}function h(n){return o=1,s(B,n)}function s(n,u,i){var o=d(t++,2);if(o.t=n,!o.__c&&(o.__=[i?i(u):B(void 0,u),function(n){var t=o.__N?o.__N[0]:o.__[0],r=o.t(t,n);t!==r&&(o.__N=[r,o.__[1]],o.__c.setState({}))}],o.__c=r,!r.u)){var f=function(n,t,r){if(!o.__c.__H)return!0;var u=o.__c.__H.__.filter(function(n){return n.__c});if(u.every(function(n){return!n.__N}))return!c||c.call(this,n,t,r);var i=!1;return u.forEach(function(n){if(n.__N){var t=n.__[0];n.__=n.__N,n.__N=void 0,t!==n.__[0]&&(i=!0)}}),!(!i&&o.__c.props===n)&&(!c||c.call(this,n,t,r))};r.u=!0;var c=r.shouldComponentUpdate,e=r.componentWillUpdate;r.componentWillUpdate=function(n,t,r){if(this.__e){var u=c;c=void 0,f(n,t,r),c=u}e&&e.call(this,n,t,r)},r.shouldComponentUpdate=f}return o.__N||o.__}function p(u,i){var o=d(t++,3);!n.__s&&z(o.__H,i)&&(o.__=u,o.i=i,r.__H.__h.push(o))}function y(u,i){var o=d(t++,4);!n.__s&&z(o.__H,i)&&(o.__=u,o.i=i,r.__h.push(o))}function _(n){return o=5,F(function(){return{current:n}},[])}function A(n,t,r){o=6,y(function(){return\"function\"==typeof n?(n(t()),function(){return n(null)}):n?(n.current=t(),function(){return n.current=null}):void 0},null==r?r:r.concat(n))}function F(n,r){var u=d(t++,7);return z(u.__H,r)?(u.__V=n(),u.i=r,u.__h=n,u.__V):u.__}function T(n,t){return o=8,F(function(){return n},t)}function q(n){var u=r.context[n.__c],i=d(t++,9);return i.c=n,u?(null==i.__&&(i.__=!0,u.sub(r)),u.props.value):n.__}function x(t,r){n.useDebugValue&&n.useDebugValue(r?r(t):t)}function P(n){var u=d(t++,10),i=h();return u.__=n,r.componentDidCatch||(r.componentDidCatch=function(n,t){u.__&&u.__(n,t),i[1](n)}),[i[0],function(){i[1](void 0)}]}function V(){var n=d(t++,11);if(!n.__){for(var u=r.__v;null!==u&&!u.__m&&null!==u.__;)u=u.__;var i=u.__m||(u.__m=[0,0]);n.__=\"P\"+i[0]+\"-\"+i[1]++}return n.__}function b(){for(var t;t=f.shift();)if(t.__P&&t.__H)try{t.__H.__h.forEach(k),t.__H.__h.forEach(w),t.__H.__h=[]}catch(r){t.__H.__h=[],n.__e(r,t.__v)}}n.__b=function(n){r=null,e&&e(n)},n.__r=function(n){a&&a(n),t=0;var i=(r=n.__c).__H;i&&(u===r?(i.__h=[],r.__h=[],i.__.forEach(function(n){n.__N&&(n.__=n.__N),n.__V=c,n.__N=n.i=void 0})):(i.__h.forEach(k),i.__h.forEach(w),i.__h=[])),u=r},n.diffed=function(t){v&&v(t);var o=t.__c;o&&o.__H&&(o.__H.__h.length&&(1!==f.push(o)&&i===n.requestAnimationFrame||((i=n.requestAnimationFrame)||j)(b)),o.__H.__.forEach(function(n){n.i&&(n.__H=n.i),n.__V!==c&&(n.__=n.__V),n.i=void 0,n.__V=c})),u=r=null},n.__c=function(t,r){r.some(function(t){try{t.__h.forEach(k),t.__h=t.__h.filter(function(n){return!n.__||w(n)})}catch(u){r.some(function(n){n.__h&&(n.__h=[])}),r=[],n.__e(u,t.__v)}}),l&&l(t,r)},n.unmount=function(t){m&&m(t);var r,u=t.__c;u&&u.__H&&(u.__H.__.forEach(function(n){try{k(n)}catch(n){r=n}}),u.__H=void 0,r&&n.__e(r,u.__v))};var g=\"function\"==typeof requestAnimationFrame;function j(n){var t,r=function(){clearTimeout(u),g&&cancelAnimationFrame(t),setTimeout(n)},u=setTimeout(r,100);g&&(t=requestAnimationFrame(r))}function k(n){var t=r,u=n.__c;\"function\"==typeof u&&(n.__c=void 0,u()),r=t}function w(n){var t=r;n.__c=n.__(),r=t}function z(n,t){return!n||n.length!==t.length||t.some(function(t,r){return t!==n[r]})}function B(n,t){return\"function\"==typeof t?t(n):t}export{T as useCallback,q as useContext,x as useDebugValue,p as useEffect,P as useErrorBoundary,V as useId,A as useImperativeHandle,y as useLayoutEffect,F as useMemo,s as useReducer,_ as useRef,h as useState};\n//# sourceMappingURL=hooks.module.js.map\n","import { useEffect } from 'preact/hooks';\n\n/**\n * Bit flags indicating modifiers required by a shortcut or pressed in a key event.\n */\nconst modifiers = {\n  alt: 1,\n  ctrl: 2,\n  meta: 4,\n  shift: 8,\n} as Record<string, number>;\n\n/**\n * Match a `shortcut` key sequence against a keydown event.\n *\n * A shortcut key sequence is a string of \"+\"-separated keyboard modifiers and\n * keys. The list may contain zero or more modifiers and must contain exactly\n * one non-modifier key. The key and modifier names are case-insensitive.\n * For example \"Ctrl+Enter\", \"shift+a\".\n *\n * Key names are matched against {@link KeyboardEvent.key}. Be aware that this\n * property is affected by the modifiers for certain keys. For example on a US\n * QWERTY keyboard, \"Shift+1\" would not match any event because the key value\n * would be \"!\" instead. See also https://github.com/w3c/uievents/issues/247.\n */\nexport function matchShortcut(event: KeyboardEvent, shortcut: string): boolean {\n  const parts = shortcut.split('+').map(p => p.toLowerCase());\n\n  let requiredModifiers = 0;\n  let requiredKey = null;\n\n  for (const part of parts) {\n    const modifierFlag = modifiers[part];\n    if (modifierFlag) {\n      requiredModifiers |= modifierFlag;\n    } else if (requiredKey === null) {\n      requiredKey = part;\n    } else {\n      throw new Error('Multiple non-modifier keys specified');\n    }\n  }\n\n  if (!requiredKey) {\n    throw new Error(`Invalid shortcut: ${shortcut}`);\n  }\n\n  const actualModifiers =\n    (event.ctrlKey ? modifiers.ctrl : 0) |\n    (event.metaKey ? modifiers.meta : 0) |\n    (event.altKey ? modifiers.alt : 0) |\n    (event.shiftKey ? modifiers.shift : 0);\n\n  return (\n    actualModifiers === requiredModifiers &&\n    event.key.toLowerCase() === requiredKey\n  );\n}\n\nexport type ShortcutOptions = {\n  /**\n   * Element on which the key event listener should be installed. Defaults to\n   * `document.body`.\n   */\n  rootElement?: HTMLElement;\n};\n\n/**\n * Install a shortcut key listener on the document.\n *\n * This can be used directly outside of a component. To use within a Preact\n * component, you probably want {@link useShortcut}.\n *\n * @param shortcut - Shortcut key sequence. See {@link matchShortcut}.\n * @param onPress - A function to call when the shortcut matches\n * @return A function that removes the shortcut\n */\nexport function installShortcut(\n  shortcut: string,\n  onPress: (e: KeyboardEvent) => void,\n  {\n    // We use `documentElement` as the root element rather than `document.body`\n    // which is used as a root element in some other places because the body\n    // element is not keyboard-focusable in XHTML documents in Safari/Chrome.\n    // See https://github.com/hypothesis/client/issues/4364.\n    rootElement = document.documentElement,\n  }: ShortcutOptions = {}\n) {\n  const onKeydown = (event: KeyboardEvent) => {\n    if (matchShortcut(event, shortcut)) {\n      onPress(event);\n    }\n  };\n  rootElement.addEventListener('keydown', onKeydown);\n  return () => rootElement.removeEventListener('keydown', onKeydown);\n}\n\n/**\n * An effect hook that installs a shortcut using {@link installShortcut} and\n * removes it when the component is unmounted.\n *\n * This provides a convenient way to enable a document-level shortcut while\n * a component is mounted. This differs from adding an `onKeyDown` handler to\n * one of the component's DOM elements in that it doesn't require the component\n * to have focus.\n *\n * To conditionally disable the shortcut, set `shortcut` to `null`.\n *\n * @param shortcut - A shortcut key sequence to match or `null` to disable. See {@link matchShortcut}.\n * @param onPress - A function to call when the shortcut matches\n */\nexport function useShortcut(\n  shortcut: string | null,\n  onPress: (e: KeyboardEvent) => void,\n  { rootElement }: ShortcutOptions = {}\n) {\n  useEffect(() => {\n    if (!shortcut) {\n      return undefined;\n    }\n    return installShortcut(shortcut, onPress, { rootElement });\n  }, [shortcut, onPress, rootElement]);\n}\n","/**\n * Helper methods to identify browser versions and os types\n */\n\n/**\n * Returns true when the OS is Mac OS.\n *\n * @param _userAgent {string} - Test seam\n */\nexport const isMacOS = (_userAgent = window.navigator.userAgent) => {\n  return _userAgent.indexOf('Mac OS') >= 0;\n};\n\n/**\n * Returns true when device is iOS.\n * https://stackoverflow.com/a/9039885/14463679\n *\n * @param _navigator {{platform: string, userAgent: string}}\n * @param _ontouchend {boolean}\n */\nexport const isIOS = (\n  _navigator = window.navigator,\n  _ontouchend = 'ontouchend' in document\n) => {\n  return (\n    [\n      'iPad Simulator',\n      'iPhone Simulator',\n      'iPod Simulator',\n      'iPad',\n      'iPhone',\n      'iPod',\n    ].includes(_navigator.platform) ||\n    // iPad on iOS 13 detection\n    (_navigator.userAgent.includes('Mac') && _ontouchend)\n  );\n};\n\n/**\n * Returns true when the device is a touch device such\n * as android or iOS.\n * https://developer.mozilla.org/en-US/docs/Web/CSS/@media/pointer#browser_compatibility\n *\n * @param _window {Window} - Test seam\n */\nexport const isTouchDevice = (_window = window) => {\n  return _window.matchMedia('(pointer: coarse)').matches;\n};\n","import{options as r}from\"preact\";export{Fragment}from\"preact\";var _=0;function o(o,e,n,t,f,l){var s,u,a={};for(u in e)\"ref\"==u?s=e[u]:a[u]=e[u];var i={type:o,props:a,key:n,ref:s,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,__h:null,constructor:void 0,__v:--_,__source:f,__self:l};if(\"function\"==typeof o&&(s=o.defaultProps))for(u in s)void 0===a[u]&&(a[u]=s[u]);return r.vnode&&r.vnode(i),i}export{o as jsx,o as jsxDEV,o as jsxs};\n//# sourceMappingURL=jsxRuntime.module.js.map\n","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Annotate.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from annotate.svg\n */\nexport default function AnnotateIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"AnnotateIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      fill: \"currentColor\",\n      d: \"M15 0c.27 0 .505.099.703.297A.961.961 0 0 1 16 1v15l-4-3H1a.974.974 0 0 1-.703-.29A.953.953 0 0 1 0 12V1A.96.96 0 0 1 .29.29.966.966 0 0 1 1 0h14zM7 3l-.469.063c-.312.041-.656.187-1.031.437-.375.25-.719.646-1.031 1.188C4.156 5.229 4 6 4 7l.002.063.006.062a.896.896 0 0 1 .008.11l-.002.074-.006.066a1.447 1.447 0 0 0 .43 1.188C4.729 8.854 5.082 9 5.5 9c.417 0 .77-.146 1.063-.438C6.854 8.271 7 7.918 7 7.5c0-.417-.146-.77-.438-1.063A1.447 1.447 0 0 0 5.5 6a1.467 1.467 0 0 0-.422.062c.177-1.03.542-1.632 1.094-1.804L7 4V3zm5 0-.469.063c-.312.041-.656.187-1.031.437-.375.25-.719.646-1.031 1.188C9.156 5.229 9 6 9 7l.002.063.006.062a.896.896 0 0 1 .008.11l-.002.074-.006.066a1.447 1.447 0 0 0 .43 1.188c.291.291.645.437 1.062.437.417 0 .77-.146 1.063-.438.291-.291.437-.645.437-1.062 0-.417-.146-.77-.438-1.063A1.447 1.447 0 0 0 10.5 6a1.467 1.467 0 0 0-.422.062c.177-1.03.542-1.632 1.094-1.804L12 4V3z\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 19,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Annotate.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Cancel.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from cancel.svg\n */\nexport default function CancelIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"CancelIcon\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      fill: \"none\",\n      \"fill-rule\": \"evenodd\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 21,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"m8 8 3.536-3.536L8 8 4.464 4.464 8 8zm0 0-3.536 3.536L8 8l3.536 3.536L8 8z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 22,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Cancel.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/CaretDown.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from caret-down.svg\n */\nexport default function CaretDownIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"CaretDownIcon\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      fill: \"none\",\n      \"fill-rule\": \"evenodd\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 21,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"m12 6-4 4-4-4\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 22,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=CaretDown.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/CaretLeft.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from caret-left.svg\n */\nexport default function CaretLeftIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"CaretLeftIcon\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      fill: \"none\",\n      \"fill-rule\": \"evenodd\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 21,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"M10 12 6 8l4-4\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 22,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=CaretLeft.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/CaretRight.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from caret-right.svg\n */\nexport default function CaretRightIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"CaretRightIcon\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      fill: \"none\",\n      \"fill-rule\": \"evenodd\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 21,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"m6 4 4 4-4 4\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 22,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=CaretRight.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Caution.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from caution.svg\n */\nexport default function CautionIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    fill: \"none\",\n    stroke: \"currentColor\",\n    \"stroke-linecap\": \"round\",\n    \"stroke-linejoin\": \"round\",\n    \"stroke-width\": \"2.5\",\n    viewBox: \"0 0 24 24\",\n    \"data-component\": \"CautionIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      d: \"M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 24,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Caution.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Check.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from check.svg\n */\nexport default function CheckIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"CheckIcon\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      fill: \"none\",\n      \"fill-rule\": \"evenodd\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 20,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"M13 3 6 13 3 8\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 21,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 19,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Check.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Hide.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from hide.svg\n */\nexport default function HideIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"HideIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      fill: \"currentColor\",\n      d: \"m1.613.21.094.083 14 14a1 1 0 0 1-1.32 1.497l-.094-.083-14-14A1 1 0 0 1 1.613.21Zm.583 4.845a1 1 0 0 1 .292 1.384C2.165 6.935 2 7.46 2 8c0 2.123 2.628 4 6 4 .22 0 .44-.008.657-.024a1 1 0 0 1 .147 1.994c-.266.02-.534.03-.804.03-4.36 0-8-2.6-8-6 0-.937.283-1.84.812-2.653a1 1 0 0 1 1.384-.292ZM8 2c4.36 0 8 2.6 8 6 0 .937-.283 1.84-.812 2.653a1 1 0 0 1-1.676-1.092C13.835 9.065 14 8.54 14 8c0-2.123-2.628-4-6-4-.22 0-.44.008-.657.024a1 1 0 1 1-.147-1.994C7.462 2.01 7.73 2 8 2Z\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Hide.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Highlight.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from highlight.svg\n */\nexport default function HighlightIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"HighlightIcon\",\n    ...props,\n    children: _jsxDEV(\"g\", {\n      fill: \"none\",\n      \"fill-rule\": \"evenodd\",\n      children: [_jsxDEV(\"path\", {\n        d: \"M0 0h16v16H0z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 21,\n        columnNumber: 9\n      }, this), _jsxDEV(\"path\", {\n        stroke: \"currentColor\",\n        \"stroke-linecap\": \"round\",\n        \"stroke-linejoin\": \"round\",\n        \"stroke-width\": \"2\",\n        d: \"M12 15H1h11zm-.5-6v2l-1 1v-2l1-1zm.5-7v6h-2V2h2zm0-1h-2 2zm0 8h-2 2z\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 22,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Highlight.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Note.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from note.svg\n */\nexport default function NoteIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"NoteIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      fill: \"currentColor\",\n      d: \"M14 0a2 2 0 0 1 1.995 1.85L16 2v7a1 1 0 0 1-.31.724l-.09.076-8 6a1 1 0 0 1-.471.192L7 16H2a2 2 0 0 1-1.995-1.85L0 14V2A2 2 0 0 1 1.85.005L2 0h12Zm0 2H2v12h4V9a1 1 0 0 1 .883-.993L7 8h7V2Zm-2 8H8v3l4-3Z\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Note.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/PointerDown.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from pointer-down.svg\n */\nexport default function PointerDownIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"9\",\n    \"data-component\": \"PointerDownIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      stroke: \"currentColor\",\n      d: \"m15.5 0-7 8-8-8\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 18,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=PointerDown.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/PointerUp.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from pointer-up.svg\n */\nexport default function PointerUpIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"9\",\n    \"data-component\": \"PointerUpIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      stroke: \"currentColor\",\n      d: \"m.5 9 7-8 8 8\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 18,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=PointerUp.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/icons/Show.tsx\"; // This file was auto-generated using scripts/generate-icons.js\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Icon generated from show.svg\n */\nexport default function ShowIcon(props) {\n  return _jsxDEV(\"svg\", {\n    xmlns: \"http://www.w3.org/2000/svg\",\n    width: \"16\",\n    height: \"16\",\n    \"aria-hidden\": \"true\",\n    viewBox: \"0 0 16 16\",\n    \"data-component\": \"ShowIcon\",\n    ...props,\n    children: _jsxDEV(\"path\", {\n      fill: \"currentColor\",\n      d: \"M8 2c4.36 0 8 2.6 8 6s-3.64 6-8 6c-4.36 0-8-2.6-8-6s3.64-6 8-6Zm0 2C4.628 4 2 5.877 2 8s2.628 4 6 4 6-1.877 6-4-2.628-4-6-4Zm0 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4Z\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 20,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 11,\n    columnNumber: 5\n  }, this);\n}\n//# sourceMappingURL=Show.js.map","/*!\n\tCopyright (c) 2018 Jed Watson.\n\tLicensed under the MIT License (MIT), see\n\thttp://jedwatson.github.io/classnames\n*/\n/* global define */\n\n(function () {\n\t'use strict';\n\n\tvar hasOwn = {}.hasOwnProperty;\n\tvar nativeCodeString = '[native code]';\n\n\tfunction classNames() {\n\t\tvar classes = [];\n\n\t\tfor (var i = 0; i < arguments.length; i++) {\n\t\t\tvar arg = arguments[i];\n\t\t\tif (!arg) continue;\n\n\t\t\tvar argType = typeof arg;\n\n\t\t\tif (argType === 'string' || argType === 'number') {\n\t\t\t\tclasses.push(arg);\n\t\t\t} else if (Array.isArray(arg)) {\n\t\t\t\tif (arg.length) {\n\t\t\t\t\tvar inner = classNames.apply(null, arg);\n\t\t\t\t\tif (inner) {\n\t\t\t\t\t\tclasses.push(inner);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (argType === 'object') {\n\t\t\t\tif (arg.toString !== Object.prototype.toString && !arg.toString.toString().includes('[native code]')) {\n\t\t\t\t\tclasses.push(arg.toString());\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tfor (var key in arg) {\n\t\t\t\t\tif (hasOwn.call(arg, key) && arg[key]) {\n\t\t\t\t\t\tclasses.push(key);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn classes.join(' ');\n\t}\n\n\tif (typeof module !== 'undefined' && module.exports) {\n\t\tclassNames.default = classNames;\n\t\tmodule.exports = classNames;\n\t} else if (typeof define === 'function' && typeof define.amd === 'object' && define.amd) {\n\t\t// register as 'classnames', consistent with npm package name\n\t\tdefine('classnames', [], function () {\n\t\t\treturn classNames;\n\t\t});\n\t} else {\n\t\twindow.classNames = classNames;\n\t}\n}());\n","import { createContext } from 'preact';\nconst ScrollContext = createContext({});\nexport default ScrollContext;\n//# sourceMappingURL=ScrollContext.js.map","import { createContext } from 'preact';\nconst TableContext = createContext({});\nexport default TableContext;\n//# sourceMappingURL=TableContext.js.map","import { createContext } from 'preact';\nconst TableSectionContext = createContext(null);\nexport default TableSectionContext;\n//# sourceMappingURL=TableSectionContext.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/layout/Card.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Render content in a card-like frame\n */\nconst CardNext = function Card({\n  children,\n  classes,\n  elementRef,\n  active = false,\n  variant = 'raised',\n  width = 'full',\n  ...htmlAttributes\n}) {\n  return _jsxDEV(\"div\", {\n    \"data-component\": \"Card\",\n    ...htmlAttributes,\n    ref: downcastRef(elementRef),\n    className: classnames('rounded-sm border bg-white', {\n      'shadow hover:shadow-md': variant === 'raised',\n      // default\n      'shadow-md': active && variant === 'raised'\n    }, {\n      'w-full': width === 'full',\n      // default\n      'w-auto': width === 'auto'\n      // No width is set if `width === 'custom'`\n    }, classes),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 40,\n    columnNumber: 5\n  }, this);\n};\nexport default CardNext;\n//# sourceMappingURL=Card.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/layout/CardContent.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Apply consistent spacing and padding for actions content inside a Card\n */\nconst CardContentNext = function CardContent({\n  children,\n  classes,\n  elementRef,\n  size = 'md',\n  ...htmlAttributes\n}) {\n  return _jsxDEV(\"div\", {\n    \"data-component\": \"CardContent\",\n    ...htmlAttributes,\n    ref: downcastRef(elementRef),\n    className: classnames({\n      'p-3 space-y-4': size === 'md',\n      // Default\n      'p-2 space-y-3': size === 'sm',\n      'p-4 space-y-6': size === 'lg'\n    }, classes),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 29,\n    columnNumber: 5\n  }, this);\n};\nexport default CardContentNext;\n//# sourceMappingURL=CardContent.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/input/ButtonBase.tsx\";\nimport classNames from 'classnames';\nimport { downcastRef } from '../../util/typing';\n\n/**\n * Common props used for Button components.\n */\n\n/**\n * HTML attributes accepted by button components. This eliminates conflicting\n * `icon` and `size` attributes.\n */\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Base component for Button components. Applies common attributes.\n */\nconst ButtonBaseNext = function ButtonBase({\n  elementRef,\n  children,\n  classes,\n  unstyled = false,\n  expanded,\n  pressed,\n  title,\n  role,\n  ...htmlAttributes\n}) {\n  const ariaProps = {\n    'aria-label': title\n  };\n\n  // aria-pressed and aria-expanded are not allowed for buttons with\n  // an aria role of `tab`. Instead, the aria-selected attribute is expected.\n  if (role === 'tab') {\n    ariaProps['aria-selected'] = pressed;\n  } else {\n    ariaProps['aria-pressed'] = pressed;\n    ariaProps['aria-expanded'] = expanded;\n  }\n  return _jsxDEV(\"button\", {\n    role: role !== null && role !== void 0 ? role : 'button',\n    ...ariaProps,\n    \"data-base-component\": \"ButtonBase\"\n    /* data-component will be overwritten unless this component is used directly */,\n    \"data-component\": \"ButtonBase\"\n    // Setting a default `type` can prevent undesired form submissions in\n    // certain cases\n    ,\n    type: \"button\",\n    ...htmlAttributes,\n    className: classNames({\n      'focus-visible-ring': !unstyled,\n      'transition-colors': !unstyled,\n      // Set layout for button content\n      'whitespace-nowrap flex items-center': !unstyled\n    }, classes),\n    title: title,\n    ref: downcastRef(elementRef),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 79,\n    columnNumber: 5\n  }, this);\n};\nexport default ButtonBaseNext;\n//# sourceMappingURL=ButtonBase.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/input/Button.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport ButtonBase from './ButtonBase';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Render a button with a label (`children`) and optional icon\n */\nconst ButtonNext = function Button({\n  children,\n  classes,\n  elementRef,\n  expanded,\n  pressed,\n  title,\n  icon: Icon,\n  size = 'md',\n  variant = 'secondary',\n  ...htmlAttributes\n}) {\n  return _jsxDEV(ButtonBase, {\n    \"data-component\": \"Button\",\n    ...htmlAttributes,\n    classes: classnames('focus-visible-ring transition-colors whitespace-nowrap flex items-center', 'font-semibold rounded-sm', {\n      // Variants\n      'text-grey-7 bg-grey-1 enabled:hover:text-grey-9 enabled:hover:bg-grey-2 aria-pressed:text-grey-9 aria-expanded:text-grey-9': variant === 'secondary',\n      // default\n      'text-grey-1 bg-grey-7 enabled:hover:bg-grey-8 disabled:text-grey-4': variant === 'primary'\n    }, {\n      // Sizes\n      'p-2 gap-x-2': size === 'md',\n      // default\n      'p-1 gap-x-1': size === 'xs',\n      'p-1.5 gap-x-1.5': size === 'sm',\n      'p-2.5 gap-x-1.5': size === 'lg'\n    }, classes),\n    elementRef: downcastRef(elementRef),\n    expanded: expanded,\n    pressed: pressed,\n    title: title,\n    unstyled: true,\n    children: [Icon && _jsxDEV(Icon, {\n      className: \"w-em h-em\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 71,\n      columnNumber: 16\n    }, this), children]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 43,\n    columnNumber: 5\n  }, this);\n};\nexport default ButtonNext;\n//# sourceMappingURL=Button.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/input/InputGroup.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\n\n// These styles may be applied to input components to adapt them when in\n// an InputGroup\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\nexport const inputGroupStyles = classnames(\n// All inputs within an InputGroup should have a border. Turn off border-radius\n'input-group:border input-group:rounded-none',\n// Restore border-radius on the leftmost and rightmost components in the group\n'input-group:first:rounded-l-sm input-group:last:rounded-r-sm',\n// \"Collapse\" borders between input components\n'input-group:border-l-0 input-group:first:border-l');\n/**\n * Render a container that lays out a group of input components\n */\nconst InputGroupNext = function InputGroup({\n  children,\n  classes,\n  elementRef,\n  ...htmlAttributes\n}) {\n  return _jsxDEV(\"div\", {\n    \"data-component\": \"InputGroup\",\n    ...htmlAttributes,\n    ref: downcastRef(elementRef),\n    className: classnames(\n    // Set the `.input-group` class so that children may\n    // use the `input-group:` variant in their styles\n    'input-group', 'flex items-stretch w-full justify-center', classes),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 32,\n    columnNumber: 5\n  }, this);\n};\nexport default InputGroupNext;\n//# sourceMappingURL=InputGroup.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/input/IconButton.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport ButtonBase from './ButtonBase';\nimport { inputGroupStyles } from './InputGroup';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Render a button that only contains an icon.\n */\nconst IconButtonNext = function IconButton({\n  children,\n  classes,\n  elementRef,\n  pressed,\n  expanded,\n  icon: Icon,\n  disableTouchSizing = false,\n  size = 'md',\n  title,\n  variant = 'secondary',\n  ...htmlAttributes\n}) {\n  return _jsxDEV(ButtonBase, {\n    \"data-component\": \"IconButton\",\n    ...htmlAttributes,\n    classes: classnames('focus-visible-ring transition-colors whitespace-nowrap flex items-center', 'justify-center gap-x-2 rounded-sm', {\n      // variant\n      'text-grey-7 bg-transparent enabled:hover:text-grey-9 aria-pressed:text-brand aria-expanded:text-brand': variant === 'secondary',\n      //default\n      'text-brand bg-transparent enabled:hover:text-grey-9 disabled:text-grey-7': variant === 'primary',\n      'text-grey-7 bg-grey-2 enabled:hover:text-grey-9 enabled:hover:bg-grey-3 disabled:text-grey-5 aria-pressed:bg-grey-3 aria-expanded:bg-grey-3': variant === 'dark',\n      // size\n      'p-2': size === 'md',\n      // Default\n      'p-1': size === 'xs',\n      'p-1.5': size === 'sm',\n      'p-2.5': size === 'lg',\n      // Responsive\n      'touch:min-w-touch-minimum touch:min-h-touch-minimum': !disableTouchSizing\n    },\n    // Adapt styling when this component is inside an InputGroup\n    inputGroupStyles, classes),\n    elementRef: downcastRef(elementRef),\n    title: title,\n    pressed: pressed,\n    expanded: expanded,\n    unstyled: true,\n    children: [Icon && _jsxDEV(Icon, {\n      className: \"w-em h-em\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 85,\n      columnNumber: 16\n    }, this), children]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 50,\n    columnNumber: 5\n  }, this);\n};\nexport default IconButtonNext;\n//# sourceMappingURL=IconButton.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/navigation/LinkBase.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Base component for Link components. Applies common attributes and styles.\n */\nconst LinkBaseNext = function LinkBase({\n  children,\n  classes,\n  elementRef,\n  unstyled = false,\n  ...htmlAttributes\n}) {\n  return _jsxDEV(\"a\", {\n    \"data-base-component\": \"LinkBase\"\n    /* data-component will be overwritten unless this component is used directly */,\n    \"data-component\": \"LinkBase\",\n    ...htmlAttributes,\n    className: classnames({\n      'focus-visible-ring': !unstyled\n    }, classes),\n    rel: \"noopener noreferrer\",\n    ref: downcastRef(elementRef),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 21,\n    columnNumber: 5\n  }, this);\n};\nexport default LinkBaseNext;\n//# sourceMappingURL=LinkBase.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/navigation/Link.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport LinkBase from './LinkBase';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * Styled component for a link (`<a>` element).\n */\nconst LinkNext = function Link({\n  children,\n  classes,\n  elementRef,\n  underline = 'none',\n  color = 'brand',\n  ...htmlAttributes\n}) {\n  return _jsxDEV(LinkBase, {\n    \"data-component\": \"Link\",\n    ...htmlAttributes,\n    classes: classnames('rounded-sm',\n    // NB: Base classes are applied by LinkBase\n    {\n      // color\n      'text-brand hover:text-brand-dark': color === 'brand',\n      // default\n      'text-color-text-light hover:text-brand': color === 'text-light',\n      'text-color-text hover:text-brand-dark': color === 'text'\n    }, {\n      // underline\n      'no-underline hover:no-underline': underline === 'none',\n      // default\n      'underline hover:underline': underline === 'always',\n      'no-underline hover:underline': underline === 'hover'\n    }, classes),\n    elementRef: downcastRef(elementRef),\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 31,\n    columnNumber: 5\n  }, this);\n};\nexport default LinkNext;\n//# sourceMappingURL=Link.js.map","var _jsxFileName = \"/home/runner/work/frontend-shared/frontend-shared/src/components/navigation/PointerButton.tsx\";\nimport classnames from 'classnames';\nimport { downcastRef } from '../../util/typing';\nimport ButtonBase from '../input/ButtonBase';\nimport { jsxDEV as _jsxDEV } from \"preact/jsx-dev-runtime\";\n/**\n * A button for pointing toward a quantified set of items somewhere else in the\n * UI or off-screen. When clicked, the application should navigate to the\n * indicated or implied position.\n *\n * Used by the bucket bar in the client application to point at\n * highlights/annotations in the guest document. Expected button content is\n * numeric text, e.g.:\n *\n *   <PointerButton direction=\"left\">5</PointerButton>\n *\n * The arrow-points are created by the combination of borders and positioning.\n * See https://css-tricks.com/snippets/css/css-triangle/\n */\nconst PointerButtonNext = function PointerButton({\n  children,\n  classes,\n  elementRef,\n  expanded,\n  pressed,\n  title,\n  direction,\n  ...htmlAttributes\n}) {\n  return _jsxDEV(ButtonBase, {\n    \"data-component\": \"PointerButton\",\n    ...htmlAttributes,\n    elementRef: downcastRef(elementRef),\n    classes: classnames(\n    // Establish relative positioning to allow absolute positioning of\n    // ::before and ::after pseudo-elements (the arrow pointers)\n    'relative w-[26px] h-[16px]', 'flex items-center justify-center', 'bg-white rounded-[4px] border',\n    // The borders of ::before and ::after will be used to style the arrow\n    // pointer border (grey) and fill (white) respectively\n    'before:absolute before:border-transparent', 'after:absolute after:border-transparent', 'text-[10px] text-color-text-light leading-none font-semibold', {\n      // This adds a 1-pixel x-offset to the default `shadow` (see tailwind\n      // config)\n      'shadow-[1px_1px_1px_rgba(0,0,0,0.1)]': direction !== 'down',\n      // The down arrow has no y-offset on its shadow to avoid odd edges\n      // around its down-pointing wedge\n      'shadow-[1px_0px_1px_rgba(0,0,0,0.1)]': direction === 'down'\n    },\n    // Styling for left-pointing arrows\n    {\n      'rounded-r-[4px] rounded-l-[2px]': direction === 'left',\n      // Position the right edges of ::before and ::after to align with the\n      // left edge of the button's body, centered vertically\n      'before:right-full before:top-1/2 after:right-full after:top-1/2': direction === 'left',\n      // ::before is the grey border of the left-pointing wedge, 1px wider\n      // than the fill\n      'before:mt-[-8px] before:border-8 before:border-r-[5px] before:border-r-grey-3': direction === 'left',\n      // ::after is the white fill of the left-pointing wedge. NB: ordering\n      // of these rules after the ::before rules is important for\n      // compositing order\n      'after:mt-[-7px] after:border-[7px] after:border-r-[4px] after:border-r-white': direction === 'left'\n    },\n    // Styling for up-pointing arrows\n    {\n      'z-1 rounded-t-px-sm rounded-b-px': direction === 'up',\n      // Position the bottom edges of ::before and ::after to align with the\n      // top edges of the button body. Center horizontally.\n      'before:top-auto before:left-1/2 before:bottom-full after:top-auto after:left-1/2 after:bottom-full': direction === 'up',\n      // Grey border of up-pointing wedge\n      'before:ml-[-13px] before:border-[13px] before:border-b-[6px] before:border-b-grey-3': direction === 'up',\n      // White fill of up-pointing wedge\n      'after:ml-[-12px] after:border-[12px] after:border-b-[5px] after:border-b-white': direction === 'up'\n    },\n    // Styling for down-pointing arrows\n    {\n      'z-1 rounded-t-px rounded-b-px-sm': direction === 'down',\n      // Position the top edges of ::before and ::after at the bottom of\n      // the button body. Center horizontally.\n      'before:top-full before:left-1/2 after:top-full after:left-1/2': direction === 'down',\n      // Grey border of down-pointing wedge\n      'before:ml-[-13px] before:border-[13px] before:border-t-[6px] before:border-t-grey-3': direction === 'down',\n      // White fill of down-pointing wedge\n      'after:ml-[-12px] after:border-[12px] after:border-t-[5px] after:border-t-white': direction === 'down'\n    }, classes),\n    expanded: expanded,\n    pressed: pressed,\n    title: title,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 52,\n    columnNumber: 5\n  }, this);\n};\nexport default PointerButtonNext;\n//# sourceMappingURL=PointerButton.js.map","import {\n  AnnotateIcon,\n  ButtonBase,\n  HighlightIcon,\n  PointerDownIcon,\n  PointerUpIcon,\n} from '@hypothesis/frontend-shared/lib/next';\nimport type { IconComponent } from '@hypothesis/frontend-shared/lib/types';\nimport classnames from 'classnames';\n\nimport { useShortcut } from '../../shared/shortcut';\n\n/**\n * Render an inverted light-on-dark \"pill\" with the given `badgeCount`\n * (annotation count). This is rendered instead of an icon on the toolbar\n * button for \"show\"-ing associated annotations for the current selection.\n */\nfunction NumberIcon({ badgeCount }: { badgeCount: number }) {\n  return (\n    <span\n      className={classnames(\n        'rounded px-1 py-0.5',\n        // The background color is inherited from the current text color in\n        // the containing button and will vary depending on hover state.\n        'bg-current'\n      )}\n    >\n      <span className=\"font-bold text-color-text-inverted\">{badgeCount}</span>\n    </span>\n  );\n}\n\n/**\n * Render an arrow pointing up or down from the AdderToolbar. This arrow\n * should point roughly to the end of the user selection in the document.\n */\nfunction AdderToolbarArrow({\n  arrowDirection,\n}: {\n  arrowDirection: 'up' | 'down';\n}) {\n  return (\n    <div\n      className={classnames(\n        // Position horizontally center of the AdderToolbar\n        'absolute left-1/2 -translate-x-1/2 z-2',\n        'fill-white text-grey-3',\n        {\n          // Move the pointer to the top of the AdderToolbar\n          'top-0 -translate-y-full': arrowDirection === 'up',\n        }\n      )}\n    >\n      {arrowDirection === 'up' ? <PointerUpIcon /> : <PointerDownIcon />}\n    </div>\n  );\n}\n\ntype ToolbarButtonProps = {\n  badgeCount?: number;\n  icon?: IconComponent;\n  label: string;\n  onClick: () => void;\n  shortcut: string | null;\n};\n\nfunction ToolbarButton({\n  badgeCount,\n  icon: Icon,\n  label,\n  onClick,\n  shortcut,\n}: ToolbarButtonProps) {\n  useShortcut(shortcut, onClick);\n\n  const title = shortcut ? `${label} (${shortcut})` : label;\n\n  return (\n    <ButtonBase\n      classes={classnames(\n        'flex-col gap-y-1 py-2.5 px-2',\n        'text-annotator-sm leading-none',\n        // Default color when the toolbar is not hovered\n        'text-grey-7',\n        // When the parent .group element is hovered (but this element itself is\n        // not), dim this button's text. This has the effect of dimming inactive\n        // buttons.\n        'group-hover:text-grey-5',\n        // When the parent .group element is hovered AND this element is\n        // hovered, this is the \"active\" button. Intensify the text color, which\n        // will also darken any descendant Icon\n        'hover:group-hover:text-grey-9'\n      )}\n      onClick={onClick}\n      title={title}\n    >\n      {Icon && <Icon className=\"text-annotator-lg\" title={title} />}\n      {typeof badgeCount === 'number' && <NumberIcon badgeCount={badgeCount} />}\n      <span>{label}</span>\n    </ButtonBase>\n  );\n}\n\n/**\n * Render non-visible content for screen readers to announce adder keyboard\n * shortcuts and count of annotations associated with the current selection.\n */\nfunction AdderToolbarShortcuts({\n  annotationCount,\n  isVisible,\n}: {\n  annotationCount: number;\n  isVisible: boolean;\n}) {\n  return (\n    <div className=\"sr-only\">\n      <span\n        aria-live=\"polite\"\n        aria-atomic=\"true\"\n        role=\"status\"\n        data-testid=\"annotation-count-announce\"\n      >\n        {annotationCount > 0 && (\n          <span>\n            {annotationCount}{' '}\n            {annotationCount === 1 ? 'annotation' : 'annotations'} for this\n            selection.\n          </span>\n        )}\n      </span>\n      <ul aria-live=\"polite\" data-testid=\"annotate-shortcuts-announce\">\n        {isVisible && (\n          <>\n            {annotationCount > 0 && <li>Press {\"'S'\"} to show annotations.</li>}\n            <li>Press {\"'A'\"} to annotate.</li>\n            <li>Press {\"'H'\"} to highlight.</li>\n          </>\n        )}\n      </ul>\n    </div>\n  );\n}\n\nexport type Command = 'annotate' | 'highlight' | 'show' | 'hide';\n\ntype AdderToolbarProps = {\n  /**\n   * Number of annotations associated with the selected text. If non-zero, a\n   * Show\" button is displayed to allow the user to see the annotations that\n   * correspond to the selection.\n   */\n  annotationCount?: number;\n  /**\n   * Whether the arrow pointing out of the toolbar towards the selected text\n   * should appear above the toolbar pointing up or below the toolbar pointing\n   * down.\n   */\n  arrowDirection: 'up' | 'down';\n  /** The toolbar is always rendered, but is not always visible. */\n  isVisible: boolean;\n  /** Called when a toolbar button is clicked */\n  onCommand: (c: Command) => void;\n};\n\n/**\n * The toolbar that is displayed above or below selected text in the document,\n * providing options to create annotations or highlights.\n *\n * @param {AdderToolbarProps} props\n * The toolbar has nuanced styling for hover. The component structure is:\n *\n * <AdderToolbar>\n *   <div.group>\n *     <button.hover-group><AnnotateIcon />Annotate</button>\n *     <button.hover-group><HighlightIcon />Highlight</button>\n *     <div>[vertical separator]</div>\n *     <button.hover-group><span><NumberIcon /></span>[count]</button>\n *   </div.group>\n *   <AdderToolbarArrow />\n * </AdderToolbar>\n *\n * Behavior: When div.group is hovered, all descendant buttons and their\n * contents dim, except for the contents of the button that is directly hovered,\n * which are darkened. This is intended to make the hovered button stand out,\n * and the non-hovered buttons recede.\n *\n * This is achieved by:\n * - Setting the .group class on the div that contains the buttons. This allows\n *   buttons to style themselves based on the combination of the div.group's\n *   hover state and their own \"local\" hover state. `group` is available in\n *   Tailwind out of the box; see\n *   https://tailwindcss.com/docs/hover-focus-and-other-states#styling-based-on-parent-state\n * - The challenge is in getting the \"badge\" in NumberIcon to dim and darken its\n *   background appropriately. `hover-group-hover` is a custom tailwind variant\n *   that allows NumberIcon to style itself based on the hover states of\n *   both div.group AND its parent button.hover-group. We need to ensure this\n *   badge will darken when its parent button is hovered, even if it is not\n *   hovered directly.\n *\n */\nexport default function AdderToolbar({\n  arrowDirection,\n  isVisible,\n  onCommand,\n  annotationCount = 0,\n}: AdderToolbarProps) {\n  // Since the selection toolbar is only shown when there is a selection\n  // of static text, we can use a plain key without any modifier as\n  // the shortcut. This avoids conflicts with browser/OS shortcuts.\n  const annotateShortcut = isVisible ? 'a' : null;\n  const highlightShortcut = isVisible ? 'h' : null;\n  const showShortcut = isVisible ? 's' : null;\n  const hideShortcut = isVisible ? 'Escape' : null;\n\n  // Add a shortcut to close the adder. Note, there is no button associated with this\n  // shortcut because any outside click will also hide the adder.\n  useShortcut(hideShortcut, () => onCommand('hide'));\n\n  // nb. The adder is hidden using the `visibility` property rather than `display`\n  // so that we can compute its size in order to position it before display.\n  return (\n    <div\n      className={classnames(\n        // Reset all inherited properties to their initial values. This prevents\n        // CSS property values from the host page being inherited by elements of\n        // the Adder, even when using Shadow DOM.\n        'all-initial',\n        // As we've reset all properties to initial values, we cannot rely on\n        // default border values from Tailwind and have to be explicit about all\n        // border attributes.\n        'border border-solid border-grey-3',\n        'absolute select-none bg-white rounded shadow-adder-toolbar',\n        // Start at a very low opacity as we're going to fade in in the animation\n        'opacity-5',\n        {\n          'animate-adder-pop-up': arrowDirection === 'up' && isVisible,\n          'animate-adder-pop-down': arrowDirection === 'down' && isVisible,\n        }\n      )}\n      data-component=\"AdderToolbar\"\n      dir=\"ltr\"\n      style={{\n        visibility: isVisible ? 'visible' : 'hidden',\n      }}\n    >\n      <div\n        className={classnames(\n          // This group is used to manage hover state styling for descendant\n          // buttons\n          'flex group'\n        )}\n      >\n        <ToolbarButton\n          icon={AnnotateIcon}\n          onClick={() => onCommand('annotate')}\n          label=\"Annotate\"\n          shortcut={annotateShortcut}\n        />\n        <ToolbarButton\n          icon={HighlightIcon}\n          onClick={() => onCommand('highlight')}\n          label=\"Highlight\"\n          shortcut={highlightShortcut}\n        />\n        {annotationCount > 0 && (\n          <>\n            <div\n              className={classnames(\n                // Style a vertical separator line\n                'm-1.5 border-r border-grey-4 border-solid'\n              )}\n            />\n            <ToolbarButton\n              badgeCount={annotationCount}\n              onClick={() => onCommand('show')}\n              label=\"Show\"\n              shortcut={showShortcut}\n            />\n          </>\n        )}\n      </div>\n      <AdderToolbarArrow arrowDirection={arrowDirection} />\n      <AdderToolbarShortcuts\n        annotationCount={annotationCount}\n        isVisible={isVisible}\n      />\n    </div>\n  );\n}\n","/**\n * Load stylesheets for annotator UI components into the shadow DOM root.\n *\n * @param {ShadowRoot} shadowRoot\n */\nfunction loadStyles(shadowRoot) {\n  // Find the preloaded stylesheet added by the boot script.\n  const url = /** @type {HTMLLinkElement|undefined} */ (\n    document.querySelector(\n      'link[rel=\"preload\"][href*=\"/build/styles/annotator.css\"]'\n    )\n  )?.href;\n\n  if (!url) {\n    return;\n  }\n\n  const linkEl = document.createElement('link');\n  linkEl.rel = 'stylesheet';\n  linkEl.href = url;\n  shadowRoot.appendChild(linkEl);\n}\n\n/**\n * Create the shadow root for an annotator UI component and load the annotator\n * CSS styles into it.\n *\n * @param {HTMLElement} container - Container element to render the UI into\n * @return {ShadowRoot}\n */\nexport function createShadowRoot(container) {\n  const shadowRoot = container.attachShadow({ mode: 'open' });\n  loadStyles(shadowRoot);\n\n  // @ts-ignore The window doesn't know about the polyfill\n  // applyFocusVisiblePolyfill comes from the `focus-visible` package.\n  const applyFocusVisible = window.applyFocusVisiblePolyfill;\n  if (applyFocusVisible) {\n    applyFocusVisible(shadowRoot);\n  }\n\n  stopEventPropagation(shadowRoot);\n  return shadowRoot;\n}\n\n/**\n * Stop bubbling up of several events.\n *\n * This makes the host page a little bit less aware of the annotator activity.\n * It is still possible for the host page to manipulate the events on the capturing\n * face.\n *\n * Another benefit is that click and touchstart typically causes the sidebar to close.\n * By preventing the bubble up of these events, we don't have to individually stop\n * the propagation.\n *\n * @param {HTMLElement|ShadowRoot} element\n */\nfunction stopEventPropagation(element) {\n  element.addEventListener('mouseup', event => event.stopPropagation());\n  element.addEventListener('mousedown', event => event.stopPropagation());\n  element.addEventListener('touchstart', event => event.stopPropagation(), {\n    passive: true,\n  });\n}\n","import { render } from 'preact';\n\nimport { isTouchDevice } from '../shared/user-agent';\nimport type { Destroyable } from '../types/annotator';\nimport AdderToolbar from './components/AdderToolbar';\nimport type { Command } from './components/AdderToolbar';\nimport { createShadowRoot } from './util/shadow-root';\n\nexport enum ArrowDirection {\n  DOWN = 1,\n  UP = 2,\n}\n\ntype Target = {\n  /** Offset from left edge of viewport */\n  left: number;\n  /** Offset from top edge of viewport */\n  top: number;\n  /** Direction of the adder's arrow */\n  arrowDirection: ArrowDirection;\n};\n\nfunction toPx(pixels: number) {\n  return pixels.toString() + 'px';\n}\n\nconst ARROW_HEIGHT = 10;\n\n// The preferred gap between the end of the text selection and the adder's\n// arrow position.\nconst ARROW_H_MARGIN = 20;\n\n/**\n * Return the closest ancestor of `el` which has been positioned.\n * If no ancestor has been positioned, returns the root element.\n */\nfunction nearestPositionedAncestor(el: Element): Element {\n  let parentEl = el.parentElement!;\n  while (parentEl.parentElement) {\n    if (getComputedStyle(parentEl).position !== 'static') {\n      break;\n    }\n    parentEl = parentEl.parentElement;\n  }\n  return parentEl;\n}\n\ntype AdderOptions = {\n  /** Callback invoked when \"Annotate\" button is clicked */\n  onAnnotate: () => void;\n  /** Callback invoked when \"Highlight\" button is clicked */\n  onHighlight: () => void;\n  /** Callback invoked when  \"Show\" button is clicked */\n  onShowAnnotations: (tags: string[]) => void;\n};\n\n/**\n * Container for the 'adder' toolbar which provides controls for the user to\n * annotate and highlight the selected text.\n *\n * The toolbar implementation is split between this class, which is\n * the container for the toolbar that positions it on the page and isolates\n * it from the page's styles using shadow DOM, and the `AdderToolbar` Preact\n * component which actually renders the toolbar.\n */\nexport class Adder implements Destroyable {\n  private _outerContainer: HTMLElement;\n  private _shadowRoot: ShadowRoot;\n  private _view: Window;\n  private _isVisible: boolean;\n  private _arrowDirection: 'up' | 'down';\n  private _onAnnotate: () => void;\n  private _onHighlight: () => void;\n  private _onShowAnnotations: (tags: string[]) => void;\n  /** Annotation tags associated with the current selection. */\n  private _annotationsForSelection: string[];\n\n  /**\n   * Create the toolbar's container and hide it.\n   *\n   * The adder is initially hidden.\n   *\n   * @param element - The DOM element into which the adder will be created\n   * @param options - Options object specifying `onAnnotate` and `onHighlight`\n   *        event handlers.\n   */\n  constructor(element: HTMLElement, options: AdderOptions) {\n    this._outerContainer = document.createElement('hypothesis-adder');\n    element.appendChild(this._outerContainer);\n    this._shadowRoot = createShadowRoot(this._outerContainer);\n\n    // Set initial style\n    Object.assign(this._outerContainer.style, {\n      // take position out of layout flow initially\n      position: 'absolute',\n      top: 0,\n      left: 0,\n    });\n\n    this._view = element.ownerDocument.defaultView!;\n    this._isVisible = false;\n    this._arrowDirection = 'up';\n    this._annotationsForSelection = [];\n\n    this._onAnnotate = options.onAnnotate;\n    this._onHighlight = options.onHighlight;\n    this._onShowAnnotations = options.onShowAnnotations;\n\n    this._render();\n  }\n\n  get annotationsForSelection() {\n    return this._annotationsForSelection;\n  }\n\n  /**\n   * Set the annotation IDs associated with the current selection.\n   *\n   * Setting this to a non-empty list causes the \"Show\" button to appear in\n   * the toolbar. Clicking the \"Show\" button  triggers the `onShowAnnotations`\n   * callback passed to the constructor.\n   */\n  set annotationsForSelection(ids) {\n    this._annotationsForSelection = ids;\n    this._render();\n  }\n\n  /** Hide the adder */\n  hide() {\n    this._isVisible = false;\n    this._render();\n    // Reposition the outerContainer because it affects the responsiveness of host page\n    // https://github.com/hypothesis/client/issues/3193\n    Object.assign(this._outerContainer.style, {\n      top: 0,\n      left: 0,\n    });\n  }\n\n  destroy() {\n    render(null, this._shadowRoot); // First, unload the Preact component\n    this._outerContainer.remove();\n  }\n\n  /**\n   * Display the adder in the best position in order to target the\n   * selected text in `selectionRect`.\n   *\n   * @param selectionRect - The rect of text to target, in viewport coordinates.\n   * @param isRTLselection - True if the selection was made right-to-left, such\n   *        that the focus point is mostly likely at the top-left edge of\n   *        `targetRect`.\n   */\n  show(selectionRect: DOMRect, isRTLselection: boolean) {\n    const { left, top, arrowDirection } = this._calculateTarget(\n      selectionRect,\n      isRTLselection\n    );\n    this._showAt(left, top);\n\n    this._isVisible = true;\n    this._arrowDirection = arrowDirection === ArrowDirection.UP ? 'up' : 'down';\n\n    this._render();\n  }\n\n  private _width(): number {\n    const firstChild = this._shadowRoot.firstChild as Element;\n    return firstChild.getBoundingClientRect().width;\n  }\n\n  private _height(): number {\n    const firstChild = this._shadowRoot.firstChild as Element;\n    return firstChild.getBoundingClientRect().height;\n  }\n\n  /**\n   *  Determine the best position for the Adder and its pointer-arrow.\n   * - Position the pointer-arrow near the end of the selection (where the user's\n   *   cursor/input is most likely to be)\n   * - Position the Adder to center horizontally on the pointer-arrow\n   * - Position the Adder below the selection (arrow pointing up) for LTR selections\n   *   and above (arrow down) for RTL selections\n   *\n   * @param selectionRect - The rect of text to target, in viewport coordinates.\n   * @param isRTLselection - True if the selection was made right-to-left, such\n   *        that the focus point is mostly likely at the top-left edge of\n   *        `targetRect`.\n   */\n  private _calculateTarget(\n    selectionRect: DOMRect,\n    isRTLselection: boolean\n  ): Target {\n    // Set the initial arrow direction based on whether the selection was made\n    // forwards/upwards or downwards/backwards.\n    let arrowDirection: ArrowDirection;\n    if (isRTLselection && !isTouchDevice()) {\n      arrowDirection = ArrowDirection.DOWN;\n    } else {\n      // Render the adder below the selection for touch devices due to competing\n      // space with the native copy/paste bar that typical (not always) renders above\n      // the selection.\n      arrowDirection = ArrowDirection.UP;\n    }\n    let top;\n    let left;\n\n    // Position the adder such that the arrow it is above or below the selection\n    // and close to the end.\n    const hMargin = Math.min(ARROW_H_MARGIN, selectionRect.width);\n    const adderWidth = this._width();\n    // Render the adder a little lower on touch devices to provide room for the native\n    // selection handles so that the interactions with selection don't compete with the adder.\n    const touchScreenOffset = isTouchDevice() ? 10 : 0;\n    const adderHeight = this._height();\n    if (isRTLselection) {\n      left = selectionRect.left - adderWidth / 2 + hMargin;\n    } else {\n      left =\n        selectionRect.left + selectionRect.width - adderWidth / 2 - hMargin;\n    }\n\n    // Flip arrow direction if adder would appear above the top or below the\n    // bottom of the viewport.\n    if (\n      selectionRect.top - adderHeight < 0 &&\n      arrowDirection === ArrowDirection.DOWN\n    ) {\n      arrowDirection = ArrowDirection.UP;\n    } else if (selectionRect.top + adderHeight > this._view.innerHeight) {\n      arrowDirection = ArrowDirection.DOWN;\n    }\n\n    if (arrowDirection === ArrowDirection.UP) {\n      top =\n        selectionRect.top +\n        selectionRect.height +\n        ARROW_HEIGHT +\n        touchScreenOffset;\n    } else {\n      top = selectionRect.top - adderHeight - ARROW_HEIGHT;\n    }\n\n    // Constrain the adder to the viewport.\n    left = Math.max(left, 0);\n    left = Math.min(left, this._view.innerWidth - adderWidth);\n\n    top = Math.max(top, 0);\n    top = Math.min(top, this._view.innerHeight - adderHeight);\n\n    return { top, left, arrowDirection };\n  }\n\n  /**\n   * Find a Z index value that will cause the adder to appear on top of any\n   * content in the document when the adder is shown at (left, top).\n   *\n   * @param left - Horizontal offset from left edge of viewport.\n   * @param top - Vertical offset from top edge of viewport.\n   * @return greatest zIndex (default value of 1)\n   */\n  private _findZindex(left: number, top: number): number {\n    if (document.elementsFromPoint === undefined) {\n      // In case of not being able to use `document.elementsFromPoint`,\n      // default to the large arbitrary number (2^15)\n      return 32768;\n    }\n\n    const adderWidth = this._width();\n    const adderHeight = this._height();\n\n    // Find the Z index of all the elements in the screen for five positions\n    // around the adder (left-top, left-bottom, middle-center, right-top,\n    // right-bottom) and use the greatest.\n\n    // Unique elements so `getComputedStyle` is called the minimum amount of times.\n    const elements = new Set([\n      ...document.elementsFromPoint(left, top),\n      ...document.elementsFromPoint(left, top + adderHeight),\n      ...document.elementsFromPoint(\n        left + adderWidth / 2,\n        top + adderHeight / 2\n      ),\n      ...document.elementsFromPoint(left + adderWidth, top),\n      ...document.elementsFromPoint(left + adderWidth, top + adderHeight),\n    ]);\n\n    const zIndexes = [...elements]\n      .map(element => +getComputedStyle(element).zIndex)\n      .filter(Number.isInteger);\n\n    // Make sure the array contains at least one element,\n    // otherwise `Math.max(...[])` results in +Infinity\n    zIndexes.push(0);\n\n    return Math.max(...zIndexes) + 1;\n  }\n\n  /**\n   * Show the adder at the given position and with the arrow pointing in\n   * `arrowDirection`.\n   *\n   * @param left - Horizontal offset from left edge of viewport.\n   * @param top - Vertical offset from top edge of viewport.\n   */\n  private _showAt(left: number, top: number) {\n    // Translate the (left, top) viewport coordinates into positions relative to\n    // the adder's nearest positioned ancestor (NPA).\n    //\n    // Typically, the adder is a child of the `<body>` and the NPA is the root\n    // `<html>` element. However, page styling may make the `<body>` positioned.\n    // See https://github.com/hypothesis/client/issues/487.\n    const positionedAncestor = nearestPositionedAncestor(this._outerContainer);\n    const parentRect = positionedAncestor.getBoundingClientRect();\n\n    const zIndex = this._findZindex(left, top);\n\n    Object.assign(this._outerContainer.style, {\n      left: toPx(left - parentRect.left),\n      top: toPx(top - parentRect.top),\n      zIndex,\n    });\n  }\n\n  private _render() {\n    const handleCommand = (command: Command) => {\n      switch (command) {\n        case 'annotate':\n          this._onAnnotate();\n          this.hide();\n          break;\n        case 'highlight':\n          this._onHighlight();\n          this.hide();\n          break;\n        case 'show':\n          this._onShowAnnotations(this.annotationsForSelection);\n          break;\n        case 'hide':\n          this.hide();\n          break;\n        default:\n          break;\n      }\n    };\n\n    render(\n      <AdderToolbar\n        isVisible={this._isVisible}\n        arrowDirection={this._arrowDirection}\n        onCommand={handleCommand}\n        annotationCount={this.annotationsForSelection.length}\n      />,\n      this._shadowRoot\n    );\n  }\n}\n","/**\n * From which direction to evaluate strings or nodes: from the start of a string\n * or range seeking Forwards, or from the end seeking Backwards.\n */\nenum TrimDirection {\n  Forwards = 1,\n  Backwards,\n}\n\n/**\n * An object representing metadata for a Range position (e.g. for use with\n * Range.setStart or Range.setEnd)\n */\ntype RangePosition = {\n  offset: number;\n  node: Node;\n};\n\n/**\n * Return the offset of the nearest non-whitespace character to `baseOffset`\n * within the string `text`, looking in the `direction` indicated. Return -1 if\n * no non-whitespace character exists between `baseOffset` (inclusive) and the\n * terminus of the string (start or end depending on `direction`).\n */\nfunction closestNonSpaceInString(\n  text: string,\n  baseOffset: number,\n  direction: TrimDirection\n): number {\n  const nextChar =\n    direction === TrimDirection.Forwards ? baseOffset : baseOffset - 1;\n  if (text.charAt(nextChar).trim() !== '') {\n    // baseOffset is already valid: it points at a non-whitespace character\n    return baseOffset;\n  }\n\n  let availableChars: string;\n  let availableNonWhitespaceChars: string;\n\n  if (direction === TrimDirection.Backwards) {\n    availableChars = text.substring(0, baseOffset);\n    availableNonWhitespaceChars = availableChars.trimEnd();\n  } else {\n    availableChars = text.substring(baseOffset);\n    availableNonWhitespaceChars = availableChars.trimStart();\n  }\n\n  if (!availableNonWhitespaceChars.length) {\n    return -1;\n  }\n\n  const offsetDelta =\n    availableChars.length - availableNonWhitespaceChars.length;\n\n  return direction === TrimDirection.Backwards\n    ? baseOffset - offsetDelta\n    : baseOffset + offsetDelta;\n}\n\n/**\n * Calculate a new Range start position (TrimDirection.Forwards) or end position\n * (Backwards) for `range` that represents the nearest non-whitespace character,\n * moving into the `range` away from the relevant initial boundary node towards\n * the terminating boundary node.\n *\n * @throws {RangeError} If no text node with non-whitespace characters found\n */\nfunction closestNonSpaceInRange(\n  range: Range,\n  direction: TrimDirection\n): RangePosition {\n  const nodeIter =\n    range.commonAncestorContainer.ownerDocument!.createNodeIterator(\n      range.commonAncestorContainer,\n      NodeFilter.SHOW_TEXT\n    );\n\n  const initialBoundaryNode =\n    direction === TrimDirection.Forwards\n      ? range.startContainer\n      : range.endContainer;\n\n  const terminalBoundaryNode =\n    direction === TrimDirection.Forwards\n      ? range.endContainer\n      : range.startContainer;\n\n  let currentNode = nodeIter.nextNode();\n\n  // Advance the NodeIterator to the `initialBoundaryNode`\n  while (currentNode && currentNode !== initialBoundaryNode) {\n    currentNode = nodeIter.nextNode();\n  }\n\n  if (direction === TrimDirection.Backwards) {\n    // Reverse the NodeIterator direction. This will return the same node\n    // as the previous `nextNode()` call (initial boundary node).\n    currentNode = nodeIter.previousNode();\n  }\n\n  let trimmedOffset = -1;\n\n  const advance = () => {\n    currentNode =\n      direction === TrimDirection.Forwards\n        ? nodeIter.nextNode()\n        : nodeIter.previousNode();\n\n    if (currentNode) {\n      const nodeText = currentNode.textContent!;\n      const baseOffset =\n        direction === TrimDirection.Forwards ? 0 : nodeText.length;\n      trimmedOffset = closestNonSpaceInString(nodeText, baseOffset, direction);\n    }\n  };\n\n  while (\n    currentNode &&\n    trimmedOffset === -1 &&\n    currentNode !== terminalBoundaryNode\n  ) {\n    advance();\n  }\n\n  if (currentNode && trimmedOffset >= 0) {\n    return { node: currentNode, offset: trimmedOffset };\n  }\n  /* istanbul ignore next */\n  throw new RangeError('No text nodes with non-whitespace text found in range');\n}\n\n/**\n * Return a new DOM Range that adjusts the start and end positions of `range` as\n * needed such that:\n *\n * - `startContainer` and `endContainer` text nodes both contain at least one\n *   non-whitespace character within the Range's text content\n * - `startOffset` and `endOffset` both reference non-whitespace characters,\n *   with `startOffset` immediately before the first non-whitespace character\n *   and `endOffset` immediately after the last\n *\n * Whitespace characters are those that are removed by `String.prototype.trim()`\n *\n * @param range - A DOM Range that whose `startContainer` and `endContainer` are\n *   both text nodes, and which contains at least one non-whitespace character.\n * @throws {RangeError}\n */\nexport function trimRange(range: Range): Range {\n  if (!range.toString().trim().length) {\n    throw new RangeError('Range contains no non-whitespace text');\n  }\n  if (range.startContainer.nodeType !== Node.TEXT_NODE) {\n    throw new RangeError('Range startContainer is not a text node');\n  }\n  if (range.endContainer.nodeType !== Node.TEXT_NODE) {\n    throw new RangeError('Range endContainer is not a text node');\n  }\n\n  const trimmedRange = range.cloneRange();\n\n  let startTrimmed = false;\n  let endTrimmed = false;\n\n  const trimmedOffsets = {\n    start: closestNonSpaceInString(\n      range.startContainer.textContent!,\n      range.startOffset,\n      TrimDirection.Forwards\n    ),\n    end: closestNonSpaceInString(\n      range.endContainer.textContent!,\n      range.endOffset,\n      TrimDirection.Backwards\n    ),\n  };\n\n  if (trimmedOffsets.start >= 0) {\n    trimmedRange.setStart(range.startContainer, trimmedOffsets.start);\n    startTrimmed = true;\n  }\n\n  // Note: An offset of 0 is invalid for an end offset, as no text in the\n  // node would be included in the range.\n  if (trimmedOffsets.end > 0) {\n    trimmedRange.setEnd(range.endContainer, trimmedOffsets.end);\n    endTrimmed = true;\n  }\n\n  if (startTrimmed && endTrimmed) {\n    return trimmedRange;\n  }\n\n  if (!startTrimmed) {\n    // There are no (non-whitespace) characters between `startOffset` and the\n    // end of the `startContainer` node.\n    const { node, offset } = closestNonSpaceInRange(\n      trimmedRange,\n      TrimDirection.Forwards\n    );\n\n    if (node && offset >= 0) {\n      trimmedRange.setStart(node, offset);\n    }\n  }\n\n  if (!endTrimmed) {\n    // There are no (non-whitespace) characters between the start of the Range's\n    // `endContainer` text content and the `endOffset`.\n    const { node, offset } = closestNonSpaceInRange(\n      trimmedRange,\n      TrimDirection.Backwards\n    );\n\n    if (node && offset > 0) {\n      trimmedRange.setEnd(node, offset);\n    }\n  }\n\n  return trimmedRange;\n}\n","import { trimRange } from './trim-range';\n\n/**\n * Return the combined length of text nodes contained in `node`.\n */\nfunction nodeTextLength(node: Node): number {\n  switch (node.nodeType) {\n    case Node.ELEMENT_NODE:\n    case Node.TEXT_NODE:\n      // nb. `textContent` excludes text in comments and processing instructions\n      // when called on a parent element, so we don't need to subtract that here.\n\n      return node.textContent?.length ?? 0;\n    default:\n      return 0;\n  }\n}\n\n/**\n * Return the total length of the text of all previous siblings of `node`.\n */\nfunction previousSiblingsTextLength(node: Node): number {\n  let sibling = node.previousSibling;\n  let length = 0;\n  while (sibling) {\n    length += nodeTextLength(sibling);\n    sibling = sibling.previousSibling;\n  }\n  return length;\n}\n\n/**\n * Resolve one or more character offsets within an element to (text node,\n * position) pairs.\n *\n * @param element\n * @param offsets - Offsets, which must be sorted in ascending order\n * @throws {RangeError}\n */\nfunction resolveOffsets(\n  element: Element,\n  ...offsets: number[]\n): Array<{ node: Text; offset: number }> {\n  let nextOffset = offsets.shift();\n  const nodeIter = element.ownerDocument.createNodeIterator(\n    element,\n    NodeFilter.SHOW_TEXT\n  );\n  const results = [];\n\n  let currentNode = nodeIter.nextNode() as Text | null;\n  let textNode;\n  let length = 0;\n\n  // Find the text node containing the `nextOffset`th character from the start\n  // of `element`.\n  while (nextOffset !== undefined && currentNode) {\n    textNode = currentNode;\n    if (length + textNode.data.length > nextOffset) {\n      results.push({ node: textNode, offset: nextOffset - length });\n      nextOffset = offsets.shift();\n    } else {\n      currentNode = nodeIter.nextNode() as Text | null;\n      length += textNode.data.length;\n    }\n  }\n\n  // Boundary case.\n  while (nextOffset !== undefined && textNode && length === nextOffset) {\n    results.push({ node: textNode, offset: textNode.data.length });\n    nextOffset = offsets.shift();\n  }\n\n  if (nextOffset !== undefined) {\n    throw new RangeError('Offset exceeds text length');\n  }\n\n  return results;\n}\n\n/**\n * When resolving a TextPosition, specifies the direction to search for the\n * nearest text node if `offset` is `0` and the element has no text.\n */\nexport enum ResolveDirection {\n  FORWARDS = 1,\n  BACKWARDS,\n}\n\n/**\n * Represents an offset within the text content of an element.\n *\n * This position can be resolved to a specific descendant node in the current\n * DOM subtree of the element using the `resolve` method.\n */\nexport class TextPosition {\n  public element: Element;\n  public offset: number;\n\n  constructor(element: Element, offset: number) {\n    if (offset < 0) {\n      throw new Error('Offset is invalid');\n    }\n\n    /** Element that `offset` is relative to. */\n    this.element = element;\n\n    /** Character offset from the start of the element's `textContent`. */\n    this.offset = offset;\n  }\n\n  /**\n   * Return a copy of this position with offset relative to a given ancestor\n   * element.\n   *\n   * @param parent - Ancestor of `this.element`\n   */\n  relativeTo(parent: Element): TextPosition {\n    if (!parent.contains(this.element)) {\n      throw new Error('Parent is not an ancestor of current element');\n    }\n\n    let el = this.element;\n    let offset = this.offset;\n    while (el !== parent) {\n      offset += previousSiblingsTextLength(el);\n      el = el.parentElement!;\n    }\n\n    return new TextPosition(el, offset);\n  }\n\n  /**\n   * Resolve the position to a specific text node and offset within that node.\n   *\n   * Throws if `this.offset` exceeds the length of the element's text. In the\n   * case where the element has no text and `this.offset` is 0, the `direction`\n   * option determines what happens.\n   *\n   * Offsets at the boundary between two nodes are resolved to the start of the\n   * node that begins at the boundary.\n   *\n   * @param options.direction - Specifies in which direction to search for the\n   *                            nearest text node if `this.offset` is `0` and\n   *                            `this.element` has no text. If not specified an\n   *                            error is thrown.\n   *\n   * @throws {RangeError}\n   */\n  resolve(options: { direction?: ResolveDirection } = {}): {\n    node: Text;\n    offset: number;\n  } {\n    try {\n      return resolveOffsets(this.element, this.offset)[0];\n    } catch (err) {\n      if (this.offset === 0 && options.direction !== undefined) {\n        const tw = document.createTreeWalker(\n          this.element.getRootNode(),\n          NodeFilter.SHOW_TEXT\n        );\n        tw.currentNode = this.element;\n        const forwards = options.direction === ResolveDirection.FORWARDS;\n        const text = forwards\n          ? (tw.nextNode() as Text | null)\n          : (tw.previousNode() as Text | null);\n        if (!text) {\n          throw err;\n        }\n        return { node: text, offset: forwards ? 0 : text.data.length };\n      } else {\n        throw err;\n      }\n    }\n  }\n\n  /**\n   * Construct a `TextPosition` that refers to the `offset`th character within\n   * `node`.\n   */\n  static fromCharOffset(node: Node, offset: number): TextPosition {\n    switch (node.nodeType) {\n      case Node.TEXT_NODE:\n        return TextPosition.fromPoint(node, offset);\n      case Node.ELEMENT_NODE:\n        return new TextPosition(node as Element, offset);\n      default:\n        throw new Error('Node is not an element or text node');\n    }\n  }\n\n  /**\n   * Construct a `TextPosition` representing the range start or end point (node, offset).\n   *\n   * @param node\n   * @param offset - Offset within the node\n   */\n  static fromPoint(node: Node, offset: number): TextPosition {\n    switch (node.nodeType) {\n      case Node.TEXT_NODE: {\n        if (offset < 0 || offset > (node as Text).data.length) {\n          throw new Error('Text node offset is out of range');\n        }\n\n        if (!node.parentElement) {\n          throw new Error('Text node has no parent');\n        }\n\n        // Get the offset from the start of the parent element.\n        const textOffset = previousSiblingsTextLength(node) + offset;\n\n        return new TextPosition(node.parentElement, textOffset);\n      }\n      case Node.ELEMENT_NODE: {\n        if (offset < 0 || offset > node.childNodes.length) {\n          throw new Error('Child node offset is out of range');\n        }\n\n        // Get the text length before the `offset`th child of element.\n        let textOffset = 0;\n        for (let i = 0; i < offset; i++) {\n          textOffset += nodeTextLength(node.childNodes[i]);\n        }\n\n        return new TextPosition(node as Element, textOffset);\n      }\n      default:\n        throw new Error('Point is not in an element or text node');\n    }\n  }\n}\n\n/**\n * Represents a region of a document as a (start, end) pair of `TextPosition` points.\n *\n * Representing a range in this way allows for changes in the DOM content of the\n * range which don't affect its text content, without affecting the text content\n * of the range itself.\n */\nexport class TextRange {\n  public start: TextPosition;\n  public end: TextPosition;\n\n  constructor(start: TextPosition, end: TextPosition) {\n    this.start = start;\n    this.end = end;\n  }\n\n  /**\n   * Create a new TextRange whose `start` and `end` are computed relative to\n   * `element`. `element` must be an ancestor of both `start.element` and\n   * `end.element`.\n   */\n  relativeTo(element: Element): TextRange {\n    return new TextRange(\n      this.start.relativeTo(element),\n      this.end.relativeTo(element)\n    );\n  }\n\n  /**\n   * Resolve this TextRange to a (DOM) Range.\n   *\n   * The resulting DOM Range will always start and end in a `Text` node.\n   * Hence `TextRange.fromRange(range).toRange()` can be used to \"shrink\" a\n   * range to the text it contains.\n   *\n   * May throw if the `start` or `end` positions cannot be resolved to a range.\n   */\n  toRange(): Range {\n    let start;\n    let end;\n\n    if (\n      this.start.element === this.end.element &&\n      this.start.offset <= this.end.offset\n    ) {\n      // Fast path for start and end points in same element.\n      [start, end] = resolveOffsets(\n        this.start.element,\n        this.start.offset,\n        this.end.offset\n      );\n    } else {\n      start = this.start.resolve({\n        direction: ResolveDirection.FORWARDS,\n      });\n      end = this.end.resolve({ direction: ResolveDirection.BACKWARDS });\n    }\n\n    const range = new Range();\n    range.setStart(start.node, start.offset);\n    range.setEnd(end.node, end.offset);\n    return range;\n  }\n\n  /**\n   * Create a TextRange from a (DOM) Range\n   */\n  static fromRange(range: Range): TextRange {\n    const start = TextPosition.fromPoint(\n      range.startContainer,\n      range.startOffset\n    );\n    const end = TextPosition.fromPoint(range.endContainer, range.endOffset);\n    return new TextRange(start, end);\n  }\n\n  /**\n   * Create a TextRange representing the `start`th to `end`th characters in\n   * `root`\n   */\n  static fromOffsets(root: Element, start: number, end: number): TextRange {\n    return new TextRange(\n      new TextPosition(root, start),\n      new TextPosition(root, end)\n    );\n  }\n\n  /**\n   * Return a new Range representing `range` trimmed of any leading or trailing\n   * whitespace\n   */\n  static trimmedRange(range: Range): Range {\n    return trimRange(TextRange.fromRange(range).toRange());\n  }\n}\n","/**\n * CSS selector that will match the placeholder within a page/tile container.\n */\nconst placeholderSelector = '.annotator-placeholder';\n\n/**\n * Create or return a placeholder element for anchoring.\n *\n * In document viewers such as PDF.js which only render a subset of long\n * documents at a time, it may not be possible to anchor annotations to the\n * actual text in pages which are off-screen. For these non-rendered pages,\n * a \"placeholder\" element is created in the approximate X/Y location (eg.\n * middle of the page) where the content will appear. Any highlights for that\n * page are then rendered inside the placeholder.\n *\n * When the viewport is scrolled to the non-rendered page, the placeholder\n * is removed and annotations are re-anchored to the real content.\n *\n * @param container - The container element for the page or tile which is not\n *   rendered.\n */\nexport function createPlaceholder(container: HTMLElement) {\n  let placeholder = container.querySelector(placeholderSelector);\n  if (placeholder) {\n    return placeholder;\n  }\n  placeholder = document.createElement('span');\n  placeholder.classList.add('annotator-placeholder');\n  placeholder.textContent = 'Loading annotations...';\n  container.appendChild(placeholder);\n  return placeholder;\n}\n\n/**\n * Return true if a page/tile container has a placeholder.\n */\nexport function hasPlaceholder(container: HTMLElement): boolean {\n  return container.querySelector(placeholderSelector) !== null;\n}\n\n/**\n * Remove the placeholder element in `container`, if present.\n */\nexport function removePlaceholder(container: HTMLElement) {\n  container.querySelector(placeholderSelector)?.remove();\n}\n\n/**\n * Return true if `node` is inside a placeholder element created with `createPlaceholder`.\n *\n * This is typically used to test if a highlight element associated with an\n * anchor is inside a placeholder.\n */\nexport function isInPlaceholder(node: Node): boolean {\n  if (!node.parentElement) {\n    return false;\n  }\n  return node.parentElement.closest(placeholderSelector) !== null;\n}\n","export function nodeIsElement(node: Node): node is Element {\n  return node.nodeType === Node.ELEMENT_NODE;\n}\n\nexport function nodeIsText(node: Node): node is Text {\n  return node.nodeType === Node.TEXT_NODE;\n}\n","import { nodeIsText } from './util/node';\n\n/**\n * Returns true if the start point of a selection occurs after the end point,\n * in document order.\n */\nexport function isSelectionBackwards(selection: Selection) {\n  if (selection.focusNode === selection.anchorNode) {\n    return selection.focusOffset < selection.anchorOffset;\n  }\n\n  const range = selection.getRangeAt(0);\n  // Does not work correctly on iOS when selecting nodes backwards.\n  // https://bugs.webkit.org/show_bug.cgi?id=220523\n  return range.startContainer === selection.focusNode;\n}\n\n/**\n * Returns true if any part of `node` lies within `range`.\n */\nexport function isNodeInRange(range: Range, node: Node) {\n  try {\n    const length = node.nodeValue?.length ?? node.childNodes.length;\n    return (\n      // Check start of node is before end of range.\n      range.comparePoint(node, 0) <= 0 &&\n      // Check end of node is after start of range.\n      range.comparePoint(node, length) >= 0\n    );\n  } catch (e) {\n    // `comparePoint` may fail if the `range` and `node` do not share a common\n    // ancestor or `node` is a doctype.\n    return false;\n  }\n}\n\n/**\n * Iterate over all Node(s) which overlap `range` in document order and invoke\n * `callback` for each of them.\n */\nexport function forEachNodeInRange(range: Range, callback: (n: Node) => void) {\n  const root = range.commonAncestorContainer;\n  const nodeIter: NodeIterator = root.ownerDocument!.createNodeIterator(\n    root,\n    NodeFilter.SHOW_ALL\n  );\n\n  let currentNode;\n  while ((currentNode = nodeIter.nextNode())) {\n    if (isNodeInRange(range, currentNode)) {\n      callback(currentNode);\n    }\n  }\n}\n\nfunction textNodeContainsText(textNode: Text): boolean {\n  const whitespaceOnly = /^\\s*$/;\n  return !textNode.textContent!.match(whitespaceOnly);\n}\n\n/**\n * Returns the bounding rectangles of non-whitespace text nodes in `range`.\n *\n * @return Array of bounding rects in viewport coordinates.\n */\nexport function getTextBoundingBoxes(range: Range): DOMRect[] {\n  const textNodes: Text[] = [];\n  forEachNodeInRange(range, node => {\n    if (nodeIsText(node) && textNodeContainsText(node)) {\n      textNodes.push(node);\n    }\n  });\n\n  return textNodes.flatMap(node => {\n    const nodeRange = node.ownerDocument.createRange();\n    nodeRange.selectNodeContents(node);\n    if (node === range.startContainer) {\n      nodeRange.setStart(node, range.startOffset);\n    }\n    if (node === range.endContainer) {\n      nodeRange.setEnd(node, range.endOffset);\n    }\n    if (nodeRange.collapsed) {\n      // If the range ends at the start of this text node or starts at the end\n      // of this node then do not include it.\n      return [];\n    }\n\n    // Measure the range and translate from viewport to document coordinates\n    const viewportRects = Array.from(nodeRange.getClientRects());\n    nodeRange.detach();\n    return viewportRects;\n  });\n}\n\n/**\n * Returns the rectangle, in viewport coordinates, for the line of text\n * containing the focus point of a Selection.\n *\n * Returns null if the selection is empty.\n */\nexport function selectionFocusRect(selection: Selection): DOMRect | null {\n  if (selection.isCollapsed) {\n    return null;\n  }\n  const textBoxes = getTextBoundingBoxes(selection.getRangeAt(0));\n  if (textBoxes.length === 0) {\n    return null;\n  }\n\n  if (isSelectionBackwards(selection)) {\n    return textBoxes[0];\n  } else {\n    return textBoxes[textBoxes.length - 1];\n  }\n}\n\n/**\n * Retrieve a set of items associated with nodes in a given range.\n *\n * An `item` can be any data that the caller wishes to compute from or associate\n * with a node. Only unique items, as determined by `Object.is`, are returned.\n *\n * @param itemForNode - Callback returning the item for a given node\n */\nexport function itemsForRange<T>(\n  range: Range,\n  itemForNode: (n: Node) => NonNullable<T> | null | undefined\n): NonNullable<T>[] {\n  const checkedNodes = new Set<Node>();\n  const items = new Set<NonNullable<T>>();\n\n  forEachNodeInRange(range, (current: Node | null) => {\n    while (current) {\n      if (checkedNodes.has(current)) {\n        break;\n      }\n      checkedNodes.add(current);\n\n      const item = itemForNode(current);\n      if (item !== null && item !== undefined) {\n        items.add(item);\n      }\n\n      current = current.parentNode;\n    }\n  });\n\n  return [...items];\n}\n","import classnames from 'classnames';\n\nimport { generateHexString } from '../shared/random';\nimport type { HighlightCluster } from '../types/shared';\nimport { isInPlaceholder } from './anchoring/placeholder';\nimport { isNodeInRange } from './range-util';\n\nconst SVG_NAMESPACE = 'http://www.w3.org/2000/svg';\n\ntype HighlightProps = {\n  // Associated SVG rect drawn to represent this highlight (in PDFs)\n  svgHighlight?: SVGRectElement;\n};\n\nexport type HighlightElement = HTMLElement & HighlightProps;\n\nexport const clusterValues: HighlightCluster[] = [\n  'user-annotations',\n  'user-highlights',\n  'other-content',\n];\n\n/**\n * Return the canvas element underneath a highlight element in a PDF page's\n * text layer.\n *\n * Returns `null` if the highlight is not above a PDF canvas.\n */\nfunction getPDFCanvas(highlightEl: HighlightElement): HTMLCanvasElement | null {\n  // This code assumes that PDF.js renders pages with a structure like:\n  //\n  // <div class=\"page\">\n  //   <div class=\"canvasWrapper\">\n  //     <canvas></canvas> <!-- The rendered PDF page -->\n  //   </div>\n  //   <div class=\"textLayer\">\n  //      <!-- Transparent text layer with text spans used to enable text selection -->\n  //   </div>\n  // </div>\n  //\n  // It also assumes that the `highlightEl` element is somewhere under\n  // the `.textLayer` div.\n\n  const pageEl = highlightEl.closest('.page');\n  if (!pageEl) {\n    return null;\n  }\n\n  const canvasEl = pageEl.querySelector('.canvasWrapper > canvas');\n  if (!canvasEl) {\n    return null;\n  }\n\n  return canvasEl as HTMLCanvasElement;\n}\n\n/**\n * Draw highlights in an SVG layer overlaid on top of a PDF.js canvas.\n *\n * The created SVG elements are stored in the `svgHighlight` property of\n * each `HighlightElement`.\n *\n * @param highlightEls -\n *   An element that wraps the highlighted text in the transparent text layer\n *   above the PDF.\n * @param [cssClass] - CSS class(es) to add to the SVG highlight elements\n */\nfunction drawHighlightsAbovePDFCanvas(\n  highlightEls: HighlightElement[],\n  cssClass?: string\n) {\n  if (highlightEls.length === 0) {\n    return;\n  }\n\n  // Get the <canvas> for the PDF page containing the highlight. We assume all\n  // the highlights are on the same page.\n  const canvasEl = getPDFCanvas(highlightEls[0]);\n  if (!canvasEl || !canvasEl.parentElement) {\n    return;\n  }\n\n  let svgHighlightLayer = canvasEl.parentElement.querySelector(\n    '.hypothesis-highlight-layer'\n  ) as SVGSVGElement | null;\n\n  if (!svgHighlightLayer) {\n    // Create SVG layer. This must be in the same stacking context as\n    // the canvas so that CSS `mix-blend-mode` can be used to control how SVG\n    // content blends with the canvas below.\n    svgHighlightLayer = document.createElementNS(SVG_NAMESPACE, 'svg');\n    svgHighlightLayer.setAttribute('class', 'hypothesis-highlight-layer');\n    canvasEl.parentElement.appendChild(svgHighlightLayer);\n\n    // Overlay SVG layer above canvas.\n    canvasEl.parentElement.style.position = 'relative';\n\n    const svgStyle = svgHighlightLayer.style;\n    svgStyle.position = 'absolute';\n    svgStyle.left = '0';\n    svgStyle.top = '0';\n    svgStyle.width = '100%';\n    svgStyle.height = '100%';\n\n    // Use multiply blending so that highlights drawn on top of text darken it\n    // rather than making it lighter. This improves contrast and thus readability\n    // of highlighted text, especially for overlapping highlights.\n    //\n    // This choice optimizes for the common case of dark text on a light background.\n    svgStyle.mixBlendMode = 'multiply';\n  }\n\n  const canvasRect = canvasEl.getBoundingClientRect();\n  const highlightRects = highlightEls.map(highlightEl => {\n    const highlightRect = highlightEl.getBoundingClientRect();\n\n    // Create SVG element for the current highlight element.\n    const rect = document.createElementNS(SVG_NAMESPACE, 'rect');\n    rect.setAttribute('x', (highlightRect.left - canvasRect.left).toString());\n    rect.setAttribute('y', (highlightRect.top - canvasRect.top).toString());\n    rect.setAttribute('width', highlightRect.width.toString());\n    rect.setAttribute('height', highlightRect.height.toString());\n    rect.setAttribute(\n      'class',\n      classnames('hypothesis-svg-highlight', cssClass)\n    );\n\n    // Make the highlight in the text layer transparent.\n    highlightEl.classList.add('is-transparent');\n\n    // Associate SVG element with highlight for use by `removeHighlights`.\n    highlightEl.svgHighlight = rect;\n\n    return rect;\n  });\n\n  svgHighlightLayer.append(...highlightRects);\n}\n\n/**\n * Return text nodes which are entirely inside `range`.\n *\n * If a range starts or ends part-way through a text node, the node is split\n * and the part inside the range is returned.\n */\nfunction wholeTextNodesInRange(range: Range): Text[] {\n  if (range.collapsed) {\n    // Exit early for an empty range to avoid an edge case that breaks the algorithm\n    // below. Splitting a text node at the start of an empty range can leave the\n    // range ending in the left part rather than the right part.\n    return [];\n  }\n\n  let root = range.commonAncestorContainer as Node | null;\n  if (root && root.nodeType !== Node.ELEMENT_NODE) {\n    // If the common ancestor is not an element, set it to the parent element to\n    // ensure that the loop below visits any text nodes generated by splitting\n    // the common ancestor.\n    //\n    // Note that `parentElement` may be `null`.\n    root = root.parentElement;\n  }\n  if (!root) {\n    // If there is no root element then we won't be able to insert highlights,\n    // so exit here.\n    return [];\n  }\n\n  const textNodes = [];\n  const nodeIter = root!.ownerDocument!.createNodeIterator(\n    root,\n    NodeFilter.SHOW_TEXT // Only return `Text` nodes.\n  );\n  let node;\n  while ((node = nodeIter.nextNode())) {\n    if (!isNodeInRange(range, node)) {\n      continue;\n    }\n    const text = node as Text;\n\n    if (text === range.startContainer && range.startOffset > 0) {\n      // Split `text` where the range starts. The split will create a new `Text`\n      // node which will be in the range and will be visited in the next loop iteration.\n      text.splitText(range.startOffset);\n      continue;\n    }\n\n    if (text === range.endContainer && range.endOffset < text.data.length) {\n      // Split `text` where the range ends, leaving it as the part in the range.\n      text.splitText(range.endOffset);\n    }\n\n    textNodes.push(text);\n  }\n\n  return textNodes;\n}\n\n/**\n * Wraps the DOM Nodes within the provided range with a highlight\n * element of the specified class and returns the highlight Elements.\n *\n * @param range - Range to be highlighted\n * @param [cssClass] - CSS class(es) to add to the highlight elements\n * @return Elements wrapping text in `normedRange` to add a highlight effect\n */\nexport function highlightRange(\n  range: Range,\n  cssClass?: string\n): HighlightElement[] {\n  const textNodes = wholeTextNodesInRange(range);\n\n  // Check if this range refers to a placeholder for not-yet-rendered content in\n  // a PDF. These highlights should be invisible.\n  const inPlaceholder = textNodes.length > 0 && isInPlaceholder(textNodes[0]);\n\n  // Group text nodes into spans of adjacent nodes. If a group of text nodes are\n  // adjacent, we only need to create one highlight element for the group.\n  let textNodeSpans: Text[][] = [];\n  let prevNode: Node | null = null;\n  let currentSpan = null;\n\n  textNodes.forEach(node => {\n    if (prevNode && prevNode.nextSibling === node) {\n      currentSpan.push(node);\n    } else {\n      currentSpan = [node];\n      textNodeSpans.push(currentSpan);\n    }\n    prevNode = node;\n  });\n\n  // Filter out text node spans that consist only of white space. This avoids\n  // inserting highlight elements in places that can only contain a restricted\n  // subset of nodes such as table rows and lists.\n  const whitespace = /^\\s*$/;\n  textNodeSpans = textNodeSpans.filter(span =>\n    // Check for at least one text node with non-space content.\n    span.some(node => !whitespace.test(node.data))\n  );\n\n  // Wrap each text node span with a `<hypothesis-highlight>` element.\n  const highlights: HighlightElement[] = [];\n  textNodeSpans.forEach(nodes => {\n    // A custom element name is used here rather than `<span>` to reduce the\n    // likelihood of highlights being hidden by page styling.\n\n    const highlightEl = document.createElement('hypothesis-highlight');\n    highlightEl.className = classnames('hypothesis-highlight', cssClass);\n\n    const parent = nodes[0].parentNode as ParentNode;\n    parent.replaceChild(highlightEl, nodes[0]);\n    nodes.forEach(node => highlightEl.appendChild(node));\n\n    highlights.push(highlightEl);\n  });\n\n  // For PDF highlights, create the highlight effect by using an SVG placed\n  // above the page's canvas rather than CSS `background-color` on the highlight\n  // element. This enables more control over blending of the highlight with the\n  // content below.\n  //\n  // Drawing these SVG highlights involves measuring the `<hypothesis-highlight>`\n  // elements, so we create them only after those elements have all been created\n  // to reduce the number of forced reflows. We also skip creating them for\n  // unrendered pages for performance reasons.\n  if (!inPlaceholder) {\n    drawHighlightsAbovePDFCanvas(highlights, cssClass);\n  }\n\n  return highlights;\n}\n\n/**\n * Replace a child `node` with `replacements`.\n *\n * nb. This is like `ChildNode.replaceWith` but it works in older browsers.\n */\nfunction replaceWith(node: ChildNode, replacements: Node[]) {\n  const parent = node.parentNode as ParentNode;\n  replacements.forEach(r => parent.insertBefore(r, node));\n  node.remove();\n}\n\n/**\n * Remove all highlights under a given root element.\n */\nexport function removeAllHighlights(root: HTMLElement) {\n  const highlights = Array.from(root.querySelectorAll('hypothesis-highlight'));\n  removeHighlights(highlights as HighlightElement[]);\n}\n\n/**\n * Remove highlights from a range previously highlighted with `highlightRange`.\n */\nexport function removeHighlights(highlights: HighlightElement[]) {\n  // Explicitly un-focus highlights to be removed. This ensures associated\n  // focused elements are removed from the document.\n  setHighlightsFocused(highlights, false);\n  for (const h of highlights) {\n    if (h.parentNode) {\n      const children = Array.from(h.childNodes);\n      replaceWith(h, children);\n    }\n    if (h.svgHighlight) {\n      h.svgHighlight.remove();\n    }\n  }\n}\n\n/**\n * Focus or un-focus an individual SVG highlight element.\n *\n * When focusing an SVG highlight, make sure it is not obscured by other SVG\n * highlight elements. As SVG highlights are siblings, this can be accomplished\n * by putting the highlight at the end the set of highlights contained its\n * parent. SVG highlight elements are cloned instead of moved so that their\n * original stacking (nesting) order is not lost when later unfocused. A data\n * attribute is added to associate the original SVG highlight element with its\n * clone.\n */\nfunction setSVGHighlightFocused(svgEl: SVGElement, focused: boolean) {\n  const parent = svgEl.parentNode as SVGElement;\n  // This attribute allows lookup of an associated, \"focused\" element. It is\n  // set if the highlight is already focused.\n  const focusedId = svgEl.getAttribute('data-focused-id');\n\n  const isFocused = Boolean(focusedId);\n  if (isFocused === focused) {\n    return;\n  }\n\n  if (focused) {\n    svgEl.setAttribute('data-focused-id', generateHexString(8));\n    const focusedHighlight = svgEl.cloneNode() as SVGElement;\n    // The cloned element will include the `data-focused-id` attribute\n    // for association with its original highlight. Set additional attribute\n    // to mark this as the focused clone of a highlight.\n    focusedHighlight.setAttribute('data-is-focused', 'data-is-focused');\n    parent.append(focusedHighlight);\n  } else {\n    const focusedHighlight = parent.querySelector(\n      `[data-focused-id=\"${focusedId}\"][data-is-focused]`\n    );\n    focusedHighlight?.remove();\n    svgEl.removeAttribute('data-focused-id');\n  }\n}\n\n/**\n * Set whether the given highlight elements should appear \"focused\".\n *\n * A highlight can be displayed in a different (\"focused\") style to indicate\n * that it is current in some other context - for example the user has selected\n * the corresponding annotation in the sidebar.\n */\nexport function setHighlightsFocused(\n  highlights: HighlightElement[],\n  focused: boolean\n) {\n  highlights.forEach(h => {\n    // In PDFs the visible highlight is created by an SVG element, so the focused\n    // effect is applied to that. In other documents the effect is applied to the\n    // `<hypothesis-highlight>` element.\n    if (h.svgHighlight) {\n      setSVGHighlightFocused(h.svgHighlight, focused);\n    } else {\n      h.classList.toggle('hypothesis-highlight-focused', focused);\n    }\n  });\n}\n\n/**\n * Set whether highlights under the given root element should be visible.\n */\nexport function setHighlightsVisible(root: HTMLElement, visible: boolean) {\n  const showHighlightsClass = 'hypothesis-highlights-always-on';\n  root.classList.toggle(showHighlightsClass, visible);\n}\n\n/**\n * Get the highlight elements that contain the given node.\n */\nexport function getHighlightsContainingNode(node: Node): HighlightElement[] {\n  let el =\n    node.nodeType === Node.ELEMENT_NODE\n      ? (node as Element)\n      : node.parentElement;\n\n  const highlights = [];\n\n  while (el) {\n    if (el.classList.contains('hypothesis-highlight')) {\n      highlights.push(el);\n    }\n    el = el.parentElement;\n  }\n\n  return highlights as HighlightElement[];\n}\n\n// Subset of `DOMRect` interface\ntype Rect = {\n  top: number;\n  left: number;\n  bottom: number;\n  right: number;\n};\n\n/**\n * Get the bounding client rectangle of a collection in viewport coordinates.\n * Unfortunately, Chrome has issues ([1]) with Range.getBoundingClient rect or we\n * could just use that.\n *\n * [1] https://bugs.chromium.org/p/chromium/issues/detail?id=324437\n */\nexport function getBoundingClientRect(collection: HTMLElement[]): Rect {\n  // Reduce the client rectangles of the highlights to a bounding box\n  const rects = collection.map(n => n.getBoundingClientRect() as Rect);\n  return rects.reduce((acc, r) => ({\n    top: Math.min(acc.top, r.top),\n    left: Math.min(acc.left, r.left),\n    bottom: Math.max(acc.bottom, r.bottom),\n    right: Math.max(acc.right, r.right),\n  }));\n}\n\n/**\n * Add metadata and manipulate ordering of all highlights in `element` to\n * allow styling of nested, clustered highlights.\n */\nexport function updateClusters(element: Element) {\n  setNestingData(getHighlights(element));\n  updateSVGHighlightOrdering(element);\n}\n\n/**\n * Is `el` a highlight element? Work around inconsistency between HTML documents\n * (`tagName` is upper-case) and XHTML documents (`tagName` is lower-case)\n */\nconst isHighlightElement = (el: Element): boolean =>\n  el.tagName.toLowerCase() === 'hypothesis-highlight';\n\n/**\n * Return the closest generation of HighlightElements to `element`.\n *\n * If `element` is itself a HighlightElement, return immediate children that\n * are also HighlightElements.\n *\n * Otherwise, return all HighlightElements that have no parent HighlightElement,\n * i.e. the outermost highlights within `element`.\n */\nfunction getHighlights(element: Element) {\n  let highlights;\n  if (isHighlightElement(element)) {\n    highlights = Array.from(element.children).filter(isHighlightElement);\n  } else {\n    highlights = Array.from(\n      element.getElementsByTagName('hypothesis-highlight')\n    ).filter(\n      highlight =>\n        !highlight.parentElement || !isHighlightElement(highlight.parentElement)\n    );\n  }\n  return highlights as HighlightElement[];\n}\n\n/**\n * Get all of the SVG highlights within `root`, grouped by layer. A PDF\n * document may have multiple layers of SVG highlights, typically one per page.\n *\n * @return a Map of layer Elements to all SVG highlights within that\n *   layer Element\n */\nfunction getSVGHighlights(root?: Element): Map<Element, HighlightElement[]> {\n  const svgHighlights: Map<Element, HighlightElement[]> = new Map();\n\n  for (const layer of (root ?? document).getElementsByClassName(\n    'hypothesis-highlight-layer'\n  )) {\n    svgHighlights.set(\n      layer,\n      Array.from(\n        layer.querySelectorAll('.hypothesis-svg-highlight')\n      ) as HighlightElement[]\n    );\n  }\n\n  return svgHighlights;\n}\n\n/**\n * Walk a tree of <hypothesis-highlight> elements, adding `data-nesting-level`\n * and `data-cluster-level` data attributes to <hypothesis-highlight>s and\n * their associated SVG highlight (<rect>) elements.\n *\n * - `data-nesting-level` - generational depth of the applicable\n *   `<hypothesis-highlight>` relative to outermost `<hypothesis-highlight>`.\n * - `data-cluster-level` - number of `<hypothesis-highlight>` generations\n *   since the cluster value changed.\n *\n * @param highlightEls - A collection of sibling <hypothesis-highlight>\n * elements\n * @param parentCluster - The cluster value of the parent highlight to\n * `highlightEls`, if any\n * @param nestingLevel - The nesting \"level\", relative to the outermost\n * <hypothesis-highlight> element (0-based)\n * @param parentClusterLevel - The parent's nesting depth, per its cluster\n * value (`parentCluster`). i.e. How many levels since the cluster value\n * changed? This allows for nested styling of highlights of the same cluster\n * value.\n */\nfunction setNestingData(\n  highlightEls: HighlightElement[],\n  parentCluster = '',\n  nestingLevel = 0,\n  parentClusterLevel = 0\n) {\n  for (const hEl of highlightEls) {\n    const elCluster =\n      clusterValues.find(cv => hEl.classList.contains(cv)) ?? 'other-content';\n\n    const elClusterLevel =\n      parentCluster && elCluster === parentCluster ? parentClusterLevel + 1 : 0;\n\n    hEl.setAttribute('data-nesting-level', `${nestingLevel}`);\n    hEl.setAttribute('data-cluster-level', `${elClusterLevel}`);\n\n    if (hEl.svgHighlight) {\n      hEl.svgHighlight.setAttribute('data-nesting-level', `${nestingLevel}`);\n      hEl.svgHighlight.setAttribute('data-cluster-level', `${elClusterLevel}`);\n    }\n\n    setNestingData(\n      getHighlights(hEl),\n      elCluster /* parentCluster */,\n      nestingLevel + 1 /* nestingLevel */,\n      elClusterLevel /* parentClusterLevel */\n    );\n  }\n}\n\n/**\n * Get the highlight nesting level of `el`. This is typically set with the\n * `data-nesting-level` attribute on highlight elements. Focused SVG highlight\n * elements should always have the highest nesting level — they should always\n * come last when sorted, so as not to be obscured by any other highlights.\n * These elements are indicated by the presence of the `data-is-focused`\n * attribute.\n */\nfunction nestingLevel(el: Element): number {\n  if (el.getAttribute('data-is-focused')) {\n    return Number.MAX_SAFE_INTEGER;\n  }\n  return parseInt(el.getAttribute('data-nesting-level') ?? '0', 10);\n}\n\n/**\n * Ensure that SVG <rect> elements are ordered correctly: inner (nested)\n * highlights should be visible on top of outer highlights.\n *\n * All SVG <rect>s drawn for a PDF page are siblings. To ensure that the\n * <rect>s associated with outer highlights don't show up on top of (and thus\n * obscure) nested highlights, order the <rects> by their `data-nesting-level`\n * value if they are not already.\n */\nfunction updateSVGHighlightOrdering(element: Element) {\n  for (const [layer, layerHighlights] of getSVGHighlights(element)) {\n    const correctlyOrdered = layerHighlights.every((svgEl, idx, allEls) => {\n      if (idx === 0) {\n        return true;\n      }\n      return nestingLevel(svgEl) >= nestingLevel(allEls[idx - 1]);\n    });\n\n    if (!correctlyOrdered) {\n      layerHighlights.sort((a, b) => nestingLevel(a) - nestingLevel(b));\n      layer.replaceChildren(...layerHighlights);\n    }\n  }\n}\n","import { ListenerCollection } from '../shared/listener-collection';\nimport type { PortRPC } from '../shared/messaging';\nimport type { Anchor, Destroyable } from '../types/annotator';\nimport type {\n  HostToGuestEvent,\n  GuestToHostEvent,\n} from '../types/port-rpc-events';\nimport { computeAnchorPositions } from './util/buckets';\n\ntype HostRPC = PortRPC<HostToGuestEvent, GuestToHostEvent>;\n\nexport type BucketBarClientOptions = {\n  /**\n   * The scrollable container element for the document content. All the highlights\n   * that the bucket bar's buckets point at should be contained within this element.\n   */\n  contentContainer: Element;\n\n  hostRPC: HostRPC;\n};\n\n/**\n * Communicate to the host frame when:\n *\n * 1. The set of anchors has been changed (due to annotations being added or removed)\n * 2. The position of anchors relative to the viewport of the guest has changed\n */\nexport class BucketBarClient implements Destroyable {\n  private _hostRPC: HostRPC;\n  private _updatePending: boolean;\n  private _anchors: Anchor[];\n  private _listeners: ListenerCollection;\n\n  constructor({ contentContainer, hostRPC }: BucketBarClientOptions) {\n    this._hostRPC = hostRPC;\n    this._updatePending = false;\n    this._anchors = [];\n    this._listeners = new ListenerCollection();\n\n    this._listeners.add(window, 'resize', () => this.update());\n    this._listeners.add(window, 'scroll', () => this.update());\n    this._listeners.add(contentContainer, 'scroll', () => this.update());\n  }\n\n  destroy() {\n    this._listeners.removeAll();\n  }\n\n  /**\n   * Notifies the BucketBar in the host frame when:\n   * 1. The set of anchors has been changed (due to annotations being added or removed)\n   * 2. The position of anchors relative to the viewport of the guest has changed\n   *\n   * Updates are debounced to reduce the overhead of gathering and sending anchor\n   * position data across frames.\n   *\n   * @param anchors - pass this option when anchors are added or deleted\n   */\n  update(anchors?: Anchor[]) {\n    if (anchors) {\n      this._anchors = anchors;\n    }\n\n    if (this._updatePending) {\n      return;\n    }\n\n    this._updatePending = true;\n    requestAnimationFrame(() => {\n      const positions = computeAnchorPositions(this._anchors);\n      this._hostRPC.call('anchorsChanged', positions);\n      this._updatePending = false;\n    });\n  }\n}\n","import { getBoundingClientRect } from '../highlighter';\n\n/**\n * @typedef {import('../../types/annotator').Anchor} Anchor\n * @typedef {import('../../types/annotator').AnchorPosition} AnchorPosition\n */\n\n/**\n * @typedef Bucket\n * @prop {Set<string>} tags - The annotation tags in this bucket\n * @prop {number} position - The vertical pixel offset where this bucket should\n *   appear in the bucket bar\n */\n\n/**\n * @typedef BucketSet\n * @prop {Bucket} above - A single bucket containing all the annotation\n *   tags whose anchors are offscreen upwards\n * @prop {Bucket} below - A single bucket containing all the annotation\n *   tags which anchors are offscreen downwards\n * @prop {Bucket[]} buckets - On-screen buckets\n */\n\n/**\n * @typedef WorkingBucket\n * @prop {Set<string>} tags - The annotation tags in this bucket\n * @prop {number} position - The computed position (offset) for this bucket,\n *   based on the current anchors. This is centered between `top` and `bottom`\n * @prop {number} top - The uppermost (lowest) vertical offset for the anchors\n *   in this bucket — the lowest `top` position value, akin to the top offset of\n *   a theoretical box drawn around all of the anchor highlights in this bucket\n * @prop {number} bottom - The bottommost (highest) vertical offset for the\n *   anchors in this bucket — the highest `top` position value, akin to the\n *   bottom of a theoretical box drawn around all of the anchor highlights in\n *   this bucket\n */\n\n// Only anchors with top offsets between `BUCKET_TOP_THRESHOLD` and\n// `window.innerHeight - BUCKET_BOTTOM_THRESHOLD` are considered \"on-screen\"\n// and will be bucketed. This is to account for bucket-bar tool buttons (top\n// and the height of the bottom navigation bucket (bottom)\nconst BUCKET_TOP_THRESHOLD = 137;\nconst BUCKET_BOTTOM_THRESHOLD = 22;\n// Generated buckets of annotation anchor highlights should be spaced by\n// at least this amount, in pixels\nconst BUCKET_GAP_SIZE = 60;\n\n/**\n * Find the closest valid anchor in `anchors` that is offscreen in the direction\n * indicated.\n *\n * @param {Anchor[]} anchors\n * @param {'up'|'down'} direction\n * @return {Anchor|null} - The closest anchor or `null` if no valid anchor found\n */\nexport function findClosestOffscreenAnchor(anchors, direction) {\n  let closestAnchor = null;\n  let closestTop = 0;\n\n  for (let anchor of anchors) {\n    if (!anchor.highlights?.length) {\n      continue;\n    }\n\n    const top = getBoundingClientRect(anchor.highlights).top;\n\n    // Verify that the anchor is offscreen in the direction we're headed\n    if (direction === 'up' && top >= BUCKET_TOP_THRESHOLD) {\n      // We're headed up but the anchor is already below the\n      // visible top of the bucket bar: it's not our guy\n      continue;\n    } else if (\n      direction === 'down' &&\n      top <= window.innerHeight - BUCKET_BOTTOM_THRESHOLD\n    ) {\n      // We're headed down but this anchor is already above\n      // the usable bottom of the screen: it's not our guy\n      continue;\n    }\n\n    if (\n      !closestAnchor ||\n      (direction === 'up' && top > closestTop) ||\n      (direction === 'down' && top < closestTop)\n    ) {\n      // This anchor is either:\n      // - The first anchor we've encountered off-screen in the direction\n      //   we're headed, or\n      // - Closer to the screen than the previous `closestAnchor`\n      closestAnchor = anchor;\n      closestTop = top;\n    }\n  }\n\n  return closestAnchor;\n}\n\n/**\n * Compute the top and bottom positions for the set of anchors' highlights, sorted\n * vertically, from top to bottom.\n *\n * @param {Anchor[]} anchors\n * @return {AnchorPosition[]}\n */\nexport function computeAnchorPositions(anchors) {\n  /** @type {AnchorPosition[]} */\n  const positions = [];\n\n  anchors.forEach(({ annotation, highlights }) => {\n    if (!highlights?.length) {\n      return;\n    }\n\n    const { top, bottom } = getBoundingClientRect(highlights);\n\n    if (top >= bottom) {\n      // Empty rect. The highlights may be disconnected from the document or hidden.\n      return;\n    }\n\n    positions.push({\n      tag: annotation.$tag,\n      top,\n      bottom,\n    });\n  });\n\n  // Sort anchors vertically from top to bottom\n  positions.sort((anchor1, anchor2) => anchor1.top - anchor2.top);\n\n  return positions;\n}\n\n/**\n * Compute buckets\n *\n * @param {AnchorPosition[]} anchorPositions\n * @return {BucketSet}\n */\nexport function computeBuckets(anchorPositions) {\n  /** @type {Set<string>} */\n  const aboveTags = new Set();\n  /** @type {Set<string>} */\n  const belowTags = new Set();\n  /** @type {Bucket[]} */\n  const buckets = [];\n\n  // Hold current working anchors and positions as we build each bucket\n  /** @type {WorkingBucket|null} */\n  let currentBucket = null;\n\n  /**\n   * Create a new working bucket based on the provided `AnchorPosition`\n   *\n   * @param {AnchorPosition} anchorPosition\n   * @return {WorkingBucket}\n   */\n  function newBucket({ bottom, tag, top }) {\n    const anchorHeight = bottom - top;\n    const bucketPosition = top + anchorHeight / 2;\n    return {\n      bottom,\n      position: bucketPosition,\n      tags: new Set([tag]),\n      top,\n    };\n  }\n\n  // Build buckets from position information\n  anchorPositions.forEach(aPos => {\n    if (aPos.top < BUCKET_TOP_THRESHOLD) {\n      aboveTags.add(aPos.tag);\n      return;\n    } else if (aPos.top > window.innerHeight - BUCKET_BOTTOM_THRESHOLD) {\n      belowTags.add(aPos.tag);\n      return;\n    }\n\n    if (!currentBucket) {\n      // We've encountered our first on-screen anchor position:\n      // We'll need a bucket!\n      currentBucket = newBucket(aPos);\n      return;\n    }\n    // We want to contain overlapping highlights and those near each other\n    // within a shared bucket\n    const isContainedWithin =\n      aPos.top > currentBucket.top && aPos.bottom < currentBucket.bottom;\n\n    // The new anchor's position is far enough below the bottom of the current\n    // bucket to justify starting a new bucket\n    const isLargeGap = aPos.top - currentBucket.bottom > BUCKET_GAP_SIZE;\n\n    if (isLargeGap && !isContainedWithin) {\n      // We need to start a new bucket; push the working bucket and create\n      // a new bucket\n      buckets.push(currentBucket);\n      currentBucket = newBucket(aPos);\n    } else {\n      // We'll add this anchor to the current working bucket and update\n      // offset properties accordingly.\n      // We can be confident that `aPos.top` is >= `currentBucket.top` because\n      // AnchorPositions are sorted by their `top` offset — meaning that\n      // `currentBucket.top` still accurately represents the `top` offset of\n      // the virtual rectangle enclosing all anchors in this bucket. But\n      // let's check to see if the bottom is larger/lower:\n      const updatedBottom =\n        aPos.bottom > currentBucket.bottom ? aPos.bottom : currentBucket.bottom;\n      const updatedHeight = updatedBottom - currentBucket.top;\n\n      currentBucket.tags.add(aPos.tag);\n      currentBucket.bottom = updatedBottom;\n      currentBucket.position = currentBucket.top + updatedHeight / 2;\n    }\n  });\n\n  if (currentBucket) {\n    buckets.push(currentBucket);\n  }\n\n  // Add an upper \"navigation\" bucket with offscreen-above anchors\n  const above = {\n    tags: aboveTags,\n    position: BUCKET_TOP_THRESHOLD,\n  };\n\n  // Add a lower \"navigation\" bucket with offscreen-below anchors\n  const below = {\n    tags: belowTags,\n    position: window.innerHeight - BUCKET_BOTTOM_THRESHOLD,\n  };\n\n  return {\n    above,\n    below,\n    buckets,\n  };\n}\n","/** @type {Set<string>} */\nlet shownWarnings = new Set();\n\n/**\n * Log a warning if it has not already been reported.\n *\n * This is useful to avoid spamming the console if a warning is emitted in a\n * context that may be called frequently.\n *\n * @param {...unknown} args -\n *   Arguments to forward to `console.warn`. The arguments `toString()` values\n *   are concatenated into a string key which is used to determine if the warning\n *   has been logged before.\n */\nexport function warnOnce(...args) {\n  const key = args.join();\n  if (shownWarnings.has(key)) {\n    return;\n  }\n  console.warn(...args);\n  shownWarnings.add(key);\n}\n\nwarnOnce.reset = () => {\n  shownWarnings.clear();\n};\n","import { TinyEmitter } from 'tiny-emitter';\n\nimport { warnOnce } from '../shared/warn-once';\nimport type { FeatureFlags as IFeatureFlags } from '../types/annotator';\n\n/**\n * List of feature flags that annotator code tests for.\n */\nconst annotatorFlags = ['html_side_by_side', 'styled_highlight_clusters'];\n\n/**\n * An observable container of feature flags.\n */\nexport class FeatureFlags extends TinyEmitter implements IFeatureFlags {\n  /** Map of flag name to enabled state. */\n  private _flags: Map<string, boolean>;\n  private _knownFlags: string[];\n\n  /**\n   * @param knownFlags - Test seam. This is a list of known flags used to catch\n   *        mistakes where code checks for an obsolete feature flag.\n   */\n  constructor(knownFlags: string[] = annotatorFlags) {\n    super();\n\n    this._flags = new Map<string, boolean>();\n    this._knownFlags = knownFlags;\n  }\n\n  /**\n   * Update the stored flags and notify observers via a \"flagsChanged\" event.\n   */\n  update(flags: Record<string, boolean>) {\n    this._flags.clear();\n    for (const [flag, on] of Object.entries(flags)) {\n      this._flags.set(flag, on);\n    }\n    this.emit('flagsChanged');\n  }\n\n  /**\n   * Test if a feature flag is enabled.\n   *\n   * This will return false if the feature flags have not yet been received from\n   * the backend. Code that uses a feature flag should handle subsequent changes\n   * to the flag's state by listening for the \"flagsChanged\" event.\n   */\n  flagEnabled(flag: string): boolean {\n    if (!this._knownFlags.includes(flag)) {\n      warnOnce('Looked up unknown feature', flag);\n      return false;\n    }\n    return this._flags.get(flag) ?? false;\n  }\n\n  /**\n   * Return the state of all feature flags.\n   *\n   * To test whether an individual flag is enabled, use {@link flagEnabled}\n   * instead.\n   */\n  allFlags(): Record<string, boolean> {\n    return Object.fromEntries(this._flags);\n  }\n}\n","import {\n  Button,\n  Card,\n  CardContent,\n  CaretDownIcon,\n  CaretRightIcon,\n  HideIcon,\n  HighlightIcon,\n} from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\nimport { useCallback, useState } from 'preact/hooks';\n\nimport type { HighlightCluster } from '../../types/shared';\nimport type { AppliedStyles, HighlightStyles } from '../highlight-clusters';\n\ntype ClusterStyleControlProps = {\n  cluster: HighlightCluster;\n  label: string;\n  onChange: (e: Event) => void;\n  currentStyles: AppliedStyles;\n  highlightStyles: HighlightStyles;\n};\n\n/**\n * Render controls for changing a single highlight cluster's style\n */\nfunction ClusterStyleControl({\n  cluster,\n  label,\n  onChange,\n  currentStyles,\n  highlightStyles,\n}: ClusterStyleControlProps) {\n  const appliedStyleName = currentStyles[cluster];\n  const isHidden = appliedStyleName === 'transparent'; // This style is somewhat special\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex items-center gap-x-2 text-annotator-base\">\n        <div\n          className=\"grow text-color-text px-2 py-1 rounded\"\n          style={{\n            backgroundColor: highlightStyles[appliedStyleName].color,\n          }}\n        >\n          {label}\n        </div>\n      </div>\n      <div className=\"flex items-center gap-x-2\">\n        {Object.keys(highlightStyles).map(styleName => (\n          <div className=\"relative\" key={`${cluster}-${styleName}`}>\n            <input\n              className={classnames(\n                // Position this atop its label and size it to the same dimensions\n                'absolute w-6 h-6',\n                // Make radio input visually hidden, but\n                // some screen readers won't read out elements with 0 opacity\n                'opacity-[.00001]',\n                'cursor-pointer'\n              )}\n              name={cluster}\n              id={`hypothesis-${cluster}-${styleName}`}\n              checked={appliedStyleName === styleName}\n              onChange={onChange}\n              type=\"radio\"\n              value={styleName}\n            />\n            <label className=\"block\" htmlFor={`${cluster}-${styleName}`}>\n              <div\n                style={{\n                  backgroundColor: highlightStyles[styleName].color,\n                }}\n                className={classnames(\n                  'block w-6 h-6 rounded-full flex items-center justify-center',\n                  {\n                    'border-2 border-slate-0': appliedStyleName !== styleName,\n                    'border-2 border-slate-3': appliedStyleName === styleName,\n                  }\n                )}\n              >\n                {styleName === 'transparent' && (\n                  <HideIcon\n                    className={classnames('w-3 h-3', {\n                      'text-slate-3': !isHidden,\n                      'text-slate-7': isHidden,\n                    })}\n                  />\n                )}\n              </div>\n              <span className=\"sr-only\">{styleName}</span>\n            </label>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport type ClusterToolbarProps = {\n  /** Is cluster highlight styling active? Do not render the toolbar if not */\n  active: boolean;\n  availableStyles: HighlightStyles;\n  currentStyles: AppliedStyles;\n  onStyleChange: (cluster: HighlightCluster, styleName: string) => void;\n};\n\n/**\n * Render controls to change highlight-cluster styling.\n */\nexport default function ClusterToolbar({\n  active,\n  availableStyles,\n  currentStyles,\n  onStyleChange,\n}: ClusterToolbarProps) {\n  const handleStyleChange = useCallback(\n    (changeEvent: Event) => {\n      const input = changeEvent.target as HTMLInputElement;\n      const cluster = input.name as HighlightCluster;\n      const styleName = input.value;\n\n      onStyleChange(cluster, styleName);\n    },\n    [onStyleChange]\n  );\n\n  const [isOpen, setOpen] = useState(false);\n\n  if (!active) {\n    return null;\n  }\n\n  return (\n    <Card>\n      <div className=\"flex flex-col text-annotator-base text-color-text\">\n        <Button\n          data-testid=\"control-toggle-button\"\n          onClick={() => setOpen(!isOpen)}\n          title={isOpen ? 'Hide highlight settings' : 'Show highlight settings'}\n        >\n          {isOpen ? (\n            <>\n              <CaretDownIcon />\n              <span>Highlight Appearance</span>\n            </>\n          ) : (\n            <>\n              <CaretRightIcon />\n              <HighlightIcon />\n            </>\n          )}\n        </Button>\n        {isOpen && (\n          <CardContent data-testid=\"cluster-style-controls\" size=\"sm\">\n            <ClusterStyleControl\n              highlightStyles={availableStyles}\n              label=\"My annotations\"\n              cluster=\"user-annotations\"\n              onChange={handleStyleChange}\n              currentStyles={currentStyles}\n            />\n            <ClusterStyleControl\n              highlightStyles={availableStyles}\n              label=\"My highlights\"\n              cluster=\"user-highlights\"\n              onChange={handleStyleChange}\n              currentStyles={currentStyles}\n            />\n            <ClusterStyleControl\n              highlightStyles={availableStyles}\n              label=\"Everybody's content\"\n              cluster=\"other-content\"\n              onChange={handleStyleChange}\n              currentStyles={currentStyles}\n            />\n          </CardContent>\n        )}\n      </div>\n    </Card>\n  );\n}\n","import { render } from 'preact';\n\nimport type {\n  Destroyable,\n  FeatureFlags as IFeatureFlags,\n} from '../types/annotator';\nimport type { HighlightCluster } from '../types/shared';\nimport ClusterToolbar from './components/ClusterToolbar';\nimport { updateClusters } from './highlighter';\nimport { createShadowRoot } from './util/shadow-root';\n\nexport type HighlightStyle = {\n  color: string;\n  secondColor: string;\n  thirdColor: string;\n};\n\nexport type HighlightStyles = Record<string, HighlightStyle>;\nexport type AppliedStyles = Record<HighlightCluster, keyof HighlightStyles>;\n\n// Available styles that users can apply to highlight clusters\nexport const highlightStyles: HighlightStyles = {\n  transparent: {\n    color: 'transparent',\n    secondColor: 'transparent',\n    thirdColor: 'transparent',\n  },\n  pink: {\n    color: 'var(--hypothesis-color-pink)',\n    secondColor: 'var(--hypothesis-color-pink-1)',\n    thirdColor: 'var(--hypothesis-color-pink-2)',\n  },\n  orange: {\n    color: 'var(--hypothesis-color-orange)',\n    secondColor: 'var(--hypothesis-color-orange-1)',\n    thirdColor: 'var(--hypothesis-color-orange-2)',\n  },\n  yellow: {\n    color: 'var(--hypothesis-color-yellow)',\n    secondColor: 'var(--hypothesis-color-yellow-1)',\n    thirdColor: 'var(--hypothesis-color-yellow-2)',\n  },\n  green: {\n    color: 'var(--hypothesis-color-green)',\n    secondColor: 'var(--hypothesis-color-green-1)',\n    thirdColor: 'var(--hypothesis-color-green-2)',\n  },\n  purple: {\n    color: 'var(--hypothesis-color-purple)',\n    secondColor: 'var(--hypothesis-color-purple-1)',\n    thirdColor: 'var(--hypothesis-color-purple-2)',\n  },\n  grey: {\n    color: 'var(--hypothesis-color-grey)',\n    secondColor: 'var(--hypothesis-color-grey-1)',\n    thirdColor: 'var(--hypothesis-color-grey-2)',\n  },\n};\n\n// The default styles applied to each highlight cluster. For now, this is\n// hard-coded.\nexport const defaultClusterStyles: AppliedStyles = {\n  'other-content': 'yellow',\n  'user-annotations': 'orange',\n  'user-highlights': 'purple',\n};\n\nexport class HighlightClusterController implements Destroyable {\n  appliedStyles: AppliedStyles;\n  private _element: HTMLElement;\n  private _features: IFeatureFlags;\n  private _outerContainer: HTMLElement;\n  private _shadowRoot: ShadowRoot;\n  private _updateTimeout?: number;\n\n  constructor(element: HTMLElement, options: { features: IFeatureFlags }) {\n    this._element = element;\n    this._features = options.features;\n\n    this._outerContainer = document.createElement(\n      'hypothesis-highlight-cluster-toolbar'\n    );\n    this._element.appendChild(this._outerContainer);\n    this._shadowRoot = createShadowRoot(this._outerContainer);\n\n    // For now, the controls are fixed at top-left of screen. This is temporary.\n    Object.assign(this._outerContainer.style, {\n      position: 'fixed',\n      top: `${this._element.offsetTop + 4}px`,\n      left: '4px',\n    });\n\n    this.appliedStyles = defaultClusterStyles;\n\n    this._init();\n\n    this._features.on('flagsChanged', () => {\n      this._activate(this._isActive());\n    });\n\n    this._render();\n  }\n\n  destroy() {\n    clearTimeout(this._updateTimeout);\n    render(null, this._shadowRoot); // unload the Preact component\n    this._activate(false); // De-activate cluster styling\n    this._outerContainer.remove();\n  }\n\n  /**\n   * Indicate that the set of highlights in the document has been dirtied and we\n   * should schedule an update to highlight data attributes and stacking order.\n   */\n  scheduleClusterUpdates() {\n    clearTimeout(this._updateTimeout);\n    this._updateTimeout = setTimeout(() => this._updateClusters(), 100);\n  }\n\n  /**\n   * Set initial values for :root CSS custom properties (variables) based on the\n   * applied styles for each cluster. This has no effect if this feature\n   * is not active.\n   */\n  _init() {\n    for (const cluster of Object.keys(this.appliedStyles) as Array<\n      keyof typeof this.appliedStyles\n    >) {\n      this._setClusterStyles(cluster, this.appliedStyles[cluster]);\n    }\n\n    this._activate(this._isActive());\n  }\n\n  _updateClusters() {\n    if (!this._isActive()) {\n      /* istanbul ignore next */\n      return;\n    }\n    updateClusters(this._element);\n  }\n\n  _isActive() {\n    return this._features.flagEnabled('styled_highlight_clusters');\n  }\n\n  /**\n   * Activate cluster highlighting if `active` is set.\n   */\n  _activate(active: boolean) {\n    this._element.classList.toggle('hypothesis-highlights-clustered', active);\n    this._render();\n  }\n\n  /**\n   * Set a value for an individual CSS variable at :root\n   */\n  _setClusterStyle(key: string, value: string) {\n    document.documentElement.style.setProperty(key, value);\n  }\n\n  /**\n   * Set CSS variables for the highlight `cluster` to apply the\n   * {@link HighlightStyle} `highlightStyles[styleName]`\n   */\n  _setClusterStyles(\n    cluster: HighlightCluster,\n    styleName: keyof typeof highlightStyles\n  ) {\n    const styleRules = highlightStyles[styleName];\n\n    for (const ruleName of Object.keys(styleRules) as Array<\n      keyof HighlightStyle\n    >) {\n      this._setClusterStyle(\n        `--hypothesis-${cluster}-${ruleName}`,\n        styleRules[ruleName] as string\n      );\n    }\n  }\n\n  /**\n   * Respond to user input to change the applied style for a cluster\n   */\n  _onChangeClusterStyle(\n    cluster: HighlightCluster,\n    styleName: keyof typeof highlightStyles\n  ) {\n    this.appliedStyles[cluster] = styleName;\n    this._setClusterStyles(cluster, styleName);\n    this._render();\n  }\n\n  _render() {\n    render(\n      <ClusterToolbar\n        active={this._isActive()}\n        availableStyles={highlightStyles}\n        currentStyles={this.appliedStyles}\n        onStyleChange={(cluster, styleName) =>\n          this._onChangeClusterStyle(cluster, styleName)\n        }\n      />,\n      this._shadowRoot\n    );\n  }\n}\n","/**\n * Implementation of Myers' online approximate string matching algorithm [1],\n * with additional optimizations suggested by [2].\n *\n * This has O((k/w) * n) expected-time where `n` is the length of the\n * text, `k` is the maximum number of errors allowed (always <= the pattern\n * length) and `w` is the word size. Because JS only supports bitwise operations\n * on 32 bit integers, `w` is 32.\n *\n * As far as I am aware, there aren't any online algorithms which are\n * significantly better for a wide range of input parameters. The problem can be\n * solved faster using \"filter then verify\" approaches which first filter out\n * regions of the text that cannot match using a \"cheap\" check and then verify\n * the remaining potential matches. The verify step requires an algorithm such\n * as this one however.\n *\n * The algorithm's approach is essentially to optimize the classic dynamic\n * programming solution to the problem by computing columns of the matrix in\n * word-sized chunks (ie. dealing with 32 chars of the pattern at a time) and\n * avoiding calculating regions of the matrix where the minimum error count is\n * guaranteed to exceed the input threshold.\n *\n * The paper consists of two parts, the first describes the core algorithm for\n * matching patterns <= the size of a word (implemented by `advanceBlock` here).\n * The second uses the core algorithm as part of a larger block-based algorithm\n * to handle longer patterns.\n *\n * [1] G. Myers, “A Fast Bit-Vector Algorithm for Approximate String Matching\n * Based on Dynamic Programming,” vol. 46, no. 3, pp. 395–415, 1999.\n *\n * [2] Šošić, M. (2014). An simd dynamic programming c/c++ library (Doctoral\n * dissertation, Fakultet Elektrotehnike i računarstva, Sveučilište u Zagrebu).\n */\nfunction reverse(s) {\n    return s.split(\"\").reverse().join(\"\");\n}\n/**\n * Given the ends of approximate matches for `pattern` in `text`, find\n * the start of the matches.\n *\n * @param findEndFn - Function for finding the end of matches in\n * text.\n * @return Matches with the `start` property set.\n */\nfunction findMatchStarts(text, pattern, matches) {\n    const patRev = reverse(pattern);\n    return matches.map((m) => {\n        // Find start of each match by reversing the pattern and matching segment\n        // of text and searching for an approx match with the same number of\n        // errors.\n        const minStart = Math.max(0, m.end - pattern.length - m.errors);\n        const textRev = reverse(text.slice(minStart, m.end));\n        // If there are multiple possible start points, choose the one that\n        // maximizes the length of the match.\n        const start = findMatchEnds(textRev, patRev, m.errors).reduce((min, rm) => {\n            if (m.end - rm.end < min) {\n                return m.end - rm.end;\n            }\n            return min;\n        }, m.end);\n        return {\n            start,\n            end: m.end,\n            errors: m.errors,\n        };\n    });\n}\n/**\n * Return 1 if a number is non-zero or zero otherwise, without using\n * conditional operators.\n *\n * This should get inlined into `advanceBlock` below by the JIT.\n *\n * Adapted from https://stackoverflow.com/a/3912218/434243\n */\nfunction oneIfNotZero(n) {\n    return ((n | -n) >> 31) & 1;\n}\n/**\n * Block calculation step of the algorithm.\n *\n * From Fig 8. on p. 408 of [1], additionally optimized to replace conditional\n * checks with bitwise operations as per Section 4.2.3 of [2].\n *\n * @param ctx - The pattern context object\n * @param peq - The `peq` array for the current character (`ctx.peq.get(ch)`)\n * @param b - The block level\n * @param hIn - Horizontal input delta ∈ {1,0,-1}\n * @return Horizontal output delta ∈ {1,0,-1}\n */\nfunction advanceBlock(ctx, peq, b, hIn) {\n    let pV = ctx.P[b];\n    let mV = ctx.M[b];\n    const hInIsNegative = hIn >>> 31; // 1 if hIn < 0 or 0 otherwise.\n    const eq = peq[b] | hInIsNegative;\n    // Step 1: Compute horizontal deltas.\n    const xV = eq | mV;\n    const xH = (((eq & pV) + pV) ^ pV) | eq;\n    let pH = mV | ~(xH | pV);\n    let mH = pV & xH;\n    // Step 2: Update score (value of last row of this block).\n    const hOut = oneIfNotZero(pH & ctx.lastRowMask[b]) -\n        oneIfNotZero(mH & ctx.lastRowMask[b]);\n    // Step 3: Update vertical deltas for use when processing next char.\n    pH <<= 1;\n    mH <<= 1;\n    mH |= hInIsNegative;\n    pH |= oneIfNotZero(hIn) - hInIsNegative; // set pH[0] if hIn > 0\n    pV = mH | ~(xV | pH);\n    mV = pH & xV;\n    ctx.P[b] = pV;\n    ctx.M[b] = mV;\n    return hOut;\n}\n/**\n * Find the ends and error counts for matches of `pattern` in `text`.\n *\n * Only the matches with the lowest error count are reported. Other matches\n * with error counts <= maxErrors are discarded.\n *\n * This is the block-based search algorithm from Fig. 9 on p.410 of [1].\n */\nfunction findMatchEnds(text, pattern, maxErrors) {\n    if (pattern.length === 0) {\n        return [];\n    }\n    // Clamp error count so we can rely on the `maxErrors` and `pattern.length`\n    // rows being in the same block below.\n    maxErrors = Math.min(maxErrors, pattern.length);\n    const matches = [];\n    // Word size.\n    const w = 32;\n    // Index of maximum block level.\n    const bMax = Math.ceil(pattern.length / w) - 1;\n    // Context used across block calculations.\n    const ctx = {\n        P: new Uint32Array(bMax + 1),\n        M: new Uint32Array(bMax + 1),\n        lastRowMask: new Uint32Array(bMax + 1),\n    };\n    ctx.lastRowMask.fill(1 << 31);\n    ctx.lastRowMask[bMax] = 1 << (pattern.length - 1) % w;\n    // Dummy \"peq\" array for chars in the text which do not occur in the pattern.\n    const emptyPeq = new Uint32Array(bMax + 1);\n    // Map of UTF-16 character code to bit vector indicating positions in the\n    // pattern that equal that character.\n    const peq = new Map();\n    // Version of `peq` that only stores mappings for small characters. This\n    // allows faster lookups when iterating through the text because a simple\n    // array lookup can be done instead of a hash table lookup.\n    const asciiPeq = [];\n    for (let i = 0; i < 256; i++) {\n        asciiPeq.push(emptyPeq);\n    }\n    // Calculate `ctx.peq` - a map of character values to bitmasks indicating\n    // positions of that character within the pattern, where each bit represents\n    // a position in the pattern.\n    for (let c = 0; c < pattern.length; c += 1) {\n        const val = pattern.charCodeAt(c);\n        if (peq.has(val)) {\n            // Duplicate char in pattern.\n            continue;\n        }\n        const charPeq = new Uint32Array(bMax + 1);\n        peq.set(val, charPeq);\n        if (val < asciiPeq.length) {\n            asciiPeq[val] = charPeq;\n        }\n        for (let b = 0; b <= bMax; b += 1) {\n            charPeq[b] = 0;\n            // Set all the bits where the pattern matches the current char (ch).\n            // For indexes beyond the end of the pattern, always set the bit as if the\n            // pattern contained a wildcard char in that position.\n            for (let r = 0; r < w; r += 1) {\n                const idx = b * w + r;\n                if (idx >= pattern.length) {\n                    continue;\n                }\n                const match = pattern.charCodeAt(idx) === val;\n                if (match) {\n                    charPeq[b] |= 1 << r;\n                }\n            }\n        }\n    }\n    // Index of last-active block level in the column.\n    let y = Math.max(0, Math.ceil(maxErrors / w) - 1);\n    // Initialize maximum error count at bottom of each block.\n    const score = new Uint32Array(bMax + 1);\n    for (let b = 0; b <= y; b += 1) {\n        score[b] = (b + 1) * w;\n    }\n    score[bMax] = pattern.length;\n    // Initialize vertical deltas for each block.\n    for (let b = 0; b <= y; b += 1) {\n        ctx.P[b] = ~0;\n        ctx.M[b] = 0;\n    }\n    // Process each char of the text, computing the error count for `w` chars of\n    // the pattern at a time.\n    for (let j = 0; j < text.length; j += 1) {\n        // Lookup the bitmask representing the positions of the current char from\n        // the text within the pattern.\n        const charCode = text.charCodeAt(j);\n        let charPeq;\n        if (charCode < asciiPeq.length) {\n            // Fast array lookup.\n            charPeq = asciiPeq[charCode];\n        }\n        else {\n            // Slower hash table lookup.\n            charPeq = peq.get(charCode);\n            if (typeof charPeq === \"undefined\") {\n                charPeq = emptyPeq;\n            }\n        }\n        // Calculate error count for blocks that we definitely have to process for\n        // this column.\n        let carry = 0;\n        for (let b = 0; b <= y; b += 1) {\n            carry = advanceBlock(ctx, charPeq, b, carry);\n            score[b] += carry;\n        }\n        // Check if we also need to compute an additional block, or if we can reduce\n        // the number of blocks processed for the next column.\n        if (score[y] - carry <= maxErrors &&\n            y < bMax &&\n            (charPeq[y + 1] & 1 || carry < 0)) {\n            // Error count for bottom block is under threshold, increase the number of\n            // blocks processed for this column & next by 1.\n            y += 1;\n            ctx.P[y] = ~0;\n            ctx.M[y] = 0;\n            let maxBlockScore;\n            if (y === bMax) {\n                const remainder = pattern.length % w;\n                maxBlockScore = remainder === 0 ? w : remainder;\n            }\n            else {\n                maxBlockScore = w;\n            }\n            score[y] =\n                score[y - 1] +\n                    maxBlockScore -\n                    carry +\n                    advanceBlock(ctx, charPeq, y, carry);\n        }\n        else {\n            // Error count for bottom block exceeds threshold, reduce the number of\n            // blocks processed for the next column.\n            while (y > 0 && score[y] >= maxErrors + w) {\n                y -= 1;\n            }\n        }\n        // If error count is under threshold, report a match.\n        if (y === bMax && score[y] <= maxErrors) {\n            if (score[y] < maxErrors) {\n                // Discard any earlier, worse matches.\n                matches.splice(0, matches.length);\n            }\n            matches.push({\n                start: -1,\n                end: j + 1,\n                errors: score[y],\n            });\n            // Because `search` only reports the matches with the lowest error count,\n            // we can \"ratchet down\" the max error threshold whenever a match is\n            // encountered and thereby save a small amount of work for the remainder\n            // of the text.\n            maxErrors = score[y];\n        }\n    }\n    return matches;\n}\n/**\n * Search for matches for `pattern` in `text` allowing up to `maxErrors` errors.\n *\n * Returns the start, and end positions and error counts for each lowest-cost\n * match. Only the \"best\" matches are returned.\n */\nexport default function search(text, pattern, maxErrors) {\n    const matches = findMatchEnds(text, pattern, maxErrors);\n    return findMatchStarts(text, pattern, matches);\n}\n","import approxSearch from 'approx-string-match';\nimport type { Match as StringMatch } from 'approx-string-match';\n\ntype Match = {\n  /** Start offset of match in text */\n  start: number;\n  /** End offset of match in text */\n  end: number;\n\n  /**\n   * Score for the match between 0 and 1.0, where 1.0 indicates a perfect match\n   * for the quote and context.\n   */\n  score: number;\n};\n\n/**\n * Find the best approximate matches for `str` in `text` allowing up to\n * `maxErrors` errors.\n */\nfunction search(text: string, str: string, maxErrors: number): StringMatch[] {\n  // Do a fast search for exact matches. The `approx-string-match` library\n  // doesn't currently incorporate this optimization itself.\n  let matchPos = 0;\n  const exactMatches: StringMatch[] = [];\n  while (matchPos !== -1) {\n    matchPos = text.indexOf(str, matchPos);\n    if (matchPos !== -1) {\n      exactMatches.push({\n        start: matchPos,\n        end: matchPos + str.length,\n        errors: 0,\n      });\n      matchPos += 1;\n    }\n  }\n  if (exactMatches.length > 0) {\n    return exactMatches;\n  }\n\n  // If there are no exact matches, do a more expensive search for matches\n  // with errors.\n  return approxSearch(text, str, maxErrors);\n}\n\n/**\n * Compute a score between 0 and 1.0 for the similarity between `text` and `str`.\n */\nfunction textMatchScore(text: string, str: string) {\n  // `search` will return no matches if either the text or pattern is empty,\n  // otherwise it will return at least one match if the max allowed error count\n  // is at least `str.length`.\n  if (str.length === 0 || text.length === 0) {\n    return 0.0;\n  }\n\n  const matches = search(text, str, str.length);\n\n  // prettier-ignore\n  return 1 - (matches[0].errors / str.length);\n}\n\ntype Context = {\n  /** Expected text before the quote */\n  prefix?: string;\n  /** Expected text after the quote */\n  suffix?: string;\n  /** Expected offset of match within text */\n  hint?: number;\n};\n\n/**\n * Find the best approximate match for `quote` in `text`.\n *\n * @param text - Document text to search\n * @param quote - String to find within `text`\n * @param context - Context in which the quote originally appeared. This is\n *        used to choose the best match.\n * @return `null` if no match exceeding the minimum quality threshold was found.\n */\nexport function matchQuote(\n  text: string,\n  quote: string,\n  context: Context = {}\n): Match | null {\n  if (quote.length === 0) {\n    return null;\n  }\n\n  // Choose the maximum number of errors to allow for the initial search.\n  // This choice involves a tradeoff between:\n  //\n  //  - Recall (proportion of \"good\" matches found)\n  //  - Precision (proportion of matches found which are \"good\")\n  //  - Cost of the initial search and of processing the candidate matches [1]\n  //\n  // [1] Specifically, the expected-time complexity of the initial search is\n  //     `O((maxErrors / 32) * text.length)`. See `approx-string-match` docs.\n  const maxErrors = Math.min(256, quote.length / 2);\n\n  // Find the closest matches for `quote` in `text` based on edit distance.\n  const matches = search(text, quote, maxErrors);\n\n  if (matches.length === 0) {\n    return null;\n  }\n\n  /**\n   * Compute a score between 0 and 1.0 for a match candidate.\n   */\n  const scoreMatch = (match: StringMatch) => {\n    const quoteWeight = 50; // Similarity of matched text to quote.\n    const prefixWeight = 20; // Similarity of text before matched text to `context.prefix`.\n    const suffixWeight = 20; // Similarity of text after matched text to `context.suffix`.\n    const posWeight = 2; // Proximity to expected location. Used as a tie-breaker.\n\n    const quoteScore = 1 - match.errors / quote.length;\n\n    const prefixScore = context.prefix\n      ? textMatchScore(\n          text.slice(\n            Math.max(0, match.start - context.prefix.length),\n            match.start\n          ),\n          context.prefix\n        )\n      : 1.0;\n    const suffixScore = context.suffix\n      ? textMatchScore(\n          text.slice(match.end, match.end + context.suffix.length),\n          context.suffix\n        )\n      : 1.0;\n\n    let posScore = 1.0;\n    if (typeof context.hint === 'number') {\n      const offset = Math.abs(match.start - context.hint);\n      posScore = 1.0 - offset / text.length;\n    }\n\n    const rawScore =\n      quoteWeight * quoteScore +\n      prefixWeight * prefixScore +\n      suffixWeight * suffixScore +\n      posWeight * posScore;\n    const maxScore = quoteWeight + prefixWeight + suffixWeight + posWeight;\n    const normalizedScore = rawScore / maxScore;\n\n    return normalizedScore;\n  };\n\n  // Rank matches based on similarity of actual and expected surrounding text\n  // and actual/expected offset in the document text.\n  const scoredMatches = matches.map(m => ({\n    start: m.start,\n    end: m.end,\n    score: scoreMatch(m),\n  }));\n\n  // Choose match with the highest score.\n  scoredMatches.sort((a, b) => b.score - a.score);\n  return scoredMatches[0];\n}\n","/**\n * Get the node name for use in generating an xpath expression.\n *\n * @param {Node} node\n */\nfunction getNodeName(node) {\n  const nodeName = node.nodeName.toLowerCase();\n  let result = nodeName;\n  if (nodeName === '#text') {\n    result = 'text()';\n  }\n  return result;\n}\n\n/**\n * Get the index of the node as it appears in its parent's child list\n *\n * @param {Node} node\n */\nfunction getNodePosition(node) {\n  let pos = 0;\n  /** @type {Node|null} */\n  let tmp = node;\n  while (tmp) {\n    if (tmp.nodeName === node.nodeName) {\n      pos += 1;\n    }\n    tmp = tmp.previousSibling;\n  }\n  return pos;\n}\n\n/** @param {Node} node */\nfunction getPathSegment(node) {\n  const name = getNodeName(node);\n  const pos = getNodePosition(node);\n  return `${name}[${pos}]`;\n}\n\n/**\n * A simple XPath generator which can generate XPaths of the form\n * /tag[index]/tag[index].\n *\n * @param {Node} node - The node to generate a path to\n * @param {Node} root - Root node to which the returned path is relative\n */\nexport function xpathFromNode(node, root) {\n  let xpath = '';\n\n  /** @type {Node|null} */\n  let elem = node;\n  while (elem !== root) {\n    if (!elem) {\n      throw new Error('Node is not a descendant of root');\n    }\n    xpath = getPathSegment(elem) + '/' + xpath;\n    elem = elem.parentNode;\n  }\n  xpath = '/' + xpath;\n  xpath = xpath.replace(/\\/$/, ''); // Remove trailing slash\n\n  return xpath;\n}\n\n/**\n * Return the `index`'th immediate child of `element` whose tag name is\n * `nodeName` (case insensitive).\n *\n * @param {Element} element\n * @param {string} nodeName\n * @param {number} index\n */\nfunction nthChildOfType(element, nodeName, index) {\n  nodeName = nodeName.toUpperCase();\n\n  let matchIndex = -1;\n  for (let i = 0; i < element.children.length; i++) {\n    const child = element.children[i];\n    if (child.nodeName.toUpperCase() === nodeName) {\n      ++matchIndex;\n      if (matchIndex === index) {\n        return child;\n      }\n    }\n  }\n\n  return null;\n}\n\n/**\n * Evaluate a _simple XPath_ relative to a `root` element and return the\n * matching element.\n *\n * A _simple XPath_ is a sequence of one or more `/tagName[index]` strings.\n *\n * Unlike `document.evaluate` this function:\n *\n *  - Only supports simple XPaths\n *  - Is not affected by the document's _type_ (HTML or XML/XHTML)\n *  - Ignores element namespaces when matching element names in the XPath against\n *    elements in the DOM tree\n *  - Is case insensitive for all elements, not just HTML elements\n *\n * The matching element is returned or `null` if no such element is found.\n * An error is thrown if `xpath` is not a simple XPath.\n *\n * @param {string} xpath\n * @param {Element} root\n * @return {Element|null}\n */\nfunction evaluateSimpleXPath(xpath, root) {\n  const isSimpleXPath =\n    xpath.match(/^(\\/[A-Za-z0-9-]+(\\[[0-9]+\\])?)+$/) !== null;\n  if (!isSimpleXPath) {\n    throw new Error('Expression is not a simple XPath');\n  }\n\n  const segments = xpath.split('/');\n  let element = root;\n\n  // Remove leading empty segment. The regex above validates that the XPath\n  // has at least two segments, with the first being empty and the others non-empty.\n  segments.shift();\n\n  for (let segment of segments) {\n    let elementName;\n    let elementIndex;\n\n    const separatorPos = segment.indexOf('[');\n    if (separatorPos !== -1) {\n      elementName = segment.slice(0, separatorPos);\n\n      const indexStr = segment.slice(separatorPos + 1, segment.indexOf(']'));\n      elementIndex = parseInt(indexStr) - 1;\n      if (elementIndex < 0) {\n        return null;\n      }\n    } else {\n      elementName = segment;\n      elementIndex = 0;\n    }\n\n    const child = nthChildOfType(element, elementName, elementIndex);\n    if (!child) {\n      return null;\n    }\n\n    element = child;\n  }\n\n  return element;\n}\n\n/**\n * Finds an element node using an XPath relative to `root`\n *\n * Example:\n *   node = nodeFromXPath('/main/article[1]/p[3]', document.body)\n *\n * @param {string} xpath\n * @param {Element} [root]\n * @return {Node|null}\n */\nexport function nodeFromXPath(xpath, root = document.body) {\n  try {\n    return evaluateSimpleXPath(xpath, root);\n  } catch (err) {\n    return document.evaluate(\n      '.' + xpath,\n      root,\n\n      // nb. The `namespaceResolver` and `result` arguments are optional in the spec\n      // but required in Edge Legacy.\n      null /* namespaceResolver */,\n      XPathResult.FIRST_ORDERED_NODE_TYPE,\n      null /* result */\n    ).singleNodeValue;\n  }\n}\n","/**\n * This module exports a set of classes for converting between DOM `Range`\n * objects and different types of selectors. It is mostly a thin wrapper around a\n * set of anchoring libraries. It serves two main purposes:\n *\n *  1. Providing a consistent interface across different types of anchors.\n *  2. Insulating the rest of the code from API changes in the underlying anchoring\n *     libraries.\n */\nimport { matchQuote } from './match-quote';\nimport { TextRange, TextPosition } from './text-range';\nimport { nodeFromXPath, xpathFromNode } from './xpath';\n\n/**\n * @typedef {import('../../types/api').RangeSelector} RangeSelector\n * @typedef {import('../../types/api').TextPositionSelector} TextPositionSelector\n * @typedef {import('../../types/api').TextQuoteSelector} TextQuoteSelector\n */\n\n/**\n * Converts between `RangeSelector` selectors and `Range` objects.\n */\nexport class RangeAnchor {\n  /**\n   * @param {Node} root - A root element from which to anchor.\n   * @param {Range} range -  A range describing the anchor.\n   */\n  constructor(root, range) {\n    this.root = root;\n    this.range = range;\n  }\n\n  /**\n   * @param {Node} root -  A root element from which to anchor.\n   * @param {Range} range -  A range describing the anchor.\n   */\n  static fromRange(root, range) {\n    return new RangeAnchor(root, range);\n  }\n\n  /**\n   * Create an anchor from a serialized `RangeSelector` selector.\n   *\n   * @param {Element} root -  A root element from which to anchor.\n   * @param {RangeSelector} selector\n   */\n  static fromSelector(root, selector) {\n    const startContainer = nodeFromXPath(selector.startContainer, root);\n    if (!startContainer) {\n      throw new Error('Failed to resolve startContainer XPath');\n    }\n\n    const endContainer = nodeFromXPath(selector.endContainer, root);\n    if (!endContainer) {\n      throw new Error('Failed to resolve endContainer XPath');\n    }\n\n    const startPos = TextPosition.fromCharOffset(\n      startContainer,\n      selector.startOffset\n    );\n    const endPos = TextPosition.fromCharOffset(\n      endContainer,\n      selector.endOffset\n    );\n\n    const range = new TextRange(startPos, endPos).toRange();\n    return new RangeAnchor(root, range);\n  }\n\n  toRange() {\n    return this.range;\n  }\n\n  /**\n   * @return {RangeSelector}\n   */\n  toSelector() {\n    // \"Shrink\" the range so that it tightly wraps its text. This ensures more\n    // predictable output for a given text selection.\n    const normalizedRange = TextRange.fromRange(this.range).toRange();\n\n    const textRange = TextRange.fromRange(normalizedRange);\n    const startContainer = xpathFromNode(textRange.start.element, this.root);\n    const endContainer = xpathFromNode(textRange.end.element, this.root);\n\n    return {\n      type: 'RangeSelector',\n      startContainer,\n      startOffset: textRange.start.offset,\n      endContainer,\n      endOffset: textRange.end.offset,\n    };\n  }\n}\n\n/**\n * Converts between `TextPositionSelector` selectors and `Range` objects.\n */\nexport class TextPositionAnchor {\n  /**\n   * @param {Element} root\n   * @param {number} start\n   * @param {number} end\n   */\n  constructor(root, start, end) {\n    this.root = root;\n    this.start = start;\n    this.end = end;\n  }\n\n  /**\n   * @param {Element} root\n   * @param {Range} range\n   */\n  static fromRange(root, range) {\n    const textRange = TextRange.fromRange(range).relativeTo(root);\n    return new TextPositionAnchor(\n      root,\n      textRange.start.offset,\n      textRange.end.offset\n    );\n  }\n  /**\n   * @param {Element} root\n   * @param {TextPositionSelector} selector\n   */\n  static fromSelector(root, selector) {\n    return new TextPositionAnchor(root, selector.start, selector.end);\n  }\n\n  /**\n   * @return {TextPositionSelector}\n   */\n  toSelector() {\n    return {\n      type: 'TextPositionSelector',\n      start: this.start,\n      end: this.end,\n    };\n  }\n\n  toRange() {\n    return TextRange.fromOffsets(this.root, this.start, this.end).toRange();\n  }\n}\n\n/**\n * @typedef QuoteMatchOptions\n * @prop {number} [hint] - Expected position of match in text. See `matchQuote`.\n */\n\n/**\n * Converts between `TextQuoteSelector` selectors and `Range` objects.\n */\nexport class TextQuoteAnchor {\n  /**\n   * @param {Element} root - A root element from which to anchor.\n   * @param {string} exact\n   * @param {object} context\n   *   @param {string} [context.prefix]\n   *   @param {string} [context.suffix]\n   */\n  constructor(root, exact, context = {}) {\n    this.root = root;\n    this.exact = exact;\n    this.context = context;\n  }\n\n  /**\n   * Create a `TextQuoteAnchor` from a range.\n   *\n   * Will throw if `range` does not contain any text nodes.\n   *\n   * @param {Element} root\n   * @param {Range} range\n   */\n  static fromRange(root, range) {\n    const text = /** @type {string} */ (root.textContent);\n    const textRange = TextRange.fromRange(range).relativeTo(root);\n\n    const start = textRange.start.offset;\n    const end = textRange.end.offset;\n\n    // Number of characters around the quote to capture as context. We currently\n    // always use a fixed amount, but it would be better if this code was aware\n    // of logical boundaries in the document (paragraph, article etc.) to avoid\n    // capturing text unrelated to the quote.\n    //\n    // In regular prose the ideal content would often be the surrounding sentence.\n    // This is a natural unit of meaning which enables displaying quotes in\n    // context even when the document is not available. We could use `Intl.Segmenter`\n    // for this when available.\n    const contextLen = 32;\n\n    return new TextQuoteAnchor(root, text.slice(start, end), {\n      prefix: text.slice(Math.max(0, start - contextLen), start),\n      suffix: text.slice(end, Math.min(text.length, end + contextLen)),\n    });\n  }\n\n  /**\n   * @param {Element} root\n   * @param {TextQuoteSelector} selector\n   */\n  static fromSelector(root, selector) {\n    const { prefix, suffix } = selector;\n    return new TextQuoteAnchor(root, selector.exact, { prefix, suffix });\n  }\n\n  /**\n   * @return {TextQuoteSelector}\n   */\n  toSelector() {\n    return {\n      type: 'TextQuoteSelector',\n      exact: this.exact,\n      prefix: this.context.prefix,\n      suffix: this.context.suffix,\n    };\n  }\n\n  /**\n   * @param {QuoteMatchOptions} [options]\n   */\n  toRange(options = {}) {\n    return this.toPositionAnchor(options).toRange();\n  }\n\n  /**\n   * @param {QuoteMatchOptions} [options]\n   */\n  toPositionAnchor(options = {}) {\n    const text = /** @type {string} */ (this.root.textContent);\n    const match = matchQuote(text, this.exact, {\n      ...this.context,\n      hint: options.hint,\n    });\n    if (!match) {\n      throw new Error('Quote not found');\n    }\n    return new TextPositionAnchor(this.root, match.start, match.end);\n  }\n}\n","import type {\n  RangeSelector,\n  Selector,\n  TextPositionSelector,\n  TextQuoteSelector,\n} from '../../types/api';\nimport { RangeAnchor, TextPositionAnchor, TextQuoteAnchor } from './types';\n\ntype Options = {\n  hint?: number;\n};\n\nasync function querySelector(\n  anchor: RangeAnchor | TextPositionAnchor | TextQuoteAnchor,\n  options: Options\n) {\n  return anchor.toRange(options);\n}\n\n/**\n * Anchor a set of selectors.\n *\n * This function converts a set of selectors into a document range.\n * It encapsulates the core anchoring algorithm, using the selectors alone or\n * in combination to establish the best anchor within the document.\n *\n * @param root - The root element of the anchoring context\n * @param selectors - The selectors to try\n */\nexport function anchor(\n  root: Element,\n  selectors: Selector[],\n  options: Options = {}\n) {\n  let position: TextPositionSelector | null = null;\n  let quote: TextQuoteSelector | null = null;\n  let range: RangeSelector | null = null;\n\n  // Collect all the selectors\n  for (const selector of selectors) {\n    switch (selector.type) {\n      case 'TextPositionSelector':\n        position = selector;\n        options.hint = position.start; // TextQuoteAnchor hint\n        break;\n      case 'TextQuoteSelector':\n        quote = selector;\n        break;\n      case 'RangeSelector':\n        range = selector;\n        break;\n    }\n  }\n\n  /**\n   * Assert the quote matches the stored quote, if applicable\n   */\n  const maybeAssertQuote = (range: Range) => {\n    if (quote?.exact && range.toString() !== quote.exact) {\n      throw new Error('quote mismatch');\n    } else {\n      return range;\n    }\n  };\n\n  // From a default of failure, we build up catch clauses to try selectors in\n  // order, from simple to complex.\n  let promise: Promise<Range> = Promise.reject('unable to anchor');\n\n  if (range) {\n    // Const binding assures TS that it won't be re-assigned when callback runs.\n    const range_ = range;\n    promise = promise.catch(() => {\n      const anchor = RangeAnchor.fromSelector(root, range_);\n      return querySelector(anchor, options).then(maybeAssertQuote);\n    });\n  }\n\n  if (position) {\n    const position_ = position;\n    promise = promise.catch(() => {\n      const anchor = TextPositionAnchor.fromSelector(root, position_);\n      return querySelector(anchor, options).then(maybeAssertQuote);\n    });\n  }\n\n  if (quote) {\n    const quote_ = quote;\n    promise = promise.catch(() => {\n      const anchor = TextQuoteAnchor.fromSelector(root, quote_);\n      return querySelector(anchor, options);\n    });\n  }\n\n  return promise;\n}\n\nexport function describe(root: Element, range: Range) {\n  const types = [RangeAnchor, TextPositionAnchor, TextQuoteAnchor];\n  const result = [];\n  for (const type of types) {\n    try {\n      const anchor = type.fromRange(root, range);\n      result.push(anchor.toSelector());\n    } catch (error) {\n      // If resolving some anchor fails, we just want to skip it silently\n    }\n  }\n  return result;\n}\n","/* global Navigation */\nimport { ListenerCollection } from '../../shared/listener-collection';\n\n/**\n * Monkey-patch an object to observe calls to a method.\n *\n * The `handler` is not invoked if the observed method throws.\n *\n * @template {any} T\n * @param {T} object\n * @param {keyof T} method\n * @param {(...args: unknown[]) => void} handler - Handler that is invoked\n *   after the monitored method has been called.\n * @return {() => void} Callback that removes the observer and restores `object[method]`.\n */\nfunction observeCalls(object, method, handler) {\n  const origHandler = object[method];\n\n  /* istanbul ignore next */\n  if (typeof origHandler !== 'function') {\n    throw new Error('Can only intercept functions');\n  }\n\n  /** @param {unknown[]} args */\n  const wrapper = (...args) => {\n    const result = origHandler.call(object, ...args);\n    handler(...args);\n    return result;\n  };\n  object[method] = /** @type {any} */ (wrapper);\n\n  return () => {\n    object[method] = origHandler;\n  };\n}\n\n/** @param {string} url */\nfunction stripFragment(url) {\n  return url.replace(/#.*/, '');\n}\n\n/**\n * Return the Navigation API entry point for the current window.\n *\n * This is a wrapper around `window.navigation` which checks both that the\n * object exists and has the expected type. See also\n * https://github.com/hypothesis/client/issues/5324.\n *\n * @return {EventTarget|null}\n */\nexport function getNavigation() {\n  const navigation = /** @type {any} */ (window).navigation;\n  if (\n    // @ts-expect-error - Navigation API is missing from TS\n    typeof Navigation === 'function' &&\n    // @ts-expect-error\n    navigation instanceof Navigation\n  ) {\n    return navigation;\n  }\n  return null;\n}\n\n/**\n * Utility for detecting client-side navigations of an HTML document.\n *\n * This uses the Navigation API [1] if available, or falls back to\n * monkey-patching the History API [2] otherwise.\n *\n * Only navigations which change the path or query params are reported. URL\n * updates which change only the hash fragment are assumed to be navigations to\n * different parts of the same logical document. Also Hypothesis in general\n * ignores the hash fragment when comparing URLs.\n *\n * [1] https://wicg.github.io/navigation-api/\n * [2] https://developer.mozilla.org/en-US/docs/Web/API/History\n */\nexport class NavigationObserver {\n  /**\n   * Begin observing navigation changes.\n   *\n   * @param {(url: string) => void} onNavigate - Callback invoked when a navigation\n   *   occurs. The callback is fired after the navigation has completed and the\n   *   new URL is reflected in `location.href`.\n   * @param {() => string} getLocation - Test seam that returns the current URL\n   */\n  constructor(\n    onNavigate,\n    /* istanbul ignore next - default overridden in tests */\n    getLocation = () => location.href\n  ) {\n    this._listeners = new ListenerCollection();\n\n    let lastURL = getLocation();\n    const checkForURLChange = (newURL = getLocation()) => {\n      if (stripFragment(lastURL) !== stripFragment(newURL)) {\n        lastURL = newURL;\n        onNavigate(newURL);\n      }\n    };\n\n    const navigation = getNavigation();\n    if (navigation) {\n      this._listeners.add(navigation, 'navigatesuccess', () =>\n        checkForURLChange()\n      );\n    } else {\n      const unpatchers = [\n        observeCalls(window.history, 'pushState', () => checkForURLChange()),\n        observeCalls(window.history, 'replaceState', () => checkForURLChange()),\n      ];\n      this._unpatchHistory = () => unpatchers.forEach(cleanup => cleanup());\n      this._listeners.add(window, 'popstate', () => checkForURLChange());\n    }\n  }\n\n  /** Stop observing navigation changes. */\n  disconnect() {\n    this._unpatchHistory?.();\n    this._listeners.removeAll();\n  }\n}\n","var COMPLETE = 'complete',\n    CANCELED = 'canceled';\n\nfunction raf(task){\n    if('requestAnimationFrame' in window){\n        return window.requestAnimationFrame(task);\n    }\n\n    setTimeout(task, 16);\n}\n\nfunction setElementScroll(element, x, y){\n    Math.max(0, x);\n    Math.max(0, y);\n\n    if(element.self === element){\n        element.scrollTo(x, y);\n    }else{\n        element.scrollLeft = x;\n        element.scrollTop = y;\n    }\n}\n\nfunction getTargetScrollLocation(scrollSettings, parent){\n    var align = scrollSettings.align,\n        target = scrollSettings.target,\n        targetPosition = target.getBoundingClientRect(),\n        parentPosition,\n        x,\n        y,\n        differenceX,\n        differenceY,\n        targetWidth,\n        targetHeight,\n        leftAlign = align && align.left != null ? align.left : 0.5,\n        topAlign = align && align.top != null ? align.top : 0.5,\n        leftOffset = align && align.leftOffset != null ? align.leftOffset : 0,\n        topOffset = align && align.topOffset != null ? align.topOffset : 0,\n        leftScalar = leftAlign,\n        topScalar = topAlign;\n\n    if(scrollSettings.isWindow(parent)){\n        targetWidth = Math.min(targetPosition.width, parent.innerWidth);\n        targetHeight = Math.min(targetPosition.height, parent.innerHeight);\n        x = targetPosition.left + parent.pageXOffset - parent.innerWidth * leftScalar + targetWidth * leftScalar;\n        y = targetPosition.top + parent.pageYOffset - parent.innerHeight * topScalar + targetHeight * topScalar;\n        x -= leftOffset;\n        y -= topOffset;\n        x = scrollSettings.align.lockX ? parent.pageXOffset : x;\n        y = scrollSettings.align.lockY ? parent.pageYOffset : y;\n        differenceX = x - parent.pageXOffset;\n        differenceY = y - parent.pageYOffset;\n    }else{\n        targetWidth = targetPosition.width;\n        targetHeight = targetPosition.height;\n        parentPosition = parent.getBoundingClientRect();\n        var offsetLeft = targetPosition.left - (parentPosition.left - parent.scrollLeft);\n        var offsetTop = targetPosition.top - (parentPosition.top - parent.scrollTop);\n        x = offsetLeft + (targetWidth * leftScalar) - parent.clientWidth * leftScalar;\n        y = offsetTop + (targetHeight * topScalar) - parent.clientHeight * topScalar;\n        x -= leftOffset;\n        y -= topOffset;\n        x = Math.max(Math.min(x, parent.scrollWidth - parent.clientWidth), 0);\n        y = Math.max(Math.min(y, parent.scrollHeight - parent.clientHeight), 0);\n        x = scrollSettings.align.lockX ? parent.scrollLeft : x;\n        y = scrollSettings.align.lockY ? parent.scrollTop : y;\n        differenceX = x - parent.scrollLeft;\n        differenceY = y - parent.scrollTop;\n    }\n\n    return {\n        x: x,\n        y: y,\n        differenceX: differenceX,\n        differenceY: differenceY\n    };\n}\n\nfunction animate(parent){\n    var scrollSettings = parent._scrollSettings;\n\n    if(!scrollSettings){\n        return;\n    }\n\n    var maxSynchronousAlignments = scrollSettings.maxSynchronousAlignments;\n\n    var location = getTargetScrollLocation(scrollSettings, parent),\n        time = Date.now() - scrollSettings.startTime,\n        timeValue = Math.min(1 / scrollSettings.time * time, 1);\n\n    if(scrollSettings.endIterations >= maxSynchronousAlignments){\n        setElementScroll(parent, location.x, location.y);\n        parent._scrollSettings = null;\n        return scrollSettings.end(COMPLETE);\n    }\n\n    var easeValue = 1 - scrollSettings.ease(timeValue);\n\n    setElementScroll(parent,\n        location.x - location.differenceX * easeValue,\n        location.y - location.differenceY * easeValue\n    );\n\n    if(time >= scrollSettings.time){\n        scrollSettings.endIterations++;\n        // Align ancestor synchronously\n        scrollSettings.scrollAncestor && animate(scrollSettings.scrollAncestor);\n        animate(parent);\n        return;\n    }\n\n    raf(animate.bind(null, parent));\n}\n\nfunction defaultIsWindow(target){\n    return target.self === target\n}\n\nfunction transitionScrollTo(target, parent, settings, scrollAncestor, callback){\n    var idle = !parent._scrollSettings,\n        lastSettings = parent._scrollSettings,\n        now = Date.now(),\n        cancelHandler,\n        passiveOptions = { passive: true };\n\n    if(lastSettings){\n        lastSettings.end(CANCELED);\n    }\n\n    function end(endType){\n        parent._scrollSettings = null;\n\n        if(parent.parentElement && parent.parentElement._scrollSettings){\n            parent.parentElement._scrollSettings.end(endType);\n        }\n\n        if(settings.debug){\n            console.log('Scrolling ended with type', endType, 'for', parent)\n        }\n\n        callback(endType);\n        if(cancelHandler){\n            parent.removeEventListener('touchstart', cancelHandler, passiveOptions);\n            parent.removeEventListener('wheel', cancelHandler, passiveOptions);\n        }\n    }\n\n    var maxSynchronousAlignments = settings.maxSynchronousAlignments;\n\n    if(maxSynchronousAlignments == null){\n        maxSynchronousAlignments = 3;\n    }\n\n    parent._scrollSettings = {\n        startTime: now,\n        endIterations: 0,\n        target: target,\n        time: settings.time,\n        ease: settings.ease,\n        align: settings.align,\n        isWindow: settings.isWindow || defaultIsWindow,\n        maxSynchronousAlignments: maxSynchronousAlignments,\n        end: end,\n        scrollAncestor\n    };\n\n    if(!('cancellable' in settings) || settings.cancellable){\n        cancelHandler = end.bind(null, CANCELED);\n        parent.addEventListener('touchstart', cancelHandler, passiveOptions);\n        parent.addEventListener('wheel', cancelHandler, passiveOptions);\n    }\n\n    if(idle){\n        animate(parent);\n    }\n\n    return cancelHandler\n}\n\nfunction defaultIsScrollable(element){\n    return (\n        'pageXOffset' in element ||\n        (\n            element.scrollHeight !== element.clientHeight ||\n            element.scrollWidth !== element.clientWidth\n        ) &&\n        getComputedStyle(element).overflow !== 'hidden'\n    );\n}\n\nfunction defaultValidTarget(){\n    return true;\n}\n\nfunction findParentElement(el){\n    if (el.assignedSlot) {\n        return findParentElement(el.assignedSlot);\n    }\n\n    if (el.parentElement) {\n        if(el.parentElement.tagName.toLowerCase() === 'body'){\n            return el.parentElement.ownerDocument.defaultView || el.parentElement.ownerDocument.ownerWindow;\n        }\n        return el.parentElement;\n    }\n\n    if (el.getRootNode){\n        var parent = el.getRootNode()\n        if(parent.nodeType === 11) {\n            return parent.host;\n        }\n    }\n}\n\nmodule.exports = function(target, settings, callback){\n    if(!target){\n        return;\n    }\n\n    if(typeof settings === 'function'){\n        callback = settings;\n        settings = null;\n    }\n\n    if(!settings){\n        settings = {};\n    }\n\n    settings.time = isNaN(settings.time) ? 1000 : settings.time;\n    settings.ease = settings.ease || function(v){return 1 - Math.pow(1 - v, v / 2);};\n    settings.align = settings.align || {};\n\n    var parent = findParentElement(target),\n        parents = 1;\n\n    function done(endType){\n        parents--;\n        if(!parents){\n            callback && callback(endType);\n        }\n    }\n\n    var validTarget = settings.validTarget || defaultValidTarget;\n    var isScrollable = settings.isScrollable;\n\n    if(settings.debug){\n        console.log('About to scroll to', target)\n\n        if(!parent){\n            console.error('Target did not have a parent, is it mounted in the DOM?')\n        }\n    }\n\n    var scrollingElements = [];\n\n    while(parent){\n        if(settings.debug){\n            console.log('Scrolling parent node', parent)\n        }\n\n        if(validTarget(parent, parents) && (isScrollable ? isScrollable(parent, defaultIsScrollable) : defaultIsScrollable(parent))){\n            parents++;\n            scrollingElements.push(parent);\n        }\n\n        parent = findParentElement(parent);\n\n        if(!parent){\n            done(COMPLETE)\n            break;\n        }\n    }\n\n    return scrollingElements.reduce((cancel, parent, index) => transitionScrollTo(target, parent, settings, scrollingElements[index + 1], done), null);\n};\n","import scrollIntoView from 'scroll-into-view';\n\n/**\n * Return a promise that resolves on the next animation frame.\n */\nfunction nextAnimationFrame() {\n  return new Promise(resolve => {\n    requestAnimationFrame(resolve);\n  });\n}\n\n/**\n * Linearly interpolate between two values.\n *\n * @param {number} a\n * @param {number} b\n * @param {number} fraction - Value in [0, 1]\n */\nfunction interpolate(a, b, fraction) {\n  return a + fraction * (b - a);\n}\n\n/**\n * Return the offset of `element` from the top of a positioned ancestor `parent`.\n *\n * @param {HTMLElement} element\n * @param {HTMLElement} parent - Positioned ancestor of `element`\n * @return {number}\n */\nexport function offsetRelativeTo(element, parent) {\n  let offset = 0;\n  while (element !== parent && parent.contains(element)) {\n    offset += element.offsetTop;\n    element = /** @type {HTMLElement} */ (element.offsetParent);\n  }\n  return offset;\n}\n\n/**\n * Scroll `element` until its `scrollTop` offset reaches a target value.\n *\n * @param {Element} element - Container element to scroll\n * @param {number} offset - Target value for the scroll offset\n * @param {object} options\n *   @param {number} [options.maxDuration]\n * @return {Promise<void>} - A promise that resolves once the scroll animation\n *   is complete\n */\nexport async function scrollElement(\n  element,\n  offset,\n  /* istanbul ignore next - defaults are overridden in tests */\n  { maxDuration = 500 } = {}\n) {\n  const startOffset = element.scrollTop;\n  const endOffset = offset;\n  const scrollStart = Date.now();\n\n  // Choose a scroll duration proportional to the scroll distance, but capped\n  // to avoid it being too slow.\n  const pixelsPerMs = 3;\n  const scrollDuration = Math.min(\n    Math.abs(endOffset - startOffset) / pixelsPerMs,\n    maxDuration\n  );\n\n  let scrollFraction = 0.0;\n  while (scrollFraction < 1.0) {\n    await nextAnimationFrame();\n    scrollFraction = Math.min(1.0, (Date.now() - scrollStart) / scrollDuration);\n    element.scrollTop = interpolate(startOffset, endOffset, scrollFraction);\n  }\n}\n\n/**\n * Smoothly scroll an element into view.\n *\n * @param {HTMLElement} element\n * @param {object} options\n *   @param {number} [options.maxDuration]\n */\nexport async function scrollElementIntoView(\n  element,\n  /* istanbul ignore next - defaults are overridden in tests */\n  { maxDuration = 500 } = {}\n) {\n  // Make the body's `tagName` return an upper-case string in XHTML documents\n  // like it does in HTML documents. This is a workaround for\n  // `scrollIntoView`'s detection of the <body> element. See\n  // https://github.com/KoryNunn/scroll-into-view/issues/101.\n  const body = element.closest('body');\n  if (body && body.tagName !== 'BODY') {\n    Object.defineProperty(body, 'tagName', {\n      value: 'BODY',\n      configurable: true,\n    });\n  }\n\n  await new Promise(resolve =>\n    scrollIntoView(element, { time: maxDuration }, resolve)\n  );\n}\n","/**\n * Return a normalized version of a URI.\n *\n * This makes it absolute and strips the fragment identifier.\n *\n * @param {string} uri - Relative or absolute URL\n * @param {string} [base] - Base URL to resolve relative to. Defaults to\n *   the document's base URL.\n */\nexport function normalizeURI(uri, base = document.baseURI) {\n  const absUrl = new URL(uri, base).href;\n\n  // Remove the fragment identifier.\n  // This is done on the serialized URL rather than modifying `url.hash` due to\n  // a bug in Safari.\n  // See https://github.com/hypothesis/h/issues/3471#issuecomment-226713750\n  return absUrl.toString().replace(/#.*/, '');\n}\n","/*\n ** Adapted from:\n ** https://github.com/openannotation/annotator/blob/v1.2.x/src/plugin/document.coffee\n **\n ** Annotator v1.2.10\n ** https://github.com/openannotation/annotator\n **\n ** Copyright 2015, the Annotator project contributors.\n ** Dual licensed under the MIT and GPLv3 licenses.\n ** https://github.com/openannotation/annotator/blob/master/LICENSE\n */\nimport { normalizeURI } from '../util/url';\n\ntype Link = {\n  href: string;\n  rel?: string;\n  type?: string;\n};\n\n/**\n * Extension of the `Metadata` type with non-optional fields for `dc`, `eprints` etc.\n */\ntype HTMLDocumentMetadata = {\n  title: string;\n  link: Link[];\n  dc: Record<string, string[]>;\n  eprints: Record<string, string[]>;\n  facebook: Record<string, string[]>;\n  highwire: Record<string, string[]>;\n  prism: Record<string, string[]>;\n  twitter: Record<string, string[]>;\n  favicon?: string;\n  documentFingerprint?: string;\n};\n\n/**\n * HTMLMetadata reads metadata/links from the current HTML document.\n */\nexport class HTMLMetadata {\n  document: Document;\n\n  constructor(options: { document?: Document } = {}) {\n    this.document = options.document || document;\n  }\n\n  /**\n   * Returns the primary URI for the document being annotated\n   */\n  uri(): string {\n    let uri = decodeURIComponent(this._getDocumentHref());\n\n    // Use the `link[rel=canonical]` element's href as the URL if present.\n    const links = this._getLinks();\n    for (const link of links) {\n      if (link.rel === 'canonical') {\n        uri = link.href;\n      }\n    }\n\n    return uri;\n  }\n\n  /**\n   * Return metadata for the current page.\n   */\n  getDocumentMetadata(): HTMLDocumentMetadata {\n    const metadata: HTMLDocumentMetadata = {\n      title: document.title,\n      link: [],\n\n      dc: this._getMetaTags('name', 'dc.'),\n      eprints: this._getMetaTags('name', 'eprints.'),\n      facebook: this._getMetaTags('property', 'og:'),\n      highwire: this._getMetaTags('name', 'citation_'),\n      prism: this._getMetaTags('name', 'prism.'),\n      twitter: this._getMetaTags('name', 'twitter:'),\n    };\n\n    const favicon = this._getFavicon();\n    if (favicon) {\n      metadata.favicon = favicon;\n    }\n\n    metadata.title = this._getTitle(metadata);\n    metadata.link = this._getLinks(metadata);\n\n    const dcLink = metadata.link.find(link => link.href.startsWith('urn:x-dc'));\n    if (dcLink) {\n      metadata.documentFingerprint = dcLink.href;\n    }\n\n    return metadata;\n  }\n\n  /**\n   * Return an array of all the `content` values of `<meta>` tags on the page\n   * where the value of the attribute begins with `<prefix>`.\n   *\n   * @param prefix - it is interpreted as a regex\n   */\n  private _getMetaTags(\n    attribute: string,\n    prefix: string\n  ): Record<string, string[]> {\n    const tags: Record<string, string[]> = {};\n    for (const meta of Array.from(this.document.querySelectorAll('meta'))) {\n      const name = meta.getAttribute(attribute);\n      const { content } = meta;\n      if (name && content) {\n        const match = name.match(RegExp(`^${prefix}(.+)$`, 'i'));\n        if (match) {\n          const key = match[1].toLowerCase();\n          if (tags[key]) {\n            tags[key].push(content);\n          } else {\n            tags[key] = [content];\n          }\n        }\n      }\n    }\n    return tags;\n  }\n\n  private _getTitle(metadata: HTMLDocumentMetadata): string {\n    if (metadata.highwire.title) {\n      return metadata.highwire.title[0];\n    } else if (metadata.eprints.title) {\n      return metadata.eprints.title[0];\n    } else if (metadata.prism.title) {\n      return metadata.prism.title[0];\n    } else if (metadata.facebook.title) {\n      return metadata.facebook.title[0];\n    } else if (metadata.twitter.title) {\n      return metadata.twitter.title[0];\n    } else if (metadata.dc.title) {\n      return metadata.dc.title[0];\n    } else {\n      return this.document.title;\n    }\n  }\n\n  /**\n   * Get document URIs from `<link>` and `<meta>` elements on the page.\n   *\n   * @param [metadata] - Dublin Core and Highwire metadata parsed from `<meta>` tags.\n   */\n  private _getLinks(\n    metadata: Pick<HTMLDocumentMetadata, 'highwire' | 'dc'> = {\n      dc: {},\n      highwire: {},\n    }\n  ): Link[] {\n    const links: Link[] = [{ href: this._getDocumentHref() }];\n\n    // Extract links from `<link>` tags with certain `rel` values.\n    const linkElements = Array.from(this.document.querySelectorAll('link'));\n    for (const link of linkElements) {\n      if (\n        !['alternate', 'canonical', 'bookmark', 'shortlink'].includes(link.rel)\n      ) {\n        continue;\n      }\n\n      if (link.rel === 'alternate') {\n        // Ignore RSS feed links.\n        if (link.type && link.type.match(/^application\\/(rss|atom)\\+xml/)) {\n          continue;\n        }\n        // Ignore alternate languages.\n        if (link.hreflang) {\n          continue;\n        }\n      }\n\n      try {\n        const href = this._absoluteUrl(link.href);\n        links.push({ href, rel: link.rel, type: link.type });\n      } catch (e) {\n        // Ignore URIs which cannot be parsed.\n      }\n    }\n\n    // Look for links in scholar metadata\n    for (const name of Object.keys(metadata.highwire)) {\n      const values = metadata.highwire[name];\n      if (name === 'pdf_url') {\n        for (const url of values) {\n          try {\n            links.push({\n              href: this._absoluteUrl(url),\n              type: 'application/pdf',\n            });\n          } catch (e) {\n            // Ignore URIs which cannot be parsed.\n          }\n        }\n      }\n\n      // Kind of a hack to express DOI identifiers as links but it's a\n      // convenient place to look them up later, and somewhat sane since\n      // they don't have a type.\n      if (name === 'doi') {\n        for (let doi of values) {\n          if (doi.slice(0, 4) !== 'doi:') {\n            doi = `doi:${doi}`;\n          }\n          links.push({ href: doi });\n        }\n      }\n    }\n\n    // Look for links in Dublin Core data\n    for (const name of Object.keys(metadata.dc)) {\n      const values = metadata.dc[name];\n      if (name === 'identifier') {\n        for (const id of values) {\n          if (id.slice(0, 4) === 'doi:') {\n            links.push({ href: id });\n          }\n        }\n      }\n    }\n\n    // Look for a link to identify the resource in Dublin Core metadata\n    const dcRelationValues = metadata.dc['relation.ispartof'];\n    const dcIdentifierValues = metadata.dc.identifier;\n    if (dcRelationValues && dcIdentifierValues) {\n      const dcUrnRelationComponent =\n        dcRelationValues[dcRelationValues.length - 1];\n      const dcUrnIdentifierComponent =\n        dcIdentifierValues[dcIdentifierValues.length - 1];\n      const dcUrn =\n        'urn:x-dc:' +\n        encodeURIComponent(dcUrnRelationComponent) +\n        '/' +\n        encodeURIComponent(dcUrnIdentifierComponent);\n      links.push({ href: dcUrn });\n    }\n\n    return links;\n  }\n\n  private _getFavicon(): string | null {\n    let favicon = null;\n    for (const link of Array.from(this.document.querySelectorAll('link'))) {\n      if (['shortcut icon', 'icon'].includes(link.rel)) {\n        try {\n          favicon = this._absoluteUrl(link.href);\n        } catch (e) {\n          // Ignore URIs which cannot be parsed.\n        }\n      }\n    }\n    return favicon;\n  }\n\n  /**\n   * Convert a possibly relative URI to an absolute one. This will throw an\n   * exception if the URL cannot be parsed.\n   */\n  private _absoluteUrl(url: string): string {\n    return normalizeURI(url, this.document.baseURI);\n  }\n\n  /**\n   * Get the true URI record when it's masked via a different protocol.\n   * This happens when an href is set with a uri using the 'blob:' protocol\n   * but the document can set a different uri through a <base> tag.\n   */\n  private _getDocumentHref(): string {\n    const { href } = this.document.location;\n    const allowedSchemes = ['http:', 'https:', 'file:'];\n\n    // Use the current document location if it has a recognized scheme.\n    const scheme = new URL(href).protocol;\n    if (allowedSchemes.includes(scheme)) {\n      return href;\n    }\n\n    // Otherwise, try using the location specified by the <base> element.\n    if (\n      this.document.baseURI &&\n      allowedSchemes.includes(new URL(this.document.baseURI).protocol)\n    ) {\n      return this.document.baseURI;\n    }\n\n    // Fall back to returning the document URI, even though the scheme is not\n    // in the allowed list.\n    return href;\n  }\n}\n","/**\n * Return the intersection of two rects.\n */\nexport function intersectRects(rectA: DOMRect, rectB: DOMRect) {\n  const left = Math.max(rectA.left, rectB.left);\n  const right = Math.min(rectA.right, rectB.right);\n  const top = Math.max(rectA.top, rectB.top);\n  const bottom = Math.min(rectA.bottom, rectB.bottom);\n  return new DOMRect(left, top, right - left, bottom - top);\n}\n\n/**\n * Return `true` if a rect is _empty_.\n *\n * An empty rect is defined as one with zero or negative width/height, eg.\n * as returned by `new DOMRect()` or `Element.getBoundingClientRect()` for a\n * hidden element.\n */\nexport function rectIsEmpty(rect: DOMRect) {\n  return rect.width <= 0 || rect.height <= 0;\n}\n\n/**\n * Return true if the 1D lines a-b and c-d overlap (ie. the length of their\n * intersection is non-zero).\n *\n * For example, the following lines overlap:\n *\n *   a----b\n *      c------d\n *\n * The inputs must be normalized such that b >= a and d >= c.\n */\nfunction linesOverlap(a: number, b: number, c: number, d: number) {\n  const maxStart = Math.max(a, c);\n  const minEnd = Math.min(b, d);\n  return maxStart < minEnd;\n}\n\n/**\n * Return true if the intersection of `rectB` and `rectA` is non-empty.\n */\nexport function rectIntersects(rectA: DOMRect, rectB: DOMRect) {\n  if (rectIsEmpty(rectA) || rectIsEmpty(rectB)) {\n    return false;\n  }\n\n  return (\n    linesOverlap(rectA.left, rectA.right, rectB.left, rectB.right) &&\n    linesOverlap(rectA.top, rectA.bottom, rectB.top, rectB.bottom)\n  );\n}\n\n/**\n * Return true if `rectB` is fully contained within `rectA`\n */\nexport function rectContains(rectA: DOMRect, rectB: DOMRect) {\n  if (rectIsEmpty(rectA) || rectIsEmpty(rectB)) {\n    return false;\n  }\n\n  return (\n    rectB.left >= rectA.left &&\n    rectB.right <= rectA.right &&\n    rectB.top >= rectA.top &&\n    rectB.bottom <= rectA.bottom\n  );\n}\n\n/**\n * Return true if two rects overlap vertically.\n */\nexport function rectsOverlapVertically(a: DOMRect, b: DOMRect) {\n  return linesOverlap(a.top, a.bottom, b.top, b.bottom);\n}\n\n/**\n * Return true if two rects overlap horizontally.\n */\nexport function rectsOverlapHorizontally(a: DOMRect, b: DOMRect) {\n  return linesOverlap(a.left, a.right, b.left, b.right);\n}\n\n/**\n * Return the union of two rects.\n *\n * The union of an empty rect (see {@link rectIsEmpty}) with a non-empty rect is\n * defined to be the non-empty rect. The union of two empty rects is an empty\n * rect.\n */\nexport function unionRects(a: DOMRect, b: DOMRect) {\n  if (rectIsEmpty(a)) {\n    return b;\n  } else if (rectIsEmpty(b)) {\n    return a;\n  }\n\n  const left = Math.min(a.left, b.left);\n  const top = Math.min(a.top, b.top);\n  const right = Math.max(a.right, b.right);\n  const bottom = Math.max(a.bottom, b.bottom);\n\n  return new DOMRect(left, top, right - left, bottom - top);\n}\n\n/**\n * Return the point at the center of a rect.\n */\nexport function rectCenter(rect: DOMRect) {\n  return new DOMPoint(\n    (rect.left + rect.right) / 2,\n    (rect.top + rect.bottom) / 2\n  );\n}\n","import { rectContains, rectIntersects } from '../util/geometry';\nimport { nodeIsElement, nodeIsText } from '../util/node';\n\n/**\n * CSS selectors used to find elements that are considered potentially part\n * of the main content of a page.\n */\nconst contentSelectors = [\n  'p',\n\n  // Paragraphs in VitalSource \"Great Book\" format ebooks.\n  '.para',\n];\n\n/**\n * Attempt to guess the region of the page that contains the main content.\n *\n * @return The left/right content margins or `null` if they could not be determined\n */\nexport function guessMainContentArea(\n  root: Element\n): { left: number; right: number } | null {\n  // Maps of (margin X coord, votes) for margin positions.\n  const leftMarginVotes = new Map<number, number>();\n  const rightMarginVotes = new Map<number, number>();\n\n  // Gather data about the paragraphs of text in the document.\n  //\n  // In future we might want to expand this to consider other text containers,\n  // since some pages, especially eg. in ebooks, may not have any paragraphs\n  // (eg. instead they may only contain tables or lists or headings).\n  const contentSelector = contentSelectors.join(',');\n  const paragraphs = Array.from(root.querySelectorAll(contentSelector))\n    .map(p => {\n      // Gather some data about them.\n      const rect = p.getBoundingClientRect();\n      const textLength = p.textContent!.length;\n      return { rect, textLength };\n    })\n    .filter(({ rect }) => {\n      // Filter out hidden paragraphs\n      return rect.width > 0 && rect.height > 0;\n    })\n    // Select the paragraphs containing the most text.\n    .sort((a, b) => b.textLength - a.textLength)\n    .slice(0, 15);\n\n  // Let these paragraphs \"vote\" for what the left and right margins of the\n  // main content area in the document are.\n  paragraphs.forEach(({ rect }) => {\n    let leftVotes = leftMarginVotes.get(rect.left) ?? 0;\n    leftVotes += 1;\n    leftMarginVotes.set(rect.left, leftVotes);\n\n    let rightVotes = rightMarginVotes.get(rect.right) ?? 0;\n    rightVotes += 1;\n    rightMarginVotes.set(rect.right, rightVotes);\n  });\n\n  // Find the margin values with the most votes.\n  if (leftMarginVotes.size === 0 || rightMarginVotes.size === 0) {\n    return null;\n  }\n\n  const leftMargin = [...leftMarginVotes.entries()].sort((a, b) => b[1] - a[1]);\n  const rightMargin = [...rightMarginVotes.entries()].sort(\n    (a, b) => b[1] - a[1]\n  );\n\n  const [leftPos] = leftMargin[0];\n  const [rightPos] = rightMargin[0];\n\n  return { left: leftPos, right: rightPos };\n}\n\nlet textRectRange: Range;\n\n/**\n * Return the viewport-relative rect occupied by part of a text node.\n */\nfunction textRect(text: Text, start = 0, end: number = text.data.length) {\n  if (!textRectRange) {\n    // Allocate a range only on the first call to avoid the overhead of\n    // constructing and maintaining a large number of live ranges.\n    textRectRange = document.createRange();\n  }\n  textRectRange.setStart(text, start);\n  textRectRange.setEnd(text, end);\n  return textRectRange.getBoundingClientRect();\n}\n\nfunction hasFixedPosition(element: Element) {\n  switch (getComputedStyle(element).position) {\n    case 'fixed':\n    case 'sticky':\n      return true;\n    default:\n      return false;\n  }\n}\n\n/**\n * Return the bounding rect that contains the element's content. Unlike\n * `Element.getBoundingClientRect`, this includes content which overflows\n * the element's specified size.\n */\nfunction elementContentRect(element: Element) {\n  const rect = element.getBoundingClientRect();\n  rect.x -= element.scrollLeft;\n  rect.y -= element.scrollTop;\n  rect.height = Math.max(rect.height, element.scrollHeight);\n  rect.width = Math.max(rect.width, element.scrollWidth);\n  return rect;\n}\n\n/**\n * Yield all the text node descendants of `root` that intersect `rect`.\n *\n * @param shouldVisit - Optional filter that determines whether to visit a subtree\n */\nfunction* textNodesInRect(\n  root: Element,\n  rect: DOMRect,\n  shouldVisit: (el: Element) => boolean\n): Generator<Text> {\n  let node: Node | null = root.firstChild;\n  while (node) {\n    if (nodeIsElement(node)) {\n      const contentIntersectsRect = rectIntersects(\n        elementContentRect(node),\n        rect\n      );\n\n      // Only examine subtrees which are visible.\n      if (shouldVisit(node) && contentIntersectsRect) {\n        yield* textNodesInRect(node, rect, shouldVisit);\n      }\n    } else if (nodeIsText(node)) {\n      // Skip over text nodes which are entirely outside the viewport or empty.\n      if (rectIntersects(textRect(node), rect)) {\n        yield node;\n      }\n    }\n    node = node.nextSibling;\n  }\n}\n\n/**\n * Find content within an element to use as an anchor when applying a layout\n * change to the document.\n *\n * @return Range to use as an anchor or `null` if a suitable range could not be found\n */\nfunction getScrollAnchor(root: Element, viewport: DOMRect): Range | null {\n  // Range representing the content whose position within the viewport we will\n  // try to maintain after running the callback.\n  let anchorRange: Range | null = null;\n\n  // Find the first word (non-whitespace substring of a text node) that is fully\n  // visible in the viewport.\n\n  // Text inside fixed-position elements is ignored because its position won't\n  // be affected by a layout change and so it makes a poor scroll anchor.\n  const shouldVisit = (el: Element) => !hasFixedPosition(el);\n\n  textNodeLoop: for (const textNode of textNodesInRect(\n    root,\n    viewport,\n    shouldVisit\n  )) {\n    let textLen = 0;\n\n    // Visit all the non-whitespace substrings of the text node.\n    for (const word of textNode.data.split(/\\b/)) {\n      if (/\\S/.test(word)) {\n        const start = textLen;\n        const end = textLen + word.length;\n        const wordBox = textRect(textNode, start, end);\n        if (rectContains(viewport, wordBox)) {\n          anchorRange = document.createRange();\n          anchorRange.setStart(textNode, start);\n          anchorRange.setEnd(textNode, end);\n          break textNodeLoop;\n        }\n      }\n\n      textLen += word.length;\n    }\n  }\n\n  return anchorRange;\n}\n\n/**\n * Apply a layout change to the document and preserve the scroll position.\n *\n * This utility selects part of the content in the viewport as an _anchor_\n * and tries to preserve the position of this content within the viewport\n * after the callback is invoked.\n *\n * @param callback - Callback that will apply the layout change\n * @param [viewport] - Area to consider \"in the viewport\". Defaults to the\n *   viewport of the current window.\n * @return Amount by which the scroll position was adjusted to keep the anchored\n *   content in view\n */\nexport function preserveScrollPosition(\n  callback: () => void,\n  /* istanbul ignore next */\n  scrollRoot: Element = document.documentElement,\n  /* istanbul ignore next */\n  viewport: DOMRect = new DOMRect(0, 0, window.innerWidth, window.innerHeight)\n): number {\n  const anchor = getScrollAnchor(scrollRoot, viewport);\n  if (!anchor) {\n    callback();\n    return 0;\n  }\n\n  const anchorTop = anchor.getBoundingClientRect().top;\n  callback();\n  const newAnchorTop = anchor.getBoundingClientRect().top;\n\n  // Determine how far we scrolled as a result of the layout change.\n  // This will be positive if the anchor element moved down or negative if it moved up.\n  const scrollDelta = newAnchorTop - anchorTop;\n  scrollRoot.scrollTop += scrollDelta;\n\n  return scrollDelta;\n}\n","import { TinyEmitter } from 'tiny-emitter';\n\nimport type {\n  Anchor,\n  FeatureFlags,\n  Integration,\n  SidebarLayout,\n} from '../../types/annotator';\nimport type { Selector } from '../../types/api';\nimport { anchor, describe } from '../anchoring/html';\nimport { TextRange } from '../anchoring/text-range';\nimport { NavigationObserver } from '../util/navigation-observer';\nimport { scrollElementIntoView } from '../util/scroll';\nimport { HTMLMetadata } from './html-metadata';\nimport {\n  guessMainContentArea,\n  preserveScrollPosition,\n} from './html-side-by-side';\n\n// When activating side-by-side mode, make sure there is at least this amount\n// of space (in pixels) left for the document's content. Any narrower and the\n// content line lengths and scale are too short to be readable.\nconst MIN_HTML_WIDTH = 480;\n\n/**\n * Document type integration for ordinary web pages.\n *\n * This integration is used for web pages and applications that are not handled\n * by a more specific integration (eg. for PDFs).\n */\nexport class HTMLIntegration extends TinyEmitter implements Integration {\n  container: HTMLElement;\n  features: FeatureFlags;\n\n  private _flagsChanged: () => void;\n  private _htmlMeta: HTMLMetadata;\n  private _prevURI: string;\n\n  /** Whether to attempt to resize the document to fit alongside sidebar. */\n  private _sideBySideEnabled: boolean;\n\n  /**\n   * Whether the document is currently being resized to fit alongside an\n   * open sidebar.\n   */\n  private _sideBySideActive: boolean;\n\n  private _lastLayout: SidebarLayout | null;\n\n  private _navObserver: NavigationObserver;\n  private _metaObserver: MutationObserver;\n\n  constructor({\n    features,\n    container = document.body,\n  }: {\n    features: FeatureFlags;\n    container?: HTMLElement;\n  }) {\n    super();\n\n    this.features = features;\n    this.container = container;\n\n    this._htmlMeta = new HTMLMetadata();\n    this._prevURI = this._htmlMeta.uri();\n\n    this._sideBySideEnabled = this.features.flagEnabled('html_side_by_side');\n    this._sideBySideActive = false;\n    this._lastLayout = null;\n\n    // Watch for changes to `location.href`.\n    this._navObserver = new NavigationObserver(() => this._checkForURIChange());\n\n    // Watch for potential changes to location information in `<head>`, eg.\n    // `<link rel=canonical>`.\n    this._metaObserver = new MutationObserver(() => this._checkForURIChange());\n    this._metaObserver.observe(document.head, {\n      childList: true,\n      subtree: true,\n      attributes: true,\n\n      attributeFilter: [\n        // Keys and values of <link> elements\n        'rel',\n        'href',\n\n        // Keys and values of <meta> elements\n        'name',\n        'content',\n      ],\n    });\n\n    this._flagsChanged = () => {\n      const sideBySide = features.flagEnabled('html_side_by_side');\n      if (sideBySide !== this._sideBySideEnabled) {\n        this._sideBySideEnabled = sideBySide;\n\n        // `fitSideBySide` is normally called by Guest when the sidebar layout\n        // changes. When the feature flag changes, we need to re-run the method.\n        if (this._lastLayout) {\n          this.fitSideBySide(this._lastLayout);\n        }\n      }\n    };\n    this.features.on('flagsChanged', this._flagsChanged);\n  }\n\n  anchor(root: Element, selectors: Selector[]): Promise<Range> {\n    return anchor(root, selectors);\n  }\n\n  describe(root: Element, range: Range): Selector[] {\n    return describe(root, range);\n  }\n\n  _checkForURIChange() {\n    const currentURI = this._htmlMeta.uri();\n    if (currentURI !== this._prevURI) {\n      this._prevURI = currentURI;\n      this.emit('uriChanged', currentURI);\n    }\n  }\n\n  /**\n   * Return a Range trimmed to remove any leading or trailing whitespace, or\n   * `null` if no valid trimmed Range can be created from `range`\n   */\n  getAnnotatableRange(range: Range) {\n    try {\n      return TextRange.trimmedRange(range);\n    } catch (err) {\n      if (err instanceof RangeError) {\n        return null;\n      }\n      throw err;\n    }\n  }\n\n  canStyleClusteredHighlights() {\n    return true;\n  }\n\n  destroy() {\n    this._navObserver.disconnect();\n    this._metaObserver.disconnect();\n    this.features.off('flagsChanged', this._flagsChanged);\n  }\n\n  contentContainer() {\n    return this.container;\n  }\n\n  fitSideBySide(layout: SidebarLayout) {\n    this._lastLayout = layout;\n\n    const maximumWidthToFit = window.innerWidth - layout.width;\n    const active =\n      this._sideBySideEnabled &&\n      layout.expanded &&\n      maximumWidthToFit >= MIN_HTML_WIDTH;\n\n    if (active) {\n      // nb. We call `_activateSideBySide` regardless of whether side-by-side\n      // is already active because the sidebar width might be different.\n      this._activateSideBySide(layout.width);\n    } else if (this._sideBySideActive) {\n      this._deactivateSideBySide();\n    }\n    this._sideBySideActive = active;\n    return active;\n  }\n\n  /**\n   * Resize the document content after side-by-side mode is activated.\n   */\n  _activateSideBySide(sidebarWidth: number) {\n    // When side-by-side mode is activated, what we want to achieve is that the\n    // main content of the page is fully visible alongside the sidebar, with\n    // as much space given to the main content as possible. A challenge is that\n    // we don't know how the page will respond to reducing the width of the body.\n    //\n    // - The content might have margins which automatically get reduced as the\n    //   available width is reduced. For example a blog post with a fixed-width\n    //   article in the middle and `margin: auto` for both margins.\n    //\n    //   In this scenario we'd want to reduce the document width by the full\n    //   width of the sidebar.\n    //\n    // - There might be sidebars to the left and/or right of the main content\n    //   which cause the main content to be squashed when the width is reduced.\n    //   For example a news website with a column of ads on the right.\n    //\n    //   In this scenario we'd want to not reduce the document width or reduce\n    //   it by a smaller amount and let the Hypothesis sidebar cover up the\n    //   document's sidebar, leaving as much space as possible to the content.\n    //\n    // Therefore what we do is to initially reduce the width of the document by\n    // the full width of the sidebar, then we use heuristics to analyze the\n    // resulting page layout and determine whether there is significant \"free space\"\n    // (ie. anything that is not the main content of the document, such as ads or\n    // links to related stories) to the right of the main content. If there is,\n    // we make the document wider again to allow more space for the main content.\n    //\n    // These heuristics assume a typical \"article\" page with one central block\n    // of content. If we can't find the \"main content\" then we just assume that\n    // everything on the page is potentially content that the user might want\n    // to annotate and so try to keep it all visible.\n\n    // nb. 12px padding is a multiple of the 4px grid unit in our design system.\n    const padding = 12;\n    const rightMargin = sidebarWidth + padding;\n\n    const computeLeftMargin = (element: HTMLElement) =>\n      parseInt(window.getComputedStyle(element).marginLeft, 10);\n\n    preserveScrollPosition(() => {\n      // nb. Adjusting the body size this way relies on the page not setting a\n      // width on the body. For sites that do this won't work.\n\n      // Remove any margins we've previously set\n      document.body.style.marginLeft = '';\n      document.body.style.marginRight = '';\n\n      // Keep track of what left margin would be naturally without right margin set\n      const beforeBodyLeft = computeLeftMargin(document.body);\n\n      document.body.style.marginRight = `${rightMargin}px`;\n\n      const contentArea = guessMainContentArea(document.body);\n      if (contentArea) {\n        // Check if we can give the main content more space by letting the\n        // sidebar overlap stuff in the document to the right of the main content.\n        const freeSpace = Math.max(\n          0,\n          window.innerWidth - rightMargin - contentArea.right\n        );\n        if (freeSpace > 0) {\n          const adjustedMargin = Math.max(0, rightMargin - freeSpace);\n          document.body.style.marginRight = `${adjustedMargin}px`;\n        }\n\n        // Changes to right margin can affect left margin in cases where body\n        // has `margin:auto`. It's OK to move the body to the left to make\n        // space, but avoid moving it to the right.\n        // See https://github.com/hypothesis/client/issues/4280\n        const afterBodyLeft = computeLeftMargin(document.body);\n        if (afterBodyLeft > beforeBodyLeft) {\n          document.body.style.marginLeft = `${beforeBodyLeft}px`;\n        }\n\n        // If the main content appears to be right up against the edge of the\n        // window, add padding for readability.\n        if (contentArea.left < padding) {\n          document.body.style.marginLeft = `${padding}px`;\n        }\n      } else {\n        document.body.style.marginLeft = '';\n        document.body.style.marginRight = '';\n      }\n    });\n  }\n\n  /**\n   * Undo the effects of `activateSideBySide`.\n   */\n  _deactivateSideBySide() {\n    preserveScrollPosition(() => {\n      document.body.style.marginLeft = '';\n      document.body.style.marginRight = '';\n    });\n  }\n\n  async getMetadata() {\n    return this._htmlMeta.getDocumentMetadata();\n  }\n\n  async uri() {\n    return this._htmlMeta.uri();\n  }\n\n  async scrollToAnchor(anchor: Anchor) {\n    const highlight = anchor.highlights?.[0];\n    if (!highlight) {\n      return;\n    }\n    await scrollElementIntoView(highlight);\n  }\n}\n","/**\n * lodash (Custom Build) <https://lodash.com/>\n * Build: `lodash modularize exports=\"npm\" -o ./`\n * Copyright jQuery Foundation and other contributors <https://jquery.org/>\n * Released under MIT license <https://lodash.com/license>\n * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>\n * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors\n */\n\n/** Used as the `TypeError` message for \"Functions\" methods. */\nvar FUNC_ERROR_TEXT = 'Expected a function';\n\n/** Used as references for various `Number` constants. */\nvar NAN = 0 / 0;\n\n/** `Object#toString` result references. */\nvar symbolTag = '[object Symbol]';\n\n/** Used to match leading and trailing whitespace. */\nvar reTrim = /^\\s+|\\s+$/g;\n\n/** Used to detect bad signed hexadecimal string values. */\nvar reIsBadHex = /^[-+]0x[0-9a-f]+$/i;\n\n/** Used to detect binary string values. */\nvar reIsBinary = /^0b[01]+$/i;\n\n/** Used to detect octal string values. */\nvar reIsOctal = /^0o[0-7]+$/i;\n\n/** Built-in method references without a dependency on `root`. */\nvar freeParseInt = parseInt;\n\n/** Detect free variable `global` from Node.js. */\nvar freeGlobal = typeof global == 'object' && global && global.Object === Object && global;\n\n/** Detect free variable `self`. */\nvar freeSelf = typeof self == 'object' && self && self.Object === Object && self;\n\n/** Used as a reference to the global object. */\nvar root = freeGlobal || freeSelf || Function('return this')();\n\n/** Used for built-in method references. */\nvar objectProto = Object.prototype;\n\n/**\n * Used to resolve the\n * [`toStringTag`](http://ecma-international.org/ecma-262/7.0/#sec-object.prototype.tostring)\n * of values.\n */\nvar objectToString = objectProto.toString;\n\n/* Built-in method references for those with the same name as other `lodash` methods. */\nvar nativeMax = Math.max,\n    nativeMin = Math.min;\n\n/**\n * Gets the timestamp of the number of milliseconds that have elapsed since\n * the Unix epoch (1 January 1970 00:00:00 UTC).\n *\n * @static\n * @memberOf _\n * @since 2.4.0\n * @category Date\n * @returns {number} Returns the timestamp.\n * @example\n *\n * _.defer(function(stamp) {\n *   console.log(_.now() - stamp);\n * }, _.now());\n * // => Logs the number of milliseconds it took for the deferred invocation.\n */\nvar now = function() {\n  return root.Date.now();\n};\n\n/**\n * Creates a debounced function that delays invoking `func` until after `wait`\n * milliseconds have elapsed since the last time the debounced function was\n * invoked. The debounced function comes with a `cancel` method to cancel\n * delayed `func` invocations and a `flush` method to immediately invoke them.\n * Provide `options` to indicate whether `func` should be invoked on the\n * leading and/or trailing edge of the `wait` timeout. The `func` is invoked\n * with the last arguments provided to the debounced function. Subsequent\n * calls to the debounced function return the result of the last `func`\n * invocation.\n *\n * **Note:** If `leading` and `trailing` options are `true`, `func` is\n * invoked on the trailing edge of the timeout only if the debounced function\n * is invoked more than once during the `wait` timeout.\n *\n * If `wait` is `0` and `leading` is `false`, `func` invocation is deferred\n * until to the next tick, similar to `setTimeout` with a timeout of `0`.\n *\n * See [David Corbacho's article](https://css-tricks.com/debouncing-throttling-explained-examples/)\n * for details over the differences between `_.debounce` and `_.throttle`.\n *\n * @static\n * @memberOf _\n * @since 0.1.0\n * @category Function\n * @param {Function} func The function to debounce.\n * @param {number} [wait=0] The number of milliseconds to delay.\n * @param {Object} [options={}] The options object.\n * @param {boolean} [options.leading=false]\n *  Specify invoking on the leading edge of the timeout.\n * @param {number} [options.maxWait]\n *  The maximum time `func` is allowed to be delayed before it's invoked.\n * @param {boolean} [options.trailing=true]\n *  Specify invoking on the trailing edge of the timeout.\n * @returns {Function} Returns the new debounced function.\n * @example\n *\n * // Avoid costly calculations while the window size is in flux.\n * jQuery(window).on('resize', _.debounce(calculateLayout, 150));\n *\n * // Invoke `sendMail` when clicked, debouncing subsequent calls.\n * jQuery(element).on('click', _.debounce(sendMail, 300, {\n *   'leading': true,\n *   'trailing': false\n * }));\n *\n * // Ensure `batchLog` is invoked once after 1 second of debounced calls.\n * var debounced = _.debounce(batchLog, 250, { 'maxWait': 1000 });\n * var source = new EventSource('/stream');\n * jQuery(source).on('message', debounced);\n *\n * // Cancel the trailing debounced invocation.\n * jQuery(window).on('popstate', debounced.cancel);\n */\nfunction debounce(func, wait, options) {\n  var lastArgs,\n      lastThis,\n      maxWait,\n      result,\n      timerId,\n      lastCallTime,\n      lastInvokeTime = 0,\n      leading = false,\n      maxing = false,\n      trailing = true;\n\n  if (typeof func != 'function') {\n    throw new TypeError(FUNC_ERROR_TEXT);\n  }\n  wait = toNumber(wait) || 0;\n  if (isObject(options)) {\n    leading = !!options.leading;\n    maxing = 'maxWait' in options;\n    maxWait = maxing ? nativeMax(toNumber(options.maxWait) || 0, wait) : maxWait;\n    trailing = 'trailing' in options ? !!options.trailing : trailing;\n  }\n\n  function invokeFunc(time) {\n    var args = lastArgs,\n        thisArg = lastThis;\n\n    lastArgs = lastThis = undefined;\n    lastInvokeTime = time;\n    result = func.apply(thisArg, args);\n    return result;\n  }\n\n  function leadingEdge(time) {\n    // Reset any `maxWait` timer.\n    lastInvokeTime = time;\n    // Start the timer for the trailing edge.\n    timerId = setTimeout(timerExpired, wait);\n    // Invoke the leading edge.\n    return leading ? invokeFunc(time) : result;\n  }\n\n  function remainingWait(time) {\n    var timeSinceLastCall = time - lastCallTime,\n        timeSinceLastInvoke = time - lastInvokeTime,\n        result = wait - timeSinceLastCall;\n\n    return maxing ? nativeMin(result, maxWait - timeSinceLastInvoke) : result;\n  }\n\n  function shouldInvoke(time) {\n    var timeSinceLastCall = time - lastCallTime,\n        timeSinceLastInvoke = time - lastInvokeTime;\n\n    // Either this is the first call, activity has stopped and we're at the\n    // trailing edge, the system time has gone backwards and we're treating\n    // it as the trailing edge, or we've hit the `maxWait` limit.\n    return (lastCallTime === undefined || (timeSinceLastCall >= wait) ||\n      (timeSinceLastCall < 0) || (maxing && timeSinceLastInvoke >= maxWait));\n  }\n\n  function timerExpired() {\n    var time = now();\n    if (shouldInvoke(time)) {\n      return trailingEdge(time);\n    }\n    // Restart the timer.\n    timerId = setTimeout(timerExpired, remainingWait(time));\n  }\n\n  function trailingEdge(time) {\n    timerId = undefined;\n\n    // Only invoke if we have `lastArgs` which means `func` has been\n    // debounced at least once.\n    if (trailing && lastArgs) {\n      return invokeFunc(time);\n    }\n    lastArgs = lastThis = undefined;\n    return result;\n  }\n\n  function cancel() {\n    if (timerId !== undefined) {\n      clearTimeout(timerId);\n    }\n    lastInvokeTime = 0;\n    lastArgs = lastCallTime = lastThis = timerId = undefined;\n  }\n\n  function flush() {\n    return timerId === undefined ? result : trailingEdge(now());\n  }\n\n  function debounced() {\n    var time = now(),\n        isInvoking = shouldInvoke(time);\n\n    lastArgs = arguments;\n    lastThis = this;\n    lastCallTime = time;\n\n    if (isInvoking) {\n      if (timerId === undefined) {\n        return leadingEdge(lastCallTime);\n      }\n      if (maxing) {\n        // Handle invocations in a tight loop.\n        timerId = setTimeout(timerExpired, wait);\n        return invokeFunc(lastCallTime);\n      }\n    }\n    if (timerId === undefined) {\n      timerId = setTimeout(timerExpired, wait);\n    }\n    return result;\n  }\n  debounced.cancel = cancel;\n  debounced.flush = flush;\n  return debounced;\n}\n\n/**\n * Checks if `value` is the\n * [language type](http://www.ecma-international.org/ecma-262/7.0/#sec-ecmascript-language-types)\n * of `Object`. (e.g. arrays, functions, objects, regexes, `new Number(0)`, and `new String('')`)\n *\n * @static\n * @memberOf _\n * @since 0.1.0\n * @category Lang\n * @param {*} value The value to check.\n * @returns {boolean} Returns `true` if `value` is an object, else `false`.\n * @example\n *\n * _.isObject({});\n * // => true\n *\n * _.isObject([1, 2, 3]);\n * // => true\n *\n * _.isObject(_.noop);\n * // => true\n *\n * _.isObject(null);\n * // => false\n */\nfunction isObject(value) {\n  var type = typeof value;\n  return !!value && (type == 'object' || type == 'function');\n}\n\n/**\n * Checks if `value` is object-like. A value is object-like if it's not `null`\n * and has a `typeof` result of \"object\".\n *\n * @static\n * @memberOf _\n * @since 4.0.0\n * @category Lang\n * @param {*} value The value to check.\n * @returns {boolean} Returns `true` if `value` is object-like, else `false`.\n * @example\n *\n * _.isObjectLike({});\n * // => true\n *\n * _.isObjectLike([1, 2, 3]);\n * // => true\n *\n * _.isObjectLike(_.noop);\n * // => false\n *\n * _.isObjectLike(null);\n * // => false\n */\nfunction isObjectLike(value) {\n  return !!value && typeof value == 'object';\n}\n\n/**\n * Checks if `value` is classified as a `Symbol` primitive or object.\n *\n * @static\n * @memberOf _\n * @since 4.0.0\n * @category Lang\n * @param {*} value The value to check.\n * @returns {boolean} Returns `true` if `value` is a symbol, else `false`.\n * @example\n *\n * _.isSymbol(Symbol.iterator);\n * // => true\n *\n * _.isSymbol('abc');\n * // => false\n */\nfunction isSymbol(value) {\n  return typeof value == 'symbol' ||\n    (isObjectLike(value) && objectToString.call(value) == symbolTag);\n}\n\n/**\n * Converts `value` to a number.\n *\n * @static\n * @memberOf _\n * @since 4.0.0\n * @category Lang\n * @param {*} value The value to process.\n * @returns {number} Returns the number.\n * @example\n *\n * _.toNumber(3.2);\n * // => 3.2\n *\n * _.toNumber(Number.MIN_VALUE);\n * // => 5e-324\n *\n * _.toNumber(Infinity);\n * // => Infinity\n *\n * _.toNumber('3.2');\n * // => 3.2\n */\nfunction toNumber(value) {\n  if (typeof value == 'number') {\n    return value;\n  }\n  if (isSymbol(value)) {\n    return NAN;\n  }\n  if (isObject(value)) {\n    var other = typeof value.valueOf == 'function' ? value.valueOf() : value;\n    value = isObject(other) ? (other + '') : other;\n  }\n  if (typeof value != 'string') {\n    return value === 0 ? value : +value;\n  }\n  value = value.replace(reTrim, '');\n  var isBinary = reIsBinary.test(value);\n  return (isBinary || reIsOctal.test(value))\n    ? freeParseInt(value.slice(2), isBinary ? 2 : 8)\n    : (reIsBadHex.test(value) ? NAN : +value);\n}\n\nmodule.exports = debounce;\n","/**\n * Find the smallest offset in `str` which contains at least `count` chars\n * that match `filter` before it.\n *\n * @param {string} str\n * @param {number} count\n * @param {(char: string) => boolean} filter\n * @param {number} [startPos]\n */\nfunction advance(str, count, filter, startPos = 0) {\n  let pos = startPos;\n  while (pos < str.length && count > 0) {\n    if (filter(str[pos])) {\n      --count;\n    }\n    ++pos;\n  }\n  return pos;\n}\n\n/**\n * Count characters which match `filter` in `str`.\n *\n * @param {string} str\n * @param {(char: string) => boolean} filter\n * @param {number} startPos\n * @param {number} endPos\n */\nfunction countChars(str, filter, startPos, endPos) {\n  let count = 0;\n  for (let pos = startPos; pos < endPos; pos++) {\n    if (filter(str[pos])) {\n      ++count;\n    }\n  }\n  return count;\n}\n\n/**\n * Translate a (start, end) pair of offsets for an \"input\" string into\n * corresponding offsets in an \"output\" string.\n *\n * Positions in the input and output strings are related by counting\n * the number of \"important\" characters before them, as determined by a\n * filter function.\n *\n * An example usage would be to find equivalent positions in two strings which\n * contain the same text content except for the addition or removal of\n * whitespace at arbitrary locations in the output string.\n *\n * Where there are multiple possible offsets in the output string that\n * correspond to the input offsets, the largest start offset and smallest end\n * offset are chosen. In other words, leading and trailing ignored characters\n * are trimmed from the output.\n *\n * @example\n *   // The input offsets (1, 3) select the substring \"bc\" in the \"input\" argument.\n *   // The returned offsets select the substring \"b c\" in the \"output\" argument.\n *   translateOffsets('abcd', ' a b c d ', 1, 3, char => char !== ' ')\n *\n * @param {string} input\n * @param {string} output\n * @param {number} start - Start offset in `input`\n * @param {number} end - End offset in `input`\n * @param {(ch: string) => boolean} filter - Filter function that returns true\n *   if a character should be counted when relating positions between `input`\n *   and `output`.\n * @return {[number, number]} - Start and end offsets in `output`\n */\nexport function translateOffsets(input, output, start, end, filter) {\n  const beforeStartCount = countChars(input, filter, 0, start);\n  const startToEndCount = countChars(input, filter, start, end);\n\n  // Find smallest offset in `output` with same number of non-ignored characters\n  // before it as before `start` in the input. This offset might correspond to\n  // an ignored character.\n  let outputStart = advance(output, beforeStartCount, filter);\n\n  // Increment this offset until it points to a non-ignored character. This\n  // \"trims\" leading ignored characters from the result.\n  while (outputStart < output.length && !filter(output[outputStart])) {\n    ++outputStart;\n  }\n\n  // Find smallest offset in `output` with same number of non-ignored characters\n  // before it as before `end` in the input.\n  const outputEnd = advance(output, startToEndCount, filter, outputStart);\n\n  return [outputStart, outputEnd];\n}\n","/* global PDFViewerApplication */\nimport { warnOnce } from '../../shared/warn-once';\nimport type {\n  TextPositionSelector,\n  TextQuoteSelector,\n  Selector,\n} from '../../types/api';\nimport type { PDFPageView, PDFViewer } from '../../types/pdfjs';\nimport { translateOffsets } from '../util/normalize';\nimport { matchQuote } from './match-quote';\nimport { createPlaceholder } from './placeholder';\nimport { TextPosition, TextRange } from './text-range';\nimport { TextQuoteAnchor } from './types';\n\ntype PDFTextRange = {\n  pageIndex: number;\n  anchor: {\n    /** Start character offset within the page's text. */\n    start: number;\n    /** End character offset within the page's text. */\n    end: number;\n  };\n};\n\n/**\n * Enum values for page rendering states (IRenderableView#renderingState)\n * in PDF.js. Taken from web/pdf_rendering_queue.js in the PDF.js library.\n *\n * Reproduced here because this enum is not exported consistently across\n * different versions of PDF.js\n */\nexport const RenderingStates = {\n  INITIAL: 0,\n  RUNNING: 1,\n  PAUSED: 2,\n  FINISHED: 3,\n};\n\n// Caches for performance.\n\n/**\n * Map of page index to page text content.\n */\nconst pageTextCache = new Map<number, Promise<string>>();\n\n/**\n * A cache that maps a `{quote}:{offset}` key to a specific\n * location in the document.\n *\n * The components of the key come from an annotation's selectors. This is used\n * to speed up re-anchoring an annotation that was previously anchored in the\n * current session.\n */\nconst quotePositionCache = new Map<string, PDFTextRange>();\n\n/**\n * Return a cache key for lookups in `quotePositionCache`.\n *\n * @param [pos] - Offset in document text\n */\nfunction quotePositionCacheKey(quote: string, pos?: number) {\n  return `${quote}:${pos}`;\n}\n\n/**\n * Return offset of `node` among its siblings.\n */\nfunction getSiblingIndex(node: Node) {\n  let index = 0;\n  while (node.previousSibling) {\n    ++index;\n    node = node.previousSibling;\n  }\n  return index;\n}\n\n/**\n * Return the text layer element of the PDF page containing `node`.\n */\nfunction getNodeTextLayer(node: Node | Element): Element | null {\n  const el = 'closest' in node ? node : node.parentElement;\n  return el?.closest('.textLayer') ?? null;\n}\n\n/**\n * Get the PDF.js viewer application.\n */\nfunction getPDFViewer(): PDFViewer {\n  // @ts-ignore - TS doesn't know about PDFViewerApplication global.\n  return PDFViewerApplication.pdfViewer;\n}\n\n/**\n * Returns the view into which a PDF page is drawn.\n *\n * If called while the PDF document is still loading, this will delay until\n * the document loading has progressed far enough for a `PDFPageView` and its\n * associated `PDFPage` to be ready.\n */\nasync function getPageView(pageIndex: number): Promise<PDFPageView> {\n  const pdfViewer = getPDFViewer();\n  let pageView = pdfViewer.getPageView(pageIndex);\n\n  if (!pageView || !pageView.pdfPage) {\n    // If the document is still loading, wait for the `pagesloaded` event.\n    //\n    // Note that loading happens in several stages. Initially the page view\n    // objects do not exist (`pageView` will be nullish), then after the\n    // \"pagesinit\" event, the page view exists but it does not have a `pdfPage`\n    // property set, then finally after the \"pagesloaded\" event, it will have\n    // a \"pdfPage\" property.\n    pageView = await new Promise(resolve => {\n      const onPagesLoaded = () => {\n        if (pdfViewer.eventBus) {\n          pdfViewer.eventBus.off('pagesloaded', onPagesLoaded);\n        } else {\n          document.removeEventListener('pagesloaded', onPagesLoaded);\n        }\n\n        resolve(pdfViewer.getPageView(pageIndex));\n      };\n\n      if (pdfViewer.eventBus) {\n        pdfViewer.eventBus.on('pagesloaded', onPagesLoaded);\n      } else {\n        // Old PDF.js versions (< 1.6.210) use DOM events.\n        document.addEventListener('pagesloaded', onPagesLoaded);\n      }\n    });\n  }\n\n  return pageView!;\n}\n\n/**\n * Return true if the document has selectable text.\n */\nexport async function documentHasText() {\n  const viewer = getPDFViewer();\n  let hasText = false;\n  for (let i = 0; i < viewer.pagesCount; i++) {\n    const pageText = await getPageTextContent(i);\n    if (pageText.trim().length > 0) {\n      hasText = true;\n      break;\n    }\n  }\n  return hasText;\n}\n\n/**\n * Return the text of a given PDF page.\n *\n * The text returned by this function should match the `textContent` of the text\n * layer element that PDF.js creates for rendered pages, with the exception\n * that differences in whitespace are tolerated.\n */\nfunction getPageTextContent(pageIndex: number): Promise<string> {\n  // If we already have or are fetching the text for this page, return the\n  // existing result.\n  const cachedText = pageTextCache.get(pageIndex);\n  if (cachedText) {\n    return cachedText;\n  }\n\n  const getPageText = async () => {\n    const pageView = await getPageView(pageIndex);\n    const textContent = await pageView.pdfPage.getTextContent({\n      // Deprecated option, set for compatibility with older PDF.js releases.\n      normalizeWhitespace: true,\n    });\n    return textContent.items.map(it => it.str).join('');\n  };\n\n  // This function synchronously populates the cache with a promise so that\n  // multiple calls don't call `PDFPageProxy.getTextContent` twice.\n  const pageText = getPageText();\n  pageTextCache.set(pageIndex, pageText);\n  return pageText;\n}\n\n/**\n * Find the offset within the document's text at which a page begins.\n *\n * @return - Offset of page's text within document text\n */\nasync function getPageOffset(pageIndex: number): Promise<number> {\n  const viewer = getPDFViewer();\n  if (pageIndex >= viewer.pagesCount) {\n    /* istanbul ignore next - This should never be triggered */\n    throw new Error('Invalid page index');\n  }\n  let offset = 0;\n  for (let i = 0; i < pageIndex; i++) {\n    const text = await getPageTextContent(i);\n    offset += text.length;\n  }\n  return offset;\n}\n\ntype PageOffset = {\n  /** Page index. */\n  index: number;\n  /** Character offset of start of page within document text. */\n  offset: number;\n  /** Text of page. */\n  text: string;\n};\n\n/**\n * Find the page containing a text offset within the document.\n *\n * If the offset is invalid (less than 0 or greater than the length of the document)\n * then the nearest (first or last) page is returned.\n */\nasync function findPageByOffset(offset: number): Promise<PageOffset> {\n  const viewer = getPDFViewer();\n\n  let pageStartOffset = 0;\n  let pageEndOffset = 0;\n  let text = '';\n\n  for (let i = 0; i < viewer.pagesCount; i++) {\n    text = await getPageTextContent(i);\n    pageStartOffset = pageEndOffset;\n    pageEndOffset += text.length;\n\n    if (pageEndOffset >= offset) {\n      return { index: i, offset: pageStartOffset, text };\n    }\n  }\n\n  // If the offset is beyond the end of the document, just pretend it was on\n  // the last page.\n  return { index: viewer.pagesCount - 1, offset: pageStartOffset, text };\n}\n\n/**\n * Return true if `char` is an ASCII space.\n *\n * This is more efficient than `/\\s/.test(char)` but does not handle Unicode\n * spaces.\n */\nfunction isSpace(char: string) {\n  switch (char) {\n    case ' ':\n    case '\\f':\n    case '\\n':\n    case '\\r':\n    case '\\t':\n    case '\\v':\n    case '\\u00a0': // nbsp\n      return true;\n    default:\n      return false;\n  }\n}\n\nconst isNotSpace = (char: string) => !isSpace(char);\n\n/**\n * Locate the DOM Range which a position selector refers to.\n *\n * If the page is off-screen it may be in an unrendered state, in which case\n * the text layer will not have been created. In that case a placeholder\n * DOM element is created and the returned range refers to that placeholder.\n * In that case, the selector will need to be re-anchored when the page is\n * scrolled into view.\n *\n * @param pageIndex - The PDF page index\n * @param start - Character offset within the page's text\n * @param end - Character offset within the page's text\n */\nasync function anchorByPosition(\n  pageIndex: number,\n  start: number,\n  end: number\n): Promise<Range> {\n  const [page, pageText] = await Promise.all([\n    getPageView(pageIndex),\n    getPageTextContent(pageIndex),\n  ]);\n\n  if (\n    page.renderingState === RenderingStates.FINISHED &&\n    page.textLayer &&\n    page.textLayer.renderingDone\n  ) {\n    // The page has been rendered. Locate the position in the text layer.\n    //\n    // We allow for differences in whitespace between the text returned by\n    // `getPageTextContent` and the text layer content. Any other differences\n    // will cause mis-anchoring.\n\n    const root = page.textLayer.textLayerDiv ?? page.textLayer.div;\n    if (!root) {\n      /* istanbul ignore next */\n      throw new Error('Unable to find PDF.js text layer root');\n    }\n\n    const textLayerStr = root.textContent!;\n\n    const [textLayerStart, textLayerEnd] = translateOffsets(\n      pageText,\n      textLayerStr,\n      start,\n      end,\n      isNotSpace\n    );\n\n    const textLayerQuote = stripSpaces(\n      textLayerStr.slice(textLayerStart, textLayerEnd)\n    );\n    const pageTextQuote = stripSpaces(pageText.slice(start, end));\n    if (textLayerQuote !== pageTextQuote) {\n      warnOnce(\n        'Text layer text does not match page text. Highlights will be mis-aligned.'\n      );\n    }\n\n    const startPos = new TextPosition(root, textLayerStart);\n    const endPos = new TextPosition(root, textLayerEnd);\n    return new TextRange(startPos, endPos).toRange();\n  }\n\n  // The page has not been rendered yet. Create a placeholder element and\n  // anchor to that instead.\n  const placeholder = createPlaceholder(page.div);\n  const range = document.createRange();\n  range.setStartBefore(placeholder);\n  range.setEndAfter(placeholder);\n  return range;\n}\n\n/**\n * Return a string with spaces stripped.\n *\n * This function optimizes for performance of stripping the main space chars\n * that PDF.js generates over handling all kinds of whitespace that could\n * occur in a string.\n */\nfunction stripSpaces(str: string) {\n  let stripped = '';\n  for (let i = 0; i < str.length; i++) {\n    const char = str[i];\n    if (isSpace(char)) {\n      continue;\n    }\n    stripped += char;\n  }\n  return stripped;\n}\n\n/**\n * Search for a quote in the given pages.\n *\n * When comparing quote selectors to document text, ASCII whitespace characters\n * are ignored. This is because text extracted from a PDF by different PDF\n * viewers, including different versions of PDF.js, can often differ in the\n * whitespace between characters and words. For a long time PDF.js in particular\n * had issues where it would often produce extra spaces between characters that\n * should not be there or omit spaces between words.\n *\n * @param [positionHint] - Expected start offset of quote\n * @return - Location of quote\n */\nasync function anchorQuote(\n  quoteSelector: TextQuoteSelector,\n  positionHint?: number\n): Promise<Range> {\n  // Determine which pages to search and in what order. If we have a position\n  // hint we'll try to use that. Otherwise we'll just search all pages in order.\n  const pageCount = getPDFViewer().pagesCount;\n  const pageIndexes = Array(pageCount)\n    .fill(0)\n    .map((_, i) => i);\n\n  let expectedPageIndex;\n  let expectedOffsetInPage;\n\n  if (positionHint) {\n    const { index, offset } = await findPageByOffset(positionHint);\n    expectedPageIndex = index;\n    expectedOffsetInPage = positionHint - offset;\n\n    // Sort pages by distance from the page where we expect to find the quote,\n    // based on the position hint.\n    pageIndexes.sort((a, b) => {\n      const distA = Math.abs(a - index);\n      const distB = Math.abs(b - index);\n      return distA - distB;\n    });\n  }\n\n  // Search pages for the best match, ignoring whitespace differences.\n  const strippedPrefix =\n    quoteSelector.prefix !== undefined\n      ? stripSpaces(quoteSelector.prefix)\n      : undefined;\n  const strippedSuffix =\n    quoteSelector.suffix !== undefined\n      ? stripSpaces(quoteSelector.suffix)\n      : undefined;\n  const strippedQuote = stripSpaces(quoteSelector.exact);\n\n  let bestMatch;\n  for (const page of pageIndexes) {\n    const text = await getPageTextContent(page);\n    const strippedText = stripSpaces(text);\n\n    // Determine expected offset of quote in current page based on position hint.\n    let strippedHint;\n    if (expectedPageIndex !== undefined && expectedOffsetInPage !== undefined) {\n      if (page < expectedPageIndex) {\n        strippedHint = strippedText.length; // Prefer matches closer to end of page.\n      } else if (page === expectedPageIndex) {\n        // Translate expected offset in whitespace-inclusive version of page\n        // text into offset in whitespace-stripped version of page text.\n        [strippedHint] = translateOffsets(\n          text,\n          strippedText,\n          expectedOffsetInPage,\n          expectedOffsetInPage,\n          isNotSpace\n        );\n      } else {\n        strippedHint = 0; // Prefer matches closer to start of page.\n      }\n    }\n\n    const match = matchQuote(strippedText, strippedQuote, {\n      prefix: strippedPrefix,\n      suffix: strippedSuffix,\n      hint: strippedHint,\n    });\n\n    if (!match) {\n      continue;\n    }\n\n    if (!bestMatch || match.score > bestMatch.match.score) {\n      // Translate match offset from whitespace-stripped version of page text\n      // back to original text.\n      const [start, end] = translateOffsets(\n        strippedText,\n        text,\n        match.start,\n        match.end,\n        isNotSpace\n      );\n      bestMatch = {\n        page,\n        match: {\n          start,\n          end,\n          score: match.score,\n        },\n      };\n\n      // If we find a very good match, stop early.\n      //\n      // There is a tradeoff here between optimizing search performance and\n      // ensuring that we have found the best match in the document.\n      //\n      // The current heuristics are that we require an exact match for the quote\n      // and either the preceding or following context. The context matching\n      // helps to avoid incorrectly stopping the search early if the quote is\n      // a word or phrase that is common in the document.\n      const exactQuoteMatch =\n        strippedText.slice(match.start, match.end) === strippedQuote;\n\n      const exactPrefixMatch =\n        strippedPrefix !== undefined &&\n        strippedText.slice(\n          Math.max(0, match.start - strippedPrefix.length),\n          match.start\n        ) === strippedPrefix;\n\n      const exactSuffixMatch =\n        strippedSuffix !== undefined &&\n        strippedText.slice(match.end, strippedSuffix.length) === strippedSuffix;\n\n      const hasContext =\n        strippedPrefix !== undefined || strippedSuffix !== undefined;\n\n      if (\n        exactQuoteMatch &&\n        (exactPrefixMatch || exactSuffixMatch || !hasContext)\n      ) {\n        break;\n      }\n    }\n  }\n\n  if (bestMatch) {\n    const { page, match } = bestMatch;\n\n    // If we found a match, optimize future anchoring of this selector in the\n    // same session by caching the match location.\n    if (positionHint) {\n      const cacheKey = quotePositionCacheKey(quoteSelector.exact, positionHint);\n      quotePositionCache.set(cacheKey, {\n        pageIndex: page,\n        anchor: match,\n      });\n    }\n\n    // Convert the (start, end) position match into a DOM range.\n    return anchorByPosition(page, match.start, match.end);\n  }\n\n  throw new Error('Quote not found');\n}\n\n/**\n * Anchor a set of selectors to a DOM Range.\n *\n * `selectors` must include a `TextQuoteSelector` and may include other selector\n * types.\n */\nexport async function anchor(\n  root: HTMLElement,\n  selectors: Selector[]\n): Promise<Range> {\n  const quote = selectors.find(s => s.type === 'TextQuoteSelector') as\n    | TextQuoteSelector\n    | undefined;\n\n  // The quote selector is required in order to check that text position\n  // selector results are still valid.\n  if (!quote) {\n    throw new Error('No quote selector found');\n  }\n\n  const position = selectors.find(s => s.type === 'TextPositionSelector') as\n    | TextPositionSelector\n    | undefined;\n\n  if (position) {\n    // If we have a position selector, try using that first as it is the fastest\n    // anchoring method.\n    try {\n      const { index, offset, text } = await findPageByOffset(position.start);\n      const start = position.start - offset;\n      const end = position.end - offset;\n\n      const matchedText = text.substring(start, end);\n      if (quote.exact !== matchedText) {\n        throw new Error('quote mismatch');\n      }\n\n      const range = await anchorByPosition(index, start, end);\n      return range;\n    } catch {\n      // Fall back to quote selector\n    }\n\n    // If anchoring with the position failed, check for a cached quote-based\n    // match using the quote + position as a cache key.\n    try {\n      const cacheKey = quotePositionCacheKey(quote.exact, position.start);\n      const cachedPos = quotePositionCache.get(cacheKey);\n      if (cachedPos) {\n        const { pageIndex, anchor } = cachedPos;\n        const range = await anchorByPosition(\n          pageIndex,\n          anchor.start,\n          anchor.end\n        );\n        return range;\n      }\n    } catch {\n      // Fall back to uncached quote selector match\n    }\n  }\n\n  return anchorQuote(quote, position?.start);\n}\n\n/**\n * Prepare a DOM range for generating selectors and find the containing text layer.\n *\n * @throws If the range cannot be annotated\n */\nfunction getTextLayerForRange(range: Range): [Range, Element] {\n  // \"Shrink\" the range so that the start and endpoints are at offsets within\n  // text nodes rather than any containing nodes.\n  try {\n    range = TextRange.fromRange(range).toRange();\n  } catch {\n    throw new Error('Selection does not contain text');\n  }\n\n  const startTextLayer = getNodeTextLayer(range.startContainer);\n  const endTextLayer = getNodeTextLayer(range.endContainer);\n\n  if (!startTextLayer || !endTextLayer) {\n    throw new Error('Selection is outside page text');\n  }\n\n  if (startTextLayer !== endTextLayer) {\n    throw new Error('Selecting across page breaks is not supported');\n  }\n\n  return [range, startTextLayer];\n}\n\n/**\n * Return true if selectors can be generated for a range using `describe`.\n *\n * This function is faster than calling `describe` if the selectors are not\n * required.\n */\nexport function canDescribe(range: Range) {\n  try {\n    getTextLayerForRange(range);\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Convert a DOM Range object into a set of selectors.\n *\n * Converts a DOM `Range` object into a `[position, quote]` tuple of selectors\n * which can be saved with an annotation and later passed to `anchor` to\n * convert the selectors back to a `Range`.\n *\n * @param root - The root element\n */\nexport async function describe(\n  root: HTMLElement,\n  range: Range\n): Promise<Selector[]> {\n  const [textRange, textLayer] = getTextLayerForRange(range);\n\n  const startPos = TextPosition.fromPoint(\n    textRange.startContainer,\n    textRange.startOffset\n  ).relativeTo(textLayer);\n\n  const endPos = TextPosition.fromPoint(\n    textRange.endContainer,\n    textRange.endOffset\n  ).relativeTo(textLayer);\n\n  const startPageIndex = getSiblingIndex(textLayer.parentNode!);\n  const pageOffset = await getPageOffset(startPageIndex);\n\n  const position = {\n    type: 'TextPositionSelector',\n    start: pageOffset + startPos.offset,\n    end: pageOffset + endPos.offset,\n  } as TextPositionSelector;\n\n  const quote = TextQuoteAnchor.fromRange(root, textRange).toSelector();\n\n  return [position, quote];\n}\n\n/**\n * Clear this module's internal caches.\n *\n * This exists mainly as a helper for use in tests.\n */\nexport function purgeCache() {\n  pageTextCache.clear();\n  quotePositionCache.clear();\n}\n","import type { ComponentChildren } from 'preact';\n\nexport type BannersProps = { children: ComponentChildren };\n\n/**\n * Render banners at the top of a document in a stacked column.\n */\nexport default function Banners({ children }: BannersProps) {\n  return <div className=\"flex flex-col\">{children}</div>;\n}\n","import {\n  Link,\n  LinkBase,\n  CaretLeftIcon,\n  CaretRightIcon,\n} from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\n\nimport type { ContentInfoConfig } from '../../types/annotator';\n\nexport type ContentInfoBannerProps = { info: ContentInfoConfig };\n\n/**\n * A banner that displays information about the current document and the entity\n * that is providing access to it (eg. JSTOR).\n *\n * Layout columns:\n *  - Logo\n *  - Container title (only shown on screens at `2xl` breakpoint and wider)\n *  - Item title with previous and next links\n */\nexport default function ContentInfoBanner({ info }: ContentInfoBannerProps) {\n  // Format item title to show subtitle\n  let itemTitle = info.item.title;\n  if (info.item.subtitle) {\n    itemTitle += `: ${info.item.subtitle}`;\n  }\n  return (\n    <div\n      className={classnames(\n        'h-10 bg-white px-4 text-slate-7 text-annotator-base border-b',\n        'grid items-center',\n        // Two columns in narrower viewports; three in wider\n        'grid-cols-[100px_minmax(0,auto)]',\n        '2xl:grid-cols-[100px_minmax(0,auto)_minmax(0,auto)] 2xl:gap-x-3'\n      )}\n    >\n      <div data-testid=\"content-logo\">\n        {info.logo && (\n          <Link href={info.logo.link} target=\"_blank\" data-testid=\"logo-link\">\n            <img\n              alt={info.logo.title}\n              src={info.logo.logo}\n              data-testid=\"logo-image\"\n            />\n          </Link>\n        )}\n      </div>\n      <div\n        className={classnames(\n          // Container title (this element) is not shown on narrow screens\n          'hidden',\n          '2xl:block 2xl:whitespace-nowrap 2xl:overflow-hidden 2xl:text-ellipsis',\n          'font-semibold'\n        )}\n        data-testid=\"content-container-info\"\n        title={info.container.title}\n      >\n        {info.container.title}\n      </div>\n      <div\n        className={classnames(\n          // Flex layout for item title, next and previous links\n          'flex justify-center items-center gap-x-2'\n        )}\n        data-testid=\"content-item-info\"\n      >\n        <div\n          className={classnames(\n            // Narrower viewports center this flex content:\n            // this element is not needed for alignment\n            'hidden',\n            // Wider viewports align this flex content to the right:\n            // This empty element is needed to fill extra space at left\n            '2xl:block 2xl:grow'\n          )}\n        />\n        {info.links.previousItem && (\n          <>\n            <Link\n              classes=\"flex gap-x-1 items-center text-annotator-sm whitespace-nowrap\"\n              title=\"Open previous item\"\n              href={info.links.previousItem}\n              underline=\"always\"\n              target=\"_blank\"\n              data-testid=\"content-previous-link\"\n            >\n              <CaretLeftIcon className=\"w-em h-em\" />\n              <span>Previous</span>\n            </Link>\n            <div className=\"text-annotator-sm\">|</div>\n          </>\n        )}\n        <div\n          className={classnames(\n            // This element will shrink and truncate fluidly.\n            // Overriding min-width `auto` prevents the content from overflowing\n            // See https://stackoverflow.com/a/66689926/434243.\n            'min-w-0 whitespace-nowrap overflow-hidden text-ellipsis shrink font-medium'\n          )}\n        >\n          <LinkBase\n            title={itemTitle}\n            href={info.links.currentItem}\n            data-testid=\"content-item-link\"\n            target=\"_blank\"\n            unstyled\n          >\n            {itemTitle}\n          </LinkBase>\n        </div>\n\n        {info.links.nextItem && (\n          <>\n            <div className=\"text-annotator-sm\">|</div>\n            <Link\n              title=\"Open next item\"\n              classes=\"flex gap-x-1 items-center text-annotator-sm whitespace-nowrap\"\n              href={info.links.nextItem}\n              underline=\"always\"\n              target=\"_blank\"\n              data-testid=\"content-next-link\"\n            >\n              <span>Next</span>\n              <CaretRightIcon className=\"w-em h-em\" />\n            </Link>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","import { CautionIcon, Link } from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\n\n/**\n * A banner shown at the top of the PDF viewer if the PDF cannot be annotated\n * by Hypothesis.\n */\nexport default function WarningBanner() {\n  return (\n    <div className=\"bg-white\" role=\"alert\">\n      <div\n        className={classnames(\n          'flex items-center gap-x-2',\n          'border border-yellow-notice bg-yellow-notice/10 text-annotator-base'\n        )}\n      >\n        <div className=\"bg-yellow-notice text-white p-2\">\n          <CautionIcon className=\"text-annotator-xl\" />\n        </div>\n        <div>\n          <strong>This PDF does not contain selectable text:</strong>{' '}\n          <Link\n            target=\"_blank\"\n            href=\"https://web.hypothes.is/help/how-to-ocr-optimize-pdfs/\"\n            underline=\"always\"\n          >\n            Learn how to fix this\n          </Link>{' '}\n          in order to annotate with Hypothesis.\n        </div>\n      </div>\n    </div>\n  );\n}\n","import type { PDFViewerApplication } from '../../types/pdfjs';\nimport { normalizeURI } from '../util/url';\n\ntype Link = { href: string };\n\ntype Metadata = {\n  /** The document title */\n  title: string;\n  /** Array of URIs associated with this document */\n  link: Link[];\n\n  /**\n   * The fingerprint of this PDF. This is referred to as the \"File Identifier\"\n   * in the PDF spec. It may be a hash of part of the content if the PDF file\n   * does not have a File Identifier.\n   *\n   * PDFs may have two file identifiers. The first is the \"original\" identifier\n   * which is not supposed to change if the file is updated and the second\n   * one is the \"last modified\" identifier. This property is the original\n   * identifier.\n   */\n  documentFingerprint: string;\n};\n\n/**\n * Wait for a PDFViewerApplication to be initialized.\n */\nfunction pdfViewerInitialized(app: PDFViewerApplication): Promise<void> {\n  // `initializedPromise` was added in PDF.js v2.4.456.\n  // See https://github.com/mozilla/pdf.js/pull/11607. In earlier versions the\n  // `initialized` property can be queried.\n  if (app.initializedPromise) {\n    return app.initializedPromise;\n  } else if (app.initialized) {\n    return Promise.resolve();\n  } else {\n    // PDF.js < v2.4.456. The recommended approach is to listen for a `localized`\n    // DOM event, but this assumes that PDF.js has been configured to publish\n    // events to the DOM. Here we simply poll `app.initialized` because it is\n    // easier.\n    return new Promise(resolve => {\n      const timeout = setInterval(() => {\n        if (app.initialized) {\n          clearTimeout(timeout);\n          resolve();\n        }\n      }, 5);\n    });\n  }\n}\n\n/**\n * PDFMetadata extracts metadata about a loading/loaded PDF document from a\n * PDF.js PDFViewerApplication object.\n *\n * @example\n * // Invoke in a PDF.js viewer, before or after the PDF has finished loading.\n * const meta = new PDFMetadata(window.PDFViewerApplication)\n * meta.getUri().then(uri => {\n *    // Do something with the URL of the PDF.\n * })\n */\nexport class PDFMetadata {\n  private _loaded: Promise<PDFViewerApplication>;\n\n  /**\n   * Construct a `PDFMetadata` that returns URIs/metadata associated with a\n   * given PDF viewer.\n   *\n   * @param app - The `PDFViewerApplication` global from PDF.js\n   */\n  constructor(app: PDFViewerApplication) {\n    this._loaded = pdfViewerInitialized(app).then(() => {\n      // Check if document has already loaded.\n      if (app.downloadComplete) {\n        return app;\n      }\n\n      return new Promise(resolve => {\n        const finish = () => {\n          if (app.eventBus) {\n            app.eventBus.off('documentload', finish);\n            app.eventBus.off('documentloaded', finish);\n          } else {\n            window.removeEventListener('documentload', finish);\n          }\n          resolve(app);\n        };\n\n        // Listen for \"documentloaded\" event which signals that the document\n        // has been downloaded and the first page has been rendered.\n        if (app.eventBus) {\n          // PDF.js >= v1.6.210 dispatch events via an internal event bus.\n          // PDF.js < v2.5.207 also dispatches events to the DOM.\n\n          // `documentloaded` is the preferred event in PDF.js >= v2.0.943.\n          // See https://github.com/mozilla/pdf.js/commit/7bc4bfcc8b7f52b14107f0a551becdf01643c5c2\n          app.eventBus.on('documentloaded', finish);\n\n          // `documentload` is dispatched by PDF.js < v2.1.266.\n          app.eventBus.on('documentload', finish);\n        } else {\n          // PDF.js < v1.6.210 dispatches events only to the DOM.\n          window.addEventListener('documentload', finish);\n        }\n      });\n    });\n  }\n\n  /**\n   * Return the URI of the PDF.\n   *\n   * If the PDF is currently loading, the returned promise resolves once loading\n   * is complete.\n   */\n  getUri(): Promise<string> {\n    return this._loaded.then(app => {\n      let uri = getPDFURL(app);\n      if (!uri) {\n        uri = fingerprintToURN(getFingerprint(app));\n      }\n      return uri;\n    });\n  }\n\n  /**\n   * Returns metadata about the document.\n   *\n   * If the PDF is currently loading, the returned promise resolves once loading\n   * is complete.\n   */\n  async getMetadata(): Promise<Metadata> {\n    const app = await this._loaded;\n    const {\n      info: documentInfo,\n      contentDispositionFilename,\n      metadata,\n    } = await app.pdfDocument.getMetadata();\n\n    const documentFingerprint = getFingerprint(app);\n    const url = getPDFURL(app);\n\n    // Return the title metadata embedded in the PDF if available, otherwise\n    // fall back to values from the `Content-Disposition` header or URL.\n    //\n    // PDFs contain two embedded metadata sources, the metadata stream and\n    // the document info dictionary. Per the specification, the metadata stream\n    // is preferred if available.\n    //\n    // This logic is similar to how PDF.js sets `document.title`.\n    let title;\n    if (metadata?.has('dc:title') && metadata.get('dc:title') !== 'Untitled') {\n      title = metadata.get('dc:title');\n    } else if (documentInfo?.Title) {\n      title = documentInfo.Title;\n    } else if (contentDispositionFilename) {\n      title = contentDispositionFilename;\n    } else if (url) {\n      title = filenameFromURL(url);\n    } else {\n      title = '';\n    }\n\n    const link = [{ href: fingerprintToURN(documentFingerprint) }];\n    if (url) {\n      link.push({ href: url });\n    }\n\n    return {\n      title,\n      link,\n      documentFingerprint,\n    };\n  }\n}\n\n/**\n * Get the fingerprint/file identifier of the currently loaded PDF.\n */\nfunction getFingerprint(app: PDFViewerApplication): string {\n  if (Array.isArray(app.pdfDocument.fingerprints)) {\n    return app.pdfDocument.fingerprints[0];\n  } else {\n    return app.pdfDocument.fingerprint!;\n  }\n}\n\n/**\n * Generate a URI from a PDF fingerprint suitable for storing as the main\n * or associated URI of an annotation.\n */\nfunction fingerprintToURN(fingerprint: string) {\n  return `urn:x-pdf:${fingerprint}`;\n}\n\nfunction getPDFURL(app: PDFViewerApplication): string | null {\n  if (!app.url) {\n    return null;\n  }\n\n  const url = normalizeURI(app.url);\n\n  // Local file:// URLs should not be saved in document metadata.\n  // Entries in document.link should be URIs. In the case of\n  // local files, omit the URL.\n  if (url.indexOf('file://') !== 0) {\n    return url;\n  }\n\n  return null;\n}\n\n/**\n * Return the last component of the path part of a URL.\n */\nfunction filenameFromURL(url: string): string {\n  const parsed = new URL(url);\n  const pathSegments = parsed.pathname.split('/');\n  return pathSegments[pathSegments.length - 1];\n}\n","import debounce from 'lodash.debounce';\nimport { render } from 'preact';\nimport { TinyEmitter } from 'tiny-emitter';\n\nimport { ListenerCollection } from '../../shared/listener-collection';\nimport type {\n  Anchor,\n  AnnotationData,\n  Annotator,\n  ContentInfoConfig,\n  Integration,\n  SidebarLayout,\n} from '../../types/annotator';\nimport type { Selector } from '../../types/api';\nimport type { PDFViewer, PDFViewerApplication } from '../../types/pdfjs';\nimport {\n  RenderingStates,\n  anchor,\n  canDescribe,\n  describe,\n  documentHasText,\n} from '../anchoring/pdf';\nimport { isInPlaceholder, removePlaceholder } from '../anchoring/placeholder';\nimport { TextRange } from '../anchoring/text-range';\nimport Banners from '../components/Banners';\nimport ContentInfoBanner from '../components/ContentInfoBanner';\nimport WarningBanner from '../components/WarningBanner';\nimport { offsetRelativeTo, scrollElement } from '../util/scroll';\nimport { createShadowRoot } from '../util/shadow-root';\nimport { PDFMetadata } from './pdf-metadata';\n\n/**\n * Window with additional globals set by PDF.js.\n */\ntype PDFWindow = Window & { PDFViewerApplication: PDFViewerApplication };\n\n// The viewport and controls for PDF.js start breaking down below about 670px\n// of available space, so only render PDF and sidebar side-by-side if there\n// is enough room. Otherwise, allow sidebar to overlap PDF\nconst MIN_PDF_WIDTH = 680;\n\n/**\n * Return true if `anchor` is in an un-rendered page.\n */\nfunction anchorIsInPlaceholder(anchor: Anchor) {\n  const highlight = anchor.highlights?.[0];\n  return highlight && isInPlaceholder(highlight);\n}\n\nfunction delay(ms: number) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Is the current document the PDF.js viewer application?\n */\nexport function isPDF() {\n  const maybePDFJS: Window & { PDFViewerApplication?: PDFViewerApplication } =\n    window;\n  return typeof maybePDFJS.PDFViewerApplication !== 'undefined';\n}\n\n/**\n * Integration that works with PDF.js\n */\nexport class PDFIntegration extends TinyEmitter implements Integration {\n  private _annotator: Annotator;\n\n  /** Banners shown at the top of the PDF viewer. */\n  private _banner: HTMLElement | null;\n\n  /** State indicating which banners to show above the PDF viewer. */\n  private _bannerState: {\n    contentInfo: ContentInfoConfig | null;\n    /** Warning that the current PDF does not have selectable text. */\n    noTextWarning: boolean;\n  };\n\n  /**\n   * A flag that indicates whether `destroy` has been called. Used to handle\n   * `destroy` being called during async code elsewhere in the class.\n   */\n  private _destroyed: boolean;\n  private _listeners: ListenerCollection;\n  private _observer: MutationObserver;\n  private _pdfContainer: HTMLElement;\n  private _pdfMetadata: PDFMetadata;\n  private _pdfViewer: PDFViewer;\n\n  /**\n   * Amount of time to wait for re-anchoring to complete when scrolling to\n   * an anchor in a not-yet-rendered page.\n   */\n  private _reanchoringMaxWait: number;\n  private _updateAnnotationLayerVisibility: () => void;\n\n  /**\n   * @param annotator\n   * @param options\n   *   @param [options.reanchoringMaxWait] - Max time to wait for\n   *     re-anchoring to complete when scrolling to an un-rendered page.\n   */\n  constructor(\n    annotator: Annotator,\n    options: { reanchoringMaxWait?: number } = {}\n  ) {\n    super();\n\n    this._annotator = annotator;\n\n    // Assume this class is only used if we're in the PDF.js viewer.\n    const pdfWindow = window as unknown as PDFWindow;\n    const pdfViewerApp = pdfWindow.PDFViewerApplication;\n\n    this._pdfViewer = pdfViewerApp.pdfViewer;\n    this._pdfViewer.viewer.classList.add('has-transparent-text-layer');\n\n    // Get the element that contains all of the PDF.js UI. This is typically\n    // `document.body`.\n    this._pdfContainer = pdfViewerApp.appConfig?.appContainer ?? document.body;\n\n    this._pdfMetadata = new PDFMetadata(pdfViewerApp);\n\n    this._observer = new MutationObserver(debounce(() => this._update(), 100));\n    this._observer.observe(this._pdfViewer.viewer, {\n      attributes: true,\n      attributeFilter: ['data-loaded'],\n      childList: true,\n      subtree: true,\n    });\n\n    this._reanchoringMaxWait = options.reanchoringMaxWait ?? 3000;\n    this._banner = null;\n    this._bannerState = {\n      contentInfo: null,\n      noTextWarning: false,\n    };\n    this._updateBannerState(this._bannerState);\n    this._checkForSelectableText();\n\n    // Hide annotation layer when the user is making a selection. The annotation\n    // layer appears above the invisible text layer and can interfere with text\n    // selection. See https://github.com/hypothesis/client/issues/1464.\n    this._updateAnnotationLayerVisibility = () => {\n      const selection = pdfWindow.getSelection()!;\n\n      // Add CSS class to indicate whether there is a selection. Annotation\n      // layers are then hidden by a CSS rule in `pdfjs-overrides.scss`.\n      this._pdfViewer.viewer.classList.toggle(\n        'is-selecting',\n        !selection.isCollapsed\n      );\n    };\n\n    this._listeners = new ListenerCollection();\n    this._listeners.add(\n      document,\n      'selectionchange',\n      this._updateAnnotationLayerVisibility\n    );\n\n    this._destroyed = false;\n  }\n\n  destroy() {\n    this._listeners.removeAll();\n    this._pdfViewer.viewer.classList.remove('has-transparent-text-layer');\n    this._observer.disconnect();\n    this._banner?.remove();\n    this._destroyed = true;\n  }\n\n  /**\n   * Return the URL of the currently loaded PDF document.\n   */\n  uri() {\n    return this._pdfMetadata.getUri();\n  }\n\n  /**\n   * Return the metadata (eg. title) for the currently loaded PDF document.\n   */\n  getMetadata() {\n    return this._pdfMetadata.getMetadata();\n  }\n\n  /**\n   * Display a banner at the top of the PDF viewer showing information about the\n   * current document.\n   */\n  showContentInfo(contentInfo: ContentInfoConfig) {\n    this._updateBannerState({ contentInfo });\n  }\n\n  /**\n   * Resolve serialized `selectors` from an annotation to a range.\n   */\n  anchor(root: HTMLElement, selectors: Selector[]): Promise<Range> {\n    // nb. The `root` argument is not really used by `anchor`. It existed for\n    // consistency between HTML and PDF anchoring and could be removed.\n    return anchor(root, selectors);\n  }\n\n  /**\n   * Trim `range` to remove leading or trailing empty content, then check to see\n   * if that trimmed Range lies within a single PDF page's text layer. If so,\n   * return the trimmed Range.\n   */\n  getAnnotatableRange(range: Range) {\n    try {\n      const trimmedRange = TextRange.trimmedRange(range);\n      if (canDescribe(trimmedRange)) {\n        return trimmedRange;\n      }\n    } catch (err) {\n      if (!(err instanceof RangeError)) {\n        throw err;\n      }\n    }\n    return null;\n  }\n\n  /* istanbul ignore next */\n  canStyleClusteredHighlights() {\n    return true;\n  }\n\n  /**\n   * Generate selectors for the text in `range`.\n   */\n  describe(root: HTMLElement, range: Range): Promise<Selector[]> {\n    // nb. The `root` argument is not really used by `anchor`. It existed for\n    // consistency between HTML and PDF anchoring and could be removed.\n    return describe(root, range);\n  }\n\n  /**\n   * Check whether the PDF has selectable text and show a warning if not.\n   */\n  async _checkForSelectableText() {\n    // Wait for PDF to load.\n    try {\n      await this.uri();\n    } catch (e) {\n      return;\n    }\n\n    // Handle `PDF` instance being destroyed while URI is fetched. This is only\n    // expected to happen in synchronous tests.\n    if (this._destroyed) {\n      return;\n    }\n\n    try {\n      const hasText = await documentHasText();\n      this._updateBannerState({ noTextWarning: !hasText });\n    } catch (err) {\n      /* istanbul ignore next */\n      console.warn('Unable to check for text in PDF:', err);\n    }\n  }\n\n  /**\n   * Update banners shown above the PDF viewer.\n   */\n  _updateBannerState(\n    state: Partial<typeof PDFIntegration.prototype._bannerState>\n  ) {\n    this._bannerState = { ...this._bannerState, ...state };\n\n    // Get a reference to the top-level DOM element associated with the PDF.js\n    // viewer.\n    const outerContainer = document.querySelector(\n      '#outerContainer'\n    ) as HTMLElement;\n\n    const showBanner =\n      this._bannerState.contentInfo || this._bannerState.noTextWarning;\n\n    if (!showBanner) {\n      this._banner?.remove();\n      this._banner = null;\n\n      // Undo inline styles applied when the banner is shown. The banner will\n      // then gets its normal 100% height set by PDF.js's CSS.\n      outerContainer.style.height = '';\n\n      return;\n    }\n\n    if (!this._banner) {\n      this._banner = document.createElement('hypothesis-banner');\n      document.body.prepend(this._banner);\n      createShadowRoot(this._banner);\n    }\n\n    render(\n      <Banners>\n        {this._bannerState.contentInfo && (\n          <ContentInfoBanner info={this._bannerState.contentInfo} />\n        )}\n        {this._bannerState.noTextWarning && <WarningBanner />}\n      </Banners>,\n      this._banner.shadowRoot!\n    );\n\n    const bannerHeight = this._banner.getBoundingClientRect().height;\n\n    // The `#outerContainer` element normally has height set to 100% of the body.\n    //\n    // Reduce this by the height of the banner so that it doesn't extend beyond\n    // the bottom of the viewport.\n    //\n    // We don't currently handle the height of the banner changing here.\n    outerContainer.style.height = `calc(100% - ${bannerHeight}px)`;\n  }\n\n  // This method (re-)anchors annotations when pages are rendered and destroyed.\n  _update() {\n    // A list of annotations that need to be refreshed.\n    const refreshAnnotations = [] as AnnotationData[];\n\n    const pageCount = this._pdfViewer.pagesCount;\n    for (let pageIndex = 0; pageIndex < pageCount; pageIndex++) {\n      const page = this._pdfViewer.getPageView(pageIndex);\n      if (!page?.textLayer?.renderingDone) {\n        continue;\n      }\n\n      // Detect what needs to be done by checking the rendering state.\n      switch (page.renderingState) {\n        case RenderingStates.INITIAL:\n          // This page has been reset to its initial state so its text layer\n          // is no longer valid. Null it out so that we don't process it again.\n          page.textLayer = null;\n          break;\n        case RenderingStates.FINISHED:\n          // This page is still rendered. If it has a placeholder node that\n          // means the PDF anchoring module anchored annotations before it was\n          // rendered. Remove this, which will cause the annotations to anchor\n          // again, below.\n          removePlaceholder(page.div);\n          break;\n      }\n    }\n\n    // Find all the anchors that have been invalidated by page state changes.\n    for (const anchor of this._annotator.anchors) {\n      // Skip any we already know about.\n      if (anchor.highlights) {\n        if (refreshAnnotations.includes(anchor.annotation)) {\n          continue;\n        }\n\n        // If the highlights are no longer in the document it means that either\n        // the page was destroyed by PDF.js or the placeholder was removed above.\n        // The annotations for these anchors need to be refreshed.\n        for (let index = 0; index < anchor.highlights.length; index++) {\n          const hl = anchor.highlights[index];\n          if (!document.body.contains(hl)) {\n            anchor.highlights.splice(index, 1);\n            delete anchor.range;\n            refreshAnnotations.push(anchor.annotation);\n            break;\n          }\n        }\n      }\n    }\n\n    refreshAnnotations.map(annotation => this._annotator.anchor(annotation));\n  }\n\n  /**\n   * Return the scrollable element which contains the document content.\n   */\n  contentContainer(): HTMLElement {\n    return document.querySelector('#viewerContainer') as HTMLElement;\n  }\n\n  /**\n   * Attempt to make the PDF viewer and the sidebar fit side-by-side without\n   * overlap if there is enough room in the viewport to do so reasonably.\n   * Resize the PDF viewer container element to leave the right amount of room\n   * for the sidebar, and prompt PDF.js to re-render the PDF pages to scale\n   * within that resized container.\n   *\n   * @return - True if side-by-side mode was activated\n   */\n  fitSideBySide(sidebarLayout: SidebarLayout): boolean {\n    const maximumWidthToFit = window.innerWidth - sidebarLayout.width;\n    const active = sidebarLayout.expanded && maximumWidthToFit >= MIN_PDF_WIDTH;\n\n    // If the sidebar is closed, we reserve enough space for the toolbar controls\n    // so that they don't overlap a) the chevron-menu on the right side of\n    // PDF.js's top toolbar and b) the document's scrollbar.\n    //\n    // If the sidebar is open, we reserve space for the whole sidebar if there is\n    // room, otherwise we reserve the same space as in the closed state to\n    // prevent the PDF content shifting when opening and closing the sidebar.\n    const reservedSpace = active\n      ? sidebarLayout.width\n      : sidebarLayout.toolbarWidth;\n    this._pdfContainer.style.width = `calc(100% - ${reservedSpace}px)`;\n\n    // The following logic is pulled from PDF.js `webViewerResize`\n    const currentScaleValue = this._pdfViewer.currentScaleValue;\n    if (\n      currentScaleValue === 'auto' ||\n      currentScaleValue === 'page-fit' ||\n      currentScaleValue === 'page-width'\n    ) {\n      // NB: There is logic within the setter for `currentScaleValue`\n      // Setting this scale value will prompt PDF.js to recalculate viewport\n      this._pdfViewer.currentScaleValue = currentScaleValue;\n    }\n    // This will cause PDF pages to re-render if their scaling has changed\n    this._pdfViewer.update();\n\n    return active;\n  }\n\n  /**\n   * Scroll to the location of an anchor in the PDF.\n   *\n   * If the anchor refers to a location that is an un-rendered page far from\n   * the viewport, then scrolling happens in three phases. First the document\n   * scrolls to the approximate location indicated by the placeholder anchor,\n   * then `scrollToAnchor` waits until the page's text layer is rendered and\n   * the annotation is re-anchored in the fully rendered page. Then it scrolls\n   * again to the final location.\n   */\n  async scrollToAnchor(anchor: Anchor) {\n    const annotation = anchor.annotation;\n    const inPlaceholder = anchorIsInPlaceholder(anchor);\n    const offset = this._anchorOffset(anchor);\n    if (offset === null) {\n      return;\n    }\n\n    // nb. We only compute the scroll offset once at the start of scrolling.\n    // This is important as the highlight may be removed from the document during\n    // the scroll due to a page transitioning from rendered <-> un-rendered.\n    await scrollElement(this.contentContainer(), offset);\n\n    if (inPlaceholder) {\n      const anchor = await this._waitForAnnotationToBeAnchored(\n        annotation,\n        this._reanchoringMaxWait\n      );\n      if (!anchor) {\n        return;\n      }\n      const offset = this._anchorOffset(anchor);\n      if (offset === null) {\n        return;\n      }\n      await scrollElement(this.contentContainer(), offset);\n    }\n  }\n\n  /**\n   * Wait for an annotation to be anchored in a rendered page.\n   */\n  async _waitForAnnotationToBeAnchored(\n    annotation: AnnotationData,\n    maxWait: number\n  ): Promise<Anchor | null> {\n    const start = Date.now();\n    let anchor;\n    do {\n      // nb. Re-anchoring might result in a different anchor object for the\n      // same annotation.\n      anchor = this._annotator.anchors.find(a => a.annotation === annotation);\n      if (!anchor || anchorIsInPlaceholder(anchor)) {\n        anchor = null;\n\n        // If no anchor was found, wait a bit longer and check again to see if\n        // re-anchoring completed.\n        await delay(20);\n      }\n    } while (!anchor && Date.now() - start < maxWait);\n    return anchor ?? null;\n  }\n\n  /**\n   * Return the offset that the PDF content container would need to be scrolled\n   * to, in order to make an anchor visible.\n   *\n   * @return - Target offset or `null` if this anchor was not resolved\n   */\n  _anchorOffset(anchor: Anchor): number | null {\n    if (!anchor.highlights) {\n      // This anchor was not resolved to a location in the document.\n      return null;\n    }\n    const highlight = anchor.highlights[0];\n    return offsetRelativeTo(highlight, this.contentContainer());\n  }\n}\n","/**\n * Functions for working with EPUB Canonical Fragment Identifiers.\n *\n * See https://idpf.org/epub/linking/cfi/.\n */\n\n/**\n * Compare two arrays.\n *\n * Arrays are compared as a sequence of values in priority order. If the two\n * arrays are of different length but their common indexes have the same values,\n * the shorter array is considered less than the longer one.\n *\n * This logic is similar to how eg. tuples are compared in Python.\n */\nfunction compareArrays(\n  a: Array<number | string>,\n  b: Array<number | string>\n): number {\n  for (let i = 0; i < Math.min(a.length, b.length); i++) {\n    if (a[i] === b[i]) {\n      continue;\n    } else if (typeof a[i] !== typeof b[i]) {\n      // The result of comparing a number with a string is undefined if the\n      // string cannot be coerced to a number. To simplify things, we just\n      // decide that numbers sort before strings.\n      return typeof a[i] === 'number' ? -1 : 1;\n    } else if (a[i] < b[i]) {\n      return -1;\n    } else if (a[i] > b[i]) {\n      return 1;\n    }\n  }\n  return a.length - b.length;\n}\n\n/**\n * Strip assertions from a Canonical Fragment Identifier.\n *\n * Assertions are `[...]` enclosed sections which act as checks on the validity\n * of numbers but do not affect the sort order.\n *\n * @example\n *   stripCFIAssertions(\"/6/14[chap05ref]\") // returns \"/6/14\"\n */\nexport function stripCFIAssertions(cfi: string): string {\n  // Fast path for CFIs with no assertions.\n  if (!cfi.includes('[')) {\n    return cfi;\n  }\n\n  let result = '';\n\n  // Has next char been escaped?\n  let escaped = false;\n\n  // Are we in a `[...]` assertion section?\n  let inAssertion = false;\n\n  for (const ch of cfi) {\n    if (!escaped && ch === '^') {\n      escaped = true;\n      continue;\n    }\n\n    if (!escaped && ch === '[') {\n      inAssertion = true;\n    } else if (!escaped && inAssertion && ch === ']') {\n      inAssertion = false;\n    } else if (!inAssertion) {\n      result += ch;\n    }\n\n    escaped = false;\n  }\n\n  return result;\n}\n\n/**\n * Compare two Canonical Fragment Identifiers.\n *\n * The full sorting rules for CFIs are specified by https://idpf.org/epub/linking/cfi/#sec-sorting.\n *\n * This function currently only implements what is necessary to compare simple\n * CFIs that specify a location within an EPUB's Package Document, without any step\n * indirections (\"!\"). These CFIs consist of a \"/\"-delimited sequence of numbers,\n * with optional assertions in `[...]` brackets (eg. \"/2/4[chapter2ref]\").\n *\n * Per the sorting rules linked above, the input CFIs are assumed to be\n * unescaped. This means that they may contain circumflex (^) escape characters,\n * but don't have the additional escaping that is needed when CFIs are used\n * inside URIs or HTML.\n *\n * @example\n *   compareCFIs(\"/2/3[chap3ref]\", \"/2/10[chap10ref]\") // returns -1\n *\n * @param a - The first CFI\n * @param b - The second CFI\n * @return A value that is negative, zero or positive depending on\n *   whether `a` is less-than, equal-to or greater-than `b`\n */\nexport function compareCFIs(a: string, b: string): number {\n  const parseCFI = (cfi: string) => {\n    return stripCFIAssertions(cfi)\n      .split('/')\n      .map(str => {\n        // CFI step values _should_ always be integers. We currently handle\n        // invalid values by using a string comparison instead. We could\n        // alternatively treat all invalid CFIs as equal.\n        const intVal = parseInt(str, 10);\n        return Number.isNaN(intVal) ? str : intVal;\n      });\n  };\n  return compareArrays(parseCFI(a), parseCFI(b));\n}\n\n/**\n * Return a slice of `cfi` up to the first step indirection [1], with assertions\n * removed.\n *\n * A typical CFI consists of a path within the table of contents to indicate\n * a content document, a step indirection (\"!\"), then the path of an element\n * within the content document. For such a CFI, this function will retain only\n * the content document path.\n *\n * [1] https://idpf.org/epub/linking/cfi/#sec-path-indirection\n *\n * @example\n *   documentCFI('/6/152[;vnd.vst.idref=ch13_01]!/4/2[ch13_sec_1]') // Returns \"/6/152\"\n */\nexport function documentCFI(cfi: string): string {\n  const stripped = stripCFIAssertions(cfi);\n  const sepIndex = stripped.indexOf('!');\n  return sepIndex === -1 ? stripped : stripped.slice(0, sepIndex);\n}\n","import debounce from 'lodash.debounce';\n\nexport const DEBOUNCE_WAIT = 40;\n\ntype FrameCallback = (frame: HTMLIFrameElement) => void;\n\n/**\n * FrameObserver detects iframes added and deleted from the document.\n *\n * To enable annotation, an iframe must be opted-in by adding the\n * `enable-annotation` attribute.\n *\n * We require the `enable-annotation` attribute to avoid the overhead of loading\n * the client into frames which are not useful to annotate. See\n * https://github.com/hypothesis/client/issues/530\n */\nexport class FrameObserver {\n  private _element: Element;\n  private _onFrameAdded: FrameCallback;\n  private _onFrameRemoved: FrameCallback;\n  private _annotatableFrames: Set<HTMLIFrameElement>;\n  private _isDisconnected: boolean;\n  private _mutationObserver: MutationObserver;\n\n  /**\n   * @param element - root of the DOM subtree to watch for the addition and\n   *   removal of annotatable iframes\n   * @param onFrameAdded - callback fired when an annotatable iframe is added\n   * @param onFrameRemoved - callback triggered when the annotatable iframe is removed\n   */\n  constructor(\n    element: Element,\n    onFrameAdded: FrameCallback,\n    onFrameRemoved: FrameCallback\n  ) {\n    this._element = element;\n    this._onFrameAdded = onFrameAdded;\n    this._onFrameRemoved = onFrameRemoved;\n    this._annotatableFrames = new Set<HTMLIFrameElement>();\n    this._isDisconnected = false;\n\n    this._mutationObserver = new MutationObserver(\n      debounce(() => {\n        this._discoverFrames();\n      }, DEBOUNCE_WAIT)\n    );\n    this._discoverFrames();\n    this._mutationObserver.observe(this._element, {\n      childList: true,\n      subtree: true,\n      attributeFilter: ['enable-annotation'],\n    });\n  }\n\n  disconnect() {\n    this._isDisconnected = true;\n    this._mutationObserver.disconnect();\n  }\n\n  private async _addFrame(frame: HTMLIFrameElement) {\n    this._annotatableFrames.add(frame);\n    try {\n      await onNextDocumentReady(frame);\n      if (this._isDisconnected) {\n        return;\n      }\n      const frameWindow = frame.contentWindow;\n      // This line raises an exception if the iframe is from a different origin\n      frameWindow!.addEventListener('unload', () => {\n        this._removeFrame(frame);\n      });\n      this._onFrameAdded(frame);\n    } catch (e) {\n      console.warn(\n        `Unable to inject the Hypothesis client (from '${document.location.href}' into a cross-origin frame '${frame.src}')`\n      );\n    }\n  }\n\n  private _removeFrame(frame: HTMLIFrameElement) {\n    this._annotatableFrames.delete(frame);\n    this._onFrameRemoved(frame);\n  }\n\n  private _discoverFrames() {\n    const frames = new Set<HTMLIFrameElement>(\n      this._element.querySelectorAll('iframe[enable-annotation]')\n    );\n\n    for (const frame of frames) {\n      if (!this._annotatableFrames.has(frame)) {\n        this._addFrame(frame);\n      }\n    }\n\n    for (const frame of this._annotatableFrames) {\n      if (!frames.has(frame)) {\n        this._removeFrame(frame);\n      }\n    }\n  }\n}\n\n/**\n * Test if this is the empty document that a new iframe has before the URL\n * specified by its `src` attribute loads.\n */\nfunction hasBlankDocumentThatWillNavigate(frame: HTMLIFrameElement): boolean {\n  return (\n    frame.contentDocument?.location.href === 'about:blank' &&\n    // Do we expect the frame to navigate away from about:blank?\n    frame.hasAttribute('src') &&\n    frame.src !== 'about:blank'\n  );\n}\n\n/**\n * Wrapper around {@link onDocumentReady} which returns a promise that resolves\n * the first time that a document in `frame` becomes ready.\n *\n * See {@link onDocumentReady} for the definition of _ready_.\n */\nexport function onNextDocumentReady(\n  frame: HTMLIFrameElement\n): Promise<Document> {\n  return new Promise((resolve, reject) => {\n    const unsubscribe = onDocumentReady(frame, (err, doc) => {\n      unsubscribe();\n      if (doc) {\n        resolve(doc);\n      } else {\n        reject(err);\n      }\n    });\n  });\n}\n\n/**\n * Register a callback that is invoked when the content document\n * (`frame.contentDocument`) in a same-origin iframe becomes _ready_.\n *\n * A document is _ready_ when its `readyState` is either \"interactive\" or\n * \"complete\". It must also not be the empty document with URL \"about:blank\"\n * that iframes have before they navigate to the URL specified by their \"src\"\n * attribute.\n *\n * The callback is fired both for the document that is in the frame when\n * `onDocumentReady` is called, as well as for new documents that are\n * subsequently loaded into the same frame.\n *\n * If at any time the frame navigates to an iframe that is cross-origin,\n * the callback will fire with an error. It will fire again for subsequent\n * navigations, but due to platform limitations, it will only fire after the\n * next document fully loads (ie. when the frame's `load` event fires).\n *\n * @return Callback that unsubscribes from future changes\n */\nexport function onDocumentReady(\n  frame: HTMLIFrameElement,\n  callback: (err: Error | null, document?: Document) => void,\n  { pollInterval = 10 }: { pollInterval?: number } = {}\n): () => void {\n  let pollTimer: number | undefined;\n  // Two linting rules are conflicting here, so muting one of them.\n  // This should be fixable by refactoring the whole function, as there are\n  // crossed dependencies between local callbacks, that rely on each other\n  // having been called in a specific order.\n  // eslint-disable-next-line prefer-const\n  let pollForDocumentChange: () => void;\n\n  // Visited documents for which we have fired the callback or are waiting\n  // to become ready.\n  const documents = new WeakSet();\n\n  const cancelPoll = () => {\n    clearTimeout(pollTimer);\n    pollTimer = undefined;\n  };\n\n  // Begin polling for a document change when the current document is about\n  // to go away.\n  const pollOnUnload = () => {\n    if (frame.contentDocument) {\n      frame.contentWindow?.addEventListener('unload', pollForDocumentChange);\n    }\n  };\n\n  const checkForDocumentChange = () => {\n    const currentDocument = frame.contentDocument;\n\n    // `contentDocument` may be null if the frame navigated to a URL that is\n    // cross-origin, or if the `<iframe>` was removed from the document.\n    if (!currentDocument) {\n      cancelPoll();\n      const errorMessage = frame.isConnected\n        ? 'Frame is cross-origin'\n        : 'Frame is disconnected';\n      callback(new Error(errorMessage));\n      return;\n    }\n\n    if (documents.has(currentDocument)) {\n      return;\n    }\n    documents.add(currentDocument);\n    cancelPoll();\n\n    if (!hasBlankDocumentThatWillNavigate(frame)) {\n      const isReady =\n        currentDocument.readyState === 'interactive' ||\n        currentDocument.readyState === 'complete';\n\n      if (isReady) {\n        callback(null, currentDocument);\n      } else {\n        currentDocument.addEventListener('DOMContentLoaded', () =>\n          callback(null, currentDocument)\n        );\n      }\n    }\n\n    // Poll for the next document change.\n    pollOnUnload();\n  };\n\n  let canceled = false;\n  pollForDocumentChange = () => {\n    cancelPoll();\n    if (!canceled) {\n      pollTimer = setInterval(checkForDocumentChange, pollInterval);\n    }\n  };\n\n  // Set up observers for signals that the document either has changed or will\n  // soon change. There are two signals with different trade-offs:\n  //\n  //  - Polling after the current document is about to be unloaded. This allows\n  //    us to detect the new document quickly, but may not fire in some\n  //    situations (exact circumstances unclear, but eg. MDN warns about this).\n  //\n  //    This is set up in the first call to `checkForDocumentChange`.\n  //\n  //  - The iframe's \"load\" event. This is guaranteed to fire but only after the\n  //    new document is fully loaded.\n  frame.addEventListener('load', checkForDocumentChange);\n\n  // Notify caller about the current document. This fires asynchronously so that\n  // the caller will have received the unsubscribe callback first.\n  const initialCheckTimer = setTimeout(checkForDocumentChange, 0);\n\n  return () => {\n    canceled = true;\n    clearTimeout(initialCheckTimer);\n    cancelPoll();\n    frame.removeEventListener('load', checkForDocumentChange);\n  };\n}\n","import { parseJsonConfig } from '../boot/parse-json-config';\nimport { generateHexString } from '../shared/random';\nimport type { Destroyable } from '../types/annotator';\nimport { onNextDocumentReady, FrameObserver } from './frame-observer';\n\n/**\n * Options for injecting the client into child frames.\n *\n * This includes the URL of the client's boot script, plus configuration\n * for the client when it loads in the child frame.\n */\nexport type InjectConfig = { clientUrl: string } & Record<string, unknown>;\n\n/**\n * HypothesisInjector injects the Hypothesis client into same-origin iframes.\n *\n * The client will be injected automatically into frames that have the\n * `enable-annotation` attribute set (see {@link FrameObserver}) and can be\n * manually injected into other frames using {@link injectClient}.\n */\nexport class HypothesisInjector implements Destroyable {\n  private _config: InjectConfig;\n  private _frameObserver: FrameObserver;\n\n  /**\n   * @param element - root of the DOM subtree to watch for the addition and\n   *   removal of annotatable iframes\n   */\n  constructor(element: Element, config: InjectConfig) {\n    this._config = config;\n    this._frameObserver = new FrameObserver(\n      element,\n      frame => injectClient(frame, config), // Frame added callback\n      () => {} // Frame removed callback\n    );\n  }\n\n  /**\n   * Disables the injection of the Hypothesis client into child iframes.\n   */\n  destroy() {\n    this._frameObserver.disconnect();\n  }\n}\n\n/**\n * Check if the client was added to a frame by {@link injectClient}.\n */\nfunction hasHypothesis(iframe: HTMLIFrameElement) {\n  const iframeDocument = iframe.contentDocument!;\n  return iframeDocument.querySelector('script.js-hypothesis-config') !== null;\n}\n\n/**\n * Remove the temporary client configuration added to a document by\n * {@link injectClient} or {@link HypothesisInjector}.\n */\nexport function removeTemporaryClientConfig(document_: Document = document) {\n  const tempConfigEls = Array.from(\n    document_.querySelectorAll(\n      'script.js-hypothesis-config[data-remove-on-unload]'\n    )\n  );\n  tempConfigEls.forEach(el => el.remove());\n}\n\n/**\n * Inject Hypothesis client into a frame.\n *\n * IMPORTANT: This method requires that the iframe is same-origin\n * (frame.contentDocument|contentWindow is not null).\n *\n * This waits for the frame to finish loading before injecting the client.\n * See {@link onDocumentReady}.\n *\n * This function does nothing if the client has already been added to the frame.\n * This is determined by the presence of temporary configuration `<script>`s\n * added by this function, which can be removed with {@link removeTemporaryClientConfig}.\n *\n * @param frameId - The ID for the guest frame. If none is provided, the guest\n *   will use a new randomly-generated ID.\n */\nexport async function injectClient(\n  frame: HTMLIFrameElement,\n  config: InjectConfig,\n  frameId?: string\n) {\n  if (hasHypothesis(frame)) {\n    return;\n  }\n\n  await onNextDocumentReady(frame);\n\n  // Propagate the client resource locations from the current frame.\n  //\n  // These settings are set only in the browser extension and not by the\n  // embedded client (served by h).\n  //\n  // We could potentially do this by allowing these settings to be part of\n  // the \"annotator\" config (see `annotator/config/index.js`) which gets passed\n  // to the constructor.\n  const { assetRoot, notebookAppUrl, profileAppUrl, sidebarAppUrl } =\n    parseJsonConfig(document);\n\n  const injectedConfig = {\n    ...config,\n\n    assetRoot,\n\n    // FIXME - We propagate these settings because the boot script expects them,\n    // but they shouldn't actually be needed when launching the client in a\n    // frame as a guest only (ie. no sidebar). A caveat is that the\n    // `<link>` element generated using the `sidebarAppUrl` value does also get\n    // used for other purposes by the annotator entry point.\n    notebookAppUrl,\n    profileAppUrl,\n    sidebarAppUrl,\n\n    // Tell the client that it should load as a guest only (no sidebar).\n    subFrameIdentifier: frameId ?? generateHexString(10),\n  };\n\n  const configElement = document.createElement('script');\n  configElement.className = 'js-hypothesis-config';\n  configElement.setAttribute('data-remove-on-unload', '');\n  configElement.type = 'application/json';\n  configElement.innerText = JSON.stringify(injectedConfig);\n\n  const bootScript = document.createElement('script');\n  bootScript.async = true;\n  bootScript.src = config.clientUrl;\n\n  const iframeDocument = frame.contentDocument!;\n  iframeDocument.body.appendChild(configElement);\n  iframeDocument.body.appendChild(bootScript);\n}\n","import debounce from 'lodash.debounce';\nimport type { DebouncedFunction } from 'lodash.debounce';\n\nimport { ListenerCollection } from '../../shared/listener-collection';\nimport {\n  rectCenter,\n  rectsOverlapHorizontally,\n  rectsOverlapVertically,\n  unionRects,\n} from '../util/geometry';\n\ntype WordBox = {\n  text: string;\n\n  /** Bounding rect of all glyphs in word. */\n  rect: DOMRect;\n};\n\ntype LineBox = {\n  words: WordBox[];\n  /** Bounding rect of all words in line. */\n  rect: DOMRect;\n};\n\ntype ColumnBox = {\n  lines: LineBox[];\n  /** Bounding rect of all lines in column. */\n  rect: DOMRect;\n};\n\n/**\n * Group characters in a page into words, lines and columns.\n *\n * The input is assumed to be _roughly_ reading order, more so at the low (word,\n * line) level. When the input is not in reading order, the output may be\n * divided into more lines / columns than expected. Downstream code is expected\n * to tolerate over-segmentation. This function should try to avoid producing\n * lines or columns that significantly intersect, as this can impair text\n * selection.\n *\n * @param charBoxes - Bounding rectangle associated with each character on the page\n * @param text - Text that corresponds to `charBoxes`\n */\nfunction analyzeLayout(charBoxes: DOMRect[], text: string): ColumnBox[] {\n  const words = [] as WordBox[];\n\n  let currentWord = { text: '', rect: new DOMRect() } as WordBox;\n\n  // Group characters into words.\n  const addWord = () => {\n    if (currentWord.text.length > 0) {\n      words.push(currentWord);\n      currentWord = { text: '', rect: new DOMRect() };\n    }\n  };\n  for (const [i, rect] of charBoxes.entries()) {\n    const char = text[i];\n    const isSpace = /\\s/.test(char);\n\n    if (\n      currentWord.text.length > 0 &&\n      !rectsOverlapVertically(currentWord.rect, rect)\n    ) {\n      addWord();\n    }\n\n    currentWord.rect = unionRects(currentWord.rect, rect);\n\n    // To simplify downstream logic, normalize whitespace.\n    currentWord.text += isSpace ? ' ' : char;\n\n    if (isSpace) {\n      addWord();\n    }\n  }\n  addWord();\n\n  const lines = [] as LineBox[];\n\n  let currentLine = { words: [], rect: new DOMRect() } as LineBox;\n\n  // Group words into lines.\n  const addLine = () => {\n    if (currentLine.words.length > 0) {\n      lines.push(currentLine);\n      currentLine = { words: [], rect: new DOMRect() };\n    }\n  };\n  for (const word of words) {\n    const prevWord = currentLine.words[currentLine.words.length - 1];\n    if (prevWord) {\n      const prevCenter = rectCenter(prevWord.rect);\n      const currentCenter = rectCenter(word.rect);\n      const xDist = currentCenter.x - prevCenter.x;\n      if (\n        !rectsOverlapVertically(prevWord.rect, word.rect) ||\n        // Break line if current word is left of previous word\n        xDist < 0\n      ) {\n        addLine();\n      }\n    }\n    currentLine.words.push(word);\n    currentLine.rect = unionRects(currentLine.rect, word.rect);\n  }\n  addLine();\n\n  const columns = [] as ColumnBox[];\n\n  let currentColumn = { lines: [], rect: new DOMRect() } as ColumnBox;\n\n  // Group lines into columns.\n  const addColumn = () => {\n    if (currentColumn.lines.length > 0) {\n      columns.push(currentColumn);\n      currentColumn = { lines: [], rect: new DOMRect() };\n    }\n  };\n  for (const line of lines) {\n    const prevLine = currentColumn.lines[currentColumn.lines.length - 1];\n\n    if (prevLine) {\n      const prevCenter = rectCenter(prevLine.rect);\n      const currentCenter = rectCenter(line.rect);\n      const yDist = currentCenter.y - prevCenter.y;\n\n      if (\n        !rectsOverlapHorizontally(prevLine.rect, line.rect) ||\n        rectsOverlapVertically(prevLine.rect, line.rect) ||\n        // Break column if current line is above previous line.\n        //\n        // In the case of a two column layout for example, this happens when\n        // moving from the bottom of one column to the top of the next.\n        yDist < 0 ||\n        // Break column if there is a large gap between the previous and current lines.\n        //\n        // This helps to avoid generating intersecting columns if there happens\n        // to be other content between the lines that comes later in the input.\n        yDist > line.rect.height * 4\n      ) {\n        addColumn();\n      }\n    }\n    currentColumn.lines.push(line);\n    currentColumn.rect = unionRects(currentColumn.rect, line.rect);\n  }\n  addColumn();\n\n  return columns;\n}\n\n/**\n * ImageTextLayer maintains a transparent text layer on top of an image\n * which contains text. This enables the text in the image to be selected\n * and highlighted.\n *\n * This is similar to the one that PDF.js creates for us in our standard PDF\n * viewer.\n */\nexport class ImageTextLayer {\n  container: HTMLElement;\n\n  private _imageSizeObserver?: ResizeObserver;\n  private _listeners: ListenerCollection;\n  private _updateTextLayerSize: DebouncedFunction<[]>;\n\n  /**\n   * Create a text layer which is displayed on top of `image`.\n   *\n   * @param image - Rendered image on which to overlay the text layer.\n   *   The text layer will be inserted into the DOM as the next sibling of `image`.\n   * @param charBoxes - Bounding boxes for characters in the image.\n   *   Coordinates should be in the range [0-1], where 0 is the top/left corner\n   *   of the image and 1 is the bottom/right.\n   * @param text - Characters in the image corresponding to `charBoxes`\n   */\n  constructor(image: Element, charBoxes: DOMRect[], text: string) {\n    if (charBoxes.length !== text.length) {\n      throw new Error('Char boxes length does not match text length');\n    }\n\n    // Create container for text layer and position it above the image.\n    const containerParent = image.parentNode as HTMLElement;\n    const container = document.createElement('hypothesis-text-layer');\n    containerParent.insertBefore(container, image.nextSibling);\n\n    // Position text layer over image. We assume the image's top-left corner\n    // aligns with the top-left corner of its container.\n    containerParent.style.position = 'relative';\n    container.style.position = 'absolute';\n    container.style.top = '0';\n    container.style.left = '0';\n    container.style.color = 'transparent';\n\n    // Prevent inherited text alignment from affecting positioning.\n    // VitalSource sets `text-align: center` for example.\n    container.style.textAlign = 'left';\n\n    // Use multiply blending to make text in the image more readable when\n    // the corresponding text in the text layer is selected or highlighted.\n    // We apply a similar effect in PDF.js.\n    container.style.mixBlendMode = 'multiply';\n\n    // Set a fixed font style on the container and create a canvas using the same\n    // font which we can use to measure the \"natural\" size of the text. This is\n    // later used when scaling the text to fit the underlying part of the image.\n    const fontSize = 16;\n    const fontFamily = 'sans-serif';\n    container.style.fontSize = fontSize + 'px';\n    container.style.fontFamily = fontFamily;\n    const canvas = document.createElement('canvas');\n    const context = canvas.getContext('2d') as CanvasRenderingContext2D;\n    context.font = `${fontSize}px ${fontFamily}`;\n\n    /** Generate a CSS value that scales with the `--x-scale` or `--y-scale` CSS variables. */\n    const scaledValue = (\n      dimension: 'x' | 'y',\n      value: number,\n      unit = 'px' as string\n    ) => `calc(var(--${dimension}-scale) * ${value}${unit})`;\n\n    // Group characters into words, lines and columns. Then use the result to\n    // create a hierarchical DOM structure in the text layer:\n    //\n    // 1. Columns are positioned absolutely\n    // 2. Columns stack lines vertically using a block layout\n    // 3. Lines arrange words horizontally using an inline layout\n    //\n    // This allows the browser to select the expected text when the cursor is\n    // in-between lines or words.\n    const columns = analyzeLayout(charBoxes, text);\n\n    for (const column of columns) {\n      const columnEl = document.createElement('hypothesis-text-column');\n      columnEl.style.display = 'block';\n      columnEl.style.position = 'absolute';\n      columnEl.style.left = scaledValue('x', column.rect.left);\n      columnEl.style.top = scaledValue('y', column.rect.top);\n\n      let prevLine = null;\n      for (const line of column.lines) {\n        const lineEl = document.createElement('hypothesis-text-line');\n        lineEl.style.display = 'block';\n        lineEl.style.marginLeft = scaledValue(\n          'x',\n          line.rect.left - column.rect.left\n        );\n        lineEl.style.height = scaledValue('y', line.rect.height);\n\n        if (prevLine) {\n          lineEl.style.marginTop = scaledValue(\n            'y',\n            line.rect.top - prevLine.rect.bottom\n          );\n        }\n        prevLine = line;\n\n        // Prevent line breaks if the word elements don't quite fit the line.\n        lineEl.style.whiteSpace = 'nowrap';\n\n        let prevWord = null;\n        for (const word of line.words) {\n          const wordEl = document.createElement('hypothesis-text-word');\n          wordEl.style.display = 'inline-block';\n          wordEl.style.transformOrigin = 'top left';\n          wordEl.textContent = word.text;\n\n          if (prevWord) {\n            wordEl.style.marginLeft = scaledValue(\n              'x',\n              word.rect.left - prevWord.rect.right\n            );\n          }\n          prevWord = word;\n\n          // Set the size of this box used for layout. This does not affect the\n          // rendered size of the content.\n          wordEl.style.width = scaledValue('x', word.rect.width);\n          wordEl.style.height = scaledValue('y', word.rect.height);\n\n          // Don't collapse whitespace at end of words, so it remains visible\n          // in selected text. Also prevent line breaks due to overflows.\n          wordEl.style.whiteSpace = 'pre';\n\n          // Scale content using a transform. This affects the rendered size\n          // of the text, used by text selection and\n          // `Element.getBoundingClientRect`, but not layout.\n          const metrics = context.measureText(word.text);\n          const xScale = scaledValue('x', word.rect.width / metrics.width, '');\n          const yScale = scaledValue('y', word.rect.height / fontSize, '');\n          wordEl.style.transform = `scale(${xScale}, ${yScale})`;\n\n          lineEl.append(wordEl);\n        }\n\n        columnEl.append(lineEl);\n      }\n\n      container.append(columnEl);\n    }\n\n    const updateTextLayerSize = () => {\n      const { width: imageWidth, height: imageHeight } =\n        image.getBoundingClientRect();\n      container.style.width = imageWidth + 'px';\n      container.style.height = imageHeight + 'px';\n\n      container.style.setProperty('--x-scale', `${imageWidth}`);\n      container.style.setProperty('--y-scale', `${imageHeight}`);\n    };\n\n    updateTextLayerSize();\n\n    /**\n     * Container element for the text layer.\n     *\n     * This is exposed so that callers can tweak the style if needed (eg.\n     * to set a z-index value).\n     */\n    this.container = container;\n\n    this._updateTextLayerSize = debounce(updateTextLayerSize, { maxWait: 50 });\n    this._listeners = new ListenerCollection();\n\n    if (typeof ResizeObserver !== 'undefined') {\n      this._imageSizeObserver = new ResizeObserver(() => {\n        this._updateTextLayerSize();\n      });\n      this._imageSizeObserver.observe(image);\n    }\n\n    // Fallback for browsers that don't support ResizeObserver (Safari < 13.4).\n    // Due to the debouncing, we can register this listener in all browsers for\n    // simplicity, without downsides.\n    this._listeners.add(window, 'resize', this._updateTextLayerSize);\n  }\n\n  /**\n   * Synchronously update the text layer to match the size and position of\n   * the image.\n   *\n   * Normally the text layer is resized automatically but asynchronously when\n   * the image size changes (eg. due to the window being resized) and updates\n   * are debounced. This method can be used to force an immediate update if\n   * needed.\n   */\n  updateSync() {\n    this._updateTextLayerSize();\n    this._updateTextLayerSize.flush();\n  }\n\n  destroy() {\n    this.container.remove();\n    this._listeners.removeAll();\n    this._updateTextLayerSize.cancel();\n    this._imageSizeObserver?.disconnect();\n  }\n}\n","import { TinyEmitter } from 'tiny-emitter';\n\nimport { documentCFI } from '../../shared/cfi';\nimport { ListenerCollection } from '../../shared/listener-collection';\nimport type {\n  Anchor,\n  AnnotationData,\n  Integration,\n  SegmentInfo,\n  SidebarLayout,\n} from '../../types/annotator';\nimport type { EPUBContentSelector, Selector } from '../../types/api';\nimport type {\n  ContentFrameGlobals,\n  MosaicBookElement,\n} from '../../types/vitalsource';\nimport { FeatureFlags } from '../features';\nimport { onDocumentReady } from '../frame-observer';\nimport { injectClient } from '../hypothesis-injector';\nimport type { InjectConfig } from '../hypothesis-injector';\nimport { HTMLIntegration } from './html';\nimport { preserveScrollPosition } from './html-side-by-side';\nimport { ImageTextLayer } from './image-text-layer';\n\n// When activating side-by-side mode for VitalSource PDF documents, make sure\n// at least this much space (in pixels) is left for the PDF document. Any\n// smaller and it feels unreadable or too-zoomed-out\nconst MIN_CONTENT_WIDTH = 480;\n\n/**\n * Return the custom DOM element that contains the book content iframe.\n */\nfunction findBookElement(document_ = document): MosaicBookElement | null {\n  return document_.querySelector('mosaic-book') as MosaicBookElement | null;\n}\n\n/**\n * Return the role of the current frame in the VitalSource Bookshelf reader or\n * `null` if the frame is not part of Bookshelf.\n *\n * @return `container` if this is the parent of the content frame, `content` if\n *   this is the frame that contains the book content or `null` if the document is\n *   not part of the Bookshelf reader.\n */\nexport function vitalSourceFrameRole(\n  window_ = window\n): 'container' | 'content' | null {\n  if (findBookElement(window_.document)) {\n    return 'container';\n  }\n\n  const parentDoc = window_.frameElement?.ownerDocument;\n  if (parentDoc && findBookElement(parentDoc)) {\n    return 'content';\n  }\n\n  return null;\n}\n\n/**\n * VitalSourceInjector runs in the book container frame and loads the client into\n * book content frames.\n *\n * The frame structure of the VitalSource book reader looks like this:\n *\n * [VitalSource top frame - bookshelf.vitalsource.com]\n *   |\n *   [Book container frame - jigsaw.vitalsource.com]\n *     |\n *     [Book content frame - jigsaw.vitalsource.com]\n *\n * The Hypothesis client can be initially loaded in the container frame or the\n * content frame. As the user navigates around the book, the container frame\n * remains the same but the content frame is swapped out. When used in the\n * container frame, this class handles initial injection of the client as a\n * guest in the current content frame, and re-injecting the client into new\n * content frames when they are created.\n */\nexport class VitalSourceInjector {\n  private _frameObserver: MutationObserver;\n\n  /**\n   * @param config - Configuration for injecting the client into\n   *   book content frames\n   */\n  constructor(config: InjectConfig) {\n    const bookElement = findBookElement();\n    if (!bookElement) {\n      throw new Error('Book container element not found');\n    }\n\n    const contentFrames = new WeakSet<HTMLIFrameElement>();\n\n    const shadowRoot = bookElement.shadowRoot!;\n    const injectClientIntoContentFrame = () => {\n      const frame = shadowRoot.querySelector('iframe');\n      if (!frame || contentFrames.has(frame)) {\n        // Either there is no content frame or we are already watching it.\n        return;\n      }\n      contentFrames.add(frame);\n      onDocumentReady(frame, (err, document_) => {\n        if (err) {\n          return;\n        }\n\n        // If `err` is null, then `document_` will be set.\n        const body = document_!.body;\n\n        const isBookContent =\n          body &&\n          // Check that this is not the temporary page containing encrypted and\n          // invisible book content, which is replaced with the real content after\n          // a form submission. These pages look something like:\n          //\n          // ```\n          // <html>\n          //   <title>content</title>\n          //   <body><div id=\"page-content\">{ Base64 encoded data }</div></body>\n          // </html>\n          // ```\n          !body.querySelector('#page-content');\n\n        if (isBookContent) {\n          injectClient(frame, config, 'vitalsource-content');\n        }\n      });\n    };\n\n    injectClientIntoContentFrame();\n\n    // Re-inject client into content frame after a chapter navigation.\n    this._frameObserver = new MutationObserver(injectClientIntoContentFrame);\n    this._frameObserver.observe(shadowRoot, { childList: true, subtree: true });\n  }\n\n  destroy() {\n    this._frameObserver.disconnect();\n  }\n}\n\nfunction getPDFPageImage() {\n  return document.querySelector('img#pbk-page') as HTMLImageElement | null;\n}\n\n/**\n * Fix how a VitalSource book content frame scrolls, so that various related\n * Hypothesis behaviors (the bucket bar, scrolling annotations into view) work\n * as intended.\n *\n * Some VitalSource books (PDFs) make content scrolling work by making the\n * content iframe really tall and having the parent frame scroll. This stops the\n * Hypothesis bucket bar and scrolling annotations into view from working.\n */\nfunction makeContentFrameScrollable(frame: HTMLIFrameElement) {\n  if (frame.getAttribute('scrolling') !== 'no') {\n    // This is a book (eg. EPUB) where the workaround is not required.\n    return;\n  }\n\n  // Override inline styles of iframe (hence `!important`). The iframe lives\n  // in Shadow DOM, so the element styles won't affect the rest of the app.\n  const style = document.createElement('style');\n  style.textContent = `iframe { height: 100% !important; }`;\n  frame.insertAdjacentElement('beforebegin', style);\n\n  const removeScrollingAttr = () => frame.removeAttribute('scrolling');\n  removeScrollingAttr();\n\n  // Sometimes the attribute gets re-added by VS. Remove it if that\n  // happens.\n  const attrObserver = new MutationObserver(removeScrollingAttr);\n  attrObserver.observe(frame, { attributes: true });\n}\n\n/**\n * Return a copy of URL with the origin removed.\n *\n * eg. \"https://jigsaw.vitalsource.com/books/123/chapter.html?foo\" =>\n * \"/books/123/chapter.html\"\n */\nfunction stripOrigin(url: string) {\n  // Resolve input URL in case it doesn't already have an origin.\n  const parsed = new URL(url, document.baseURI);\n  return parsed.pathname + parsed.search;\n}\n\n/**\n * Integration for the content frame in VitalSource's Bookshelf ebook reader.\n *\n * This integration delegates to the standard HTML integration for most\n * functionality, but it adds logic to:\n *\n *  - Customize the document URI and metadata that is associated with annotations\n *  - Prevent VitalSource's built-in selection menu from getting in the way\n *    of the adder.\n *  - Create a hidden text layer in PDF-based books, so the user can select text\n *    in the PDF image. This is similar to what PDF.js does for us in PDFs.\n */\nexport class VitalSourceContentIntegration\n  extends TinyEmitter\n  implements Integration\n{\n  private _bookElement: MosaicBookElement;\n  private _htmlIntegration: HTMLIntegration;\n  private _listeners: ListenerCollection;\n  private _textLayer?: ImageTextLayer;\n\n  constructor(\n    /* istanbul ignore next - defaults are overridden in tests */\n    container: HTMLElement = document.body,\n    /* istanbul ignore next - defaults are overridden in tests */\n    options: {\n      // Test seam\n      bookElement?: MosaicBookElement;\n    } = {}\n  ) {\n    super();\n\n    const bookElement =\n      options.bookElement ?? findBookElement(window.parent.document);\n    if (!bookElement) {\n      /* istanbul ignore next */\n      throw new Error(\n        'Failed to find <mosaic-book> element in container frame'\n      );\n    }\n    this._bookElement = bookElement;\n\n    const htmlFeatures = new FeatureFlags();\n\n    // Forcibly enable the side-by-side feature for VS books. This feature is\n    // only behind a flag for regular web pages, which are typically more\n    // complex and varied than EPUB books.\n    htmlFeatures.update({ html_side_by_side: true });\n\n    this._htmlIntegration = new HTMLIntegration({\n      container,\n      features: htmlFeatures,\n    });\n\n    this._listeners = new ListenerCollection();\n\n    // Prevent mouse events from reaching the window. This prevents VitalSource\n    // from showing its native selection menu, which obscures the client's\n    // annotation toolbar.\n    //\n    // To avoid interfering with the client's own selection handling, this\n    // event blocking must happen at the same level or higher in the DOM tree\n    // than where SelectionObserver listens.\n    const stopEvents = ['mouseup', 'mousedown', 'mouseout'];\n    for (const event of stopEvents) {\n      this._listeners.add(document.documentElement, event, e => {\n        e.stopPropagation();\n      });\n    }\n\n    // Install scrolling workaround for PDFs. We do this in the content frame\n    // so that it works whether Hypothesis is loaded directly into the content\n    // frame or injected by VitalSourceInjector from the parent frame.\n    const frame = window.frameElement as HTMLIFrameElement | null;\n    if (frame) {\n      makeContentFrameScrollable(frame);\n    }\n\n    // If this is a PDF, create the hidden text layer above the rendered PDF\n    // image.\n    const bookImage = getPDFPageImage();\n\n    const pageData = (window as ContentFrameGlobals).innerPageData;\n\n    if (bookImage && pageData) {\n      const charRects = pageData.glyphs.glyphs.map(glyph => {\n        const left = glyph.l / 100;\n        const right = glyph.r / 100;\n        const top = glyph.t / 100;\n        const bottom = glyph.b / 100;\n        return new DOMRect(left, top, right - left, bottom - top);\n      });\n\n      this._textLayer = new ImageTextLayer(\n        bookImage,\n        charRects,\n        pageData.words\n      );\n\n      // VitalSource has several DOM elements in the page which are raised\n      // above the image using z-index. One of these is used to handle VS's\n      // own text selection functionality.\n      //\n      // Set a z-index on our text layer to raise it above VS's own one.\n      this._textLayer.container.style.zIndex = '100';\n    }\n  }\n\n  getAnnotatableRange(range: Range) {\n    return this._htmlIntegration.getAnnotatableRange(range);\n  }\n\n  destroy() {\n    this._textLayer?.destroy();\n    this._listeners.removeAll();\n    this._htmlIntegration.destroy();\n  }\n\n  anchor(root: HTMLElement, selectors: Selector[]) {\n    return this._htmlIntegration.anchor(root, selectors);\n  }\n\n  async describe(root: HTMLElement, range: Range) {\n    const selectors: Selector[] = this._htmlIntegration.describe(root, range);\n\n    const {\n      cfi,\n      index: pageIndex,\n      page: pageLabel,\n      title,\n      url,\n    } = await this._getPageInfo(true /* includeTitle */);\n\n    // We generate an \"EPUBContentSelector\" with a CFI for all VS books,\n    // although for PDF-based books the CFI is a string generated from the\n    // page number.\n    const extraSelectors: Selector[] = [\n      {\n        type: 'EPUBContentSelector',\n        cfi,\n        url,\n        title,\n      },\n    ];\n\n    // If this is a PDF-based book, add a page selector. PDFs always have page\n    // numbers available. EPUB-based books _may_ have information about how\n    // content maps to page numbers in a printed edition of the book. We\n    // currently limit page number selectors to PDFs until more is understood\n    // about when EPUB page numbers are reliable/likely to remain stable.\n    const bookInfo = this._bookElement.getBookInfo();\n    if (bookInfo.format === 'pbk' && typeof pageIndex === 'number') {\n      extraSelectors.push({\n        type: 'PageSelector',\n        index: pageIndex,\n        label: pageLabel,\n      });\n    }\n\n    selectors.push(...extraSelectors);\n\n    return selectors;\n  }\n\n  contentContainer() {\n    return this._htmlIntegration.contentContainer();\n  }\n\n  fitSideBySide(layout: SidebarLayout) {\n    // For PDF books, handle side-by-side mode in this integration. For EPUBs,\n    // delegate to the HTML integration.\n    const bookImage = getPDFPageImage();\n    if (bookImage && this._textLayer) {\n      const bookContainer = bookImage.parentElement as HTMLElement;\n      const textLayer = this._textLayer;\n\n      // Update the PDF image size and alignment to fit alongside the sidebar.\n      // `ImageTextLayer` will handle adjusting the text layer to match.\n      const newWidth = window.innerWidth - layout.width;\n\n      preserveScrollPosition(() => {\n        if (layout.expanded && newWidth > MIN_CONTENT_WIDTH) {\n          // The VS book viewer sets `text-align: center` on the <body> element\n          // by default, which centers the book image in the page. When the sidebar\n          // is open we need the image to be left-aligned.\n          bookContainer.style.textAlign = 'left';\n          bookImage.style.width = `${newWidth}px`;\n        } else {\n          bookContainer.style.textAlign = '';\n          bookImage.style.width = '';\n        }\n\n        // Update text layer to match new image dimensions immediately. This\n        // is needed so that `preserveScrollPosition` can see how the content\n        // has shifted when this callback returns.\n        textLayer.updateSync();\n      });\n\n      return layout.expanded;\n    } else {\n      return this._htmlIntegration.fitSideBySide(layout);\n    }\n  }\n\n  async getMetadata() {\n    const bookInfo = this._bookElement.getBookInfo();\n    return {\n      title: bookInfo.title,\n      link: [],\n    };\n  }\n\n  navigateToSegment(ann: AnnotationData) {\n    const selector = ann.target[0].selector?.find(\n      s => s.type === 'EPUBContentSelector'\n    ) as EPUBContentSelector | undefined;\n    if (selector?.cfi) {\n      this._bookElement.goToCfi(selector.cfi);\n    } else if (selector?.url) {\n      this._bookElement.goToURL(stripOrigin(selector.url));\n    } else {\n      throw new Error('No segment information available');\n    }\n  }\n\n  persistFrame() {\n    // Hint to the sidebar that it should not unload annotations when the\n    // guest frame using this integration unloads.\n    return true;\n  }\n\n  /**\n   * Retrieve information about the currently displayed content document or\n   * page.\n   *\n   * @param includeTitle - Whether to fetch the title. This involves some extra\n   *   work so should be skipped when not required.\n   */\n  async _getPageInfo(includeTitle: boolean) {\n    const [pageInfo, toc] = await Promise.all([\n      this._bookElement.getCurrentPage(),\n      includeTitle ? this._bookElement.getTOC() : undefined,\n    ]);\n\n    // If changes in VitalSource ever mean that critical chapter/page metadata\n    // fields are missing, fail loudly. Otherwise we might create annotations\n    // that cannot be re-anchored in future.\n    const requiredFields = ['absoluteURL', 'cfi'];\n    for (const field of requiredFields) {\n      // nb. We intentionally allow properties anywhere on the prototype chain,\n      // rather than requiring `hasOwnProperty`.\n      if (!(field in pageInfo)) {\n        throw new Error(`Page metadata field \"${field}\" is missing`);\n      }\n    }\n\n    let title;\n\n    if (toc) {\n      title = pageInfo.chapterTitle;\n\n      // Find the first table of contents entry that corresponds to the current page,\n      // and use its title instead of `pageInfo.chapterTitle`. This works around\n      // https://github.com/hypothesis/client/issues/4986.\n      const pageCFI = documentCFI(pageInfo.cfi);\n      const tocEntry = toc.data?.find(\n        entry => documentCFI(entry.cfi) === pageCFI\n      );\n      if (tocEntry) {\n        title = tocEntry.title;\n      }\n    }\n\n    return {\n      cfi: pageInfo.cfi,\n      index: pageInfo.index,\n      page: pageInfo.page,\n      title,\n\n      // The `pageInfo.absoluteURL` URL is an absolute path that does not\n      // include the origin of VitalSource's CDN.\n      url: new URL(pageInfo.absoluteURL, document.baseURI).toString(),\n    };\n  }\n\n  async segmentInfo(): Promise<SegmentInfo> {\n    const { cfi, url } = await this._getPageInfo(false /* includeTitle */);\n    return { cfi, url };\n  }\n\n  async uri() {\n    const bookInfo = this._bookElement.getBookInfo();\n    const bookId = bookInfo.isbn;\n    if (!bookId) {\n      throw new Error('Unable to get book ID from VitalSource');\n    }\n    return `https://bookshelf.vitalsource.com/reader/books/${bookId}`;\n  }\n\n  async scrollToAnchor(anchor: Anchor) {\n    return this._htmlIntegration.scrollToAnchor(anchor);\n  }\n}\n","import type { Annotator, Integration } from '../../types/annotator';\nimport { HTMLIntegration } from './html';\nimport { PDFIntegration, isPDF } from './pdf';\nimport {\n  VitalSourceContentIntegration,\n  vitalSourceFrameRole,\n} from './vitalsource';\n\n/**\n * Create the integration that handles document-type specific aspects of\n * guest functionality.\n */\nexport function createIntegration(annotator: Annotator): Integration {\n  if (isPDF()) {\n    return new PDFIntegration(annotator);\n  }\n\n  const vsFrameRole = vitalSourceFrameRole();\n  if (vsFrameRole === 'content') {\n    return new VitalSourceContentIntegration(document.body);\n  }\n\n  return new HTMLIntegration({ features: annotator.features });\n}\n","import { ListenerCollection } from '../shared/listener-collection';\n\n/**\n * Return the current selection or `null` if there is no selection, or it is empty.\n */\nexport function selectedRange(document: Document): Range | null {\n  const selection = document.getSelection();\n  if (!selection || selection.rangeCount === 0) {\n    return null;\n  }\n  const range = selection.getRangeAt(0);\n  if (range.collapsed) {\n    return null;\n  }\n  return range;\n}\n\n/**\n * An observer that watches for and buffers changes to the document's current selection.\n */\nexport class SelectionObserver {\n  /** Tracks the timeout ID of the last scheduled callback */\n  private _pendingCallback: number | null;\n  private _document: Document;\n  private _listeners: ListenerCollection;\n\n  /**\n   * Start observing changes to the current selection in the document.\n   *\n   * @param callback - Callback invoked with the selected region of the document\n   *                   when it has changed.\n   * @param document_ - Test seam\n   */\n  constructor(\n    callback: (range: Range | null) => void,\n    document_: Document = document\n  ) {\n    let isMouseDown = false;\n\n    this._pendingCallback = null;\n\n    const scheduleCallback = (delay = 10) => {\n      this._pendingCallback = setTimeout(() => {\n        callback(selectedRange(document_));\n      }, delay);\n    };\n\n    const eventHandler = (event: Event) => {\n      if (event.type === 'mousedown') {\n        isMouseDown = true;\n      }\n      if (event.type === 'mouseup') {\n        isMouseDown = false;\n      }\n\n      // If the user makes a selection with the mouse, wait until they release\n      // it before reporting a selection change.\n      if (isMouseDown) {\n        return;\n      }\n\n      this._cancelPendingCallback();\n\n      // Schedule a notification after a short delay. The delay serves two\n      // purposes:\n      //\n      // - If this handler was called as a result of a 'mouseup' event then the\n      //   selection will not be updated until the next tick of the event loop.\n      //   In this case we only need a short delay.\n      //\n      // - If the user is changing the selection with a non-mouse input (eg.\n      //   keyboard or selection handles on mobile) this buffers updates and\n      //   makes sure that we only report one when the update has stopped\n      //   changing. In this case we want a longer delay.\n\n      const delay = event.type === 'mouseup' ? 10 : 100;\n      scheduleCallback(delay);\n    };\n\n    this._document = document_;\n    this._listeners = new ListenerCollection();\n\n    this._listeners.add(document_, 'selectionchange', eventHandler);\n\n    // Mouse events are handled on the body because propagation may be stopped\n    // before they reach the document in some environments (eg. VitalSource).\n    this._listeners.add(document_.body, 'mousedown', eventHandler);\n    this._listeners.add(document_.body, 'mouseup', eventHandler);\n\n    // Report the initial selection.\n    scheduleCallback(1);\n  }\n\n  disconnect() {\n    this._listeners.removeAll();\n    this._cancelPendingCallback();\n  }\n\n  private _cancelPendingCallback() {\n    if (this._pendingCallback) {\n      clearTimeout(this._pendingCallback);\n      this._pendingCallback = null;\n    }\n  }\n}\n","import { TinyEmitter } from 'tiny-emitter';\n\nimport { ListenerCollection } from '../shared/listener-collection';\nimport { PortFinder, PortRPC } from '../shared/messaging';\nimport { generateHexString } from '../shared/random';\nimport { matchShortcut } from '../shared/shortcut';\nimport type {\n  AnnotationData,\n  Annotator,\n  Anchor,\n  ContentInfoConfig,\n  Destroyable,\n  DocumentInfo,\n  Integration,\n  SidebarLayout,\n} from '../types/annotator';\nimport type { Target } from '../types/api';\nimport type {\n  HostToGuestEvent,\n  GuestToHostEvent,\n  GuestToSidebarEvent,\n  SidebarToGuestEvent,\n} from '../types/port-rpc-events';\nimport { Adder } from './adder';\nimport { TextRange } from './anchoring/text-range';\nimport { BucketBarClient } from './bucket-bar-client';\nimport { FeatureFlags } from './features';\nimport { HighlightClusterController } from './highlight-clusters';\nimport {\n  getHighlightsContainingNode,\n  highlightRange,\n  removeAllHighlights,\n  removeHighlights,\n  setHighlightsFocused,\n  setHighlightsVisible,\n} from './highlighter';\nimport { createIntegration } from './integrations';\nimport * as rangeUtil from './range-util';\nimport { SelectionObserver, selectedRange } from './selection-observer';\nimport { findClosestOffscreenAnchor } from './util/buckets';\nimport { frameFillsAncestor } from './util/frame';\nimport { normalizeURI } from './util/url';\n\n/** HTML element created by the highlighter with an associated annotation. */\ntype AnnotationHighlight = HTMLElement & { _annotation?: AnnotationData };\n\n/** Return all the annotations tags associated with the selected text. */\nfunction annotationsForSelection(): string[] {\n  const selection = window.getSelection()!;\n  const range = selection.getRangeAt(0);\n  const tags = rangeUtil.itemsForRange(\n    range,\n    node => (node as AnnotationHighlight)._annotation?.$tag\n  );\n  return tags;\n}\n\n/**\n * Return the annotation tags associated with any highlights that contain a given\n * DOM node.\n */\nfunction annotationsAt(node: Node): string[] {\n  const items = getHighlightsContainingNode(node)\n    .map(h => (h as AnnotationHighlight)._annotation)\n    .filter(ann => ann !== undefined)\n    .map(ann => ann?.$tag);\n  return items as string[];\n}\n\n/**\n * Resolve an anchor's associated document region to a concrete `Range`.\n *\n * This may fail if anchoring failed or if the document has been mutated since\n * the anchor was created in a way that invalidates the anchor.\n */\nfunction resolveAnchor(anchor: Anchor): Range | null {\n  if (!anchor.range) {\n    return null;\n  }\n  try {\n    return anchor.range.toRange();\n  } catch {\n    return null;\n  }\n}\n\nfunction removeTextSelection() {\n  document.getSelection()?.removeAllRanges();\n}\n\n/**\n * Subset of the Hypothesis client configuration that is used by {@link Guest}.\n */\nexport type GuestConfig = {\n  /**\n   * An identifier used by this guest to identify the current frame when\n   * communicating with the sidebar. This is only set in non-host frames.\n   */\n  subFrameIdentifier?: string;\n\n  /** Configures a banner or other indicators showing where the content has come from. */\n  contentInfoBanner?: ContentInfoConfig;\n};\n\n/**\n * `Guest` is the central class of the annotator that handles anchoring (locating)\n * annotations in the document when they are fetched by the sidebar, rendering\n * highlights for them and handling subsequent interactions with the highlights.\n *\n * It is also responsible for listening to changes in the current selection\n * and triggering the display of controls to create new annotations. When one\n * of these controls is clicked, it creates the new annotation and sends it to\n * the sidebar.\n *\n * Within a browser tab, there is typically one `Guest` instance per frame that\n * loads Hypothesis (not all frames will be annotation-enabled). In one frame,\n * usually the top-level one, there will also be an instance of the `Sidebar`\n * class that shows the sidebar app and surrounding UI. The `Guest` instance in\n * each frame connects to the sidebar and host frames as part of its\n * initialization.\n */\nexport class Guest extends TinyEmitter implements Annotator, Destroyable {\n  public element: HTMLElement;\n\n  /** Ranges of the current text selection. */\n  public selectedRanges: Range[];\n\n  /**\n   * The anchors generated by resolving annotation selectors to locations in the\n   * document. These are added by `anchor` and removed by `detach`.\n   *\n   * There is one anchor per annotation `Target`, which typically means one\n   * anchor per annotation.\n   */\n  public anchors: Anchor[];\n\n  public features: FeatureFlags;\n\n  /** Promise that resolves when feature flags are received from the sidebar. */\n  private _featureFlagsReceived: Promise<void>;\n\n  private _adder: Adder;\n  private _clusterToolbar?: HighlightClusterController;\n  private _hostFrame: Window;\n  private _highlightsVisible: boolean;\n  private _isAdderVisible: boolean;\n  private _informHostOnNextSelectionClear: boolean;\n  private _selectionObserver: SelectionObserver;\n\n  /**\n   * Tags of annotations that are currently anchored or being anchored in\n   * the guest.\n   */\n  private _annotations: Set<string>;\n  private _frameIdentifier: string | null;\n  private _portFinder: PortFinder;\n\n  /**\n   * Integration that handles document-type specific functionality in the\n   * guest.\n   */\n  private _integration: Integration;\n\n  /** Channel for host-guest communication. */\n  private _hostRPC: PortRPC<HostToGuestEvent, GuestToHostEvent>;\n\n  /** Channel for guest-sidebar communication. */\n  private _sidebarRPC: PortRPC<SidebarToGuestEvent, GuestToSidebarEvent>;\n\n  private _bucketBarClient: BucketBarClient;\n\n  private _sideBySideActive: boolean;\n  private _listeners: ListenerCollection;\n\n  /**\n   * Tags of currently hovered annotations. This is used to set the hovered\n   * state correctly for new highlights if the associated annotation is already\n   * hovered in the sidebar.\n   */\n  private _hoveredAnnotations: Set<string>;\n\n  /**\n   * @param element -\n   *   The root element in which the `Guest` instance should be able to anchor\n   *   or create annotations. In an ordinary web page this typically `document.body`.\n   * @param [config]\n   * @param [hostFrame] -\n   *   Host frame which this guest is associated with. This is expected to be\n   *   an ancestor of the guest frame. It may be same or cross origin.\n   */\n  constructor(\n    element: HTMLElement,\n    config: GuestConfig = {},\n    hostFrame: Window = window\n  ) {\n    super();\n\n    this.element = element;\n    this._hostFrame = hostFrame;\n    this._highlightsVisible = false;\n    this._isAdderVisible = false;\n    this._informHostOnNextSelectionClear = true;\n    this.selectedRanges = [];\n\n    this._adder = new Adder(this.element, {\n      onAnnotate: () => this.createAnnotation(),\n      onHighlight: () => this.createAnnotation({ highlight: true }),\n\n      // When the \"Show\" button is triggered, open the sidebar and select the\n      // annotations. Also give keyboard focus to the first selected annotation.\n      // This is an important affordance for eg. screen reader users as it gives\n      // them an efficient way to navigate from highlights in the document to\n      // the corresponding comments in the sidebar.\n      onShowAnnotations: tags =>\n        this.selectAnnotations(tags, { focusInSidebar: true }),\n    });\n\n    this._selectionObserver = new SelectionObserver(range => {\n      if (range) {\n        this._onSelection(range);\n      } else {\n        this._onClearSelection();\n      }\n    });\n\n    this.anchors = [];\n    this._annotations = new Set();\n\n    // Set the frame identifier if it's available.\n    // The \"top\" guest instance will have this as null since it's in a top frame not a sub frame\n    this._frameIdentifier = config.subFrameIdentifier || null;\n\n    this._portFinder = new PortFinder({\n      hostFrame: this._hostFrame,\n      source: 'guest',\n      sourceId: this._frameIdentifier ?? undefined,\n    });\n\n    this.features = new FeatureFlags();\n    this._featureFlagsReceived = new Promise(resolve => {\n      this.features.on('flagsChanged', resolve);\n    });\n\n    this._integration = createIntegration(this);\n    this._integration.on('uriChanged', () => this._sendDocumentInfo());\n    if (config.contentInfoBanner) {\n      this._integration.showContentInfo?.(config.contentInfoBanner);\n    }\n\n    if (this._integration.canStyleClusteredHighlights?.()) {\n      this._clusterToolbar = new HighlightClusterController(\n        this._integration.contentContainer(),\n        {\n          features: this.features,\n        }\n      );\n    }\n\n    this._hostRPC = new PortRPC();\n    this._connectHost(hostFrame);\n\n    this._sidebarRPC = new PortRPC();\n    this._connectSidebar();\n\n    this._bucketBarClient = new BucketBarClient({\n      contentContainer: this._integration.contentContainer(),\n      hostRPC: this._hostRPC,\n    });\n\n    this._sideBySideActive = false;\n\n    // Setup event handlers on the root element\n    this._listeners = new ListenerCollection();\n    this._setupElementEvents();\n\n    this._hoveredAnnotations = new Set();\n  }\n\n  // Add DOM event listeners for clicks, taps etc. on the document and\n  // highlights.\n  _setupElementEvents() {\n    // Hide the sidebar in response to a document click or tap, so it doesn't obscure\n    // the document content.\n    const maybeCloseSidebar = (element: Element) => {\n      if (this._sideBySideActive) {\n        // Don't hide the sidebar if event was disabled because the sidebar\n        // doesn't overlap the content.\n        return;\n      }\n      if (annotationsAt(element).length) {\n        // Don't hide the sidebar if the event comes from an element that contains a highlight\n        return;\n      }\n      this._sidebarRPC.call('closeSidebar');\n    };\n\n    this._listeners.add(this.element, 'mouseup', event => {\n      const { target, metaKey, ctrlKey } = event;\n      const tags = annotationsAt(target as Element);\n      if (tags.length && this._highlightsVisible) {\n        const toggle = metaKey || ctrlKey;\n        this.selectAnnotations(tags, { toggle });\n      }\n    });\n\n    this._listeners.add(this.element, 'mousedown', ({ target }) => {\n      maybeCloseSidebar(target as Element);\n    });\n\n    // Allow taps on the document to hide the sidebar as well as clicks.\n    // On iOS < 13 (2019), elements like h2 or div don't emit 'click' events.\n    this._listeners.add(this.element, 'touchstart', ({ target }) => {\n      maybeCloseSidebar(target as Element);\n    });\n\n    this._listeners.add(this.element, 'mouseover', ({ target }) => {\n      const tags = annotationsAt(target as Element);\n      if (tags.length && this._highlightsVisible) {\n        this._sidebarRPC.call('hoverAnnotations', tags);\n      }\n    });\n\n    this._listeners.add(this.element, 'mouseout', () => {\n      if (this._highlightsVisible) {\n        this._sidebarRPC.call('hoverAnnotations', []);\n      }\n    });\n\n    this._listeners.add(this.element, 'keydown', event => {\n      this._handleShortcut(event);\n    });\n\n    this._listeners.add(window, 'resize', () => this._repositionAdder());\n  }\n\n  /**\n   * Retrieve metadata for the current document.\n   */\n  async getDocumentInfo(): Promise<DocumentInfo> {\n    const [uri, metadata, segmentInfo] = await Promise.all([\n      this._integration.uri(),\n      this._integration.getMetadata(),\n      this._integration.segmentInfo?.(),\n    ]);\n\n    return {\n      uri: normalizeURI(uri),\n      metadata,\n      segmentInfo,\n      persistent: this._integration.persistFrame?.() ?? false,\n    };\n  }\n\n  /** Send the current document URI and metadata to the sidebar. */\n  async _sendDocumentInfo() {\n    if (this._integration.waitForFeatureFlags?.()) {\n      await this._featureFlagsReceived;\n    }\n    const metadata = await this.getDocumentInfo();\n    this._sidebarRPC.call('documentInfoChanged', metadata);\n  }\n\n  /**\n   * Shift the position of the adder on window 'resize' events\n   */\n  _repositionAdder() {\n    if (this._isAdderVisible === false) {\n      return;\n    }\n    const range = window.getSelection()?.getRangeAt(0);\n    if (range) {\n      this._onSelection(range);\n    }\n  }\n\n  async _connectHost(hostFrame: Window) {\n    this._hostRPC.on('clearSelection', () => {\n      if (selectedRange(document)) {\n        this._informHostOnNextSelectionClear = false;\n        removeTextSelection();\n      }\n    });\n\n    this._hostRPC.on('createAnnotation', () => this.createAnnotation());\n\n    this._hostRPC.on('hoverAnnotations', (tags: string[]) =>\n      this._hoverAnnotations(tags)\n    );\n\n    this._hostRPC.on(\n      'scrollToClosestOffScreenAnchor',\n      (tags: string[], direction: 'down' | 'up') =>\n        this._scrollToClosestOffScreenAnchor(tags, direction)\n    );\n\n    this._hostRPC.on('selectAnnotations', (tags: string[], toggle: boolean) =>\n      this.selectAnnotations(tags, { toggle })\n    );\n\n    this._hostRPC.on('sidebarLayoutChanged', (sidebarLayout: SidebarLayout) => {\n      if (frameFillsAncestor(window, hostFrame)) {\n        this.fitSideBySide(sidebarLayout);\n      }\n    });\n\n    this._hostRPC.on('close', () => this.emit('hostDisconnected'));\n\n    // Discover and connect to the host frame. All RPC events must be\n    // registered before creating the channel.\n    const hostPort = await this._portFinder.discover('host');\n    this._hostRPC.connect(hostPort);\n  }\n\n  async _connectSidebar() {\n    this._sidebarRPC.on(\n      'featureFlagsUpdated',\n      (flags: Record<string, boolean>) => this.features.update(flags)\n    );\n\n    // Handlers for events sent when user hovers or clicks on an annotation card\n    // in the sidebar.\n    this._sidebarRPC.on('hoverAnnotations', (tags: string[]) =>\n      this._hoverAnnotations(tags)\n    );\n\n    this._sidebarRPC.on('scrollToAnnotation', (tag: string) => {\n      const anchor = this.anchors.find(a => a.annotation.$tag === tag);\n      if (!anchor?.highlights) {\n        return;\n      }\n      const range = resolveAnchor(anchor);\n      if (!range) {\n        return;\n      }\n\n      // Emit a custom event that the host page can respond to. This is useful,\n      // for example, if the highlighted content is contained in a collapsible\n      // section of the page that needs to be un-collapsed.\n      const event = new CustomEvent('scrolltorange', {\n        bubbles: true,\n        cancelable: true,\n        detail: range,\n      });\n      const defaultNotPrevented = this.element.dispatchEvent(event);\n\n      if (defaultNotPrevented) {\n        this._integration.scrollToAnchor(anchor);\n      }\n    });\n\n    // Handler for controls on the sidebar\n    this._sidebarRPC.on('setHighlightsVisible', (showHighlights: boolean) => {\n      this.setHighlightsVisible(showHighlights, false /* notifyHost */);\n    });\n\n    this._sidebarRPC.on('deleteAnnotation', (tag: string) => this.detach(tag));\n\n    this._sidebarRPC.on('loadAnnotations', (annotations: AnnotationData[]) =>\n      annotations.forEach(annotation => this.anchor(annotation))\n    );\n\n    this._sidebarRPC.on('showContentInfo', (info: ContentInfoConfig) =>\n      this._integration.showContentInfo?.(info)\n    );\n\n    this._sidebarRPC.on('navigateToSegment', (annotation: AnnotationData) =>\n      this._integration.navigateToSegment?.(annotation)\n    );\n\n    // Connect to sidebar and send document info/URIs to it.\n    //\n    // RPC calls are deferred until a connection is made, so these steps can\n    // complete in either order.\n    this._portFinder.discover('sidebar').then(port => {\n      this._sidebarRPC.connect(port);\n    });\n\n    this._sendDocumentInfo();\n  }\n\n  destroy() {\n    this._portFinder.destroy();\n    this._hostRPC.destroy();\n    this._sidebarRPC.destroy();\n\n    this._listeners.removeAll();\n\n    this._selectionObserver.disconnect();\n    this._adder.destroy();\n    this._bucketBarClient.destroy();\n    this._clusterToolbar?.destroy();\n\n    removeAllHighlights(this.element);\n\n    this._integration.destroy();\n  }\n\n  /**\n   * Anchor an annotation's selectors in the document.\n   *\n   * _Anchoring_ resolves a set of selectors to a concrete region of the document\n   * which is then highlighted.\n   *\n   * Any existing anchors associated with `annotation` will be removed before\n   * re-anchoring the annotation.\n   */\n  async anchor(annotation: AnnotationData): Promise<Anchor[]> {\n    /**\n     * Resolve an annotation's selectors to a concrete range.\n     */\n    const locate = async (target: Target): Promise<Anchor> => {\n      // Only annotations with an associated quote can currently be anchored.\n      // This is because the quote is used to verify anchoring with other selector\n      // types.\n      if (\n        !target.selector ||\n        !target.selector.some(s => s.type === 'TextQuoteSelector')\n      ) {\n        return { annotation, target };\n      }\n\n      let anchor: Anchor;\n      try {\n        const range = await this._integration.anchor(\n          this.element,\n          target.selector\n        );\n        // Convert the `Range` to a `TextRange` which can be converted back to\n        // a `Range` later. The `TextRange` representation allows for highlights\n        // to be inserted during anchoring other annotations without \"breaking\"\n        // this anchor.\n        const textRange = TextRange.fromRange(range);\n        anchor = { annotation, target, range: textRange };\n      } catch (err) {\n        anchor = { annotation, target };\n      }\n      return anchor;\n    };\n\n    /**\n     * Highlight the text range that `anchor` refers to.\n     */\n    const highlight = (anchor: Anchor) => {\n      const range = resolveAnchor(anchor);\n      if (!range) {\n        return;\n      }\n\n      const highlights = highlightRange(\n        range,\n        anchor.annotation?.$cluster /* cssClass */\n      ) as AnnotationHighlight[];\n      highlights.forEach(h => {\n        h._annotation = anchor.annotation;\n      });\n      anchor.highlights = highlights;\n\n      if (this._hoveredAnnotations.has(anchor.annotation.$tag)) {\n        setHighlightsFocused(highlights, true);\n      }\n    };\n\n    // Remove existing anchors for this annotation.\n    this.detach(annotation.$tag, false /* notify */);\n\n    this._annotations.add(annotation.$tag);\n\n    // Resolve selectors to ranges and insert highlights.\n    if (!annotation.target) {\n      annotation.target = [];\n    }\n    const anchors = await Promise.all(annotation.target.map(locate));\n\n    // If the annotation was removed while anchoring, don't save the anchors.\n    if (!this._annotations.has(annotation.$tag)) {\n      return [];\n    }\n\n    for (const anchor of anchors) {\n      highlight(anchor);\n    }\n\n    // Set flag indicating whether anchoring succeeded. For each target,\n    // anchoring is successful either if there are no selectors (ie. this is a\n    // Page Note) or we successfully resolved the selectors to a range.\n    annotation.$orphan =\n      anchors.length > 0 &&\n      anchors.every(anchor => anchor.target.selector && !anchor.range);\n\n    this._updateAnchors(this.anchors.concat(anchors), true /* notify */);\n\n    // Let other frames (eg. the sidebar) know about the new annotation.\n    this._sidebarRPC.call('syncAnchoringStatus', annotation);\n\n    return anchors;\n  }\n\n  /**\n   * Remove the anchors and associated highlights for an annotation from the document.\n   *\n   * @param [notify] - For internal use. Whether to inform the host\n   *   frame about the removal of an anchor.\n   */\n  detach(tag: string, notify = true) {\n    this._annotations.delete(tag);\n\n    const anchors = [] as Anchor[];\n    for (const anchor of this.anchors) {\n      if (anchor.annotation.$tag !== tag) {\n        anchors.push(anchor);\n      } else if (anchor.highlights) {\n        removeHighlights(anchor.highlights);\n      }\n    }\n    this._updateAnchors(anchors, notify);\n  }\n\n  _updateAnchors(anchors: Anchor[], notify: boolean) {\n    this.anchors = anchors;\n    this._clusterToolbar?.scheduleClusterUpdates();\n    if (notify) {\n      this._bucketBarClient.update(this.anchors);\n    }\n  }\n\n  /**\n   * Create a new annotation that is associated with the selected region of\n   * the current document.\n   *\n   * @param options\n   *   @param [options.highlight] - If true, the new annotation has\n   *     the `$highlight` flag set, causing it to be saved immediately without\n   *     prompting for a comment.\n   * @return The new annotation\n   */\n  async createAnnotation({ highlight = false } = {}): Promise<AnnotationData> {\n    const ranges = this.selectedRanges;\n    this.selectedRanges = [];\n\n    const info = await this.getDocumentInfo();\n    const root = this.element;\n    const rangeSelectors = await Promise.all(\n      ranges.map(range => this._integration.describe(root, range))\n    );\n    const target = rangeSelectors.map(selectors => ({\n      source: info.uri,\n\n      // In the Hypothesis API the field containing the selectors is called\n      // `selector`, despite being a list.\n      selector: selectors,\n    }));\n\n    const annotation: AnnotationData = {\n      uri: info.uri,\n      document: info.metadata,\n      target,\n      $highlight: highlight,\n      $cluster: highlight ? 'user-highlights' : 'user-annotations',\n      $tag: 'a:' + generateHexString(8),\n    };\n\n    this._sidebarRPC.call('createAnnotation', annotation);\n    this.anchor(annotation);\n\n    // Removing the text selection triggers the `SelectionObserver` callback,\n    // which causes the adder to be removed after some delay.\n    removeTextSelection();\n\n    return annotation;\n  }\n\n  /**\n   * Indicate in the sidebar that certain annotations are focused (ie. the\n   * associated document region(s) is hovered).\n   */\n  _hoverAnnotations(tags: string[]) {\n    this._hoveredAnnotations.clear();\n    tags.forEach(tag => this._hoveredAnnotations.add(tag));\n\n    for (const anchor of this.anchors) {\n      if (anchor.highlights) {\n        const toggle = tags.includes(anchor.annotation.$tag);\n        setHighlightsFocused(anchor.highlights, toggle);\n      }\n    }\n\n    this._sidebarRPC.call('hoverAnnotations', tags);\n  }\n\n  /**\n   * Scroll to the closest off screen anchor.\n   */\n  _scrollToClosestOffScreenAnchor(tags: string[], direction: 'down' | 'up') {\n    const anchors = this.anchors.filter(({ annotation }) =>\n      tags.includes(annotation.$tag)\n    );\n    const closest = findClosestOffscreenAnchor(anchors, direction);\n    if (closest) {\n      this._integration.scrollToAnchor(closest);\n    }\n  }\n\n  /**\n   * Show or hide the adder toolbar when the selection changes.\n   */\n  _onSelection(range: Range) {\n    const annotatableRange = this._integration.getAnnotatableRange(range);\n    if (!annotatableRange) {\n      this._onClearSelection();\n      return;\n    }\n\n    const selection = document.getSelection()!;\n    const isBackwards = rangeUtil.isSelectionBackwards(selection);\n    const focusRect = rangeUtil.selectionFocusRect(selection);\n    if (!focusRect) {\n      // The selected range does not contain any text\n      this._onClearSelection();\n      return;\n    }\n\n    this.selectedRanges = [annotatableRange];\n    this._hostRPC.call('textSelected');\n\n    this._adder.annotationsForSelection = annotationsForSelection();\n    this._isAdderVisible = true;\n    this._adder.show(focusRect, isBackwards);\n  }\n\n  _onClearSelection() {\n    this._isAdderVisible = false;\n    this._adder.hide();\n    this.selectedRanges = [];\n    if (this._informHostOnNextSelectionClear) {\n      this._hostRPC.call('textUnselected');\n    }\n    this._informHostOnNextSelectionClear = true;\n  }\n\n  /**\n   * Show the given annotations in the sidebar.\n   *\n   * This sets up a filter in the sidebar to show only the selected annotations\n   * and opens the sidebar. Optionally it can also transfer keyboard focus to\n   * the annotation card for the first selected annotation.\n   *\n   * @param tags\n   * @param options\n   *   @param [options.toggle] - Toggle whether the annotations are\n   *     selected, as opposed to just selecting them\n   *   @param [options.focusInSidebar] - Whether to transfer keyboard\n   *     focus to the card for the first annotation in the selection. This\n   *     option has no effect if {@link toggle} is true.\n   */\n  selectAnnotations(\n    tags: string[],\n    { toggle = false, focusInSidebar = false } = {}\n  ) {\n    if (toggle) {\n      this._sidebarRPC.call('toggleAnnotationSelection', tags);\n    } else {\n      this._sidebarRPC.call('showAnnotations', tags, focusInSidebar);\n    }\n    this._sidebarRPC.call('openSidebar');\n  }\n\n  /**\n   * Set whether highlights are visible in the document or not.\n   *\n   * @param visible\n   * @param notifyHost - Whether to notify the host frame about this\n   *   change. This should be true unless the request to change highlight\n   *   visibility is coming from the host frame.\n   */\n  setHighlightsVisible(visible: boolean, notifyHost = true) {\n    setHighlightsVisible(this.element, visible);\n    this._highlightsVisible = visible;\n    if (notifyHost) {\n      this._hostRPC.call('highlightsVisibleChanged', visible);\n    }\n  }\n\n  get highlightsVisible() {\n    return this._highlightsVisible;\n  }\n\n  /**\n   * Attempt to fit the document content alongside the sidebar.\n   *\n   * @param sidebarLayout\n   */\n  fitSideBySide(sidebarLayout: SidebarLayout) {\n    this._sideBySideActive = this._integration.fitSideBySide(sidebarLayout);\n  }\n\n  /**\n   * Return true if side-by-side mode is currently active.\n   *\n   * Side-by-side mode is activated or de-activated when `fitSideBySide` is called\n   * depending on whether the sidebar is expanded and whether there is room for\n   * the content alongside the sidebar.\n   */\n  get sideBySideActive() {\n    return this._sideBySideActive;\n  }\n\n  /**\n   * Return the tags of annotations that are currently displayed in a hovered\n   * state.\n   */\n  get hoveredAnnotationTags(): Set<string> {\n    return this._hoveredAnnotations;\n  }\n\n  /**\n   * Handle a potential shortcut trigger.\n   */\n  _handleShortcut(event: KeyboardEvent) {\n    if (matchShortcut(event, 'Ctrl+Shift+H')) {\n      this.setHighlightsVisible(!this._highlightsVisible);\n    }\n  }\n}\n","/**\n * Test whether an iframe fills the viewport of an ancestor frame.\n *\n * @param {Window} frame\n * @param {Window} ancestor\n */\nexport function frameFillsAncestor(frame, ancestor) {\n  if (frame === ancestor) {\n    return true;\n  }\n\n  if (frame.parent !== ancestor) {\n    // To keep things simple, we initially only support direct ancestors.\n    return false;\n  }\n\n  if (!frame.frameElement) {\n    // This is a cross-origin iframe. In this case we can't tell if it fills\n    // the parent frame or not.\n    return false;\n  }\n\n  const frameBox = frame.frameElement.getBoundingClientRect();\n\n  // Threshold for deciding when a frame occupies enough of its parent's width\n  // to count as filling the viewport.\n  const fullWidthThreshold = 0.8;\n\n  return frameBox.width / frame.parent.innerWidth >= fullWidthThreshold;\n}\n","/**\n * Encode app configuration in a URL fragment.\n *\n * This is used by the annotator to pass configuration to the sidebar and\n * notebook apps, which they can easily read on startup. The configuration is\n * passed in the fragment to avoid invalidating cache entries for the URL\n * or adding noise to server logs.\n *\n * @param {string} baseURL\n * @param {object} config\n * @return {string} URL with added fragment\n */\nexport function addConfigFragment(baseURL, config) {\n  const url = new URL(baseURL);\n  const params = new URLSearchParams();\n  params.append('config', JSON.stringify(config));\n  url.hash = params.toString();\n  return url.toString();\n}\n\n/**\n * Parse configuration from a URL generated by {@link addConfigFragment}.\n *\n * @param {string} url\n * @return {Record<string, unknown>}\n */\nexport function parseConfigFragment(url) {\n  const configStr = new URL(url).hash.slice(1);\n  const configJSON = new URLSearchParams(configStr).get('config');\n  return JSON.parse(configJSON || '{}');\n}\n","/**\n * Create the JSON-serializable subset of annotator configuration that should\n * be passed to the sidebar or notebook applications.\n *\n * @param appURL - URL from which the application will be served\n */\nexport function createAppConfig(\n  appURL: string,\n  config: Record<string, unknown>\n): Record<string, unknown> {\n  const appConfig: Record<string, unknown> = {};\n\n  for (const [key, value] of Object.entries(config)) {\n    // Remove several annotator-only properties.\n    //\n    // nb. We don't currently strip all the annotator-only properties here.\n    // That's OK because validation / filtering happens in the sidebar app itself.\n    // It just results in unnecessary content in the sidebar iframe's URL string.\n    if (key === 'notebookAppUrl' || key === 'sidebarAppUrl') {\n      continue;\n    }\n\n    // Strip nullish properties, as these are ignored by the application and\n    // they add noise to logs etc.\n    //\n    // eslint-disable-next-line eqeqeq\n    if (value == null) {\n      continue;\n    }\n\n    appConfig[key] = value;\n  }\n\n  // Pass the expected origin of the app. This is used to detect when it is\n  // served from a different location than expected, which may stop it working.\n  appConfig.origin = new URL(appURL).origin;\n\n  // Pass the version of the client, so we can check if it is the same as the\n  // one used in the sidebar/notebook/profile.\n  appConfig.version = '__VERSION__';\n\n  // Pass the URL of the page that embedded the client.\n  const hostURL = new URL(window.location.href);\n  hostURL.hash = '';\n  appConfig.hostURL = hostURL.toString();\n\n  // Some config settings are not JSON-stringifiable (e.g. JavaScript\n  // functions) and will be omitted when the config is JSON-stringified.\n  // Add a JSON-stringifiable option for each of these so that the sidebar can\n  // at least know whether the callback functions were provided or not.\n  if (Array.isArray(appConfig.services) && appConfig.services?.length > 0) {\n    const service = appConfig.services[0];\n    if (service.onLoginRequest) {\n      service.onLoginRequestProvided = true;\n    }\n    if (service.onLogoutRequest) {\n      service.onLogoutRequestProvided = true;\n    }\n    if (service.onSignupRequest) {\n      service.onSignupRequestProvided = true;\n    }\n    if (service.onProfileRequest) {\n      service.onProfileRequestProvided = true;\n    }\n    if (service.onHelpRequest) {\n      service.onHelpRequestProvided = true;\n    }\n  }\n\n  return appConfig;\n}\n","import { IconButton, CancelIcon } from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\nimport { useEffect, useRef, useState } from 'preact/hooks';\n\nimport { addConfigFragment } from '../../shared/config-fragment';\nimport { createAppConfig } from '../config/app';\nimport type { EventBus, Emitter } from '../util/emitter';\n\n/**\n * Configuration used to launch the notebook application.\n *\n * This includes the URL for the iframe and configuration to pass to the\n * application on launch.\n */\nexport type NotebookConfig = {\n  notebookAppUrl: string;\n} & Record<string, unknown>;\n\ntype NotebookIframeProps = {\n  config: NotebookConfig;\n  groupId: string;\n};\n/**\n * Create the iframe that will load the notebook application.\n */\nfunction NotebookIframe({ config, groupId }: NotebookIframeProps) {\n  const notebookAppSrc = addConfigFragment(config.notebookAppUrl, {\n    ...createAppConfig(config.notebookAppUrl, config),\n\n    // Explicity set the \"focused\" group\n    group: groupId,\n  });\n\n  return (\n    <iframe\n      title={'Hypothesis annotation notebook'}\n      className=\"h-full w-full border-0\"\n      // Enable media in annotations to be shown fullscreen.\n      // TODO: Use `allow=\"fullscreen\" once `allow` attribute available for\n      // iframe elements in all supported browsers\n      // See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-allow\n      // eslint-disable-next-line react/no-unknown-property\n      allowFullScreen\n      src={notebookAppSrc}\n    />\n  );\n}\nexport type NotebookModalProps = {\n  eventBus: EventBus;\n  config: NotebookConfig;\n};\n\n/**\n * Create a modal component that hosts (1) the notebook iframe and (2) a button to close the modal.\n */\nexport default function NotebookModal({\n  eventBus,\n  config,\n}: NotebookModalProps) {\n  // Temporary solution: while there is no mechanism to sync new annotations in\n  // the notebook, we force re-rendering of the iframe on every 'openNotebook'\n  // event, so that the new annotations are displayed.\n  // https://github.com/hypothesis/client/issues/3182\n  const [iframeKey, setIframeKey] = useState(0);\n  const [isHidden, setIsHidden] = useState(true);\n  const [groupId, setGroupId] = useState<string | null>(null);\n  const originalDocumentOverflowStyle = useRef('');\n  const emitterRef = useRef<Emitter | null>(null);\n\n  // Stores the original overflow CSS property of document.body and reset it\n  // when the component is destroyed\n  useEffect(() => {\n    originalDocumentOverflowStyle.current = document.body.style.overflow;\n\n    return () => {\n      document.body.style.overflow = originalDocumentOverflowStyle.current;\n    };\n  }, []);\n\n  // The overflow CSS property is set to hidden to prevent scrolling of the host page,\n  // while the notebook modal is open. It is restored when the modal is closed.\n  useEffect(() => {\n    if (isHidden) {\n      document.body.style.overflow = originalDocumentOverflowStyle.current;\n    } else {\n      document.body.style.overflow = 'hidden';\n    }\n  }, [isHidden]);\n\n  useEffect(() => {\n    const emitter = eventBus.createEmitter();\n    emitter.subscribe('openNotebook', (groupId: string) => {\n      setIsHidden(false);\n      setIframeKey(iframeKey => iframeKey + 1);\n      setGroupId(groupId);\n    });\n    emitterRef.current = emitter;\n\n    return () => {\n      emitter.destroy();\n    };\n  }, [eventBus]);\n\n  const onClose = () => {\n    setIsHidden(true);\n    emitterRef.current?.publish('closeNotebook');\n  };\n\n  if (groupId === null) {\n    return null;\n  }\n\n  return (\n    <div\n      className={classnames(\n        'fixed z-max top-0 left-0 right-0 bottom-0 p-3 bg-black/50',\n        { hidden: isHidden }\n      )}\n      data-testid=\"notebook-outer\"\n    >\n      <div className=\"relative w-full h-full\" data-testid=\"notebook-inner\">\n        <div className=\"absolute right-0 m-3\">\n          <IconButton\n            title=\"Close the Notebook\"\n            onClick={onClose}\n            variant=\"dark\"\n            classes={classnames(\n              // Remove the dark variant's background color to avoid\n              // interfering with modal overlays. Re-activate the dark variant's\n              // background color on hover.\n              // See https://github.com/hypothesis/client/issues/3676\n              '!bg-transparent enabled:hover:!bg-grey-3'\n            )}\n          >\n            <CancelIcon className=\"w-4 h-4\" />\n          </IconButton>\n        </div>\n        <NotebookIframe key={iframeKey} config={config} groupId={groupId} />\n      </div>\n    </div>\n  );\n}\n","import { render } from 'preact';\n\nimport type { Destroyable } from '../types/annotator';\nimport NotebookModal from './components/NotebookModal';\nimport type { NotebookConfig } from './components/NotebookModal';\nimport type { EventBus } from './util/emitter';\nimport { createShadowRoot } from './util/shadow-root';\n\nexport class Notebook implements Destroyable {\n  private _outerContainer: HTMLElement;\n  private _shadowRoot: ShadowRoot;\n\n  /**\n   * @param eventBus - Enables communication between components sharing the\n   *   same eventBus\n   */\n  constructor(\n    element: HTMLElement,\n    eventBus: EventBus,\n    config: NotebookConfig\n  ) {\n    /**\n     * Un-styled shadow host for the notebook content.\n     * This isolates the notebook from the page's styles.\n     */\n    this._outerContainer = document.createElement('hypothesis-notebook');\n    element.appendChild(this._outerContainer);\n    this._shadowRoot = createShadowRoot(this._outerContainer);\n\n    render(\n      <NotebookModal eventBus={eventBus} config={config} />,\n      this._shadowRoot\n    );\n  }\n\n  destroy() {\n    render(null, this._shadowRoot);\n    this._outerContainer.remove();\n  }\n}\n","import { CancelIcon, IconButton } from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\nimport { useEffect, useRef, useState } from 'preact/hooks';\n\nimport type { Emitter, EventBus } from '../util/emitter';\n\nexport type ProfileConfig = { profileAppUrl: string } & Record<string, unknown>;\n\ntype ProfileModalProps = {\n  eventBus: EventBus;\n  config: ProfileConfig;\n};\n\nexport default function ProfileModal({ eventBus, config }: ProfileModalProps) {\n  const [isHidden, setIsHidden] = useState(true);\n  const emitterRef = useRef<Emitter | null>(null);\n\n  useEffect(() => {\n    const emitter = eventBus.createEmitter();\n    emitter.subscribe('openProfile', () => {\n      setIsHidden(false);\n    });\n    emitterRef.current = emitter;\n\n    return () => {\n      emitter.destroy();\n    };\n  }, [eventBus]);\n\n  const onClose = () => {\n    setIsHidden(true);\n    emitterRef.current?.publish('closeProfile');\n  };\n\n  if (isHidden) {\n    return null;\n  }\n\n  return (\n    <div\n      className=\"fixed z-max top-0 left-0 right-0 bottom-0 p-3 bg-black/50\"\n      data-testid=\"profile-outer\"\n    >\n      <div className=\"relative w-full h-full\" data-testid=\"profile-inner\">\n        <div className=\"absolute right-0 m-3\">\n          <IconButton\n            title=\"Close the Profile\"\n            onClick={onClose}\n            variant=\"dark\"\n            classes={classnames(\n              // Remove the dark variant's background color to avoid\n              // interfering with modal overlays. Re-activate the dark variant's\n              // background color on hover.\n              // See https://github.com/hypothesis/client/issues/3676\n              '!bg-transparent enabled:hover:!bg-grey-3'\n            )}\n          >\n            <CancelIcon className=\"w-4 h-4\" />\n          </IconButton>\n        </div>\n        <iframe\n          title={'Hypothesis profile'}\n          className=\"h-full w-full border-0\"\n          src={config.profileAppUrl}\n        />\n      </div>\n    </div>\n  );\n}\n","import { render } from 'preact';\n\nimport type { Destroyable } from '../types/annotator';\nimport type { ProfileConfig } from './components/ProfileModal';\nimport ProfileModal from './components/ProfileModal';\nimport type { EventBus } from './util/emitter';\nimport { createShadowRoot } from './util/shadow-root';\n\nexport class Profile implements Destroyable {\n  private _outerContainer: HTMLElement;\n  public shadowRoot: ShadowRoot;\n\n  constructor(element: HTMLElement, eventBus: EventBus, config: ProfileConfig) {\n    this._outerContainer = document.createElement('hypothesis-profile');\n    element.appendChild(this._outerContainer);\n    this.shadowRoot = createShadowRoot(this._outerContainer);\n\n    render(\n      <ProfileModal eventBus={eventBus} config={config} />,\n      this.shadowRoot\n    );\n  }\n\n  destroy(): void {\n    render(null, this.shadowRoot);\n    this._outerContainer.remove();\n  }\n}\n","/*! Hammer.JS - v2.0.7 - 2016-04-22\n * http://hammerjs.github.io/\n *\n * Copyright (c) 2016 Jorik Tangelder;\n * Licensed under the MIT license */\n(function(window, document, exportName, undefined) {\n  'use strict';\n\nvar VENDOR_PREFIXES = ['', 'webkit', 'Moz', 'MS', 'ms', 'o'];\nvar TEST_ELEMENT = document.createElement('div');\n\nvar TYPE_FUNCTION = 'function';\n\nvar round = Math.round;\nvar abs = Math.abs;\nvar now = Date.now;\n\n/**\n * set a timeout with a given scope\n * @param {Function} fn\n * @param {Number} timeout\n * @param {Object} context\n * @returns {number}\n */\nfunction setTimeoutContext(fn, timeout, context) {\n    return setTimeout(bindFn(fn, context), timeout);\n}\n\n/**\n * if the argument is an array, we want to execute the fn on each entry\n * if it aint an array we don't want to do a thing.\n * this is used by all the methods that accept a single and array argument.\n * @param {*|Array} arg\n * @param {String} fn\n * @param {Object} [context]\n * @returns {Boolean}\n */\nfunction invokeArrayArg(arg, fn, context) {\n    if (Array.isArray(arg)) {\n        each(arg, context[fn], context);\n        return true;\n    }\n    return false;\n}\n\n/**\n * walk objects and arrays\n * @param {Object} obj\n * @param {Function} iterator\n * @param {Object} context\n */\nfunction each(obj, iterator, context) {\n    var i;\n\n    if (!obj) {\n        return;\n    }\n\n    if (obj.forEach) {\n        obj.forEach(iterator, context);\n    } else if (obj.length !== undefined) {\n        i = 0;\n        while (i < obj.length) {\n            iterator.call(context, obj[i], i, obj);\n            i++;\n        }\n    } else {\n        for (i in obj) {\n            obj.hasOwnProperty(i) && iterator.call(context, obj[i], i, obj);\n        }\n    }\n}\n\n/**\n * wrap a method with a deprecation warning and stack trace\n * @param {Function} method\n * @param {String} name\n * @param {String} message\n * @returns {Function} A new function wrapping the supplied method.\n */\nfunction deprecate(method, name, message) {\n    var deprecationMessage = 'DEPRECATED METHOD: ' + name + '\\n' + message + ' AT \\n';\n    return function() {\n        var e = new Error('get-stack-trace');\n        var stack = e && e.stack ? e.stack.replace(/^[^\\(]+?[\\n$]/gm, '')\n            .replace(/^\\s+at\\s+/gm, '')\n            .replace(/^Object.<anonymous>\\s*\\(/gm, '{anonymous}()@') : 'Unknown Stack Trace';\n\n        var log = window.console && (window.console.warn || window.console.log);\n        if (log) {\n            log.call(window.console, deprecationMessage, stack);\n        }\n        return method.apply(this, arguments);\n    };\n}\n\n/**\n * extend object.\n * means that properties in dest will be overwritten by the ones in src.\n * @param {Object} target\n * @param {...Object} objects_to_assign\n * @returns {Object} target\n */\nvar assign;\nif (typeof Object.assign !== 'function') {\n    assign = function assign(target) {\n        if (target === undefined || target === null) {\n            throw new TypeError('Cannot convert undefined or null to object');\n        }\n\n        var output = Object(target);\n        for (var index = 1; index < arguments.length; index++) {\n            var source = arguments[index];\n            if (source !== undefined && source !== null) {\n                for (var nextKey in source) {\n                    if (source.hasOwnProperty(nextKey)) {\n                        output[nextKey] = source[nextKey];\n                    }\n                }\n            }\n        }\n        return output;\n    };\n} else {\n    assign = Object.assign;\n}\n\n/**\n * extend object.\n * means that properties in dest will be overwritten by the ones in src.\n * @param {Object} dest\n * @param {Object} src\n * @param {Boolean} [merge=false]\n * @returns {Object} dest\n */\nvar extend = deprecate(function extend(dest, src, merge) {\n    var keys = Object.keys(src);\n    var i = 0;\n    while (i < keys.length) {\n        if (!merge || (merge && dest[keys[i]] === undefined)) {\n            dest[keys[i]] = src[keys[i]];\n        }\n        i++;\n    }\n    return dest;\n}, 'extend', 'Use `assign`.');\n\n/**\n * merge the values from src in the dest.\n * means that properties that exist in dest will not be overwritten by src\n * @param {Object} dest\n * @param {Object} src\n * @returns {Object} dest\n */\nvar merge = deprecate(function merge(dest, src) {\n    return extend(dest, src, true);\n}, 'merge', 'Use `assign`.');\n\n/**\n * simple class inheritance\n * @param {Function} child\n * @param {Function} base\n * @param {Object} [properties]\n */\nfunction inherit(child, base, properties) {\n    var baseP = base.prototype,\n        childP;\n\n    childP = child.prototype = Object.create(baseP);\n    childP.constructor = child;\n    childP._super = baseP;\n\n    if (properties) {\n        assign(childP, properties);\n    }\n}\n\n/**\n * simple function bind\n * @param {Function} fn\n * @param {Object} context\n * @returns {Function}\n */\nfunction bindFn(fn, context) {\n    return function boundFn() {\n        return fn.apply(context, arguments);\n    };\n}\n\n/**\n * let a boolean value also be a function that must return a boolean\n * this first item in args will be used as the context\n * @param {Boolean|Function} val\n * @param {Array} [args]\n * @returns {Boolean}\n */\nfunction boolOrFn(val, args) {\n    if (typeof val == TYPE_FUNCTION) {\n        return val.apply(args ? args[0] || undefined : undefined, args);\n    }\n    return val;\n}\n\n/**\n * use the val2 when val1 is undefined\n * @param {*} val1\n * @param {*} val2\n * @returns {*}\n */\nfunction ifUndefined(val1, val2) {\n    return (val1 === undefined) ? val2 : val1;\n}\n\n/**\n * addEventListener with multiple events at once\n * @param {EventTarget} target\n * @param {String} types\n * @param {Function} handler\n */\nfunction addEventListeners(target, types, handler) {\n    each(splitStr(types), function(type) {\n        target.addEventListener(type, handler, false);\n    });\n}\n\n/**\n * removeEventListener with multiple events at once\n * @param {EventTarget} target\n * @param {String} types\n * @param {Function} handler\n */\nfunction removeEventListeners(target, types, handler) {\n    each(splitStr(types), function(type) {\n        target.removeEventListener(type, handler, false);\n    });\n}\n\n/**\n * find if a node is in the given parent\n * @method hasParent\n * @param {HTMLElement} node\n * @param {HTMLElement} parent\n * @return {Boolean} found\n */\nfunction hasParent(node, parent) {\n    while (node) {\n        if (node == parent) {\n            return true;\n        }\n        node = node.parentNode;\n    }\n    return false;\n}\n\n/**\n * small indexOf wrapper\n * @param {String} str\n * @param {String} find\n * @returns {Boolean} found\n */\nfunction inStr(str, find) {\n    return str.indexOf(find) > -1;\n}\n\n/**\n * split string on whitespace\n * @param {String} str\n * @returns {Array} words\n */\nfunction splitStr(str) {\n    return str.trim().split(/\\s+/g);\n}\n\n/**\n * find if a array contains the object using indexOf or a simple polyFill\n * @param {Array} src\n * @param {String} find\n * @param {String} [findByKey]\n * @return {Boolean|Number} false when not found, or the index\n */\nfunction inArray(src, find, findByKey) {\n    if (src.indexOf && !findByKey) {\n        return src.indexOf(find);\n    } else {\n        var i = 0;\n        while (i < src.length) {\n            if ((findByKey && src[i][findByKey] == find) || (!findByKey && src[i] === find)) {\n                return i;\n            }\n            i++;\n        }\n        return -1;\n    }\n}\n\n/**\n * convert array-like objects to real arrays\n * @param {Object} obj\n * @returns {Array}\n */\nfunction toArray(obj) {\n    return Array.prototype.slice.call(obj, 0);\n}\n\n/**\n * unique array with objects based on a key (like 'id') or just by the array's value\n * @param {Array} src [{id:1},{id:2},{id:1}]\n * @param {String} [key]\n * @param {Boolean} [sort=False]\n * @returns {Array} [{id:1},{id:2}]\n */\nfunction uniqueArray(src, key, sort) {\n    var results = [];\n    var values = [];\n    var i = 0;\n\n    while (i < src.length) {\n        var val = key ? src[i][key] : src[i];\n        if (inArray(values, val) < 0) {\n            results.push(src[i]);\n        }\n        values[i] = val;\n        i++;\n    }\n\n    if (sort) {\n        if (!key) {\n            results = results.sort();\n        } else {\n            results = results.sort(function sortUniqueArray(a, b) {\n                return a[key] > b[key];\n            });\n        }\n    }\n\n    return results;\n}\n\n/**\n * get the prefixed property\n * @param {Object} obj\n * @param {String} property\n * @returns {String|Undefined} prefixed\n */\nfunction prefixed(obj, property) {\n    var prefix, prop;\n    var camelProp = property[0].toUpperCase() + property.slice(1);\n\n    var i = 0;\n    while (i < VENDOR_PREFIXES.length) {\n        prefix = VENDOR_PREFIXES[i];\n        prop = (prefix) ? prefix + camelProp : property;\n\n        if (prop in obj) {\n            return prop;\n        }\n        i++;\n    }\n    return undefined;\n}\n\n/**\n * get a unique id\n * @returns {number} uniqueId\n */\nvar _uniqueId = 1;\nfunction uniqueId() {\n    return _uniqueId++;\n}\n\n/**\n * get the window object of an element\n * @param {HTMLElement} element\n * @returns {DocumentView|Window}\n */\nfunction getWindowForElement(element) {\n    var doc = element.ownerDocument || element;\n    return (doc.defaultView || doc.parentWindow || window);\n}\n\nvar MOBILE_REGEX = /mobile|tablet|ip(ad|hone|od)|android/i;\n\nvar SUPPORT_TOUCH = ('ontouchstart' in window);\nvar SUPPORT_POINTER_EVENTS = prefixed(window, 'PointerEvent') !== undefined;\nvar SUPPORT_ONLY_TOUCH = SUPPORT_TOUCH && MOBILE_REGEX.test(navigator.userAgent);\n\nvar INPUT_TYPE_TOUCH = 'touch';\nvar INPUT_TYPE_PEN = 'pen';\nvar INPUT_TYPE_MOUSE = 'mouse';\nvar INPUT_TYPE_KINECT = 'kinect';\n\nvar COMPUTE_INTERVAL = 25;\n\nvar INPUT_START = 1;\nvar INPUT_MOVE = 2;\nvar INPUT_END = 4;\nvar INPUT_CANCEL = 8;\n\nvar DIRECTION_NONE = 1;\nvar DIRECTION_LEFT = 2;\nvar DIRECTION_RIGHT = 4;\nvar DIRECTION_UP = 8;\nvar DIRECTION_DOWN = 16;\n\nvar DIRECTION_HORIZONTAL = DIRECTION_LEFT | DIRECTION_RIGHT;\nvar DIRECTION_VERTICAL = DIRECTION_UP | DIRECTION_DOWN;\nvar DIRECTION_ALL = DIRECTION_HORIZONTAL | DIRECTION_VERTICAL;\n\nvar PROPS_XY = ['x', 'y'];\nvar PROPS_CLIENT_XY = ['clientX', 'clientY'];\n\n/**\n * create new input type manager\n * @param {Manager} manager\n * @param {Function} callback\n * @returns {Input}\n * @constructor\n */\nfunction Input(manager, callback) {\n    var self = this;\n    this.manager = manager;\n    this.callback = callback;\n    this.element = manager.element;\n    this.target = manager.options.inputTarget;\n\n    // smaller wrapper around the handler, for the scope and the enabled state of the manager,\n    // so when disabled the input events are completely bypassed.\n    this.domHandler = function(ev) {\n        if (boolOrFn(manager.options.enable, [manager])) {\n            self.handler(ev);\n        }\n    };\n\n    this.init();\n\n}\n\nInput.prototype = {\n    /**\n     * should handle the inputEvent data and trigger the callback\n     * @virtual\n     */\n    handler: function() { },\n\n    /**\n     * bind the events\n     */\n    init: function() {\n        this.evEl && addEventListeners(this.element, this.evEl, this.domHandler);\n        this.evTarget && addEventListeners(this.target, this.evTarget, this.domHandler);\n        this.evWin && addEventListeners(getWindowForElement(this.element), this.evWin, this.domHandler);\n    },\n\n    /**\n     * unbind the events\n     */\n    destroy: function() {\n        this.evEl && removeEventListeners(this.element, this.evEl, this.domHandler);\n        this.evTarget && removeEventListeners(this.target, this.evTarget, this.domHandler);\n        this.evWin && removeEventListeners(getWindowForElement(this.element), this.evWin, this.domHandler);\n    }\n};\n\n/**\n * create new input type manager\n * called by the Manager constructor\n * @param {Hammer} manager\n * @returns {Input}\n */\nfunction createInputInstance(manager) {\n    var Type;\n    var inputClass = manager.options.inputClass;\n\n    if (inputClass) {\n        Type = inputClass;\n    } else if (SUPPORT_POINTER_EVENTS) {\n        Type = PointerEventInput;\n    } else if (SUPPORT_ONLY_TOUCH) {\n        Type = TouchInput;\n    } else if (!SUPPORT_TOUCH) {\n        Type = MouseInput;\n    } else {\n        Type = TouchMouseInput;\n    }\n    return new (Type)(manager, inputHandler);\n}\n\n/**\n * handle input events\n * @param {Manager} manager\n * @param {String} eventType\n * @param {Object} input\n */\nfunction inputHandler(manager, eventType, input) {\n    var pointersLen = input.pointers.length;\n    var changedPointersLen = input.changedPointers.length;\n    var isFirst = (eventType & INPUT_START && (pointersLen - changedPointersLen === 0));\n    var isFinal = (eventType & (INPUT_END | INPUT_CANCEL) && (pointersLen - changedPointersLen === 0));\n\n    input.isFirst = !!isFirst;\n    input.isFinal = !!isFinal;\n\n    if (isFirst) {\n        manager.session = {};\n    }\n\n    // source event is the normalized value of the domEvents\n    // like 'touchstart, mouseup, pointerdown'\n    input.eventType = eventType;\n\n    // compute scale, rotation etc\n    computeInputData(manager, input);\n\n    // emit secret event\n    manager.emit('hammer.input', input);\n\n    manager.recognize(input);\n    manager.session.prevInput = input;\n}\n\n/**\n * extend the data with some usable properties like scale, rotate, velocity etc\n * @param {Object} manager\n * @param {Object} input\n */\nfunction computeInputData(manager, input) {\n    var session = manager.session;\n    var pointers = input.pointers;\n    var pointersLength = pointers.length;\n\n    // store the first input to calculate the distance and direction\n    if (!session.firstInput) {\n        session.firstInput = simpleCloneInputData(input);\n    }\n\n    // to compute scale and rotation we need to store the multiple touches\n    if (pointersLength > 1 && !session.firstMultiple) {\n        session.firstMultiple = simpleCloneInputData(input);\n    } else if (pointersLength === 1) {\n        session.firstMultiple = false;\n    }\n\n    var firstInput = session.firstInput;\n    var firstMultiple = session.firstMultiple;\n    var offsetCenter = firstMultiple ? firstMultiple.center : firstInput.center;\n\n    var center = input.center = getCenter(pointers);\n    input.timeStamp = now();\n    input.deltaTime = input.timeStamp - firstInput.timeStamp;\n\n    input.angle = getAngle(offsetCenter, center);\n    input.distance = getDistance(offsetCenter, center);\n\n    computeDeltaXY(session, input);\n    input.offsetDirection = getDirection(input.deltaX, input.deltaY);\n\n    var overallVelocity = getVelocity(input.deltaTime, input.deltaX, input.deltaY);\n    input.overallVelocityX = overallVelocity.x;\n    input.overallVelocityY = overallVelocity.y;\n    input.overallVelocity = (abs(overallVelocity.x) > abs(overallVelocity.y)) ? overallVelocity.x : overallVelocity.y;\n\n    input.scale = firstMultiple ? getScale(firstMultiple.pointers, pointers) : 1;\n    input.rotation = firstMultiple ? getRotation(firstMultiple.pointers, pointers) : 0;\n\n    input.maxPointers = !session.prevInput ? input.pointers.length : ((input.pointers.length >\n        session.prevInput.maxPointers) ? input.pointers.length : session.prevInput.maxPointers);\n\n    computeIntervalInputData(session, input);\n\n    // find the correct target\n    var target = manager.element;\n    if (hasParent(input.srcEvent.target, target)) {\n        target = input.srcEvent.target;\n    }\n    input.target = target;\n}\n\nfunction computeDeltaXY(session, input) {\n    var center = input.center;\n    var offset = session.offsetDelta || {};\n    var prevDelta = session.prevDelta || {};\n    var prevInput = session.prevInput || {};\n\n    if (input.eventType === INPUT_START || prevInput.eventType === INPUT_END) {\n        prevDelta = session.prevDelta = {\n            x: prevInput.deltaX || 0,\n            y: prevInput.deltaY || 0\n        };\n\n        offset = session.offsetDelta = {\n            x: center.x,\n            y: center.y\n        };\n    }\n\n    input.deltaX = prevDelta.x + (center.x - offset.x);\n    input.deltaY = prevDelta.y + (center.y - offset.y);\n}\n\n/**\n * velocity is calculated every x ms\n * @param {Object} session\n * @param {Object} input\n */\nfunction computeIntervalInputData(session, input) {\n    var last = session.lastInterval || input,\n        deltaTime = input.timeStamp - last.timeStamp,\n        velocity, velocityX, velocityY, direction;\n\n    if (input.eventType != INPUT_CANCEL && (deltaTime > COMPUTE_INTERVAL || last.velocity === undefined)) {\n        var deltaX = input.deltaX - last.deltaX;\n        var deltaY = input.deltaY - last.deltaY;\n\n        var v = getVelocity(deltaTime, deltaX, deltaY);\n        velocityX = v.x;\n        velocityY = v.y;\n        velocity = (abs(v.x) > abs(v.y)) ? v.x : v.y;\n        direction = getDirection(deltaX, deltaY);\n\n        session.lastInterval = input;\n    } else {\n        // use latest velocity info if it doesn't overtake a minimum period\n        velocity = last.velocity;\n        velocityX = last.velocityX;\n        velocityY = last.velocityY;\n        direction = last.direction;\n    }\n\n    input.velocity = velocity;\n    input.velocityX = velocityX;\n    input.velocityY = velocityY;\n    input.direction = direction;\n}\n\n/**\n * create a simple clone from the input used for storage of firstInput and firstMultiple\n * @param {Object} input\n * @returns {Object} clonedInputData\n */\nfunction simpleCloneInputData(input) {\n    // make a simple copy of the pointers because we will get a reference if we don't\n    // we only need clientXY for the calculations\n    var pointers = [];\n    var i = 0;\n    while (i < input.pointers.length) {\n        pointers[i] = {\n            clientX: round(input.pointers[i].clientX),\n            clientY: round(input.pointers[i].clientY)\n        };\n        i++;\n    }\n\n    return {\n        timeStamp: now(),\n        pointers: pointers,\n        center: getCenter(pointers),\n        deltaX: input.deltaX,\n        deltaY: input.deltaY\n    };\n}\n\n/**\n * get the center of all the pointers\n * @param {Array} pointers\n * @return {Object} center contains `x` and `y` properties\n */\nfunction getCenter(pointers) {\n    var pointersLength = pointers.length;\n\n    // no need to loop when only one touch\n    if (pointersLength === 1) {\n        return {\n            x: round(pointers[0].clientX),\n            y: round(pointers[0].clientY)\n        };\n    }\n\n    var x = 0, y = 0, i = 0;\n    while (i < pointersLength) {\n        x += pointers[i].clientX;\n        y += pointers[i].clientY;\n        i++;\n    }\n\n    return {\n        x: round(x / pointersLength),\n        y: round(y / pointersLength)\n    };\n}\n\n/**\n * calculate the velocity between two points. unit is in px per ms.\n * @param {Number} deltaTime\n * @param {Number} x\n * @param {Number} y\n * @return {Object} velocity `x` and `y`\n */\nfunction getVelocity(deltaTime, x, y) {\n    return {\n        x: x / deltaTime || 0,\n        y: y / deltaTime || 0\n    };\n}\n\n/**\n * get the direction between two points\n * @param {Number} x\n * @param {Number} y\n * @return {Number} direction\n */\nfunction getDirection(x, y) {\n    if (x === y) {\n        return DIRECTION_NONE;\n    }\n\n    if (abs(x) >= abs(y)) {\n        return x < 0 ? DIRECTION_LEFT : DIRECTION_RIGHT;\n    }\n    return y < 0 ? DIRECTION_UP : DIRECTION_DOWN;\n}\n\n/**\n * calculate the absolute distance between two points\n * @param {Object} p1 {x, y}\n * @param {Object} p2 {x, y}\n * @param {Array} [props] containing x and y keys\n * @return {Number} distance\n */\nfunction getDistance(p1, p2, props) {\n    if (!props) {\n        props = PROPS_XY;\n    }\n    var x = p2[props[0]] - p1[props[0]],\n        y = p2[props[1]] - p1[props[1]];\n\n    return Math.sqrt((x * x) + (y * y));\n}\n\n/**\n * calculate the angle between two coordinates\n * @param {Object} p1\n * @param {Object} p2\n * @param {Array} [props] containing x and y keys\n * @return {Number} angle\n */\nfunction getAngle(p1, p2, props) {\n    if (!props) {\n        props = PROPS_XY;\n    }\n    var x = p2[props[0]] - p1[props[0]],\n        y = p2[props[1]] - p1[props[1]];\n    return Math.atan2(y, x) * 180 / Math.PI;\n}\n\n/**\n * calculate the rotation degrees between two pointersets\n * @param {Array} start array of pointers\n * @param {Array} end array of pointers\n * @return {Number} rotation\n */\nfunction getRotation(start, end) {\n    return getAngle(end[1], end[0], PROPS_CLIENT_XY) + getAngle(start[1], start[0], PROPS_CLIENT_XY);\n}\n\n/**\n * calculate the scale factor between two pointersets\n * no scale is 1, and goes down to 0 when pinched together, and bigger when pinched out\n * @param {Array} start array of pointers\n * @param {Array} end array of pointers\n * @return {Number} scale\n */\nfunction getScale(start, end) {\n    return getDistance(end[0], end[1], PROPS_CLIENT_XY) / getDistance(start[0], start[1], PROPS_CLIENT_XY);\n}\n\nvar MOUSE_INPUT_MAP = {\n    mousedown: INPUT_START,\n    mousemove: INPUT_MOVE,\n    mouseup: INPUT_END\n};\n\nvar MOUSE_ELEMENT_EVENTS = 'mousedown';\nvar MOUSE_WINDOW_EVENTS = 'mousemove mouseup';\n\n/**\n * Mouse events input\n * @constructor\n * @extends Input\n */\nfunction MouseInput() {\n    this.evEl = MOUSE_ELEMENT_EVENTS;\n    this.evWin = MOUSE_WINDOW_EVENTS;\n\n    this.pressed = false; // mousedown state\n\n    Input.apply(this, arguments);\n}\n\ninherit(MouseInput, Input, {\n    /**\n     * handle mouse events\n     * @param {Object} ev\n     */\n    handler: function MEhandler(ev) {\n        var eventType = MOUSE_INPUT_MAP[ev.type];\n\n        // on start we want to have the left mouse button down\n        if (eventType & INPUT_START && ev.button === 0) {\n            this.pressed = true;\n        }\n\n        if (eventType & INPUT_MOVE && ev.which !== 1) {\n            eventType = INPUT_END;\n        }\n\n        // mouse must be down\n        if (!this.pressed) {\n            return;\n        }\n\n        if (eventType & INPUT_END) {\n            this.pressed = false;\n        }\n\n        this.callback(this.manager, eventType, {\n            pointers: [ev],\n            changedPointers: [ev],\n            pointerType: INPUT_TYPE_MOUSE,\n            srcEvent: ev\n        });\n    }\n});\n\nvar POINTER_INPUT_MAP = {\n    pointerdown: INPUT_START,\n    pointermove: INPUT_MOVE,\n    pointerup: INPUT_END,\n    pointercancel: INPUT_CANCEL,\n    pointerout: INPUT_CANCEL\n};\n\n// in IE10 the pointer types is defined as an enum\nvar IE10_POINTER_TYPE_ENUM = {\n    2: INPUT_TYPE_TOUCH,\n    3: INPUT_TYPE_PEN,\n    4: INPUT_TYPE_MOUSE,\n    5: INPUT_TYPE_KINECT // see https://twitter.com/jacobrossi/status/480596438489890816\n};\n\nvar POINTER_ELEMENT_EVENTS = 'pointerdown';\nvar POINTER_WINDOW_EVENTS = 'pointermove pointerup pointercancel';\n\n// IE10 has prefixed support, and case-sensitive\nif (window.MSPointerEvent && !window.PointerEvent) {\n    POINTER_ELEMENT_EVENTS = 'MSPointerDown';\n    POINTER_WINDOW_EVENTS = 'MSPointerMove MSPointerUp MSPointerCancel';\n}\n\n/**\n * Pointer events input\n * @constructor\n * @extends Input\n */\nfunction PointerEventInput() {\n    this.evEl = POINTER_ELEMENT_EVENTS;\n    this.evWin = POINTER_WINDOW_EVENTS;\n\n    Input.apply(this, arguments);\n\n    this.store = (this.manager.session.pointerEvents = []);\n}\n\ninherit(PointerEventInput, Input, {\n    /**\n     * handle mouse events\n     * @param {Object} ev\n     */\n    handler: function PEhandler(ev) {\n        var store = this.store;\n        var removePointer = false;\n\n        var eventTypeNormalized = ev.type.toLowerCase().replace('ms', '');\n        var eventType = POINTER_INPUT_MAP[eventTypeNormalized];\n        var pointerType = IE10_POINTER_TYPE_ENUM[ev.pointerType] || ev.pointerType;\n\n        var isTouch = (pointerType == INPUT_TYPE_TOUCH);\n\n        // get index of the event in the store\n        var storeIndex = inArray(store, ev.pointerId, 'pointerId');\n\n        // start and mouse must be down\n        if (eventType & INPUT_START && (ev.button === 0 || isTouch)) {\n            if (storeIndex < 0) {\n                store.push(ev);\n                storeIndex = store.length - 1;\n            }\n        } else if (eventType & (INPUT_END | INPUT_CANCEL)) {\n            removePointer = true;\n        }\n\n        // it not found, so the pointer hasn't been down (so it's probably a hover)\n        if (storeIndex < 0) {\n            return;\n        }\n\n        // update the event in the store\n        store[storeIndex] = ev;\n\n        this.callback(this.manager, eventType, {\n            pointers: store,\n            changedPointers: [ev],\n            pointerType: pointerType,\n            srcEvent: ev\n        });\n\n        if (removePointer) {\n            // remove from the store\n            store.splice(storeIndex, 1);\n        }\n    }\n});\n\nvar SINGLE_TOUCH_INPUT_MAP = {\n    touchstart: INPUT_START,\n    touchmove: INPUT_MOVE,\n    touchend: INPUT_END,\n    touchcancel: INPUT_CANCEL\n};\n\nvar SINGLE_TOUCH_TARGET_EVENTS = 'touchstart';\nvar SINGLE_TOUCH_WINDOW_EVENTS = 'touchstart touchmove touchend touchcancel';\n\n/**\n * Touch events input\n * @constructor\n * @extends Input\n */\nfunction SingleTouchInput() {\n    this.evTarget = SINGLE_TOUCH_TARGET_EVENTS;\n    this.evWin = SINGLE_TOUCH_WINDOW_EVENTS;\n    this.started = false;\n\n    Input.apply(this, arguments);\n}\n\ninherit(SingleTouchInput, Input, {\n    handler: function TEhandler(ev) {\n        var type = SINGLE_TOUCH_INPUT_MAP[ev.type];\n\n        // should we handle the touch events?\n        if (type === INPUT_START) {\n            this.started = true;\n        }\n\n        if (!this.started) {\n            return;\n        }\n\n        var touches = normalizeSingleTouches.call(this, ev, type);\n\n        // when done, reset the started state\n        if (type & (INPUT_END | INPUT_CANCEL) && touches[0].length - touches[1].length === 0) {\n            this.started = false;\n        }\n\n        this.callback(this.manager, type, {\n            pointers: touches[0],\n            changedPointers: touches[1],\n            pointerType: INPUT_TYPE_TOUCH,\n            srcEvent: ev\n        });\n    }\n});\n\n/**\n * @this {TouchInput}\n * @param {Object} ev\n * @param {Number} type flag\n * @returns {undefined|Array} [all, changed]\n */\nfunction normalizeSingleTouches(ev, type) {\n    var all = toArray(ev.touches);\n    var changed = toArray(ev.changedTouches);\n\n    if (type & (INPUT_END | INPUT_CANCEL)) {\n        all = uniqueArray(all.concat(changed), 'identifier', true);\n    }\n\n    return [all, changed];\n}\n\nvar TOUCH_INPUT_MAP = {\n    touchstart: INPUT_START,\n    touchmove: INPUT_MOVE,\n    touchend: INPUT_END,\n    touchcancel: INPUT_CANCEL\n};\n\nvar TOUCH_TARGET_EVENTS = 'touchstart touchmove touchend touchcancel';\n\n/**\n * Multi-user touch events input\n * @constructor\n * @extends Input\n */\nfunction TouchInput() {\n    this.evTarget = TOUCH_TARGET_EVENTS;\n    this.targetIds = {};\n\n    Input.apply(this, arguments);\n}\n\ninherit(TouchInput, Input, {\n    handler: function MTEhandler(ev) {\n        var type = TOUCH_INPUT_MAP[ev.type];\n        var touches = getTouches.call(this, ev, type);\n        if (!touches) {\n            return;\n        }\n\n        this.callback(this.manager, type, {\n            pointers: touches[0],\n            changedPointers: touches[1],\n            pointerType: INPUT_TYPE_TOUCH,\n            srcEvent: ev\n        });\n    }\n});\n\n/**\n * @this {TouchInput}\n * @param {Object} ev\n * @param {Number} type flag\n * @returns {undefined|Array} [all, changed]\n */\nfunction getTouches(ev, type) {\n    var allTouches = toArray(ev.touches);\n    var targetIds = this.targetIds;\n\n    // when there is only one touch, the process can be simplified\n    if (type & (INPUT_START | INPUT_MOVE) && allTouches.length === 1) {\n        targetIds[allTouches[0].identifier] = true;\n        return [allTouches, allTouches];\n    }\n\n    var i,\n        targetTouches,\n        changedTouches = toArray(ev.changedTouches),\n        changedTargetTouches = [],\n        target = this.target;\n\n    // get target touches from touches\n    targetTouches = allTouches.filter(function(touch) {\n        return hasParent(touch.target, target);\n    });\n\n    // collect touches\n    if (type === INPUT_START) {\n        i = 0;\n        while (i < targetTouches.length) {\n            targetIds[targetTouches[i].identifier] = true;\n            i++;\n        }\n    }\n\n    // filter changed touches to only contain touches that exist in the collected target ids\n    i = 0;\n    while (i < changedTouches.length) {\n        if (targetIds[changedTouches[i].identifier]) {\n            changedTargetTouches.push(changedTouches[i]);\n        }\n\n        // cleanup removed touches\n        if (type & (INPUT_END | INPUT_CANCEL)) {\n            delete targetIds[changedTouches[i].identifier];\n        }\n        i++;\n    }\n\n    if (!changedTargetTouches.length) {\n        return;\n    }\n\n    return [\n        // merge targetTouches with changedTargetTouches so it contains ALL touches, including 'end' and 'cancel'\n        uniqueArray(targetTouches.concat(changedTargetTouches), 'identifier', true),\n        changedTargetTouches\n    ];\n}\n\n/**\n * Combined touch and mouse input\n *\n * Touch has a higher priority then mouse, and while touching no mouse events are allowed.\n * This because touch devices also emit mouse events while doing a touch.\n *\n * @constructor\n * @extends Input\n */\n\nvar DEDUP_TIMEOUT = 2500;\nvar DEDUP_DISTANCE = 25;\n\nfunction TouchMouseInput() {\n    Input.apply(this, arguments);\n\n    var handler = bindFn(this.handler, this);\n    this.touch = new TouchInput(this.manager, handler);\n    this.mouse = new MouseInput(this.manager, handler);\n\n    this.primaryTouch = null;\n    this.lastTouches = [];\n}\n\ninherit(TouchMouseInput, Input, {\n    /**\n     * handle mouse and touch events\n     * @param {Hammer} manager\n     * @param {String} inputEvent\n     * @param {Object} inputData\n     */\n    handler: function TMEhandler(manager, inputEvent, inputData) {\n        var isTouch = (inputData.pointerType == INPUT_TYPE_TOUCH),\n            isMouse = (inputData.pointerType == INPUT_TYPE_MOUSE);\n\n        if (isMouse && inputData.sourceCapabilities && inputData.sourceCapabilities.firesTouchEvents) {\n            return;\n        }\n\n        // when we're in a touch event, record touches to  de-dupe synthetic mouse event\n        if (isTouch) {\n            recordTouches.call(this, inputEvent, inputData);\n        } else if (isMouse && isSyntheticEvent.call(this, inputData)) {\n            return;\n        }\n\n        this.callback(manager, inputEvent, inputData);\n    },\n\n    /**\n     * remove the event listeners\n     */\n    destroy: function destroy() {\n        this.touch.destroy();\n        this.mouse.destroy();\n    }\n});\n\nfunction recordTouches(eventType, eventData) {\n    if (eventType & INPUT_START) {\n        this.primaryTouch = eventData.changedPointers[0].identifier;\n        setLastTouch.call(this, eventData);\n    } else if (eventType & (INPUT_END | INPUT_CANCEL)) {\n        setLastTouch.call(this, eventData);\n    }\n}\n\nfunction setLastTouch(eventData) {\n    var touch = eventData.changedPointers[0];\n\n    if (touch.identifier === this.primaryTouch) {\n        var lastTouch = {x: touch.clientX, y: touch.clientY};\n        this.lastTouches.push(lastTouch);\n        var lts = this.lastTouches;\n        var removeLastTouch = function() {\n            var i = lts.indexOf(lastTouch);\n            if (i > -1) {\n                lts.splice(i, 1);\n            }\n        };\n        setTimeout(removeLastTouch, DEDUP_TIMEOUT);\n    }\n}\n\nfunction isSyntheticEvent(eventData) {\n    var x = eventData.srcEvent.clientX, y = eventData.srcEvent.clientY;\n    for (var i = 0; i < this.lastTouches.length; i++) {\n        var t = this.lastTouches[i];\n        var dx = Math.abs(x - t.x), dy = Math.abs(y - t.y);\n        if (dx <= DEDUP_DISTANCE && dy <= DEDUP_DISTANCE) {\n            return true;\n        }\n    }\n    return false;\n}\n\nvar PREFIXED_TOUCH_ACTION = prefixed(TEST_ELEMENT.style, 'touchAction');\nvar NATIVE_TOUCH_ACTION = PREFIXED_TOUCH_ACTION !== undefined;\n\n// magical touchAction value\nvar TOUCH_ACTION_COMPUTE = 'compute';\nvar TOUCH_ACTION_AUTO = 'auto';\nvar TOUCH_ACTION_MANIPULATION = 'manipulation'; // not implemented\nvar TOUCH_ACTION_NONE = 'none';\nvar TOUCH_ACTION_PAN_X = 'pan-x';\nvar TOUCH_ACTION_PAN_Y = 'pan-y';\nvar TOUCH_ACTION_MAP = getTouchActionProps();\n\n/**\n * Touch Action\n * sets the touchAction property or uses the js alternative\n * @param {Manager} manager\n * @param {String} value\n * @constructor\n */\nfunction TouchAction(manager, value) {\n    this.manager = manager;\n    this.set(value);\n}\n\nTouchAction.prototype = {\n    /**\n     * set the touchAction value on the element or enable the polyfill\n     * @param {String} value\n     */\n    set: function(value) {\n        // find out the touch-action by the event handlers\n        if (value == TOUCH_ACTION_COMPUTE) {\n            value = this.compute();\n        }\n\n        if (NATIVE_TOUCH_ACTION && this.manager.element.style && TOUCH_ACTION_MAP[value]) {\n            this.manager.element.style[PREFIXED_TOUCH_ACTION] = value;\n        }\n        this.actions = value.toLowerCase().trim();\n    },\n\n    /**\n     * just re-set the touchAction value\n     */\n    update: function() {\n        this.set(this.manager.options.touchAction);\n    },\n\n    /**\n     * compute the value for the touchAction property based on the recognizer's settings\n     * @returns {String} value\n     */\n    compute: function() {\n        var actions = [];\n        each(this.manager.recognizers, function(recognizer) {\n            if (boolOrFn(recognizer.options.enable, [recognizer])) {\n                actions = actions.concat(recognizer.getTouchAction());\n            }\n        });\n        return cleanTouchActions(actions.join(' '));\n    },\n\n    /**\n     * this method is called on each input cycle and provides the preventing of the browser behavior\n     * @param {Object} input\n     */\n    preventDefaults: function(input) {\n        var srcEvent = input.srcEvent;\n        var direction = input.offsetDirection;\n\n        // if the touch action did prevented once this session\n        if (this.manager.session.prevented) {\n            srcEvent.preventDefault();\n            return;\n        }\n\n        var actions = this.actions;\n        var hasNone = inStr(actions, TOUCH_ACTION_NONE) && !TOUCH_ACTION_MAP[TOUCH_ACTION_NONE];\n        var hasPanY = inStr(actions, TOUCH_ACTION_PAN_Y) && !TOUCH_ACTION_MAP[TOUCH_ACTION_PAN_Y];\n        var hasPanX = inStr(actions, TOUCH_ACTION_PAN_X) && !TOUCH_ACTION_MAP[TOUCH_ACTION_PAN_X];\n\n        if (hasNone) {\n            //do not prevent defaults if this is a tap gesture\n\n            var isTapPointer = input.pointers.length === 1;\n            var isTapMovement = input.distance < 2;\n            var isTapTouchTime = input.deltaTime < 250;\n\n            if (isTapPointer && isTapMovement && isTapTouchTime) {\n                return;\n            }\n        }\n\n        if (hasPanX && hasPanY) {\n            // `pan-x pan-y` means browser handles all scrolling/panning, do not prevent\n            return;\n        }\n\n        if (hasNone ||\n            (hasPanY && direction & DIRECTION_HORIZONTAL) ||\n            (hasPanX && direction & DIRECTION_VERTICAL)) {\n            return this.preventSrc(srcEvent);\n        }\n    },\n\n    /**\n     * call preventDefault to prevent the browser's default behavior (scrolling in most cases)\n     * @param {Object} srcEvent\n     */\n    preventSrc: function(srcEvent) {\n        this.manager.session.prevented = true;\n        srcEvent.preventDefault();\n    }\n};\n\n/**\n * when the touchActions are collected they are not a valid value, so we need to clean things up. *\n * @param {String} actions\n * @returns {*}\n */\nfunction cleanTouchActions(actions) {\n    // none\n    if (inStr(actions, TOUCH_ACTION_NONE)) {\n        return TOUCH_ACTION_NONE;\n    }\n\n    var hasPanX = inStr(actions, TOUCH_ACTION_PAN_X);\n    var hasPanY = inStr(actions, TOUCH_ACTION_PAN_Y);\n\n    // if both pan-x and pan-y are set (different recognizers\n    // for different directions, e.g. horizontal pan but vertical swipe?)\n    // we need none (as otherwise with pan-x pan-y combined none of these\n    // recognizers will work, since the browser would handle all panning\n    if (hasPanX && hasPanY) {\n        return TOUCH_ACTION_NONE;\n    }\n\n    // pan-x OR pan-y\n    if (hasPanX || hasPanY) {\n        return hasPanX ? TOUCH_ACTION_PAN_X : TOUCH_ACTION_PAN_Y;\n    }\n\n    // manipulation\n    if (inStr(actions, TOUCH_ACTION_MANIPULATION)) {\n        return TOUCH_ACTION_MANIPULATION;\n    }\n\n    return TOUCH_ACTION_AUTO;\n}\n\nfunction getTouchActionProps() {\n    if (!NATIVE_TOUCH_ACTION) {\n        return false;\n    }\n    var touchMap = {};\n    var cssSupports = window.CSS && window.CSS.supports;\n    ['auto', 'manipulation', 'pan-y', 'pan-x', 'pan-x pan-y', 'none'].forEach(function(val) {\n\n        // If css.supports is not supported but there is native touch-action assume it supports\n        // all values. This is the case for IE 10 and 11.\n        touchMap[val] = cssSupports ? window.CSS.supports('touch-action', val) : true;\n    });\n    return touchMap;\n}\n\n/**\n * Recognizer flow explained; *\n * All recognizers have the initial state of POSSIBLE when a input session starts.\n * The definition of a input session is from the first input until the last input, with all it's movement in it. *\n * Example session for mouse-input: mousedown -> mousemove -> mouseup\n *\n * On each recognizing cycle (see Manager.recognize) the .recognize() method is executed\n * which determines with state it should be.\n *\n * If the recognizer has the state FAILED, CANCELLED or RECOGNIZED (equals ENDED), it is reset to\n * POSSIBLE to give it another change on the next cycle.\n *\n *               Possible\n *                  |\n *            +-----+---------------+\n *            |                     |\n *      +-----+-----+               |\n *      |           |               |\n *   Failed      Cancelled          |\n *                          +-------+------+\n *                          |              |\n *                      Recognized       Began\n *                                         |\n *                                      Changed\n *                                         |\n *                                  Ended/Recognized\n */\nvar STATE_POSSIBLE = 1;\nvar STATE_BEGAN = 2;\nvar STATE_CHANGED = 4;\nvar STATE_ENDED = 8;\nvar STATE_RECOGNIZED = STATE_ENDED;\nvar STATE_CANCELLED = 16;\nvar STATE_FAILED = 32;\n\n/**\n * Recognizer\n * Every recognizer needs to extend from this class.\n * @constructor\n * @param {Object} options\n */\nfunction Recognizer(options) {\n    this.options = assign({}, this.defaults, options || {});\n\n    this.id = uniqueId();\n\n    this.manager = null;\n\n    // default is enable true\n    this.options.enable = ifUndefined(this.options.enable, true);\n\n    this.state = STATE_POSSIBLE;\n\n    this.simultaneous = {};\n    this.requireFail = [];\n}\n\nRecognizer.prototype = {\n    /**\n     * @virtual\n     * @type {Object}\n     */\n    defaults: {},\n\n    /**\n     * set options\n     * @param {Object} options\n     * @return {Recognizer}\n     */\n    set: function(options) {\n        assign(this.options, options);\n\n        // also update the touchAction, in case something changed about the directions/enabled state\n        this.manager && this.manager.touchAction.update();\n        return this;\n    },\n\n    /**\n     * recognize simultaneous with an other recognizer.\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    recognizeWith: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'recognizeWith', this)) {\n            return this;\n        }\n\n        var simultaneous = this.simultaneous;\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        if (!simultaneous[otherRecognizer.id]) {\n            simultaneous[otherRecognizer.id] = otherRecognizer;\n            otherRecognizer.recognizeWith(this);\n        }\n        return this;\n    },\n\n    /**\n     * drop the simultaneous link. it doesnt remove the link on the other recognizer.\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    dropRecognizeWith: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'dropRecognizeWith', this)) {\n            return this;\n        }\n\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        delete this.simultaneous[otherRecognizer.id];\n        return this;\n    },\n\n    /**\n     * recognizer can only run when an other is failing\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    requireFailure: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'requireFailure', this)) {\n            return this;\n        }\n\n        var requireFail = this.requireFail;\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        if (inArray(requireFail, otherRecognizer) === -1) {\n            requireFail.push(otherRecognizer);\n            otherRecognizer.requireFailure(this);\n        }\n        return this;\n    },\n\n    /**\n     * drop the requireFailure link. it does not remove the link on the other recognizer.\n     * @param {Recognizer} otherRecognizer\n     * @returns {Recognizer} this\n     */\n    dropRequireFailure: function(otherRecognizer) {\n        if (invokeArrayArg(otherRecognizer, 'dropRequireFailure', this)) {\n            return this;\n        }\n\n        otherRecognizer = getRecognizerByNameIfManager(otherRecognizer, this);\n        var index = inArray(this.requireFail, otherRecognizer);\n        if (index > -1) {\n            this.requireFail.splice(index, 1);\n        }\n        return this;\n    },\n\n    /**\n     * has require failures boolean\n     * @returns {boolean}\n     */\n    hasRequireFailures: function() {\n        return this.requireFail.length > 0;\n    },\n\n    /**\n     * if the recognizer can recognize simultaneous with an other recognizer\n     * @param {Recognizer} otherRecognizer\n     * @returns {Boolean}\n     */\n    canRecognizeWith: function(otherRecognizer) {\n        return !!this.simultaneous[otherRecognizer.id];\n    },\n\n    /**\n     * You should use `tryEmit` instead of `emit` directly to check\n     * that all the needed recognizers has failed before emitting.\n     * @param {Object} input\n     */\n    emit: function(input) {\n        var self = this;\n        var state = this.state;\n\n        function emit(event) {\n            self.manager.emit(event, input);\n        }\n\n        // 'panstart' and 'panmove'\n        if (state < STATE_ENDED) {\n            emit(self.options.event + stateStr(state));\n        }\n\n        emit(self.options.event); // simple 'eventName' events\n\n        if (input.additionalEvent) { // additional event(panleft, panright, pinchin, pinchout...)\n            emit(input.additionalEvent);\n        }\n\n        // panend and pancancel\n        if (state >= STATE_ENDED) {\n            emit(self.options.event + stateStr(state));\n        }\n    },\n\n    /**\n     * Check that all the require failure recognizers has failed,\n     * if true, it emits a gesture event,\n     * otherwise, setup the state to FAILED.\n     * @param {Object} input\n     */\n    tryEmit: function(input) {\n        if (this.canEmit()) {\n            return this.emit(input);\n        }\n        // it's failing anyway\n        this.state = STATE_FAILED;\n    },\n\n    /**\n     * can we emit?\n     * @returns {boolean}\n     */\n    canEmit: function() {\n        var i = 0;\n        while (i < this.requireFail.length) {\n            if (!(this.requireFail[i].state & (STATE_FAILED | STATE_POSSIBLE))) {\n                return false;\n            }\n            i++;\n        }\n        return true;\n    },\n\n    /**\n     * update the recognizer\n     * @param {Object} inputData\n     */\n    recognize: function(inputData) {\n        // make a new copy of the inputData\n        // so we can change the inputData without messing up the other recognizers\n        var inputDataClone = assign({}, inputData);\n\n        // is is enabled and allow recognizing?\n        if (!boolOrFn(this.options.enable, [this, inputDataClone])) {\n            this.reset();\n            this.state = STATE_FAILED;\n            return;\n        }\n\n        // reset when we've reached the end\n        if (this.state & (STATE_RECOGNIZED | STATE_CANCELLED | STATE_FAILED)) {\n            this.state = STATE_POSSIBLE;\n        }\n\n        this.state = this.process(inputDataClone);\n\n        // the recognizer has recognized a gesture\n        // so trigger an event\n        if (this.state & (STATE_BEGAN | STATE_CHANGED | STATE_ENDED | STATE_CANCELLED)) {\n            this.tryEmit(inputDataClone);\n        }\n    },\n\n    /**\n     * return the state of the recognizer\n     * the actual recognizing happens in this method\n     * @virtual\n     * @param {Object} inputData\n     * @returns {Const} STATE\n     */\n    process: function(inputData) { }, // jshint ignore:line\n\n    /**\n     * return the preferred touch-action\n     * @virtual\n     * @returns {Array}\n     */\n    getTouchAction: function() { },\n\n    /**\n     * called when the gesture isn't allowed to recognize\n     * like when another is being recognized or it is disabled\n     * @virtual\n     */\n    reset: function() { }\n};\n\n/**\n * get a usable string, used as event postfix\n * @param {Const} state\n * @returns {String} state\n */\nfunction stateStr(state) {\n    if (state & STATE_CANCELLED) {\n        return 'cancel';\n    } else if (state & STATE_ENDED) {\n        return 'end';\n    } else if (state & STATE_CHANGED) {\n        return 'move';\n    } else if (state & STATE_BEGAN) {\n        return 'start';\n    }\n    return '';\n}\n\n/**\n * direction cons to string\n * @param {Const} direction\n * @returns {String}\n */\nfunction directionStr(direction) {\n    if (direction == DIRECTION_DOWN) {\n        return 'down';\n    } else if (direction == DIRECTION_UP) {\n        return 'up';\n    } else if (direction == DIRECTION_LEFT) {\n        return 'left';\n    } else if (direction == DIRECTION_RIGHT) {\n        return 'right';\n    }\n    return '';\n}\n\n/**\n * get a recognizer by name if it is bound to a manager\n * @param {Recognizer|String} otherRecognizer\n * @param {Recognizer} recognizer\n * @returns {Recognizer}\n */\nfunction getRecognizerByNameIfManager(otherRecognizer, recognizer) {\n    var manager = recognizer.manager;\n    if (manager) {\n        return manager.get(otherRecognizer);\n    }\n    return otherRecognizer;\n}\n\n/**\n * This recognizer is just used as a base for the simple attribute recognizers.\n * @constructor\n * @extends Recognizer\n */\nfunction AttrRecognizer() {\n    Recognizer.apply(this, arguments);\n}\n\ninherit(AttrRecognizer, Recognizer, {\n    /**\n     * @namespace\n     * @memberof AttrRecognizer\n     */\n    defaults: {\n        /**\n         * @type {Number}\n         * @default 1\n         */\n        pointers: 1\n    },\n\n    /**\n     * Used to check if it the recognizer receives valid input, like input.distance > 10.\n     * @memberof AttrRecognizer\n     * @param {Object} input\n     * @returns {Boolean} recognized\n     */\n    attrTest: function(input) {\n        var optionPointers = this.options.pointers;\n        return optionPointers === 0 || input.pointers.length === optionPointers;\n    },\n\n    /**\n     * Process the input and return the state for the recognizer\n     * @memberof AttrRecognizer\n     * @param {Object} input\n     * @returns {*} State\n     */\n    process: function(input) {\n        var state = this.state;\n        var eventType = input.eventType;\n\n        var isRecognized = state & (STATE_BEGAN | STATE_CHANGED);\n        var isValid = this.attrTest(input);\n\n        // on cancel input and we've recognized before, return STATE_CANCELLED\n        if (isRecognized && (eventType & INPUT_CANCEL || !isValid)) {\n            return state | STATE_CANCELLED;\n        } else if (isRecognized || isValid) {\n            if (eventType & INPUT_END) {\n                return state | STATE_ENDED;\n            } else if (!(state & STATE_BEGAN)) {\n                return STATE_BEGAN;\n            }\n            return state | STATE_CHANGED;\n        }\n        return STATE_FAILED;\n    }\n});\n\n/**\n * Pan\n * Recognized when the pointer is down and moved in the allowed direction.\n * @constructor\n * @extends AttrRecognizer\n */\nfunction PanRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n\n    this.pX = null;\n    this.pY = null;\n}\n\ninherit(PanRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof PanRecognizer\n     */\n    defaults: {\n        event: 'pan',\n        threshold: 10,\n        pointers: 1,\n        direction: DIRECTION_ALL\n    },\n\n    getTouchAction: function() {\n        var direction = this.options.direction;\n        var actions = [];\n        if (direction & DIRECTION_HORIZONTAL) {\n            actions.push(TOUCH_ACTION_PAN_Y);\n        }\n        if (direction & DIRECTION_VERTICAL) {\n            actions.push(TOUCH_ACTION_PAN_X);\n        }\n        return actions;\n    },\n\n    directionTest: function(input) {\n        var options = this.options;\n        var hasMoved = true;\n        var distance = input.distance;\n        var direction = input.direction;\n        var x = input.deltaX;\n        var y = input.deltaY;\n\n        // lock to axis?\n        if (!(direction & options.direction)) {\n            if (options.direction & DIRECTION_HORIZONTAL) {\n                direction = (x === 0) ? DIRECTION_NONE : (x < 0) ? DIRECTION_LEFT : DIRECTION_RIGHT;\n                hasMoved = x != this.pX;\n                distance = Math.abs(input.deltaX);\n            } else {\n                direction = (y === 0) ? DIRECTION_NONE : (y < 0) ? DIRECTION_UP : DIRECTION_DOWN;\n                hasMoved = y != this.pY;\n                distance = Math.abs(input.deltaY);\n            }\n        }\n        input.direction = direction;\n        return hasMoved && distance > options.threshold && direction & options.direction;\n    },\n\n    attrTest: function(input) {\n        return AttrRecognizer.prototype.attrTest.call(this, input) &&\n            (this.state & STATE_BEGAN || (!(this.state & STATE_BEGAN) && this.directionTest(input)));\n    },\n\n    emit: function(input) {\n\n        this.pX = input.deltaX;\n        this.pY = input.deltaY;\n\n        var direction = directionStr(input.direction);\n\n        if (direction) {\n            input.additionalEvent = this.options.event + direction;\n        }\n        this._super.emit.call(this, input);\n    }\n});\n\n/**\n * Pinch\n * Recognized when two or more pointers are moving toward (zoom-in) or away from each other (zoom-out).\n * @constructor\n * @extends AttrRecognizer\n */\nfunction PinchRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n}\n\ninherit(PinchRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof PinchRecognizer\n     */\n    defaults: {\n        event: 'pinch',\n        threshold: 0,\n        pointers: 2\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_NONE];\n    },\n\n    attrTest: function(input) {\n        return this._super.attrTest.call(this, input) &&\n            (Math.abs(input.scale - 1) > this.options.threshold || this.state & STATE_BEGAN);\n    },\n\n    emit: function(input) {\n        if (input.scale !== 1) {\n            var inOut = input.scale < 1 ? 'in' : 'out';\n            input.additionalEvent = this.options.event + inOut;\n        }\n        this._super.emit.call(this, input);\n    }\n});\n\n/**\n * Press\n * Recognized when the pointer is down for x ms without any movement.\n * @constructor\n * @extends Recognizer\n */\nfunction PressRecognizer() {\n    Recognizer.apply(this, arguments);\n\n    this._timer = null;\n    this._input = null;\n}\n\ninherit(PressRecognizer, Recognizer, {\n    /**\n     * @namespace\n     * @memberof PressRecognizer\n     */\n    defaults: {\n        event: 'press',\n        pointers: 1,\n        time: 251, // minimal time of the pointer to be pressed\n        threshold: 9 // a minimal movement is ok, but keep it low\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_AUTO];\n    },\n\n    process: function(input) {\n        var options = this.options;\n        var validPointers = input.pointers.length === options.pointers;\n        var validMovement = input.distance < options.threshold;\n        var validTime = input.deltaTime > options.time;\n\n        this._input = input;\n\n        // we only allow little movement\n        // and we've reached an end event, so a tap is possible\n        if (!validMovement || !validPointers || (input.eventType & (INPUT_END | INPUT_CANCEL) && !validTime)) {\n            this.reset();\n        } else if (input.eventType & INPUT_START) {\n            this.reset();\n            this._timer = setTimeoutContext(function() {\n                this.state = STATE_RECOGNIZED;\n                this.tryEmit();\n            }, options.time, this);\n        } else if (input.eventType & INPUT_END) {\n            return STATE_RECOGNIZED;\n        }\n        return STATE_FAILED;\n    },\n\n    reset: function() {\n        clearTimeout(this._timer);\n    },\n\n    emit: function(input) {\n        if (this.state !== STATE_RECOGNIZED) {\n            return;\n        }\n\n        if (input && (input.eventType & INPUT_END)) {\n            this.manager.emit(this.options.event + 'up', input);\n        } else {\n            this._input.timeStamp = now();\n            this.manager.emit(this.options.event, this._input);\n        }\n    }\n});\n\n/**\n * Rotate\n * Recognized when two or more pointer are moving in a circular motion.\n * @constructor\n * @extends AttrRecognizer\n */\nfunction RotateRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n}\n\ninherit(RotateRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof RotateRecognizer\n     */\n    defaults: {\n        event: 'rotate',\n        threshold: 0,\n        pointers: 2\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_NONE];\n    },\n\n    attrTest: function(input) {\n        return this._super.attrTest.call(this, input) &&\n            (Math.abs(input.rotation) > this.options.threshold || this.state & STATE_BEGAN);\n    }\n});\n\n/**\n * Swipe\n * Recognized when the pointer is moving fast (velocity), with enough distance in the allowed direction.\n * @constructor\n * @extends AttrRecognizer\n */\nfunction SwipeRecognizer() {\n    AttrRecognizer.apply(this, arguments);\n}\n\ninherit(SwipeRecognizer, AttrRecognizer, {\n    /**\n     * @namespace\n     * @memberof SwipeRecognizer\n     */\n    defaults: {\n        event: 'swipe',\n        threshold: 10,\n        velocity: 0.3,\n        direction: DIRECTION_HORIZONTAL | DIRECTION_VERTICAL,\n        pointers: 1\n    },\n\n    getTouchAction: function() {\n        return PanRecognizer.prototype.getTouchAction.call(this);\n    },\n\n    attrTest: function(input) {\n        var direction = this.options.direction;\n        var velocity;\n\n        if (direction & (DIRECTION_HORIZONTAL | DIRECTION_VERTICAL)) {\n            velocity = input.overallVelocity;\n        } else if (direction & DIRECTION_HORIZONTAL) {\n            velocity = input.overallVelocityX;\n        } else if (direction & DIRECTION_VERTICAL) {\n            velocity = input.overallVelocityY;\n        }\n\n        return this._super.attrTest.call(this, input) &&\n            direction & input.offsetDirection &&\n            input.distance > this.options.threshold &&\n            input.maxPointers == this.options.pointers &&\n            abs(velocity) > this.options.velocity && input.eventType & INPUT_END;\n    },\n\n    emit: function(input) {\n        var direction = directionStr(input.offsetDirection);\n        if (direction) {\n            this.manager.emit(this.options.event + direction, input);\n        }\n\n        this.manager.emit(this.options.event, input);\n    }\n});\n\n/**\n * A tap is ecognized when the pointer is doing a small tap/click. Multiple taps are recognized if they occur\n * between the given interval and position. The delay option can be used to recognize multi-taps without firing\n * a single tap.\n *\n * The eventData from the emitted event contains the property `tapCount`, which contains the amount of\n * multi-taps being recognized.\n * @constructor\n * @extends Recognizer\n */\nfunction TapRecognizer() {\n    Recognizer.apply(this, arguments);\n\n    // previous time and center,\n    // used for tap counting\n    this.pTime = false;\n    this.pCenter = false;\n\n    this._timer = null;\n    this._input = null;\n    this.count = 0;\n}\n\ninherit(TapRecognizer, Recognizer, {\n    /**\n     * @namespace\n     * @memberof PinchRecognizer\n     */\n    defaults: {\n        event: 'tap',\n        pointers: 1,\n        taps: 1,\n        interval: 300, // max time between the multi-tap taps\n        time: 250, // max time of the pointer to be down (like finger on the screen)\n        threshold: 9, // a minimal movement is ok, but keep it low\n        posThreshold: 10 // a multi-tap can be a bit off the initial position\n    },\n\n    getTouchAction: function() {\n        return [TOUCH_ACTION_MANIPULATION];\n    },\n\n    process: function(input) {\n        var options = this.options;\n\n        var validPointers = input.pointers.length === options.pointers;\n        var validMovement = input.distance < options.threshold;\n        var validTouchTime = input.deltaTime < options.time;\n\n        this.reset();\n\n        if ((input.eventType & INPUT_START) && (this.count === 0)) {\n            return this.failTimeout();\n        }\n\n        // we only allow little movement\n        // and we've reached an end event, so a tap is possible\n        if (validMovement && validTouchTime && validPointers) {\n            if (input.eventType != INPUT_END) {\n                return this.failTimeout();\n            }\n\n            var validInterval = this.pTime ? (input.timeStamp - this.pTime < options.interval) : true;\n            var validMultiTap = !this.pCenter || getDistance(this.pCenter, input.center) < options.posThreshold;\n\n            this.pTime = input.timeStamp;\n            this.pCenter = input.center;\n\n            if (!validMultiTap || !validInterval) {\n                this.count = 1;\n            } else {\n                this.count += 1;\n            }\n\n            this._input = input;\n\n            // if tap count matches we have recognized it,\n            // else it has began recognizing...\n            var tapCount = this.count % options.taps;\n            if (tapCount === 0) {\n                // no failing requirements, immediately trigger the tap event\n                // or wait as long as the multitap interval to trigger\n                if (!this.hasRequireFailures()) {\n                    return STATE_RECOGNIZED;\n                } else {\n                    this._timer = setTimeoutContext(function() {\n                        this.state = STATE_RECOGNIZED;\n                        this.tryEmit();\n                    }, options.interval, this);\n                    return STATE_BEGAN;\n                }\n            }\n        }\n        return STATE_FAILED;\n    },\n\n    failTimeout: function() {\n        this._timer = setTimeoutContext(function() {\n            this.state = STATE_FAILED;\n        }, this.options.interval, this);\n        return STATE_FAILED;\n    },\n\n    reset: function() {\n        clearTimeout(this._timer);\n    },\n\n    emit: function() {\n        if (this.state == STATE_RECOGNIZED) {\n            this._input.tapCount = this.count;\n            this.manager.emit(this.options.event, this._input);\n        }\n    }\n});\n\n/**\n * Simple way to create a manager with a default set of recognizers.\n * @param {HTMLElement} element\n * @param {Object} [options]\n * @constructor\n */\nfunction Hammer(element, options) {\n    options = options || {};\n    options.recognizers = ifUndefined(options.recognizers, Hammer.defaults.preset);\n    return new Manager(element, options);\n}\n\n/**\n * @const {string}\n */\nHammer.VERSION = '2.0.7';\n\n/**\n * default settings\n * @namespace\n */\nHammer.defaults = {\n    /**\n     * set if DOM events are being triggered.\n     * But this is slower and unused by simple implementations, so disabled by default.\n     * @type {Boolean}\n     * @default false\n     */\n    domEvents: false,\n\n    /**\n     * The value for the touchAction property/fallback.\n     * When set to `compute` it will magically set the correct value based on the added recognizers.\n     * @type {String}\n     * @default compute\n     */\n    touchAction: TOUCH_ACTION_COMPUTE,\n\n    /**\n     * @type {Boolean}\n     * @default true\n     */\n    enable: true,\n\n    /**\n     * EXPERIMENTAL FEATURE -- can be removed/changed\n     * Change the parent input target element.\n     * If Null, then it is being set the to main element.\n     * @type {Null|EventTarget}\n     * @default null\n     */\n    inputTarget: null,\n\n    /**\n     * force an input class\n     * @type {Null|Function}\n     * @default null\n     */\n    inputClass: null,\n\n    /**\n     * Default recognizer setup when calling `Hammer()`\n     * When creating a new Manager these will be skipped.\n     * @type {Array}\n     */\n    preset: [\n        // RecognizerClass, options, [recognizeWith, ...], [requireFailure, ...]\n        [RotateRecognizer, {enable: false}],\n        [PinchRecognizer, {enable: false}, ['rotate']],\n        [SwipeRecognizer, {direction: DIRECTION_HORIZONTAL}],\n        [PanRecognizer, {direction: DIRECTION_HORIZONTAL}, ['swipe']],\n        [TapRecognizer],\n        [TapRecognizer, {event: 'doubletap', taps: 2}, ['tap']],\n        [PressRecognizer]\n    ],\n\n    /**\n     * Some CSS properties can be used to improve the working of Hammer.\n     * Add them to this method and they will be set when creating a new Manager.\n     * @namespace\n     */\n    cssProps: {\n        /**\n         * Disables text selection to improve the dragging gesture. Mainly for desktop browsers.\n         * @type {String}\n         * @default 'none'\n         */\n        userSelect: 'none',\n\n        /**\n         * Disable the Windows Phone grippers when pressing an element.\n         * @type {String}\n         * @default 'none'\n         */\n        touchSelect: 'none',\n\n        /**\n         * Disables the default callout shown when you touch and hold a touch target.\n         * On iOS, when you touch and hold a touch target such as a link, Safari displays\n         * a callout containing information about the link. This property allows you to disable that callout.\n         * @type {String}\n         * @default 'none'\n         */\n        touchCallout: 'none',\n\n        /**\n         * Specifies whether zooming is enabled. Used by IE10>\n         * @type {String}\n         * @default 'none'\n         */\n        contentZooming: 'none',\n\n        /**\n         * Specifies that an entire element should be draggable instead of its contents. Mainly for desktop browsers.\n         * @type {String}\n         * @default 'none'\n         */\n        userDrag: 'none',\n\n        /**\n         * Overrides the highlight color shown when the user taps a link or a JavaScript\n         * clickable element in iOS. This property obeys the alpha value, if specified.\n         * @type {String}\n         * @default 'rgba(0,0,0,0)'\n         */\n        tapHighlightColor: 'rgba(0,0,0,0)'\n    }\n};\n\nvar STOP = 1;\nvar FORCED_STOP = 2;\n\n/**\n * Manager\n * @param {HTMLElement} element\n * @param {Object} [options]\n * @constructor\n */\nfunction Manager(element, options) {\n    this.options = assign({}, Hammer.defaults, options || {});\n\n    this.options.inputTarget = this.options.inputTarget || element;\n\n    this.handlers = {};\n    this.session = {};\n    this.recognizers = [];\n    this.oldCssProps = {};\n\n    this.element = element;\n    this.input = createInputInstance(this);\n    this.touchAction = new TouchAction(this, this.options.touchAction);\n\n    toggleCssProps(this, true);\n\n    each(this.options.recognizers, function(item) {\n        var recognizer = this.add(new (item[0])(item[1]));\n        item[2] && recognizer.recognizeWith(item[2]);\n        item[3] && recognizer.requireFailure(item[3]);\n    }, this);\n}\n\nManager.prototype = {\n    /**\n     * set options\n     * @param {Object} options\n     * @returns {Manager}\n     */\n    set: function(options) {\n        assign(this.options, options);\n\n        // Options that need a little more setup\n        if (options.touchAction) {\n            this.touchAction.update();\n        }\n        if (options.inputTarget) {\n            // Clean up existing event listeners and reinitialize\n            this.input.destroy();\n            this.input.target = options.inputTarget;\n            this.input.init();\n        }\n        return this;\n    },\n\n    /**\n     * stop recognizing for this session.\n     * This session will be discarded, when a new [input]start event is fired.\n     * When forced, the recognizer cycle is stopped immediately.\n     * @param {Boolean} [force]\n     */\n    stop: function(force) {\n        this.session.stopped = force ? FORCED_STOP : STOP;\n    },\n\n    /**\n     * run the recognizers!\n     * called by the inputHandler function on every movement of the pointers (touches)\n     * it walks through all the recognizers and tries to detect the gesture that is being made\n     * @param {Object} inputData\n     */\n    recognize: function(inputData) {\n        var session = this.session;\n        if (session.stopped) {\n            return;\n        }\n\n        // run the touch-action polyfill\n        this.touchAction.preventDefaults(inputData);\n\n        var recognizer;\n        var recognizers = this.recognizers;\n\n        // this holds the recognizer that is being recognized.\n        // so the recognizer's state needs to be BEGAN, CHANGED, ENDED or RECOGNIZED\n        // if no recognizer is detecting a thing, it is set to `null`\n        var curRecognizer = session.curRecognizer;\n\n        // reset when the last recognizer is recognized\n        // or when we're in a new session\n        if (!curRecognizer || (curRecognizer && curRecognizer.state & STATE_RECOGNIZED)) {\n            curRecognizer = session.curRecognizer = null;\n        }\n\n        var i = 0;\n        while (i < recognizers.length) {\n            recognizer = recognizers[i];\n\n            // find out if we are allowed try to recognize the input for this one.\n            // 1.   allow if the session is NOT forced stopped (see the .stop() method)\n            // 2.   allow if we still haven't recognized a gesture in this session, or the this recognizer is the one\n            //      that is being recognized.\n            // 3.   allow if the recognizer is allowed to run simultaneous with the current recognized recognizer.\n            //      this can be setup with the `recognizeWith()` method on the recognizer.\n            if (session.stopped !== FORCED_STOP && ( // 1\n                    !curRecognizer || recognizer == curRecognizer || // 2\n                    recognizer.canRecognizeWith(curRecognizer))) { // 3\n                recognizer.recognize(inputData);\n            } else {\n                recognizer.reset();\n            }\n\n            // if the recognizer has been recognizing the input as a valid gesture, we want to store this one as the\n            // current active recognizer. but only if we don't already have an active recognizer\n            if (!curRecognizer && recognizer.state & (STATE_BEGAN | STATE_CHANGED | STATE_ENDED)) {\n                curRecognizer = session.curRecognizer = recognizer;\n            }\n            i++;\n        }\n    },\n\n    /**\n     * get a recognizer by its event name.\n     * @param {Recognizer|String} recognizer\n     * @returns {Recognizer|Null}\n     */\n    get: function(recognizer) {\n        if (recognizer instanceof Recognizer) {\n            return recognizer;\n        }\n\n        var recognizers = this.recognizers;\n        for (var i = 0; i < recognizers.length; i++) {\n            if (recognizers[i].options.event == recognizer) {\n                return recognizers[i];\n            }\n        }\n        return null;\n    },\n\n    /**\n     * add a recognizer to the manager\n     * existing recognizers with the same event name will be removed\n     * @param {Recognizer} recognizer\n     * @returns {Recognizer|Manager}\n     */\n    add: function(recognizer) {\n        if (invokeArrayArg(recognizer, 'add', this)) {\n            return this;\n        }\n\n        // remove existing\n        var existing = this.get(recognizer.options.event);\n        if (existing) {\n            this.remove(existing);\n        }\n\n        this.recognizers.push(recognizer);\n        recognizer.manager = this;\n\n        this.touchAction.update();\n        return recognizer;\n    },\n\n    /**\n     * remove a recognizer by name or instance\n     * @param {Recognizer|String} recognizer\n     * @returns {Manager}\n     */\n    remove: function(recognizer) {\n        if (invokeArrayArg(recognizer, 'remove', this)) {\n            return this;\n        }\n\n        recognizer = this.get(recognizer);\n\n        // let's make sure this recognizer exists\n        if (recognizer) {\n            var recognizers = this.recognizers;\n            var index = inArray(recognizers, recognizer);\n\n            if (index !== -1) {\n                recognizers.splice(index, 1);\n                this.touchAction.update();\n            }\n        }\n\n        return this;\n    },\n\n    /**\n     * bind event\n     * @param {String} events\n     * @param {Function} handler\n     * @returns {EventEmitter} this\n     */\n    on: function(events, handler) {\n        if (events === undefined) {\n            return;\n        }\n        if (handler === undefined) {\n            return;\n        }\n\n        var handlers = this.handlers;\n        each(splitStr(events), function(event) {\n            handlers[event] = handlers[event] || [];\n            handlers[event].push(handler);\n        });\n        return this;\n    },\n\n    /**\n     * unbind event, leave emit blank to remove all handlers\n     * @param {String} events\n     * @param {Function} [handler]\n     * @returns {EventEmitter} this\n     */\n    off: function(events, handler) {\n        if (events === undefined) {\n            return;\n        }\n\n        var handlers = this.handlers;\n        each(splitStr(events), function(event) {\n            if (!handler) {\n                delete handlers[event];\n            } else {\n                handlers[event] && handlers[event].splice(inArray(handlers[event], handler), 1);\n            }\n        });\n        return this;\n    },\n\n    /**\n     * emit event to the listeners\n     * @param {String} event\n     * @param {Object} data\n     */\n    emit: function(event, data) {\n        // we also want to trigger dom events\n        if (this.options.domEvents) {\n            triggerDomEvent(event, data);\n        }\n\n        // no handlers, so skip it all\n        var handlers = this.handlers[event] && this.handlers[event].slice();\n        if (!handlers || !handlers.length) {\n            return;\n        }\n\n        data.type = event;\n        data.preventDefault = function() {\n            data.srcEvent.preventDefault();\n        };\n\n        var i = 0;\n        while (i < handlers.length) {\n            handlers[i](data);\n            i++;\n        }\n    },\n\n    /**\n     * destroy the manager and unbinds all events\n     * it doesn't unbind dom events, that is the user own responsibility\n     */\n    destroy: function() {\n        this.element && toggleCssProps(this, false);\n\n        this.handlers = {};\n        this.session = {};\n        this.input.destroy();\n        this.element = null;\n    }\n};\n\n/**\n * add/remove the css properties as defined in manager.options.cssProps\n * @param {Manager} manager\n * @param {Boolean} add\n */\nfunction toggleCssProps(manager, add) {\n    var element = manager.element;\n    if (!element.style) {\n        return;\n    }\n    var prop;\n    each(manager.options.cssProps, function(value, name) {\n        prop = prefixed(element.style, name);\n        if (add) {\n            manager.oldCssProps[prop] = element.style[prop];\n            element.style[prop] = value;\n        } else {\n            element.style[prop] = manager.oldCssProps[prop] || '';\n        }\n    });\n    if (!add) {\n        manager.oldCssProps = {};\n    }\n}\n\n/**\n * trigger dom event\n * @param {String} event\n * @param {Object} data\n */\nfunction triggerDomEvent(event, data) {\n    var gestureEvent = document.createEvent('Event');\n    gestureEvent.initEvent(event, true, true);\n    gestureEvent.gesture = data;\n    data.target.dispatchEvent(gestureEvent);\n}\n\nassign(Hammer, {\n    INPUT_START: INPUT_START,\n    INPUT_MOVE: INPUT_MOVE,\n    INPUT_END: INPUT_END,\n    INPUT_CANCEL: INPUT_CANCEL,\n\n    STATE_POSSIBLE: STATE_POSSIBLE,\n    STATE_BEGAN: STATE_BEGAN,\n    STATE_CHANGED: STATE_CHANGED,\n    STATE_ENDED: STATE_ENDED,\n    STATE_RECOGNIZED: STATE_RECOGNIZED,\n    STATE_CANCELLED: STATE_CANCELLED,\n    STATE_FAILED: STATE_FAILED,\n\n    DIRECTION_NONE: DIRECTION_NONE,\n    DIRECTION_LEFT: DIRECTION_LEFT,\n    DIRECTION_RIGHT: DIRECTION_RIGHT,\n    DIRECTION_UP: DIRECTION_UP,\n    DIRECTION_DOWN: DIRECTION_DOWN,\n    DIRECTION_HORIZONTAL: DIRECTION_HORIZONTAL,\n    DIRECTION_VERTICAL: DIRECTION_VERTICAL,\n    DIRECTION_ALL: DIRECTION_ALL,\n\n    Manager: Manager,\n    Input: Input,\n    TouchAction: TouchAction,\n\n    TouchInput: TouchInput,\n    MouseInput: MouseInput,\n    PointerEventInput: PointerEventInput,\n    TouchMouseInput: TouchMouseInput,\n    SingleTouchInput: SingleTouchInput,\n\n    Recognizer: Recognizer,\n    AttrRecognizer: AttrRecognizer,\n    Tap: TapRecognizer,\n    Pan: PanRecognizer,\n    Swipe: SwipeRecognizer,\n    Pinch: PinchRecognizer,\n    Rotate: RotateRecognizer,\n    Press: PressRecognizer,\n\n    on: addEventListeners,\n    off: removeEventListeners,\n    each: each,\n    merge: merge,\n    extend: extend,\n    assign: assign,\n    inherit: inherit,\n    bindFn: bindFn,\n    prefixed: prefixed\n});\n\n// this prevents errors when Hammer is loaded in the presence of an AMD\n//  style loader but by script tag, not by the loader.\nvar freeGlobal = (typeof window !== 'undefined' ? window : (typeof self !== 'undefined' ? self : {})); // jshint ignore:line\nfreeGlobal.Hammer = Hammer;\n\nif (typeof define === 'function' && define.amd) {\n    define(function() {\n        return Hammer;\n    });\n} else if (typeof module != 'undefined' && module.exports) {\n    module.exports = Hammer;\n} else {\n    window[exportName] = Hammer;\n}\n\n})(window, document, 'Hammer');\n","import { PointerButton } from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\n\nimport type { Bucket } from '../util/buckets';\n\nexport type BucketsProps = {\n  /**\n   * Bucket containing the $tags of any annotations that are offscreen above\n   * the current viewport. If the set of $tags is non-empty, up navigation\n   * will be rendered.\n   */\n  above: Bucket;\n\n  /**\n   * Bucket containing the $tags of any annotations that are offscreen below\n   * the current viewport. If the set of $tags is non-empty, down navigation\n   * will be rendered.\n   */\n  below: Bucket;\n\n  /**\n   * A list of buckets visible on-screen. A left-pointing arrow will be\n   * rendered for each bucket.\n   */\n  buckets: Bucket[];\n  onFocusAnnotations: ($tags: string[]) => void;\n  onScrollToClosestOffScreenAnchor: (\n    $tags: string[],\n    direction: 'down' | 'up'\n  ) => void;\n  onSelectAnnotations: ($tags: string[], toggle: boolean) => void;\n};\n\n/**\n * A list of buckets, including up and down navigation (when applicable) and\n * on-screen buckets\n *\n * This component and its buttons are sized with absolute units such that they\n * don't scale with changes to the host page's root font size. They will still\n * properly scale with user/browser zooming.\n */\nexport default function Buckets({\n  above,\n  below,\n  buckets,\n  onFocusAnnotations,\n  onScrollToClosestOffScreenAnchor,\n  onSelectAnnotations,\n}: BucketsProps) {\n  const showUpNavigation = above.tags.size > 0;\n  const showDownNavigation = below.tags.size > 0;\n\n  return (\n    <ul\n      className={classnames(\n        // 2020-11-20: Making bucket bar one pixel wider (23px vs 22px) is an\n        // interim and pragmatic solution for an apparent glitch on\n        // Safari and Chrome. Adding one pixel resolves this issue:\n        // https://github.com/hypothesis/client/pull/2750\n        'absolute w-[23px] left-[-22px] h-full',\n        // The background is set to low opacity when the sidebar is collapsed.\n        'bg-grey-2 sidebar-collapsed:bg-black/[.08]',\n        // Disable pointer events along the sidebar itself; re-enable them in\n        // the list elements containing bucket buttons\n        'pointer-events-none'\n      )}\n    >\n      {showUpNavigation && (\n        <li\n          className=\"absolute right-0 pointer-events-auto mt-[-11px]\"\n          style={{ top: above.position }}\n        >\n          <PointerButton\n            data-testid=\"up-navigation-button\"\n            direction=\"up\"\n            onClick={() =>\n              onScrollToClosestOffScreenAnchor([...above.tags], 'up')\n            }\n            onBlur={() => onFocusAnnotations([])}\n            onFocus={() => onFocusAnnotations([...above.tags])}\n            onMouseEnter={() => onFocusAnnotations([...above.tags])}\n            onMouseOut={() => onFocusAnnotations([])}\n            title={`Go up to next annotations (${above.tags.size})`}\n          >\n            {above.tags.size}\n          </PointerButton>\n        </li>\n      )}\n      {buckets.map((bucket, index) => (\n        <li\n          className=\"absolute right-0 pointer-events-auto mt-[-8px]\"\n          key={index}\n          style={{ top: bucket.position }}\n        >\n          <PointerButton\n            direction=\"left\"\n            onClick={event =>\n              onSelectAnnotations(\n                [...bucket.tags],\n                event.metaKey || event.ctrlKey\n              )\n            }\n            onBlur={() => onFocusAnnotations([])}\n            onFocus={() => onFocusAnnotations([...bucket.tags])}\n            onMouseEnter={() => onFocusAnnotations([...bucket.tags])}\n            onMouseOut={() => onFocusAnnotations([])}\n            title={`Select nearby annotations (${bucket.tags.size})`}\n          >\n            {bucket.tags.size}\n          </PointerButton>\n        </li>\n      ))}\n      {showDownNavigation && (\n        <li\n          className=\"absolute right-0 pointer-events-auto\"\n          style={{ top: below.position }}\n        >\n          <PointerButton\n            data-testid=\"down-navigation-button\"\n            direction=\"down\"\n            onClick={() =>\n              onScrollToClosestOffScreenAnchor([...below.tags], 'down')\n            }\n            onBlur={() => onFocusAnnotations([])}\n            onFocus={() => onFocusAnnotations([...below.tags])}\n            onMouseEnter={() => onFocusAnnotations([...below.tags])}\n            onMouseOut={() => onFocusAnnotations([])}\n            title={`Go up to next annotations (${below.tags.size})`}\n          >\n            {below.tags.size}\n          </PointerButton>\n        </li>\n      )}\n    </ul>\n  );\n}\n","import { render } from 'preact';\n\nimport type { AnchorPosition, Destroyable } from '../types/annotator';\nimport Buckets from './components/Buckets';\nimport { computeBuckets } from './util/buckets';\n\nexport type BucketBarOptions = {\n  onFocusAnnotations: (tags: string[]) => void;\n  onScrollToClosestOffScreenAnchor: (\n    tags: string[],\n    direction: 'down' | 'up'\n  ) => void;\n  onSelectAnnotations: (tags: string[], toggle: boolean) => void;\n};\n\n/**\n * Controller for the \"bucket bar\" shown alongside the sidebar indicating where\n * annotations are in the document.\n */\nexport class BucketBar implements Destroyable {\n  private _bucketsContainer: HTMLDivElement;\n  private _onFocusAnnotations: BucketBarOptions['onFocusAnnotations'];\n  private _onScrollToClosestOffScreenAnchor: BucketBarOptions['onScrollToClosestOffScreenAnchor'];\n  private _onSelectAnnotations: BucketBarOptions['onSelectAnnotations'];\n\n  constructor(\n    container: HTMLElement,\n    {\n      onFocusAnnotations,\n      onScrollToClosestOffScreenAnchor,\n      onSelectAnnotations,\n    }: BucketBarOptions\n  ) {\n    this._bucketsContainer = document.createElement('div');\n    container.appendChild(this._bucketsContainer);\n\n    this._onFocusAnnotations = onFocusAnnotations;\n    this._onScrollToClosestOffScreenAnchor = onScrollToClosestOffScreenAnchor;\n    this._onSelectAnnotations = onSelectAnnotations;\n\n    // Immediately render the bucket bar\n    this.update([]);\n  }\n\n  destroy() {\n    render(null, this._bucketsContainer);\n    this._bucketsContainer.remove();\n  }\n\n  update(positions: AnchorPosition[]) {\n    const buckets = computeBuckets(positions);\n    render(\n      <Buckets\n        above={buckets.above}\n        below={buckets.below}\n        buckets={buckets.buckets}\n        onFocusAnnotations={tags => this._onFocusAnnotations(tags)}\n        onScrollToClosestOffScreenAnchor={(tags, direction) =>\n          this._onScrollToClosestOffScreenAnchor(tags, direction)\n        }\n        onSelectAnnotations={(tags, toogle) =>\n          this._onSelectAnnotations(tags, toogle)\n        }\n      />,\n      this._bucketsContainer\n    );\n  }\n}\n","import {\n  Card,\n  Link,\n  CancelIcon,\n  CautionIcon,\n  CheckIcon,\n} from '@hypothesis/frontend-shared/lib/next';\nimport classnames from 'classnames';\n\nexport type ToastMessage = {\n  type: 'error' | 'success' | 'notice';\n  id: string;\n  message: string;\n  moreInfoURL: string;\n  isDismissed: boolean;\n  visuallyHidden: boolean;\n};\n\ntype ToastMessageItemProps = {\n  message: ToastMessage;\n  onDismiss: (id: string) => void;\n};\n\n/**\n * An individual toast message: a brief and transient success or error message.\n * The message may be dismissed by clicking on it. `visuallyHidden` toast\n * messages will not be visible but are still available to screen readers.\n */\nfunction ToastMessageItem({ message, onDismiss }: ToastMessageItemProps) {\n  // Capitalize the message type for prepending; Don't prepend a message\n  // type for \"notice\" messages\n  const prefix =\n    message.type !== 'notice'\n      ? `${message.type.charAt(0).toUpperCase() + message.type.slice(1)}: `\n      : '';\n\n  let Icon;\n  switch (message.type) {\n    case 'success':\n      Icon = CheckIcon;\n      break;\n    case 'error':\n      Icon = CancelIcon;\n      break;\n    case 'notice':\n    default:\n      Icon = CautionIcon;\n      break;\n  }\n  /**\n   * a11y linting is disabled here: There is a click-to-remove handler on a\n   * non-interactive element. This allows sighted users to get the toast message\n   * out of their way if it interferes with interacting with the underlying\n   * components. This shouldn't pose the same irritation to users with screen-\n   * readers as the rendered toast messages shouldn't impede interacting with\n   * the underlying document.\n   */\n  return (\n    /* eslint-disable-next-line jsx-a11y/click-events-have-key-events, jsx-a11y/no-noninteractive-element-interactions */\n    <Card\n      classes={classnames('flex', {\n        'sr-only': message.visuallyHidden,\n        'border-red-error': message.type === 'error',\n        'border-yellow-notice': message.type === 'notice',\n        'border-green-success': message.type === 'success',\n      })}\n      onClick={() => onDismiss(message.id)}\n    >\n      <div\n        className={classnames('flex items-center p-3 text-white', {\n          'bg-red-error': message.type === 'error',\n          'bg-yellow-notice': message.type === 'notice',\n          'bg-green-success': message.type === 'success',\n        })}\n      >\n        <Icon\n          className={classnames(\n            // Adjust alignment of icon to appear more aligned with text\n            'mt-[2px]'\n          )}\n        />\n      </div>\n      <div className=\"grow p-3\" data-testid=\"toast-message-text\">\n        <strong>{prefix}</strong>\n        {message.message}\n        {message.moreInfoURL && (\n          <div className=\"text-right\">\n            <Link\n              href={message.moreInfoURL}\n              onClick={\n                event =>\n                  event.stopPropagation() /* consume the event so that it does not dismiss the message */\n              }\n              target=\"_new\"\n            >\n              More info\n            </Link>\n          </div>\n        )}\n      </div>\n    </Card>\n  );\n}\n\nexport type BaseToastMessageProps = {\n  messages: ToastMessage[];\n  onMessageDismiss: (messageId: string) => void;\n};\n\n/**\n * A collection of toast messages. These are rendered within an `aria-live`\n * region for accessibility with screen readers.\n */\nexport default function BaseToastMessages({\n  messages,\n  onMessageDismiss,\n}: BaseToastMessageProps) {\n  // The `ul` containing any toast messages is absolute-positioned and the full\n  // width of the viewport. Each toast message `li` has its position and width\n  // constrained by `container` configuration in tailwind.\n  return (\n    <div>\n      <ul\n        aria-live=\"polite\"\n        aria-relevant=\"additions\"\n        className=\"absolute z-2 left-0 w-full\"\n      >\n        {messages.map(message => (\n          <li\n            className={classnames(\n              'relative w-full container hover:cursor-pointer',\n              {\n                // Add a bottom margin to visible messages only. Typically, we'd\n                // use a `space-y-2` class on the parent to space children.\n                // Doing that here could cause an undesired top margin on\n                // the first visible message in a list that contains (only)\n                // visually-hidden messages before it.\n                // See https://tailwindcss.com/docs/space#limitations\n                'mb-2': !message.visuallyHidden,\n                // Slide in from right in narrow viewports; fade in larger\n                // viewports to toast message isn't flying too far\n                'motion-safe:animate-slide-in-from-right lg:animate-fade-in':\n                  !message.isDismissed,\n                // Only ever fade in if motion-reduction is preferred\n                'motion-reduce:animate-fade-in': !message.isDismissed,\n                'animate-fade-out': message.isDismissed,\n              }\n            )}\n            key={message.id}\n          >\n            <ToastMessageItem message={message} onDismiss={onMessageDismiss} />\n          </li>\n        ))}\n      </ul>\n    </div>\n  );\n}\n","import { useCallback, useEffect, useState } from 'preact/hooks';\n\nimport BaseToastMessages from '../../shared/components/BaseToastMessages';\nimport type { ToastMessage } from '../../shared/components/BaseToastMessages';\nimport type { Emitter } from '../util/emitter';\n\nexport type ToastMessagesProps = {\n  emitter: Emitter;\n};\n\n/**\n * A component that renders toast messages published from the sidebar, in a way\n * that they \"appear\" in the viewport even when the sidebar is collapsed.\n * This is useful to make sure screen readers announce hidden messages.\n */\nexport default function ToastMessages({ emitter }: ToastMessagesProps) {\n  const [messages, setMessages] = useState<ToastMessage[]>([]);\n  const addMessage = useCallback(\n    (newMessage: ToastMessage) => setMessages(prev => [...prev, newMessage]),\n    []\n  );\n  const dismissMessage = useCallback(\n    (messageId: string) =>\n      setMessages(prev => prev.filter(message => message.id !== messageId)),\n    []\n  );\n\n  useEffect(() => {\n    emitter.subscribe('toastMessageAdded', addMessage);\n    emitter.subscribe('toastMessageDismissed', dismissMessage);\n\n    return () => {\n      emitter.unsubscribe('toastMessageAdded', addMessage);\n      emitter.unsubscribe('toastMessageDismissed', dismissMessage);\n    };\n  }, [emitter, dismissMessage, addMessage]);\n\n  return (\n    <BaseToastMessages messages={messages} onMessageDismiss={dismissMessage} />\n  );\n}\n","import type { ButtonCommonProps } from '@hypothesis/frontend-shared/lib/components/input/ButtonBase';\nimport {\n  ButtonBase,\n  AnnotateIcon,\n  CancelIcon,\n  CaretRightIcon,\n  CaretLeftIcon,\n  HideIcon,\n  NoteIcon,\n  ShowIcon,\n} from '@hypothesis/frontend-shared/lib/next';\nimport type {\n  IconComponent,\n  PresentationalProps,\n} from '@hypothesis/frontend-shared/lib/types';\nimport classnames from 'classnames';\nimport type { JSX, RefObject } from 'preact';\n\n// TODO: ToolbarButton should be extracted as a shared design pattern or\n// component\ntype ToolbarButtonProps = PresentationalProps &\n  ButtonCommonProps &\n  Omit<JSX.HTMLAttributes<HTMLButtonElement>, 'icon' | 'size'> & {\n    icon: IconComponent;\n  };\n\n/**\n * Style an IconButton for use on the Toolbar\n */\nfunction ToolbarButton({ icon: Icon, ...buttonProps }: ToolbarButtonProps) {\n  return (\n    <ButtonBase\n      classes={classnames(\n        'w-[30px] h-[30px]', // These buttons have precise dimensions\n        'rounded-px', // size of border radius in absolute units\n        'flex items-center justify-center',\n        'border bg-white text-grey-6 hover:text-grey-9',\n        'shadow transition-colors'\n      )}\n      {...buttonProps}\n    >\n      <Icon />\n    </ButtonBase>\n  );\n}\n\n/**\n * Hidden component that announces certain Hypothesis states.\n *\n * This is useful to inform assistive technology users when these states\n * have been changed (eg. whether highlights are visible), given that they can\n * be changed in multiple ways (keyboard shortcuts, toolbar button) etc.\n */\nfunction StatusNotifier({ highlightsVisible }: { highlightsVisible: boolean }) {\n  return (\n    <div className=\"sr-only\" role=\"status\" data-testid=\"toolbar-status\">\n      {highlightsVisible ? 'Highlights visible' : 'Highlights hidden'}\n    </div>\n  );\n}\n\nexport type ToolbarProps = {\n  /**\n   * Callback for the \"Close sidebar\" button. This button is only shown when\n   * `useMinimalControls` is true and the sidebar is open.\n   */\n  closeSidebar: () => void;\n\n  /** Callback for when \"Create annotation\" button is clicked. */\n  createAnnotation: () => void;\n\n  /** Is the sidebar currently open? */\n  isSidebarOpen: boolean;\n\n  /**\n   * Informs which icon to show on the \"Create annotation\" button and what type\n   * of annotation should be created by the `createAnnotation` callback. The\n   * type of annotation depends on whether there is a text selection in the\n   * document.\n   */\n  newAnnotationType: 'annotation' | 'note';\n\n  /** Are highlights currently visible in the document? */\n  showHighlights: boolean;\n\n  /** Callback for the show/hide highlights button */\n  toggleHighlights: () => void;\n\n  /**\n   * Callback for toggling the visibility of the sidebar when the show/hide\n   * sidebar button is clicked\n   */\n  toggleSidebar: () => void;\n\n  /**\n   * Ref to apply to the show/hide-sidebar button. This is exposed to enable\n   * drag-to-resize functionality.\n   */\n  toggleSidebarRef?: RefObject<HTMLElement>;\n\n  /**\n   * When true, all controls are hidden except for the \"Close sidebar\" button\n   * when the sidebar is open. This is enabled for the \"clean\" theme.\n   */\n  useMinimalControls?: boolean;\n};\n\n/**\n * Controls on the edge of the sidebar for opening/closing the sidebar,\n * controlling highlight visibility and creating new page notes.\n *\n * This component and its buttons are sized with absolute units such that they\n * don't scale with changes to the host page's root font size. They will still\n * properly scale with user/browser zooming.\n */\nexport default function Toolbar({\n  closeSidebar,\n  createAnnotation,\n  isSidebarOpen,\n  newAnnotationType,\n  showHighlights,\n  toggleHighlights,\n  toggleSidebar,\n  toggleSidebarRef,\n  useMinimalControls = false,\n}: ToolbarProps) {\n  return (\n    <div\n      className={classnames(\n        'absolute left-[-33px] w-[33px] z-2',\n        'text-px-base leading-none' // non-scaling sizing\n      )}\n    >\n      {/* In the clean theme (`useMinimalControls` is `true`),\n          the only button that should appear is a button\n          to close the sidebar, and only if the sidebar is open. This button is\n          absolutely positioned some way down the edge of the sidebar.\n      */}\n      {useMinimalControls && isSidebarOpen && (\n        <ButtonBase\n          classes={classnames(\n            'w-[27px] h-[27px] mt-[140px] ml-px-1.5',\n            'flex items-center justify-center bg-white border',\n            'text-grey-6 hover:text-grey-9 transition-colors',\n            // Turn off right border to blend with sidebar\n            'border-r-0',\n            // A more intense shadow than other ToolbarButtons, to match that\n            // of the edge of the sidebar in clean theme\n            'shadow-sidebar'\n          )}\n          title=\"Close annotation sidebar\"\n          onClick={closeSidebar}\n        >\n          <CancelIcon />\n        </ButtonBase>\n      )}\n      {!useMinimalControls && (\n        <>\n          <ButtonBase\n            classes={classnames(\n              // Height and width to align with the sidebar's top bar\n              'h-[40px] w-[33px] pl-[6px]',\n              'bg-white text-grey-5 hover:text-grey-9',\n              // Turn on left and bottom borders to continue the\n              // border of the sidebar's top bar\n              'border-l border-b'\n            )}\n            elementRef={toggleSidebarRef}\n            title=\"Annotation sidebar\"\n            expanded={isSidebarOpen}\n            pressed={isSidebarOpen}\n            onClick={toggleSidebar}\n          >\n            {isSidebarOpen ? <CaretRightIcon /> : <CaretLeftIcon />}\n          </ButtonBase>\n          <div className=\"space-y-px-1.5 mt-px-2\">\n            <ToolbarButton\n              title=\"Show highlights\"\n              icon={showHighlights ? ShowIcon : HideIcon}\n              selected={showHighlights}\n              onClick={toggleHighlights}\n            />\n            <ToolbarButton\n              title={\n                newAnnotationType === 'note'\n                  ? 'New page note'\n                  : 'New annotation'\n              }\n              icon={newAnnotationType === 'note' ? NoteIcon : AnnotateIcon}\n              onClick={createAnnotation}\n            />\n          </div>\n          <StatusNotifier highlightsVisible={showHighlights} />\n        </>\n      )}\n    </div>\n  );\n}\n","import { createRef, render } from 'preact';\nimport type { RefObject } from 'preact';\n\nimport Toolbar from './components/Toolbar';\n\nexport type ToolbarOptions = {\n  createAnnotation: () => void;\n  setSidebarOpen: (open: boolean) => void;\n  setHighlightsVisible: (visible: boolean) => void;\n};\n\n/**\n * Controller for the toolbar on the edge of the sidebar.\n *\n * This toolbar provides controls for opening and closing the sidebar, toggling\n * highlight visibility etc.\n */\nexport class ToolbarController {\n  private _container: HTMLElement;\n  private _newAnnotationType: 'annotation' | 'note';\n  private _useMinimalControls: boolean;\n  private _highlightsVisible: boolean;\n  private _sidebarOpen: boolean;\n  private _closeSidebar: () => void;\n  private _toggleSidebar: () => void;\n  private _toggleHighlights: () => void;\n  private _createAnnotation: () => void;\n  private _sidebarToggleButton: RefObject<HTMLElement>;\n\n  /**\n   * @param container - Element into which the toolbar is rendered\n   */\n  constructor(container: HTMLElement, options: ToolbarOptions) {\n    const { createAnnotation, setSidebarOpen, setHighlightsVisible } = options;\n\n    this._container = container;\n    this._useMinimalControls = false;\n    this._newAnnotationType = 'note';\n    this._highlightsVisible = false;\n    this._sidebarOpen = false;\n\n    this._closeSidebar = () => setSidebarOpen(false);\n    this._toggleSidebar = () => setSidebarOpen(!this._sidebarOpen);\n    this._toggleHighlights = () =>\n      setHighlightsVisible(!this._highlightsVisible);\n    this._createAnnotation = () => {\n      createAnnotation();\n      setSidebarOpen(true);\n    };\n\n    /** Reference to the sidebar toggle button. */\n    this._sidebarToggleButton = createRef<HTMLElement>();\n\n    this.render();\n  }\n\n  getWidth() {\n    const content = this._container.firstChild as HTMLElement;\n    return content.getBoundingClientRect().width;\n  }\n\n  /**\n   * Set whether the toolbar is in the \"minimal controls\" mode where\n   * only the \"Close\" button is shown.\n   */\n  set useMinimalControls(minimal) {\n    this._useMinimalControls = minimal;\n    this.render();\n  }\n\n  get useMinimalControls() {\n    return this._useMinimalControls;\n  }\n\n  /**\n   * Update the toolbar to reflect whether the sidebar is open or not.\n   */\n  set sidebarOpen(open) {\n    this._sidebarOpen = open;\n    this.render();\n  }\n\n  get sidebarOpen() {\n    return this._sidebarOpen;\n  }\n\n  /**\n   * Update the toolbar to reflect whether the \"Create annotation\" button will\n   * create a page note (if there is no selection) or an annotation (if there is\n   * a selection).\n   */\n  set newAnnotationType(type) {\n    this._newAnnotationType = type;\n    this.render();\n  }\n\n  get newAnnotationType() {\n    return this._newAnnotationType;\n  }\n\n  /**\n   * Update the toolbar to reflect whether highlights are currently visible.\n   */\n  set highlightsVisible(visible) {\n    this._highlightsVisible = visible;\n    this.render();\n  }\n\n  get highlightsVisible() {\n    return this._highlightsVisible;\n  }\n\n  /**\n   * Return the DOM element that toggles the sidebar's visibility.\n   */\n  get sidebarToggleButton() {\n    return this._sidebarToggleButton.current as HTMLButtonElement;\n  }\n\n  render() {\n    render(\n      <Toolbar\n        closeSidebar={this._closeSidebar}\n        createAnnotation={this._createAnnotation}\n        newAnnotationType={this._newAnnotationType}\n        isSidebarOpen={this._sidebarOpen}\n        showHighlights={this._highlightsVisible}\n        toggleHighlights={this._toggleHighlights}\n        toggleSidebar={this._toggleSidebar}\n        toggleSidebarRef={this._sidebarToggleButton}\n        useMinimalControls={this.useMinimalControls}\n      />,\n      this._container\n    );\n  }\n}\n","import * as Hammer from 'hammerjs';\nimport { render } from 'preact';\n\nimport type { ToastMessage } from '../shared/components/BaseToastMessages';\nimport { addConfigFragment } from '../shared/config-fragment';\nimport { sendErrorsTo } from '../shared/frame-error-capture';\nimport { ListenerCollection } from '../shared/listener-collection';\nimport { PortRPC } from '../shared/messaging';\nimport type {\n  AnchorPosition,\n  SidebarLayout,\n  Destroyable,\n} from '../types/annotator';\nimport type { Service } from '../types/config';\nimport type {\n  GuestToHostEvent,\n  HostToGuestEvent,\n  HostToSidebarEvent,\n  SidebarToHostEvent,\n} from '../types/port-rpc-events';\nimport { annotationCounts } from './annotation-counts';\nimport { BucketBar } from './bucket-bar';\nimport ToastMessages from './components/ToastMessages';\nimport { createAppConfig } from './config/app';\nimport { FeatureFlags } from './features';\nimport { sidebarTrigger } from './sidebar-trigger';\nimport { ToolbarController } from './toolbar';\nimport type { Emitter, EventBus } from './util/emitter';\nimport { createShadowRoot } from './util/shadow-root';\n\n// Minimum width to which the iframeContainer can be resized.\nexport const MIN_RESIZE = 280;\n\n/**\n * Client configuration used to launch the sidebar application.\n *\n * This includes the URL for the iframe and configuration to pass to the\n * application on launch.\n */\nexport type SidebarConfig = { sidebarAppUrl: string } & Record<string, unknown>;\n\n/**\n * Client configuration used by the sidebar container ({@link Sidebar}).\n */\nexport type SidebarContainerConfig = {\n  /**\n   * Details of the annotation service the client should connect to.\n   * This includes callbacks provided by the host page to handle certain actions\n   * in the sidebar (eg. the Login button).\n   */\n  services?: Service[];\n\n  /**\n   * CSS selector of a container element in the host page which the sidebar\n   * should be added into, instead of creating a new container.\n   */\n  externalContainerSelector?: string;\n\n  /**\n   * Callback that allows the host page to react to the sidebar being opened,\n   * closed or resized\n   */\n  onLayoutChange?: (layout: SidebarLayout) => void;\n};\n\n/**\n * Create the iframe that will load the sidebar application.\n */\nfunction createSidebarIframe(config: SidebarConfig): HTMLIFrameElement {\n  const sidebarURL = config.sidebarAppUrl;\n  const sidebarAppSrc = addConfigFragment(\n    sidebarURL,\n    createAppConfig(sidebarURL, config)\n  );\n\n  const sidebarFrame = document.createElement('iframe');\n\n  // Enable media in annotations to be shown fullscreen\n  sidebarFrame.setAttribute('allowfullscreen', '');\n\n  sidebarFrame.src = sidebarAppSrc;\n  sidebarFrame.title = 'Hypothesis annotation viewer';\n  sidebarFrame.className = 'sidebar-frame';\n\n  return sidebarFrame;\n}\n\ntype GestureState = {\n  /** Initial position at the start of a drag/pan resize event (in pixels). */\n  initial: number | null;\n  /** Final position at end of drag resize event. */\n  final: number | null;\n};\n\n/**\n * The `Sidebar` class creates (1) the sidebar application iframe, (2) its container,\n * as well as (3) the adjacent controls.\n */\nexport class Sidebar implements Destroyable {\n  private _emitter: Emitter;\n  private _config: SidebarContainerConfig & SidebarConfig;\n  private _listeners: ListenerCollection;\n  private _gestureState: GestureState;\n  private _layoutState: SidebarLayout;\n  private _hammerManager: HammerManager | undefined;\n  private _hypothesisSidebar: HTMLElement | undefined;\n  private _messagesElement: HTMLElement | undefined;\n  private _toolbarWidth: number;\n  private _renderFrame: number | undefined;\n\n  /**\n   * Tracks which `Guest` has a text selection. `null` indicates to default to\n   * the first connected guest frame.\n   */\n  private _guestWithSelection: PortRPC<\n    GuestToHostEvent,\n    HostToGuestEvent\n  > | null;\n\n  /** Channel for host-sidebar communication. */\n  private _sidebarRPC: PortRPC<SidebarToHostEvent, HostToSidebarEvent>;\n\n  /** Channels for host-guest communication. */\n  private _guestRPC: PortRPC<GuestToHostEvent, HostToGuestEvent>[];\n\n  bucketBar: BucketBar | null;\n  features: FeatureFlags;\n  externalFrame: Element | undefined;\n  iframeContainer: HTMLDivElement | undefined;\n  toolbar: ToolbarController;\n  onLoginRequest: Service['onLoginRequest'];\n  onLogoutRequest: Service['onLogoutRequest'];\n  onSignupRequest: Service['onSignupRequest'];\n  onProfileRequest: Service['onProfileRequest'];\n  onHelpRequest: Service['onHelpRequest'];\n  onLayoutChange: SidebarContainerConfig['onLayoutChange'];\n\n  /** The `<iframe>` element containing the sidebar application. */\n  iframe: HTMLIFrameElement;\n\n  /**\n   * @param eventBus - Enables communication between components sharing the same\n   *                   eventBus\n   */\n  constructor(\n    element: HTMLElement,\n    eventBus: EventBus,\n    config: SidebarContainerConfig & SidebarConfig\n  ) {\n    this._emitter = eventBus.createEmitter();\n    this._guestWithSelection = null;\n    this._guestRPC = [];\n    this._sidebarRPC = new PortRPC();\n    this.iframe = createSidebarIframe(config);\n    this._config = config;\n    this.bucketBar = null;\n    this.features = new FeatureFlags();\n\n    if (config.externalContainerSelector) {\n      this.externalFrame =\n        document.querySelector(config.externalContainerSelector) ?? element;\n      this.externalFrame.appendChild(this.iframe);\n    } else {\n      this.iframeContainer = document.createElement('div');\n      this.iframeContainer.style.display = 'none';\n      this.iframeContainer.className = 'sidebar-container';\n\n      if (config.theme === 'clean') {\n        this.iframeContainer.classList.add('theme-clean');\n      } else {\n        this.bucketBar = new BucketBar(this.iframeContainer, {\n          onFocusAnnotations: tags =>\n            this._guestRPC.forEach(rpc => rpc.call('hoverAnnotations', tags)),\n          onScrollToClosestOffScreenAnchor: (tags, direction) =>\n            this._guestRPC.forEach(rpc =>\n              rpc.call('scrollToClosestOffScreenAnchor', tags, direction)\n            ),\n          onSelectAnnotations: (tags, toggle) =>\n            this._guestRPC.forEach(rpc =>\n              rpc.call('selectAnnotations', tags, toggle)\n            ),\n        });\n      }\n\n      this.iframeContainer.appendChild(this.iframe);\n\n      // Wrap up the 'iframeContainer' element into a shadow DOM, so it is not\n      // affected by host CSS styles\n      this._hypothesisSidebar = document.createElement('hypothesis-sidebar');\n      const shadowRoot = createShadowRoot(this._hypothesisSidebar);\n      shadowRoot.appendChild(this.iframeContainer);\n\n      element.appendChild(this._hypothesisSidebar);\n\n      // Render a container for toast messages in the host frame. The sidebar\n      // will forward messages to render here while it is collapsed.\n      this._messagesElement = document.createElement('div');\n      shadowRoot.appendChild(this._messagesElement);\n      render(<ToastMessages emitter={this._emitter} />, this._messagesElement);\n    }\n\n    // Register the sidebar as a handler for Hypothesis errors in this frame.\n    if (this.iframe.contentWindow) {\n      sendErrorsTo(this.iframe.contentWindow);\n    }\n\n    this._listeners = new ListenerCollection();\n\n    // Set up the toolbar on the left edge of the sidebar.\n    const toolbarContainer = document.createElement('div');\n    this.toolbar = new ToolbarController(toolbarContainer, {\n      createAnnotation: () => {\n        if (this._guestRPC.length === 0) {\n          return;\n        }\n\n        const rpc = this._guestWithSelection ?? this._guestRPC[0];\n        rpc.call('createAnnotation');\n      },\n      setSidebarOpen: open => (open ? this.open() : this.close()),\n      setHighlightsVisible: show => this.setHighlightsVisible(show),\n    });\n\n    if (config.theme === 'clean') {\n      this.toolbar.useMinimalControls = true;\n    } else {\n      this.toolbar.useMinimalControls = false;\n    }\n\n    if (this.iframeContainer) {\n      // If using our own container frame for the sidebar, add the toolbar to it.\n      this.iframeContainer.prepend(toolbarContainer);\n      this._toolbarWidth = this.toolbar.getWidth();\n    } else {\n      // If using a host-page provided container for the sidebar, the toolbar is\n      // not shown.\n      this._toolbarWidth = 0;\n    }\n\n    this._listeners.add(window, 'resize', () => this._onResize());\n\n    this._gestureState = {\n      initial: null,\n      final: null,\n    };\n    this._setupGestures();\n    this.close();\n\n    // Publisher-provided callback functions\n    const [serviceConfig] = config.services || [];\n    if (serviceConfig) {\n      this.onLoginRequest = serviceConfig.onLoginRequest;\n      this.onLogoutRequest = serviceConfig.onLogoutRequest;\n      this.onSignupRequest = serviceConfig.onSignupRequest;\n      this.onProfileRequest = serviceConfig.onProfileRequest;\n      this.onHelpRequest = serviceConfig.onHelpRequest;\n    }\n\n    this.onLayoutChange = config.onLayoutChange;\n\n    this._layoutState = {\n      expanded: false,\n      width: 0,\n      height: 0,\n      toolbarWidth: 0,\n    };\n\n    // Initial layout notification\n    this._updateLayoutState(false);\n    this._setupSidebarEvents();\n  }\n\n  destroy() {\n    this._guestRPC.forEach(rpc => rpc.destroy());\n    this._sidebarRPC.destroy();\n    this.bucketBar?.destroy();\n    this._listeners.removeAll();\n    this._hammerManager?.destroy();\n    if (this._hypothesisSidebar) {\n      // Explicitly unmounting the \"messages\" element, to make sure effects are clean-up\n      render(null, this._messagesElement!);\n      this._hypothesisSidebar.remove();\n    } else {\n      this.iframe.remove();\n    }\n    this._emitter.destroy();\n\n    // Unregister the sidebar iframe as a handler for errors in this frame.\n    sendErrorsTo(null);\n  }\n\n  /**\n   * Setup communication with a frame that has connected to the host.\n   */\n  onFrameConnected(source: 'guest' | 'sidebar', port: MessagePort) {\n    switch (source) {\n      case 'guest':\n        this._connectGuest(port);\n        break;\n      case 'sidebar':\n        this._sidebarRPC.connect(port);\n        break;\n    }\n  }\n\n  _connectGuest(port: MessagePort) {\n    const guestRPC = new PortRPC<GuestToHostEvent, HostToGuestEvent>();\n\n    guestRPC.on('textSelected', () => {\n      this._guestWithSelection = guestRPC;\n      this.toolbar.newAnnotationType = 'annotation';\n      this._guestRPC\n        .filter(port => port !== guestRPC)\n        .forEach(rpc => rpc.call('clearSelection'));\n    });\n\n    guestRPC.on('textUnselected', () => {\n      this._guestWithSelection = null;\n      this.toolbar.newAnnotationType = 'note';\n      this._guestRPC\n        .filter(port => port !== guestRPC)\n        .forEach(rpc => rpc.call('clearSelection'));\n    });\n\n    guestRPC.on('highlightsVisibleChanged', (visible: boolean) => {\n      this.setHighlightsVisible(visible);\n    });\n\n    // The listener will do nothing if the sidebar doesn't have a bucket bar\n    // (clean theme)\n    const bucketBar = this.bucketBar;\n    // Currently, we ignore `anchorsChanged` for all the guests except the first connected guest.\n    if (bucketBar) {\n      guestRPC.on('anchorsChanged', (positions: AnchorPosition[]) => {\n        if (this._guestRPC.indexOf(guestRPC) === 0) {\n          bucketBar.update(positions);\n        }\n      });\n    }\n\n    guestRPC.on('close', () => {\n      guestRPC.destroy();\n      if (guestRPC === this._guestWithSelection) {\n        this._guestWithSelection = null;\n      }\n      this._guestRPC = this._guestRPC.filter(rpc => rpc !== guestRPC);\n    });\n\n    guestRPC.connect(port);\n    this._guestRPC.push(guestRPC);\n\n    guestRPC.call('sidebarLayoutChanged', this._layoutState);\n  }\n\n  _setupSidebarEvents() {\n    annotationCounts(document.body, this._sidebarRPC);\n    sidebarTrigger(document.body, () => this.open());\n\n    this._sidebarRPC.on(\n      'featureFlagsUpdated',\n      (flags: Record<string, boolean>) => this.features.update(flags)\n    );\n\n    this._sidebarRPC.on('connect', () => {\n      // Show the UI\n      if (this.iframeContainer) {\n        this.iframeContainer.style.display = '';\n      }\n\n      const showHighlights = this._config.showHighlights === 'always';\n      this.setHighlightsVisible(showHighlights);\n\n      if (\n        this._config.openSidebar ||\n        this._config.annotations ||\n        this._config.query ||\n        this._config.group\n      ) {\n        this.open();\n      }\n    });\n\n    this._sidebarRPC.on('showHighlights', () =>\n      this.setHighlightsVisible(true)\n    );\n\n    this._sidebarRPC.on('openSidebar', () => this.open());\n\n    this._sidebarRPC.on('closeSidebar', () => this.close());\n\n    // Sidebar listens to the `openNotebook` and `openProfile` events coming\n    // from the sidebar's iframe and re-publishes them via the emitter to the\n    // Notebook/Profile\n    this._sidebarRPC.on('openNotebook', (groupId: string) => {\n      this.hide();\n      this._emitter.publish('openNotebook', groupId);\n    });\n    this._sidebarRPC.on('openProfile', () => {\n      this.hide();\n      this._emitter.publish('openProfile');\n    });\n    this._emitter.subscribe('closeProfile', () => {\n      this.show();\n    });\n\n    this._emitter.subscribe('closeNotebook', () => {\n      this.show();\n    });\n\n    // Sidebar listens to the `toastMessageAdded` and `toastMessageDismissed`\n    // events coming from the sidebar's iframe and re-publishes them via the\n    // emitter\n    this._sidebarRPC.on('toastMessageAdded', (newMessage: ToastMessage) => {\n      this._emitter.publish('toastMessageAdded', newMessage);\n    });\n    this._sidebarRPC.on('toastMessageDismissed', (messageId: string) => {\n      this._emitter.publish('toastMessageDismissed', messageId);\n    });\n\n    // Suppressing ban-types here because the functions are originally defined\n    // as `Function` somewhere else. To be fixed when that is migrated to TS\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    const eventHandlers: Array<[SidebarToHostEvent, Function | undefined]> = [\n      ['loginRequested', this.onLoginRequest],\n      ['logoutRequested', this.onLogoutRequest],\n      ['signupRequested', this.onSignupRequest],\n      ['profileRequested', this.onProfileRequest],\n      ['helpRequested', this.onHelpRequest],\n    ];\n    eventHandlers.forEach(([event, handler]) => {\n      if (handler) {\n        this._sidebarRPC.on(event, () => handler());\n      }\n    });\n  }\n\n  _resetGestureState() {\n    this._gestureState = { initial: null, final: null };\n  }\n\n  _setupGestures() {\n    const toggleButton = this.toolbar.sidebarToggleButton;\n    if (toggleButton) {\n      this._hammerManager = new Hammer.Manager(toggleButton);\n      this._hammerManager.on(\n        'panstart panend panleft panright',\n        /* istanbul ignore next */\n        event => this._onPan(event)\n      );\n      this._hammerManager.add(\n        new Hammer.Pan({ direction: Hammer.DIRECTION_HORIZONTAL })\n      );\n    }\n  }\n\n  // Schedule any changes needed to update the sidebar layout.\n  _updateLayout() {\n    // Only schedule one frame at a time.\n    if (this._renderFrame) {\n      return;\n    }\n\n    // Schedule a frame.\n    this._renderFrame = requestAnimationFrame(() => {\n      this._renderFrame = undefined;\n\n      if (\n        this._gestureState.final !== this._gestureState.initial &&\n        this.iframeContainer\n      ) {\n        const margin: number = this._gestureState.final!;\n        const width = -margin;\n        this.iframeContainer.style.marginLeft = `${margin}px`;\n        if (width >= MIN_RESIZE) {\n          this.iframeContainer.style.width = `${width}px`;\n        }\n        this._updateLayoutState();\n      }\n    });\n  }\n\n  /**\n   * Update the current layout state and notify the embedder if they provided\n   * an `onLayoutChange` callback in the Hypothesis config, as well as guests\n   * so they can enable/adapt side-by-side mode.\n   *\n   * This is called when the sidebar is opened, closed or resized.\n   *\n   * @param expanded -\n   *   `true` or `false` if the sidebar is being directly opened or closed, as\n   *   opposed to being resized via the sidebar's drag handles\n   */\n  _updateLayoutState(expanded?: boolean) {\n    // The sidebar structure is:\n    //\n    // [ Toolbar    ][                                   ]\n    // [ ---------- ][ Sidebar iframe container (@frame) ]\n    // [ Bucket Bar ][                                   ]\n    //\n    // The sidebar iframe is hidden or shown by adjusting the left margin of\n    // its container.\n\n    const toolbarWidth = (this.iframeContainer && this.toolbar.getWidth()) || 0;\n    const frame: Element = this.iframeContainer ?? this.externalFrame!;\n    const { height } = frame.getBoundingClientRect();\n    const computedStyle = window.getComputedStyle(frame);\n    const width = parseInt(computedStyle.width);\n    const leftMargin = parseInt(computedStyle.marginLeft);\n\n    // The width of the sidebar that is visible on screen, including the\n    // toolbar, which is always visible.\n    let frameVisibleWidth = toolbarWidth;\n\n    if (typeof expanded === 'boolean') {\n      if (expanded) {\n        frameVisibleWidth += width;\n      }\n    } else {\n      if (leftMargin < MIN_RESIZE) {\n        frameVisibleWidth -= leftMargin;\n      } else {\n        frameVisibleWidth += width;\n      }\n\n      // Infer expanded state based on whether at least part of the sidebar\n      // frame is visible.\n      expanded = frameVisibleWidth > toolbarWidth;\n    }\n\n    const layoutState: SidebarLayout = {\n      expanded,\n      width: expanded ? frameVisibleWidth : toolbarWidth,\n      height,\n      toolbarWidth,\n    };\n\n    this._layoutState = layoutState;\n    this.onLayoutChange?.(layoutState);\n\n    this._guestRPC.forEach(rpc =>\n      rpc.call('sidebarLayoutChanged', layoutState)\n    );\n  }\n\n  /**\n   *  On window resize events, update the marginLeft of the sidebar by calling hide/show methods.\n   */\n  _onResize() {\n    if (this.toolbar.sidebarOpen === true) {\n      if (window.innerWidth < MIN_RESIZE) {\n        this.close();\n      } else {\n        this.open();\n      }\n    }\n  }\n\n  _onPan(event: HammerInput) {\n    const frame = this.iframeContainer;\n    if (!frame) {\n      return;\n    }\n\n    switch (event.type) {\n      case 'panstart':\n        this._resetGestureState();\n\n        // Disable animated transition of sidebar position\n        frame.classList.add('sidebar-no-transition');\n\n        // Disable pointer events on the iframe.\n        frame.style.pointerEvents = 'none';\n\n        this._gestureState.initial = parseInt(\n          getComputedStyle(frame).marginLeft\n        );\n\n        break;\n      case 'panend':\n        frame.classList.remove('sidebar-no-transition');\n\n        // Re-enable pointer events on the iframe.\n        frame.style.pointerEvents = '';\n\n        // Snap open or closed.\n        if (\n          this._gestureState.final === null ||\n          this._gestureState.final <= -MIN_RESIZE\n        ) {\n          this.open();\n        } else {\n          this.close();\n        }\n        this._resetGestureState();\n        break;\n      case 'panleft':\n      case 'panright': {\n        if (typeof this._gestureState.initial !== 'number') {\n          return;\n        }\n\n        const margin = this._gestureState.initial;\n        const delta = event.deltaX;\n        this._gestureState.final = Math.min(Math.round(margin + delta), 0);\n        this._updateLayout();\n        break;\n      }\n    }\n  }\n\n  open() {\n    this._sidebarRPC.call('sidebarOpened');\n\n    if (this.iframeContainer) {\n      const width = this.iframeContainer.getBoundingClientRect().width;\n      this.iframeContainer.style.marginLeft = `${-1 * width}px`;\n      this.iframeContainer.classList.remove('sidebar-collapsed');\n    }\n\n    this.toolbar.sidebarOpen = true;\n\n    if (this._config.showHighlights === 'whenSidebarOpen') {\n      this.setHighlightsVisible(true);\n    }\n\n    this._updateLayoutState(true);\n  }\n\n  close() {\n    this._sidebarRPC.call('sidebarClosed');\n\n    if (this.iframeContainer) {\n      this.iframeContainer.style.marginLeft = '';\n      this.iframeContainer.classList.add('sidebar-collapsed');\n    }\n\n    this.toolbar.sidebarOpen = false;\n\n    if (this._config.showHighlights === 'whenSidebarOpen') {\n      this.setHighlightsVisible(false);\n    }\n\n    this._updateLayoutState(false);\n  }\n\n  /**\n   * Set whether highlights are visible in guest frames.\n   */\n  setHighlightsVisible(visible: boolean) {\n    this.toolbar.highlightsVisible = visible;\n\n    // Notify sidebar app of change which will in turn reflect state to guest frames.\n    this._sidebarRPC.call('setHighlightsVisible', visible);\n  }\n\n  /**\n   * Shows the sidebar's controls\n   */\n  show() {\n    this.iframeContainer?.classList.remove('is-hidden');\n  }\n\n  /**\n   * Hides the sidebar's controls\n   */\n  hide() {\n    this.iframeContainer?.classList.add('is-hidden');\n  }\n}\n","import type { PortRPC } from '../shared/messaging';\n\nconst ANNOTATION_COUNT_ATTR = 'data-hypothesis-annotation-count';\n\n/**\n * Show the current count of public annotations in designated elements.\n *\n * Any time the count of public annotations changes, find all elements within\n * `rootEl` that have the `data-hypothesis-annotation-count` attribute and\n * replace their text content with the current count of public annotations.\n *\n * This allows publishers to add a count of annotations to their web pages.\n *\n * See:\n * https://h.readthedocs.io/projects/client/en/latest/publishers/host-page-integration.html#cmdoption-arg-data-hypothesis-annotation-count\n *\n */\nexport function annotationCounts(\n  rootEl: Element,\n  rpc: PortRPC<'publicAnnotationCountChanged', string>\n) {\n  rpc.on('publicAnnotationCountChanged', updateAnnotationCountElems);\n\n  function updateAnnotationCountElems(newCount: number) {\n    const elems = rootEl.querySelectorAll(`[${ANNOTATION_COUNT_ATTR}]`);\n    Array.from(elems).forEach(elem => {\n      elem.textContent = newCount.toString();\n    });\n  }\n}\n","const SIDEBAR_TRIGGER_BTN_ATTR = 'data-hypothesis-trigger';\n\n/**\n * Show the sidebar when user clicks on an element with the\n * trigger data attribute.\n *\n * @param rootEl - The DOM element which contains the trigger elements.\n * @param showFn - Function which shows the sidebar.\n */\nexport function sidebarTrigger(rootEl: Element, showFn: () => void) {\n  const triggerElems = rootEl.querySelectorAll(\n    '[' + SIDEBAR_TRIGGER_BTN_ATTR + ']'\n  );\n\n  Array.from(triggerElems).forEach(triggerElem => {\n    triggerElem.addEventListener('click', e => {\n      showFn();\n      e.stopPropagation();\n    });\n  });\n}\n","import { TinyEmitter } from 'tiny-emitter';\n\n/** @typedef {import('../../types/annotator').Destroyable} Destroyable */\n\n/**\n * Emitter is a communication class that implements the publisher/subscriber\n * pattern. It allows sending and listening events through a shared EventBus.\n * The different elements of the application can communicate with each other\n * without being tightly coupled.\n *\n * @implements {Destroyable}\n */\nexport class Emitter {\n  /**\n   * @param {TinyEmitter} emitter\n   */\n  constructor(emitter) {\n    this._emitter = emitter;\n\n    /** @type {[event: string, callback: Function][]} */\n    this._subscriptions = [];\n  }\n\n  /**\n   * Fire an event.\n   *\n   * @param {string} event\n   * @param {unknown[]} args\n   */\n  publish(event, ...args) {\n    this._emitter.emit(event, ...args);\n  }\n\n  /**\n   * Register an event listener.\n   *\n   * @param {string} event\n   * @param {Function} callback\n   */\n  subscribe(event, callback) {\n    this._emitter.on(event, callback);\n    this._subscriptions.push([event, callback]);\n  }\n\n  /**\n   * Remove an event listener.\n   *\n   * @param {string} event\n   * @param {Function} callback\n   */\n  unsubscribe(event, callback) {\n    this._emitter.off(event, callback);\n    this._subscriptions = this._subscriptions.filter(\n      ([subEvent, subCallback]) =>\n        subEvent !== event || subCallback !== callback\n    );\n  }\n\n  /**\n   * Remove all event listeners.\n   */\n  destroy() {\n    for (let [event, callback] of this._subscriptions) {\n      this._emitter.off(event, callback);\n    }\n    this._subscriptions = [];\n  }\n}\n\nexport class EventBus {\n  constructor() {\n    this._emitter = new TinyEmitter();\n  }\n\n  createEmitter() {\n    return new Emitter(this._emitter);\n  }\n}\n","// Load polyfill for :focus-visible pseudo-class.\nimport 'focus-visible';\n// Enable debug checks for Preact. Removed in prod builds by Rollup config.\nimport 'preact/debug';\n\nimport {\n  PortProvider,\n  installPortCloseWorkaroundForSafari,\n} from '../shared/messaging';\nimport type { Destroyable } from '../types/annotator';\nimport type { NotebookConfig } from './components/NotebookModal';\nimport type { ProfileConfig } from './components/ProfileModal';\nimport { getConfig } from './config/index';\nimport { Guest } from './guest';\nimport type { GuestConfig } from './guest';\nimport {\n  HypothesisInjector,\n  removeTemporaryClientConfig,\n} from './hypothesis-injector';\nimport type { InjectConfig } from './hypothesis-injector';\nimport {\n  VitalSourceInjector,\n  vitalSourceFrameRole,\n} from './integrations/vitalsource';\nimport { Notebook } from './notebook';\nimport { Profile } from './profile';\nimport { Sidebar } from './sidebar';\nimport type { SidebarConfig } from './sidebar';\nimport { EventBus } from './util/emitter';\n\n// Look up the URL of the sidebar. This element is added to the page by the\n// boot script before the \"annotator\" bundle loads.\nconst sidebarLinkElement = document.querySelector(\n  'link[type=\"application/annotator+html\"][rel=\"sidebar\"]'\n) as HTMLLinkElement;\n\n/**\n * Entry point for the part of the Hypothesis client that runs in the page being\n * annotated.\n *\n * Depending on the client configuration in the current frame, this can\n * initialize different functionality. In \"host\" frames the sidebar controls and\n * iframe containing the sidebar application are created. In \"guest\" frames the\n * functionality to support anchoring and creating annotations is loaded. An\n * instance of Hypothesis will have one host frame, one sidebar frame and one or\n * more guest frames. The most common case is that the host frame, where the\n * client is initially loaded, is also the only guest frame.\n */\nfunction init() {\n  const annotatorConfig = getConfig('annotator') as GuestConfig & InjectConfig;\n\n  let resolveUnloadRequested = () => {};\n  const unloadRequested = new Promise<void>(resolve => {\n    resolveUnloadRequested = resolve;\n  });\n  sidebarLinkElement.addEventListener('destroy', resolveUnloadRequested);\n\n  const hostFrame = annotatorConfig.subFrameIdentifier ? window.parent : window;\n\n  const destroyables = [] as Destroyable[];\n\n  if (hostFrame === window) {\n    // Ensure port \"close\" notifications from eg. guest frames are delivered properly.\n    const removeWorkaround = installPortCloseWorkaroundForSafari();\n    destroyables.push({ destroy: removeWorkaround });\n\n    const sidebarConfig = getConfig('sidebar') as SidebarConfig;\n\n    const hypothesisAppsOrigin = new URL(sidebarConfig.sidebarAppUrl).origin;\n    const portProvider = new PortProvider(hypothesisAppsOrigin);\n\n    const eventBus = new EventBus();\n    const sidebar = new Sidebar(document.body, eventBus, sidebarConfig);\n    const notebook = new Notebook(\n      document.body,\n      eventBus,\n      getConfig('notebook') as NotebookConfig\n    );\n    const profile = new Profile(\n      document.body,\n      eventBus,\n      getConfig('profile') as ProfileConfig\n    );\n\n    portProvider.on('frameConnected', (source, port) =>\n      sidebar.onFrameConnected(source, port)\n    );\n    destroyables.push(portProvider, sidebar, notebook, profile);\n  }\n\n  const vsFrameRole = vitalSourceFrameRole();\n  if (vsFrameRole === 'container') {\n    const vitalSourceInjector = new VitalSourceInjector(annotatorConfig);\n    destroyables.push(vitalSourceInjector);\n  } else {\n    // Set up automatic injection of the client into iframes in this frame.\n    const hypothesisInjector = new HypothesisInjector(\n      document.body,\n      annotatorConfig\n    );\n\n    // Create the guest that handles creating annotations and displaying highlights.\n    const guest = new Guest(document.body, annotatorConfig, hostFrame);\n\n    // When the client is unloaded in the host frame, also unload it from any\n    // connected iframes.\n    guest.on('hostDisconnected', resolveUnloadRequested);\n\n    destroyables.push(hypothesisInjector, guest);\n  }\n\n  unloadRequested.then(() => {\n    destroyables.forEach(instance => instance.destroy());\n\n    // Remove all the `<link>`, `<script>` and `<style>` elements added to the\n    // page by the boot script.\n    const clientAssets = document.querySelectorAll('[data-hypothesis-asset]');\n    clientAssets.forEach(el => el.remove());\n\n    // If this is a guest-only frame, remove client config added by the host\n    // frame. This enables the client to later be re-loaded in this frame.\n    removeTemporaryClientConfig();\n  });\n}\n\n/**\n * Returns a Promise that resolves when the document has loaded (but subresources\n * may still be loading).\n */\nfunction documentReady(): Promise<void> {\n  return new Promise(resolve => {\n    if (document.readyState !== 'loading') {\n      resolve();\n    }\n    // nb. `readystatechange` may be emitted twice, but `resolve` only resolves\n    // on the first call.\n    document.addEventListener('readystatechange', () => resolve());\n  });\n}\n\ndocumentReady().then(init);\n"],"names":["applyFocusVisiblePolyfill","scope","hadKeyboardEvent","hadFocusVisibleRecently","hadFocusVisibleRecentlyTimeout","inputTypesAllowlist","text","search","url","tel","email","password","number","date","month","week","time","datetime","isValidFocusTarget","el","document","nodeName","classList","focusTriggersKeyboardModality","type","tagName","readOnly","isContentEditable","addFocusVisibleClass","contains","add","setAttribute","removeFocusVisibleClass","hasAttribute","remove","removeAttribute","onKeyDown","e","metaKey","altKey","ctrlKey","activeElement","onPointerDown","onFocus","target","onBlur","window","clearTimeout","setTimeout","onVisibilityChange","visibilityState","addInitialPointerMoveListeners","addEventListener","onInitialPointerMove","removeInitialPointerMoveListeners","removeEventListener","toLowerCase","nodeType","Node","DOCUMENT_FRAGMENT_NODE","host","DOCUMENT_NODE","documentElement","event","CustomEvent","error","createEvent","initCustomEvent","dispatchEvent","factory","ListenerCollection","constructor","_defineProperty","this","_listeners","Map","eventTarget","eventType","listener","options","symbol","Symbol","set","listenerId","get","delete","removeAll","forEach","clear","byteToHex","val","str","toString","length","generateHexString","len","bytes","Uint8Array","crypto","getRandomValues","Array","from","map","join","isMessage","data","property","isMessageEqual","message","JSON","stringify","Object","keys","sort","PortFinder","hostFrame","source","sourceId","_hostFrame","_source","_sourceId","destroy","async","isValidRequest","Error","requestId","Promise","resolve","reject","postRequest","postMessage","frame1","frame2","intervalId","setInterval","timeoutId","clearInterval","ports","E","prototype","on","name","callback","ctx","push","fn","once","self","off","apply","arguments","_","emit","slice","call","evtArr","i","evts","liveEvents","tinyEmitterModule","exports","TinyEmitter","tinyEmitter","errorDestination","serializeError","err","stack","String","undefined","sendError","context","postErr","DOMException","sendErr","console","warn","sendErrorsTo","destination","PortProvider","hypothesisAppsOrigin","_hypothesisAppsOrigin","_emitter","_handledRequests","Set","_sidebarHostChannel","MessageChannel","_allowedMessages","allowedOrigin","_listen","errorContext","sentErrors","reportError","has","origin","channel","MessagePort","ServiceWorker","isSourceWindow","find","allowedMessage","_messageMatches","messageChannel","targetOrigin","port1","port2","args","eventName","handler","VERSION","PROTOCOL","sendCall","port","method","sequence","protocol","version","shouldUseSafariWorkaround","userAgent","webkitVersionMatch","match","parseInt","PortRPC","navigator","currentWindow","_port","_methods","_sequence","_callbacks","parent","_pendingCalls","_receivedCloseEvent","connect","_handle","start","close","_destroyed","seq","finalArg","_parseMessage","isArray","msg","response","cb","toBoolean","value","trim","toLocaleLowerCase","numericalVal","Number","isNaN","Boolean","parseJsonConfig","config","settingsElements","querySelectorAll","settings","parse","textContent","assign","hasOwn","object","hasOwnProperty","urlFromLinkTag","window_","rel","link","querySelector","href","checkIfString","settingsFrom","configFuncSettings","hypothesisConfig","docs","configFuncSettingsFrom","jsonConfigs","ignoreOtherConfiguration","hostPageSetting","annotations","annotFragmentMatch","location","annotationsFromURL","clientUrl","group","groupFragmentMatch","groupFromURL","notebookAppUrl","profileAppUrl","showHighlights","sidebarAppUrl","query","queryFragmentMatch","decodeURIComponent","queryFromURL","getHostPageSetting","configDefinitions","allowInBrowserExt","defaultValue","getValue","appType","branding","contentInfoBanner","enableExperimentalNewNoteButton","focus","theme","usernameUrl","onLayoutChange","openSidebar","coerce","requestConfigFromFrame","services","subFrameIdentifier","externalContainerSelector","getConfig","key","contexts","annotator","sidebar","notebook","profile","values","flat","configurationKeys","configDef","hasDefault","isURLFromBrowserExtension","startsWith","n","l","u","t","r","o","f","c","s","a","h","v","parentNode","removeChild","p","props","ref","__k","__","__b","__e","__d","__c","__h","__v","vnode","children","k","b","indexOf","g","base","m","w","__r","debounceRendering","shift","__P","L","__n","ownerSVGElement","M","x","y","d","A","C","$","nextSibling","S","O","appendChild","insertBefore","I","setProperty","test","T","style","cssText","replace","z","j","P","H","contextType","__E","render","q","sub","state","_sb","__s","getDerivedStateFromProps","componentWillMount","componentDidMount","componentWillReceiveProps","shouldComponentUpdate","componentWillUpdate","componentDidUpdate","getChildContext","getSnapshotBeforeUpdate","N","diffed","some","localName","createTextNode","createElementNS","createElement","is","childNodes","dangerouslySetInnerHTML","attributes","__html","innerHTML","checked","current","unmount","componentWillUnmount","B","defaultProps","firstChild","F","Consumer","Provider","splice","getDerivedStateFromError","setState","componentDidCatch","forceUpdate","then","bind","__H","__V","__N","filter","every","requestAnimationFrame","cancelAnimationFrame","modifiers","alt","ctrl","meta","matchShortcut","shortcut","parts","split","requiredModifiers","requiredKey","part","modifierFlag","shiftKey","useShortcut","onPress","rootElement","useEffect","onKeydown","installShortcut","isTouchDevice","_window","matchMedia","matches","__source","__self","_jsxFileName","AnnotateIcon","_jsxDEV","xmlns","width","height","viewBox","fill","fileName","lineNumber","columnNumber","CancelIcon","stroke","CaretDownIcon","CaretLeftIcon","CaretRightIcon","CautionIcon","CheckIcon","HideIcon","HighlightIcon","NoteIcon","PointerDownIcon","PointerUpIcon","ShowIcon","classNames","classes","arg","argType","inner","includes","module","default","createContext","CardNext","elementRef","active","variant","htmlAttributes","className","classnames","CardContentNext","size","ButtonBaseNext","unstyled","expanded","pressed","title","role","ariaProps","ButtonNext","icon","Icon","ButtonBase","inputGroupStyles","IconButtonNext","disableTouchSizing","LinkBaseNext","LinkNext","underline","color","LinkBase","PointerButtonNext","direction","NumberIcon","badgeCount","_jsx","AdderToolbarArrow","arrowDirection","ToolbarButton","label","onClick","_jsxs","AdderToolbarShortcuts","annotationCount","isVisible","_Fragment","AdderToolbar","onCommand","annotateShortcut","highlightShortcut","showShortcut","dir","visibility","createShadowRoot","container","shadowRoot","attachShadow","mode","_document$querySelect","linkEl","loadStyles","applyFocusVisible","element","stopPropagation","passive","ArrowDirection","toPx","pixels","Adder","_outerContainer","_shadowRoot","position","top","left","_view","ownerDocument","defaultView","_isVisible","_arrowDirection","_annotationsForSelection","_onAnnotate","onAnnotate","_onHighlight","onHighlight","_onShowAnnotations","onShowAnnotations","_render","annotationsForSelection","ids","hide","show","selectionRect","isRTLselection","_calculateTarget","_showAt","UP","_width","getBoundingClientRect","_height","DOWN","hMargin","Math","min","adderWidth","touchScreenOffset","adderHeight","innerHeight","max","innerWidth","_findZindex","elementsFromPoint","zIndexes","getComputedStyle","zIndex","isInteger","parentRect","parentEl","parentElement","nearestPositionedAncestor","command","TrimDirection","closestNonSpaceInString","baseOffset","nextChar","Forwards","charAt","availableChars","availableNonWhitespaceChars","Backwards","substring","trimEnd","trimStart","offsetDelta","closestNonSpaceInRange","range","nodeIter","commonAncestorContainer","createNodeIterator","NodeFilter","SHOW_TEXT","initialBoundaryNode","startContainer","endContainer","terminalBoundaryNode","currentNode","nextNode","previousNode","trimmedOffset","advance","nodeText","node","offset","RangeError","nodeTextLength","_node$textContent$len","_node$textContent","ELEMENT_NODE","TEXT_NODE","previousSiblingsTextLength","sibling","previousSibling","resolveOffsets","offsets","nextOffset","results","textNode","ResolveDirection","TextPosition","relativeTo","tw","createTreeWalker","getRootNode","forwards","FORWARDS","static","fromPoint","textOffset","TextRange","end","toRange","BACKWARDS","Range","setStart","setEnd","startOffset","endOffset","root","trimmedRange","cloneRange","startTrimmed","endTrimmed","trimmedOffsets","trimRange","fromRange","placeholderSelector","isInPlaceholder","closest","nodeIsElement","nodeIsText","isSelectionBackwards","selection","focusNode","anchorNode","focusOffset","anchorOffset","getRangeAt","isNodeInRange","_node$nodeValue$lengt","_node$nodeValue","nodeValue","comparePoint","forEachNodeInRange","SHOW_ALL","selectionFocusRect","isCollapsed","textBoxes","textNodes","flatMap","nodeRange","createRange","selectNodeContents","collapsed","viewportRects","getClientRects","detach","getTextBoundingBoxes","SVG_NAMESPACE","clusterValues","highlightRange","cssClass","splitText","wholeTextNodesInRange","inPlaceholder","textNodeSpans","prevNode","currentSpan","whitespace","span","highlights","nodes","highlightEl","replaceChild","highlightEls","canvasEl","pageEl","getPDFCanvas","svgHighlightLayer","svgStyle","mixBlendMode","canvasRect","highlightRects","highlightRect","rect","svgHighlight","append","drawHighlightsAbovePDFCanvas","replaceWith","replacements","removeHighlights","setHighlightsFocused","focused","svgEl","focusedId","getAttribute","focusedHighlight","cloneNode","setSVGHighlightFocused","toggle","collection","rects","reduce","acc","bottom","right","updateClusters","setNestingData","getHighlights","layer","layerHighlights","svgHighlights","getElementsByClassName","getSVGHighlights","idx","allEls","nestingLevel","replaceChildren","updateSVGHighlightOrdering","isHighlightElement","getElementsByTagName","highlight","parentCluster","parentClusterLevel","hEl","_clusterValues$find","elCluster","cv","elClusterLevel","_el$getAttribute","MAX_SAFE_INTEGER","BucketBarClient","contentContainer","hostRPC","_hostRPC","_updatePending","_anchors","update","anchors","positions","annotation","tag","$tag","anchor1","anchor2","computeAnchorPositions","shownWarnings","warnOnce","reset","annotatorFlags","FeatureFlags","knownFlags","super","_flags","_knownFlags","flags","flag","entries","flagEnabled","_this$_flags$get","allFlags","fromEntries","ClusterStyleControl","cluster","onChange","currentStyles","highlightStyles","appliedStyleName","isHidden","backgroundColor","styleName","id","htmlFor","ClusterToolbar","availableStyles","onStyleChange","handleStyleChange","useCallback","changeEvent","input","isOpen","setOpen","useState","Card","Button","CardContent","transparent","secondColor","thirdColor","pink","orange","yellow","green","purple","grey","defaultClusterStyles","HighlightClusterController","_element","_features","features","offsetTop","appliedStyles","_init","_activate","_isActive","_updateTimeout","scheduleClusterUpdates","_updateClusters","_setClusterStyles","_setClusterStyle","styleRules","ruleName","_onChangeClusterStyle","reverse","oneIfNotZero","advanceBlock","peq","hIn","pV","mV","hInIsNegative","eq","xV","xH","pH","mH","hOut","lastRowMask","findMatchEnds","pattern","maxErrors","bMax","ceil","Uint32Array","emptyPeq","asciiPeq","charCodeAt","charPeq","score","charCode","carry","maxBlockScore","remainder","errors","patRev","minStart","rm","findMatchStarts","matchPos","exactMatches","approxSearch","textMatchScore","matchQuote","quote","scoreMatch","quoteScore","prefixScore","prefix","suffixScore","suffix","posScore","hint","abs","quoteWeight","scoredMatches","getPathSegment","result","getNodeName","pos","tmp","getNodePosition","xpathFromNode","xpath","elem","nthChildOfType","index","toUpperCase","matchIndex","child","nodeFromXPath","body","segments","segment","elementName","elementIndex","separatorPos","indexStr","evaluateSimpleXPath","evaluate","XPathResult","FIRST_ORDERED_NODE_TYPE","singleNodeValue","RangeAnchor","selector","startPos","fromCharOffset","endPos","toSelector","normalizedRange","textRange","TextPositionAnchor","fromOffsets","TextQuoteAnchor","exact","toPositionAnchor","anchor","observeCalls","origHandler","wrapper","stripFragment","NavigationObserver","onNavigate","getLocation","lastURL","checkForURLChange","newURL","navigation","Navigation","getNavigation","unpatchers","history","_unpatchHistory","cleanup","disconnect","_this$_unpatchHistory","COMPLETE","CANCELED","setElementScroll","scrollTo","scrollLeft","scrollTop","animate","scrollSettings","_scrollSettings","maxSynchronousAlignments","parentPosition","differenceX","differenceY","targetWidth","targetHeight","align","targetPosition","leftAlign","topAlign","leftOffset","topOffset","leftScalar","topScalar","isWindow","pageXOffset","pageYOffset","lockX","lockY","offsetLeft","clientWidth","clientHeight","scrollWidth","scrollHeight","getTargetScrollLocation","Date","now","startTime","timeValue","endIterations","easeValue","ease","scrollAncestor","task","raf","defaultIsWindow","defaultIsScrollable","overflow","defaultValidTarget","findParentElement","assignedSlot","ownerWindow","scrollIntoView","pow","parents","validTarget","isScrollable","debug","log","scrollingElements","done","cancel","cancelHandler","idle","lastSettings","passiveOptions","endType","cancellable","transitionScrollTo","interpolate","fraction","scrollElement","maxDuration","scrollStart","scrollDuration","scrollFraction","normalizeURI","uri","baseURI","URL","HTMLMetadata","_getDocumentHref","links","_getLinks","getDocumentMetadata","metadata","dc","_getMetaTags","eprints","facebook","highwire","prism","twitter","favicon","_getFavicon","_getTitle","dcLink","documentFingerprint","attribute","tags","content","RegExp","linkElements","hreflang","_absoluteUrl","doi","dcRelationValues","dcIdentifierValues","identifier","dcUrnRelationComponent","dcUrnIdentifierComponent","dcUrn","encodeURIComponent","allowedSchemes","scheme","rectIsEmpty","linesOverlap","rectIntersects","rectA","rectB","rectsOverlapVertically","rectsOverlapHorizontally","unionRects","DOMRect","rectCenter","DOMPoint","contentSelectors","textRectRange","textRect","elementContentRect","textNodesInRect","shouldVisit","contentIntersectsRect","getScrollAnchor","viewport","anchorRange","hasFixedPosition","textNodeLoop","textLen","word","wordBox","preserveScrollPosition","scrollRoot","anchorTop","scrollDelta","HTMLIntegration","_htmlMeta","_prevURI","_sideBySideEnabled","_sideBySideActive","_lastLayout","_navObserver","_checkForURIChange","_metaObserver","MutationObserver","observe","head","childList","subtree","attributeFilter","_flagsChanged","sideBySide","fitSideBySide","selectors","maybeAssertQuote","_quote","promise","range_","catch","fromSelector","position_","quote_","describe","types","currentURI","getAnnotatableRange","canStyleClusteredHighlights","layout","maximumWidthToFit","_activateSideBySide","_deactivateSideBySide","sidebarWidth","rightMargin","computeLeftMargin","marginLeft","marginRight","beforeBodyLeft","contentArea","leftMarginVotes","rightMarginVotes","contentSelector","paragraphs","textLength","_leftMarginVotes$get","_rightMarginVotes$get","leftVotes","rightVotes","leftMargin","leftPos","rightPos","guessMainContentArea","freeSpace","adjustedMargin","_anchor$highlights","defineProperty","configurable","scrollElementIntoView","reTrim","reIsBadHex","reIsBinary","reIsOctal","freeParseInt","freeGlobal","global","freeSelf","Function","objectToString","nativeMax","nativeMin","isObject","toNumber","isObjectLike","isSymbol","other","valueOf","isBinary","lodash_debounce","func","wait","lastArgs","lastThis","maxWait","timerId","lastCallTime","lastInvokeTime","leading","maxing","trailing","TypeError","invokeFunc","thisArg","leadingEdge","timerExpired","shouldInvoke","timeSinceLastCall","trailingEdge","remainingWait","debounced","isInvoking","flush","count","countChars","translateOffsets","output","beforeStartCount","startToEndCount","outputStart","RenderingStates","pageTextCache","quotePositionCache","quotePositionCacheKey","getNodeTextLayer","_el$closest","getPDFViewer","PDFViewerApplication","pdfViewer","getPageView","pageIndex","pageView","pdfPage","onPagesLoaded","eventBus","getPageTextContent","cachedText","pageText","getTextContent","normalizeWhitespace","items","it","getPageText","findPageByOffset","viewer","pageStartOffset","pageEndOffset","pagesCount","isSpace","char","isNotSpace","anchorByPosition","page","all","renderingState","textLayer","renderingDone","_page$textLayer$textL","textLayerDiv","div","textLayerStr","textLayerStart","textLayerEnd","stripSpaces","placeholder","createPlaceholder","setStartBefore","setEndAfter","stripped","matchedText","cacheKey","cachedPos","quoteSelector","positionHint","pageCount","pageIndexes","expectedPageIndex","expectedOffsetInPage","strippedPrefix","strippedSuffix","strippedQuote","bestMatch","strippedText","strippedHint","exactQuoteMatch","exactPrefixMatch","exactSuffixMatch","hasContext","anchorQuote","getTextLayerForRange","startTextLayer","endTextLayer","startPageIndex","getSiblingIndex","pageOffset","getPageOffset","Banners","ContentInfoBanner","info","itemTitle","item","subtitle","logo","Link","src","previousItem","currentItem","nextItem","WarningBanner","PDFMetadata","app","_loaded","initializedPromise","initialized","timeout","pdfViewerInitialized","downloadComplete","finish","getUri","getPDFURL","fingerprintToURN","getFingerprint","documentInfo","contentDispositionFilename","pdfDocument","getMetadata","Title","pathSegments","pathname","filenameFromURL","fingerprints","fingerprint","anchorIsInPlaceholder","delay","ms","PDFIntegration","_pdfViewerApp$appConf","_pdfViewerApp$appConf2","_options$reanchoringM","_annotator","pdfWindow","pdfViewerApp","_pdfViewer","_pdfContainer","appConfig","appContainer","_pdfMetadata","_observer","debounce","_update","_reanchoringMaxWait","reanchoringMaxWait","_banner","_bannerState","contentInfo","noTextWarning","_updateBannerState","_checkForSelectableText","_updateAnnotationLayerVisibility","getSelection","_this$_banner","showContentInfo","canDescribe","hasText","documentHasText","outerContainer","_this$_banner2","prepend","bannerHeight","refreshAnnotations","_page$textLayer","_container$querySelec","hl","sidebarLayout","reservedSpace","toolbarWidth","currentScaleValue","_anchorOffset","_waitForAnnotationToBeAnchored","_anchor","offsetParent","offsetRelativeTo","documentCFI","cfi","escaped","inAssertion","ch","stripCFIAssertions","sepIndex","FrameObserver","onFrameAdded","onFrameRemoved","_onFrameAdded","_onFrameRemoved","_annotatableFrames","_isDisconnected","_mutationObserver","_discoverFrames","frame","onNextDocumentReady","contentWindow","_removeFrame","frames","_addFrame","unsubscribe","onDocumentReady","doc","pollInterval","pollTimer","pollForDocumentChange","documents","WeakSet","cancelPoll","checkForDocumentChange","currentDocument","contentDocument","_frame$contentDocumen","hasBlankDocumentThatWillNavigate","readyState","pollOnUnload","_frame$contentWindow","errorMessage","isConnected","canceled","initialCheckTimer","HypothesisInjector","_config","_frameObserver","injectClient","frameId","assetRoot","injectedConfig","configElement","innerText","bootScript","iframeDocument","ImageTextLayer","image","charBoxes","containerParent","textAlign","fontFamily","fontSize","getContext","font","scaledValue","dimension","unit","columns","words","currentWord","addWord","lines","currentLine","addLine","prevWord","prevCenter","xDist","currentColumn","addColumn","line","prevLine","yDist","analyzeLayout","column","columnEl","display","lineEl","marginTop","whiteSpace","wordEl","transformOrigin","metrics","measureText","xScale","yScale","transform","updateTextLayerSize","imageWidth","imageHeight","_updateTextLayerSize","ResizeObserver","_imageSizeObserver","updateSync","_this$_imageSizeObser","findBookElement","document_","vitalSourceFrameRole","_window_$frameElement","parentDoc","frameElement","VitalSourceInjector","bookElement","contentFrames","injectClientIntoContentFrame","getPDFPageImage","VitalSourceContentIntegration","_options$bookElement","_bookElement","htmlFeatures","html_side_by_side","_htmlIntegration","stopEvents","insertAdjacentElement","removeScrollingAttr","makeContentFrameScrollable","bookImage","pageData","innerPageData","charRects","glyphs","glyph","_textLayer","_this$_textLayer","pageLabel","_getPageInfo","extraSelectors","getBookInfo","format","bookContainer","newWidth","navigateToSegment","ann","_ann$target$0$selecto","goToCfi","goToURL","parsed","stripOrigin","persistFrame","includeTitle","pageInfo","toc","getCurrentPage","getTOC","requiredFields","field","_toc$data","chapterTitle","pageCFI","tocEntry","entry","absoluteURL","bookId","isbn","scrollToAnchor","createIntegration","selectedRange","rangeCount","SelectionObserver","isMouseDown","_pendingCallback","scheduleCallback","eventHandler","_cancelPendingCallback","_document","itemForNode","checkedNodes","rangeUtil","_annotation","annotationsAt","getHighlightsContainingNode","resolveAnchor","removeTextSelection","_document$getSelectio","removeAllRanges","Guest","_this$_frameIdentifie","_this$_integration$ca","_this$_integration2","_this$_integration$sh","_this$_integration","_highlightsVisible","_isAdderVisible","_informHostOnNextSelectionClear","selectedRanges","_adder","createAnnotation","selectAnnotations","focusInSidebar","_selectionObserver","_onSelection","_onClearSelection","_annotations","_frameIdentifier","_portFinder","_featureFlagsReceived","_integration","_sendDocumentInfo","_clusterToolbar","_connectHost","_sidebarRPC","_connectSidebar","_bucketBarClient","_setupElementEvents","_hoveredAnnotations","maybeCloseSidebar","_handleShortcut","_repositionAdder","_this$_integration$se","_this$_integration3","_this$_integration$pe","_this$_integration$pe2","_this$_integration4","segmentInfo","persistent","_this$_integration$wa","_this$_integration5","waitForFeatureFlags","getDocumentInfo","_window$getSelection","_hoverAnnotations","_scrollToClosestOffScreenAnchor","ancestor","hostPort","discover","bubbles","cancelable","detail","setHighlightsVisible","_this$_integration$sh2","_this$_integration6","_this$_integration$na","_this$_integration7","_this$_clusterToolbar","removeAllHighlights","_anchor$annotation","$cluster","$orphan","_updateAnchors","concat","notify","_this$_clusterToolbar2","ranges","$highlight","closestAnchor","closestTop","findClosestOffscreenAnchor","annotatableRange","isBackwards","focusRect","visible","notifyHost","highlightsVisible","sideBySideActive","hoveredAnnotationTags","addConfigFragment","baseURL","params","URLSearchParams","hash","createAppConfig","appURL","_appConfig$services","hostURL","service","onLoginRequest","onLoginRequestProvided","onLogoutRequest","onLogoutRequestProvided","onSignupRequest","onSignupRequestProvided","onProfileRequest","onProfileRequestProvided","onHelpRequest","onHelpRequestProvided","NotebookIframe","groupId","allowFullScreen","NotebookModal","iframeKey","setIframeKey","setIsHidden","setGroupId","originalDocumentOverflowStyle","useRef","emitterRef","emitter","createEmitter","subscribe","hidden","IconButton","onClose","_emitterRef$current","publish","Notebook","ProfileModal","Profile","exportName","VENDOR_PREFIXES","TEST_ELEMENT","round","setTimeoutContext","bindFn","invokeArrayArg","each","obj","iterator","deprecate","deprecationMessage","nextKey","extend","dest","merge","inherit","properties","childP","baseP","create","_super","boolOrFn","ifUndefined","val1","val2","addEventListeners","splitStr","removeEventListeners","hasParent","inStr","inArray","findByKey","toArray","uniqueArray","prefixed","prop","camelProp","_uniqueId","getWindowForElement","parentWindow","SUPPORT_TOUCH","SUPPORT_POINTER_EVENTS","SUPPORT_ONLY_TOUCH","INPUT_TYPE_TOUCH","INPUT_TYPE_MOUSE","DIRECTION_VERTICAL","DIRECTION_UP","PROPS_XY","PROPS_CLIENT_XY","Input","manager","inputTarget","domHandler","ev","enable","init","inputHandler","pointersLen","pointers","changedPointersLen","changedPointers","isFirst","isFinal","session","pointersLength","firstInput","simpleCloneInputData","firstMultiple","offsetCenter","center","getCenter","timeStamp","deltaTime","angle","getAngle","distance","getDistance","prevDelta","prevInput","deltaX","deltaY","computeDeltaXY","offsetDirection","getDirection","overallVelocity","getVelocity","overallVelocityX","overallVelocityY","scale","rotation","getRotation","maxPointers","velocity","velocityX","velocityY","last","lastInterval","computeIntervalInputData","srcEvent","computeInputData","recognize","clientX","clientY","p1","p2","sqrt","atan2","PI","evEl","evTarget","evWin","MOUSE_INPUT_MAP","mousedown","mousemove","mouseup","MOUSE_ELEMENT_EVENTS","MOUSE_WINDOW_EVENTS","MouseInput","button","which","pointerType","POINTER_INPUT_MAP","pointerdown","pointermove","pointerup","pointercancel","pointerout","IE10_POINTER_TYPE_ENUM","POINTER_ELEMENT_EVENTS","POINTER_WINDOW_EVENTS","PointerEventInput","store","pointerEvents","MSPointerEvent","PointerEvent","removePointer","eventTypeNormalized","isTouch","storeIndex","pointerId","SINGLE_TOUCH_INPUT_MAP","touchstart","touchmove","touchend","touchcancel","SINGLE_TOUCH_TARGET_EVENTS","SINGLE_TOUCH_WINDOW_EVENTS","SingleTouchInput","started","normalizeSingleTouches","touches","changed","changedTouches","TOUCH_INPUT_MAP","TOUCH_TARGET_EVENTS","TouchInput","targetIds","getTouches","allTouches","targetTouches","changedTargetTouches","touch","TouchMouseInput","mouse","primaryTouch","lastTouches","recordTouches","eventData","setLastTouch","lastTouch","lts","isSyntheticEvent","dx","dy","inputEvent","inputData","isMouse","sourceCapabilities","firesTouchEvents","PREFIXED_TOUCH_ACTION","NATIVE_TOUCH_ACTION","TOUCH_ACTION_COMPUTE","TOUCH_ACTION_AUTO","TOUCH_ACTION_MANIPULATION","TOUCH_ACTION_NONE","TOUCH_ACTION_PAN_X","TOUCH_ACTION_PAN_Y","TOUCH_ACTION_MAP","touchMap","cssSupports","CSS","supports","getTouchActionProps","TouchAction","compute","actions","touchAction","recognizers","recognizer","getTouchAction","hasPanX","hasPanY","cleanTouchActions","preventDefaults","prevented","preventDefault","hasNone","isTapPointer","isTapMovement","isTapTouchTime","DIRECTION_LEFT","preventSrc","STATE_FAILED","Recognizer","defaults","simultaneous","requireFail","stateStr","directionStr","getRecognizerByNameIfManager","otherRecognizer","AttrRecognizer","PanRecognizer","pX","pY","PinchRecognizer","PressRecognizer","_timer","_input","RotateRecognizer","SwipeRecognizer","TapRecognizer","pTime","pCenter","Hammer","preset","Manager","recognizeWith","dropRecognizeWith","requireFailure","dropRequireFailure","hasRequireFailures","canRecognizeWith","additionalEvent","tryEmit","canEmit","inputDataClone","process","attrTest","optionPointers","isRecognized","isValid","threshold","DIRECTION_HORIZONTAL","directionTest","hasMoved","inOut","validPointers","validMovement","validTime","taps","interval","posThreshold","validTouchTime","failTimeout","validInterval","validMultiTap","tapCount","domEvents","inputClass","cssProps","userSelect","touchSelect","touchCallout","contentZooming","userDrag","tapHighlightColor","handlers","oldCssProps","toggleCssProps","stop","force","stopped","curRecognizer","existing","events","gestureEvent","initEvent","gesture","triggerDomEvent","INPUT_START","INPUT_MOVE","INPUT_END","INPUT_CANCEL","STATE_POSSIBLE","STATE_BEGAN","STATE_CHANGED","STATE_ENDED","STATE_RECOGNIZED","STATE_CANCELLED","DIRECTION_NONE","DIRECTION_RIGHT","DIRECTION_DOWN","DIRECTION_ALL","Tap","Pan","Swipe","Pinch","Rotate","Press","Buckets","above","below","buckets","onFocusAnnotations","onScrollToClosestOffScreenAnchor","onSelectAnnotations","showUpNavigation","showDownNavigation","PointerButton","onMouseEnter","onMouseOut","bucket","BucketBar","_bucketsContainer","_onFocusAnnotations","_onScrollToClosestOffScreenAnchor","_onSelectAnnotations","anchorPositions","aboveTags","belowTags","currentBucket","newBucket","aPos","isContainedWithin","updatedBottom","updatedHeight","computeBuckets","toogle","ToastMessageItem","onDismiss","visuallyHidden","moreInfoURL","BaseToastMessages","messages","onMessageDismiss","isDismissed","ToastMessages","setMessages","addMessage","newMessage","prev","dismissMessage","messageId","buttonProps","StatusNotifier","Toolbar","closeSidebar","isSidebarOpen","newAnnotationType","toggleHighlights","toggleSidebar","toggleSidebarRef","useMinimalControls","selected","ToolbarController","setSidebarOpen","_container","_useMinimalControls","_newAnnotationType","_sidebarOpen","_closeSidebar","_toggleSidebar","_toggleHighlights","_createAnnotation","_sidebarToggleButton","getWidth","minimal","sidebarOpen","open","sidebarToggleButton","MIN_RESIZE","Sidebar","_guestWithSelection","_guestRPC","iframe","sidebarURL","sidebarAppSrc","sidebarFrame","createSidebarIframe","bucketBar","externalFrame","iframeContainer","rpc","_hypothesisSidebar","_messagesElement","toolbarContainer","toolbar","_this$_guestWithSelec","_toolbarWidth","_onResize","_gestureState","initial","final","_setupGestures","serviceConfig","_layoutState","_updateLayoutState","_setupSidebarEvents","_this$bucketBar","_this$_hammerManager","_hammerManager","onFrameConnected","_connectGuest","guestRPC","rootEl","newCount","elems","showFn","triggerElems","triggerElem","sidebarTrigger","_resetGestureState","toggleButton","_onPan","_updateLayout","_renderFrame","margin","_this$iframeContainer","_this$onLayoutChange","computedStyle","frameVisibleWidth","layoutState","delta","_this$iframeContainer2","_this$iframeContainer3","Emitter","_subscriptions","subEvent","subCallback","EventBus","sidebarLinkElement","annotatorConfig","resolveUnloadRequested","unloadRequested","destroyables","removeWorkaround","_event$data","installPortCloseWorkaroundForSafari","sidebarConfig","portProvider","vitalSourceInjector","hypothesisInjector","guest","instance","removeTemporaryClientConfig"],"mappings":"unBAIS,WASP,SAASA,EAA0BC,GACjC,IAAIC,GAAmB,EACnBC,GAA0B,EAC1BC,EAAiC,KAEjCC,EAAsB,CACxBC,MAAM,EACNC,QAAQ,EACRC,KAAK,EACLC,KAAK,EACLC,OAAO,EACPC,UAAU,EACVC,QAAQ,EACRC,MAAM,EACNC,OAAO,EACPC,MAAM,EACNC,MAAM,EACNC,UAAU,EACV,kBAAkB,GAQpB,SAASC,EAAmBC,GAC1B,SACEA,GACAA,IAAOC,UACS,SAAhBD,EAAGE,UACa,SAAhBF,EAAGE,UACH,cAAeF,GACf,aAAcA,EAAGG,UAKpB,CASD,SAASC,EAA8BJ,GACrC,IAAIK,EAAOL,EAAGK,KACVC,EAAUN,EAAGM;CAEjB,QAAgB,UAAZA,IAAuBpB,EAAoBmB,IAAUL,EAAGO,WAI5C,aAAZD,IAA2BN,EAAGO,YAI9BP,EAAGQ,iBAKR,CAOD,SAASC,EAAqBT,GACxBA,EAAGG,UAAUO,SAAS,mBAG1BV,EAAGG,UAAUQ,IAAI,iBACjBX,EAAGY,aAAa,2BAA4B,IAC7C,CAOD,SAASC,EAAwBb,GAC1BA,EAAGc,aAAa,8BAGrBd,EAAGG,UAAUY,OAAO,iBACpBf,EAAGgB,gBAAgB,4BACpB,CAUD,SAASC,EAAUC,GACbA,EAAEC,SAAWD,EAAEE,QAAUF,EAAEG,UAI3BtB,EAAmBjB,EAAMwC,gBAC3Bb,EAAqB3B,EAAMwC,eAG7BvC,GAAmB,EACpB,CAUD,SAASwC,EAAcL,GACrBnC,GAAmB,CACpB,CASD,SAASyC,EAAQN,GAEVnB,EAAmBmB,EAAEO,UAItB1C,GAAoBqB,EAA8Bc,EAAEO,UACtDhB,EAAqBS,EAAEO,OAE1B,CAMD,SAASC,EAAOR,GACTnB,EAAmBmB,EAAEO,UAKxBP,EAAEO,OAAOtB,UAAUO,SAAS,kBAC5BQ,EAAEO,OAAOX,aAAa,+BAMtB9B,GAA0B,EAC1B2C,OAAOC,aAAa3C,GACpBA,EAAiC0C,OAAOE,YAAW,WACjD7C,GAA0B,CAC3B,GAAE,KACH6B,EAAwBK,EAAEO,QAE7B,CAOD,SAASK,EAAmBZ,GACO,WAA7BjB,SAAS8B,kBAKP/C,IACFD,GAAmB,GAErBiD,IAEH,CAQD,SAASA,IACP/B,SAASgC,iBAAiB,YAAaC,GACvCjC,SAASgC,iBAAiB,YAAaC,GACvCjC,SAASgC,iBAAiB,UAAWC,GACrCjC,SAASgC,iBAAiB,cAAeC;AACzCjC,SAASgC,iBAAiB,cAAeC,GACzCjC,SAASgC,iBAAiB,YAAaC,GACvCjC,SAASgC,iBAAiB,YAAaC,GACvCjC,SAASgC,iBAAiB,aAAcC,GACxCjC,SAASgC,iBAAiB,WAAYC,EACvC,CAED,SAASC,IACPlC,SAASmC,oBAAoB,YAAaF,GAC1CjC,SAASmC,oBAAoB,YAAaF,GAC1CjC,SAASmC,oBAAoB,UAAWF,GACxCjC,SAASmC,oBAAoB,cAAeF,GAC5CjC,SAASmC,oBAAoB,cAAeF,GAC5CjC,SAASmC,oBAAoB,YAAaF,GAC1CjC,SAASmC,oBAAoB,YAAaF,GAC1CjC,SAASmC,oBAAoB,aAAcF,GAC3CjC,SAASmC,oBAAoB,WAAYF,EAC1C,CASD,SAASA,EAAqBhB,GAGxBA,EAAEO,OAAOvB,UAAgD,SAApCgB,EAAEO,OAAOvB,SAASmC,gBAI3CtD,GAAmB,EACnBoD,IACD,CAKDlC,SAASgC,iBAAiB,UAAWhB,GAAW,GAChDhB,SAASgC,iBAAiB,YAAaV,GAAe,GACtDtB,SAASgC,iBAAiB,cAAeV,GAAe,GACxDtB,SAASgC,iBAAiB,aAAcV,GAAe,GACvDtB,SAASgC,iBAAiB,mBAAoBH,GAAoB,GAElEE,IAMAlD,EAAMmD,iBAAiB,QAAST,GAAS,GACzC1C,EAAMmD,iBAAiB,OAAQP,GAAQ;AAOnC5C,EAAMwD,WAAaC,KAAKC,wBAA0B1D,EAAM2D,KAI1D3D,EAAM2D,KAAK7B,aAAa,wBAAyB,IACxC9B,EAAMwD,WAAaC,KAAKG,gBACjCzC,SAAS0C,gBAAgBxC,UAAUQ,IAAI,oBACvCV,SAAS0C,gBAAgB/B,aAAa,wBAAyB,IAElE,CAKD,GAAsB,oBAAXe,QAA8C,oBAAb1B,SAA0B,CAQpE,IAAI2C,EAJJjB,OAAO9C,0BAA4BA,EAMnC,IACE+D,EAAQ,IAAIC,YAAY,+BAKzB,CAJC,MAAOC,IAEPF,EAAQ3C,SAAS8C,YAAY,gBACvBC,gBAAgB,gCAAgC,GAAO,EAAO,CAAE,EACvE,CAEDrB,OAAOsB,cAAcL,EACtB,CAEuB,oBAAb3C,UAGTpB,EAA0BoB,SAG7B,CAtTgEiD,GC2B1D,MAAMC,EAGXC,cAAcC,EAAAC,KAAA,kBAAA,GACZA,KAAKC,WAAa,IAAIC,GACxB,CAKA7C,IACE8C,EACAC,EACAC,EACAC,GAEAH,EAAYxB,iBAAiByB,EAAWC,EAA2BC,GACnE,MAAMC,EAASC,SAOf,OANAR,KAAKC,WAAWQ,IAAIF,EAAQ,CAC1BJ,cACAC,YAEAC,SAAUA,IAELE,CACT,CAKA9C,OAAOiD,GACL,MAAMpB,EAAQU,KAAKC,WAAWU,IAAID,GAClC,GAAIpB,EAAO,CACT,MAAMa,YAAEA,EAAWC,UAAEA,EAASC,SAAEA,GAAaf,EAC7Ca,EAAYrB,oBAAoBsB,EAAWC,GAC3CL,KAAKC,WAAWW,OAAOF,EACzB,CACF,CAEAG,YACEb,KAAKC,WAAWa,SAAQ,EAAGX,cAAaC,YAAWC;AACjDF,EAAYrB,oBAAoBsB,EAAWC,EAAS,IAEtDL,KAAKC,WAAWc,OAClB,ECvEF,SAASC,EAAUC,GACjB,MAAMC,EAAMD,EAAIE,SAAS,IACzB,OAAsB,IAAfD,EAAIE,OAAe,IAAMF,EAAMA,CACxC,CAQO,SAASG,EAAkBC,GAChC,MAAMC,EAAQ,IAAIC,WAAWF,EAAM,GAEnC,OADAjD,OAAOoD,OAAOC,gBAAgBH,GACvBI,MAAMC,KAAKL,GAAOM,IAAIb,GAAWc,KAAK,GAC/C,CCWO,SAASC,EAAUC,GACxB,GAAa,OAATA,GAAiC,iBAATA,EAC1B,OAAO,EAGT,IAAK,IAAIC,IAAY,CAAC,SAAU,SAAU,OAAQ,aAChD,GAA8B,iBAAnBD,EAAKC,GACd,OAAO,EAIX,OAAO,CACT,CAQO,SAASC,EAAeF,EAAMG,GACnC,QAAKJ,EAAUC,IAObI,KAAKC,UAAUL,EAAMM,OAAOC,KAAKJ,GAASK,UAC1CJ,KAAKC,UAAUF,EAASG,OAAOC,KAAKJ,GAASK,OAEjD,CCnCO,MAAMC,EAQX3C,aAAY4C,UAAEA,EAASC,OAAEA,EAAMC,SAAEA,IAC/B5C,KAAK6C,WAAaH,EAClB1C,KAAK8C,QAAUH,EACf3C,KAAK+C,UAAYH,EACjB5C,KAAKC,WAAa,IAAIJ,CACxB,CAEAmD,UACEhD,KAAKC,WAAWY,WAClB,CAQAoC,eAAe9E,GACb,IAAI+E,GAAiB,EAUrB,IARoB,UAAjBlD,KAAK8C,SAAkC,SAAX3E,GACX,UAAjB6B,KAAK8C,SAAkC,YAAX3E,GACX,YAAjB6B,KAAK8C,SAAoC,SAAX3E,GACb,aAAjB6B,KAAK8C,SAAqC,YAAX3E,KAEhC+E,GAAiB,IAGdA,EACH,MAAM,IAAIC,MAAM,mCAGlB,MAAMC,EAAY/B,EAAkB,GAEpC,OAAO,IAAIgC,SAAQ,CAACC,EAASC,KAC3B,MAAMC,EAAcA,KAClBxD,KAAK6C,WAAWY,YACd,CACEC,OAAQ1D,KAAK8C,QACba,OAAQxF;AACRpB,KAAM,UACNqG,YACAR,SAAU5C,KAAK+C,WAEjB,IACD,EAUGa,EAAaC,YAAYL,EA9EI,KAiF7BM,EAAYvF,YAAW,KAC3BwF,cAAcH,GACdL,EACE,IAAIJ,MACD,uBAAsBnD,KAAK8C,WAAW3E,2BAE1C,GA1FwB,KA6FrBuC,EAAaV,KAAKC,WAAW5C,IAAIgB,OAAQ,WAAWiB,IACxD,MAAM0C,KAAEA,EAAIgC,MAAEA,GAAU1E,EAEtB4C,EAAeF,EAAM,CACnB0B,OAAQ1D,KAAK8C,QACba,OAAQxF,EACRpB,KAAM,QACNqG,gBAGFW,cAAcH,GACdtF,aAAawF,GACb9D,KAAKC,WAAWxC,OAAOiD,GACvB4C,EAAQU,EAAM,IAChB,IAGFR,GAAa,GAEjB,2DCrHF,SAASS,IAGT,CAEAA,EAAEC,UAAY,CACZC,GAAI,SAAUC,EAAMC,EAAUC,GAC5B,IAAI1G,EAAIoC,KAAKpC,IAAMoC,KAAKpC,EAAI,CAAA,GAO5B,OALCA,EAAEwG,KAAUxG,EAAEwG,GAAQ,KAAKG,KAAK,CAC/BC,GAAIH,EACJC,IAAKA,IAGAtE,IACR,EAEDyE,KAAM,SAAUL,EAAMC,EAAUC,GAC9B,IAAII,EAAO1E,KACX,SAASK,IACPqE,EAAKC,IAAIP,EAAM/D,GACfgE,EAASO,MAAMN,EAAKO,UAE1B,CAEI,OADAxE,EAASyE,EAAIT,EACNrE,KAAKmE,GAAGC,EAAM/D,EAAUiE,EAChC,EAEDS,KAAM,SAAUX,GAMd,IALA,IAAIpC,EAAO,GAAGgD,MAAMC,KAAKJ,UAAW,GAChCK,IAAWlF,KAAKpC,IAAMoC,KAAKpC,EAAI,CAAA,IAAKwG,IAAS,IAAIY,QACjDG,EAAI,EACJ7D,EAAM4D,EAAO9D,OAET+D,EAAI7D,EAAK6D,IACfD,EAAOC,GAAGX,GAAGI,MAAMM,EAAOC,GAAGb,IAAKtC,GAGpC,OAAOhC,IACR,EAED2E,IAAK,SAAUP,EAAMC,GACnB,IAAIzG,EAAIoC,KAAKpC,IAAMoC,KAAKpC,EAAI,CAAA,GACxBwH,EAAOxH,EAAEwG,GACTiB,EAAa,GAEjB,GAAID,GAAQf,EACV,IAAK,IAAIc,EAAI,EAAG7D,EAAM8D,EAAKhE,OAAQ+D,EAAI7D,EAAK6D,IACtCC,EAAKD,GAAGX,KAAOH,GAAYe,EAAKD,GAAGX,GAAGM,IAAMT,GAC9CgB,EAAWd,KAAKa,EAAKD,IAY3B,OAJCE,EAAiB,OACdzH,EAAEwG,GAAQiB,SACHzH,EAAEwG;AAENpE,IACR,GAGHsF,EAAcC,QAAGtB,EACjB,IAAAuB,EAAAC,EAAAD,YAA6BvB,ECjE7B,IAAIyB,EAAmB,KAsCvB,SAASC,EAAeC,GACtB,OAAMA,aAAezC,MAId,CACLhB,QAASyD,EAAIzD,QACb0D,MAAOD,EAAIC,OALJ,CAAE1D,QAAS2D,OAAOF,GAAMC,WAAOE,EAO1C,CA4BO,SAASC,EAAUxG,EAAOyG,GAC/B,IAAKP,EACH,OAGF,MAAM1D,EAAO,CACXjF,KAAM,mBACNyC,MAAOA,aAAiB2D,MAAQ3D,EAAQmG,EAAenG,GACvDyG,WAGF,IAGE,IACEP,EAAiBjC,YAAYzB,EAAM,IAWrC,CAVE,MAAOkE,GACP,KACEA,aAAmBC,cACF,mBAAjBD,EAAQ9B,MAKR,MAAM8B,EAHNlE,EAAKxC,MAAQmG,EAAe3D,EAAKxC,OACjCkG,EAAiBjC,YAAYzB,EAAM,IAIvC,CAGF,CAFE,MAAOoE,GACPC,QAAQC,KAAK,oCAAqCF,EACpD,CACF,CA6BO,SAASG,EAAaC,GAC3Bd,EAAmBc,CACrB,CC3EO,MAAMC,EAQX3G,YAAY4G,GACV1G,KAAK2G,sBAAwBD,EAC7B1G,KAAK4G,SAAW,IAAIpB,EAWpBxF,KAAK6G,iBAAmB,IAAIC,IAI5B9G,KAAK+G,oBAAsB,IAAIC,eAE/BhH,KAAKC,WAAa,IAAIJ,EAGtBG,KAAKiH,iBAAmB,CACtB,CACEC,cAAe,IACfxD,OAAQ,QACRC,OAAQ,OACR5G,KAAM,WAER,CACEmK,cAAe,IACfxD,OAAQ,QACRC,OAAQ,UACR5G,KAAM,WAER,CACEmK,cAAelH,KAAK2G,sBACpBjD,OAAQ,UACRC,OAAQ,OACR5G,KAAM,WAER,CACEmK,cAAelH,KAAK2G,sBACpBjD,OAAQ,WACRC,OAAQ,UACR5G,KAAM,YAIViD,KAAKmH,SACP,CAEAA;AACE,MAAMC,EAAe,wBACfC,EAAyC,IAAIP,IAG7CQ,EAAcnF,IACdkF,EAAWE,IAAIpF,KAOnBkF,EAAWhK,IAAI8E,GACf6D,EAAU,IAAI7C,MAAMhB,GAAUiF,GAAa,ED3H1C,IAAuB/C,EAAU4B,ECuMpCjG,KAAKC,WAAW5C,IACdgB,OACA,WDzMwBgG,EC+HJ/E,IACpB,MAAM0C,KAAEA,EAAIwF,OAAEA,EAAM7E,OAAEA,GAAWrD,EAEjC,IAAKyC,EAAUC,IAAuB,YAAdA,EAAKjF,KAE3B,OAGF,MAAM2G,OAAEA,EAAMC,OAAEA,EAAMP,UAAEA,EAASR,SAAEA,GAAaZ,EAC1CyF,EAAmC,GAAE/D,KAAUC,IAErD,IJrFC,SAAwBhB,GAC7B,QAIa,OAAXA,GACAA,aAAkB+E,aACjBrJ,OAAOsJ,eAAiBhF,aAAkBgF,cAM/C,CIwEWC,CAAejF,GAIlB,YAHA2E,EACG,oCAAmCG,4BAexC,QAAc1B,IAVA/F,KAAKiH,iBAAiBY,MAClC,EAAGX,mBAAkBY,KACnB9H,KAAK+H,gBAAgB,CACnBD,iBACAZ,gBACAlF,OACAwF,aAQJ,YAHAF,EACG,4CAA2CG,UAAgBD,KAKhE,GAAIxH,KAAK6G,iBAAiBU,IAAInE,GAC5B,OAEFpD,KAAK6G,iBAAiBxJ,IAAI+F,GAI1B,MAAM4E,EACQ,iBAAZP,EACIzH,KAAK+G,oBACL,IAAIC,eAMJ7E,EAAU,CAAEuB,SAAQC,SAAQ5G,KAAM,QAASqG,YAAWR,YAStDqF,EAA0B,SAAXT,EAAoB,IAAMA,EAC/C7E,EAAOc,YAAYtB,EAAS8F,EAAc,CAACD,EAAeE;AAE3C,YAAXvE,EACF3D,KAAK+G,oBAAoBoB,MAAM1E,YAAYtB,EAAS,CAClD6F,EAAeG,QAEG,SAAXxE,GACT3D,KAAK4G,SAAS7B,KAAK,iBAAkBrB,EAAQsE,EAAeG,MAC9D,EDpMkClC,EC0MLmB,EDzM1B,IAAIgB,KACT,IACE,OAAO/D,KAAY+D,EAIrB,CAHE,MAAOxC,GAEP,MADAI,EAAUJ,EAAKK,GACTL,CACR,ICqMF,CAYAmC,iBAAgBD,eAAEA,EAAcZ,cAAEA,EAAalF,KAAEA,EAAIwF,OAAEA,IACrD,OAAsB,MAAlBN,GAAyBM,IAAWN,IAIjChF,EAAeF,EAAM8F,EAC9B,CAOA3D,GAAGkE,EAAWC,GACZtI,KAAK4G,SAASzC,GAAGkE,EAAWC,EAC9B,CAEAtF,UACEhD,KAAKC,WAAWY,WAClB,EC9NF,MAAM0H,EAAU,QACVC,EAAW,YAiCjB,SAASC,EAASC,EAAMC,EAAQP,EAAO,GAAIQ,GAAW,GACpDF,EAAKjF,YAC4B,CAC7BoF,SAAUL,EACVM,QAASP,EACT1D,UAAWuD,EACXO,SACAC,YAGN,CAwCA,SAASG,EAA0BC,GACjC,MAAMC,EAAqBD,EAAUE,MAAM,6BAC3C,IAAKD,EACH,OAAO,EAOT,QALgBE,SAASF,EAAmB,KAK7B,IAKjB,CA0CO,MAAMG,EAMXtJ,aAAYkJ,UACVA,EAAYK,UAAUL,UAASM,cAC/BA,EAAgBjL,QACd,IAEF2B,KAAKuJ,MAAQ,KAGbvJ,KAAKwJ,SAAW,IAAItJ,IAEpBF,KAAKyJ,UAAY,EAGjBzJ,KAAK0J,WAAa,IAAIxJ,IAEtBF,KAAKC,WAAa,IAAIJ,EACtBG,KAAKC,WAAW5C,IAAIiM,EAAe,UAAU,KACvCtJ,KAAKuJ,QAGPd,EAASzI,KAAKuJ,MAAO,SAMnBD,IAAkBA,EAAcK,QAChCZ,EAA0BC,IAE1BM,EAAcK,OAAOlG,YACnB,CAAE1G,KAAM,wBACR,IACA,CAACiD,KAAKuJ,QAGZ,IAQFvJ,KAAK4J,cAAgB,GAErB5J,KAAK6J,qBAAsB,CAC7B,CAcA1F,GAAGwE,EAAQL;AACT,GAAItI,KAAKuJ,MACP,MAAM,IAAIpG,MAAM,yDAElBnD,KAAKwJ,SAAS/I,IAAIkI,EAA4BL,EAChD,CAOAwB,QAAQpB,GACN1I,KAAKuJ,MAAQb,EACb1I,KAAKC,WAAW5C,IAAIqL,EAAM,WAAWpJ,GAASU,KAAK+J,QAAQzK,KAC3DoJ,EAAKsB,QACLvB,EAASC,EAAM,WAEf,IAAK,IAAKC,EAAQP,KAASpI,KAAK4J,cAC9B5J,KAAKiF,KAAK0D,KAAWP,GAEvBpI,KAAK4J,cAAgB,EACvB,CAKA5G,UACMhD,KAAKuJ,QACPd,EAASzI,KAAKuJ,MAAO,SACrBvJ,KAAKuJ,MAAMU,SAEbjK,KAAKkK,YAAa,EAClBlK,KAAKC,WAAWY,WAClB,CAcAoE,KAAK0D,KAAWP,GAKd,GAJKpI,KAAKuJ,OACRvJ,KAAK4J,cAAcrF,KAAK,CAACoE,EAAQP,KAG9BpI,KAAKuJ,OAASvJ,KAAKkK,WACtB,OAGF,MAAMC,EAAMnK,KAAKyJ,YACXW,EAAWhC,EAAKA,EAAKhH,OAAS,GAzJd,mBA0JPgJ,IACbpK,KAAK0J,WAAWjJ,IAAI0J,EAAKC,GACzBhC,EAAOA,EAAKpD,MAAM,GAAI,IAGxByD,EAASzI,KAAKuJ,MAAOZ,EAAQP,EAAM+B,EACrC,CAQAE,eAAcrI,KAAEA,IACd,OAAKA,GAAwB,iBAATA,EAGhBA,EAAK6G,WAAaL,GAGlBxG,EAAK8G,UAAYP,EAFZ,KAKJ5G,MAAM2I,QAAQtI,EAAK6C,WAIjB7C,EAHE,KATA,IAaX,CAKA+H,QAAQzK,GACN,MAAMiL,EAAMvK,KAAKqK,cAAc/K,GACzBoJ,EAAO1I,KAAKuJ,MAElB,GAAKgB,GAAQ7B,EAIb,GAAI,WAAY6B,EAAK,CAEnB,GAAmB,UAAfA,EAAI5B,OAAoB,CAC1B,GAAI3I,KAAK6J,oBACP,OAEA7J,KAAK6J,qBAAsB,CAE/B,CAEA,MAAMvB,EAAUtI,KAAKwJ,SAAS7I,IAAI4J,EAAI5B,QACtC,IAAKL,EACH,OAIF,MAAMjE,EAAWA,IAAI+D,KAEnB,MAAMjG,EAAU,CACd0C,UAAWuD,EACXS,SAAUL;AACVgC,SAAUD,EAAI3B,SACdE,QAASP,GAGXG,EAAKjF,YAAYtB,EAAQ,EAE3BmG,KAAWiC,EAAI1F,UAAWR,EAC5B,MAAO,GAAI,aAAckG,EAAK,CAC5B,MAAME,EAAKzK,KAAK0J,WAAW/I,IAAI4J,EAAIC,UACnCxK,KAAK0J,WAAW9I,OAAO2J,EAAIC,UACvBC,GACFA,KAAMF,EAAI1F,UAEd,CACF,ECjWK,SAAS6F,EAAUC,GACxB,GAAqB,iBAAVA,GACgC,UAArCA,EAAMC,OAAOC,oBAEf,OAAO,EAGX,MAAMC,EAAeC,OAAOJ,GAC5B,OAAKK,MAAMF,GAIa,iBAAVH,EAHLM,QAAQH,EAInB,CCbO,SAASI,EAAgBvO,GAO9B,IALA,IAAMwO,EAAS,CAAA,EACTC,EAAmBzO,EAAS0O,iBAChC,+BAGOlG,EAAI,EAAGA,EAAIiG,EAAiBhK,OAAQ+D,IAAK,CAChD,IAAImG,OAAQ,EACZ,IACEA,EAAWlJ,KAAKmJ,MAAMH,EAAiBjG,GAAGqG,aAAe,GAO3D,CANE,MAAO5F,GACPS,QAAQC,KACN,0DACAV,GAEF0F,EAAW,CAAA,CACb,CACAhJ,OAAOmJ,OAAON,EAAQG,EACxB,CAEA,OAAOH,CACT,CC7BO,SAASO,EAAOC,EAAQ1J,GAC7B,OAAOK,OAAO4B,UAAU0H,eAAe3G,KAAK0G,EAAQ1J,EACtD,CCEO,SAAS4J,EACdC,EACAC,EACAhP,GAEA,MAAMiP,EAAOF,EAAQnP,SAASsP,cAC3B,oCAAmClP,YAAegP,OAGrD,IAAKC,EACH,MAAM,IAAI7I,MACP,4BAA2BpG,WAAcgP,4BAI9C,IAAKC,EAAKE,KACR,MAAM,IAAI/I,MACP,yBAAwBpG,WAAcgP,wBAI3C,OAAOC,EAAKE,IACd,CCdA,SAASC,EAAcxB,GACrB,MAAwB,iBAAVA,EAAqBA,EAAQ,IAC7C;AAEO,SAASyB,EAAaN,GAI3B,MAAMO,ECLD,SACLP,GAEA,IAAKJ,EAAOI,EAAS,oBACnB,MAAO,GAGT,GAAwC,mBAA7BA,EAAQQ,iBAAiC,CAClD,MAAMC,EACJ,gGAEF,OADAlG,QAAQC,KAAK,6CAA+CiG,GACrD,EACT,CAEA,OAAOT,EAAQQ,kBACjB,CDV6BE,CAAuBV,GAE5CW,EAAuC/B,EAC3C2B,EAAmBK,0BAEjB,CAAA,EACAxB,EAAgBY,EAAQnP,UA4G5B,SAASgQ,EAAgBvI,GACvB,OAAIsH,EAAOW,EAAoBjI,GACtBiI,EAAmBjI,GAGxBsH,EAAOe,EAAarI,GACfqI,EAAYrI,QADrB,CAKF,CAEA,MAAO,CACDwI,kBACF,OAlGKT,EAAcM,EAAYG,cAZjC,WAGE,MAAMC,EAAqBf,EAAQgB,SAASZ,KAAKhD,MAC/C,kCAEF,OAAI2D,EACKA,EAAmB,GAErB,IACT,CAEiDE,EAmGhD,EACGC,gBACF,OAAOnB,EAAeC,EAAS,oBAAqB,aACrD,EACGmB,YACF,OAlFKd,EAAcM,EAAYQ,QAVjC,WACE,MAAMC,EAAqBpB,EAAQgB,SAASZ,KAAKhD,MAC/C,wCAEF,OAAIgE,EACKA,EAAmB,GAErB,IACT,CAE2CC,EAmF1C,EACGC,qBACF,OAAOvB,EAAeC,EAAS,WAAY,OAC5C,EACGuB,oBACF,OAAOxB,EAAeC,EAAS,UAAW,OAC3C,EACGwB,qBACF,OAxFJ,WACE,MAAM3C,EAAQgC,EAAgB,kBAE9B,OAAQhC,GACN,IAAK,SACL,IAAK,QACL,IAAK,kBACH,OAAOA,EACT,KAAK,EACH,MAAO;CACT,KAAK,EACH,MAAO,QACT,QACE,MAAO,SAEb,CAyEW2C,EACR,EACGC,oBACF,OAAO1B,EAAeC,EAAS,UAAW,OAC3C,EACG0B,YACF,OAhDKrB,EAAcM,EAAYe,QAdjC,WACE,MAAMC,EAAqB3B,EAAQgB,SAASZ,KAAKhD,MAC/C,iCAEF,GAAIuE,EACF,IACE,OAAOC,mBAAmBD,EAAmB,GAE7C,CADA,MAAO7H,GACP,CAGJ,OAAO,IACT,CAE2C+H,EAiD1C,EACDhB,kBAEJ,CEhGA,MAAMiB,EAAkCA,CAACtC,EAAUlH,IACjDkH,EAASqB,gBAAgBvI,GAKrByJ,EAAyC,CAC7CjB,YAAa,CACXkB,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAASsB,aAEjCqB,QAAS,CACPH,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZM,SAAU,CACRH,aAAc,KACdD,mBAAmB,EACnBE,SAAUJ,GAIZZ,UAAW,CACTc,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAAS0B,WAEjCmB,kBAAmB,CACjBL,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZQ,gCAAiC,CAC/BN,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZX,MAAO,CACLa,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAAS2B,OAEjCoB,MAAO,CACLP,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZU,MAAO,CACLR,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZW,YAAa,CACXT,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZY,eAAgB;AACdV,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZa,YAAa,CACXX,mBAAmB,EACnBC,cAAc,EACdW,OAAQhE,EACRsD,SAAUJ,GAEZJ,MAAO,CACLM,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAASkC,OAEjCmB,uBAAwB,CACtBb,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZgB,SAAU,CACRd,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZN,eAAgB,CACdQ,mBAAmB,EACnBC,aAAc,SACdC,SAAU1C,GAAYA,EAASgC,gBAEjCF,eAAgB,CACdU,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAAS8B,gBAEjCC,cAAe,CACbS,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAAS+B,eAEjCE,cAAe,CACbO,mBAAmB,EACnBC,aAAc,KACdC,SAAU1C,GAAYA,EAASiC,eAIjCsB,mBAAoB,CAClBf,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,GAEZkB,0BAA2B,CACzBhB,mBAAmB,EACnBC,aAAc,KACdC,SAAUJ,IAeP,SAASmB,EAAU9I,EAAkB6F,EAAkBzN,QAC5D,MAAMiN,EAAWc,EAAaN,GACxBX,EAAkC,CAAA,EAIxC,IAAK,MAAM6D,KA1Lb,SAA2B/I,GACzB,MAAMgJ,EAAW,CACfC,UAAW,CAAC,YAAa,oBAAqB;AAC9CC,QAAS,CACP,UACA,cACA,WACA,kCACA,4BACA,QACA,QACA,iBACA,cACA,QACA,yBACA,WACA,iBACA,gBACA,QACA,eAEFC,SAAU,CACR,WACA,QACA,iBACA,yBACA,WACA,QACA,eAEFC,QAAS,CAAC,kBAGZ,OAAQpJ,GACN,IAAK,YACH,OAAOgJ,EAASC,UAClB,IAAK,UACH,OAAOD,EAASE,QAClB,IAAK,WACH,OAAOF,EAASG,SAClB,IAAK,UACH,OAAOH,EAASI,QAClB,IAAK,MAEH,OAAO/M,OAAOgN,OAAOL,GAAUM,OACjC,QACE,MAAM,IAAIpM,MAAO,sCAAqC8C,MAE5D,CA0IoBuJ,CAAkBvJ,GAAU,CAC5C,MAAMwJ,EAAY5B,EAAkBmB,GAC9BU,OAAwC3J,IAA3B0J,EAAU1B,aACvB4B,KC7NyB5T,ED8N7B8P,EAAeC,EAAS,UAAW,SC7N1B8D,WAAW,YAAc7T,EAAI6T,WAAW,aDiOnD,IAAKH,EAAU3B,mBAAqB6B,EAA2B,CAGzDD,IACFvE,EAAO6D,GAAOS,EAAU1B,cAE1B,QACF,CAGA,MAAMpD,EAAQ8E,EAAUzB,SAAS1C,EAAU0D,QAC7BjJ,IAAV4E,EAUJQ,EAAO6D,GAAOS,EAAUf,OAASe,EAAUf,OAAO/D,GAASA,EAPrD+E,IACFvE,EAAO6D,GAAOS,EAAU1B,aAO9B,CCxPK,IAA4BhS,ED0PjC,OAAOoP,CACT,CE/PG,IAAC0E,EAAEC,EAAEC,EAAIC,EAAEC,EAAEC,EAAEC,EAAEvS,EAAEwS,EAAE,CAAA,EAAGC,EAAE,GAAGC,EAAE;CAAoE,SAASC,EAAEV,EAAEC,GAAG,IAAI,IAAIC,KAAKD,EAAED,EAAEE,GAAGD,EAAEC,GAAG,OAAOF,CAAC,CAAC,SAASW,EAAEX,GAAG,IAAIC,EAAED,EAAEY,WAAWX,GAAGA,EAAEY,YAAYb,EAAE,CAAsS,SAASc,EAAEd,EAAE1K,EAAE6K,EAAEC,EAAEC,GAAG,IAAIC,EAAE,CAACpT,KAAK8S,EAAEe,MAAMzL,EAAE6J,IAAIgB,EAAEa,IAAIZ,EAAEa,IAAI,KAAKC,GAAG,KAAKC,IAAI,EAAEC,IAAI,KAAKC,SAAI,EAAOC,IAAI,KAAKC,IAAI,KAAKtR,iBAAY,EAAOuR,IAAI,MAAMnB,IAAIH,EAAEG,GAAG,OAAO,MAAMA,GAAG,MAAMJ,EAAEwB,OAAOxB,EAAEwB,MAAMnB,GAAGA,CAAC,CAAmC,SAASrL,EAAE+K,GAAG,OAAOA,EAAE0B,QAAQ,CAAC,SAASC,EAAE3B,EAAEC,GAAG9P,KAAK4Q,MAAMf,EAAE7P,KAAKiG,QAAQ6J,CAAC,CAAC,SAAS2B,EAAE5B,EAAEC,GAAG,GAAG,MAAMA,EAAE,OAAOD,EAAEkB,GAAGU,EAAE5B,EAAEkB,GAAGlB,EAAEkB,GAAGD,IAAIY,QAAQ7B,GAAG,GAAG,KAAK,IAAI,IAAIE,EAAED,EAAED,EAAEiB,IAAI1P,OAAO0O,IAAI,GAAG,OAAOC,EAAEF,EAAEiB,IAAIhB,KAAK,MAAMC,EAAEkB,IAAI,OAAOlB,EAAEkB,IAAI,MAAM,mBAAmBpB,EAAE9S,KAAK0U,EAAE5B,GAAG,IAAI,CAAC,SAAS8B,EAAE9B,GAAG,IAAIC,EAAEC,EAAE,GAAG,OAAOF,EAAEA,EAAEkB,KAAK,MAAMlB,EAAEsB,IAAI,CAAC,IAAItB,EAAEoB,IAAIpB,EAAEsB,IAAIS,KAAK,KAAK9B,EAAE,EAAEA,EAAED,EAAEiB,IAAI1P,OAAO0O,IAAI,GAAG,OAAOC,EAAEF,EAAEiB,IAAIhB,KAAK,MAAMC,EAAEkB,IAAI,CAACpB,EAAEoB,IAAIpB,EAAEsB,IAAIS,KAAK7B,EAAEkB,IAAI,KAAK,CAAC,OAAOU,EAAE9B,EAAE,CAAC,CAAC,SAASgC,EAAEhC,KAAKA,EAAEqB,MAAMrB,EAAEqB,KAAI,IAAKlB,EAAEzL,KAAKsL,KAAKiC,EAAEC,OAAO9B,IAAIH,EAAEkC,sBAAsB/B,EAAEH,EAAEkC,oBAAoB9B,GAAG4B,EAAE,CAAC,SAASA,IAAI,IAAIjC,EAAEC,EAAEC,EAAE5K,EAAE8K,EAAEC,EAAEtS,EAAEwS,EAAE,IAAIJ,EAAExN,KAAK2N,GAAGN,EAAEG,EAAEiC,SAASpC,EAAEqB,MAAMpB,EAAEE,EAAE5O,OAAO+D,OAAE,EAAO8K,OAAE,EAAOrS,GAAGsS,GAAGH,EAAEF,GAAGwB,KAAKJ,KAAKb,EAAEL,EAAEmC,OAAO/M,EAAE;CAAI8K,EAAEM,EAAE,CAAA,EAAGL,IAAImB,IAAInB,EAAEmB,IAAI,EAAEc,GAAE/B,EAAEF,EAAED,EAAEF,EAAEqC,SAAI,IAAShC,EAAEiC,gBAAgB,MAAMnC,EAAEkB,IAAI,CAACxT,GAAG,KAAKuH,EAAE,MAAMvH,EAAE6T,EAAEvB,GAAGtS,EAAEsS,EAAEkB,KAAKkB,GAAEnN,EAAE+K,GAAGA,EAAEe,KAAKrT,GAAG+T,EAAEzB,IAAIF,EAAE5O,OAAO0O,GAAGE,EAAExN,KAAK2N,IAAI2B,EAAEC,IAAI,CAAC,CAAC,SAASQ,EAAE1C,EAAEC,EAAEC,EAAE5K,EAAE6K,EAAEC,EAAEC,EAAEC,EAAEvS,EAAE0S,GAAG,IAAIC,EAAEC,EAAEgC,EAAEC,EAAEjB,EAAEG,EAAEE,EAAEC,EAAE3M,GAAGA,EAAE2L,KAAKT,EAAEkC,EAAET,EAAE1Q,OAAO,IAAI2O,EAAEe,IAAI,GAAGP,EAAE,EAAEA,EAAET,EAAE1O,OAAOmP,IAAI,GAAG,OAAOkC,EAAE1C,EAAEe,IAAIP,GAAG,OAAOkC,EAAE3C,EAAES,KAAK,kBAAkBkC,GAAG,mBAAmBA,EAAE,KAAK,iBAAiBA,GAAG,iBAAiBA,GAAG,iBAAiBA,EAAE9B,EAAE,KAAK8B,EAAE,KAAK,KAAKA,GAAG9Q,MAAM2I,QAAQmI,GAAG9B,EAAE7L,EAAE,CAACyM,SAASkB,GAAG,KAAK,KAAK,MAAMA,EAAEzB,IAAI,EAAEL,EAAE8B,EAAE1V,KAAK0V,EAAE7B,MAAM6B,EAAEzD,IAAIyD,EAAE5B,IAAI4B,EAAE5B,IAAI,KAAK4B,EAAEpB,KAAKoB,GAAG,CAAC,GAAGA,EAAE1B,GAAGhB,EAAE0C,EAAEzB,IAAIjB,EAAEiB,IAAI,EAAE,QAAQwB,EAAEV,EAAEvB,KAAKiC,GAAGC,EAAEzD,KAAKwD,EAAExD,KAAKyD,EAAE1V,OAAOyV,EAAEzV,KAAK+U,EAAEvB,QAAG,OAAY,IAAIC,EAAE,EAAEA,EAAE+B,EAAE/B,IAAI,CAAC,IAAIgC,EAAEV,EAAEtB,KAAKiC,EAAEzD,KAAKwD,EAAExD,KAAKyD,EAAE1V,OAAOyV,EAAEzV,KAAK,CAAC+U,EAAEtB,QAAG,EAAO,KAAK,CAACgC,EAAE,IAAI,CAACL,GAAEtC,EAAE4C,EAAED,EAAEA,GAAGpC,EAAEJ,EAAEC,EAAEC,EAAEC,EAAEvS,EAAE0S,GAAGkB,EAAEiB,EAAExB,KAAKT,EAAEiC,EAAE5B,MAAM2B,EAAE3B,KAAKL,IAAIqB,IAAIA,EAAE,IAAIW,EAAE3B,KAAKgB,EAAEtN,KAAKiO,EAAE3B,IAAI,KAAK4B,GAAGZ,EAAEtN,KAAKiM,EAAEiC,EAAEtB,KAAKK,EAAEiB,IAAI,MAAMjB,GAAG,MAAMG,IAAIA,EAAEH,GAAG,mBAAmBiB,EAAE1V,MAAM0V,EAAE3B,MAAM0B,EAAE1B,IAAI2B,EAAEvB,IAAItT,EAAE8U,EAAED,EAAE7U,EAAEiS,GAAGjS,EAAE+U,EAAE9C,EAAE4C,EAAED,EAAEV,EAAEN,EAAE5T,GAAG,mBAAmBmS,EAAEhT,OAAOgT,EAAEmB,IAAItT,IAAIA,GAAG4U,EAAEvB,KAAKrT,GAAGA,EAAE6S,YAAYZ,IAAIjS,EAAE6T,EAAEe,GAAG;AAAC,IAAIzC,EAAEkB,IAAIU,EAAEpB,EAAEgC,EAAEhC,KAAK,MAAMuB,EAAEvB,KAAK,mBAAmBR,EAAEhT,MAAM,MAAM+U,EAAEvB,GAAGU,KAAKa,EAAEvB,GAAGU,KAAKlB,EAAEmB,MAAMnB,EAAEmB,IAAI0B,GAAEzN,GAAG0N,aAAaC,GAAEhB,EAAEvB,GAAGuB,EAAEvB,KAAK,GAAGsB,EAAE,IAAItB,EAAE,EAAEA,EAAEsB,EAAEzQ,OAAOmP,IAAIwC,GAAElB,EAAEtB,GAAGsB,IAAItB,GAAGsB,IAAItB,GAAG,CAAC,SAASmC,EAAE7C,EAAEC,EAAEC,GAAG,IAAI,IAAI5K,EAAE6K,EAAEH,EAAEiB,IAAIb,EAAE,EAAED,GAAGC,EAAED,EAAE5O,OAAO6O,KAAK9K,EAAE6K,EAAEC,MAAM9K,EAAE4L,GAAGlB,EAAEC,EAAE,mBAAmB3K,EAAEpI,KAAK2V,EAAEvN,EAAE2K,EAAEC,GAAG4C,EAAE5C,EAAE5K,EAAEA,EAAE6K,EAAE7K,EAAE8L,IAAInB,IAAI,OAAOA,CAAC,CAAyH,SAAS6C,EAAE9C,EAAEC,EAAEC,EAAE5K,EAAE6K,EAAEC,GAAG,IAAIC,EAAEC,EAAEvS,EAAE,QAAG,IAASkS,EAAEoB,IAAIhB,EAAEJ,EAAEoB,IAAIpB,EAAEoB,SAAI,OAAY,GAAG,MAAMnB,GAAGC,GAAGC,GAAG,MAAMD,EAAES,WAAWZ,EAAE,GAAG,MAAMI,GAAGA,EAAEQ,aAAaZ,EAAEA,EAAEmD,YAAYhD,GAAGE,EAAE,SAAS,CAAC,IAAIC,EAAEF,EAAErS,EAAE,GAAGuS,EAAEA,EAAE0C,cAAcjV,EAAEuH,EAAE/D,OAAOxD,GAAG,EAAE,GAAGuS,GAAGH,EAAE,MAAMH,EAAEA,EAAEoD,aAAajD,EAAEC,GAAGC,EAAED,CAAC,CAAC,YAAO,IAASC,EAAEA,EAAEF,EAAE6C,WAAW,CAAC,SAASD,GAAE/C,GAAG,IAAIC,EAAEC,EAAE5K,EAAE,GAAG,MAAM0K,EAAE9S,MAAM,iBAAiB8S,EAAE9S,KAAK,OAAO8S,EAAEoB,IAAI,GAAGpB,EAAEiB,IAAI,IAAIhB,EAAED,EAAEiB,IAAI1P,OAAO,EAAE0O,GAAG,EAAEA,IAAI,IAAIC,EAAEF,EAAEiB,IAAIhB,MAAM3K,EAAEyN,GAAE7C,IAAI,OAAO5K,EAAE,OAAO,IAAI,CAA4N,SAAS+N,GAAErD,EAAEC,EAAEC,GAAG,MAAMD,EAAE,GAAGD,EAAEsD,YAAYrD,EAAE,MAAMC,EAAE,GAAGA,GAAGF,EAAEC,GAAG,MAAMC,EAAE,GAAG,iBAAiBA,GAAGO,EAAE8C,KAAKtD,GAAGC,EAAEA,EAAE,IAAI,CAAC,SAASsD,GAAExD,EAAEC,EAAEC,EAAE5K,EAAE6K,GAAG,IAAIC,EAAEJ,EAAE,GAAG,UAAUC,EAAE,GAAG,iBAAiBC,EAAEF,EAAEyD,MAAMC,QAAQxD,MAAM;AAAC,GAAG,iBAAiB5K,IAAI0K,EAAEyD,MAAMC,QAAQpO,EAAE,IAAIA,EAAE,IAAI2K,KAAK3K,EAAE4K,GAAGD,KAAKC,GAAGmD,GAAErD,EAAEyD,MAAMxD,EAAE,IAAI,GAAGC,EAAE,IAAID,KAAKC,EAAE5K,GAAG4K,EAAED,KAAK3K,EAAE2K,IAAIoD,GAAErD,EAAEyD,MAAMxD,EAAEC,EAAED,GAAG,MAAM,GAAG,MAAMA,EAAE,IAAI,MAAMA,EAAE,GAAGG,EAAEH,KAAKA,EAAEA,EAAE0D,QAAQ,WAAW,KAAK1D,EAAEA,EAAE/Q,gBAAgB8Q,EAAEC,EAAE/Q,cAAciG,MAAM,GAAG8K,EAAE9K,MAAM,GAAG6K,EAAEC,IAAID,EAAEC,EAAE,CAAE,GAAED,EAAEC,EAAEA,EAAEG,GAAGF,EAAEA,EAAE5K,GAAG0K,EAAElR,iBAAiBmR,EAAEG,EAAEwD,GAAEC,GAAEzD,GAAGJ,EAAE/Q,oBAAoBgR,EAAEG,EAAEwD,GAAEC,GAAEzD,QAAQ,GAAG,4BAA4BH,EAAE,CAAC,GAAGE,EAAEF,EAAEA,EAAE0D,QAAQ,cAAc,KAAKA,QAAQ,SAAS,UAAU,GAAG,UAAU1D,GAAG,WAAWA,GAAG,SAASA,GAAG,SAASA,GAAG,SAASA,GAAG,aAAaA,GAAG,aAAaA,GAAGA,KAAKD,EAAE,IAAIA,EAAEC,GAAG,MAAMC,EAAE,GAAGA,EAAE,MAAMF,CAAY,CAAV,MAAMA,GAAI,CAAA,mBAAmBE,IAAI,MAAMA,IAAG,IAAKA,GAAG,MAAMD,EAAE,GAAGD,EAAEnS,gBAAgBoS,GAAGD,EAAEvS,aAAawS,EAAEC,GAAG,CAAC,CAAC,SAAS2D,GAAE7D,GAAG,OAAO7P,KAAK8P,EAAED,EAAE9S,MAAK,GAAI+S,EAAExQ,MAAMwQ,EAAExQ,MAAMuQ,GAAGA,EAAE,CAAC,SAAS4D,GAAE5D,GAAG,OAAO7P,KAAK8P,EAAED,EAAE9S,MAAK,GAAI+S,EAAExQ,MAAMwQ,EAAExQ,MAAMuQ,GAAGA,EAAE,CAAC,SAASsC,GAAEtC,EAAEE,EAAE5K,EAAE6K,EAAEC,EAAEC,EAAEC,EAAEvS,EAAEwS,GAAG,IAAIC,EAAEC,EAAEE,EAAEgC,EAAE7B,EAAE8B,EAAEhB,EAAEE,EAAEE,EAAEC,EAAEY,EAAEiB,EAAEhB,EAAEC,EAAEgB,EAAEV,EAAEnD,EAAEhT,KAAK,QAAG,IAASgT,EAAEjQ,YAAY,OAAO,KAAK,MAAMqF,EAAEiM,MAAMhB,EAAEjL,EAAEiM,IAAIxT,EAAEmS,EAAEkB,IAAI9L,EAAE8L,IAAIlB,EAAEqB,IAAI,KAAKlB,EAAE,CAACtS,KAAKyS,EAAEP,EAAEkB,MAAMX,EAAEN,GAAG;AAAIF,EAAE,GAAG,mBAAmBqD,EAAE,CAAC,GAAGvB,EAAE5B,EAAEa,MAAMiB,GAAGxB,EAAE6C,EAAEW,cAAc7D,EAAEK,EAAEc,KAAKW,EAAEzB,EAAEwB,EAAEA,EAAEjB,MAAMjG,MAAM0F,EAAEU,GAAGf,EAAE7K,EAAEgM,IAAIM,GAAGnB,EAAEP,EAAEoB,IAAIhM,EAAEgM,KAAKJ,GAAGT,EAAEwD,KAAK,cAAcZ,GAAGA,EAAEhP,UAAU6P,OAAOhE,EAAEoB,IAAIb,EAAE,IAAI4C,EAAEvB,EAAEG,IAAI/B,EAAEoB,IAAIb,EAAE,IAAIkB,EAAEG,EAAEG,GAAGxB,EAAExQ,YAAYoT,EAAE5C,EAAEyD,OAAOC,IAAGnC,GAAGA,EAAEoC,IAAI3D,GAAGA,EAAEM,MAAMe,EAAErB,EAAE4D,QAAQ5D,EAAE4D,MAAM,IAAI5D,EAAErK,QAAQ6L,EAAExB,EAAE8B,IAAIpC,EAAEQ,EAAEF,EAAEY,KAAI,EAAGZ,EAAEc,IAAI,GAAGd,EAAE6D,IAAI,IAAI,MAAM7D,EAAE8D,MAAM9D,EAAE8D,IAAI9D,EAAE4D,OAAO,MAAMhB,EAAEmB,2BAA2B/D,EAAE8D,KAAK9D,EAAE4D,QAAQ5D,EAAE8D,IAAI7D,EAAE,CAAA,EAAGD,EAAE8D,MAAM7D,EAAED,EAAE8D,IAAIlB,EAAEmB,yBAAyB1C,EAAErB,EAAE8D,OAAO5B,EAAElC,EAAEM,MAAMD,EAAEL,EAAE4D,MAAM5D,EAAEe,IAAItB,EAAES,EAAE,MAAM0C,EAAEmB,0BAA0B,MAAM/D,EAAEgE,oBAAoBhE,EAAEgE,qBAAqB,MAAMhE,EAAEiE,mBAAmBjE,EAAEc,IAAI7M,KAAK+L,EAAEiE,uBAAuB,CAAC,GAAG,MAAMrB,EAAEmB,0BAA0B1C,IAAIa,GAAG,MAAMlC,EAAEkE,2BAA2BlE,EAAEkE,0BAA0B7C,EAAEG,IAAIxB,EAAEW,KAAK,MAAMX,EAAEmE,wBAAuB,IAAKnE,EAAEmE,sBAAsB9C,EAAErB,EAAE8D,IAAItC,IAAI/B,EAAEsB,MAAMlM,EAAEkM,IAAI,CAAC,IAAItB,EAAEsB,MAAMlM,EAAEkM,MAAMf,EAAEM,MAAMe,EAAErB,EAAE4D,MAAM5D,EAAE8D,IAAI9D,EAAEY,KAAI,GAAIZ,EAAEW,KAAI,EAAGlB,EAAEkB,IAAI9L,EAAE8L,IAAIlB,EAAEe,IAAI3L,EAAE2L,IAAIf,EAAEe,IAAIhQ,SAAQ,SAAS+O,GAAGA,IAAIA,EAAEkB,GAAGhB,EAAE;AAAG2C,EAAE,EAAEA,EAAEpC,EAAE6D,IAAI/S,OAAOsR,IAAIpC,EAAEc,IAAI7M,KAAK+L,EAAE6D,IAAIzB,IAAIpC,EAAE6D,IAAI,GAAG7D,EAAEc,IAAIhQ,QAAQ+O,EAAE5L,KAAK+L,GAAG,MAAMT,CAAC,CAAC,MAAMS,EAAEoE,qBAAqBpE,EAAEoE,oBAAoB/C,EAAErB,EAAE8D,IAAItC,GAAG,MAAMxB,EAAEqE,oBAAoBrE,EAAEc,IAAI7M,MAAK,WAAW+L,EAAEqE,mBAAmBnC,EAAE7B,EAAE8B,EAAE,GAAE,CAAC,GAAGnC,EAAErK,QAAQ6L,EAAExB,EAAEM,MAAMe,EAAErB,EAAE4B,IAAIrC,EAAE8D,EAAE7D,EAAEiC,IAAIY,EAAE,EAAE,cAAcO,GAAGA,EAAEhP,UAAU6P,OAAO,CAAC,IAAIzD,EAAE4D,MAAM5D,EAAE8D,IAAI9D,EAAEY,KAAI,EAAGyC,GAAGA,EAAE5D,GAAGM,EAAEC,EAAEyD,OAAOzD,EAAEM,MAAMN,EAAE4D,MAAM5D,EAAErK,SAAS2M,EAAE,EAAEA,EAAEtC,EAAE6D,IAAI/S,OAAOwR,IAAItC,EAAEc,IAAI7M,KAAK+L,EAAE6D,IAAIvB,IAAItC,EAAE6D,IAAI,EAAE,MAAM,GAAG7D,EAAEY,KAAI,EAAGyC,GAAGA,EAAE5D,GAAGM,EAAEC,EAAEyD,OAAOzD,EAAEM,MAAMN,EAAE4D,MAAM5D,EAAErK,SAASqK,EAAE4D,MAAM5D,EAAE8D,UAAU9D,EAAEY,OAAOyB,EAAE,IAAIrC,EAAE4D,MAAM5D,EAAE8D,IAAI,MAAM9D,EAAEsE,kBAAkB5E,EAAEO,EAAEA,EAAE,GAAGP,GAAGM,EAAEsE,oBAAoBpE,GAAG,MAAMF,EAAEuE,0BAA0BpC,EAAEnC,EAAEuE,wBAAwBrC,EAAE7B,IAAIiD,EAAE,MAAMvD,GAAGA,EAAEtT,OAAO+H,GAAG,MAAMuL,EAAErB,IAAIqB,EAAEO,MAAMW,SAASlB,EAAEkC,EAAE1C,EAAElO,MAAM2I,QAAQsJ,GAAGA,EAAE,CAACA,GAAG7D,EAAE5K,EAAE6K,EAAEC,EAAEC,EAAEC,EAAEvS,EAAEwS,GAAGE,EAAEsB,KAAK7B,EAAEkB,IAAIlB,EAAEqB,IAAI,KAAKd,EAAEc,IAAIhQ,QAAQ+O,EAAE5L,KAAK+L,GAAGmB,IAAInB,EAAEwD,IAAIxD,EAAES,GAAG,MAAMT,EAAEW,KAAI,CAAE,MAAM,MAAMf,GAAGH,EAAEsB,MAAMlM,EAAEkM,KAAKtB,EAAEe,IAAI3L,EAAE2L,IAAIf,EAAEkB,IAAI9L,EAAE8L,KAAKlB,EAAEkB,IAAI6D,GAAE3P,EAAE8L,IAAIlB,EAAE5K,EAAE6K,EAAEC,EAAEC,EAAEC,EAAEC,IAAIC,EAAEP,EAAEiF,SAAS1E,EAAEN,EAA0F,CAAvF,MAAMF,GAAGE,EAAEsB,IAAI,MAAMjB,GAAG,MAAMF,KAAKH,EAAEkB,IAAIrT,EAAEmS,EAAEqB,MAAMhB;AAAEF,EAAEA,EAAEwB,QAAQ9T,IAAI,MAAMkS,EAAEmB,IAAIpB,EAAEE,EAAE5K,EAAE,CAAC,CAAC,SAASmN,GAAEzC,EAAEE,GAAGD,EAAEqB,KAAKrB,EAAEqB,IAAIpB,EAAEF,GAAGA,EAAEmF,MAAK,SAASjF,GAAG,IAAIF,EAAEE,EAAEqB,IAAIrB,EAAEqB,IAAI,GAAGvB,EAAEmF,MAAK,SAASnF,GAAGA,EAAE5K,KAAK8K,EAAE,GAA0B,CAAvB,MAAMF,GAAGC,EAAEmB,IAAIpB,EAAEE,EAAEsB,IAAI,CAAC,GAAE,CAAC,SAASyD,GAAEhF,EAAEC,EAAE5K,EAAE6K,EAAEC,EAAEC,EAAEC,EAAEvS,GAAG,IAAIyS,EAAEC,EAAEC,EAAEiC,EAAErN,EAAEyL,MAAMD,EAAEZ,EAAEa,MAAM6B,EAAE1C,EAAEhT,KAAK+H,EAAE,EAAE,GAAG,QAAQ2N,IAAIxC,GAAE,GAAI,MAAMC,EAAE,KAAKpL,EAAEoL,EAAE9O,OAAO0D,IAAI,IAAIuL,EAAEH,EAAEpL,KAAK,iBAAiBuL,KAAKoC,IAAIA,EAAEpC,EAAE4E,YAAYxC,EAAE,IAAIpC,EAAErR,UAAU,CAAC8Q,EAAEO,EAAEH,EAAEpL,GAAG,KAAK,KAAK,CAAC,GAAG,MAAMgL,EAAE,CAAC,GAAG,OAAO2C,EAAE,OAAO9V,SAASuY,eAAevE,GAAGb,EAAEG,EAAEtT,SAASwY,gBAAgB,6BAA6B1C,GAAG9V,SAASyY,cAAc3C,EAAE9B,EAAE0E,IAAI1E,GAAGT,EAAE,KAAKtS,GAAE,CAAE,CAAC,GAAG,OAAO6U,EAAED,IAAI7B,GAAG/S,GAAGkS,EAAE9N,OAAO2O,IAAIb,EAAE9N,KAAK2O,OAAO,CAAC,GAAGT,EAAEA,GAAGL,EAAE5K,KAAK6K,EAAEwF,YAAYhF,GAAGkC,EAAErN,EAAEyL,OAAOR,GAAGmF,wBAAwBhF,EAAEI,EAAE4E,yBAAyB3X,EAAE,CAAC,GAAG,MAAMsS,EAAE,IAAIsC,EAAE,CAAE,EAAC1N,EAAE,EAAEA,EAAEgL,EAAE0F,WAAWpU,OAAO0D,IAAI0N,EAAE1C,EAAE0F,WAAW1Q,GAAGV,MAAM0L,EAAE0F,WAAW1Q,GAAG6F,OAAO4F,GAAGD,KAAKC,IAAID,GAAGC,EAAEkF,QAAQnF,EAAEmF,QAAQlF,EAAEkF,SAAS3F,EAAE4F,aAAa5F,EAAE4F,UAAUnF,GAAGA,EAAEkF,QAAQ,IAAI,CAAC,GAAntI,SAAW5F,EAAEC,EAAEC,EAAE5K,EAAE6K,GAAG,IAAIC,EAAE,IAAIA,KAAKF,EAAE,aAAaE,GAAG,QAAQA,GAAGA,KAAKH,GAAGuD,GAAExD,EAAEI,EAAE,KAAKF,EAAEE,GAAG9K;CAAG,IAAI8K,KAAKH,EAAEE,GAAG,mBAAmBF,EAAEG,IAAI,aAAaA,GAAG,QAAQA,GAAG,UAAUA,GAAG,YAAYA,GAAGF,EAAEE,KAAKH,EAAEG,IAAIoD,GAAExD,EAAEI,EAAEH,EAAEG,GAAGF,EAAEE,GAAG9K,EAAE,CAA4/HyO,CAAE9D,EAAEa,EAAE6B,EAAEvC,EAAErS,GAAG2S,EAAER,EAAEe,IAAI,QAAQ,GAAGhM,EAAEiL,EAAEa,MAAMW,SAASgB,EAAEzC,EAAEnO,MAAM2I,QAAQxF,GAAGA,EAAE,CAACA,GAAGiL,EAAE5K,EAAE6K,EAAEC,GAAG,kBAAkBwC,EAAEvC,EAAEC,EAAED,EAAEA,EAAE,GAAG/K,EAAE2L,KAAKW,EAAEtM,EAAE,GAAGvH,GAAG,MAAMsS,EAAE,IAAIpL,EAAEoL,EAAE9O,OAAO0D,KAAK,MAAMoL,EAAEpL,IAAI0L,EAAEN,EAAEpL,IAAIlH,IAAI,UAAU+S,QAAG,KAAU7L,EAAE6L,EAAEhG,SAAS7F,IAAIgL,EAAEnF,OAAO,aAAa8H,IAAI3N,GAAG,WAAW2N,GAAG3N,IAAI0N,EAAE7H,QAAQ0I,GAAEvD,EAAE,QAAQhL,EAAE0N,EAAE7H,OAAM,GAAI,YAAYgG,QAAG,KAAU7L,EAAE6L,EAAEgF,UAAU7Q,IAAIgL,EAAE6F,SAAStC,GAAEvD,EAAE,UAAUhL,EAAE0N,EAAEmD,SAAQ,GAAI,CAAC,OAAO7F,CAAC,CAAC,SAASiD,GAAElD,EAAEE,EAAE5K,GAAG,IAAI,mBAAmB0K,EAAEA,EAAEE,GAAGF,EAAE+F,QAAQ7F,CAAqB,CAAnB,MAAMF,GAAGC,EAAEmB,IAAIpB,EAAE1K,EAAE,CAAC,CAAC,SAAS2N,GAAEjD,EAAEE,EAAE5K,GAAG,IAAI6K,EAAEC,EAAE,GAAGH,EAAE+F,SAAS/F,EAAE+F,QAAQhG,IAAIG,EAAEH,EAAEgB,OAAOb,EAAE4F,SAAS5F,EAAE4F,UAAU/F,EAAEoB,KAAK8B,GAAE/C,EAAE,KAAKD,IAAI,OAAOC,EAAEH,EAAEsB,KAAK,CAAC,GAAGnB,EAAE8F,qBAAqB,IAAI9F,EAAE8F,sBAA0C,CAAnB,MAAMjG,GAAGC,EAAEmB,IAAIpB,EAAEE,EAAE,CAACC,EAAE4B,KAAK5B,EAAEkC,IAAI,KAAKrC,EAAEsB,SAAI,CAAM,CAAC,GAAGnB,EAAEH,EAAEiB,IAAI,IAAIb,EAAE,EAAEA,EAAED,EAAE5O,OAAO6O,IAAID,EAAEC,IAAI6C,GAAE9C,EAAEC,GAAGF,EAAE5K,GAAG,mBAAmB0K,EAAE9S,MAAMoI,GAAG,MAAM0K,EAAEoB,KAAKT,EAAEX,EAAEoB,KAAKpB,EAAEkB,GAAGlB,EAAEoB,IAAIpB,EAAEqB,SAAI,CAAM,CAAC,SAAS8C,GAAEnE,EAAEC,EAAEC,GAAG,OAAO/P,KAAKF,YAAY+P,EAAEE;AAAE,CAAC,SAASgG,GAAEhG,EAAE5K,EAAE6K,GAAG,IAAIC,EAAEC,EAAEC,EAAEL,EAAEiB,IAAIjB,EAAEiB,GAAGhB,EAAE5K,GAAG+K,GAAGD,EAAE,mBAAmBD,GAAG,KAAKA,GAAGA,EAAEc,KAAK3L,EAAE2L,IAAIX,EAAE,GAAGgC,GAAEhN,EAAE4K,IAAIE,GAAGD,GAAG7K,GAAG2L,IAA1wQ,SAAWhB,EAAEC,EAAE5K,GAAG,IAAI6K,EAAEC,EAAEC,EAAEC,EAAE,CAAA,EAAG,IAAID,KAAKH,EAAE,OAAOG,EAAEF,EAAED,EAAEG,GAAG,OAAOA,EAAED,EAAEF,EAAEG,GAAGC,EAAED,GAAGH,EAAEG,GAAG,GAAGrL,UAAUzD,OAAO,IAAI+O,EAAEoB,SAAS1M,UAAUzD,OAAO,EAAEyO,EAAE5K,KAAKJ,UAAU,GAAGM,GAAG,mBAAmB2K,GAAG,MAAMA,EAAEkG,aAAa,IAAI9F,KAAKJ,EAAEkG,kBAAa,IAAS7F,EAAED,KAAKC,EAAED,GAAGJ,EAAEkG,aAAa9F,IAAI,OAAOS,EAAEb,EAAEK,EAAEH,EAAEC,EAAE,KAAK,CAA0+PuC,CAAE1N,EAAE,KAAK,CAACiL,IAAIG,GAAGE,EAAEA,OAAE,IAASjL,EAAEkN,iBAAiBpC,GAAGD,EAAE,CAACA,GAAGE,EAAE,KAAK/K,EAAE8Q,WAAWpG,EAAE5K,KAAKE,EAAEmQ,YAAY,KAAKnF,GAAGF,GAAGD,EAAEA,EAAEE,EAAEA,EAAEe,IAAI9L,EAAE8Q,WAAWhG,GAAGqC,GAAEnC,EAAEJ,EAAE,CAA+O,SAASmG,GAAErG,EAAEC,GAAG,IAAIC,EAAE,CAACoB,IAAIrB,EAAE,OAAOlS,IAAImT,GAAGlB,EAAEsG,SAAS,SAAStG,EAAEC,GAAG,OAAOD,EAAE0B,SAASzB,EAAE,EAAEsG,SAAS,SAASvG,GAAG,IAAIE,EAAE5K,EAAE,OAAOnF,KAAK4U,kBAAkB7E,EAAE,IAAI5K,EAAE,CAAE,GAAE2K,GAAG9P,KAAKA,KAAK4U,gBAAgB,WAAW,OAAOzP,CAAC,EAAEnF,KAAKyU,sBAAsB,SAAS5E,GAAG7P,KAAK4Q,MAAMjG,QAAQkF,EAAElF,OAAOoF,EAAEiF,MAAK,SAASnF,GAAGA,EAAEoB,KAAI,EAAGY,EAAEhC,EAAE,GAAE,EAAE7P,KAAKiU,IAAI,SAASpE,GAAGE,EAAExL,KAAKsL,GAAG,IAAIC,EAAED,EAAEiG,qBAAqBjG,EAAEiG,qBAAqB,WAAW/F,EAAEsG,OAAOtG,EAAE2B,QAAQ7B,GAAG,GAAGC,GAAGA,EAAE7K,KAAK4K,EAAE,CAAC,GAAGA,EAAE0B,QAAQ;CAAG,OAAOxB,EAAEqG,SAASrF,GAAGhB,EAAEoG,SAAStC,YAAY9D,CAAC,CAACF,EAAEQ,EAAErL,MAAM8K,EAAE,CAACmB,IAAI,SAASpB,EAAEC,EAAEC,EAAE5K,GAAG,IAAI,IAAI6K,EAAEC,EAAEC,EAAEJ,EAAEA,EAAEiB,IAAI,IAAIf,EAAEF,EAAEqB,OAAOnB,EAAEe,GAAG,IAAI,IAAId,EAAED,EAAElQ,cAAc,MAAMmQ,EAAEqG,2BAA2BtG,EAAEuG,SAAStG,EAAEqG,yBAAyBzG,IAAIK,EAAEF,EAAEkB,KAAK,MAAMlB,EAAEwG,oBAAoBxG,EAAEwG,kBAAkB3G,EAAE1K,GAAG,CAAA,GAAI+K,EAAEF,EAAEkB,KAAKhB,EAAE,OAAOF,EAAE8D,IAAI9D,CAAc,CAAZ,MAAMF,GAAGD,EAAEC,CAAC,CAAC,MAAMD,CAAC,GAAGE,EAAE,EAAwDyB,EAAEtN,UAAUqS,SAAS,SAAS1G,EAAEC,GAAG,IAAIC,EAAEA,EAAE,MAAM/P,KAAKoU,KAAKpU,KAAKoU,MAAMpU,KAAKkU,MAAMlU,KAAKoU,IAAIpU,KAAKoU,IAAI7D,EAAE,CAAE,EAACvQ,KAAKkU,OAAO,mBAAmBrE,IAAIA,EAAEA,EAAEU,EAAE,CAAA,EAAGR,GAAG/P,KAAK4Q,QAAQf,GAAGU,EAAER,EAAEF,GAAG,MAAMA,GAAG7P,KAAKqR,MAAMvB,GAAG9P,KAAKmU,IAAI5P,KAAKuL,GAAG+B,EAAE7R,MAAM,EAAEwR,EAAEtN,UAAUuS,YAAY,SAAS5G,GAAG7P,KAAKqR,MAAMrR,KAAKiR,KAAI,EAAGpB,GAAG7P,KAAKoR,IAAI7M,KAAKsL,GAAGgC,EAAE7R,MAAM,EAAEwR,EAAEtN,UAAU6P,OAAOjP,EAAEkL,EAAE,GAAGE,EAAE,mBAAmB7M,QAAQA,QAAQa,UAAUwS,KAAKC,KAAKtT,QAAQC,WAAW/E,WAAW4R,EAAE,SAASN,EAAEC,GAAG,OAAOD,EAAEwB,IAAIL,IAAIlB,EAAEuB,IAAIL,GAAG,EAAEc,EAAEC,IAAI,EAAEnU,EAAE,ECAtnU,IAAIoS,GAAEC,GAAEF,GAAE5K,GAAE+K,GAAE,EAAEC,GAAE,GAAGC,GAAE,GAAGxS,GAAEiS,EAAEmB,IAAIV,GAAET,EAAEkC,IAAIvB,GAAEX,EAAEkF,OAAOjF,GAAED,EAAEsB,IAAIU,GAAEhC,EAAEgG,QAAQ,SAASpD,GAAEzC,EAAED,GAAGF,EAAEuB,KAAKvB,EAAEuB,IAAInB,GAAED,EAAEE,IAAGH,GAAGG,GAAE,EAAE,IAAI/K,EAAE8K,GAAE2G,MAAM3G,GAAE2G,IAAI,CAAC7F,GAAG,GAAGK,IAAI;CAAK,OAAOpB,GAAG7K,EAAE4L,GAAG3P,QAAQ+D,EAAE4L,GAAGxM,KAAK,CAACsS,IAAIzG,KAAIjL,EAAE4L,GAAGf,EAAE,CAAC,SAASO,GAAEV,GAAG,OAAOK,GAAE,EAAS,SAAWL,EAAEE,EAAE5K,GAAG,IAAI+K,EAAEuC,GAAEzC,KAAI,GAAG,GAAGE,EAAEF,EAAEH,GAAGK,EAAEiB,MAAMjB,EAAEa,GAAG,CAAC5L,EAAEA,EAAE4K,GAAGgG,QAAE,EAAOhG,GAAG,SAASF,GAAG,IAAIG,EAAEE,EAAE4G,IAAI5G,EAAE4G,IAAI,GAAG5G,EAAEa,GAAG,GAAGd,EAAEC,EAAEF,EAAEA,EAAEH,GAAGG,IAAIC,IAAIC,EAAE4G,IAAI,CAAC7G,EAAEC,EAAEa,GAAG,IAAIb,EAAEiB,IAAIoF,SAAS,CAAA,GAAI,GAAGrG,EAAEiB,IAAIlB,IAAGA,GAAEF,GAAG,CAAC,IAAII,EAAE,SAASN,EAAEG,EAAEC,GAAG,IAAIC,EAAEiB,IAAIyF,IAAI,OAAM,EAAG,IAAI7G,EAAEG,EAAEiB,IAAIyF,IAAI7F,GAAGgG,QAAO,SAASlH,GAAG,OAAOA,EAAEsB,GAAG,IAAG,GAAGpB,EAAEiH,OAAM,SAASnH,GAAG,OAAOA,EAAEiH,GAAG,IAAG,OAAO1G,GAAGA,EAAEnL,KAAKjF,KAAK6P,EAAEG,EAAEC,GAAG,IAAI9K,GAAE,EAAG,OAAO4K,EAAEjP,SAAQ,SAAS+O,GAAG,GAAGA,EAAEiH,IAAI,CAAC,IAAI9G,EAAEH,EAAEkB,GAAG,GAAGlB,EAAEkB,GAAGlB,EAAEiH,IAAIjH,EAAEiH,SAAI,EAAO9G,IAAIH,EAAEkB,GAAG,KAAK5L,GAAE,EAAG,CAAC,OAAMA,GAAG+K,EAAEiB,IAAIP,QAAQf,MAAMO,GAAGA,EAAEnL,KAAKjF,KAAK6P,EAAEG,EAAEC,GAAG,EAAEA,GAAEF,GAAE,EAAG,IAAIK,EAAEH,GAAEwE,sBAAsB7W,EAAEqS,GAAEyE,oBAAoBzE,GAAEyE,oBAAoB,SAAS7E,EAAEG,EAAEC,GAAG,GAAGjQ,KAAKiR,IAAI,CAAC,IAAIlB,EAAEK,EAAEA,OAAE,EAAOD,EAAEN,EAAEG,EAAEC,GAAGG,EAAEL,CAAC,CAACnS,GAAGA,EAAEqH,KAAKjF,KAAK6P,EAAEG,EAAEC,EAAE,EAAEA,GAAEwE,sBAAsBtE,CAAC,CAAC,OAAOD,EAAE4G,KAAK5G,EAAEa,EAAE,CAA3tBV,CAAE0F,GAAElG,EAAE,CAAstB,SAASc,GAAEZ,EAAE5K,GAAG,IAAI+K,EAAEuC,GAAEzC,KAAI,IAAIH,EAAEuE,KAAKX,GAAEvD,EAAE0G,IAAIzR,KAAK+K,EAAEa,GAAGhB,EAAEG,EAAE/K,EAAEA,EAAE8K,GAAE2G,IAAIxF,IAAI7M,KAAK2L,GAAG,CAAiF,SAASpL,GAAE+K,GAAG,OAAOK,GAAE,EAAEgG,IAAE,WAAW,MAAM,CAACN,QAAQ/F,EAAE,GAAE,GAAG,CAAsL,SAASqG,GAAErG,EAAEI,GAAG,IAAIF,EAAE0C,GAAEzC,KAAI;CAAG,OAAOyD,GAAE1D,EAAE6G,IAAI3G,IAAIF,EAAE8G,IAAIhH,IAAIE,EAAE5K,EAAE8K,EAAEF,EAAEqB,IAAIvB,EAAEE,EAAE8G,KAAK9G,EAAEgB,EAAE,CAAC,SAASsC,GAAExD,EAAEG,GAAG,OAAOE,GAAE,EAAEgG,IAAE,WAAW,OAAOrG,CAAC,GAAEG,EAAE,CAAgf,SAASyB,KAAI,IAAI,IAAIzB,EAAEA,EAAEG,GAAE8B,SAAS,GAAGjC,EAAEkC,KAAKlC,EAAE4G,IAAI,IAAI5G,EAAE4G,IAAIxF,IAAItQ,QAAQ0Q,IAAGxB,EAAE4G,IAAIxF,IAAItQ,QAAQgR,IAAG9B,EAAE4G,IAAIxF,IAAI,EAAuC,CAApC,MAAMnB,GAAGD,EAAE4G,IAAIxF,IAAI,GAAGvB,EAAEoB,IAAIhB,EAAED,EAAEqB,IAAI,CAAC,CAACxB,EAAEmB,IAAI,SAASnB,GAAGI,GAAE,KAAKrS,IAAGA,GAAEiS,EAAE,EAAEA,EAAEkC,IAAI,SAASlC,GAAGS,IAAGA,GAAET,GAAGG,GAAE,EAAE,IAAI7K,GAAG8K,GAAEJ,EAAEsB,KAAKyF,IAAIzR,IAAI4K,KAAIE,IAAG9K,EAAEiM,IAAI,GAAGnB,GAAEmB,IAAI,GAAGjM,EAAE4L,GAAGjQ,SAAQ,SAAS+O,GAAGA,EAAEiH,MAAMjH,EAAEkB,GAAGlB,EAAEiH,KAAKjH,EAAEgH,IAAIzG,GAAEP,EAAEiH,IAAIjH,EAAE1K,OAAE,CAAM,MAAKA,EAAEiM,IAAItQ,QAAQ0Q,IAAGrM,EAAEiM,IAAItQ,QAAQgR,IAAG3M,EAAEiM,IAAI,KAAKrB,GAAEE,EAAC,EAAEJ,EAAEkF,OAAO,SAAS/E,GAAGQ,IAAGA,GAAER,GAAG,IAAIE,EAAEF,EAAEmB,IAAIjB,GAAGA,EAAE0G,MAAM1G,EAAE0G,IAAIxF,IAAIhQ,SAAS,IAAI+O,GAAE5L,KAAK2L,IAAI/K,KAAI0K,EAAEoH,yBAAyB9R,GAAE0K,EAAEoH,wBAAwBvD,IAAGjC,KAAIvB,EAAE0G,IAAI7F,GAAGjQ,SAAQ,SAAS+O,GAAGA,EAAE1K,IAAI0K,EAAE+G,IAAI/G,EAAE1K,GAAG0K,EAAEgH,MAAMzG,KAAIP,EAAEkB,GAAGlB,EAAEgH,KAAKhH,EAAE1K,OAAE,EAAO0K,EAAEgH,IAAIzG,EAAC,KAAIL,GAAEE,GAAE,IAAI,EAAEJ,EAAEsB,IAAI,SAASnB,EAAEC,GAAGA,EAAE+E,MAAK,SAAShF,GAAG,IAAIA,EAAEoB,IAAItQ,QAAQ0Q,IAAGxB,EAAEoB,IAAIpB,EAAEoB,IAAI2F,QAAO,SAASlH,GAAG,OAAOA,EAAEkB,IAAIe,GAAEjC,EAAE,GAAsE,CAAnE,MAAME,GAAGE,EAAE+E,MAAK,SAASnF,GAAGA,EAAEuB,MAAMvB,EAAEuB,IAAI,GAAG,IAAGnB,EAAE,GAAGJ,EAAEoB,IAAIlB,EAAEC,EAAEqB,IAAI,CAAC,IAAGvB,IAAGA,GAAEE,EAAEC,EAAE,EAAEJ,EAAEgG,QAAQ,SAAS7F,GAAG6B,IAAGA,GAAE7B;CAAG,IAAIC,EAAEF,EAAEC,EAAEmB,IAAIpB,GAAGA,EAAE6G,MAAM7G,EAAE6G,IAAI7F,GAAGjQ,SAAQ,SAAS+O,GAAG,IAAI2B,GAAE3B,EAAe,CAAZ,MAAMA,GAAGI,EAAEJ,CAAC,CAAC,IAAGE,EAAE6G,SAAI,EAAO3G,GAAGJ,EAAEoB,IAAIhB,EAAEF,EAAEsB,KAAK,EAAE,IAAIM,GAAE,mBAAmBsF,sBAAsB,SAASvD,GAAE7D,GAAG,IAAIG,EAAEC,EAAE,WAAW3R,aAAayR,GAAG4B,IAAGuF,qBAAqBlH,GAAGzR,WAAWsR,EAAE,EAAEE,EAAExR,WAAW0R,EAAE,KAAK0B,KAAI3B,EAAEiH,sBAAsBhH,GAAG,CAAC,SAASuB,GAAE3B,GAAG,IAAIG,EAAEC,GAAEF,EAAEF,EAAEsB,IAAI,mBAAmBpB,IAAIF,EAAEsB,SAAI,EAAOpB,KAAKE,GAAED,CAAC,CAAC,SAAS8B,GAAEjC,GAAG,IAAIG,EAAEC,GAAEJ,EAAEsB,IAAItB,EAAEkB,KAAKd,GAAED,CAAC,CAAC,SAASyD,GAAE5D,EAAEG,GAAG,OAAOH,GAAGA,EAAEzO,SAAS4O,EAAE5O,QAAQ4O,EAAEgF,MAAK,SAAShF,EAAEC,GAAG,OAAOD,IAAIH,EAAEI,EAAE,GAAE,CAAC,SAAS8F,GAAElG,EAAEG,GAAG,MAAM,mBAAmBA,EAAEA,EAAEH,GAAGG,CAAC,CCKt3G,MAAMmH,GAAY,CAChBC,IAAK,EACLC,KAAM,EACNC,KAAM,EACNrF,MAAO,GAgBF,SAASsF,GAAcjY,EAAsBkY,GAClD,MAAMC,EAAQD,EAASE,MAAM,KAAK7V,KAAI8O,GAAKA,EAAE5R,gBAE7C,IAAI4Y,EAAoB,EACpBC,EAAc,KAElB,IAAK,MAAMC,KAAQJ,EAAO,CACxB,MAAMK,EAAeX,GAAUU,GAC/B,GAAIC,EACFH,GAAqBG,MAChB,IAAoB,OAAhBF,EAGT,MAAM,IAAIzU,MAAM,wCAFhByU,EAAcC,CAGhB,CACF,CAEA,IAAKD,EACH,MAAM,IAAIzU,MAAO,qBAAoBqU,KASvC,QALGlY,EAAMvB,QAAUoZ,GAAUE,KAAO,IACjC/X,EAAMzB,QAAUsZ,GAAUG,KAAO,IACjChY,EAAMxB,OAASqZ,GAAUC,IAAM,IAC/B9X,EAAMyY,SAAWZ,GAAUlF,MAAQ,MAGhB0F,GACpBrY,EAAM0P,IAAIjQ,gBAAkB6Y,CAEhC,CAsDO,SAASI,GACdR,EACAS,GACAC,YAAEA,GAAiC;AAEnCC,IAAU,KACR,GAAKX,EAGL,OA3CG,SACLA,EACAS,GACAC,YAKEA,EAAcvb,SAAS0C,iBACJ,IAErB,MAAM+Y,EAAa9Y,IACbiY,GAAcjY,EAAOkY,IACvBS,EAAQ3Y,EACV,EAGF,OADA4Y,EAAYvZ,iBAAiB,UAAWyZ,GACjC,IAAMF,EAAYpZ,oBAAoB,UAAWsZ,EAC1D,CAyBWC,CAAgBb,EAAUS,EAAS,CAAEC,eAAc,GACzD,CAACV,EAAUS,EAASC,GACzB,CC5EO,MAAMI,GAAgBA,CAACC,EAAUla,SAC/Bka,EAAQC,WAAW,qBAAqBC,QC9Ca,IAAI3T,GAAE,EAAE,SAASoL,GAAEA,EAAEtS,EAAEiS,EAAEG,EAAEG,EAAEL,GAAG,IAAIO,EAAEN,EAAEO,EAAE,CAAA,EAAG,IAAIP,KAAKnS,EAAE,OAAOmS,EAAEM,EAAEzS,EAAEmS,GAAGO,EAAEP,GAAGnS,EAAEmS,GAAG,IAAI5K,EAAE,CAACpI,KAAKmT,EAAEU,MAAMN,EAAEtB,IAAIa,EAAEgB,IAAIR,EAAES,IAAI,KAAKC,GAAG,KAAKC,IAAI,EAAEC,IAAI,KAAKC,SAAI,EAAOC,IAAI,KAAKC,IAAI,KAAKtR,iBAAY,EAAOuR,MAAMvM,GAAE4T,SAASvI,EAAEwI,OAAO7I,GAAG,GAAG,mBAAmBI,IAAIG,EAAEH,EAAE8F,cAAc,IAAIjG,KAAKM,OAAE,IAASC,EAAEP,KAAKO,EAAEP,GAAGM,EAAEN,IAAI,OAAOE,EAAEqB,OAAOrB,EAAEqB,MAAMnM,GAAGA,CAAC,CCA7Y,IAAIyT,GAAe,sFAKJ,SAASC,GAAajI,GACnC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACRC,QAAS,YACT,iBAAkB,kBACftI,EACHW,SAAUuH,GAAQ,OAAQ,CACxBK,KAAM;AACN1G,EAAG,44BACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL;AC1BA,IAAI4Y,GAAe,oFAKJ,SAASW,GAAW3I,GACjC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,gBACftI,EACHW,SAAUuH,GAAQ,IAAK,CACrBK,KAAM,OACN,YAAa,UACb5H,SAAU,CAACuH,GAAQ,OAAQ,CACzBrG,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,MAAO8Y,GAAQ,OAAQ,CACxBU,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,IAChB/G,EAAG,mFACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,aACF,EAAQ,EAAM,CACfoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC5CA,IAAI4Y,GAAe,uFAKJ,SAASa,GAAc7I,GACpC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB;GACftI,EACHW,SAAUuH,GAAQ,IAAK,CACrBK,KAAM,OACN,YAAa,UACb5H,SAAU,CAACuH,GAAQ,OAAQ,CACzBrG,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,MAAO8Y,GAAQ,OAAQ,CACxBU,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,IAChB/G,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,aACF,EAAQ,EAAM,CACfoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC5CA,IAAI4Y,GAAe,uFAKJ,SAASc,GAAc9I,GACpC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,mBACftI,EACHW,SAAUuH,GAAQ,IAAK,CACrBK,KAAM,OACN,YAAa,UACb5H,SAAU,CAACuH,GAAQ,OAAQ,CACzBrG,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,MAAO8Y,GAAQ,OAAQ,CACxBU,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,IAChB/G,EAAG,uBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY;AACZC,aAAc,GACbtZ,aACF,EAAQ,EAAM,CACfoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC5CA,IAAI4Y,GAAe,wFAKJ,SAASe,GAAe/I,GACrC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,oBACftI,EACHW,SAAUuH,GAAQ,IAAK,CACrBK,KAAM,OACN,YAAa,UACb5H,SAAU,CAACuH,GAAQ,OAAQ,CACzBrG,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,MAAO8Y,GAAQ,OAAQ,CACxBU,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,IAChB/G,EAAG,qBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,aACF,EAAQ,EAAM,CACfoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC5CA,IAAI4Y,GAAe,qFAKJ,SAASgB,GAAYhJ,GAClC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO;AACPC,OAAQ,KACRE,KAAM,OACNK,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,MAChBN,QAAS,YACT,iBAAkB,iBACftI,EACHW,SAAUuH,GAAQ,OAAQ,CACxBrG,EAAG,kHACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC9BA,IAAI4Y,GAAe,mFAKJ,SAASiB,GAAUjJ,GAChC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACRC,QAAS,YACT,iBAAkB,eACftI,EACHW,SAAUuH,GAAQ,IAAK,CACrBK,KAAM,OACN,YAAa,UACb5H,SAAU,CAACuH,GAAQ,OAAQ,CACzBrG,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,MAAO8Y,GAAQ,OAAQ,CACxBU,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,IAChB/G,EAAG,uBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,aACF,EAAQ,EAAM,CACfoZ,SAAUR,GACVS,WAAY;AACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC3CA,IAAI4Y,GAAe,kFAKJ,SAASkB,GAASlJ,GAC/B,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,cACftI,EACHW,SAAUuH,GAAQ,OAAQ,CACxBK,KAAM,eACN1G,EAAG,oeACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL;AC3BA,IAAI4Y,GAAe,uFAKJ,SAASmB,GAAcnJ,GACpC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,mBACftI,EACHW,SAAUuH,GAAQ,IAAK,CACrBK,KAAM,OACN,YAAa,UACb5H,SAAU,CAACuH,GAAQ,OAAQ,CACzBrG,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,MAAO8Y,GAAQ,OAAQ,CACxBU,OAAQ,eACR,iBAAkB,QAClB,kBAAmB,QACnB,eAAgB,IAChB/G,EAAG,6EACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,aACF,EAAQ,EAAM,CACfoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC5CA,IAAI4Y,GAAe,kFAKJ,SAASoB,GAASpJ,GAC/B,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,cACftI;AACHW,SAAUuH,GAAQ,OAAQ,CACxBK,KAAM,eACN1G,EAAG,kNACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CC3BA,IAAI4Y,GAAe,yFAKJ,SAASqB,GAAgBrJ,GACtC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,IACR,iBAAkB,qBACfrI,EACHW,SAAUuH,GAAQ,OAAQ,CACxBU,OAAQ,eACR/G,EAAG,wBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CCzBA,IAAI4Y,GAAe,uFAKJ,SAASsB,GAActJ,GACpC,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,IACR,iBAAkB,mBACfrI,EACHW,SAAUuH,GAAQ,OAAQ;AACxBU,OAAQ,eACR/G,EAAG,sBACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,CCzBA,IAAI4Y,GAAe,kFAKJ,SAASuB,GAASvJ,GAC/B,OAAOkI,GAAQ,MAAO,CACpBC,MAAO,6BACPC,MAAO,KACPC,OAAQ,KACR,cAAe,OACfC,QAAS,YACT,iBAAkB,cACftI,EACHW,SAAUuH,GAAQ,OAAQ,CACxBK,KAAM,eACN1G,EAAG,sKACF,EAAQ,EAAO,CAChB2G,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,YACF,EAAQ,EAAO,CAChBoZ,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,uECpBC,WAGA,IAAI0L,EAAS,CAAE,EAACE,eAGhB,SAASwO,IAGR,IAFA,IAAIC,EAAU,GAELlV,EAAI,EAAGA,EAAIN,UAAUzD,OAAQ+D,IAAK,CAC1C,IAAImV,EAAMzV,UAAUM,GACpB,GAAKmV,EAAL,CAEA,IAAIC,SAAiBD,EAErB,GAAgB,WAAZC,GAAoC,WAAZA,EAC3BF,EAAQ9V,KAAK+V,QACP,GAAI3Y,MAAM2I,QAAQgQ,IACxB,GAAIA,EAAIlZ,OAAQ;AACf,IAAIoZ,EAAQJ,EAAWxV,MAAM,KAAM0V,GAC/BE,GACHH,EAAQ9V,KAAKiW,EAEd,OACK,GAAgB,WAAZD,EAAsB,CAChC,GAAID,EAAInZ,WAAamB,OAAO4B,UAAU/C,WAAamZ,EAAInZ,SAASA,WAAWsZ,SAAS,iBAAkB,CACrGJ,EAAQ9V,KAAK+V,EAAInZ,YACjB,QACA,CAED,IAAK,IAAI6N,KAAOsL,EACX5O,EAAOzG,KAAKqV,EAAKtL,IAAQsL,EAAItL,IAChCqL,EAAQ9V,KAAKyK,EAGf,CAxBkB,CAyBnB,CAED,OAAOqL,EAAQvY,KAAK,IACpB,CAEoC4Y,GAAOnV,SAC3C6U,EAAWO,QAAUP,EACrBM,GAAAnV,QAAiB6U,GAOjB/b,OAAO+b,WAAaA,CAEtB,CApDA,aCNsBQ,GAAc,CAAE,GCAjBA,GAAc,CAAE,GCATA,GAAc,MCM1C,MAAMC,GAAW,UAActJ,SAC7BA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUC,OACVA,GAAS,EAAKC,QACdA,EAAU,SAAQhC,MAClBA,EAAQ,UACLiC,IAEH,OAAOnC,GAAQ,MAAO,CACpB,iBAAkB,UACfmC,EACHpK,IAAiBiK,EACjBI,UAAWC,GAAW,6BAA8B,CAClD,yBAAsC,WAAZH,EAE1B,YAAaD,GAAsB,WAAZC,GACtB,CACD,SAAoB,SAAVhC,EAEV,SAAoB,SAAVA,GAETqB,GACH9I,SAAUA,QACT,EAAQ,EAAO,CAChB6H,SAhCe,mFAiCfC,WAAY,GACZC,aAAc,GACbtZ,KACL,EC7BA,MAAMob,GAAkB,UAAqB7J,SAC3CA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUO,KACVA,EAAO,QACJJ,IAEH,OAAOnC,GAAQ,MAAO,CACpB,iBAAkB,iBACfmC,EACHpK,IAAiBiK,EACjBI,UAAWC,GAAW,CACpB,gBAA0B,OAATE,EAEjB,gBAA0B,OAATA,EACjB,gBAA0B,OAATA;EAChBhB,GACH9I,SAAUA,QACT,EAAQ,EAAO,CAChB6H,SA1Be,0FA2BfC,WAAY,GACZC,aAAc,GACbtZ,KACL,ECdA,MAAMsb,GAAiB,UAAoBR,WACzCA,EAAUvJ,SACVA,EAAQ8I,QACRA,EAAOkB,SACPA,GAAW,EAAKC,SAChBA,EAAQC,QACRA,EAAOC,MACPA,EAAKC,KACLA,KACGV,IAEH,MAAMW,EAAY,CAChB,aAAcF,GAWhB,MANa,QAATC,EACFC,EAAU,iBAAmBH,GAE7BG,EAAU,gBAAkBH,EAC5BG,EAAU,iBAAmBJ,GAExB1C,GAAQ,SAAU,CACvB6C,KAAMA,QAAmCA,EAAO,YAC7CC,EACH,sBAAuB,aAEvB,iBAAkB,aAIlB7e,KAAM,YACHke,EACHC,UAAWd,GAAW,CACpB,sBAAuBmB,EACvB,qBAAsBA,EAEtB,uCAAwCA,GACvClB,GACHqB,MAAOA,EACP7K,IAAiBiK,EACjBvJ,SAAUA,QACT,EAAQ,EAAO,CAChB6H,SA5De,wFA6DfC,WAAY,GACZC,aAAc,GACbtZ,KACL,EChEA,IAAI4Y,GAAe,oFAQnB,MAAMiD,GAAa,UAAgBtK,SACjCA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUU,SACVA,EAAQC,QACRA,EAAOC,MACPA,EACAI,KAAMC,EAAIV,KACVA,EAAO,KAAIL,QACXA,EAAU,eACPC,IAEH,OAAOnC,GAAQkD,GAAY;AACzB,iBAAkB,YACff,EACHZ,QAASc,GAAW,2EAA4E,2BAA4B,CAE1H,6HAA0I,cAAZH,EAE9H,qEAAkF,YAAZA,GACrE,CAED,cAAwB,OAATK,EAEf,cAAwB,OAATA,EACf,kBAA4B,OAATA,EACnB,kBAA4B,OAATA,GAClBhB,GACHS,WAAwBA,EACxBU,SAAUA,EACVC,QAASA,EACTC,MAAOA,EACPH,UAAU,EACVhK,SAAU,CAACwK,GAAQjD,GAAQiD,EAAM,CAC/Bb,UAAW,kBACV,EAAQ,EAAO,CAChB9B,SAAUR,GACVS,WAAY,GACZC,aAAc,IACbtZ,MAAOuR,SACT,EAAQ,EAAM,CACf6H,SAAUR,GACVS,WAAY,GACZC,aAAc,GACbtZ,KACL,EC9Caic,GAAmBd,GAEhC,8CAEA,+DAEA,qDCbA,IAAIvC,GAAe;CASnB,MAAMsD,GAAiB,UAAoB3K,SACzCA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUW,QACVA,EAAOD,SACPA,EACAM,KAAMC,EAAII,mBACVA,GAAqB,EAAKd,KAC1BA,EAAO,KAAIK,MACXA,EAAKV,QACLA,EAAU,eACPC,IAEH,OAAOnC,GAAQkD,GAAY,CACzB,iBAAkB,gBACff,EACHZ,QAASc,GAAW,2EAA4E,oCAAqC,CAEnI,wGAAqH,cAAZH,EAEzG,2EAAwF,YAAZA,EAC5E,8IAA2J,SAAZA,EAE/I,MAAgB,OAATK,EAEP,MAAgB,OAATA,EACP,QAAkB,OAATA,EACT,QAAkB,OAATA,EAET,uDAAwDc,GAG1DF,GAAkB5B,GAClBS,WAAwBA,EACxBY,MAAOA,EACPD,QAASA,EACTD,SAAUA,EACVD,UAAU,EACVhK,SAAU,CAACwK,GAAQjD,GAAQiD,EAAM,CAC/Bb,UAAW,kBACV,EAAQ,EAAO,CAChB9B,SAAUR,GACVS,WAAY,GACZC,aAAc,IACbtZ,MAAOuR,SACT,EAAQ,EAAM,CACf6H,SAAUR,GACVS,WAAY;AACZC,aAAc,GACbtZ,KACL,ECpDA,MAAMoc,GAAe,UAAkB7K,SACrCA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUS,SACVA,GAAW,KACRN,IAEH,OAAOnC,GAAQ,IAAK,CAClB,sBAAuB,WAEvB,iBAAkB,cACfmC,EACHC,UAAWC,GAAW,CACpB,sBAAuBI,GACtBlB,GACHtO,IAAK,sBACL8E,IAAiBiK,EACjBvJ,SAAUA,QACT,EAAQ,EAAO,CAChB6H,SA1Be,2FA2BfC,WAAY,GACZC,aAAc,GACbtZ,KACL,ECtBA,MAAMqc,GAAW,UAAc9K,SAC7BA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUwB,UACVA,EAAY,OAAMC,MAClBA,EAAQ,WACLtB,IAEH,OAAOnC,GAAQ0D,GAAU,CACvB,iBAAkB,UACfvB,EACHZ,QAASc,GAAW,aAEpB,CAEE,mCAA8C,UAAVoB,EAEpC,yCAAoD,eAAVA,EAC1C,wCAAmD,SAAVA,GACxC,CAED,kCAAiD,SAAdD,EAEnC,4BAA2C,WAAdA,EAC7B,+BAA8C,UAAdA,GAC/BjC,GACHS,WAAwBA,EACxBvJ,SAAUA,QACT,EAAQ,EAAO,CAChB6H,SArCe,uFAsCfC,WAAY,GACZC,aAAc;EACbtZ,KACL,ECtBA,MAAMyc,GAAoB,UAAuBlL,SAC/CA,EAAQ8I,QACRA,EAAOS,WACPA,EAAUU,SACVA,EAAQC,QACRA,EAAOC,MACPA,EAAKgB,UACLA,KACGzB,IAEH,OAAOnC,GAAQkD,GAAY,CACzB,iBAAkB,mBACff,EACHH,WAAwBA,EACxBT,QAASc,GAGT,6BAA8B,mCAAoC,gCAGlE,4CAA6C,0CAA2C,+DAAgE,CAGtJ,uCAAsD,SAAduB,EAGxC,uCAAsD,SAAdA,GAG1C,CACE,kCAAiD,SAAdA,EAGnC,kEAAiF,SAAdA,EAGnE,gFAA+F,SAAdA,EAIjF,+EAA8F,SAAdA,GAGlF,CACE,mCAAkD,OAAdA,EAGpC,qGAAoH,OAAdA;AAEtG,sFAAqG,OAAdA,EAEvF,iFAAgG,OAAdA,GAGpF,CACE,mCAAkD,SAAdA,EAGpC,gEAA+E,SAAdA,EAEjE,sFAAqG,SAAdA,EAEvF,iFAAgG,SAAdA,GACjFrC,GACHmB,SAAUA,EACVC,QAASA,EACTC,MAAOA,EACPnK,SAAUA,QACT,EAAQ,EAAO,CAChB6H,SAxFe,gGAyFfC,WAAY,GACZC,aAAc,GACbtZ,KACL,EC3EA,SAAS2c,IAAWC,WAAEA,IACpB,OACEC,GAAA,OAAA,CACE3B,UAAWC,GACT,sBAGA,cACA5J,SAEFsL,GAAA,OAAA,CAAM3B,UAAU,qCAAoC3J,SAAEqL,KAG5D,CAMA,SAASE,IAAkBC,eACzBA,IAIA,OACEF,GAAA,MAAA,CACE3B,UAAWC,GAET,yCACA,yBACA;AAEE,0BAA8C,OAAnB4B,IAE7BxL,SAEyBsL,GAAP,OAAnBE,EAA2B7C,GAAoBD,GAAJ,CAAA,IAGlD,CAUA,SAAS+C,IAAcJ,WACrBA,EACAd,KAAMC,EAAIkB,MACVA,EAAKC,QACLA,EAAO1F,SACPA,IAEAQ,GAAYR,EAAU0F,GAEtB,MAAMxB,EAAQlE,EAAY,GAAEyF,MAAUzF,KAAcyF,EAEpD,OACEE,GAACnB,GAAU,CACT3B,QAASc,GACP,+BACA,iCAEA,cAIA,0BAIA,iCAEF+B,QAASA,EACTxB,MAAOA,EAAMnK,SAEZwK,CAAAA,GAAQc,GAACd,EAAI,CAACb,UAAU,oBAAoBQ,MAAOA,IAC7B,iBAAfkB,GAA2BC,GAACF,GAAU,CAACC,WAAYA,IAC3DC,GAAA,OAAA,CAAAtL,SAAO0L,MAGb,CAMA,SAASG,IAAsBC,gBAC7BA,EAAeC,UACfA,IAKA,OACEH,GAAA,MAAA,CAAKjC,UAAU,UAAS3J,UACtBsL,GAAA,OAAA,CACE,YAAU,SACV,cAAY,OACZlB,KAAK,SACL,cAAY,4BAA2BpK,SAEtC8L,EAAkB,GACjBF,GAAA,OAAA,CAAA5L,SACG8L,CAAAA,EAAiB,IACG,IAApBA,EAAwB,aAAe,cAAc,4BAK5DR,GAAA,KAAA,CAAI,YAAU,SAAS,cAAY,8BAA6BtL,SAC7D+L,GACCH,GAAAI,EAAA,CAAAhM,SACG8L,CAAAA,EAAkB,GAAKF,GAAA,KAAA,CAAA5L,SAAI,CAAA,SAAO,MAAM,2BACzC4L,GAAA,KAAA,CAAA5L,SAAI,CAAA,SAAO,MAAM,mBACjB4L,GAAA,KAAA;AAAA5L,SAAI,CAAA,SAAO,MAAM,2BAM7B,CA2De,SAASiM,IAAaT,eACnCA,EAAcO,UACdA,EAASG,UACTA,EAASJ,gBACTA,EAAkB,IAKlB,MAAMK,EAAmBJ,EAAY,IAAM,KACrCK,EAAoBL,EAAY,IAAM,KACtCM,EAAeN,EAAY,IAAM,KASvC,OAJAtF,GAJqBsF,EAAY,SAAW,MAIlB,IAAMG,EAAU,UAKxCN,GAAA,MAAA,CACEjC,UAAWC,GAIT,cAIA,oCACA,6DAEA,YACA,CACE,uBAA2C,OAAnB4B,GAA2BO,EACnD,yBAA6C,SAAnBP,GAA6BO,IAG3D,iBAAe,eACfO,IAAI,MACJvK,MAAO,CACLwK,WAAYR,EAAY,UAAY,UACpC/L,UAEF4L,GAAA,MAAA,CACEjC,UAAWC,GAGT,cACA5J,SAAA,CAEFsL,GAACG,GAAa,CACZlB,KAAMjD,GACNqE,QAASA,IAAMO,EAAU,YACzBR,MAAM,WACNzF,SAAUkG,IAEZb,GAACG,GAAa,CACZlB,KAAM/B,GACNmD,QAASA,IAAMO,EAAU,aACzBR,MAAM,YACNzF,SAAUmG,IAEXN,EAAkB,GACjBF,GAAAI,EAAA,CAAAhM,UACEsL,GAAA,MAAA,CACE3B,UAAWC,GAET,+CAGJ0B,GAACG,GAAa,CACZJ,WAAYS,EACZH,QAASA,IAAMO,EAAU,QACzBR,MAAM,OACNzF,SAAUoG,UAKlBf,GAACC,GAAiB,CAACC,eAAgBA,IACnCF,GAACO,GAAqB,CACpBC,gBAAiBA,EACjBC,UAAWA,MAInB,CClQO,SAASS,GAAiBC,GAC/B,MAAMC,EAAaD,EAAUE,aAAa,CAAEC,KAAM,UA1BpD,SAAoBF;AAAY,IAAAG,EAE9B,MAAMriB,EAGHqiB,QAHSA,EACVzhB,SAASsP,cACP,mEAFiDmS,IAGlDA,OAHkDA,EAAAA,EAIlDlS,KAEH,IAAKnQ,EACH,OAGF,MAAMsiB,EAAS1hB,SAASyY,cAAc,QACtCiJ,EAAOtS,IAAM,aACbsS,EAAOnS,KAAOnQ,EACdkiB,EAAWjL,YAAYqL,EACzB,CAWEC,CAAWL,GAIX,MAAMM,EAAoBlgB,OAAO9C,0BAsBnC,IAA8BijB,EAhB5B,OALID,GACFA,EAAkBN,IAoBQO,EAjBPP,GAkBbtf,iBAAiB,WAAWW,GAASA,EAAMmf,oBACnDD,EAAQ7f,iBAAiB,aAAaW,GAASA,EAAMmf,oBACrDD,EAAQ7f,iBAAiB,cAAcW,GAASA,EAAMmf,mBAAmB,CACvEC,SAAS,IApBJT,CACT,CCnCYU,IAAAA,YAAAA,GAAc,OAAdA,EAAAA,EAAc,KAAA,GAAA,OAAdA,EAAAA,EAAc,GAAA,GAAA,KAAdA,CAAc,EAAA,CAAA,GAc1B,SAASC,GAAKC,GACZ,OAAOA,EAAO1d,WAAa,IAC7B,CAyCO,MAAM2d,GAqBXhf,YAAY0e,EAAsBle,GAAuBP,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,aAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,gCAAA,GACvDA,KAAK+e,gBAAkBpiB,SAASyY,cAAc,oBAC9CoJ,EAAQxL,YAAYhT,KAAK+e;AACzB/e,KAAKgf,YAAcjB,GAAiB/d,KAAK+e,iBAGzCzc,OAAOmJ,OAAOzL,KAAK+e,gBAAgBzL,MAAO,CAExC2L,SAAU,WACVC,IAAK,EACLC,KAAM,IAGRnf,KAAKof,MAAQZ,EAAQa,cAAcC,YACnCtf,KAAKuf,YAAa,EAClBvf,KAAKwf,gBAAkB,KACvBxf,KAAKyf,yBAA2B,GAEhCzf,KAAK0f,YAAcpf,EAAQqf,WAC3B3f,KAAK4f,aAAetf,EAAQuf,YAC5B7f,KAAK8f,mBAAqBxf,EAAQyf,kBAElC/f,KAAKggB,SACP,CAEIC,8BACF,OAAOjgB,KAAKyf,wBACd,CASIQ,4BAAwBC,GAC1BlgB,KAAKyf,yBAA2BS,EAChClgB,KAAKggB,SACP,CAGAG,OACEngB,KAAKuf,YAAa,EAClBvf,KAAKggB,UAGL1d,OAAOmJ,OAAOzL,KAAK+e,gBAAgBzL,MAAO,CACxC4L,IAAK,EACLC,KAAM,GAEV,CAEAnc,UACE+Q,GAAO,KAAM/T,KAAKgf,aAClBhf,KAAK+e,gBAAgBthB,QACvB,CAWA2iB,KAAKC,EAAwBC,GAC3B,MAAMnB,KAAEA,EAAID,IAAEA,EAAGnC,eAAEA,GAAmB/c,KAAKugB,iBACzCF,EACAC,GAEFtgB,KAAKwgB,QAAQrB,EAAMD,GAEnBlf,KAAKuf,YAAa,EAClBvf,KAAKwf,gBAAkBzC,IAAmB4B,GAAe8B,GAAK,KAAO,OAErEzgB,KAAKggB,SACP,CAEQU,SAEN,OADmB1gB,KAAKgf,YAAY/I,WAClB0K,wBAAwB3H,KAC5C,CAEQ4H,UAEN,OADmB5gB,KAAKgf,YAAY/I,WAClB0K,wBAAwB1H,MAC5C,CAeQsH,iBACNF,EACAC,GAIA,IAAIvD,EASAmC,EACAC;CARFpC,EADEuD,IAAmBhI,KACJqG,GAAekC,KAKflC,GAAe8B,GAOlC,MAAMK,EAAUC,KAAKC,IAnLF,GAmLsBX,EAAcrH,OACjDiI,EAAajhB,KAAK0gB,SAGlBQ,EAAoB5I,KAAkB,GAAK,EAC3C6I,EAAcnhB,KAAK4gB,UAoCzB,OAlCEzB,EADEmB,EACKD,EAAclB,KAAO8B,EAAa,EAAIH,EAG3CT,EAAclB,KAAOkB,EAAcrH,MAAQiI,EAAa,EAAIH,EAM9DT,EAAcnB,IAAMiC,EAAc,GAClCpE,IAAmB4B,GAAekC,KAElC9D,EAAiB4B,GAAe8B,GACvBJ,EAAcnB,IAAMiC,EAAcnhB,KAAKof,MAAMgC,cACtDrE,EAAiB4B,GAAekC,MAIhC3B,EADEnC,IAAmB4B,GAAe8B,GAElCJ,EAAcnB,IACdmB,EAAcpH,OAlND,GAoNbiI,EAEIb,EAAcnB,IAAMiC,EAtNX,GA0NjBhC,EAAO4B,KAAKM,IAAIlC,EAAM,GACtBA,EAAO4B,KAAKC,IAAI7B,EAAMnf,KAAKof,MAAMkC,WAAaL,GAE9C/B,EAAM6B,KAAKM,IAAInC,EAAK,GACpBA,EAAM6B,KAAKC,IAAI9B,EAAKlf,KAAKof,MAAMgC,YAAcD,GAEtC,CAAEjC,MAAKC,OAAMpC,iBACtB,CAUQwE,YAAYpC,EAAcD,GAChC,QAAmCnZ,IAA/BpJ,SAAS6kB,kBAGX,OAAO,MAGT,MAAMP,EAAajhB,KAAK0gB,SAClBS,EAAcnhB,KAAK4gB,UAkBnBa,EAAW,IAXA,IAAI3a,IAAI,IACpBnK,SAAS6kB,kBAAkBrC,EAAMD,MACjCviB,SAAS6kB,kBAAkBrC,EAAMD,EAAMiC,MACvCxkB,SAAS6kB,kBACVrC,EAAO8B,EAAa,EACpB/B,EAAMiC,EAAc,MAEnBxkB,SAAS6kB,kBAAkBrC,EAAO8B,EAAY/B,MAC9CviB,SAAS6kB,kBAAkBrC,EAAO8B,EAAY/B,EAAMiC,MAItDtf,KAAI2c,IAAYkD,iBAAiBlD,GAASmD,SAC1C5K,OAAOhM,OAAO6W,WAMjB,OAFAH,EAASld,KAAK,GAEPwc,KAAKM,OAAOI,GAAY,CACjC,CASQjB,QAAQrB,EAAcD,GAO5B,MACM2C,EArRV,SAAmCnlB,GACjC,IAAIolB,EAAWplB,EAAGqlB,cAClB,KAAOD,EAASC,eAC8B,WAAxCL,iBAAiBI,GAAU7C,UAG/B6C,EAAWA,EAASC,cAEtB,OAAOD;AACT,CA2Q+BE,CAA0BhiB,KAAK+e,iBACpB4B,wBAEhCgB,EAAS3hB,KAAKuhB,YAAYpC,EAAMD,GAEtC5c,OAAOmJ,OAAOzL,KAAK+e,gBAAgBzL,MAAO,CACxC6L,KAAMP,GAAKO,EAAO0C,EAAW1C,MAC7BD,IAAKN,GAAKM,EAAM2C,EAAW3C,KAC3ByC,UAEJ,CAEQ3B,UAsBNjM,GACE8I,GAACW,GAAY,CACXF,UAAWtd,KAAKuf,WAChBxC,eAAgB/c,KAAKwf,gBACrB/B,UAzBmBwE,IACrB,OAAQA,GACN,IAAK,WACHjiB,KAAK0f,cACL1f,KAAKmgB,OACL,MACF,IAAK,YACHngB,KAAK4f,eACL5f,KAAKmgB,OACL,MACF,IAAK,OACHngB,KAAK8f,mBAAmB9f,KAAKigB,yBAC7B,MACF,IAAK,OACHjgB,KAAKmgB,OAGC,EASR9C,gBAAiBrd,KAAKigB,wBAAwB7e,SAEhDpB,KAAKgf,YAET,ECnWF,IAIKkD,YAAAA,GAAa,OAAbA,EAAAA,EAAa,SAAA,GAAA,WAAbA,EAAAA,EAAa,UAAA,GAAA,YAAbA,CAAa,EAAbA,IAAa,CAAA,GAoBlB,SAASC,GACPtmB,EACAumB,EACA1F,GAEA,MAAM2F,EACJ3F,IAAcwF,GAAcI,SAAWF,EAAaA,EAAa,EACnE,GAAqC,KAAjCvmB,EAAK0mB,OAAOF,GAAUzX,OAExB,OAAOwX,EAGT,IAAII,EACAC,EAUJ,GARI/F,IAAcwF,GAAcQ,WAC9BF,EAAiB3mB,EAAK8mB,UAAU,EAAGP,GACnCK,EAA8BD,EAAeI,YAE7CJ,EAAiB3mB,EAAK8mB,UAAUP,GAChCK,EAA8BD,EAAeK,cAG1CJ,EAA4BrhB,OAC/B,OAAQ,EAGV,MAAM0hB,EACJN,EAAephB,OAASqhB,EAA4BrhB,OAEtD,OAAOsb,IAAcwF,GAAcQ,UAC/BN,EAAaU,EACbV,EAAaU,CACnB,CAUA,SAASC,GACPC,EACAtG;AAEA,MAAMuG,EACJD,EAAME,wBAAwB7D,cAAe8D,mBAC3CH,EAAME,wBACNE,WAAWC,WAGTC,EACJ5G,IAAcwF,GAAcI,SACxBU,EAAMO,eACNP,EAAMQ,aAENC,EACJ/G,IAAcwF,GAAcI,SACxBU,EAAMQ,aACNR,EAAMO,eAEZ,IAAIG,EAAcT,EAASU,WAG3B,KAAOD,GAAeA,IAAgBJ,GACpCI,EAAcT,EAASU,WAGrBjH,IAAcwF,GAAcQ,YAG9BgB,EAAcT,EAASW,gBAGzB,IAAIC,GAAiB,EAErB,MAAMC,EAAUA,KAMd,GALAJ,EACEhH,IAAcwF,GAAcI,SACxBW,EAASU,WACTV,EAASW,eAEXF,EAAa,CACf,MAAMK,EAAWL,EAAYlY,YACvB4W,EACJ1F,IAAcwF,GAAcI,SAAW,EAAIyB,EAAS3iB,OACtDyiB,EAAgB1B,GAAwB4B,EAAU3B,EAAY1F,EAChE,GAGF,KACEgH,IACmB,IAAnBG,GACAH,IAAgBD,GAEhBK,IAGF,GAAIJ,GAAeG,GAAiB,EAClC,MAAO,CAAEG,KAAMN,EAAaO,OAAQJ,GAGtC,MAAM,IAAIK,WAAW,wDACvB,CC5HA,SAASC,GAAeH,GAAoB,IAAAI,EAAAC,EAC1C,OAAQL,EAAKhlB,UACX,KAAKC,KAAKqlB,aACV,KAAKrlB,KAAKslB,UAIR,OAA+B,QAA/BH,EAAuBC,QAAvBA,EAAOL,EAAKxY,mBAAL6Y,IAAgBA,OAAhBA,EAAAA,EAAkBjjB,cAAMgjB,IAAAA,EAAAA,EAAI,EACrC,QACE,OAAO,EAEb,CAKA,SAASI,GAA2BR,GAClC,IAAIS,EAAUT,EAAKU,gBACftjB,EAAS,EACb,KAAOqjB,GACLrjB,GAAU+iB,GAAeM,GACzBA,EAAUA,EAAQC,gBAEpB,OAAOtjB,CACT,CAUA,SAASujB,GACPnG,KACGoG,GAEH,IAAIC,EAAaD,EAAQ3S,QACzB,MAAMgR,EAAWzE,EAAQa,cAAc8D,mBACrC3E,EACA4E,WAAWC,WAEPyB,EAAU,GAEhB,IACIC,EADArB,EAAcT,EAASU,WAEvBviB,EAAS,EAIb,UAAsB2E,IAAf8e,GAA4BnB,GACjCqB,EAAWrB;AACPtiB,EAAS2jB,EAAS/iB,KAAKZ,OAASyjB,GAClCC,EAAQvgB,KAAK,CAAEyf,KAAMe,EAAUd,OAAQY,EAAazjB,IACpDyjB,EAAaD,EAAQ3S,UAErByR,EAAcT,EAASU,WACvBviB,GAAU2jB,EAAS/iB,KAAKZ,QAK5B,UAAsB2E,IAAf8e,GAA4BE,GAAY3jB,IAAWyjB,GACxDC,EAAQvgB,KAAK,CAAEyf,KAAMe,EAAUd,OAAQc,EAAS/iB,KAAKZ,SACrDyjB,EAAaD,EAAQ3S,QAGvB,QAAmBlM,IAAf8e,EACF,MAAM,IAAIX,WAAW,8BAGvB,OAAOY,CACT,CAMYE,IAAAA,YAAAA,GAAgB,OAAhBA,EAAAA,EAAgB,SAAA,GAAA,WAAhBA,EAAAA,EAAgB,UAAA,GAAA,YAAhBA,CAAgB,EAAA,CAAA,GAWrB,MAAMC,GAIXnlB,YAAY0e,EAAkByF,GAC5B,GAD4ClkB,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,cAAA,GACxCikB,EAAS,EACX,MAAM,IAAI9gB,MAAM,qBAIlBnD,KAAKwe,QAAUA,EAGfxe,KAAKikB,OAASA,CAChB,CAQAiB,WAAWvb,GACT,IAAKA,EAAOvM,SAAS4C,KAAKwe,SACxB,MAAM,IAAIrb,MAAM,gDAGlB,IAAIzG,EAAKsD,KAAKwe,QACVyF,EAASjkB,KAAKikB,OAClB,KAAOvnB,IAAOiN,GACZsa,GAAUO,GAA2B9nB,GACrCA,EAAKA,EAAGqlB,cAGV,OAAO,IAAIkD,GAAavoB,EAAIunB,EAC9B,CAmBA3gB,QAAQhD,EAA4C,IAIlD,IACE,OAAOqkB,GAAe3kB,KAAKwe,QAASxe,KAAKikB,QAAQ,EAmBnD,CAlBE,MAAOre,GACP,GAAoB,IAAhB5F,KAAKikB,aAAsCle,IAAtBzF,EAAQoc,UAAyB,CACxD,MAAMyI,EAAKxoB,SAASyoB,iBAClBplB,KAAKwe,QAAQ6G,cACbjC,WAAWC,WAEb8B,EAAGzB,YAAc1jB,KAAKwe,QACtB,MAAM8G,EAAWhlB,EAAQoc,YAAcsI,GAAiBO,SAClD1pB,EAAOypB,EACRH,EAAGxB,WACHwB,EAAGvB,eACR,IAAK/nB,EACH,MAAM+J,EAER,MAAO,CAAEoe,KAAMnoB,EAAMooB,OAAQqB,EAAW,EAAIzpB,EAAKmG,KAAKZ,OACxD;AACE,MAAMwE,CAEV,CACF,CAMA4f,sBAAsBxB,EAAYC,GAChC,OAAQD,EAAKhlB,UACX,KAAKC,KAAKslB,UACR,OAAOU,GAAaQ,UAAUzB,EAAMC,GACtC,KAAKhlB,KAAKqlB,aACR,OAAO,IAAIW,GAAajB,EAAiBC,GAC3C,QACE,MAAM,IAAI9gB,MAAM,uCAEtB,CAQAqiB,iBAAiBxB,EAAYC,GAC3B,OAAQD,EAAKhlB,UACX,KAAKC,KAAKslB,UAAW,CACnB,GAAIN,EAAS,GAAKA,EAAUD,EAAchiB,KAAKZ,OAC7C,MAAM,IAAI+B,MAAM,oCAGlB,IAAK6gB,EAAKjC,cACR,MAAM,IAAI5e,MAAM,2BAIlB,MAAMuiB,EAAalB,GAA2BR,GAAQC,EAEtD,OAAO,IAAIgB,GAAajB,EAAKjC,cAAe2D,EAC9C,CACA,KAAKzmB,KAAKqlB,aAAc,CACtB,GAAIL,EAAS,GAAKA,EAASD,EAAK1O,WAAWlU,OACzC,MAAM,IAAI+B,MAAM,qCAIlB,IAAIuiB,EAAa,EACjB,IAAK,IAAIvgB,EAAI,EAAGA,EAAI8e,EAAQ9e,IAC1BugB,GAAcvB,GAAeH,EAAK1O,WAAWnQ,IAG/C,OAAO,IAAI8f,GAAajB,EAAiB0B,EAC3C,CACA,QACE,MAAM,IAAIviB,MAAM,2CAEtB,EAUK,MAAMwiB,GAIX7lB,YAAYkK,EAAqB4b,GAAmB7lB,EAAAC,KAAA,aAAA,GAAAD,EAAAC,KAAA,WAAA,GAClDA,KAAKgK,MAAQA,EACbhK,KAAK4lB,IAAMA,CACb,CAOAV,WAAW1G,GACT,OAAO,IAAImH,GACT3lB,KAAKgK,MAAMkb,WAAW1G,GACtBxe,KAAK4lB,IAAIV,WAAW1G,GAExB,CAWAqH,UACE,IAAI7b,EACA4b;CAGF5lB,KAAKgK,MAAMwU,UAAYxe,KAAK4lB,IAAIpH,SAChCxe,KAAKgK,MAAMia,QAAUjkB,KAAK4lB,IAAI3B,QAG7Bja,EAAO4b,GAAOjB,GACb3kB,KAAKgK,MAAMwU,QACXxe,KAAKgK,MAAMia,OACXjkB,KAAK4lB,IAAI3B,SAGXja,EAAQhK,KAAKgK,MAAM1G,QAAQ,CACzBoZ,UAAWsI,GAAiBO,WAE9BK,EAAM5lB,KAAK4lB,IAAItiB,QAAQ,CAAEoZ,UAAWsI,GAAiBc,aAGvD,MAAM9C,EAAQ,IAAI+C,MAGlB,OAFA/C,EAAMgD,SAAShc,EAAMga,KAAMha,EAAMia,QACjCjB,EAAMiD,OAAOL,EAAI5B,KAAM4B,EAAI3B,QACpBjB,CACT,CAKAwC,iBAAiBxC,GACf,MAAMhZ,EAAQib,GAAaQ,UACzBzC,EAAMO,eACNP,EAAMkD,aAEFN,EAAMX,GAAaQ,UAAUzC,EAAMQ,aAAcR,EAAMmD,WAC7D,OAAO,IAAIR,GAAU3b,EAAO4b,EAC9B,CAMAJ,mBAAmBY,EAAepc,EAAe4b,GAC/C,OAAO,IAAID,GACT,IAAIV,GAAamB,EAAMpc,GACvB,IAAIib,GAAamB,EAAMR,GAE3B,CAMAJ,oBAAoBxC,GAClB,ODjLG,SAAmBA,GACxB,IAAKA,EAAM7hB,WAAWyJ,OAAOxJ,OAC3B,MAAM,IAAI8iB,WAAW,yCAEvB,GAAIlB,EAAMO,eAAevkB,WAAaC,KAAKslB,UACzC,MAAM,IAAIL,WAAW,2CAEvB,GAAIlB,EAAMQ,aAAaxkB,WAAaC,KAAKslB,UACvC,MAAM,IAAIL,WAAW,yCAGvB,MAAMmC,EAAerD,EAAMsD,aAE3B,IAAIC,GAAe,EACfC,GAAa,EAEjB,MAAMC,EAAiB,CACrBzc,MAAOmY,GACLa,EAAMO,eAAe/X,YACrBwX,EAAMkD,YACNhE,GAAcI;AAEhBsD,IAAKzD,GACHa,EAAMQ,aAAahY,YACnBwX,EAAMmD,UACNjE,GAAcQ,YAgBlB,GAZI+D,EAAezc,OAAS,IAC1Bqc,EAAaL,SAAShD,EAAMO,eAAgBkD,EAAezc,OAC3Duc,GAAe,GAKbE,EAAeb,IAAM,IACvBS,EAAaJ,OAAOjD,EAAMQ,aAAciD,EAAeb,KACvDY,GAAa,GAGXD,GAAgBC,EAClB,OAAOH,EAGT,IAAKE,EAAc,CAGjB,MAAMvC,KAAEA,EAAIC,OAAEA,GAAWlB,GACvBsD,EACAnE,GAAcI,UAGZ0B,GAAQC,GAAU,GACpBoC,EAAaL,SAAShC,EAAMC,EAEhC,CAEA,IAAKuC,EAAY,CAGf,MAAMxC,KAAEA,EAAIC,OAAEA,GAAWlB,GACvBsD,EACAnE,GAAcQ,WAGZsB,GAAQC,EAAS,GACnBoC,EAAaJ,OAAOjC,EAAMC,EAE9B,CAEA,OAAOoC,CACT,CCyGWK,CAAUf,GAAUgB,UAAU3D,GAAO6C,UAC9C,EClUF,MAAMe,GAAsB,yBAkDrB,SAASC,GAAgB7C,GAC9B,QAAKA,EAAKjC,eAGiD,OAApDiC,EAAKjC,cAAc+E,QAAQF,GACpC,CC1DO,SAASG,GAAc/C,GAC5B,OAAOA,EAAKhlB,WAAaC,KAAKqlB,YAChC,CAEO,SAAS0C,GAAWhD,GACzB,OAAOA,EAAKhlB,WAAaC,KAAKslB,SAChC,CCAO,SAAS0C,GAAqBC,GACnC,GAAIA,EAAUC,YAAcD,EAAUE,WACpC,OAAOF,EAAUG,YAAcH,EAAUI,aAM3C,OAHcJ,EAAUK,WAAW,GAGtBhE,iBAAmB2D,EAAUC,SAC5C,CAKO,SAASK,GAAcxE,EAAcgB,GAC1C,IAAI,IAAAyD,EAAAC,EACF,MAAMtmB,EAA+BqmB,QAAzBA,EAAiB,QAAjBC,EAAG1D,EAAK2D,iBAAS,IAAAD,OAAA,EAAdA,EAAgBtmB,cAAMqmB,IAAAA,EAAAA,EAAIzD,EAAK1O,WAAWlU,OACzD,OAEE4hB,EAAM4E,aAAa5D,EAAM,IAAM,GAE/BhB,EAAM4E,aAAa5D,EAAM5iB,IAAW,CAMxC,CAJE,MAAOxD,GAGP,OAAO,CACT,CACF,CAMO,SAASiqB,GAAmB7E,EAAc3e,GAC/C,MAAM+hB,EAAOpD,EAAME,wBACbD,EAAyBmD,EAAK/G,cAAe8D,mBACjDiD,EACAhD,WAAW0E;CAGb,IAAIpE,EACJ,KAAQA,EAAcT,EAASU,YACzB6D,GAAcxE,EAAOU,IACvBrf,EAASqf,EAGf,CAgDO,SAASqE,GAAmBb,GACjC,GAAIA,EAAUc,YACZ,OAAO,KAET,MAAMC,EAxCD,SAA8BjF,GACnC,MAAMkF,EAAoB,GAO1B,OANAL,GAAmB7E,GAAOgB,IACpBgD,GAAWhD,KAA8BA,EAX9BxY,YAAatC,MADP,UAanBgf,EAAU3jB,KAAKyf,EACjB,IAGKkE,EAAUC,SAAQnE,IACvB,MAAMoE,EAAYpE,EAAK3E,cAAcgJ,cAQrC,GAPAD,EAAUE,mBAAmBtE,GACzBA,IAAShB,EAAMO,gBACjB6E,EAAUpC,SAAShC,EAAMhB,EAAMkD,aAE7BlC,IAAShB,EAAMQ,cACjB4E,EAAUnC,OAAOjC,EAAMhB,EAAMmD,WAE3BiC,EAAUG,UAGZ,MAAO,GAIT,MAAMC,EAAgB7mB,MAAMC,KAAKwmB,EAAUK,kBAE3C,OADAL,EAAUM,SACHF,CAAa,GAExB,CAYoBG,CAAqBzB,EAAUK,WAAW,IAC5D,OAAyB,IAArBU,EAAU7mB,OACL,KAGL6lB,GAAqBC,GAChBe,EAAU,GAEVA,EAAUA,EAAU7mB,OAAS,EAExC,CC5GA,MAAMwnB,GAAgB,6BASTC,GAAoC,CAC/C,mBACA,kBACA,iBA2LK,SAASC,GACd9F,EACA+F,GAEA,MAAMb,EAjER,SAA+BlF,GAC7B,GAAIA,EAAMuF,UAIR,MAAO,GAGT,IAAInC,EAAOpD,EAAME,wBASjB,GARIkD,GAAQA,EAAKpnB,WAAaC,KAAKqlB,eAMjC8B,EAAOA,EAAKrE,gBAETqE,EAGH,MAAO,GAGT,MAAM8B,EAAY,GACZjF,EAAWmD,EAAM/G,cAAe8D,mBACpCiD,EACAhD,WAAWC,WAEb,IAAIW,EACJ,KAAQA,EAAOf,EAASU,YAAa,CACnC,IAAK6D,GAAcxE,EAAOgB,GACxB,SAEF,MAAMnoB,EAAOmoB;CAETnoB,IAASmnB,EAAMO,gBAAkBP,EAAMkD,YAAc,EAGvDrqB,EAAKmtB,UAAUhG,EAAMkD,cAInBrqB,IAASmnB,EAAMQ,cAAgBR,EAAMmD,UAAYtqB,EAAKmG,KAAKZ,QAE7DvF,EAAKmtB,UAAUhG,EAAMmD,WAGvB+B,EAAU3jB,KAAK1I,GACjB,CAEA,OAAOqsB,CACT,CAcoBe,CAAsBjG,GAIlCkG,EAAgBhB,EAAU9mB,OAAS,GAAKylB,GAAgBqB,EAAU,IAIxE,IAAIiB,EAA0B,GAC1BC,EAAwB,KACxBC,EAAc,KAElBnB,EAAUpnB,SAAQkjB,IACZoF,GAAYA,EAASvW,cAAgBmR,EACvCqF,EAAY9kB,KAAKyf,IAEjBqF,EAAc,CAACrF,GACfmF,EAAc5kB,KAAK8kB,IAErBD,EAAWpF,CAAI,IAMjB,MAAMsF,EAAa,QACnBH,EAAgBA,EAAcpS,QAAOwS,GAEnCA,EAAKvU,MAAKgP,IAASsF,EAAWlW,KAAK4Q,EAAKhiB,UAI1C,MAAMwnB,EAAiC,GA4BvC,OA3BAL,EAAcroB,SAAQ2oB,IAIpB,MAAMC,EAAc/sB,SAASyY,cAAc,wBAC3CsU,EAAYxO,UAAYC,GAAW,uBAAwB4N,GAE5CU,EAAM,GAAGhZ,WACjBkZ,aAAaD,EAAaD,EAAM,IACvCA,EAAM3oB,SAAQkjB,GAAQ0F,EAAY1W,YAAYgR,KAE9CwF,EAAWjlB,KAAKmlB,EAAY,IAYzBR,GAvMP,SACEU,EACAb,GAEA,GAA4B,IAAxBa,EAAaxoB,OACf,OAKF,MAAMyoB,EAjDR,SAAsBH,GAepB,MAAMI,EAASJ,EAAY5C,QAAQ,SACnC,OAAKgD,GAIYA,EAAO7d,cAAc,4BAH7B,IASX,CAuBmB8d,CAAaH,EAAa,IAC3C,IAAKC,IAAaA,EAAS9H,cACzB,OAGF,IAAIiI,EAAoBH,EAAS9H,cAAc9V,cAC7C,+BAGF,IAAK+d,EAAmB,CAItBA,EAAoBrtB,SAASwY,gBAAgByT,GAAe,OAC5DoB,EAAkB1sB,aAAa,QAAS,8BACxCusB,EAAS9H,cAAc/O,YAAYgX,GAGnCH,EAAS9H,cAAczO,MAAM2L,SAAW,WAExC,MAAMgL,EAAWD,EAAkB1W,MACnC2W,EAAShL,SAAW,WACpBgL,EAAS9K,KAAO;AAChB8K,EAAS/K,IAAM,IACf+K,EAASjR,MAAQ,OACjBiR,EAAShR,OAAS,OAOlBgR,EAASC,aAAe,UAC1B,CAEA,MAAMC,EAAaN,EAASlJ,wBACtByJ,EAAiBR,EAAa/nB,KAAI6nB,IACtC,MAAMW,EAAgBX,EAAY/I,wBAG5B2J,EAAO3tB,SAASwY,gBAAgByT,GAAe,QAgBrD,OAfA0B,EAAKhtB,aAAa,KAAM+sB,EAAclL,KAAOgL,EAAWhL,MAAMhe,YAC9DmpB,EAAKhtB,aAAa,KAAM+sB,EAAcnL,IAAMiL,EAAWjL,KAAK/d,YAC5DmpB,EAAKhtB,aAAa,QAAS+sB,EAAcrR,MAAM7X,YAC/CmpB,EAAKhtB,aAAa,SAAU+sB,EAAcpR,OAAO9X,YACjDmpB,EAAKhtB,aACH,QACA6d,GAAW,2BAA4B4N,IAIzCW,EAAY7sB,UAAUQ,IAAI,kBAG1BqsB,EAAYa,aAAeD,EAEpBA,CAAI,IAGbN,EAAkBQ,UAAUJ,EAC9B,CAkIIK,CAA6BjB,EAAYT,GAGpCS,CACT,CAOA,SAASkB,GAAY1G,EAAiB2G,GACpC,MAAMhhB,EAASqa,EAAKvT,WACpBka,EAAa7pB,SAAQmP,GAAKtG,EAAOsJ,aAAahD,EAAG+T,KACjDA,EAAKvmB,QACP,CAaO,SAASmtB,GAAiBpB,GAG/BqB,GAAqBrB,GAAY,GACjC,IAAK,MAAMjZ,KAAKiZ,EAAY,CAC1B,GAAIjZ,EAAEE,WAAY,CAEhBia,GAAYna,EADK5O,MAAMC,KAAK2O,EAAE+E,YAEhC,CACI/E,EAAEga,cACJha,EAAEga,aAAa9sB,QAEnB,CACF,CAgDO,SAASotB,GACdrB,EACAsB,GAEAtB,EAAW1oB,SAAQyP,IAIbA,EAAEga,aA3CV,SAAgCQ,EAAmBD,GACjD,MAAMnhB,EAASohB,EAAMta,WAGfua,EAAYD,EAAME,aAAa,mBAGrC,GADkBhgB,QAAQ+f,KACRF,EAIlB,GAAIA,EAAS,CACXC,EAAMztB,aAAa,kBAAmB+D,EAAkB,IACxD,MAAM6pB,EAAmBH,EAAMI,YAI/BD,EAAiB5tB,aAAa,kBAAmB,mBACjDqM,EAAO6gB,OAAOU,EAChB,KAAO;AACL,MAAMA,EAAmBvhB,EAAOsC,cAC7B,qBAAoB+e,wBAEvBE,SAAAA,EAAkBztB,SAClBstB,EAAMrtB,gBAAgB,kBACxB,CACF,CAkBM0tB,CAAuB7a,EAAEga,aAAcO,GAEvCva,EAAE1T,UAAUwuB,OAAO,+BAAgCP,EACrD,GAEJ,CA8CO,SAASnK,GAAsB2K,GAEpC,MAAMC,EAAQD,EAAWzpB,KAAIgO,GAAKA,EAAE8Q,0BACpC,OAAO4K,EAAMC,QAAO,CAACC,EAAKxb,KAAO,CAC/BiP,IAAK6B,KAAKC,IAAIyK,EAAIvM,IAAKjP,EAAEiP,KACzBC,KAAM4B,KAAKC,IAAIyK,EAAItM,KAAMlP,EAAEkP,MAC3BuM,OAAQ3K,KAAKM,IAAIoK,EAAIC,OAAQzb,EAAEyb,QAC/BC,MAAO5K,KAAKM,IAAIoK,EAAIE,MAAO1b,EAAE0b,UAEjC,CAMO,SAASC,GAAepN,GAC7BqN,GAAeC,GAActN,IAsI/B,SAAoCA,GAClC,IAAK,MAAOuN,EAAOC,KA7FrB,SAA0B5F,GACxB,MAAM6F,EAAkD,IAAI/rB,IAE5D,IAAK,MAAM6rB,KAAU3F,QAAAA,EAAQzpB,UAAUuvB,uBACrC,8BAEAD,EAAcxrB,IACZsrB,EACApqB,MAAMC,KACJmqB,EAAM1gB,iBAAiB,+BAK7B,OAAO4gB,CACT,CA8EyCE,CAAiB3N,GAAU,CACvCwN,EAAgBhV,OAAM,CAAC+T,EAAOqB,EAAKC,IAC9C,IAARD,GAGGE,GAAavB,IAAUuB,GAAaD,EAAOD,EAAM,QAIxDJ,EAAgBxpB,MAAK,CAAC8N,EAAGmB,IAAM6a,GAAahc,GAAKgc,GAAa7a,KAC9Dsa,EAAMQ,mBAAmBP,GAE7B,CACF,CAnJEQ,CAA2BhO,EAC7B,CAMA,MAAMiO,GAAsB/vB,GACG,yBAA7BA,EAAGM,QAAQ+B,cAWb,SAAS+sB,GAActN,GACrB,IAAIgL,EAWJ,OATEA,EADEiD,GAAmBjO,GACR7c,MAAMC,KAAK4c,EAAQjN,UAAUwF,OAAO0V,IAEpC9qB,MAAMC,KACjB4c,EAAQkO,qBAAqB,yBAC7B3V,QACA4V,IACGA,EAAU5K,gBAAkB0K,GAAmBE,EAAU5K,iBAGzDyH,CACT;AA+CA,SAASqC,GACPjC,EACAgD,EAAgB,GAChBN,EAAe,EACfO,EAAqB,GAErB,IAAK,MAAMC,KAAOlD,EAAc,CAAA,IAAAmD,EAC9B,MAAMC,UAASD,EACblE,GAAchhB,MAAKolB,GAAMH,EAAIjwB,UAAUO,SAAS6vB,YAAI,IAAAF,EAAAA,EAAI,gBAEpDG,EACJN,GAAiBI,IAAcJ,EAAgBC,EAAqB,EAAI,EAE1EC,EAAIxvB,aAAa,qBAAuB,GAAEgvB,KAC1CQ,EAAIxvB,aAAa,qBAAuB,GAAE4vB,KAEtCJ,EAAIvC,eACNuC,EAAIvC,aAAajtB,aAAa,qBAAuB,GAAEgvB,KACvDQ,EAAIvC,aAAajtB,aAAa,qBAAuB,GAAE4vB,MAGzDrB,GACEC,GAAcgB,GACdE,EACAV,EAAe,EACfY,EAEJ,CACF,CAUA,SAASZ,GAAa5vB,GAAqB,IAAAywB,EACzC,OAAIzwB,EAAGuuB,aAAa,mBACXlgB,OAAOqiB,iBAETjkB,SAA8C,QAAtCgkB,EAACzwB,EAAGuuB,aAAa,6BAAqBkC,IAAAA,EAAAA,EAAI,IAAK,GAChE,CChhBO,MAAME,GAMXvtB,aAAYwtB,iBAAEA,EAAgBC,QAAEA,IAAmCxtB,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,sBAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,kBAAA,GACjEA,KAAKwtB,SAAWD,EAChBvtB,KAAKytB,gBAAiB,EACtBztB,KAAK0tB,SAAW,GAChB1tB,KAAKC,WAAa,IAAIJ,EAEtBG,KAAKC,WAAW5C,IAAIgB,OAAQ,UAAU,IAAM2B,KAAK2tB,WACjD3tB,KAAKC,WAAW5C,IAAIgB,OAAQ,UAAU,IAAM2B,KAAK2tB,WACjD3tB,KAAKC,WAAW5C,IAAIiwB,EAAkB,UAAU,IAAMttB,KAAK2tB,UAC7D,CAEA3qB,UACEhD,KAAKC,WAAWY,WAClB,CAYA8sB,OAAOC;AACDA,IACF5tB,KAAK0tB,SAAWE,GAGd5tB,KAAKytB,iBAITztB,KAAKytB,gBAAiB,EACtBxW,uBAAsB,KACpB,MAAM4W,ECmCL,SAAgCD,GAErC,MAAMC,EAAY,GAwBlB,OAtBAD,EAAQ9sB,SAAQ,EAAGgtB,aAAYtE,iBAC7B,GAAKA,UAAAA,EAAYpoB,OACf,OAGF,MAAM8d,IAAEA,EAAGwM,OAAEA,GAAW/K,GAAsB6I,GAE1CtK,GAAOwM,GAKXmC,EAAUtpB,KAAK,CACbwpB,IAAKD,EAAWE,KAChB9O,MACAwM,UACA,IAIJmC,EAAUrrB,MAAK,CAACyrB,EAASC,IAAYD,EAAQ/O,IAAMgP,EAAQhP,MAEpD2O,CACT,CD9DwBM,CAAuBnuB,KAAK0tB,UAC9C1tB,KAAKwtB,SAASvoB,KAAK,iBAAkB4oB,GACrC7tB,KAAKytB,gBAAiB,CAAK,IAE/B,EExEF,IAAIW,GAAgB,IAAItnB,IAajB,SAASunB,MAAYjmB,GAC1B,MAAM4G,EAAM5G,EAAKtG,OACbssB,GAAc7mB,IAAIyH,KAGtB3I,QAAQC,QAAQ8B,GAChBgmB,GAAc/wB,IAAI2R,GACpB,CAEAqf,GAASC,MAAQ,KACfF,GAAcrtB,OAAO,EChBvB,MAAMwtB,GAAiB,CAAC,oBAAqB,6BAKtC,MAAMC,WAAqBhpB,EAShC1F,YAAY2uB,EAAuBF,IACjCG,QAAQ3uB,EAAAC,KAAA,cAAA,GAAAD,EAAAC,KAAA,mBAAA,GAERA,KAAK2uB,OAAS,IAAIzuB,IAClBF,KAAK4uB,YAAcH,CACrB,CAKAd,OAAOkB,GACL7uB,KAAK2uB,OAAO5tB,QACZ,IAAK,MAAO+tB,EAAM3qB,KAAO7B,OAAOysB,QAAQF,GACtC7uB,KAAK2uB,OAAOluB,IAAIquB,EAAM3qB,GAExBnE,KAAK+E,KAAK,eACZ,CASAiqB,YAAYF,GAAuB,IAAAG,EACjC,OAAKjvB,KAAK4uB,YAAYnU,SAASqU,GAIHG,QAA5BA,EAAOjvB,KAAK2uB,OAAOhuB,IAAImuB,UAAKG,IAAAA,GAAAA,GAH1BZ,GAAS,4BAA6BS,IAC/B,EAGX,CAQAI,WACE,OAAO5sB,OAAO6sB,YAAYnvB,KAAK2uB,OACjC;ACrCF,SAASS,IAAoBC,QAC3BA,EAAOpS,MACPA,EAAKqS,SACLA,EAAQC,cACRA,EAAaC,gBACbA,IAEA,MAAMC,EAAmBF,EAAcF,GACjCK,EAAgC,gBAArBD,EACjB,OACEtS,GAAA,MAAA,CAAKjC,UAAU,YAAW3J,UACxBsL,GAAA,MAAA,CAAK3B,UAAU,gDAA+C3J,SAC5DsL,GAAA,MAAA,CACE3B,UAAU,yCACV5H,MAAO,CACLqc,gBAAiBH,EAAgBC,GAAkBlT,OACnDhL,SAED0L,MAGLJ,GAAA,MAAA,CAAK3B,UAAU,4BAA2B3J,SACvCjP,OAAOC,KAAKitB,GAAiB3tB,KAAI+tB,GAChCzS,GAAA,MAAA,CAAKjC,UAAU,WAAU3J,UACvBsL,GAAA,QAAA,CACE3B,UAAWC,GAET,mBAGA,mBACA,kBAEF/W,KAAMirB,EACNQ,GAAK,cAAaR,KAAWO,IAC7Bja,QAAS8Z,IAAqBG,EAC9BN,SAAUA,EACVvyB,KAAK,QACL4N,MAAOilB,IAETzS,GAAA,QAAA,CAAOjC,UAAU,QAAQ4U,QAAU,GAAET,KAAWO,IAAYre,UAC1DsL,GAAA,MAAA,CACEvJ,MAAO,CACLqc,gBAAiBH,EAAgBI,GAAWrT,OAE9CrB,UAAWC,GACT,8DACA,CACE,0BAA2BsU,IAAqBG,EAChD,0BAA2BH,IAAqBG,IAElDre,SAEa,gBAAdqe,GACC/S,GAAC/C,GAAQ,CACPoB,UAAWC,GAAW,UAAW,CAC/B,gBAAiBuU,EACjB,eAAgBA,QAKxB7S,GAAA,OAAA,CAAM3B,UAAU,UAAS3J,SAAEqe;KAvCC,GAAEP,KAAWO,WA8CvD,CAae,SAASG,IAAehV,OACrCA,EAAMiV,gBACNA,EAAeT,cACfA,EAAaU,cACbA,IAEA,MAAMC,EAAoBC,IACvBC,IACC,MAAMC,EAAQD,EAAYjyB,OACpBkxB,EAAUgB,EAAMjsB,KAChBwrB,EAAYS,EAAM1lB,MAExBslB,EAAcZ,EAASO,EAAU,GAEnC,CAACK,KAGIK,EAAQC,GAAWC,IAAS,GAEnC,OAAKzV,EAKH8B,GAAC4T,GAAI,CAAAlf,SACH4L,GAAA,MAAA,CAAKjC,UAAU,oDAAmD3J,SAAA,CAChEsL,GAAC6T,GAAM,CACL,cAAY,wBACZxT,QAASA,IAAMqT,GAASD,GACxB5U,MAAO4U,EAAS,0BAA4B,0BAA0B/e,SAGpE4L,GAAAI,EADD+S,EACC,CAAA/e,UACEsL,GAACpD,GAAa,CAAA,GACdoD,GAAA,OAAA,CAAAtL,SAAM,2BAGR,CAAAA,SAAA,CACEsL,GAAClD,OACDkD,GAAC9C,GAAgB,CAAA,QAItBuW,GACCnT,GAACwT,GAAW,CAAC,cAAY,yBAAyBtV,KAAK,KAAI9J,SAAA,CACzDsL,GAACuS,GAAmB,CAClBI,gBAAiBQ,EACjB/S,MAAM,iBACNoS,QAAQ,mBACRC,SAAUY,EACVX,cAAeA,IAEjB1S,GAACuS,GAAmB,CAClBI,gBAAiBQ,EACjB/S,MAAM,gBACNoS,QAAQ,kBACRC,SAAUY,EACVX,cAAeA,IAEjB1S,GAACuS,GAAmB,CAClBI,gBAAiBQ,EACjB/S,MAAM,sBACNoS,QAAQ,gBACRC,SAAUY,EACVX,cAAeA,YA5ClB,IAmDX,CC9JO,MAAMC,GAAmC,CAC9CoB,YAAa,CACXrU,MAAO,cACPsU,YAAa,cACbC,WAAY,eAEdC,KAAM;AACJxU,MAAO,+BACPsU,YAAa,iCACbC,WAAY,kCAEdE,OAAQ,CACNzU,MAAO,iCACPsU,YAAa,mCACbC,WAAY,oCAEdG,OAAQ,CACN1U,MAAO,iCACPsU,YAAa,mCACbC,WAAY,oCAEdI,MAAO,CACL3U,MAAO,gCACPsU,YAAa,kCACbC,WAAY,mCAEdK,OAAQ,CACN5U,MAAO,iCACPsU,YAAa,mCACbC,WAAY,oCAEdM,KAAM,CACJ7U,MAAO,+BACPsU,YAAa,iCACbC,WAAY,mCAMHO,GAAsC,CACjD,gBAAiB,SACjB,mBAAoB,SACpB,kBAAmB,UAGd,MAAMC,GAQXxxB,YAAY0e,EAAsBle,GAAsCP,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,iBAAA;AAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,sBAAA,GACtEA,KAAKuxB,SAAW/S,EAChBxe,KAAKwxB,UAAYlxB,EAAQmxB,SAEzBzxB,KAAK+e,gBAAkBpiB,SAASyY,cAC9B,wCAEFpV,KAAKuxB,SAASve,YAAYhT,KAAK+e,iBAC/B/e,KAAKgf,YAAcjB,GAAiB/d,KAAK+e,iBAGzCzc,OAAOmJ,OAAOzL,KAAK+e,gBAAgBzL,MAAO,CACxC2L,SAAU,QACVC,IAAM,GAAElf,KAAKuxB,SAASG,UAAY,MAClCvS,KAAM,QAGRnf,KAAK2xB,cAAgBN,GAErBrxB,KAAK4xB,QAEL5xB,KAAKwxB,UAAUrtB,GAAG,gBAAgB,KAChCnE,KAAK6xB,UAAU7xB,KAAK8xB,YAAY,IAGlC9xB,KAAKggB,SACP,CAEAhd,UACE1E,aAAa0B,KAAK+xB,gBAClBhe,GAAO,KAAM/T,KAAKgf,aAClBhf,KAAK6xB,WAAU,GACf7xB,KAAK+e,gBAAgBthB,QACvB,CAMAu0B,yBACE1zB,aAAa0B,KAAK+xB,gBAClB/xB,KAAK+xB,eAAiBxzB,YAAW,IAAMyB,KAAKiyB,mBAAmB,IACjE,CAOAL,QACE,IAAK,MAAMvC,KAAW/sB,OAAOC,KAAKvC,KAAK2xB,eAGrC3xB,KAAKkyB,kBAAkB7C,EAASrvB,KAAK2xB,cAActC,IAGrDrvB,KAAK6xB,UAAU7xB,KAAK8xB,YACtB,CAEAG,kBACOjyB,KAAK8xB,aAIVlG,GAAe5rB,KAAKuxB,SACtB,CAEAO;AACE,OAAO9xB,KAAKwxB,UAAUxC,YAAY,4BACpC,CAKA6C,UAAU9W,GACR/a,KAAKuxB,SAAS10B,UAAUwuB,OAAO,kCAAmCtQ,GAClE/a,KAAKggB,SACP,CAKAmS,iBAAiBnjB,EAAarE,GAC5BhO,SAAS0C,gBAAgBiU,MAAMH,YAAYnE,EAAKrE,EAClD,CAMAunB,kBACE7C,EACAO,GAEA,MAAMwC,EAAa5C,GAAgBI,GAEnC,IAAK,MAAMyC,KAAY/vB,OAAOC,KAAK6vB,GAGjCpyB,KAAKmyB,iBACF,gBAAe9C,KAAWgD,IAC3BD,EAAWC,GAGjB,CAKAC,sBACEjD,EACAO,GAEA5vB,KAAK2xB,cAActC,GAAWO,EAC9B5vB,KAAKkyB,kBAAkB7C,EAASO,GAChC5vB,KAAKggB,SACP,CAEAA,UACEjM,GACE8I,GAACkT,GAAc,CACbhV,OAAQ/a,KAAK8xB,YACb9B,gBAAiBR,GACjBD,cAAevvB,KAAK2xB,cACpB1B,cAAeA,CAACZ,EAASO,IACvB5vB,KAAKsyB,sBAAsBjD,EAASO,KAGxC5vB,KAAKgf,YAET,EC5KF,SAASuT,GAAQliB,GACb,OAAOA,EAAEqH,MAAM,IAAI6a,UAAUzwB,KAAK,GACtC,CAwCA,SAAS0wB,GAAa3iB,GAClB,OAASA,GAAKA,IAAM,GAAM,CAC9B,CAaA,SAAS4iB,GAAanuB,EAAKouB,EAAKjhB,EAAGkhB,GAC/B,IAAIC,EAAKtuB,EAAIqP,EAAElC,GACXohB,EAAKvuB,EAAIgO,EAAEb,GACf,MAAMqhB,EAAgBH,IAAQ,GACxBI,EAAKL,EAAIjhB,GAAKqhB,EAEdE,EAAKD,EAAKF,EACVI,GAAQF,EAAKH,GAAMA,EAAMA,EAAMG,EACrC,IAAIG,EAAKL,IAAOI,EAAKL,GACjBO,EAAKP,EAAKK,EAEd,MAAMG,EAAOZ,GAAaU,EAAK5uB,EAAI+uB,YAAY5hB,IAC3C+gB,GAAaW,EAAK7uB,EAAI+uB,YAAY5hB,IAUtC,OARAyhB,IAAO,EACPC,IAAO,EACPA,GAAML,EACNI,GAAMV,GAAaG,GAAOG,EAC1BF,EAAKO,IAAOH,EAAKE,GACjBL,EAAKK,EAAKF,EACV1uB,EAAIqP,EAAElC,GAAKmhB,EACXtuB,EAAIgO,EAAEb,GAAKohB,EACJO,CACX,CASA,SAASE,GAAcz3B,EAAM03B,EAASC,GAClC,GAAuB,IAAnBD,EAAQnyB,OACR,MAAO,GAIXoyB,EAAYzS,KAAKC,IAAIwS,EAAWD,EAAQnyB;CACxC,MAAMqX,EAAU,GAEV3G,EAAI,GAEJ2hB,EAAO1S,KAAK2S,KAAKH,EAAQnyB,OAAS0Q,GAAK,EAEvCxN,EAAM,CACRqP,EAAG,IAAIggB,YAAYF,EAAO,GAC1BnhB,EAAG,IAAIqhB,YAAYF,EAAO,GAC1BJ,YAAa,IAAIM,YAAYF,EAAO,IAExCnvB,EAAI+uB,YAAYla,KAAK,GAAK,IAC1B7U,EAAI+uB,YAAYI,GAAQ,IAAMF,EAAQnyB,OAAS,GAAK0Q,EAEpD,MAAM8hB,EAAW,IAAID,YAAYF,EAAO,GAGlCf,EAAM,IAAIxyB,IAIV2zB,EAAW,GACjB,IAAK,IAAI1uB,EAAI,EAAGA,EAAI,IAAKA,IACrB0uB,EAAStvB,KAAKqvB,GAKlB,IAAK,IAAIxjB,EAAI,EAAGA,EAAImjB,EAAQnyB,OAAQgP,GAAK,EAAG,CACxC,MAAMnP,EAAMsyB,EAAQO,WAAW1jB,GAC/B,GAAIsiB,EAAInrB,IAAItG,GAER,SAEJ,MAAM8yB,EAAU,IAAIJ,YAAYF,EAAO,GACvCf,EAAIjyB,IAAIQ,EAAK8yB,GACT9yB,EAAM4yB,EAASzyB,SACfyyB,EAAS5yB,GAAO8yB,GAEpB,IAAK,IAAItiB,EAAI,EAAGA,GAAKgiB,EAAMhiB,GAAK,EAAG,CAC/BsiB,EAAQtiB,GAAK,EAIb,IAAK,IAAIxB,EAAI,EAAGA,EAAI6B,EAAG7B,GAAK,EAAG,CAC3B,MAAMmc,EAAM3a,EAAIK,EAAI7B,EACpB,GAAImc,GAAOmH,EAAQnyB,OACf,SAEUmyB,EAAQO,WAAW1H,KAASnrB,IAEtC8yB,EAAQtiB,IAAM,GAAKxB,EAE1B,CACJ,CACJ,CAED,IAAIuC,EAAIuO,KAAKM,IAAI,EAAGN,KAAK2S,KAAKF,EAAY1hB,GAAK,GAE/C,MAAMkiB,EAAQ,IAAIL,YAAYF,EAAO,GACrC,IAAK,IAAIhiB,EAAI,EAAGA,GAAKe,EAAGf,GAAK,EACzBuiB,EAAMviB,IAAMA,EAAI,GAAKK,EAEzBkiB,EAAMP,GAAQF,EAAQnyB,OAEtB,IAAK,IAAIqQ,EAAI,EAAGA,GAAKe,EAAGf,GAAK,EACzBnN,EAAIqP,EAAElC,IAAK,EACXnN,EAAIgO,EAAEb,GAAK,EAIf,IAAK,IAAIiC,EAAI,EAAGA,EAAI7X,EAAKuF,OAAQsS,GAAK,EAAG,CAGrC,MAAMugB,EAAWp4B,EAAKi4B,WAAWpgB,GACjC,IAAIqgB,EACAE,EAAWJ,EAASzyB,OAEpB2yB,EAAUF,EAASI,IAInBF,EAAUrB,EAAI/xB,IAAIszB,QACK,IAAZF,IACPA,EAAUH,IAKlB,IAAIM,EAAQ,EACZ,IAAK,IAAIziB,EAAI,EAAGA,GAAKe,EAAGf,GAAK,EACzByiB,EAAQzB,GAAanuB,EAAKyvB,EAAStiB,EAAGyiB,GACtCF,EAAMviB,IAAMyiB,EAIhB,GAAIF,EAAMxhB,GAAK0hB,GAASV,GACpBhhB,EAAIihB,IACc,EAAjBM,EAAQvhB,EAAI,IAAU0hB,EAAQ,GAAI,CAMnC,IAAIC,EACJ,GAJA3hB,GAAK,EACLlO,EAAIqP,EAAEnB,IAAK,EACXlO,EAAIgO,EAAEE,GAAK,EAEPA,IAAMihB,EAAM,CACZ,MAAMW,EAAYb,EAAQnyB,OAAS0Q,EACnCqiB,EAA8B,IAAdC,EAAkBtiB,EAAIsiB,CACzC,MAEGD,EAAgBriB,EAEpBkiB,EAAMxhB,GACFwhB,EAAMxhB,EAAI,GACN2hB,EACAD,EACAzB,GAAanuB,EAAKyvB,EAASvhB,EAAG0hB,EACzC,MAIG,KAAO1hB,EAAI,GAAKwhB,EAAMxhB,IAAMghB,EAAY1hB,GACpCU,GAAK;CAITA,IAAMihB,GAAQO,EAAMxhB,IAAMghB,IACtBQ,EAAMxhB,GAAKghB,GAEX/a,EAAQpC,OAAO,EAAGoC,EAAQrX,QAE9BqX,EAAQlU,KAAK,CACTyF,OAAQ,EACR4b,IAAKlS,EAAI,EACT2gB,OAAQL,EAAMxhB,KAMlBghB,EAAYQ,EAAMxhB,GAEzB,CACD,OAAOiG,CACX,CAOe,SAAS3c,GAAOD,EAAM03B,EAASC,GAE1C,OA9OJ,SAAyB33B,EAAM03B,EAAS9a,GACpC,MAAM6b,EAAS/B,GAAQgB,GACvB,OAAO9a,EAAQ5W,KAAKgQ,IAIhB,MAAM0iB,EAAWxT,KAAKM,IAAI,EAAGxP,EAAE+T,IAAM2N,EAAQnyB,OAASyQ,EAAEwiB,QAUxD,MAAO,CACHrqB,MAPUspB,GAHEf,GAAQ12B,EAAKmJ,MAAMuvB,EAAU1iB,EAAE+T,MAGV0O,EAAQziB,EAAEwiB,QAAQ7I,QAAO,CAACxK,EAAKwT,IAC5D3iB,EAAE+T,IAAM4O,EAAG5O,IAAM5E,EACVnP,EAAE+T,IAAM4O,EAAG5O,IAEf5E,GACRnP,EAAE+T,KAGDA,IAAK/T,EAAE+T,IACPyO,OAAQxiB,EAAEwiB,OACb,GAET,CAwNWI,CAAgB54B,EAAM03B,EADbD,GAAcz3B,EAAM03B,EAASC,GAEjD,CCvQA,SAAS13B,GAAOD,EAAcqF,EAAasyB,GAGzC,IAAIkB,EAAW,EACf,MAAMC,EAA8B,GACpC,MAAqB,IAAdD,GACLA,EAAW74B,EAAK6V,QAAQxQ,EAAKwzB,IACX,IAAdA,IACFC,EAAapwB,KAAK,CAChByF,MAAO0qB,EACP9O,IAAK8O,EAAWxzB,EAAIE,OACpBizB,OAAQ,IAEVK,GAAY,GAGhB,OAAIC,EAAavzB,OAAS,EACjBuzB,EAKFC,GAAa/4B,EAAMqF,EAAKsyB,EACjC,CAKA,SAASqB,GAAeh5B,EAAcqF,GAIpC,GAAmB,IAAfA,EAAIE,QAAgC,IAAhBvF,EAAKuF,OAC3B,OAAO,EAMT,OAAO,EAHStF,GAAOD,EAAMqF,EAAKA,EAAIE,QAGlB,GAAGizB,OAASnzB,EAAIE,MACtC,CAoBO,SAAS0zB,GACdj5B,EACAk5B,EACA9uB,EAAmB,CAAA,GAEnB,GAAqB,IAAjB8uB,EAAM3zB,OACR,OAAO,KAYT,MAAMoyB,EAAYzS,KAAKC,IAAI,IAAK+T,EAAM3zB,OAAS,GAGzCqX,EAAU3c,GAAOD,EAAMk5B,EAAOvB,GAEpC,GAAuB,IAAnB/a,EAAQrX,OACV,OAAO,KAMT,MAAM4zB,EAAc9rB,IAClB,MAKM+rB,EAAa,EAAI/rB,EAAMmrB,OAASU,EAAM3zB,OAEtC8zB,EAAcjvB,EAAQkvB,OACxBN,GACEh5B,EAAKmJ,MACH+b,KAAKM,IAAI,EAAGnY,EAAMc,MAAQ/D,EAAQkvB,OAAO/zB,QACzC8H,EAAMc,OAER/D,EAAQkvB,QAEV,EACEC,EAAcnvB,EAAQovB,OACxBR,GACEh5B,EAAKmJ,MAAMkE,EAAM0c,IAAK1c,EAAM0c,IAAM3f,EAAQovB,OAAOj0B,QACjD6E,EAAQovB,QAEV,EAEJ,IAAIC,EAAW,EACf,GAA4B,iBAAjBrvB,EAAQsvB,KAAmB,CAEpCD,EAAW,EADIvU,KAAKyU,IAAItsB,EAAMc,MAAQ/D,EAAQsvB,MACpB15B,EAAKuF,MACjC;AAUA,OArCoB,GA8BJ6zB,EA7BK,GA8BJC,EA7BI,GA8BJE,EA7BC,EA8BJE,GACGG,EAGK,EAKlBC,EAAgBjd,EAAQ5W,KAAIgQ,IAAM,CACtC7H,MAAO6H,EAAE7H,MACT4b,IAAK/T,EAAE+T,IACPoO,MAAOgB,EAAWnjB,OAKpB,OADA6jB,EAAclzB,MAAK,CAAC8N,EAAGmB,IAAMA,EAAEuiB,MAAQ1jB,EAAE0jB,QAClC0B,EAAc,EACvB,CCjIA,SAASC,GAAe3R,GACtB,MAAM5f,EA7BR,SAAqB4f,GACnB,MAAMpnB,EAAWonB,EAAKpnB,SAASmC,cAC/B,IAAI62B,EAASh5B,EAIb,MAHiB,UAAbA,IACFg5B,EAAS,UAEJA,CACT,CAsBeC,CAAY7R,GACnB8R,EAhBR,SAAyB9R,GACvB,IAAI8R,EAAM,EAENC,EAAM/R,EACV,KAAO+R,GACDA,EAAIn5B,WAAaonB,EAAKpnB,WACxBk5B,GAAO,GAETC,EAAMA,EAAIrR,gBAEZ,OAAOoR,CACT,CAKcE,CAAgBhS,GAC5B,MAAQ,GAAE5f,KAAQ0xB,IACpB,CASO,SAASG,GAAcjS,EAAMoC,GAClC,IAAI8P,EAAQ,GAGRC,EAAOnS,EACX,KAAOmS,IAAS/P,GAAM,CACpB,IAAK+P,EACH,MAAM,IAAIhzB,MAAM,oCAElB+yB,EAAQP,GAAeQ,GAAQ,IAAMD,EACrCC,EAAOA,EAAK1lB,UACd,CAIA,OAHAylB,EAAQ,IAAMA,EACdA,EAAQA,EAAM1iB,QAAQ,MAAO,IAEtB0iB,CACT,CAUA,SAASE,GAAe5X,EAAS5hB,EAAUy5B,GACzCz5B,EAAWA,EAAS05B,cAEpB,IAAIC,GAAc,EAClB,IAAK,IAAIpxB,EAAI,EAAGA,EAAIqZ,EAAQjN,SAASnQ,OAAQ+D,IAAK,CAChD,MAAMqxB,EAAQhY,EAAQjN,SAASpM,GAC/B,GAAIqxB,EAAM55B,SAAS05B,gBAAkB15B,MACjC25B,EACEA,IAAeF,GACjB,OAAOG,CAGb,CAEA,OAAO,IACT,CA4EO,SAASC,GAAcP,EAAO9P,EAAOzpB,SAAS+5B,MACnD,IACE,OAvDJ,SAA6BR,EAAO9P,GAGlC,GADuD,OAArD8P,EAAMhtB,MAAM,qCAEZ,MAAM,IAAI/F,MAAM,oCAGlB,MAAMwzB,EAAWT,EAAMxe,MAAM,KAC7B,IAAI8G,EAAU4H,EAIduQ,EAAS1kB,QAET,IAAK,IAAI2kB,KAAWD,EAAU,CAC5B,IAAIE,EACAC,EAEJ,MAAMC,EAAeH,EAAQllB,QAAQ,KACrC,IAAsB,IAAlBqlB,EAAqB,CACvBF,EAAcD,EAAQ5xB,MAAM,EAAG+xB,GAE/B,MAAMC,EAAWJ,EAAQ5xB,MAAM+xB,EAAe,EAAGH,EAAQllB,QAAQ;CAEjE,GADAolB,EAAe3tB,SAAS6tB,GAAY,EAChCF,EAAe,EACjB,OAAO,IAEX,MACED,EAAcD,EACdE,EAAe,EAGjB,MAAMN,EAAQJ,GAAe5X,EAASqY,EAAaC,GACnD,IAAKN,EACH,OAAO,KAGThY,EAAUgY,CACZ,CAEA,OAAOhY,CACT,CAcWyY,CAAoBf,EAAO9P,EAYpC,CAXE,MAAOxgB,GACP,OAAOjJ,SAASu6B,SACd,IAAMhB,EACN9P,EAIA,KACA+Q,YAAYC,wBACZ,MACAC,eACJ,CACF,CC5JO,MAAMC,GAKXx3B,YAAYsmB,EAAMpD,GAChBhjB,KAAKomB,KAAOA,EACZpmB,KAAKgjB,MAAQA,CACf,CAMAwC,iBAAiBY,EAAMpD,GACrB,OAAO,IAAIsU,GAAYlR,EAAMpD,EAC/B,CAQAwC,oBAAoBY,EAAMmR,GACxB,MAAMhU,EAAiBkT,GAAcc,EAAShU,eAAgB6C,GAC9D,IAAK7C,EACH,MAAM,IAAIpgB,MAAM,0CAGlB,MAAMqgB,EAAeiT,GAAcc,EAAS/T,aAAc4C,GAC1D,IAAK5C,EACH,MAAM,IAAIrgB,MAAM,wCAGlB,MAAMq0B,EAAWvS,GAAawS,eAC5BlU,EACAgU,EAASrR,aAELwR,EAASzS,GAAawS,eAC1BjU,EACA+T,EAASpR,WAGLnD,EAAQ,IAAI2C,GAAU6R,EAAUE,GAAQ7R,UAC9C,OAAO,IAAIyR,GAAYlR,EAAMpD,EAC/B,CAEA6C,UACE,OAAO7lB,KAAKgjB,KACd,CAKA2U,aAGE,MAAMC,EAAkBjS,GAAUgB,UAAU3mB,KAAKgjB,OAAO6C,UAElDgS,EAAYlS,GAAUgB,UAAUiR,GAChCrU,EAAiB0S,GAAc4B,EAAU7tB,MAAMwU,QAASxe,KAAKomB,MAC7D5C,EAAeyS,GAAc4B,EAAUjS,IAAIpH,QAASxe,KAAKomB,MAE/D,MAAO,CACLrpB,KAAM,gBACNwmB,iBACA2C,YAAa2R,EAAU7tB,MAAMia,OAC7BT,eACA2C,UAAW0R,EAAUjS,IAAI3B,OAE7B,EAMK,MAAM6T,GAMXh4B,YAAYsmB,EAAMpc,EAAO4b,GACvB5lB,KAAKomB,KAAOA,EACZpmB,KAAKgK,MAAQA,EACbhK,KAAK4lB,IAAMA,CACb,CAMAJ,iBAAiBY,EAAMpD;AACrB,MAAM6U,EAAYlS,GAAUgB,UAAU3D,GAAOkC,WAAWkB,GACxD,OAAO,IAAI0R,GACT1R,EACAyR,EAAU7tB,MAAMia,OAChB4T,EAAUjS,IAAI3B,OAElB,CAKAuB,oBAAoBY,EAAMmR,GACxB,OAAO,IAAIO,GAAmB1R,EAAMmR,EAASvtB,MAAOutB,EAAS3R,IAC/D,CAKA+R,aACE,MAAO,CACL56B,KAAM,uBACNiN,MAAOhK,KAAKgK,MACZ4b,IAAK5lB,KAAK4lB,IAEd,CAEAC,UACE,OAAOF,GAAUoS,YAAY/3B,KAAKomB,KAAMpmB,KAAKgK,MAAOhK,KAAK4lB,KAAKC,SAChE,EAWK,MAAMmS,GAQXl4B,YAAYsmB,EAAM6R,EAAOhyB,EAAU,CAAA,GACjCjG,KAAKomB,KAAOA,EACZpmB,KAAKi4B,MAAQA,EACbj4B,KAAKiG,QAAUA,CACjB,CAUAuf,iBAAiBY,EAAMpD,GACrB,MAAMnnB,EAA8BuqB,EAAK5a,YACnCqsB,EAAYlS,GAAUgB,UAAU3D,GAAOkC,WAAWkB,GAElDpc,EAAQ6tB,EAAU7tB,MAAMia,OACxB2B,EAAMiS,EAAUjS,IAAI3B,OAa1B,OAAO,IAAI+T,GAAgB5R,EAAMvqB,EAAKmJ,MAAMgF,EAAO4b,GAAM,CACvDuP,OAAQt5B,EAAKmJ,MAAM+b,KAAKM,IAAI,EAAGrX,EAHd,IAGmCA,GACpDqrB,OAAQx5B,EAAKmJ,MAAM4gB,EAAK7E,KAAKC,IAAInlB,EAAKuF,OAAQwkB,EAJ7B,MAMrB,CAMAJ,oBAAoBY,EAAMmR,GACxB,MAAMpC,OAAEA,EAAME,OAAEA,GAAWkC,EAC3B,OAAO,IAAIS,GAAgB5R,EAAMmR,EAASU,MAAO,CAAE9C,SAAQE,UAC7D,CAKAsC,aACE,MAAO,CACL56B,KAAM,oBACNk7B,MAAOj4B,KAAKi4B,MACZ9C,OAAQn1B,KAAKiG,QAAQkvB,OACrBE,OAAQr1B,KAAKiG,QAAQovB,OAEzB,CAKAxP,QAAQvlB,EAAU,IAChB,OAAON,KAAKk4B,iBAAiB53B,GAASulB,SACxC,CAKAqS,iBAAiB53B,EAAU,IACzB,MACM4I,EAAQ4rB,GADsB90B,KAAKomB,KAAK5a,YACfxL,KAAKi4B,MAAO,IACtCj4B,KAAKiG,QACRsvB,KAAMj1B,EAAQi1B,OAEhB,IAAKrsB,EACH,MAAM,IAAI/F,MAAM;CAElB,OAAO,IAAI20B,GAAmB93B,KAAKomB,KAAMld,EAAMc,MAAOd,EAAM0c,IAC9D,ECtOF3iB,eAAegJ,GACbksB,EACA73B,GAEA,OAAO63B,EAAOtS,QAAQvlB,EACxB,CCFA,SAAS83B,GAAazsB,EAAQhD,EAAQL,GACpC,MAAM+vB,EAAc1sB,EAAOhD,GAG3B,GAA2B,mBAAhB0vB,EACT,MAAM,IAAIl1B,MAAM,gCAWlB,OAFAwI,EAAOhD,GALS2vB,IAAIlwB,KAClB,MAAMwtB,EAASyC,EAAYpzB,KAAK0G,KAAWvD,GAE3C,OADAE,KAAWF,GACJwtB,CAAM,EAIR,KACLjqB,EAAOhD,GAAU0vB,CAAW,CAEhC,CAGA,SAASE,GAAcx8B,GACrB,OAAOA,EAAIyX,QAAQ,MAAO,GAC5B,CAsCO,MAAMglB,GASX14B,YACE24B,EAEAC,EAAcA,KAAM5rB,SAASZ,OAE7BlM,KAAKC,WAAa,IAAIJ,EAEtB,IAAI84B,EAAUD,IACd,MAAME,EAAoBA,CAACC,EAASH,OAC9BH,GAAcI,KAAaJ,GAAcM,KAC3CF,EAAUE,EACVJ,EAAWI,GACb,EAGIC,EAnDH,WACL,MAAMA,EAAiCz6B,OAAQy6B,WAC/C,MAEwB,mBAAfC,YAEPD,aAAsBC,WAEfD,EAEF,IACT,CAwCuBE,GACnB,GAAIF,EACF94B,KAAKC,WAAW5C,IAAIy7B,EAAY,mBAAmB,IACjDF,UAEG,CACL,MAAMK,EAAa,CACjBb,GAAa/5B,OAAO66B,QAAS,aAAa,IAAMN,MAChDR,GAAa/5B,OAAO66B,QAAS,gBAAgB,IAAMN,OAErD54B,KAAKm5B,gBAAkB,IAAMF,EAAWn4B,SAAQs4B,GAAWA,MAC3Dp5B,KAAKC,WAAW5C,IAAIgB,OAAQ,YAAY,IAAMu6B,KAChD,CACF,CAGAS,aAAa,IAAAC,EACS,QAApBA,EAAIt5B,KAACm5B,uBAAe,IAAAG,GAApBA,EAAAr0B,KAAAjF,MACAA,KAAKC,WAAWY,WAClB,ECxHF,IAAI04B,GAAW,WACXC,GAAW,WAUf,SAASC,GAAiBjb,EAASjM,EAAGC,GAI/BgM,EAAQ9Z,OAAS8Z,EAChBA,EAAQkb,SAASnnB,EAAGC,IAEpBgM,EAAQmb,WAAapnB,EACrBiM,EAAQob,UAAYpnB,EAE5B,CAyDA,SAASqnB,GAAQlwB;AACb,IAAImwB,EAAiBnwB,EAAOowB,gBAE5B,GAAID,EAAJ,CAIA,IAAIE,EAA2BF,EAAeE,yBAE1CltB,EAhER,SAAiCgtB,EAAgBnwB,GAC7C,IAGIswB,EACA1nB,EACAC,EACA0nB,EACAC,EACAC,EACAC,EATAC,EAAQR,EAAeQ,MAEvBC,EADST,EAAe37B,OACAwiB,wBAQxB6Z,EAAYF,GAAuB,MAAdA,EAAMnb,KAAemb,EAAMnb,KAAO,GACvDsb,EAAWH,GAAsB,MAAbA,EAAMpb,IAAcob,EAAMpb,IAAM,GACpDwb,EAAaJ,GAA6B,MAApBA,EAAMI,WAAqBJ,EAAMI,WAAa,EACpEC,EAAYL,GAA4B,MAAnBA,EAAMK,UAAoBL,EAAMK,UAAY,EACjEC,EAAaJ,EACbK,EAAYJ,EAEhB,GAAGX,EAAegB,SAASnxB,GACvBywB,EAAcrZ,KAAKC,IAAIuZ,EAAevhB,MAAOrP,EAAO2X,YACpD+Y,EAAetZ,KAAKC,IAAIuZ,EAAethB,OAAQtP,EAAOyX,aACtD7O,EAAIgoB,EAAepb,KAAOxV,EAAOoxB,YAAcpxB,EAAO2X,WAAasZ,EAAaR,EAAcQ,EAC9FpoB,EAAI+nB,EAAerb,IAAMvV,EAAOqxB,YAAcrxB,EAAOyX,YAAcyZ,EAAYR,EAAeQ,EAC9FtoB,GAAKmoB,EACLloB,GAAKmoB,EACLpoB,EAAIunB,EAAeQ,MAAMW,MAAQtxB,EAAOoxB,YAAcxoB,EACtDC,EAAIsnB,EAAeQ,MAAMY,MAAQvxB,EAAOqxB,YAAcxoB,EACtD0nB,EAAc3nB,EAAI5I,EAAOoxB,YACzBZ,EAAc3nB,EAAI7I,EAAOqxB,gBACxB,CACDZ,EAAcG,EAAevhB,MAC7BqhB,EAAeE,EAAethB,OAC9BghB,EAAiBtwB,EAAOgX,wBACxB,IAAIwa,EAAaZ,EAAepb,MAAQ8a,EAAe9a,KAAOxV,EAAOgwB,YACjEjI,EAAY6I,EAAerb,KAAO+a,EAAe/a,IAAMvV,EAAOiwB,WAClErnB,EAAI4oB,EAAcf,EAAcQ,EAAcjxB,EAAOyxB,YAAcR,EACnEpoB,EAAIkf,EAAa2I,EAAeQ,EAAalxB,EAAO0xB,aAAeR,EACnEtoB,GAAKmoB,EACLloB,GAAKmoB,EACLpoB,EAAIwO,KAAKM,IAAIN,KAAKC,IAAIzO,EAAG5I,EAAO2xB,YAAc3xB,EAAOyxB,aAAc,GACnE5oB,EAAIuO,KAAKM,IAAIN,KAAKC,IAAIxO,EAAG7I,EAAO4xB,aAAe5xB,EAAO0xB,cAAe,GACrE9oB,EAAIunB,EAAeQ,MAAMW,MAAQtxB,EAAOgwB,WAAapnB,EACrDC,EAAIsnB,EAAeQ,MAAMY,MAAQvxB,EAAOiwB,UAAYpnB,EACpD0nB,EAAc3nB,EAAI5I,EAAOgwB,WACzBQ,EAAc3nB,EAAI7I,EAAOiwB,SAC5B,CAED,MAAO,CACHrnB,EAAGA,EACHC,EAAGA,EACH0nB,YAAaA,EACbC,YAAaA;AAErB,CAWmBqB,CAAwB1B,EAAgBnwB,GACnDpN,EAAOk/B,KAAKC,MAAQ5B,EAAe6B,UACnCC,EAAY7a,KAAKC,IAAI,EAAI8Y,EAAev9B,KAAOA,EAAM,GAEzD,GAAGu9B,EAAe+B,eAAiB7B,EAG/B,OAFAP,GAAiB9vB,EAAQmD,EAASyF,EAAGzF,EAAS0F,GAC9C7I,EAAOowB,gBAAkB,KAClBD,EAAelU,IAAI2T,IAG9B,IAAIuC,EAAY,EAAIhC,EAAeiC,KAAKH,GAOxC,GALAnC,GAAiB9vB,EACbmD,EAASyF,EAAIzF,EAASotB,YAAc4B,EACpChvB,EAAS0F,EAAI1F,EAASqtB,YAAc2B,GAGrCv/B,GAAQu9B,EAAev9B,KAKtB,OAJAu9B,EAAe+B,gBAEf/B,EAAekC,gBAAkBnC,GAAQC,EAAekC,qBACxDnC,GAAQlwB,IAzGhB,SAAasyB,GACT,GAAG,0BAA2B59B,OAC1B,OAAOA,OAAO4Y,sBAAsBglB,GAGxC19B,WAAW09B,EAAM,GACrB,CAuGIC,CAAIrC,GAAQljB,KAAK,KAAMhN,GA7BtB,CA8BL,CAEA,SAASwyB,GAAgBh+B,GACrB,OAAOA,EAAOuG,OAASvG,CAC3B,CA+DA,SAASi+B,GAAoB5d,GACzB,MACI,gBAAiBA,IAEbA,EAAQ+c,eAAiB/c,EAAQ6c,cACjC7c,EAAQ8c,cAAgB9c,EAAQ4c,cAEG,WAAvC1Z,iBAAiBlD,GAAS6d,QAElC,CAEA,SAASC,KACL,OAAO,CACX,CAEA,SAASC,GAAkB7/B,GACvB,GAAIA,EAAG8/B,aACH,OAAOD,GAAkB7/B,EAAG8/B,cAGhC,GAAI9/B,EAAGqlB,cACH,MAA8C,SAA3CrlB,EAAGqlB,cAAc/kB,QAAQ+B,cACjBrC,EAAGqlB,cAAc1C,cAAcC,aAAe5iB,EAAGqlB,cAAc1C,cAAcod,YAEjF//B,EAAGqlB,cAGd,GAAIrlB,EAAG2oB,YAAY,CACf,IAAI1b,EAASjN,EAAG2oB,cAChB,GAAuB,KAApB1b,EAAO3K,SACN,OAAO2K,EAAOxK,IAErB,CACL,CAEA,IAAAu9B,GAAiB,SAASv+B,EAAQmN,EAAUjH,GACxC,GAAIlG,EAAJ,CAIuB,mBAAbmN,IACNjH,EAAWiH,EACXA,EAAW,MAGXA,IACAA,EAAW,CAAA,GAGfA,EAAS/O,KAAOyO,MAAMM,EAAS/O,MAAQ,IAAO+O,EAAS/O;AACvD+O,EAASywB,KAAOzwB,EAASywB,MAAQ,SAASvrB,GAAG,OAAO,EAAIuQ,KAAK4b,IAAI,EAAInsB,EAAGA,EAAI,EAAG,EAC/ElF,EAASgvB,MAAQhvB,EAASgvB,OAAS,CAAA,EAEnC,IAAI3wB,EAAS4yB,GAAkBp+B,GAC3By+B,EAAU,EASVC,EAAcvxB,EAASuxB,aAAeP,GACtCQ,EAAexxB,EAASwxB,aAEzBxxB,EAASyxB,QACR12B,QAAQ22B,IAAI,qBAAsB7+B,GAE9BwL,GACAtD,QAAQ7G,MAAM,4DAMtB,IAFA,IAAIy9B,EAAoB,GAElBtzB,GAYF,GAXG2B,EAASyxB,OACR12B,QAAQ22B,IAAI,wBAAyBrzB,GAGtCkzB,EAAYlzB,EAAQizB,KAAaE,EAAeA,EAAanzB,EAAQyyB,IAAuBA,GAAoBzyB,MAC/GizB,IACAK,EAAkB14B,KAAKoF,MAG3BA,EAAS4yB,GAAkB5yB,IAEhB,CACPuzB,EAAK3D,IACL,KACH,CAGL,OAAO0D,EAAkBzR,QAAO,CAAC2R,EAAQxzB,EAAQ0sB,IA3JrD,SAA4Bl4B,EAAQwL,EAAQ2B,EAAU0wB,EAAgB33B,GAClE,IAGI+4B,EAHAC,GAAQ1zB,EAAOowB,gBACfuD,EAAe3zB,EAAOowB,gBACtB2B,EAAMD,KAAKC,MAEX6B,EAAiB,CAAE7e,SAAS,GAMhC,SAASkH,EAAI4X,GACT7zB,EAAOowB,gBAAkB,KAEtBpwB,EAAOoY,eAAiBpY,EAAOoY,cAAcgY,iBAC5CpwB,EAAOoY,cAAcgY,gBAAgBnU,IAAI4X,GAG1ClyB,EAASyxB,OACR12B,QAAQ22B,IAAI,4BAA6BQ,EAAS,MAAO7zB,GAG7DtF,EAASm5B,GACNJ,IACCzzB,EAAO7K,oBAAoB,aAAcs+B,EAAeG,GACxD5zB,EAAO7K,oBAAoB,QAASs+B,EAAeG,GAE1D,CApBED,GACCA,EAAa1X,IAAI4T,IAqBrB,IAAIQ,EAA2B1uB,EAAS0uB,yBA6BxC,OA3B+B,MAA5BA,IACCA,EAA2B,GAG/BrwB,EAAOowB,gBAAkB,CACrB4B,UAAWD,EACXG,cAAe,EACf19B,OAAQA,EACR5B,KAAM+O,EAAS/O,KACfw/B,KAAMzwB,EAASywB,KACfzB,MAAOhvB,EAASgvB,MAChBQ,SAAUxvB,EAASwvB,UAAYqB,GAC/BnC,yBAA0BA,EAC1BpU,IAAKA,EACLoW;AAGC,gBAAiB1wB,IAAaA,EAASmyB,cACxCL,EAAgBxX,EAAIjP,KAAK,KAAM6iB,IAC/B7vB,EAAOhL,iBAAiB,aAAcy+B,EAAeG,GACrD5zB,EAAOhL,iBAAiB,QAASy+B,EAAeG,IAGjDF,GACCxD,GAAQlwB,GAGLyzB,CACX,CAgG+DM,CAAmBv/B,EAAQwL,EAAQ2B,EAAU2xB,EAAkB5G,EAAQ,GAAI6G,IAAO,KAxD5I,CAkBD,SAASA,EAAKM,KACVZ,GAEIv4B,GAAYA,EAASm5B,EAE5B,CAkCL,ECjQA,SAASG,GAAYrtB,EAAGmB,EAAGmsB,GACzB,OAAOttB,EAAIstB,GAAYnsB,EAAInB,EAC7B,CA4BOrN,eAAe46B,GACpBrf,EACAyF,GAEA6Z,YAAEA,EAAc,KAAQ,IAExB,MAAM5X,EAAc1H,EAAQob,UACtBzT,EAAYlC,EACZ8Z,EAActC,KAAKC,MAKnBsC,EAAiBjd,KAAKC,IAC1BD,KAAKyU,IAAIrP,EAAYD,GAFH,EAGlB4X,GAGF,IAAIG,EAAiB,EACrB,KAAOA,EAAiB,SA7DjB,IAAI56B,SAAQC,IACjB2T,sBAAsB3T,EAAQ,IA8D9B26B,EAAiBld,KAAKC,IAAI,GAAMya,KAAKC,MAAQqC,GAAeC,GAC5Dxf,EAAQob,UAAY+D,GAAYzX,EAAaC,EAAW8X,EAE5D,CC/DO,SAASC,GAAaC,EAAKvsB,EAAOjV,SAASyhC,SAOhD,OANe,IAAIC,IAAIF,EAAKvsB,GAAM1F,KAMpB/K,WAAWqS,QAAQ,MAAO,GAC1C,CCqBO,MAAM8qB,GAGXx+B,YAAYQ,EAAmC,IAAIP,EAAAC,KAAA,gBAAA,GACjDA,KAAKrD,SAAW2D,EAAQ3D,UAAYA,QACtC,CAKAwhC,MACE,IAAIA,EAAMzwB,mBAAmB1N,KAAKu+B,oBAGlC,MAAMC,EAAQx+B,KAAKy+B,YACnB,IAAK,MAAMzyB,KAAQwyB,EACA,cAAbxyB,EAAKD,MACPoyB,EAAMnyB,EAAKE,MAIf,OAAOiyB,CACT,CAKAO,sBACE,MAAMC,EAAiC,CACrCjjB,MAAO/e,SAAS+e,MAChB1P,KAAM,GAEN4yB,GAAI5+B,KAAK6+B,aAAa,OAAQ,OAC9BC,QAAS9+B,KAAK6+B,aAAa,OAAQ,YACnCE,SAAU/+B,KAAK6+B,aAAa,WAAY,OACxCG,SAAUh/B,KAAK6+B,aAAa,OAAQ;AACpCI,MAAOj/B,KAAK6+B,aAAa,OAAQ,UACjCK,QAASl/B,KAAK6+B,aAAa,OAAQ,aAG/BM,EAAUn/B,KAAKo/B,cACjBD,IACFR,EAASQ,QAAUA,GAGrBR,EAASjjB,MAAQ1b,KAAKq/B,UAAUV,GAChCA,EAAS3yB,KAAOhM,KAAKy+B,UAAUE,GAE/B,MAAMW,EAASX,EAAS3yB,KAAKnE,MAAKmE,GAAQA,EAAKE,KAAK0D,WAAW,cAK/D,OAJI0vB,IACFX,EAASY,oBAAsBD,EAAOpzB,MAGjCyyB,CACT,CAQQE,aACNW,EACArK,GAEA,MAAMsK,EAAiC,CAAA,EACvC,IAAK,MAAMnoB,KAAQ3V,MAAMC,KAAK5B,KAAKrD,SAAS0O,iBAAiB,SAAU,CACrE,MAAMjH,EAAOkT,EAAK2T,aAAauU,IACzBE,QAAEA,GAAYpoB,EACpB,GAAIlT,GAAQs7B,EAAS,CACnB,MAAMx2B,EAAQ9E,EAAK8E,MAAMy2B,OAAQ,IAAGxK,SAAe,MACnD,GAAIjsB,EAAO,CACT,MAAM8F,EAAM9F,EAAM,GAAGnK,cACjB0gC,EAAKzwB,GACPywB,EAAKzwB,GAAKzK,KAAKm7B,GAEfD,EAAKzwB,GAAO,CAAC0wB,EAEjB,CACF,CACF,CACA,OAAOD,CACT,CAEQJ,UAAUV,GAChB,OAAIA,EAASK,SAAStjB,MACbijB,EAASK,SAAStjB,MAAM,GACtBijB,EAASG,QAAQpjB,MACnBijB,EAASG,QAAQpjB,MAAM,GACrBijB,EAASM,MAAMvjB,MACjBijB,EAASM,MAAMvjB,MAAM,GACnBijB,EAASI,SAASrjB,MACpBijB,EAASI,SAASrjB,MAAM,GACtBijB,EAASO,QAAQxjB,MACnBijB,EAASO,QAAQxjB,MAAM,GACrBijB,EAASC,GAAGljB,MACdijB,EAASC,GAAGljB,MAAM,GAElB1b,KAAKrD,SAAS+e,KAEzB,CAOQ+iB,UACNE,EAA0D,CACxDC,GAAI,CAAE,EACNI,SAAU,CAAC,IAGb,MAAMR,EAAgB,CAAC,CAAEtyB,KAAMlM,KAAKu+B,qBAG9BqB,EAAej+B,MAAMC,KAAK5B,KAAKrD,SAAS0O,iBAAiB,SAC/D,IAAK,MAAMW,KAAQ4zB,EACjB,GACG,CAAC,YAAa,YAAa,WAAY,aAAanlB,SAASzO,EAAKD,KADrE,CAMA,GAAiB,cAAbC,EAAKD,IAAqB;AAE5B,GAAIC,EAAKjP,MAAQiP,EAAKjP,KAAKmM,MAAM,iCAC/B,SAGF,GAAI8C,EAAK6zB,SACP,QAEJ,CAEA,IACE,MAAM3zB,EAAOlM,KAAK8/B,aAAa9zB,EAAKE,MACpCsyB,EAAMj6B,KAAK,CAAE2H,OAAMH,IAAKC,EAAKD,IAAKhP,KAAMiP,EAAKjP,MAE7C,CADA,MAAOa,GACP,CAjBF,CAsBF,IAAK,MAAMwG,KAAQ9B,OAAOC,KAAKo8B,EAASK,UAAW,CACjD,MAAM1vB,EAASqvB,EAASK,SAAS56B,GACjC,GAAa,YAATA,EACF,IAAK,MAAMrI,KAAOuT,EAChB,IACEkvB,EAAMj6B,KAAK,CACT2H,KAAMlM,KAAK8/B,aAAa/jC,GACxBgB,KAAM,mBAGR,CADA,MAAOa,GACP,CAQN,GAAa,QAATwG,EACF,IAAK,IAAI27B,KAAOzwB,EACU,SAApBywB,EAAI/6B,MAAM,EAAG,KACf+6B,EAAO,OAAMA,KAEfvB,EAAMj6B,KAAK,CAAE2H,KAAM6zB,GAGzB,CAGA,IAAK,MAAM37B,KAAQ9B,OAAOC,KAAKo8B,EAASC,IAAK,CAC3C,MAAMtvB,EAASqvB,EAASC,GAAGx6B,GAC3B,GAAa,eAATA,EACF,IAAK,MAAMyrB,KAAMvgB,EACQ,SAAnBugB,EAAG7qB,MAAM,EAAG,IACdw5B,EAAMj6B,KAAK,CAAE2H,KAAM2jB,GAI3B,CAGA,MAAMmQ,EAAmBrB,EAASC,GAAG,qBAC/BqB,EAAqBtB,EAASC,GAAGsB,WACvC,GAAIF,GAAoBC,EAAoB,CAC1C,MAAME,EACJH,EAAiBA,EAAiB5+B,OAAS,GACvCg/B,EACJH,EAAmBA,EAAmB7+B,OAAS,GAC3Ci/B,EACJ,YACAC,mBAAmBH,GACnB,IACAG,mBAAmBF,GACrB5B,EAAMj6B,KAAK,CAAE2H,KAAMm0B,GACrB,CAEA,OAAO7B,CACT,CAEQY,cACN,IAAID,EAAU,KACd,IAAK,MAAMnzB,KAAQrK,MAAMC,KAAK5B,KAAKrD,SAAS0O,iBAAiB,SAC3D,GAAI,CAAC,gBAAiB,QAAQoP,SAASzO,EAAKD,KAC1C,IACEozB,EAAUn/B,KAAK8/B,aAAa9zB,EAAKE,KAEjC,CADA,MAAOtO,GACP,CAIN,OAAOuhC,CACT,CAMQW,aAAa/jC,GACnB,OAAOmiC,GAAaniC,EAAKiE,KAAKrD,SAASyhC,QACzC,CAOQG;AACN,MAAMryB,KAAEA,GAASlM,KAAKrD,SAASmQ,SACzByzB,EAAiB,CAAC,QAAS,SAAU,SAGrCC,EAAS,IAAInC,IAAInyB,GAAMrD,SAC7B,OAAI03B,EAAe9lB,SAAS+lB,GACnBt0B,EAKPlM,KAAKrD,SAASyhC,SACdmC,EAAe9lB,SAAS,IAAI4jB,IAAIr+B,KAAKrD,SAASyhC,SAASv1B,UAEhD7I,KAAKrD,SAASyhC,QAKhBlyB,CACT,EChRK,SAASu0B,GAAYnW,GAC1B,OAAOA,EAAKtR,OAAS,GAAKsR,EAAKrR,QAAU,CAC3C,CAaA,SAASynB,GAAapwB,EAAWmB,EAAWrB,EAAWqC,GAGrD,OAFiBsO,KAAKM,IAAI/Q,EAAGF,GACd2Q,KAAKC,IAAIvP,EAAGgB,EAE7B,CAKO,SAASkuB,GAAeC,EAAgBC,GAC7C,OAAIJ,GAAYG,KAAUH,GAAYI,KAKpCH,GAAaE,EAAMzhB,KAAMyhB,EAAMjV,MAAOkV,EAAM1hB,KAAM0hB,EAAMlV,QACxD+U,GAAaE,EAAM1hB,IAAK0hB,EAAMlV,OAAQmV,EAAM3hB,IAAK2hB,EAAMnV,QAE3D,CAqBO,SAASoV,GAAuBxwB,EAAYmB,GACjD,OAAOivB,GAAapwB,EAAE4O,IAAK5O,EAAEob,OAAQja,EAAEyN,IAAKzN,EAAEia,OAChD,CAKO,SAASqV,GAAyBzwB,EAAYmB,GACnD,OAAOivB,GAAapwB,EAAE6O,KAAM7O,EAAEqb,MAAOla,EAAE0N,KAAM1N,EAAEka,MACjD,CASO,SAASqV,GAAW1wB,EAAYmB,GACrC,GAAIgvB,GAAYnwB,GACd,OAAOmB,EACF,GAAIgvB,GAAYhvB,GACrB,OAAOnB,EAGT,MAAM6O,EAAO4B,KAAKC,IAAI1Q,EAAE6O,KAAM1N,EAAE0N,MAC1BD,EAAM6B,KAAKC,IAAI1Q,EAAE4O,IAAKzN,EAAEyN,KACxByM,EAAQ5K,KAAKM,IAAI/Q,EAAEqb,MAAOla,EAAEka,OAC5BD,EAAS3K,KAAKM,IAAI/Q,EAAEob,OAAQja,EAAEia,QAEpC,OAAO,IAAIuV,QAAQ9hB,EAAMD,EAAKyM,EAAQxM,EAAMuM,EAASxM,EACvD,CAKO,SAASgiB,GAAW5W,GACzB,OAAO,IAAI6W,UACR7W,EAAKnL,KAAOmL,EAAKqB,OAAS,GAC1BrB,EAAKpL,IAAMoL,EAAKoB,QAAU,EAE/B,CC1GA,MAAM0V,GAAmB,CACvB,IAGA,SAgEF,IAAIC,GAKJ,SAASC,GAASzlC,EAAYmO,EAAQ,EAAG4b,EAAc/pB,EAAKmG,KAAKZ,QAQ/D,OAPKigC,KAGHA,GAAgB1kC,SAAS0rB,eAE3BgZ,GAAcrb,SAASnqB,EAAMmO,GAC7Bq3B,GAAcpb,OAAOpqB,EAAM+pB,GACpByb,GAAc1gB,uBACvB,CAiBA,SAAS4gB,GAAmB/iB,GAC1B,MAAM8L,EAAO9L,EAAQmC;CAKrB,OAJA2J,EAAK/X,GAAKiM,EAAQmb,WAClBrP,EAAK9X,GAAKgM,EAAQob,UAClBtP,EAAKrR,OAAS8H,KAAKM,IAAIiJ,EAAKrR,OAAQuF,EAAQ+c,cAC5CjR,EAAKtR,MAAQ+H,KAAKM,IAAIiJ,EAAKtR,MAAOwF,EAAQ8c,aACnChR,CACT,CAOA,SAAUkX,GACRpb,EACAkE,EACAmX,GAEA,IAAIzd,EAAoBoC,EAAKnQ,WAC7B,KAAO+N,GAAM,CACX,GAAI+C,GAAc/C,GAAO,CACvB,MAAM0d,EAAwBf,GAC5BY,GAAmBvd,GACnBsG,GAIEmX,EAAYzd,IAAS0d,UAChBF,GAAgBxd,EAAMsG,EAAMmX,GAEvC,MAAWza,GAAWhD,IAEhB2c,GAAeW,GAAStd,GAAOsG,WAC3BtG,GAGVA,EAAOA,EAAKnR,WACd,CACF,CAQA,SAAS8uB,GAAgBvb,EAAewb,GAGtC,IAAIC,EAA4B,KAOhC,MAAMJ,EAAe/kC,IAxEvB,SAA0B8hB,GACxB,OAAQkD,iBAAiBlD,GAASS,UAChC,IAAK,QACL,IAAK,SACH,OAAO,EACT,QACE,OAAO,EAEb,CAgEwC6iB,CAAiBplC,GAEvDqlC,EAAc,IAAK,MAAMhd,KAAYyc,GACnCpb,EACAwb,EACAH,GACC,CACD,IAAIO,EAAU,EAGd,IAAK,MAAMC,KAAQld,EAAS/iB,KAAK0V,MAAM,MAAO,CAC5C,GAAI,KAAKtE,KAAK6uB,GAAO,CACnB,MAAMj4B,EAAQg4B,EACRpc,EAAMoc,EAAUC,EAAK7gC,OACrB8gC,EAAUZ,GAASvc,EAAU/a,EAAO4b,GAC1C,GD1HqCib,EC0HVqB,GDzH7BzB,GADuBG,EC0HJgB,KDzHGnB,GAAYI,IAKpCA,EAAM1hB,MAAQyhB,EAAMzhB,MACpB0hB,EAAMlV,OAASiV,EAAMjV,OACrBkV,EAAM3hB,KAAO0hB,EAAM1hB,KACnB2hB,EAAMnV,QAAUkV,EAAMlV,OCiHmB,CACnCmW,EAAcllC,SAAS0rB,cACvBwZ,EAAY7b,SAASjB,EAAU/a,GAC/B63B,EAAY5b,OAAOlB,EAAUa,GAC7B,MAAMmc,CACR,CACF,CAEAC,GAAWC,EAAK7gC,MAClB,CACF,CDpIK,IAAsBw/B,EAAgBC,ECsI3C,OAAOgB,CACT,CAeO,SAASM,GACd99B,EAEA+9B,EAAsBzlC,SAAS0C,gBAE/BuiC,EAAoB,IAAIX,QAAQ,EAAG,EAAG5iC,OAAOijB,WAAYjjB,OAAO+iB,cAEhE,MAAM+W,EAASwJ,GAAgBS,EAAYR,GAC3C,IAAKzJ,EAEH,OADA9zB,IACO,EAGT,MAAMg+B,EAAYlK,EAAOxX,wBAAwBzB,IACjD7a,IACA,MAIMi+B,EAJenK,EAAOxX,wBAAwBzB,IAIjBmjB,EAGnC,OAFAD,EAAWxI,WAAa0I,EAEjBA,CACT,CCvMO,MAAMC,WAAwB/8B;AAsBnC1F,aAAY2xB,SACVA,EAAQzT,UACRA,EAAYrhB,SAAS+5B,OAKrBhI,QAAQ3uB,EAAAC,KAAA,iBAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,iBAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,yBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAERA,KAAKyxB,SAAWA,EAChBzxB,KAAKge,UAAYA,EAEjBhe,KAAKwiC,UAAY,IAAIlE,GACrBt+B,KAAKyiC,SAAWziC,KAAKwiC,UAAUrE,MAE/Bn+B,KAAK0iC,mBAAqB1iC,KAAKyxB,SAASzC,YAAY,qBACpDhvB,KAAK2iC,mBAAoB,EACzB3iC,KAAK4iC,YAAc,KAGnB5iC,KAAK6iC,aAAe,IAAIrK,IAAmB,IAAMx4B,KAAK8iC,uBAItD9iC,KAAK+iC,cAAgB,IAAIC,kBAAiB,IAAMhjC,KAAK8iC,uBACrD9iC,KAAK+iC,cAAcE,QAAQtmC,SAASumC,KAAM,CACxCC,WAAW,EACXC,SAAS,EACT5tB,YAAY,EAEZ6tB,gBAAiB,CAEf,MACA,OAGA,OACA,aAIJrjC,KAAKsjC,cAAgB,KACnB,MAAMC,EAAa9R,EAASzC,YAAY,qBACpCuU,IAAevjC,KAAK0iC,qBACtB1iC,KAAK0iC,mBAAqBa,EAItBvjC,KAAK4iC,aACP5iC,KAAKwjC,cAAcxjC,KAAK4iC,aAE5B;AAEF5iC,KAAKyxB,SAASttB,GAAG,eAAgBnE,KAAKsjC,cACxC,CAEAnL,OAAO/R,EAAeqd,GACpB,ORhFG,SACLrd,EACAqd,EACAnjC,EAAmB,CAAA,GAEnB,IAAI2e,EAAwC,KACxC8V,EAAkC,KAClC/R,EAA8B,KAGlC,IAAK,MAAMuU,KAAYkM,EACrB,OAAQlM,EAASx6B,MACf,IAAK,uBACHkiB,EAAWsY,EACXj3B,EAAQi1B,KAAOtW,EAASjV,MACxB,MACF,IAAK,oBACH+qB,EAAQwC,EACR,MACF,IAAK,gBACHvU,EAAQuU,EAQd,MAAMmM,EAAoB1gB,IAAiB,IAAA2gB,EACzC,GAASA,QAALA,EAAA5O,aAAK4O,GAALA,EAAO1L,OAASjV,EAAM7hB,aAAe4zB,EAAMkD,MAC7C,MAAM,IAAI90B,MAAM,kBAEhB,OAAO6f,CACT,EAKF,IAAI4gB,EAA0BvgC,QAAQE,OAAO,oBAE7C,GAAIyf,EAAO,CAET,MAAM6gB,EAAS7gB,EACf4gB,EAAUA,EAAQE,OAAM,IAEf73B,GADQqrB,GAAYyM,aAAa3d,EAAMyd,GACjBvjC,GAASoW,KAAKgtB,IAE/C,CAEA,GAAIzkB,EAAU,CACZ,MAAM+kB,EAAY/kB,EAClB2kB,EAAUA,EAAQE,OAAM,IAEf73B,GADQ6rB,GAAmBiM,aAAa3d,EAAM4d,GACxB1jC,GAASoW,KAAKgtB,IAE/C,CAEA,GAAI3O,EAAO,CACT,MAAMkP,EAASlP,EACf6O,EAAUA,EAAQE,OAAM,IAEf73B,GADQ+rB,GAAgB+L,aAAa3d,EAAM6d,GACrB3jC,IAEjC,CAEA,OAAOsjC,CACT,CQcWzL,CAAO/R,EAAMqd,EACtB,CAEAS,SAAS9d,EAAepD,GACtB,ORhBG,SAAkBoD,EAAepD,GACtC,MAAMmhB,EAAQ,CAAC7M,GAAaQ,GAAoBE,IAC1CpC,EAAS,GACf,IAAK,MAAM74B,KAAQonC,EACjB,IACE,MAAMhM,EAASp7B,EAAK4pB,UAAUP,EAAMpD,GACpC4S,EAAOrxB,KAAK4zB,EAAOR,aAEnB,CADA,MAAOn4B,GACP,CAGJ,OAAOo2B,CACT,CQIWsO,CAAS9d,EAAMpD,EACxB,CAEA8f,qBACE,MAAMsB,EAAapkC,KAAKwiC,UAAUrE,MAC9BiG,IAAepkC,KAAKyiC,WACtBziC,KAAKyiC,SAAW2B,EAChBpkC,KAAK+E,KAAK,aAAcq/B,GAE5B,CAMAC,oBAAoBrhB,GAClB,IACE,OAAO2C,GAAUU,aAAarD,EAMhC,CALE,MAAOpd,GACP,GAAIA,aAAese,WACjB,OAAO,KAET,MAAMte,CACR,CACF;AAEA0+B,8BACE,OAAO,CACT,CAEAthC,UACEhD,KAAK6iC,aAAaxJ,aAClBr5B,KAAK+iC,cAAc1J,aACnBr5B,KAAKyxB,SAAS9sB,IAAI,eAAgB3E,KAAKsjC,cACzC,CAEAhW,mBACE,OAAOttB,KAAKge,SACd,CAEAwlB,cAAce,GACZvkC,KAAK4iC,YAAc2B,EAEnB,MAAMC,EAAoBnmC,OAAOijB,WAAaijB,EAAOvrB,MAC/C+B,EACJ/a,KAAK0iC,oBACL6B,EAAO/oB,UACPgpB,GA1IiB,IAoJnB,OARIzpB,EAGF/a,KAAKykC,oBAAoBF,EAAOvrB,OACvBhZ,KAAK2iC,mBACd3iC,KAAK0kC,wBAEP1kC,KAAK2iC,kBAAoB5nB,EAClBA,CACT,CAKA0pB,oBAAoBE,GAkClB,MACMC,EAAcD,EADJ,GAGVE,EAAqBrmB,GACzBrV,SAAS9K,OAAOqjB,iBAAiBlD,GAASsmB,WAAY,IAExD3C,IAAuB,KAKrBxlC,SAAS+5B,KAAKpjB,MAAMwxB,WAAa,GACjCnoC,SAAS+5B,KAAKpjB,MAAMyxB,YAAc,GAGlC,MAAMC,EAAiBH,EAAkBloC,SAAS+5B,MAElD/5B,SAAS+5B,KAAKpjB,MAAMyxB,YAAe,GAAEH,MAErC,MAAMK,EDlNL,SACL7e,GAGA,MAAM8e,EAAkB,IAAIhlC,IACtBilC,EAAmB,IAAIjlC,IAOvBklC,EAAkBhE,GAAiBt/B,KAAK,KACxCujC,EAAa1jC,MAAMC,KAAKwkB,EAAK/a,iBAAiB+5B,IACjDvjC,KAAI8O,IAII,CAAE2Z,KAFI3Z,EAAEgQ,wBAEA2kB,WADI30B,EAAEnF,YAAapK,WAGnC2V,QAAO,EAAGuT,UAEFA,EAAKtR,MAAQ,GAAKsR,EAAKrR,OAAS,IAGxCzW,MAAK,CAAC8N,EAAGmB,IAAMA,EAAE6zB,WAAah1B,EAAEg1B,aAChCtgC,MAAM,EAAG,IAeZ,GAXAqgC,EAAWvkC,SAAQ,EAAGwpB,WAAW,IAAAib,EAAAC;CAC/B,IAAIC,EAA0C,QAAjCF,EAAGL,EAAgBvkC,IAAI2pB,EAAKnL,aAAKomB,IAAAA,EAAAA,EAAI,EAClDE,GAAa,EACbP,EAAgBzkC,IAAI6pB,EAAKnL,KAAMsmB,GAE/B,IAAIC,EAA6C,QAAnCF,EAAGL,EAAiBxkC,IAAI2pB,EAAKqB,cAAM6Z,IAAAA,EAAAA,EAAI,EACrDE,GAAc,EACdP,EAAiB1kC,IAAI6pB,EAAKqB,MAAO+Z,EAAW,IAIjB,IAAzBR,EAAgB7pB,MAAwC,IAA1B8pB,EAAiB9pB,KACjD,OAAO,KAGT,MAAMsqB,EAAa,IAAIT,EAAgBnW,WAAWvsB,MAAK,CAAC8N,EAAGmB,IAAMA,EAAE,GAAKnB,EAAE,KACpEs0B,EAAc,IAAIO,EAAiBpW,WAAWvsB,MAClD,CAAC8N,EAAGmB,IAAMA,EAAE,GAAKnB,EAAE,MAGds1B,GAAWD,EAAW,IACtBE,GAAYjB,EAAY,GAE/B,MAAO,CAAEzlB,KAAMymB,EAASja,MAAOka,EACjC,CC4J0BC,CAAqBnpC,SAAS+5B,MAClD,GAAIuO,EAAa,CAGf,MAAMc,EAAYhlB,KAAKM,IACrB,EACAhjB,OAAOijB,WAAasjB,EAAcK,EAAYtZ,OAEhD,GAAIoa,EAAY,EAAG,CACjB,MAAMC,EAAiBjlB,KAAKM,IAAI,EAAGujB,EAAcmB,GACjDppC,SAAS+5B,KAAKpjB,MAAMyxB,YAAe,GAAEiB,KACvC,CAMsBnB,EAAkBloC,SAAS+5B,MAC7BsO,IAClBroC,SAAS+5B,KAAKpjB,MAAMwxB,WAAc,GAAEE,OAKlCC,EAAY9lB,KA3CJ,KA4CVxiB,SAAS+5B,KAAKpjB,MAAMwxB,WAAc,OAEtC,MACEnoC,SAAS+5B,KAAKpjB,MAAMwxB,WAAa,GACjCnoC,SAAS+5B,KAAKpjB,MAAMyxB,YAAc,EACpC,GAEJ,CAKAL,wBACEvC,IAAuB,KACrBxlC,SAAS+5B,KAAKpjB,MAAMwxB,WAAa,GACjCnoC,SAAS+5B,KAAKpjB,MAAMyxB,YAAc,EAAE,GAExC,CAEA9hC,oBACE,OAAOjD,KAAKwiC,UAAU9D,qBACxB,CAEAz7B,YACE,OAAOjD,KAAKwiC,UAAUrE,KACxB,CAEAl7B,qBAAqBk1B,GAAgB,IAAA8N,EACnC,MAAMtZ,EAA6B,QAApBsZ,EAAG9N,EAAO3O,kBAAU,IAAAyc,OAAA,EAAjBA,EAAoB,GACjCtZ,SL1MF1pB,eACLub,GAEAsf,YAAEA,EAAc,KAAQ,IAMxB,MAAMpH,EAAOlY,EAAQsI,QAAQ;CACzB4P,GAAyB,SAAjBA,EAAK15B,SACfsF,OAAO4jC,eAAexP,EAAM,UAAW,CACrC/rB,MAAO,OACPw7B,cAAc,UAIZ,IAAI9iC,SAAQC,GAChBo5B,GAAele,EAAS,CAAEjiB,KAAMuhC,GAAex6B,IAEnD,CKyLU8iC,CAAsBzZ,EAC9B,ECrRF,IASI0Z,GAAS,aAGTC,GAAa,qBAGbC,GAAa,aAGbC,GAAY,cAGZC,GAAet9B,SAGfu9B,GAA8B,iBAAVC,GAAsBA,GAAUA,EAAOrkC,SAAWA,QAAUqkC,EAGhFC,GAA0B,iBAARliC,MAAoBA,MAAQA,KAAKpC,SAAWA,QAAUoC,KAGxE0hB,GAAOsgB,IAAcE,IAAYC,SAAS,cAATA,GAUjCC,GAPcxkC,OAAO4B,UAOQ/C,SAG7B4lC,GAAYhmB,KAAKM,IACjB2lB,GAAYjmB,KAAKC,IAkBjB0a,GAAM,WACR,OAAOtV,GAAKqV,KAAKC,KACnB,EA2MA,SAASuL,GAASt8B,GAChB,IAAI5N,SAAc4N,EAClB,QAASA,IAAkB,UAAR5N,GAA4B,YAARA,EACzC,CA2EA,SAASmqC,GAASv8B,GAChB,GAAoB,iBAATA,EACT,OAAOA,EAET,GAhCF,SAAkBA,GAChB,MAAuB,iBAATA,GAtBhB,SAAsBA,GACpB,QAASA,GAAyB,iBAATA,CAC3B,CAqBKw8B,CAAax8B,IAzTF,mBAyTYm8B,GAAe7hC,KAAK0F,EAChD,CA6BMy8B,CAASz8B,GACX,OA3VM,IA6VR,GAAIs8B,GAASt8B,GAAQ,CACnB,IAAI08B,EAAgC,mBAAjB18B,EAAM28B,QAAwB38B,EAAM28B,UAAY38B,EACnEA,EAAQs8B,GAASI,GAAUA,EAAQ,GAAMA,CAC1C,CACD,GAAoB,iBAAT18B,EACT,OAAiB,IAAVA,EAAcA,GAASA,EAEhCA,EAAQA,EAAM6I,QAAQ6yB,GAAQ,IAC9B,IAAIkB,EAAWhB,GAAWnzB,KAAKzI,GAC/B,OAAQ48B,GAAYf,GAAUpzB,KAAKzI,GAC/B87B,GAAa97B,EAAM3F,MAAM,GAAIuiC,EAAW,EAAI,GAC3CjB,GAAWlzB,KAAKzI,GAxWb,KAwW6BA,CACvC,CAEA,IAAA68B,GAtPA,SAAkBC,EAAMC,EAAMpnC,GAC5B,IAAIqnC,EACAC,EACAC,EACAjS,EACAkS,EACAC,EACAC,EAAiB,EACjBC,GAAU,EACVC,GAAS,EACTC,GAAW;CAEf,GAAmB,mBAARV,EACT,MAAM,IAAIW,UArIQ,uBA+IpB,SAASC,EAAW9rC,GAClB,IAAI6L,EAAOu/B,EACPW,EAAUV,EAKd,OAHAD,EAAWC,OAAW7hC,EACtBiiC,EAAiBzrC,EACjBq5B,EAAS6R,EAAK7iC,MAAM0jC,EAASlgC,EAE9B,CAED,SAASmgC,EAAYhsC,GAMnB,OAJAyrC,EAAiBzrC,EAEjBurC,EAAUvpC,WAAWiqC,EAAcd,GAE5BO,EAAUI,EAAW9rC,GAAQq5B,CACrC,CAUD,SAAS6S,EAAalsC,GACpB,IAAImsC,EAAoBnsC,EAAOwrC,EAM/B,YAAyBhiC,IAAjBgiC,GAA+BW,GAAqBhB,GACzDgB,EAAoB,GAAOR,GANJ3rC,EAAOyrC,GAM8BH,CAChE,CAED,SAASW,IACP,IAAIjsC,EAAOm/B,KACX,GAAI+M,EAAalsC,GACf,OAAOosC,EAAapsC,GAGtBurC,EAAUvpC,WAAWiqC,EAzBvB,SAAuBjsC,GACrB,IAEIq5B,EAAS8R,GAFWnrC,EAAOwrC,GAI/B,OAAOG,EAASlB,GAAUpR,EAAQiS,GAHRtrC,EAAOyrC,IAGkCpS,CACpE,CAmBoCgT,CAAcrsC,GAClD,CAED,SAASosC,EAAapsC,GAKpB,OAJAurC,OAAU/hC,EAINoiC,GAAYR,EACPU,EAAW9rC,IAEpBorC,EAAWC,OAAW7hC,EACf6vB,EACR,CAcD,SAASiT,IACP,IAAItsC,EAAOm/B,KACPoN,EAAaL,EAAalsC,GAM9B,GAJAorC,EAAW9iC,UACX+iC,EAAW5nC,KACX+nC,EAAexrC,EAEXusC,EAAY,CACd,QAAgB/iC,IAAZ+hC,EACF,OAAOS,EAAYR,GAErB,GAAIG,EAGF,OADAJ,EAAUvpC,WAAWiqC,EAAcd,GAC5BW,EAAWN,EAErB,CAID,YAHgBhiC,IAAZ+hC,IACFA,EAAUvpC,WAAWiqC,EAAcd,IAE9B9R,CACR,CAGD,OAxGA8R,EAAOR,GAASQ,IAAS,EACrBT,GAAS3mC,KACX2nC,IAAY3nC,EAAQ2nC,QAEpBJ,GADAK,EAAS,YAAa5nC,GACHymC,GAAUG,GAAS5mC,EAAQunC,UAAY,EAAGH,GAAQG,EACrEM,EAAW,aAAc7nC,IAAYA,EAAQ6nC,SAAWA,GAiG1DU,EAAU1L,OAnCV,gBACkBp3B,IAAZ+hC,GACFxpC,aAAawpC,GAEfE,EAAiB,EACjBL,EAAWI,EAAeH,EAAWE,OAAU/hC,CAChD,EA8BD8iC,EAAUE,MA5BV,WACE,YAAmBhjC,IAAZ+hC,EAAwBlS,EAAS+S,EAAajN,KACtD,EA2BMmN,CACT,ECjPA,SAAS/kB,GAAQ5iB,EAAK8nC,EAAOjyB,EAAQygB,EAAW,GAC9C,IAAI1B,EAAM0B,EACV,KAAO1B,EAAM50B,EAAIE,QAAU4nC,EAAQ,GAC7BjyB,EAAO7V,EAAI40B,OACXkT,IAEFlT,EAEJ,OAAOA,CACT,CAUA,SAASmT,GAAW/nC,EAAK6V,EAAQygB,EAAUE,GACzC,IAAIsR,EAAQ,EACZ,IAAK,IAAIlT,EAAM0B,EAAU1B,EAAM4B,EAAQ5B,IACjC/e,EAAO7V,EAAI40B,OACXkT,EAGN,OAAOA,CACT,CAiCO,SAASE,GAAiB7Y,EAAO8Y,EAAQn/B,EAAO4b,EAAK7O,GAC1D,MAAMqyB,EAAmBH,GAAW5Y,EAAOtZ,EAAQ,EAAG/M,GAChDq/B,EAAkBJ,GAAW5Y,EAAOtZ,EAAQ/M,EAAO4b;CAKzD,IAAI0jB,EAAcxlB,GAAQqlB,EAAQC,EAAkBryB,GAIpD,KAAOuyB,EAAcH,EAAO/nC,SAAW2V,EAAOoyB,EAAOG,OACjDA,EAOJ,MAAO,CAACA,EAFUxlB,GAAQqlB,EAAQE,EAAiBtyB,EAAQuyB,GAG7D,CC1DO,MAAMC,GACF,EADEA,GAID,EAQNC,GAAgB,IAAItpC,IAUpBupC,GAAqB,IAAIvpC,IAO/B,SAASwpC,GAAsB3U,EAAee,GAC5C,MAAQ,GAAEf,KAASe,GACrB,CAiBA,SAAS6T,GAAiB3lB,GAAsC,IAAA4lB,EAC9D,MAAMltC,EAAK,YAAasnB,EAAOA,EAAOA,EAAKjC,cAC3C,OAAgC,QAAhC6nB,EAAOltC,eAAAA,EAAIoqB,QAAQ,qBAAa8iB,IAAAA,EAAAA,EAAI,IACtC,CAKA,SAASC,KAEP,OAAOC,qBAAqBC,SAC9B,CASA9mC,eAAe+mC,GAAYC,GACzB,MAAMF,EAAYF,KAClB,IAAIK,EAAWH,EAAUC,YAAYC,GA8BrC,OA5BKC,GAAaA,EAASC,UAQzBD,QAAiB,IAAI7mC,SAAQC,IAC3B,MAAM8mC,EAAgBA,KAChBL,EAAUM,SACZN,EAAUM,SAAS1lC,IAAI,cAAeylC,GAEtCztC,SAASmC,oBAAoB,cAAesrC,GAG9C9mC,EAAQymC,EAAUC,YAAYC,GAAW,EAGvCF,EAAUM,SACZN,EAAUM,SAASlmC,GAAG,cAAeimC,GAGrCztC,SAASgC,iBAAiB,cAAeyrC,EAC3C,KAIGF,CACT,CAyBA,SAASI,GAAmBL,GAG1B,MAAMM,EAAaf,GAAc7oC,IAAIspC,GACrC,GAAIM,EACF,OAAOA,EAGT,MAWMC,EAXcvnC,WAClB,MAAMinC,QAAiBF,GAAYC,GAKnC,aAJ0BC,EAASC,QAAQM,eAAe,CAExDC,qBAAqB,KAEJC,MAAM9oC,KAAI+oC,GAAMA,EAAG1pC,MAAKY,KAAK,GAAG,EAKpC+oC,GAEjB,OADArB,GAAc/oC,IAAIwpC,EAAWO,GACtBA,CACT,CAoCAvnC,eAAe6nC,GAAiB7mB,GAC9B,MAAM8mB,EAASlB,KAEf,IAAImB,EAAkB,EAClBC,EAAgB,EAChBpvC,EAAO,GAEX,IAAK,IAAIsJ,EAAI,EAAGA,EAAI4lC,EAAOG,WAAY/lC,IAKrC,GAJAtJ,QAAayuC,GAAmBnlC,GAChC6lC,EAAkBC,EAClBA,GAAiBpvC,EAAKuF,OAElB6pC,GAAiBhnB,EACnB,MAAO,CAAEoS,MAAOlxB,EAAG8e,OAAQ+mB,EAAiBnvC,QAMhD,MAAO;AAAEw6B,MAAO0U,EAAOG,WAAa,EAAGjnB,OAAQ+mB,EAAiBnvC,OAClE,CAQA,SAASsvC,GAAQC,GACf,OAAQA,GACN,IAAK,IACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,IACH,OAAO,EACT,QACE,OAAO,EAEb,CAEA,MAAMC,GAAcD,IAAkBD,GAAQC,GAe9CnoC,eAAeqoC,GACbrB,EACAjgC,EACA4b,GAEA,MAAO2lB,EAAMf,SAAkBnnC,QAAQmoC,IAAI,CACzCxB,GAAYC,GACZK,GAAmBL,KAGrB,GACEsB,EAAKE,iBAAmBlC,IACxBgC,EAAKG,WACLH,EAAKG,UAAUC,cACf,CAAA,IAAAC,EAOA,MAAMxlB,EAAkCwlB,QAA9BA,EAAGL,EAAKG,UAAUG,wBAAYD,EAAAA,EAAIL,EAAKG,UAAUI,IAC3D,IAAK1lB,EAEH,MAAM,IAAIjjB,MAAM,yCAGlB,MAAM4oC,EAAe3lB,EAAK5a,aAEnBwgC,EAAgBC,GAAgB/C,GACrCsB,EACAuB,EACA/hC,EACA4b,EACAylB,IAGqBa,GACrBH,EAAa/mC,MAAMgnC,EAAgBC,MAEfC,GAAY1B,EAASxlC,MAAMgF,EAAO4b,KAEtDyI,GACE,6EAIJ,MAAMmJ,EAAW,IAAIvS,GAAamB,EAAM4lB,GAClCtU,EAAS,IAAIzS,GAAamB,EAAM6lB,GACtC,OAAO,IAAItmB,GAAU6R,EAAUE,GAAQ7R,SACzC,CAIA,MAAMsmB,EzBlTD,SAA2BnuB,GAChC,IAAImuB,EAAcnuB,EAAU/R,cAAc2a,IAC1C,OAAIulB,IAGJA,EAAcxvC,SAASyY,cAAc,QACrC+2B,EAAYtvC,UAAUQ,IAAI,yBAC1B8uC,EAAY3gC,YAAc,yBAC1BwS,EAAUhL,YAAYm5B,GACfA,EACT,CyBwSsBC,CAAkBb,EAAKO,KACrC9oB,EAAQrmB,SAAS0rB,cAGvB,OAFArF,EAAMqpB,eAAeF,GACrBnpB,EAAMspB,YAAYH,GACXnpB,CACT,CASA,SAASkpB,GAAYhrC,GACnB,IAAIqrC,EAAW,GACf,IAAK,IAAIpnC,EAAI,EAAGA,EAAIjE,EAAIE,OAAQ+D,IAAK,CACnC,MAAMimC,EAAOlqC,EAAIiE,GACbgmC,GAAQC,KAGZmB,GAAYnB,EACd;AACA,OAAOmB,CACT,CAyKOtpC,eAAek1B,GACpB/R,EACAqd,GAEA,MAAM1O,EAAQ0O,EAAU57B,MAAKwI,GAAgB,sBAAXA,EAAEtT,OAMpC,IAAKg4B,EACH,MAAM,IAAI5xB,MAAM,2BAGlB,MAAM8b,EAAWwkB,EAAU57B,MAAKwI,GAAgB,yBAAXA,EAAEtT,OAIvC,GAAIkiB,EAAU,CAGZ,IACE,MAAMoX,MAAEA,EAAKpS,OAAEA,EAAMpoB,KAAEA,SAAeivC,GAAiB7rB,EAASjV,OAC1DA,EAAQiV,EAASjV,MAAQia,EACzB2B,EAAM3G,EAAS2G,IAAM3B,EAErBuoB,EAAc3wC,EAAK8mB,UAAU3Y,EAAO4b,GAC1C,GAAImP,EAAMkD,QAAUuU,EAClB,MAAM,IAAIrpC,MAAM,kBAIlB,aADoBmoC,GAAiBjV,EAAOrsB,EAAO4b,EAGnD,CADA,MACA,CAKF,IACE,MAAM6mB,EAAW/C,GAAsB3U,EAAMkD,MAAOhZ,EAASjV,OACvD0iC,EAAYjD,GAAmB9oC,IAAI8rC,GACzC,GAAIC,EAAW,CACb,MAAMzC,UAAEA,EAAS9R,OAAEA,GAAWuU,EAM9B,aALoBpB,GAClBrB,EACA9R,EAAOnuB,MACPmuB,EAAOvS,IAGX,CAEA,CADA,MACA,CAEJ,CAEA,OAlNF3iB,eACE0pC,EACAC,GAIA,MAAMC,EAAYhD,KAAeqB,WAC3B4B,EAAcnrC,MAAMkrC,GACvB1zB,KAAK,GACLtX,KAAI,CAACiD,EAAGK,IAAMA,IAEjB,IAAI4nC,EACAC,EAEJ,GAAIJ,EAAc,CAChB,MAAMvW,MAAEA,EAAKpS,OAAEA,SAAiB6mB,GAAiB8B,GACjDG,EAAoB1W,EACpB2W,EAAuBJ,EAAe3oB,EAItC6oB,EAAYtqC,MAAK,CAAC8N,EAAGmB,IACLsP,KAAKyU,IAAIllB,EAAI+lB,GACbtV,KAAKyU,IAAI/jB,EAAI4kB,IAG/B,CAGA,MAAM4W,OACqBlnC,IAAzB4mC,EAAcxX,OACV+W,GAAYS,EAAcxX,aAC1BpvB,EACAmnC,OACqBnnC,IAAzB4mC,EAActX,OACV6W,GAAYS,EAActX,aAC1BtvB,EACAonC,EAAgBjB,GAAYS,EAAc1U,OAEhD,IAAImV,EACJ,IAAK,MAAM7B,KAAQuB,EAAa,CAC9B,MAAMjxC,QAAayuC,GAAmBiB,GAChC8B,EAAenB,GAAYrwC,GAGjC,IAAIyxC,OACsBvnC,IAAtBgnC,QAA4DhnC,IAAzBinC,IACjCzB,EAAOwB,EACTO,EAAeD,EAAajsC,OACnBmqC,IAASwB,GAGjBO,GAAgBpE,GACfrtC,EACAwxC,EACAL,EACAA,EACA3B,IAGFiC,EAAe,GAInB,MAAMpkC,EAAQ4rB,GAAWuY,EAAcF,EAAe,CACpDhY,OAAQ8X,EACR5X,OAAQ6X,EACR3X,KAAM+X,IAGR,GAAKpkC,KAIAkkC,GAAalkC,EAAM8qB,MAAQoZ,EAAUlkC,MAAM8qB,OAAO,CAGrD,MAAOhqB,EAAO4b,GAAOsjB,GACnBmE,EACAxxC,EACAqN,EAAMc,MACNd,EAAM0c,IACNylB,IAEF+B,EAAY;AACV7B,OACAriC,MAAO,CACLc,QACA4b,MACAoO,MAAO9qB,EAAM8qB,QAajB,MAAMuZ,EACJF,EAAaroC,MAAMkE,EAAMc,MAAOd,EAAM0c,OAASunB,EAE3CK,OACeznC,IAAnBknC,GACAI,EAAaroC,MACX+b,KAAKM,IAAI,EAAGnY,EAAMc,MAAQijC,EAAe7rC,QACzC8H,EAAMc,SACFijC,EAEFQ,OACe1nC,IAAnBmnC,GACAG,EAAaroC,MAAMkE,EAAM0c,IAAKsnB,EAAe9rC,UAAY8rC,EAErDQ,OACe3nC,IAAnBknC,QAAmDlnC,IAAnBmnC,EAElC,GACEK,IACCC,GAAoBC,IAAqBC,GAE1C,KAEJ,CACF,CAEA,GAAIN,EAAW,CACb,MAAM7B,KAAEA,EAAIriC,MAAEA,GAAUkkC,EAIxB,GAAIR,EAAc,CAChB,MAAMH,EAAW/C,GAAsBiD,EAAc1U,MAAO2U,GAC5DnD,GAAmBhpC,IAAIgsC,EAAU,CAC/BxC,UAAWsB,EACXpT,OAAQjvB,GAEZ,CAGA,OAAOoiC,GAAiBC,EAAMriC,EAAMc,MAAOd,EAAM0c,IACnD,CAEA,MAAM,IAAIziB,MAAM,kBAClB,CAgESwqC,CAAY5Y,EAAO9V,aAAAA,EAAAA,EAAUjV,MACtC,CAOA,SAAS4jC,GAAqB5qB,GAG5B,IACEA,EAAQ2C,GAAUgB,UAAU3D,GAAO6C,SAGrC,CAFE,MACA,MAAM,IAAI1iB,MAAM,kCAClB,CAEA,MAAM0qC,EAAiBlE,GAAiB3mB,EAAMO,gBACxCuqB,EAAenE,GAAiB3mB,EAAMQ,cAE5C,IAAKqqB,IAAmBC,EACtB,MAAM,IAAI3qC,MAAM,kCAGlB,GAAI0qC,IAAmBC,EACrB,MAAM,IAAI3qC,MAAM,iDAGlB,MAAO,CAAC6f,EAAO6qB,EACjB,CA0BO5qC,eAAeihC,GACpB9d,EACApD,GAEA,MAAO6U,EAAW6T,GAAakC,GAAqB5qB,GAE9CwU,EAAWvS,GAAaQ,UAC5BoS,EAAUtU,eACVsU,EAAU3R,aACVhB,WAAWwmB,GAEPhU,EAASzS,GAAaQ,UAC1BoS,EAAUrU,aACVqU,EAAU1R,WACVjB,WAAWwmB,GAEPqC,EApkBR,SAAyB/pB,GACvB,IAAIqS,EAAQ,EACZ,KAAOrS,EAAKU,mBACR2R,EACFrS,EAAOA,EAAKU,gBAEd,OAAO2R,CACT,CA6jByB2X,CAAgBtC,EAAUj7B,YAC3Cw9B,QA9cRhrC,eAA6BgnC;AAE3B,GAAIA,GADWJ,KACSqB,WAEtB,MAAM,IAAI/nC,MAAM,sBAElB,IAAI8gB,EAAS,EACb,IAAK,IAAI9e,EAAI,EAAGA,EAAI8kC,EAAW9kC,IAE7B8e,UADmBqmB,GAAmBnlC,IACvB/D,OAEjB,OAAO6iB,CACT,CAkc2BiqB,CAAcH,GAUvC,MAAO,CARU,CACfhxC,KAAM,uBACNiN,MAAOikC,EAAazW,EAASvT,OAC7B2B,IAAKqoB,EAAavW,EAAOzT,QAGb+T,GAAgBrR,UAAUP,EAAMyR,GAAWF,aAG3D,CC5oBe,SAASwW,IAAQ58B,SAAEA,IAChC,OAAOsL,GAAA,MAAA,CAAK3B,UAAU,gBAAe3J,SAAEA,GACzC,CCYe,SAAS68B,IAAkBC,KAAEA,IAE1C,IAAIC,EAAYD,EAAKE,KAAK7yB,MAI1B,OAHI2yB,EAAKE,KAAKC,WACZF,GAAc,KAAID,EAAKE,KAAKC,YAG5BrxB,GAAA,MAAA,CACEjC,UAAWC,GACT,+DACA,oBAEA,mCACA,mEACA5J,UAEFsL,GAAA,MAAA,CAAK,cAAY,eAActL,SAC5B88B,EAAKI,MACJ5xB,GAAC6xB,GAAI,CAACxiC,KAAMmiC,EAAKI,KAAKziC,KAAM7N,OAAO,SAAS,cAAY,YAAWoT,SACjEsL,GAAA,MAAA,CACEzF,IAAKi3B,EAAKI,KAAK/yB,MACfizB,IAAKN,EAAKI,KAAKA,KACf,cAAY,mBAKpB5xB,GAAA,MAAA,CACE3B,UAAWC,GAET,SACA,wEACA,iBAEF,cAAY,yBACZO,MAAO2yB,EAAKrwB,UAAUtC;AAAMnK,SAE3B88B,EAAKrwB,UAAUtC,QAElByB,GAAA,MAAA,CACEjC,UAAWC,GAET,4CAEF,cAAY,oBAAmB5J,UAE/BsL,GAAA,MAAA,CACE3B,UAAWC,GAGT,SAGA,wBAGHkzB,EAAK7P,MAAMoQ,cACVzxB,GAAAI,EAAA,CAAAhM,SAAA,CACE4L,GAACuxB,GAAI,CACHr0B,QAAQ,gEACRqB,MAAM,qBACNxP,KAAMmiC,EAAK7P,MAAMoQ,aACjBtyB,UAAU,SACVne,OAAO,SACP,cAAY,wBAAuBoT,SAAA,CAEnCsL,GAACnD,GAAa,CAACwB,UAAU,cACzB2B,GAAA,OAAA,CAAAtL,SAAM,gBAERsL,GAAA,MAAA,CAAK3B,UAAU,oBAAmB3J,SAAC,SAGvCsL,GAAA,MAAA,CACE3B,UAAWC,GAIT,8EACA5J,SAEFsL,GAACL,GAAQ,CACPd,MAAO4yB,EACPpiC,KAAMmiC,EAAK7P,MAAMqQ,YACjB,cAAY,oBACZ1wC,OAAO,SACPod,UAAQ,EAAAhK,SAEP+8B,MAIJD,EAAK7P,MAAMsQ,UACV3xB,GAAAI,EAAA,CAAAhM,UACEsL,GAAA,MAAA,CAAK3B,UAAU,oBAAmB3J,SAAC,MACnC4L,GAACuxB,GAAI,CACHhzB,MAAM,iBACNrB,QAAQ,gEACRnO,KAAMmiC,EAAK7P,MAAMsQ;AACjBxyB,UAAU,SACVne,OAAO,SACP,cAAY,oBAAmBoT,UAE/BsL,GAAA,OAAA,CAAAtL,SAAM,SACNsL,GAAClD,GAAc,CAACuB,UAAU,yBAOxC,CC5He,SAAS6zB,KACtB,OACElyB,GAAA,MAAA,CAAK3B,UAAU,WAAWS,KAAK,QAAOpK,SACpC4L,GAAA,MAAA,CACEjC,UAAWC,GACT,4BACA,uEACA5J,UAEFsL,GAAA,MAAA,CAAK3B,UAAU,kCAAiC3J,SAC9CsL,GAACjD,GAAW,CAACsB,UAAU,wBAEzBiC,GAAA,MAAA,CAAA5L,UACEsL,GAAA,SAAA,CAAAtL,SAAQ,+CAAoD,IAC5DsL,GAAC6xB,GAAI,CACHvwC,OAAO,SACP+N,KAAK,yDACLoQ,UAAU,SAAQ/K,SACnB,0BAEO,IAAI,+CAMtB,CC6BO,MAAMy9B,GASXlvC,YAAYmvC,GAA2BlvC,EAAAC,KAAA,eAAA,GACrCA,KAAKkvC,QA7CT,SAA8BD,GAI5B,OAAIA,EAAIE,mBACCF,EAAIE,mBACFF,EAAIG,YACN/rC,QAAQC,UAMR,IAAID,SAAQC,IACjB,MAAM+rC,EAAUxrC,aAAY,KACtBorC,EAAIG,cACN9wC,aAAa+wC,GACb/rC,IACF,GACC,EAAE;AAGX,CAuBmBgsC,CAAqBL,GAAKv4B,MAAK,IAExCu4B,EAAIM,iBACCN,EAGF,IAAI5rC,SAAQC,IACjB,MAAMksC,EAASA,KACTP,EAAI5E,UACN4E,EAAI5E,SAAS1lC,IAAI,eAAgB6qC,GACjCP,EAAI5E,SAAS1lC,IAAI,iBAAkB6qC,IAEnCnxC,OAAOS,oBAAoB,eAAgB0wC,GAE7ClsC,EAAQ2rC,EAAI,EAKVA,EAAI5E,UAMN4E,EAAI5E,SAASlmC,GAAG,iBAAkBqrC,GAGlCP,EAAI5E,SAASlmC,GAAG,eAAgBqrC,IAGhCnxC,OAAOM,iBAAiB,eAAgB6wC,EAC1C,KAGN,CAQAC,SACE,OAAOzvC,KAAKkvC,QAAQx4B,MAAKu4B,IACvB,IAAI9Q,EAAMuR,GAAUT,GAIpB,OAHK9Q,IACHA,EAAMwR,GAAiBC,GAAeX,KAEjC9Q,CAAG,GAEd,CAQAl7B,oBACE,MAAMgsC,QAAYjvC,KAAKkvC,SAErBb,KAAMwB,EAAYC,2BAClBA,EAA0BnR,SAC1BA,SACQsQ,EAAIc,YAAYC,cAEpBzQ,EAAsBqQ,GAAeX,GACrClzC,EAAM2zC,GAAUT,GAUtB,IAAIvzB,EAEFA,EADEijB,SAAAA,EAAUp3B,IAAI,aAA4C,aAA7Bo3B,EAASh+B,IAAI,YACpCg+B,EAASh+B,IAAI,YACZkvC,SAAAA,EAAcI,MACfJ,EAAaI,MACZH,IAEA/zC,EA0Df,SAAyBA,GACvB,MACMm0C,EADS,IAAI7R,IAAItiC,GACKo0C,SAASz4B,MAAM,KAC3C,OAAOw4B,EAAaA,EAAa9uC,OAAS,EAC5C,CA7DcgvC,CAAgBr0C,GAEhB,IAGV,MAAMiQ,EAAO,CAAC,CAAEE,KAAMyjC,GAAiBpQ,KAKvC,OAJIxjC,GACFiQ,EAAKzH,KAAK,CAAE2H,KAAMnQ,IAGb,CACL2f,QACA1P,OACAuzB,sBAEJ,EAMF,SAASqQ,GAAeX,GACtB,OAAIttC,MAAM2I,QAAQ2kC,EAAIc,YAAYM,cACzBpB,EAAIc,YAAYM,aAAa,GAE7BpB,EAAIc,YAAYO,WAE3B,CAMA,SAASX,GAAiBW,GACxB,MAAQ,aAAYA,GACtB,CAEA,SAASZ,GAAUT;AACjB,IAAKA,EAAIlzC,IACP,OAAO,KAGT,MAAMA,EAAMmiC,GAAa+Q,EAAIlzC,KAK7B,OAA+B,IAA3BA,EAAI2V,QAAQ,WACP3V,EAGF,IACT,CCtKA,SAASw0C,GAAsBpY,GAAgB,IAAA8N,EAC7C,MAAMtZ,EAA6B,QAApBsZ,EAAG9N,EAAO3O,kBAAU,IAAAyc,OAAA,EAAjBA,EAAoB,GACtC,OAAOtZ,GAAa9F,GAAgB8F,EACtC,CAEA,SAAS6jB,GAAMC,GACb,OAAO,IAAIptC,SAAQC,GAAW/E,WAAW+E,EAASmtC,IACpD,CAcO,MAAMC,WAAuBlrC,EAqClC1F,YACEoP,EACA5O,EAA2C,IAC3C,IAAAqwC,EAAAC,EAAAC,EACAniB,QAAQ3uB,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,iBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,2BAAA,GAAAD,EAAAC,KAAA,wCAAA,GAERA,KAAK8wC,WAAa5hC,EAGlB,MAAM6hC,EAAY1yC,OACZ2yC,EAAeD,EAAUjH,qBAE/B9pC,KAAKixC,WAAaD,EAAajH,UAC/B/pC,KAAKixC,WAAWlG,OAAOluC,UAAUQ,IAAI,8BAIrC2C,KAAKkxC,cAAoDP,QAAvCA,EAAyB,QAAzBC,EAAGI,EAAaG,iBAAbP,IAAsBA,OAAtBA,EAAAA,EAAwBQ,wBAAYT,EAAAA,EAAIh0C,SAAS+5B,KAEtE12B,KAAKqxC,aAAe,IAAIrC,GAAYgC,GAEpChxC,KAAKsxC,UAAY,IAAItO,iBAAiBuO,IAAS,IAAMvxC,KAAKwxC,WAAW;AACrExxC,KAAKsxC,UAAUrO,QAAQjjC,KAAKixC,WAAWlG,OAAQ,CAC7Cv1B,YAAY,EACZ6tB,gBAAiB,CAAC,eAClBF,WAAW,EACXC,SAAS,IAGXpjC,KAAKyxC,oBAAgDZ,QAA7BA,EAAGvwC,EAAQoxC,0BAAkBb,IAAAA,EAAAA,EAAI,IACzD7wC,KAAK2xC,QAAU,KACf3xC,KAAK4xC,aAAe,CAClBC,YAAa,KACbC,eAAe,GAEjB9xC,KAAK+xC,mBAAmB/xC,KAAK4xC,cAC7B5xC,KAAKgyC,0BAKLhyC,KAAKiyC,iCAAmC,KACtC,MAAM/qB,EAAY6pB,EAAUmB,eAI5BlyC,KAAKixC,WAAWlG,OAAOluC,UAAUwuB,OAC/B,gBACCnE,EAAUc,YACZ,EAGHhoB,KAAKC,WAAa,IAAIJ,EACtBG,KAAKC,WAAW5C,IACdV,SACA,kBACAqD,KAAKiyC,kCAGPjyC,KAAKkK,YAAa,CACpB,CAEAlH,UAAU,IAAAmvC,EACRnyC,KAAKC,WAAWY,YAChBb,KAAKixC,WAAWlG,OAAOluC,UAAUY,OAAO,8BACxCuC,KAAKsxC,UAAUjY,aACH,QAAZ8Y,EAAInyC,KAAC2xC,eAALQ,IAAYA,GAAZA,EAAc10C,SACduC,KAAKkK,YAAa,CACpB,CAKAi0B,MACE,OAAOn+B,KAAKqxC,aAAa5B,QAC3B,CAKAO,cACE,OAAOhwC,KAAKqxC,aAAarB,aAC3B,CAMAoC,gBAAgBP,GACd7xC,KAAK+xC,mBAAmB,CAAEF,eAC5B,CAKA1Z,OAAO/R,EAAmBqd,GAGxB,OAAOtL,GAAO/R,EAAMqd,EACtB,CAOAY,oBAAoBrhB,GAClB;AACE,MAAMqD,EAAeV,GAAUU,aAAarD,GAC5C,GLkZC,SAAqBA,GAC1B,IAEE,OADA4qB,GAAqB5qB,IACd,CAGT,CAFE,MACA,OAAO,CACT,CACF,CKzZUqvB,CAAYhsB,GACd,OAAOA,CAMX,CAJE,MAAOzgB,GACP,KAAMA,aAAese,YACnB,MAAMte,CAEV,CACA,OAAO,IACT,CAGA0+B,8BACE,OAAO,CACT,CAKAJ,SAAS9d,EAAmBpD,GAG1B,OAAOkhB,GAAS9d,EAAMpD,EACxB,CAKA/f,gCAEE,UACQjD,KAAKm+B,KAGb,CAFE,MAAOvgC,GACP,MACF,CAIA,IAAIoC,KAAKkK,WAIT,IACE,MAAMooC,QLrHLrvC,iBACL,MAAM8nC,EAASlB,KACf,IAAIyI,GAAU,EACd,IAAK,IAAIntC,EAAI,EAAGA,EAAI4lC,EAAOG,WAAY/lC,IAErC,UADuBmlC,GAAmBnlC,IAC7ByF,OAAOxJ,OAAS,EAAG,CAC9BkxC,GAAU,EACV,KACF,CAEF,OAAOA,CACT,CK0G4BC,GACtBvyC,KAAK+xC,mBAAmB,CAAED,eAAgBQ,GAI5C,CAHE,MAAO1sC,GAEPS,QAAQC,KAAK,mCAAoCV,EACnD,CACF,CAKAmsC,mBACE79B,GAEAlU,KAAK4xC,aAAe,IAAK5xC,KAAK4xC,gBAAiB19B,GAI/C,MAAMs+B,EAAiB71C,SAASsP,cAC9B,mBAMe,IAAAwmC,EAAjB,KAFEzyC,KAAK4xC,aAAaC,aAAe7xC,KAAK4xC,aAAaE,eAUnD,OAPY,QAAZW,EAAIzyC,KAAC2xC,eAALc,IAAYA,GAAZA,EAAch1C,SACduC,KAAK2xC,QAAU,UAIfa,EAAel/B,MAAM2F,OAAS,IAK3BjZ,KAAK2xC,UACR3xC,KAAK2xC,QAAUh1C,SAASyY,cAAc,qBACtCzY,SAAS+5B,KAAKgc,QAAQ1yC,KAAK2xC,SAC3B5zB,GAAiB/d,KAAK2xC,UAGxB59B,GACEoJ,GAACgxB,GAAO;AAAA58B,SAAA,CACLvR,KAAK4xC,aAAaC,aACjBh1B,GAACuxB,GAAiB,CAACC,KAAMruC,KAAK4xC,aAAaC,cAE5C7xC,KAAK4xC,aAAaE,eAAiBj1B,GAACkyB,GAAgB,CAAA,MAEvD/uC,KAAK2xC,QAAQ1zB,YAGf,MAAM00B,EAAe3yC,KAAK2xC,QAAQhxB,wBAAwB1H,OAQ1Du5B,EAAel/B,MAAM2F,OAAU,eAAc05B,MAC/C,CAGAnB,UAEE,MAAMoB,EAAqB,GAErB/F,EAAY7sC,KAAKixC,WAAW/F,WAClC,IAAK,IAAIjB,EAAY,EAAGA,EAAY4C,EAAW5C,IAAa,CAAA,IAAA4I,EAC1D,MAAMtH,EAAOvrC,KAAKixC,WAAWjH,YAAYC,GACzC,GAAKsB,iBAAIsH,EAAJtH,EAAMG,iBAAS,IAAAmH,GAAfA,EAAiBlH,cAKtB,OAAQJ,EAAKE,gBACX,KAAKlC,GAGHgC,EAAKG,UAAY,KACjB,MACF,KAAKnC,G9BrSqBvrB,E8B0SNutB,EAAKO,I9B1SyBgH,SACZ,QAA5CA,EAAA90B,EAAU/R,cAAc2a,WAAoB,IAAAksB,GAA5CA,EAA8Cr1C,S8B4S5C,C9B7SG,IAA2BugB,EAAwB80B,E8BgTtD,IAAK,MAAM3a,KAAUn4B,KAAK8wC,WAAWljB,QAEnC,GAAIuK,EAAO3O,WAAY,CACrB,GAAIopB,EAAmBn4B,SAAS0d,EAAOrK,YACrC,SAMF,IAAK,IAAIuI,EAAQ,EAAGA,EAAQ8B,EAAO3O,WAAWpoB,OAAQi1B,IAAS,CAC7D,MAAM0c,EAAK5a,EAAO3O,WAAW6M,GAC7B,IAAK15B,SAAS+5B,KAAKt5B,SAAS21C,GAAK,CAC/B5a,EAAO3O,WAAWnT,OAAOggB,EAAO,UACzB8B,EAAOnV,MACd4vB,EAAmBruC,KAAK4zB,EAAOrK,YAC/B,KACF,CACF,CACF,CAGF8kB,EAAmB/wC,KAAIisB,GAAc9tB,KAAK8wC,WAAW3Y,OAAOrK,IAC9D,CAKAR,mBACE,OAAO3wB,SAASsP,cAAc,mBAChC,CAWAu3B,cAAcwP;AACZ,MAAMxO,EAAoBnmC,OAAOijB,WAAa0xB,EAAch6B,MACtD+B,EAASi4B,EAAcx3B,UAAYgpB,GA/VvB,IAwWZyO,EAAgBl4B,EAClBi4B,EAAch6B,MACdg6B,EAAcE,aAClBlzC,KAAKkxC,cAAc59B,MAAM0F,MAAS,eAAci6B,OAGhD,MAAME,EAAoBnzC,KAAKixC,WAAWkC,kBAa1C,MAXwB,SAAtBA,GACsB,aAAtBA,GACsB,eAAtBA,IAIAnzC,KAAKixC,WAAWkC,kBAAoBA,GAGtCnzC,KAAKixC,WAAWtjB,SAET5S,CACT,CAYA9X,qBAAqBk1B,GACnB,MAAMrK,EAAaqK,EAAOrK,WACpB5E,EAAgBqnB,GAAsBpY,GACtClU,EAASjkB,KAAKozC,cAAcjb,GAClC,GAAe,OAAXlU,UAOE4Z,GAAc79B,KAAKstB,mBAAoBrJ,GAEzCiF,GAAe,CACjB,MAAMiP,QAAen4B,KAAKqzC,+BACxBvlB,EACA9tB,KAAKyxC,qBAEP,IAAKtZ,EACH,OAEF,MAAMlU,EAASjkB,KAAKozC,cAAcjb,GAClC,GAAe,OAAXlU,EACF,aAEI4Z,GAAc79B,KAAKstB,mBAAoBrJ,EAC/C,CACF,CAKAhhB,qCACE6qB,EACA+Z,GACwB,IAAAyL,EACxB,MAAMtpC,EAAQyxB,KAAKC,MACnB,IAAIvD,EACJ,GAGEA,EAASn4B,KAAK8wC,WAAWljB,QAAQ/lB,MAAKyI,GAAKA,EAAEwd,aAAeA,IACvDqK,IAAUoY,GAAsBpY,KACnCA,EAAS,WAIHqY,GAAM,YAENrY,GAAUsD,KAAKC,MAAQ1xB,EAAQ69B,GACzC,OAAa,QAAbyL,EAAOnb,SAAMmb,IAAAA,EAAAA,EAAI,IACnB,CAQAF,cAAcjb,GACZ,IAAKA,EAAO3O,WAEV,OAAO,KAGT,ObndG,SAA0BhL,EAAS7U,GACxC,IAAIsa,EAAS,EACb,KAAOzF,IAAY7U,GAAUA,EAAOvM,SAASohB,IAC3CyF,GAAUzF,EAAQkT,UAClBlT,EAAsCA,EAAQ+0B,aAEhD,OAAOtvB,CACT,Ca4cWuvB,CADWrb,EAAO3O,WAAW,GACDxpB,KAAKstB,mBAC1C;AC9WK,SAASmmB,GAAYC,GAC1B,MAAMnH,EAvFD,SAA4BmH,GAEjC,IAAKA,EAAIj5B,SAAS,KAChB,OAAOi5B,EAGT,IAAI9d,EAAS,GAGT+d,GAAU,EAGVC,GAAc,EAElB,IAAK,MAAMC,KAAMH,EACVC,GAAkB,MAAPE,GAKXF,GAAkB,MAAPE,GAEJF,GAAWC,GAAsB,MAAPC,EACpCD,GAAc,EACJA,IACVhe,GAAUie,GAJVD,GAAc,EAOhBD,GAAU,GAZRA,GAAU,EAed,OAAO/d,CACT,CAuDmBke,CAAmBJ,GAC9BK,EAAWxH,EAAS76B,QAAQ,KAClC,OAAqB,IAAdqiC,EAAkBxH,EAAWA,EAASvnC,MAAM,EAAG+uC,EACxD,CCvHO,MAAMC,GAcXl0C,YACE0e,EACAy1B,EACAC,GACAn0C,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,yBAAA,GACAA,KAAKuxB,SAAW/S,EAChBxe,KAAKm0C,cAAgBF,EACrBj0C,KAAKo0C,gBAAkBF,EACvBl0C,KAAKq0C,mBAAqB,IAAIvtC,IAC9B9G,KAAKs0C,iBAAkB,EAEvBt0C,KAAKu0C,kBAAoB,IAAIvR,iBAC3BuO,IAAS,KACPvxC,KAAKw0C,iBAAiB,GAzCD,KA4CzBx0C,KAAKw0C,kBACLx0C,KAAKu0C,kBAAkBtR,QAAQjjC,KAAKuxB,SAAU,CAC5C4R,WAAW,EACXC,SAAS,EACTC,gBAAiB,CAAC,sBAEtB,CAEAhK,aACEr5B,KAAKs0C,iBAAkB,EACvBt0C,KAAKu0C,kBAAkBlb,YACzB,CAEAp2B,gBAAwBwxC,GACtBz0C,KAAKq0C,mBAAmBh3C,IAAIo3C,GAC5B,IAEE,SADMC,GAAoBD,GACtBz0C,KAAKs0C,gBACP,OAEkBG,EAAME,cAEbh2C,iBAAiB,UAAU,KACtCqB,KAAK40C,aAAaH,EAAM;AAE1Bz0C,KAAKm0C,cAAcM,EAKrB,CAJE,MAAO72C,GACPyI,QAAQC,KACL,iDAAgD3J,SAASmQ,SAASZ,oCAAoCuoC,EAAM9F,QAEjH,CACF,CAEQiG,aAAaH,GACnBz0C,KAAKq0C,mBAAmBzzC,OAAO6zC,GAC/Bz0C,KAAKo0C,gBAAgBK,EACvB,CAEQD,kBACN,MAAMK,EAAS,IAAI/tC,IACjB9G,KAAKuxB,SAASlmB,iBAAiB,8BAGjC,IAAK,MAAMopC,KAASI,EACb70C,KAAKq0C,mBAAmB9sC,IAAIktC,IAC/Bz0C,KAAK80C,UAAUL,GAInB,IAAK,MAAMA,KAASz0C,KAAKq0C,mBAClBQ,EAAOttC,IAAIktC,IACdz0C,KAAK40C,aAAaH,EAGxB,EAsBK,SAASC,GACdD,GAEA,OAAO,IAAIpxC,SAAQ,CAACC,EAASC,KAC3B,MAAMwxC,EAAcC,GAAgBP,GAAO,CAAC7uC,EAAKqvC,KAC/CF,IACIE,EACF3xC,EAAQ2xC,GAER1xC,EAAOqC,EACT,GACA,GAEN,CAsBO,SAASovC,GACdP,EACApwC,GACA6wC,aAAEA,EAAe,IAAkC,IAEnD,IAAIC,EAMAC,EAIJ,MAAMC,EAAY,IAAIC,QAEhBC,EAAaA,KACjBj3C,aAAa62C,GACbA,OAAYpvC,CAAS,EAWjByvC,EAAyBA,KAC7B,MAAMC,EAAkBhB,EAAMiB,gBAI9B,GAAKD,GASL,IAAIJ,EAAU9tC,IAAIkuC,GAAlB,CAMA,GAHAJ,EAAUh4C,IAAIo4C,GACdF,KAlGJ,SAA0Cd,GAAmC,IAAAkB,EAC3E,MAC2C,iBAApB,QAArBA,EAAAlB,EAAMiB,uBAAe,IAAAC,OAAA,EAArBA,EAAuB7oC,SAASZ,OAEhCuoC,EAAMj3C,aAAa,QACL,gBAAdi3C,EAAM9F,GAEV,CA6FSiH,CAAiCnB,GAAQ,CAEX,gBAA/BgB,EAAgBI,YACe,aAA/BJ,EAAgBI,WAGhBxxC,EAAS,KAAMoxC,GAEfA,EAAgB92C,iBAAiB,oBAAoB,IACnD0F,EAAS,KAAMoxC,IAGrB,CAtCmBK,IACQC;CAAvBtB,EAAMiB,kBACWK,QAAnBA,EAAAtB,EAAME,qBAANoB,IAAmBA,GAAnBA,EAAqBp3C,iBAAiB,SAAUy2C,GAoBlD,MAXA,CACEG,IACA,MAAMS,EAAevB,EAAMwB,YACvB,wBACA,wBACJ5xC,EAAS,IAAIlB,MAAM6yC,GAErB,CAuBc,EAGhB,IAAIE,GAAW,EACfd,EAAwBA,KACtBG,IACKW,IACHf,EAAYtxC,YAAY2xC,EAAwBN,GAClD,EAcFT,EAAM91C,iBAAiB,OAAQ62C,GAI/B,MAAMW,EAAoB53C,WAAWi3C,EAAwB,GAE7D,MAAO,KACLU,GAAW,EACX53C,aAAa63C,GACbZ,IACAd,EAAM31C,oBAAoB,OAAQ02C,EAAuB,CAE7D,CC5OO,MAAMY,GAQXt2C,YAAY0e,EAAkBrT,GAAsBpL,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,sBAAA,GAClDA,KAAKq2C,QAAUlrC,EACfnL,KAAKs2C,eAAiB,IAAItC,GACxBx1B,GACAi2B,GAAS8B,GAAa9B,EAAOtpC,KAC7B,QAEJ,CAKAnI,UACEhD,KAAKs2C,eAAejd,YACtB,EAwCKp2B,eAAeszC,GACpB9B,EACAtpC,EACAqrC,GAEA,GArCuE,OAqCrD/B,EAtCYiB,gBACRzpC,cAAc,+BAsClC,aAGIyoC,GAAoBD,GAU1B,MAAMgC,UAAEA,EAASrpC,eAAEA,EAAcC,cAAEA,EAAaE,cAAEA,GAChDrC,EAAgBvO,UAEZ+5C,EAAiB,IAClBvrC,EAEHsrC,YAOArpC,iBACAC,gBACAE,gBAGAsB,mBAAoB2nC,QAAAA,EAAWn1C,EAAkB,KAG7Cs1C,EAAgBh6C,SAASyY,cAAc,UAC7CuhC,EAAcz7B,UAAY,uBAC1By7B,EAAcr5C,aAAa,wBAAyB,IACpDq5C,EAAc55C,KAAO,mBACrB45C,EAAcC,UAAYx0C,KAAKC,UAAUq0C;CAEzC,MAAMG,EAAal6C,SAASyY,cAAc,UAC1CyhC,EAAW5zC,OAAQ,EACnB4zC,EAAWlI,IAAMxjC,EAAO6B,UAExB,MAAM8pC,EAAiBrC,EAAMiB,gBAC7BoB,EAAepgB,KAAK1jB,YAAY2jC,GAChCG,EAAepgB,KAAK1jB,YAAY6jC,EAClC,CCwBO,MAAME,GAiBXj3C,YAAYk3C,EAAgBC,EAAsBp7C,GAChD,GAD8DkE,EAAAC,KAAA,iBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,4BAAA,GAC1Di3C,EAAU71C,SAAWvF,EAAKuF,OAC5B,MAAM,IAAI+B,MAAM,gDAIlB,MAAM+zC,EAAkBF,EAAMvmC,WACxBuN,EAAYrhB,SAASyY,cAAc,yBACzC8hC,EAAgBjkC,aAAa+K,EAAWg5B,EAAMnkC,aAI9CqkC,EAAgB5jC,MAAM2L,SAAW,WACjCjB,EAAU1K,MAAM2L,SAAW,WAC3BjB,EAAU1K,MAAM4L,IAAM,IACtBlB,EAAU1K,MAAM6L,KAAO,IACvBnB,EAAU1K,MAAMiJ,MAAQ,cAIxByB,EAAU1K,MAAM6jC,UAAY,OAK5Bn5B,EAAU1K,MAAM4W,aAAe,WAK/B,MACMktB,EAAa,aACnBp5B,EAAU1K,MAAM+jC,SAAWA,OAC3Br5B,EAAU1K,MAAM8jC,WAAaA,EAC7B,MACMnxC,EADStJ,SAASyY,cAAc,UACfkiC,WAAW,MAClCrxC,EAAQsxC,KAAQ,kBAGhB,MAAMC,EAAcA,CAClBC,EACA9sC,EACA+sC,EAAO,OACH,cAAaD,cAAsB9sC,IAAQ+sC,KAW3CC,EA3LV,SAAuBV,EAAsBp7C,GAC3C,MAAM+7C,EAAQ,GAEd,IAAIC,EAAc,CAAEh8C,KAAM,GAAIyuB,KAAM,IAAI2W,SAGxC,MAAM6W,EAAUA,KACVD,EAAYh8C,KAAKuF,OAAS,IAC5Bw2C,EAAMrzC,KAAKszC,GACXA,EAAc,CAAEh8C,KAAM,GAAIyuB,KAAM,IAAI2W,SACtC;CAEF,IAAK,MAAO97B,EAAGmlB,KAAS2sB,EAAUloB,UAAW,CAC3C,MAAMqc,EAAOvvC,EAAKsJ,GACZgmC,EAAU,KAAK/3B,KAAKg4B,GAGxByM,EAAYh8C,KAAKuF,OAAS,IACzB0/B,GAAuB+W,EAAYvtB,KAAMA,IAE1CwtB,IAGFD,EAAYvtB,KAAO0W,GAAW6W,EAAYvtB,KAAMA,GAGhDutB,EAAYh8C,MAAQsvC,EAAU,IAAMC,EAEhCD,GACF2M,GAEJ,CACAA,IAEA,MAAMC,EAAQ,GAEd,IAAIC,EAAc,CAAEJ,MAAO,GAAIttB,KAAM,IAAI2W,SAGzC,MAAMgX,EAAUA,KACVD,EAAYJ,MAAMx2C,OAAS,IAC7B22C,EAAMxzC,KAAKyzC,GACXA,EAAc,CAAEJ,MAAO,GAAIttB,KAAM,IAAI2W,SACvC,EAEF,IAAK,MAAMgB,KAAQ2V,EAAO,CACxB,MAAMM,EAAWF,EAAYJ,MAAMI,EAAYJ,MAAMx2C,OAAS,GAC9D,GAAI82C,EAAU,CACZ,MAAMC,EAAajX,GAAWgX,EAAS5tB,MAEjC8tB,EADgBlX,GAAWe,EAAK3X,MACV/X,EAAI4lC,EAAW5lC,IAExCuuB,GAAuBoX,EAAS5tB,KAAM2X,EAAK3X,OAE5C8tB,EAAQ,IAERH,GAEJ,CACAD,EAAYJ,MAAMrzC,KAAK09B,GACvB+V,EAAY1tB,KAAO0W,GAAWgX,EAAY1tB,KAAM2X,EAAK3X,KACvD,CACA2tB,IAEA,MAAMN,EAAU,GAEhB,IAAIU,EAAgB,CAAEN,MAAO,GAAIztB,KAAM,IAAI2W,SAG3C,MAAMqX,EAAYA,KACZD,EAAcN,MAAM32C,OAAS,IAC/Bu2C,EAAQpzC,KAAK8zC,GACbA,EAAgB,CAAEN,MAAO,GAAIztB,KAAM,IAAI2W,SACzC,EAEF,IAAK,MAAMsX,KAAQR,EAAO,CACxB,MAAMS,EAAWH,EAAcN,MAAMM,EAAcN,MAAM32C,OAAS,GAElE,GAAIo3C,EAAU,CACZ,MAAML,EAAajX,GAAWsX,EAASluB,MAEjCmuB,EADgBvX,GAAWqX,EAAKjuB,MACV9X,EAAI2lC,EAAW3lC,IAGxCuuB,GAAyByX,EAASluB,KAAMiuB,EAAKjuB,OAC9CwW,GAAuB0X,EAASluB,KAAMiuB,EAAKjuB,OAK3CmuB,EAAQ,GAKRA,EAA2B,EAAnBF,EAAKjuB,KAAKrR,SAElBq/B,GAEJ,CACAD,EAAcN,MAAMxzC,KAAKg0C,GACzBF,EAAc/tB,KAAO0W,GAAWqX,EAAc/tB,KAAMiuB,EAAKjuB,KAC3D,CAGA,OAFAguB,IAEOX,CACT,CAiFoBe,CAAczB,EAAWp7C,GAEzC,IAAK,MAAM88C,KAAUhB,EAAS,CAC5B,MAAMiB,EAAWj8C,SAASyY,cAAc,0BACxCwjC,EAAStlC,MAAMulC,QAAU,QACzBD,EAAStlC,MAAM2L,SAAW,WAC1B25B,EAAStlC,MAAM6L,KAAOq4B,EAAY,IAAKmB,EAAOruB,KAAKnL,MACnDy5B,EAAStlC,MAAM4L,IAAMs4B,EAAY,IAAKmB,EAAOruB,KAAKpL,KAElD,IAAIs5B,EAAW,KACf,IAAK,MAAMD,KAAQI,EAAOZ,MAAO;AAC/B,MAAMe,EAASn8C,SAASyY,cAAc,wBACtC0jC,EAAOxlC,MAAMulC,QAAU,QACvBC,EAAOxlC,MAAMwxB,WAAa0S,EACxB,IACAe,EAAKjuB,KAAKnL,KAAOw5B,EAAOruB,KAAKnL,MAE/B25B,EAAOxlC,MAAM2F,OAASu+B,EAAY,IAAKe,EAAKjuB,KAAKrR,QAE7Cu/B,IACFM,EAAOxlC,MAAMylC,UAAYvB,EACvB,IACAe,EAAKjuB,KAAKpL,IAAMs5B,EAASluB,KAAKoB,SAGlC8sB,EAAWD,EAGXO,EAAOxlC,MAAM0lC,WAAa,SAE1B,IAAId,EAAW,KACf,IAAK,MAAMjW,KAAQsW,EAAKX,MAAO,CAC7B,MAAMqB,EAASt8C,SAASyY,cAAc,wBACtC6jC,EAAO3lC,MAAMulC,QAAU,eACvBI,EAAO3lC,MAAM4lC,gBAAkB,WAC/BD,EAAOztC,YAAcy2B,EAAKpmC,KAEtBq8C,IACFe,EAAO3lC,MAAMwxB,WAAa0S,EACxB,IACAvV,EAAK3X,KAAKnL,KAAO+4B,EAAS5tB,KAAKqB,QAGnCusB,EAAWjW,EAIXgX,EAAO3lC,MAAM0F,MAAQw+B,EAAY,IAAKvV,EAAK3X,KAAKtR,OAChDigC,EAAO3lC,MAAM2F,OAASu+B,EAAY,IAAKvV,EAAK3X,KAAKrR,QAIjDggC,EAAO3lC,MAAM0lC,WAAa,MAK1B,MAAMG,EAAUlzC,EAAQmzC,YAAYnX,EAAKpmC,MACnCw9C,EAAS7B,EAAY,IAAKvV,EAAK3X,KAAKtR,MAAQmgC,EAAQngC,MAAO,IAC3DsgC,EAAS9B,EAAY,IAAKvV,EAAK3X,KAAKrR,OAnF/B,GAmFkD,IAC7DggC,EAAO3lC,MAAMimC,UAAa,SAAQF,MAAWC,KAE7CR,EAAOtuB,OAAOyuB,EAChB,CAEAL,EAASpuB,OAAOsuB,EAClB,CAEA96B,EAAUwM,OAAOouB,EACnB,CAEA,MAAMY,EAAsBA,KAC1B,MAAQxgC,MAAOygC,EAAYxgC,OAAQygC,GACjC1C,EAAMr2B,wBACR3C,EAAU1K,MAAM0F,MAAQygC,EAAa,KACrCz7B,EAAU1K,MAAM2F,OAASygC,EAAc,KAEvC17B,EAAU1K,MAAMH,YAAY,YAAc,GAAEsmC,KAC5Cz7B,EAAU1K,MAAMH,YAAY,YAAc,GAAEumC,IAAc,EAG5DF,IAQAx5C,KAAKge,UAAYA,EAEjBhe,KAAK25C,qBAAuBpI,GAASiI,EAAqB,CAAE3R,QAAS;AACrE7nC,KAAKC,WAAa,IAAIJ,EAEQ,oBAAnB+5C,iBACT55C,KAAK65C,mBAAqB,IAAID,gBAAe,KAC3C55C,KAAK25C,sBAAsB,IAE7B35C,KAAK65C,mBAAmB5W,QAAQ+T,IAMlCh3C,KAAKC,WAAW5C,IAAIgB,OAAQ,SAAU2B,KAAK25C,qBAC7C,CAWAG,aACE95C,KAAK25C,uBACL35C,KAAK25C,qBAAqB5Q,OAC5B,CAEA/lC,UAAU,IAAA+2C,EACR/5C,KAAKge,UAAUvgB,SACfuC,KAAKC,WAAWY,YAChBb,KAAK25C,qBAAqBxc,SACH,QAAvB4c,EAAI/5C,KAAC65C,0BAALE,IAAuBA,GAAvBA,EAAyB1gB,YAC3B,ECpUF,SAAS2gB,GAAgBC,EAAYt9C,UACnC,OAAOs9C,EAAUhuC,cAAc,cACjC,CAUO,SAASiuC,GACdpuC,EAAUzN,QACsB,IAAA87C,EAChC,GAAIH,GAAgBluC,EAAQnP,UAC1B,MAAO,YAGT,MAAMy9C,EAAgC,QAAvBD,EAAGruC,EAAQuuC,oBAAY,IAAAF,OAAA,EAApBA,EAAsB96B,cACxC,OAAI+6B,GAAaJ,GAAgBI,GACxB,UAGF,IACT,CAqBO,MAAME,GAOXx6C,YAAYqL,GAAsBpL,EAAAC,KAAA,sBAAA,GAChC,MAAMu6C,EAAcP,KACpB,IAAKO,EACH,MAAM,IAAIp3C,MAAM,oCAGlB,MAAMq3C,EAAgB,IAAIlF,QAEpBr3B,EAAas8B,EAAYt8B,WACzBw8B,EAA+BA,KACnC,MAAMhG,EAAQx2B,EAAWhS,cAAc,UAClCwoC,IAAS+F,EAAcjzC,IAAIktC,KAIhC+F,EAAcn9C,IAAIo3C,GAClBO,GAAgBP,GAAO,CAAC7uC,EAAKq0C,KAC3B,GAAIr0C,EACF,OAIF,MAAM8wB,EAAOujB,EAAWvjB;CAGtBA,IAWCA,EAAKzqB,cAAc,kBAGpBsqC,GAAa9B,EAAOtpC,EAAQ,sBAC9B,IACA,EAGJsvC,IAGAz6C,KAAKs2C,eAAiB,IAAItT,iBAAiByX,GAC3Cz6C,KAAKs2C,eAAerT,QAAQhlB,EAAY,CAAEklB,WAAW,EAAMC,SAAS,GACtE,CAEApgC,UACEhD,KAAKs2C,eAAejd,YACtB,EAGF,SAASqhB,KACP,OAAO/9C,SAASsP,cAAc,eAChC,CAwDO,MAAM0uC,WACHn1C,EAQR1F,YAEEke,EAAyBrhB,SAAS+5B,KAElCp2B,EAGI,CAAA,GACJ,IAAAs6C,EACAlsB,QAAQ3uB,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,wBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAER,MAAMu6C,EACeK,QADJA,EACft6C,EAAQi6C,uBAAWK,EAAAA,EAAIZ,GAAgB37C,OAAOsL,OAAOhN,UACvD,IAAK49C,EAEH,MAAM,IAAIp3C,MACR,2DAGJnD,KAAK66C,aAAeN,EAEpB,MAAMO,EAAe,IAAItsB,GAKzBssB,EAAantB,OAAO,CAAEotB,mBAAmB,IAEzC/6C,KAAKg7C,iBAAmB,IAAIzY,GAAgB,CAC1CvkB,YACAyT,SAAUqpB,IAGZ96C,KAAKC,WAAa,IAAIJ,EAStB,MAAMo7C,EAAa,CAAC,UAAW,YAAa,YAC5C,IAAK,MAAM37C,KAAS27C,EAClBj7C,KAAKC,WAAW5C,IAAIV,SAAS0C,gBAAiBC,GAAO1B,IACnDA,EAAE6gB,iBAAiB,IAOvB,MAAMg2B,EAAQp2C,OAAOg8C,aACjB5F,GA3GR,SAAoCA,GAClC,GAAwC,OAApCA,EAAMxpB,aAAa,aAErB;CAKF,MAAM3X,EAAQ3W,SAASyY,cAAc,SACrC9B,EAAM9H,YAAe,sCACrBipC,EAAMyG,sBAAsB,cAAe5nC,GAE3C,MAAM6nC,EAAsBA,IAAM1G,EAAM/2C,gBAAgB,aACxDy9C,IAIqB,IAAInY,iBAAiBmY,GAC7BlY,QAAQwR,EAAO,CAAEj/B,YAAY,GAC5C,CAyFM4lC,CAA2B3G,GAK7B,MAAM4G,EAAYX,KAEZY,EAAYj9C,OAA+Bk9C,cAEjD,GAAIF,GAAaC,EAAU,CACzB,MAAME,EAAYF,EAASG,OAAOA,OAAO55C,KAAI65C,IAC3C,MAAMv8B,EAAOu8B,EAAM5rC,EAAI,IACjB6b,EAAQ+vB,EAAMzrC,EAAI,IAClBiP,EAAMw8B,EAAM1rC,EAAI,IAChB0b,EAASgwB,EAAMjqC,EAAI,IACzB,OAAO,IAAIwvB,QAAQ9hB,EAAMD,EAAKyM,EAAQxM,EAAMuM,EAASxM,EAAI,IAG3Dlf,KAAK27C,WAAa,IAAI5E,GACpBsE,EACAG,EACAF,EAAS1D,OAQX53C,KAAK27C,WAAW39B,UAAU1K,MAAMqO,OAAS,KAC3C,CACF,CAEA0iB,oBAAoBrhB,GAClB,OAAOhjB,KAAKg7C,iBAAiB3W,oBAAoBrhB,EACnD,CAEAhgB,UAAU,IAAA44C,EACO,QAAfA,EAAI57C,KAAC27C,kBAALC,IAAeA,GAAfA,EAAiB54C,UACjBhD,KAAKC,WAAWY,YAChBb,KAAKg7C,iBAAiBh4C,SACxB,CAEAm1B,OAAO/R,EAAmBqd,GACxB,OAAOzjC,KAAKg7C,iBAAiB7iB,OAAO/R,EAAMqd,EAC5C,CAEAxgC,eAAemjB,EAAmBpD,GAChC,MAAMygB,EAAwBzjC,KAAKg7C,iBAAiB9W,SAAS9d,EAAMpD,IAE7D0wB,IACJA,EACArd,MAAO4T,EACPsB,KAAMsQ,EAASngC,MACfA,EAAK3f,IACLA,SACQiE,KAAK87C,cAAa,GAKtBC,EAA6B,CACjC,CACEh/C,KAAM,sBACN22C,MACA33C,MACA2f,UAoBJ,MAVwB,QADP1b,KAAK66C,aAAamB,cACtBC,QAAyC,iBAAdhS,GACtC8R,EAAex3C,KAAK,CAClBxH,KAAM;AACNs5B,MAAO4T,EACPhtB,MAAO4+B,IAIXpY,EAAUl/B,QAAQw3C,GAEXtY,CACT,CAEAnW,mBACE,OAAOttB,KAAKg7C,iBAAiB1tB,kBAC/B,CAEAkW,cAAce,GAGZ,MAAM8W,EAAYX,KAClB,GAAIW,GAAar7C,KAAK27C,WAAY,CAChC,MAAMO,EAAgBb,EAAUt5B,cAC1B2pB,EAAY1rC,KAAK27C,WAIjBQ,EAAW99C,OAAOijB,WAAaijB,EAAOvrB,MAoB5C,OAlBAmpB,IAAuB,KACjBoC,EAAO/oB,UAAY2gC,EArVL,KAyVhBD,EAAc5oC,MAAM6jC,UAAY,OAChCkE,EAAU/nC,MAAM0F,MAAS,GAAEmjC,QAE3BD,EAAc5oC,MAAM6jC,UAAY,GAChCkE,EAAU/nC,MAAM0F,MAAQ,IAM1B0yB,EAAUoO,YAAY,IAGjBvV,EAAO/oB,QAChB,CACE,OAAOxb,KAAKg7C,iBAAiBxX,cAAce,EAE/C,CAEAthC,oBAEE,MAAO,CACLyY,MAFe1b,KAAK66C,aAAamB,cAEjBtgC,MAChB1P,KAAM,GAEV,CAEAowC,kBAAkBC,GAAqB,IAAAC,EACrC,MAAM/kB,EAAiC,QAAzB+kB,EAAGD,EAAIl+C,OAAO,GAAGo5B,gBAAd+kB,IAAsBA,OAAtBA,EAAAA,EAAwBz0C,MACvCwI,GAAgB,wBAAXA,EAAEtT,OAET,GAAIw6B,SAAAA,EAAUmc,IACZ1zC,KAAK66C,aAAa0B,QAAQhlB,EAASmc,SAC9B,IAAInc,UAAAA,EAAUx7B,IAGnB,MAAM,IAAIoH,MAAM,oCAFhBnD,KAAK66C,aAAa2B,QAjOxB,SAAqBzgD,GAEnB,MAAM0gD,EAAS,IAAIpe,IAAItiC,EAAKY,SAASyhC,SACrC,OAAOqe,EAAOtM,SAAWsM,EAAO3gD,MAClC,CA6NgC4gD,CAAYnlB,EAASx7B,KAGjD,CACF,CAEA4gD,eAGE,OAAO,CACT,CASA15C,mBAAmB25C;AACjB,MAAOC,EAAUC,SAAaz5C,QAAQmoC,IAAI,CACxCxrC,KAAK66C,aAAakC,iBAClBH,EAAe58C,KAAK66C,aAAamC,cAAWj3C,IAMxCk3C,EAAiB,CAAC,cAAe,OACvC,IAAK,MAAMC,KAASD,EAGlB,KAAMC,KAASL,GACb,MAAM,IAAI15C,MAAO,wBAAuB+5C,iBAI5C,IAAIxhC,EAEJ,GAAIohC,EAAK,CAAA,IAAAK,EACPzhC,EAAQmhC,EAASO,aAKjB,MAAMC,EAAU5J,GAAYoJ,EAASnJ,KAC/B4J,EAAmB,QAAXH,EAAGL,EAAI96C,YAAI,IAAAm7C,OAAA,EAARA,EAAUt1C,MACzB01C,GAAS9J,GAAY8J,EAAM7J,OAAS2J,IAElCC,IACF5hC,EAAQ4hC,EAAS5hC,MAErB,CAEA,MAAO,CACLg4B,IAAKmJ,EAASnJ,IACdrd,MAAOwmB,EAASxmB,MAChBkV,KAAMsR,EAAStR,KACf7vB,QAIA3f,IAAK,IAAIsiC,IAAIwe,EAASW,YAAa7gD,SAASyhC,SAASj9B,WAEzD,CAEA8B,oBACE,MAAMywC,IAAEA,EAAG33C,IAAEA,SAAciE,KAAK87C,cAAa,GAC7C,MAAO,CAAEpI,MAAK33C,MAChB,CAEAkH,YACE,MACMw6C,EADWz9C,KAAK66C,aAAamB,cACX0B,KACxB,IAAKD,EACH,MAAM,IAAIt6C,MAAM,0CAElB,MAAQ,kDAAiDs6C,GAC3D,CAEAx6C,qBAAqBk1B,GACnB,OAAOn4B,KAAKg7C,iBAAiB2C,eAAexlB,EAC9C,EC5dK,SAASylB,GAAkB1uC,GAChC,QN8CkD,IADhD7Q,OACuByrC,qBM7CvB,OAAO,IAAI4G,GAAexhC,GAI5B,MAAoB,YADAgrC,KAEX,IAAIS,GAA8Bh+C,SAAS+5B,MAG7C,IAAI6L,GAAgB,CAAE9Q,SAAUviB,EAAUuiB,UACnD,CClBO,SAASosB,GAAclhD,GAC5B,MAAMuqB,EAAYvqB,EAASu1C,eAC3B,IAAKhrB,GAAsC,IAAzBA,EAAU42B,WAC1B,OAAO;CAET,MAAM96B,EAAQkE,EAAUK,WAAW,GACnC,OAAIvE,EAAMuF,UACD,KAEFvF,CACT,CAKO,MAAM+6B,GAaXj+C,YACEuE,EACA41C,EAAsBt9C,UACtBoD,EAAAC,KAAA,wBAAA,GAAAD,EAAAC,KAAA,iBAAA,GAAAD,EAAAC,KAAA,kBAAA,GACA,IAAIg+C,GAAc,EAElBh+C,KAAKi+C,iBAAmB,KAExB,MAAMC,EAAmBA,CAAC1N,EAAQ,MAChCxwC,KAAKi+C,iBAAmB1/C,YAAW,KACjC8F,EAASw5C,GAAc5D,GAAW,GACjCzJ,EAAM,EAGL2N,EAAgB7+C,IAUpB,GATmB,cAAfA,EAAMvC,OACRihD,GAAc,GAEG,YAAf1+C,EAAMvC,OACRihD,GAAc,GAKZA,EACF,OAGFh+C,KAAKo+C,yBAcL,MAAM5N,EAAuB,YAAflxC,EAAMvC,KAAqB,GAAK,IAC9CmhD,EAAiB1N,EAAM,EAGzBxwC,KAAKq+C,UAAYpE,EACjBj6C,KAAKC,WAAa,IAAIJ,EAEtBG,KAAKC,WAAW5C,IAAI48C,EAAW,kBAAmBkE,GAIlDn+C,KAAKC,WAAW5C,IAAI48C,EAAUvjB,KAAM,YAAaynB,GACjDn+C,KAAKC,WAAW5C,IAAI48C,EAAUvjB,KAAM,UAAWynB,GAG/CD,EAAiB,EACnB,CAEA7kB,aACEr5B,KAAKC,WAAWY,YAChBb,KAAKo+C,wBACP,CAEQA,yBACFp+C,KAAKi+C,mBACP3/C,aAAa0B,KAAKi+C,kBAClBj+C,KAAKi+C,iBAAmB,KAE5B,ECxDF,SAASh+B,KACP,MAEMwf,EpC2ED,SACLzc,EACAs7B,GAEA,MAAMC,EAAe,IAAIz3C,IACnB6jC,EAAQ,IAAI7jC,IAkBlB,OAhBA+gB,GAAmB7E,GAAQpN,IACzB,KAAOA,IACD2oC,EAAah3C,IAAIqO,IADP,CAId2oC,EAAalhD,IAAIuY,GAEjB,MAAM24B,EAAO+P,EAAY1oC,GACrB24B,SACF5D,EAAMttC,IAAIkxC,GAGZ34B,EAAUA,EAAQnF,UACpB,KAGK,IAAIk6B,EACb,CoCnGe6T,CAFKngD,OAAO6zC,eACD3qB,WAAW,IAGjCvD,IAAI,IAAAy6B;CAAA,eAAAA,EAAKz6B,EAA6By6B,mBAAW,IAAAA,OAAA,EAAzCA,EAA2CzwB,IAAI,IAEzD,OAAOyR,CACT,CAMA,SAASif,GAAc16B,GACrB,MAAM2mB,EnCiUD,SAAqC3mB,GAC1C,IAAItnB,EACFsnB,EAAKhlB,WAAaC,KAAKqlB,aAClBN,EACDA,EAAKjC,cAEX,MAAMyH,EAAa,GAEnB,KAAO9sB,GACDA,EAAGG,UAAUO,SAAS,yBACxBosB,EAAWjlB,KAAK7H,GAElBA,EAAKA,EAAGqlB,cAGV,OAAOyH,CACT,CmCjVgBm1B,CAA4B36B,GACvCniB,KAAI0O,GAAMA,EAA0BkuC,cACpC1nC,QAAOslC,QAAet2C,IAARs2C,IACdx6C,KAAIw6C,GAAOA,aAAG,EAAHA,EAAKruB,OACnB,OAAO2c,CACT,CAQA,SAASiU,GAAczmB,GACrB,IAAKA,EAAOnV,MACV,OAAO,KAET,IACE,OAAOmV,EAAOnV,MAAM6C,SAGtB,CAFE,MACA,OAAO,IACT,CACF,CAEA,SAASg5B,KAAsB,IAAAC,EACNA,QAAvBA,EAAAniD,SAASu1C,sBAAT4M,IAAuBA,GAAvBA,EAAyBC,iBAC3B,CAiCO,MAAMC,WAAcx5C,EAqEzB1F,YACE0e,EACArT,EAAsB,CAAA,EACtBzI,EAAoBrE,QACpB,IAAA4gD,EAAAC,EAAAC,EAmD8BC,EAAAC,GAlD9B3wB,QAAQ3uB,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,sBAAA,GAAAD,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,6BAAA,GAAAD,EAAAC,KAAA,cAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,uCAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,oBAAA;AAAAD,EAAAC,KAAA,wBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,wBAAA,GAAAD,EAAAC,KAAA,yBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,2BAAA,GAERA,KAAKwe,QAAUA,EACfxe,KAAK6C,WAAaH,EAClB1C,KAAKs/C,oBAAqB,EAC1Bt/C,KAAKu/C,iBAAkB,EACvBv/C,KAAKw/C,iCAAkC,EACvCx/C,KAAKy/C,eAAiB,GAEtBz/C,KAAK0/C,OAAS,IAAI5gC,GAAM9e,KAAKwe,QAAS,CACpCmB,WAAYA,IAAM3f,KAAK2/C,mBACvB9/B,YAAaA,IAAM7f,KAAK2/C,iBAAiB,CAAEhzB,WAAW,IAOtD5M,kBAAmB0f,GACjBz/B,KAAK4/C,kBAAkBngB,EAAM,CAAEogB,gBAAgB,MAGnD7/C,KAAK8/C,mBAAqB,IAAI/B,IAAkB/6B,IAC1CA,EACFhjB,KAAK+/C,aAAa/8B,GAElBhjB,KAAKggD,mBACP,IAGFhgD,KAAK4tB,QAAU,GACf5tB,KAAKigD,aAAe,IAAIn5C,IAIxB9G,KAAKkgD,iBAAmB/0C,EAAO0D,oBAAsB,KAErD7O,KAAKmgD,YAAc,IAAI19C,EAAW,CAChCC,UAAW1C,KAAK6C,WAChBF,OAAQ,QACRC,SAA+Bq8C,QAAvBA,EAAEj/C,KAAKkgD,wBAAgBjB,IAAAA,EAAAA,OAAIl5C,IAGrC/F,KAAKyxB,SAAW,IAAIjD,GACpBxuB,KAAKogD,sBAAwB,IAAI/8C,SAAQC;AACvCtD,KAAKyxB,SAASttB,GAAG,eAAgBb,EAAQ,IAG3CtD,KAAKqgD,aAAezC,GAAkB59C,MACtCA,KAAKqgD,aAAal8C,GAAG,cAAc,IAAMnE,KAAKsgD,sBAC1Cn1C,EAAOgD,qBACwBixC,QAAjCA,GAAAC,EAAAr/C,KAAKqgD,cAAajO,2BAAegN,GAAjCA,EAAAn6C,KAAAo6C,EAAoCl0C,EAAOgD,oBAGI+wC,QAAjDA,GAAIC,EAAIn/C,KAACqgD,cAAa/b,uCAA2B4a,GAA7CA,EAAAj6C,KAAAk6C,KACFn/C,KAAKugD,gBAAkB,IAAIjvB,GACzBtxB,KAAKqgD,aAAa/yB,mBAClB,CACEmE,SAAUzxB,KAAKyxB,YAKrBzxB,KAAKwtB,SAAW,IAAIpkB,EACpBpJ,KAAKwgD,aAAa99C,GAElB1C,KAAKygD,YAAc,IAAIr3C,EACvBpJ,KAAK0gD,kBAEL1gD,KAAK2gD,iBAAmB,IAAItzB,GAAgB,CAC1CC,iBAAkBttB,KAAKqgD,aAAa/yB,mBACpCC,QAASvtB,KAAKwtB,WAGhBxtB,KAAK2iC,mBAAoB,EAGzB3iC,KAAKC,WAAa,IAAIJ,EACtBG,KAAK4gD,sBAEL5gD,KAAK6gD,oBAAsB,IAAI/5C,GACjC,CAIA85C,sBAGE,MAAME,EAAqBtiC,IACrBxe,KAAK2iC,mBAKL+b,GAAclgC,GAASpd,QAI3BpB,KAAKygD,YAAYx7C,KAAK,eAAe,EAGvCjF,KAAKC,WAAW5C,IAAI2C,KAAKwe,QAAS,WAAWlf,IAC3C,MAAMnB,OAAEA,EAAMN,QAAEA,EAAOE,QAAEA,GAAYuB,EAC/BmgC,EAAOif,GAAcvgD,GAC3B,GAAIshC,EAAKr+B,QAAUpB,KAAKs/C,mBAAoB,CAC1C,MAAMj0B,EAASxtB,GAAWE,EAC1BiC,KAAK4/C,kBAAkBngB,EAAM,CAAEpU,UACjC;AAAA,IAGFrrB,KAAKC,WAAW5C,IAAI2C,KAAKwe,QAAS,aAAa,EAAGrgB,aAChD2iD,EAAkB3iD,EAAkB,IAKtC6B,KAAKC,WAAW5C,IAAI2C,KAAKwe,QAAS,cAAc,EAAGrgB,aACjD2iD,EAAkB3iD,EAAkB,IAGtC6B,KAAKC,WAAW5C,IAAI2C,KAAKwe,QAAS,aAAa,EAAGrgB,aAChD,MAAMshC,EAAOif,GAAcvgD,GACvBshC,EAAKr+B,QAAUpB,KAAKs/C,oBACtBt/C,KAAKygD,YAAYx7C,KAAK,mBAAoBw6B,EAC5C,IAGFz/B,KAAKC,WAAW5C,IAAI2C,KAAKwe,QAAS,YAAY,KACxCxe,KAAKs/C,oBACPt/C,KAAKygD,YAAYx7C,KAAK,mBAAoB,GAC5C,IAGFjF,KAAKC,WAAW5C,IAAI2C,KAAKwe,QAAS,WAAWlf,IAC3CU,KAAK+gD,gBAAgBzhD,EAAM,IAG7BU,KAAKC,WAAW5C,IAAIgB,OAAQ,UAAU,IAAM2B,KAAKghD,oBACnD,CAKA/9C,wBAA+C,IAAAg+C,EAAAC,EAAAC,EAAAC,EAAAC,EAC7C,MAAOljB,EAAKQ,EAAU2iB,SAAqBj+C,QAAQmoC,IAAI,CACrDxrC,KAAKqgD,aAAaliB,MAClBn+B,KAAKqgD,aAAarQ,cACWiR,QADEA,GAC/BC,EAAIlhD,KAACqgD,cAAaiB,uBAAWL,SAA7BA,EAAAh8C,KAAAi8C,KAGF,MAAO,CACL/iB,IAAKD,GAAaC,GAClBQ,WACA2iB,cACAC,WAA8CJ,QAApCA,UAAAC,GAAEC,EAAArhD,KAAKqgD,cAAa1D,oBAAY,IAAAyE,OAAA,EAA9BA,EAAAn8C,KAAAo8C,UAAkCF,IAAAA,GAAAA,EAElD,CAGAl+C,0BAA0B,IAAAu+C,EAAAC;CACiBD,QAAzCA,GAAIC,EAAIzhD,KAACqgD,cAAaqB,+BAAmBF,GAArCA,EAAAv8C,KAAAw8C,UACIzhD,KAAKogD,sBAEb,MAAMzhB,QAAiB3+B,KAAK2hD,kBAC5B3hD,KAAKygD,YAAYx7C,KAAK,sBAAuB05B,EAC/C,CAKAqiB,mBAAmB,IAAAY,EACjB,IAA6B,IAAzB5hD,KAAKu/C,gBACP,OAEF,MAAMv8B,EAA6B4+B,QAAxBA,EAAGvjD,OAAO6zC,0BAAc0P,SAArBA,EAAuBr6B,WAAW,GAC5CvE,GACFhjB,KAAK+/C,aAAa/8B,EAEtB,CAEA/f,mBAAmBP,GACjB1C,KAAKwtB,SAASrpB,GAAG,kBAAkB,KAC7B05C,GAAclhD,YAChBqD,KAAKw/C,iCAAkC,EACvCX,KACF,IAGF7+C,KAAKwtB,SAASrpB,GAAG,oBAAoB,IAAMnE,KAAK2/C,qBAEhD3/C,KAAKwtB,SAASrpB,GAAG,oBAAqBs7B,GACpCz/B,KAAK6hD,kBAAkBpiB,KAGzBz/B,KAAKwtB,SAASrpB,GACZ,kCACA,CAACs7B,EAAgB/iB,IACf1c,KAAK8hD,gCAAgCriB,EAAM/iB,KAG/C1c,KAAKwtB,SAASrpB,GAAG,qBAAqB,CAACs7B,EAAgBpU,IACrDrrB,KAAK4/C,kBAAkBngB,EAAM,CAAEpU,aAGjCrrB,KAAKwtB,SAASrpB,GAAG,wBAAyB6uC,ICzYvC,IAA4ByB,EAAOsN,IAAPtN,ED0YNp2C,WC1Ya0jD,ED0YLr/C,ICrY/B+xC,EAAM9qC,SAAWo4C,GAKhBtN,EAAM4F,cAMM5F,EAAM4F,aAAa15B,wBAMpB3H,MAAQy7B,EAAM9qC,OAAO2X,YAFV,KDuXrBthB,KAAKwjC,cAAcwP,EACrB;AAGFhzC,KAAKwtB,SAASrpB,GAAG,SAAS,IAAMnE,KAAK+E,KAAK,sBAI1C,MAAMi9C,QAAiBhiD,KAAKmgD,YAAY8B,SAAS,QACjDjiD,KAAKwtB,SAAS1jB,QAAQk4C,EACxB,CAEA/+C,wBACEjD,KAAKygD,YAAYt8C,GACf,uBACC0qB,GAAmC7uB,KAAKyxB,SAAS9D,OAAOkB,KAK3D7uB,KAAKygD,YAAYt8C,GAAG,oBAAqBs7B,GACvCz/B,KAAK6hD,kBAAkBpiB,KAGzBz/B,KAAKygD,YAAYt8C,GAAG,sBAAuB4pB,IACzC,MAAMoK,EAASn4B,KAAK4tB,QAAQ/lB,MAAKyI,GAAKA,EAAEwd,WAAWE,OAASD,IAC5D,GAAKoK,UAAAA,EAAQ3O,WACX,OAEF,MAAMxG,EAAQ47B,GAAczmB,GAC5B,IAAKnV,EACH,OAMF,MAAM1jB,EAAQ,IAAIC,YAAY,gBAAiB,CAC7C2iD,SAAS,EACTC,YAAY,EACZC,OAAQp/B,IAEkBhjB,KAAKwe,QAAQ7e,cAAcL,IAGrDU,KAAKqgD,aAAa1C,eAAexlB,EACnC,IAIFn4B,KAAKygD,YAAYt8C,GAAG,wBAAyBmJ,IAC3CtN,KAAKqiD,qBAAqB/0C,GAAgB,EAAuB,IAGnEtN,KAAKygD,YAAYt8C,GAAG,oBAAqB4pB,GAAgB/tB,KAAK0oB,OAAOqF,KAErE/tB,KAAKygD,YAAYt8C,GAAG,mBAAoByI,GACtCA,EAAY9L,SAAQgtB,GAAc9tB,KAAKm4B,OAAOrK,OAGhD9tB,KAAKygD,YAAYt8C,GAAG,mBAAoBkqC,IAAuB,IAAAiU,EAAAC,EAAA,eAAAD,GAC7DC,EAAIviD,KAACqgD,cAAajO,uBAAe,IAAAkQ,OAAA,EAAjCA,EAAAr9C,KAAAs9C,EAAoClU,EAAK,IAG3CruC,KAAKygD,YAAYt8C,GAAG,qBAAsB2pB,IAA0B,IAAA00B,EAAAC;CAAA,eAAAD,GAClEC,EAAIziD,KAACqgD,cAAajE,yBAAiB,IAAAoG,OAAA,EAAnCA,EAAAv9C,KAAAw9C,EAAsC30B,EAAW,IAOnD9tB,KAAKmgD,YAAY8B,SAAS,WAAWvrC,MAAKhO,IACxC1I,KAAKygD,YAAY32C,QAAQpB,EAAK,IAGhC1I,KAAKsgD,mBACP,CAEAt9C,UAAU,IAAA0/C,EACR1iD,KAAKmgD,YAAYn9C,UACjBhD,KAAKwtB,SAASxqB,UACdhD,KAAKygD,YAAYz9C,UAEjBhD,KAAKC,WAAWY,YAEhBb,KAAK8/C,mBAAmBzmB,aACxBr5B,KAAK0/C,OAAO18C,UACZhD,KAAK2gD,iBAAiB39C,UACF,QAApB0/C,EAAI1iD,KAACugD,uBAALmC,IAAoBA,GAApBA,EAAsB1/C,UnC3MnB,SAA6BojB,GAElCwE,GADmBjpB,MAAMC,KAAKwkB,EAAK/a,iBAAiB,yBAEtD,CmC0MIs3C,CAAoB3iD,KAAKwe,SAEzBxe,KAAKqgD,aAAar9C,SACpB,CAWAC,aAAa6qB,GAIX,MAgCMnB,EAAawL,IAAmB,IAAAyqB,EACpC,MAAM5/B,EAAQ47B,GAAczmB,GAC5B,IAAKnV,EACH,OAGF,MAAMwG,EAAaV,GACjB9F,UAAK4/B,EACLzqB,EAAOrK,kBAAU,IAAA80B,OAAA,EAAjBA,EAAmBC,UAErBr5B,EAAW1oB,SAAQyP,IACjBA,EAAEkuC,YAActmB,EAAOrK,UAAU,IAEnCqK,EAAO3O,WAAaA,EAEhBxpB,KAAK6gD,oBAAoBt5C,IAAI4wB,EAAOrK,WAAWE,OACjDnD,GAAqBrB,GAAY,EACnC,EAIFxpB,KAAK0oB,OAAOoF,EAAWE,MAAM,GAE7BhuB,KAAKigD,aAAa5iD,IAAIywB,EAAWE,MAG5BF,EAAW3vB,SACd2vB,EAAW3vB,OAAS,IAEtB,MAAMyvB,QAAgBvqB,QAAQmoC,IAAI1d,EAAW3vB,OAAO0D,KA7DrCoB;AAIb,IACG9E,EAAOo5B,WACPp5B,EAAOo5B,SAASviB,MAAK3E,GAAgB,sBAAXA,EAAEtT,OAE7B,MAAO,CAAE+wB,aAAY3vB,UAGvB,IAAIg6B,EACJ,IACE,MAAMnV,QAAchjB,KAAKqgD,aAAaloB,OACpCn4B,KAAKwe,QACLrgB,EAAOo5B,UAMHM,EAAYlS,GAAUgB,UAAU3D,GACtCmV,EAAS,CAAErK,aAAY3vB,SAAQ6kB,MAAO6U,EAGxC,CAFE,MAAOjyB,GACPuyB,EAAS,CAAErK,aAAY3vB,SACzB,CACA,OAAOg6B,CAAM,KAsCf,IAAKn4B,KAAKigD,aAAa14C,IAAIumB,EAAWE,MACpC,MAAO,GAGT,IAAK,MAAMmK,KAAUvK,EACnBjB,EAAUwL,GAeZ,OATArK,EAAWg1B,QACTl1B,EAAQxsB,OAAS,GACjBwsB,EAAQ5W,OAAMmhB,GAAUA,EAAOh6B,OAAOo5B,WAAaY,EAAOnV,QAE5DhjB,KAAK+iD,eAAe/iD,KAAK4tB,QAAQo1B,OAAOp1B,IAAU,GAGlD5tB,KAAKygD,YAAYx7C,KAAK,sBAAuB6oB,GAEtCF,CACT,CAQAlF,OAAOqF,EAAak1B,GAAS,GAC3BjjD,KAAKigD,aAAar/C,OAAOmtB,GAEzB,MAAMH,EAAU,GAChB,IAAK,MAAMuK,KAAUn4B,KAAK4tB,QACpBuK,EAAOrK,WAAWE,OAASD,EAC7BH,EAAQrpB,KAAK4zB,GACJA,EAAO3O,YAChBoB,GAAiBuN,EAAO3O,YAG5BxpB,KAAK+iD,eAAen1B,EAASq1B,EAC/B,CAEAF,eAAen1B,EAAmBq1B,GAAiB,IAAAC,EACjDljD,KAAK4tB,QAAUA,EACK,QAApBs1B,EAAIljD,KAACugD,uBAAL2C,IAAoBA,GAApBA,EAAsBlxB,yBAClBixB,GACFjjD,KAAK2gD,iBAAiBhzB,OAAO3tB,KAAK4tB,QAEtC,CAYA3qB,wBAAuB0pB,UAAEA,GAAY,GAAU,IAC7C,MAAMw2B,EAASnjD,KAAKy/C,eACpBz/C,KAAKy/C,eAAiB;CAEtB,MAAMpR,QAAaruC,KAAK2hD,kBAClBv7B,EAAOpmB,KAAKwe,QAIZrgB,SAHuBkF,QAAQmoC,IACnC2X,EAAOthD,KAAImhB,GAAShjB,KAAKqgD,aAAanc,SAAS9d,EAAMpD,OAEzBnhB,KAAI4hC,IAAc,CAC9C9gC,OAAQ0rC,EAAKlQ,IAIb5G,SAAUkM,MAGN3V,EAA6B,CACjCqQ,IAAKkQ,EAAKlQ,IACVxhC,SAAU0xC,EAAK1P,SACfxgC,SACAilD,WAAYz2B,EACZk2B,SAAUl2B,EAAY,kBAAoB,mBAC1CqB,KAAM,KAAO3sB,EAAkB,IAUjC,OAPArB,KAAKygD,YAAYx7C,KAAK,mBAAoB6oB,GAC1C9tB,KAAKm4B,OAAOrK,GAIZ+wB,KAEO/wB,CACT,CAMA+zB,kBAAkBpiB,GAChBz/B,KAAK6gD,oBAAoB9/C,QACzB0+B,EAAK3+B,SAAQitB,GAAO/tB,KAAK6gD,oBAAoBxjD,IAAI0wB,KAEjD,IAAK,MAAMoK,KAAUn4B,KAAK4tB,QACxB,GAAIuK,EAAO3O,WAAY,CACrB,MAAM6B,EAASoU,EAAKhlB,SAAS0d,EAAOrK,WAAWE,MAC/CnD,GAAqBsN,EAAO3O,WAAY6B,EAC1C,CAGFrrB,KAAKygD,YAAYx7C,KAAK,mBAAoBw6B,EAC5C,CAKAqiB,gCAAgCriB,EAAgB/iB,GAC9C,MAGMoK,EjCjoBH,SAAoC8G,EAASlR,GAClD,IAAI2mC,EAAgB,KAChBC,EAAa,EAEjB,IAAK,IAAInrB,KAAUvK,EAAS,CAAA,IAAAqY,EAC1B,GAAsBA,QAAlBA,EAAC9N,EAAO3O,kBAAPyc,IAAiBA,IAAjBA,EAAmB7kC,OACtB,SAGF,MAAM8d,EAAMyB,GAAsBwX,EAAO3O,YAAYtK,IAGnC,OAAdxC,GAAsBwC,GA1BD,KA+BT,SAAdxC,GACAwC,GAAO7gB,OAAO+iB,YA/BY,MAuCzBiiC,GACc,OAAd3mC,GAAsBwC,EAAMokC,GACd,SAAd5mC,GAAwBwC,EAAMokC,KAM/BD,EAAgBlrB,EAChBmrB,EAAapkC,EAEjB,CAEA,OAAOmkC,CACT,CiCylBoBE,CAHAvjD,KAAK4tB,QAAQ7W,QAAO,EAAG+W,gBACrC2R,EAAKhlB,SAASqT,EAAWE,QAEyBtR,GAChDoK,GACF9mB,KAAKqgD,aAAa1C,eAAe72B,EAErC,CAKAi5B,aAAa/8B;AACX,MAAMwgC,EAAmBxjD,KAAKqgD,aAAahc,oBAAoBrhB,GAC/D,IAAKwgC,EAEH,YADAxjD,KAAKggD,oBAIP,MAAM94B,EAAYvqB,SAASu1C,eACrBuR,EAAcjF,GAA+Bt3B,GAC7Cw8B,EAAYlF,GAA6Bt3B,GAC1Cw8B,GAML1jD,KAAKy/C,eAAiB,CAAC+D,GACvBxjD,KAAKwtB,SAASvoB,KAAK,gBAEnBjF,KAAK0/C,OAAOz/B,wBAA0BA,KACtCjgB,KAAKu/C,iBAAkB,EACvBv/C,KAAK0/C,OAAOt/B,KAAKsjC,EAAWD,IAT1BzjD,KAAKggD,mBAUT,CAEAA,oBACEhgD,KAAKu/C,iBAAkB,EACvBv/C,KAAK0/C,OAAOv/B,OACZngB,KAAKy/C,eAAiB,GAClBz/C,KAAKw/C,iCACPx/C,KAAKwtB,SAASvoB,KAAK,kBAErBjF,KAAKw/C,iCAAkC,CACzC,CAiBAI,kBACEngB,GACApU,OAAEA,GAAS,EAAKw0B,eAAEA,GAAiB,GAAU,IAEzCx0B,EACFrrB,KAAKygD,YAAYx7C,KAAK,4BAA6Bw6B,GAEnDz/B,KAAKygD,YAAYx7C,KAAK,kBAAmBw6B,EAAMogB,GAEjD7/C,KAAKygD,YAAYx7C,KAAK,cACxB,CAUAo9C,qBAAqBsB,EAAkBC,GAAa,InC/Y/C,SAA8Bx9B,EAAmBu9B,GAEtDv9B,EAAKvpB,UAAUwuB,OADa,kCACes4B,EAC7C,CmC6YItB,CAAqBriD,KAAKwe,QAASmlC,GACnC3jD,KAAKs/C,mBAAqBqE,EACtBC,GACF5jD,KAAKwtB,SAASvoB,KAAK,2BAA4B0+C,EAEnD,CAEIE,wBACF,OAAO7jD,KAAKs/C,kBACd,CAOA9b,cAAcwP;AACZhzC,KAAK2iC,kBAAoB3iC,KAAKqgD,aAAa7c,cAAcwP,EAC3D,CASI8Q,uBACF,OAAO9jD,KAAK2iC,iBACd,CAMIohB,4BACF,OAAO/jD,KAAK6gD,mBACd,CAKAE,gBAAgBzhD,GACViY,GAAcjY,EAAO,iBACvBU,KAAKqiD,sBAAsBriD,KAAKs/C,mBAEpC,EEzyBK,SAAS0E,GAAkBC,EAAS94C,GACzC,MAAMpP,EAAM,IAAIsiC,IAAI4lB,GACdC,EAAS,IAAIC,gBAGnB,OAFAD,EAAO15B,OAAO,SAAUpoB,KAAKC,UAAU8I,IACvCpP,EAAIqoD,KAAOF,EAAO/iD,WACXpF,EAAIoF,UACb,CCZO,SAASkjD,GACdC,EACAn5C,GACyB,IAAAo5C,EACzB,MAAMpT,EAAqC,CAAA,EAE3C,IAAK,MAAOniC,EAAKrE,KAAUrI,OAAOysB,QAAQ5jB,GAM5B,mBAAR6D,GAAoC,kBAARA,GAQnB,MAATrE,IAIJwmC,EAAUniC,GAAOrE,GAKnBwmC,EAAU3pC,OAAS,IAAI62B,IAAIimB,GAAQ98C,OAInC2pC,EAAUroC,QAAU,WAGpB,MAAM07C,EAAU,IAAInmB,IAAIhgC,OAAOyO,SAASZ,MAQxC,GAPAs4C,EAAQJ,KAAO,GACfjT,EAAUqT,QAAUA,EAAQrjD,WAMxBQ,MAAM2I,QAAQ6mC,EAAUviC,YAA+B,QAAlB21C,EAAApT,EAAUviC,gBAAQ,IAAA21C,OAAA,EAAlBA,EAAoBnjD,QAAS,EAAG,CACvE,MAAMqjD,EAAUtT,EAAUviC,SAAS,GAC/B61C,EAAQC,iBACVD,EAAQE,wBAAyB,GAE/BF,EAAQG,kBACVH,EAAQI,yBAA0B,GAEhCJ,EAAQK,kBACVL,EAAQM,yBAA0B,GAEhCN,EAAQO,mBACVP,EAAQQ,0BAA2B,GAEjCR,EAAQS,gBACVT,EAAQU,uBAAwB,EAEpC,CAEA,OAAOhU,CACT;AC7CA,SAASiU,IAAej6C,OAAEA,EAAMk6C,QAAEA,IAQhC,OACExoC,GAAA,SAAA,CACEnB,MAAO,iCACPR,UAAU,yBAMVoqC,iBAAe,EACf3W,IAjBmBqV,GAAkB74C,EAAOiC,eAAgB,IAC3Di3C,GAAgBl5C,EAAOiC,eAAgBjC,GAG1C8B,MAAOo4C,KAgBX,CASe,SAASE,IAAclb,SACpCA,EAAQl/B,OACRA,IAMA,MAAOq6C,EAAWC,GAAgBj1B,GAAS,IACpCd,EAAUg2B,GAAel1B,IAAS,IAClC60B,EAASM,GAAcn1B,GAAwB,MAChDo1B,EAAgCC,GAAO,IACvCC,EAAaD,GAAuB,MAI1C1tC,IAAU,KACRytC,EAA8BhwC,QAAUjZ,SAAS+5B,KAAKpjB,MAAM+oB,SAErD,KACL1/B,SAAS+5B,KAAKpjB,MAAM+oB,SAAWupB,EAA8BhwC,OAAO,IAErE,IAIHuC,IAAU,KAENxb,SAAS+5B,KAAKpjB,MAAM+oB,SADlB3M,EAC6Bk2B,EAA8BhwC,QAE9B,QACjC,GACC,CAAC8Z,IAEJvX,IAAU,KACR,MAAM4tC,EAAU1b,EAAS2b,gBAQzB,OAPAD,EAAQE,UAAU,gBAAiBZ,IACjCK,GAAY,GACZD,GAAaD,GAAaA,EAAY,IACtCG,EAAWN,EAAQ,IAErBS,EAAWlwC,QAAUmwC,EAEd,KACLA,EAAQ/iD,SAAS,CAClB,GACA,CAACqnC,IAOJ,OAAgB,OAAZgb,EACK,KAIPxoC,GAAA,MAAA,CACE3B,UAAWC,GACT,4DACA,CAAE+qC,OAAQx2B,IAEZ,cAAY,iBAAgBne,SAE5B4L,GAAA,MAAA,CAAKjC,UAAU,yBAAyB,cAAY,iBAAgB3J,UAClEsL,GAAA,MAAA,CAAK3B,UAAU,uBAAsB3J,SACnCsL,GAACspC,GAAU,CACTzqC,MAAM,qBACNwB,QArBMkpC,KAAM,IAAAC,EACpBX,GAAY;AACM,QAAlBW,EAAAP,EAAWlwC,eAAO,IAAAywC,GAAlBA,EAAoBC,QAAQ,gBAAgB,EAoBpCtrC,QAAQ,OACRX,QAASc,GAKP,4CACA5J,SAEFsL,GAACtD,GAAU,CAAC2B,UAAU,gBAG1B2B,GAACuoC,GAAc,CAAiBj6C,OAAQA,EAAQk6C,QAASA,GAApCG,OAI7B,CCrIO,MAAMe,GAQXzmD,YACE0e,EACA6rB,EACAl/B,GACApL,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,mBAAA,GAKAA,KAAK+e,gBAAkBpiB,SAASyY,cAAc,uBAC9CoJ,EAAQxL,YAAYhT,KAAK+e,iBACzB/e,KAAKgf,YAAcjB,GAAiB/d,KAAK+e,iBAEzChL,GACE8I,GAAC0oC,GAAa,CAAClb,SAAUA,EAAUl/B,OAAQA,IAC3CnL,KAAKgf,YAET,CAEAhc,UACE+Q,GAAO,KAAM/T,KAAKgf,aAClBhf,KAAK+e,gBAAgBthB,QACvB,ECzBa,SAAS+oD,IAAanc,SAAEA,EAAQl/B,OAAEA,IAC/C,MAAOukB,EAAUg2B,GAAel1B,IAAS,GACnCs1B,EAAaD,GAAuB,MAE1C1tC,IAAU,KACR,MAAM4tC,EAAU1b,EAAS2b,gBAMzB,OALAD,EAAQE,UAAU,eAAe,KAC/BP,GAAY,EAAM,IAEpBI,EAAWlwC,QAAUmwC,EAEd,KACLA,EAAQ/iD,SAAS,CAClB,GACA,CAACqnC,IAOJ,OAAI3a,EACK,KAIP7S,GAAA,MAAA,CACE3B,UAAU,4DACV,cAAY,gBAAe3J,SAE3B4L,GAAA,MAAA,CAAKjC,UAAU,yBAAyB,cAAY,gBAAe3J,UACjEsL,GAAA,MAAA,CAAK3B,UAAU,uBAAsB3J,SACnCsL,GAACspC,GAAU;AACTzqC,MAAM,oBACNwB,QAlBMkpC,KAAM,IAAAC,EACpBX,GAAY,GACM,QAAlBW,EAAAP,EAAWlwC,eAAO,IAAAywC,GAAlBA,EAAoBC,QAAQ,eAAe,EAiBnCtrC,QAAQ,OACRX,QAASc,GAKP,4CACA5J,SAEFsL,GAACtD,GAAU,CAAC2B,UAAU,gBAG1B2B,GAAA,SAAA,CACEnB,MAAO,qBACPR,UAAU,yBACVyzB,IAAKxjC,EAAOkC,oBAKtB,CC5DO,MAAMo5C,GAIX3mD,YAAY0e,EAAsB6rB,EAAoBl/B,GAAuBpL,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,kBAAA,GAC3EA,KAAK+e,gBAAkBpiB,SAASyY,cAAc,sBAC9CoJ,EAAQxL,YAAYhT,KAAK+e,iBACzB/e,KAAKie,WAAaF,GAAiB/d,KAAK+e,iBAExChL,GACE8I,GAAC2pC,GAAY,CAACnc,SAAUA,EAAUl/B,OAAQA,IAC1CnL,KAAKie,WAET,CAEAjb,UACE+Q,GAAO,KAAM/T,KAAKie,YAClBje,KAAK+e,gBAAgBthB,QACvB,6ECrBF,SAAUY,EAAQ1B,EAAU+pD,EAAY3gD,GAGxC,IA+FI0F,EA/FAk7C,EAAkB,CAAC,GAAI,SAAU,MAAO,KAAM,KAAM,KACpDC,EAAejqD,EAASyY,cAAc,OAItCyxC,EAAQ9lC,KAAK8lC,MACbrxB,EAAMzU,KAAKyU,IACXkG,EAAMD,KAAKC,IASf,SAASorB,EAAkBtiD,EAAI6qC,EAASppC,GACpC,OAAO1H,WAAWwoD,EAAOviD,EAAIyB,GAAUopC,EAC1C,CAWD,SAAS2X,EAAe1sC,EAAK9V,EAAIyB,GAC7B,QAAItE,MAAM2I,QAAQgQ,KACd2sC,EAAK3sC,EAAKrU,EAAQzB,GAAKyB,IAChB,EAGd,CAQD,SAASghD,EAAKC,EAAKC,EAAUlhD,GACzB,IAAId;CAEJ,GAAK+hD,EAIL,GAAIA,EAAIpmD,QACJomD,EAAIpmD,QAAQqmD,EAAUlhD,QACnB,GAAIihD,EAAI9lD,SAAW2E,EAEtB,IADAZ,EAAI,EACGA,EAAI+hD,EAAI9lD,QACX+lD,EAASliD,KAAKgB,EAASihD,EAAI/hD,GAAIA,EAAG+hD,GAClC/hD,SAGJ,IAAKA,KAAK+hD,EACNA,EAAIt7C,eAAezG,IAAMgiD,EAASliD,KAAKgB,EAASihD,EAAI/hD,GAAIA,EAAG+hD,EAGtE,CASD,SAASE,EAAUz+C,EAAQvE,EAAMjC,GAC7B,IAAIklD,EAAqB,sBAAwBjjD,EAAO,KAAOjC,EAAU,SACzE,OAAO,WACH,IAAIvE,EAAI,IAAIuF,MAAM,mBACd0C,EAAQjI,GAAKA,EAAEiI,MAAQjI,EAAEiI,MAAM2N,QAAQ,kBAAmB,IACzDA,QAAQ,cAAe,IACvBA,QAAQ,6BAA8B,kBAAoB,sBAE3DwpB,EAAM3+B,EAAOgI,UAAYhI,EAAOgI,QAAQC,MAAQjI,EAAOgI,QAAQ22B,KAInE,OAHIA,GACAA,EAAI/3B,KAAK5G,EAAOgI,QAASghD,EAAoBxhD,GAE1C8C,EAAO/D,MAAM5E,KAAM6E,UAClC,CACC,CAWG4G,EADyB,mBAAlBnJ,OAAOmJ,OACL,SAAgBtN,GACrB,GAAIA,IAAW4H,GAAwB,OAAX5H,EACxB,MAAM,IAAIiqC,UAAU,8CAIxB,IADA,IAAIe,EAAS7mC,OAAOnE,GACXk4B,EAAQ,EAAGA,EAAQxxB,UAAUzD,OAAQi1B,IAAS,CACnD,IAAI1zB,EAASkC,UAAUwxB,GACvB,GAAI1zB,IAAWoD,GAAwB,OAAXpD,EACxB,IAAK,IAAI2kD,KAAW3kD,EACZA,EAAOiJ,eAAe07C,KACtBne,EAAOme,GAAW3kD,EAAO2kD,GAIxC,CACD,OAAOne,CACf,EAEa7mC,OAAOmJ,OAWpB,IAAI87C,EAASH,GAAU,SAAgBI,EAAM7Y,EAAK8Y,GAG9C,IAFA,IAAIllD,EAAOD,OAAOC,KAAKosC,GACnBxpC,EAAI,EACDA,EAAI5C,EAAKnB,UACPqmD,GAAUA,GAASD,EAAKjlD,EAAK4C,MAAQY,KACtCyhD,EAAKjlD,EAAK4C,IAAMwpC,EAAIpsC,EAAK4C,KAE7BA,IAEJ,OAAOqiD,CACX,GAAG,SAAU,iBASTC,EAAQL,GAAU,SAAeI,EAAM7Y,GACvC,OAAO4Y,EAAOC,EAAM7Y,GAAK;AAC7B,GAAG,QAAS,iBAQZ,SAAS+Y,EAAQlxB,EAAO5kB,EAAM+1C,GAC1B,IACIC,EADAC,EAAQj2C,EAAK1N,WAGjB0jD,EAASpxB,EAAMtyB,UAAY5B,OAAOwlD,OAAOD,IAClC/nD,YAAc02B,EACrBoxB,EAAOG,OAASF,EAEZF,GACAl8C,EAAOm8C,EAAQD,EAEtB,CAQD,SAASZ,EAAOviD,EAAIyB,GAChB,OAAO,WACH,OAAOzB,EAAGI,MAAMqB,EAASpB,UACjC,CACC,CASD,SAASmjD,EAAS/mD,EAAKmH,GACnB,MA1LgB,mBA0LLnH,EACAA,EAAI2D,MAAMwD,GAAOA,EAAK,IAAkBrC,EAAWqC,GAEvDnH,CACV,CAQD,SAASgnD,EAAYC,EAAMC,GACvB,OAAQD,IAASniD,EAAaoiD,EAAOD,CACxC,CAQD,SAASE,EAAkBjqD,EAAQgmC,EAAO77B,GACtC2+C,EAAKoB,EAASlkB,IAAQ,SAASpnC,GAC3BoB,EAAOQ,iBAAiB5B,EAAMuL,GAAS,EAC/C,GACC,CAQD,SAASggD,EAAqBnqD,EAAQgmC,EAAO77B,GACzC2+C,EAAKoB,EAASlkB,IAAQ,SAASpnC,GAC3BoB,EAAOW,oBAAoB/B,EAAMuL,GAAS,EAClD,GACC,CASD,SAASigD,EAAUvkC,EAAMra,GACrB,KAAOqa,GAAM,CACT,GAAIA,GAAQra,EACR,OAAO,EAEXqa,EAAOA,EAAKvT,UACf,CACD,OAAO,CACV,CAQD,SAAS+3C,EAAMtnD,EAAK2G,GAChB,OAAO3G,EAAIwQ,QAAQ7J,IAAS,CAC/B,CAOD,SAASwgD,EAASnnD,GACd,OAAOA,EAAI0J,OAAO8M,MAAM,OAC3B,CASD,SAAS+wC,EAAQ9Z,EAAK9mC,EAAM6gD,GACxB,GAAI/Z,EAAIj9B,UAAYg3C,EAChB,OAAO/Z,EAAIj9B,QAAQ7J,GAGnB,IADA,IAAI1C,EAAI,EACDA,EAAIwpC,EAAIvtC,QAAQ,CACnB,GAAKsnD,GAAa/Z,EAAIxpC,GAAGujD,IAAc7gD,IAAW6gD,GAAa/Z,EAAIxpC,KAAO0C,EACtE,OAAO1C,EAEXA,GACH,CACD,OAAQ,CAEf,CAOD,SAASwjD,EAAQzB,GACb,OAAOvlD,MAAMuC,UAAUc,MAAMC,KAAKiiD,EAAK,EAC1C,CASD,SAAS0B,EAAYja,EAAK3/B,EAAKxM,GAK3B,IAJA,IAAIsiB,EAAU,GACVxV,EAAS,GACTnK,EAAI,EAEDA,EAAIwpC,EAAIvtC,QAAQ,CACnB,IAAIH,EAAM+N,EAAM2/B,EAAIxpC,GAAG6J,GAAO2/B,EAAIxpC,GAC9BsjD,EAAQn5C,EAAQrO,GAAO,GACvB6jB,EAAQvgB,KAAKoqC,EAAIxpC,IAErBmK,EAAOnK,GAAKlE,EACZkE,GACH,CAYD,OAVI3C,IAIIsiB,EAHC9V,EAGS8V,EAAQtiB,MAAK,SAAyB8N,EAAGmB,GAC/C,OAAOnB,EAAEtB,GAAOyC,EAAEzC,EAClC,IAJsB8V,EAAQtiB,QAQnBsiB,CACV,CAQD,SAAS+jC,EAAS3B,EAAKjlD;AAKnB,IAJA,IAAIkzB,EAAQ2zB,EACRC,EAAY9mD,EAAS,GAAGq0B,cAAgBr0B,EAAS+C,MAAM,GAEvDG,EAAI,EACDA,EAAIwhD,EAAgBvlD,QAAQ,CAI/B,IAFA0nD,GADA3zB,EAASwxB,EAAgBxhD,IACPgwB,EAAS4zB,EAAY9mD,KAE3BilD,EACR,OAAO4B,EAEX3jD,GACH,CACD,OAAOY,CACV,CAMD,IAAIijD,EAAY,EAUhB,SAASC,EAAoBzqC,GACzB,IAAIy2B,EAAMz2B,EAAQa,eAAiBb,EACnC,OAAQy2B,EAAI31B,aAAe21B,EAAIiU,cAAgB7qD,CAClD,CAED,IAEI8qD,EAAiB,iBAAkB9qD,EACnC+qD,EAAyBP,EAASxqD,EAAQ,kBAAoB0H,EAC9DsjD,EAAqBF,GAJN,wCAIoC/1C,KAAK/J,UAAUL,WAElEsgD,EAAmB,QAEnBC,EAAmB,QAiBnBC,EAAqBC,GAGrBC,EAAW,CAAC,IAAK,KACjBC,EAAkB,CAAC,UAAW,WASlC,SAASC,EAAMC,EAASxlD,GACpB,IAAIK,EAAO1E,KACXA,KAAK6pD,QAAUA,EACf7pD,KAAKqE,SAAWA,EAChBrE,KAAKwe,QAAUqrC,EAAQrrC,QACvBxe,KAAK7B,OAAS0rD,EAAQvpD,QAAQwpD,YAI9B9pD,KAAK+pD,WAAa,SAASC,GACnBhC,EAAS6B,EAAQvpD,QAAQ2pD,OAAQ,CAACJ,KAClCnlD,EAAK4D,QAAQ0hD,EAEzB,EAEIhqD,KAAKkqD,MAER,CA0DD,SAASC,EAAaN,EAASzpD,EAAWiwB,GACtC,IAAI+5B,EAAc/5B,EAAMg6B,SAASjpD,OAC7BkpD,EAAqBj6B,EAAMk6B,gBAAgBnpD,OAC3CopD,EAvGU,EAuGCpqD,GAA4BgqD,EAAcE,GAAuB,EAC5EG,EAAoB,GAATrqD,GAA2CgqD,EAAcE,GAAuB,EAE/Fj6B,EAAMm6B,UAAYA,EAClBn6B,EAAMo6B,UAAYA,EAEdD,IACAX,EAAQa,QAAU,IAKtBr6B,EAAMjwB,UAAYA,EAiBtB,SAA0BypD,EAASx5B,GAC/B,IAAIq6B,EAAUb,EAAQa,QAClBL,EAAWh6B,EAAMg6B,SACjBM,EAAiBN,EAASjpD,OAGzBspD,EAAQE,aACTF,EAAQE,WAAaC,EAAqBx6B,IAI1Cs6B,EAAiB,IAAMD,EAAQI,cAC/BJ,EAAQI,cAAgBD,EAAqBx6B,GACnB,IAAnBs6B,IACPD,EAAQI,eAAgB,GAG5B,IAAIF,EAAaF,EAAQE,WACrBE,EAAgBJ,EAAQI,cACxBC,EAAeD,EAAgBA,EAAcE,OAASJ,EAAWI,OAEjEA,EAAS36B,EAAM26B,OAASC,EAAUZ,GACtCh6B,EAAM66B,UAAYxvB,IAClBrL,EAAM86B,UAAY96B,EAAM66B,UAAYN,EAAWM;AAE/C76B,EAAM+6B,MAAQC,EAASN,EAAcC,GACrC36B,EAAMi7B,SAAWC,EAAYR,EAAcC,GA0B/C,SAAwBN,EAASr6B,GAC7B,IAAI26B,EAAS36B,EAAM26B,OACf/mC,EAASymC,EAAQ5nC,aAAe,GAChC0oC,EAAYd,EAAQc,WAAa,GACjCC,EAAYf,EAAQe,WAAa,GA5LvB,IA8LVp7B,EAAMjwB,WA5LE,IA4L2BqrD,EAAUrrD,YAC7CorD,EAAYd,EAAQc,UAAY,CAC5Bj5C,EAAGk5C,EAAUC,QAAU,EACvBl5C,EAAGi5C,EAAUE,QAAU,GAG3B1nC,EAASymC,EAAQ5nC,YAAc,CAC3BvQ,EAAGy4C,EAAOz4C,EACVC,EAAGw4C,EAAOx4C,IAIlB6d,EAAMq7B,OAASF,EAAUj5C,GAAKy4C,EAAOz4C,EAAI0R,EAAO1R,GAChD8d,EAAMs7B,OAASH,EAAUh5C,GAAKw4C,EAAOx4C,EAAIyR,EAAOzR,EACnD,CA5CGo5C,CAAelB,EAASr6B,GACxBA,EAAMw7B,gBAAkBC,EAAaz7B,EAAMq7B,OAAQr7B,EAAMs7B,QAEzD,IAAII,EAAkBC,EAAY37B,EAAM86B,UAAW96B,EAAMq7B,OAAQr7B,EAAMs7B,QACvEt7B,EAAM47B,iBAAmBF,EAAgBx5C,EACzC8d,EAAM67B,iBAAmBH,EAAgBv5C,EACzC6d,EAAM07B,gBAAmBv2B,EAAIu2B,EAAgBx5C,GAAKijB,EAAIu2B,EAAgBv5C,GAAMu5C,EAAgBx5C,EAAIw5C,EAAgBv5C,EAEhH6d,EAAM87B,MAAQrB,GAkNA9gD,EAlNyB8gD,EAAcT,SAkNhCzkC,EAlN0CykC,EAmNxDkB,EAAY3lC,EAAI,GAAIA,EAAI,GAAI+jC,GAAmB4B,EAAYvhD,EAAM,GAAIA,EAAM,GAAI2/C,IAnNX,EAC3Et5B,EAAM+7B,SAAWtB,EAsMrB,SAAqB9gD,EAAO4b,GACxB,OAAOylC,EAASzlC,EAAI,GAAIA,EAAI,GAAI+jC,GAAmB0B,EAASrhD,EAAM,GAAIA,EAAM,GAAI2/C,EACnF,CAxMoC0C,CAAYvB,EAAcT,SAAUA,GAAY,EAEjFh6B,EAAMi8B,YAAe5B,EAAQe,UAAsCp7B,EAAMg6B,SAASjpD,OAC9EspD,EAAQe,UAAUa,YAAej8B,EAAMg6B,SAASjpD,OAASspD,EAAQe,UAAUa,YADtCj8B,EAAMg6B,SAASjpD,OAwC5D,SAAkCspD,EAASr6B,GACvC,IAEIk8B,EAAUC,EAAWC,EAAW/vC,EAFhCgwC,EAAOhC,EAAQiC,cAAgBt8B,EAC/B86B,EAAY96B,EAAM66B,UAAYwB,EAAKxB,UAGvC,GArNe,GAqNX76B,EAAMjwB,YAA8B+qD,EA1NrB,IA0NqDuB,EAAKH,WAAaxmD,GAAY,CAClG,IAAI2lD,EAASr7B,EAAMq7B,OAASgB,EAAKhB,OAC7BC,EAASt7B,EAAMs7B,OAASe,EAAKf,OAE7Bn7C,EAAIw7C,EAAYb,EAAWO,EAAQC,GACvCa,EAAYh8C,EAAE+B,EACdk6C,EAAYj8C,EAAEgC,EACd+5C,EAAY/2B,EAAIhlB,EAAE+B,GAAKijB,EAAIhlB,EAAEgC,GAAMhC,EAAE+B,EAAI/B,EAAEgC,EAC3CkK,EAAYovC,EAAaJ,EAAQC,GAEjCjB,EAAQiC,aAAet8B,CAC/B,MAEQk8B,EAAWG,EAAKH,SAChBC,EAAYE,EAAKF,UACjBC,EAAYC,EAAKD,UACjB/vC,EAAYgwC,EAAKhwC,UAGrB2T,EAAMk8B,SAAWA;AACjBl8B,EAAMm8B,UAAYA,EAClBn8B,EAAMo8B,UAAYA,EAClBp8B,EAAM3T,UAAYA,CACrB,CAjEGkwC,CAAyBlC,EAASr6B,GA4MtC,IAAkBrmB,EAAO4b,EAzMrB,IAAIznB,EAAS0rD,EAAQrrC,QACjB+pC,EAAUl4B,EAAMw8B,SAAS1uD,OAAQA,KACjCA,EAASkyB,EAAMw8B,SAAS1uD,QAE5BkyB,EAAMlyB,OAASA,CAClB,CAhEG2uD,CAAiBjD,EAASx5B,GAG1Bw5B,EAAQ9kD,KAAK,eAAgBsrB,GAE7Bw5B,EAAQkD,UAAU18B,GAClBw5B,EAAQa,QAAQe,UAAYp7B,CAC/B,CAyHD,SAASw6B,EAAqBx6B,GAK1B,IAFA,IAAIg6B,EAAW,GACXllD,EAAI,EACDA,EAAIkrB,EAAMg6B,SAASjpD,QACtBipD,EAASllD,GAAK,CACV6nD,QAASnG,EAAMx2B,EAAMg6B,SAASllD,GAAG6nD,SACjCC,QAASpG,EAAMx2B,EAAMg6B,SAASllD,GAAG8nD,UAErC9nD,IAGJ,MAAO,CACH+lD,UAAWxvB,IACX2uB,SAAUA,EACVW,OAAQC,EAAUZ,GAClBqB,OAAQr7B,EAAMq7B,OACdC,OAAQt7B,EAAMs7B,OAErB,CAOD,SAASV,EAAUZ,GACf,IAAIM,EAAiBN,EAASjpD,OAG9B,GAAuB,IAAnBupD,EACA,MAAO,CACHp4C,EAAGs0C,EAAMwD,EAAS,GAAG2C,SACrBx6C,EAAGq0C,EAAMwD,EAAS,GAAG4C,UAK7B,IADA,IAAI16C,EAAI,EAAGC,EAAI,EAAGrN,EAAI,EACfA,EAAIwlD,GACPp4C,GAAK83C,EAASllD,GAAG6nD,QACjBx6C,GAAK63C,EAASllD,GAAG8nD,QACjB9nD,IAGJ,MAAO,CACHoN,EAAGs0C,EAAMt0C,EAAIo4C,GACbn4C,EAAGq0C,EAAMr0C,EAAIm4C,GAEpB,CASD,SAASqB,EAAYb,EAAW54C,EAAGC,GAC/B,MAAO,CACHD,EAAGA,EAAI44C,GAAa,EACpB34C,EAAGA,EAAI24C,GAAa,EAE3B,CAQD,SAASW,EAAav5C,EAAGC,GACrB,OAAID,IAAMC,EAzTO,EA6TbgjB,EAAIjjB,IAAMijB,EAAIhjB,GACPD,EAAI,EA7TE,EACC,EA8TXC,EAAI,EA7TI,EACE,EA6TpB,CASD,SAAS+4C,EAAY2B,EAAIC,EAAIv8C,GACpBA,IACDA,EAAQ84C,GAEZ,IAAIn3C,EAAI46C,EAAGv8C,EAAM,IAAMs8C,EAAGt8C,EAAM,IAC5B4B,EAAI26C,EAAGv8C,EAAM,IAAMs8C,EAAGt8C,EAAM,IAEhC,OAAOmQ,KAAKqsC,KAAM76C,EAAIA,EAAMC,EAAIA,EACnC,CASD,SAAS64C,EAAS6B,EAAIC,EAAIv8C,GACjBA,IACDA,EAAQ84C,GAEZ,IAAIn3C,EAAI46C,EAAGv8C,EAAM,IAAMs8C,EAAGt8C,EAAM,IAC5B4B,EAAI26C,EAAGv8C,EAAM,IAAMs8C,EAAGt8C,EAAM,IAChC,OAA0B,IAAnBmQ,KAAKssC,MAAM76C,EAAGD,GAAWwO,KAAKusC,EACxC,CA3TD1D,EAAM1lD,UAAY,CAKdoE,QAAS,WAAc,EAKvB4hD,KAAM,WACFlqD,KAAKutD,MAAQnF,EAAkBpoD,KAAKwe,QAASxe,KAAKutD,KAAMvtD,KAAK+pD;AAC7D/pD,KAAKwtD,UAAYpF,EAAkBpoD,KAAK7B,OAAQ6B,KAAKwtD,SAAUxtD,KAAK+pD,YACpE/pD,KAAKytD,OAASrF,EAAkBa,EAAoBjpD,KAAKwe,SAAUxe,KAAKytD,MAAOztD,KAAK+pD,WACvF,EAKD/mD,QAAS,WACLhD,KAAKutD,MAAQjF,EAAqBtoD,KAAKwe,QAASxe,KAAKutD,KAAMvtD,KAAK+pD,YAChE/pD,KAAKwtD,UAAYlF,EAAqBtoD,KAAK7B,OAAQ6B,KAAKwtD,SAAUxtD,KAAK+pD,YACvE/pD,KAAKytD,OAASnF,EAAqBW,EAAoBjpD,KAAKwe,SAAUxe,KAAKytD,MAAOztD,KAAK+pD,WAC1F,GA2TL,IAAI2D,EAAkB,CAClBC,UA/Xc,EAgYdC,UA/Xa,EAgYbC,QA/XY,GAkYZC,EAAuB,YACvBC,EAAsB,oBAO1B,SAASC,IACLhuD,KAAKutD,KAAOO,EACZ9tD,KAAKytD,MAAQM,EAEb/tD,KAAKyb,SAAU,EAEfmuC,EAAMhlD,MAAM5E,KAAM6E,UACrB,CAED6iD,EAAQsG,EAAYpE,EAAO,CAKvBthD,QAAS,SAAmB0hD,GACxB,IAAI5pD,EAAYstD,EAAgB1D,EAAGjtD,MA3ZzB,EA8ZNqD,GAAyC,IAAd4pD,EAAGiE,SAC9BjuD,KAAKyb,SAAU,GA9ZV,EAiaLrb,GAAuC,IAAb4pD,EAAGkE,QAC7B9tD,EAjaI,GAqaHJ,KAAKyb,UAraF,EAyaJrb,IACAJ,KAAKyb,SAAU,GAGnBzb,KAAKqE,SAASrE,KAAK6pD,QAASzpD,EAAW,CACnCiqD,SAAU,CAACL,GACXO,gBAAiB,CAACP,GAClBmE,YAAa5E,EACbsD,SAAU7C,IAEjB,IAGL,IAAIoE,EAAoB,CACpBC,YAzbc,EA0bdC,YAzba,EA0bbC,UAzbY,EA0bZC,cAzbe,EA0bfC,WA1be,GA8bfC,EAAyB,CACzB,EAAGpF,EACH,EAzciB,MA0cjB,EAAGC,EACH,EAzcoB,UA4cpBoF,GAAyB,cACzBC,GAAwB,sCAa5B,SAASC,KACL7uD,KAAKutD,KAAOoB,GACZ3uD,KAAKytD,MAAQmB,GAEbhF,EAAMhlD,MAAM5E,KAAM6E,WAElB7E,KAAK8uD,MAAS9uD,KAAK6pD,QAAQa,QAAQqE,cAAgB,EACtD;AAjBG1wD,EAAO2wD,iBAAmB3wD,EAAO4wD,eACjCN,GAAyB,gBACzBC,GAAwB,6CAiB5BlH,EAAQmH,GAAmBjF,EAAO,CAK9BthD,QAAS,SAAmB0hD,GACxB,IAAI8E,EAAQ9uD,KAAK8uD,MACbI,GAAgB,EAEhBC,EAAsBnF,EAAGjtD,KAAKgC,cAAcyU,QAAQ,KAAM,IAC1DpT,EAAYguD,EAAkBe,GAC9BhB,EAAcO,EAAuB1E,EAAGmE,cAAgBnE,EAAGmE,YAE3DiB,EAAWjB,GAAe7E,EAG1B+F,EAAa5G,EAAQqG,EAAO9E,EAAGsF,UAAW,aA/epC,EAkfNlvD,IAA0C,IAAd4pD,EAAGiE,QAAgBmB,GAC3CC,EAAa,IACbP,EAAMvqD,KAAKylD,GACXqF,EAAaP,EAAM1tD,OAAS,GAEhB,GAAThB,IACP8uD,GAAgB,GAIhBG,EAAa,IAKjBP,EAAMO,GAAcrF,EAEpBhqD,KAAKqE,SAASrE,KAAK6pD,QAASzpD,EAAW,CACnCiqD,SAAUyE,EACVvE,gBAAiB,CAACP,GAClBmE,YAAaA,EACbtB,SAAU7C,IAGVkF,GAEAJ,EAAMz4C,OAAOg5C,EAAY,GAEhC,IAGL,IAAIE,GAAyB,CACzBC,WAlhBc,EAmhBdC,UAlhBa,EAmhBbC,SAlhBY,EAmhBZC,YAlhBe,GAqhBfC,GAA6B,aAC7BC,GAA6B,4CAOjC,SAASC,KACL9vD,KAAKwtD,SAAWoC,GAChB5vD,KAAKytD,MAAQoC,GACb7vD,KAAK+vD,SAAU,EAEfnG,EAAMhlD,MAAM5E,KAAM6E,UACrB,CAqCD,SAASmrD,GAAuBhG,EAAIjtD,GAChC,IAAIyuC,EAAMmd,EAAQqB,EAAGiG,SACjBC,EAAUvH,EAAQqB,EAAGmG,gBAMzB,OAJQ,GAAJpzD,IACAyuC,EAAMod,EAAYpd,EAAIwX,OAAOkN,GAAU,cAAc,IAGlD,CAAC1kB,EAAK0kB,EAChB,CA5CDxI,EAAQoI,GAAkBlG,EAAO,CAC7BthD,QAAS,SAAmB0hD,GACxB,IAAIjtD,EAAOwyD,GAAuBvF,EAAGjtD,MAOrC,GAjjBU,IA6iBNA,IACAiD,KAAK+vD,SAAU,GAGd/vD,KAAK+vD,QAAV,CAIA,IAAIE,EAAUD,GAAuB/qD,KAAKjF,KAAMgqD,EAAIjtD,GAGxC,GAARA,GAAqCkzD,EAAQ,GAAG7uD,OAAS6uD,EAAQ,GAAG7uD,QAAW,IAC/EpB,KAAK+vD,SAAU,GAGnB/vD,KAAKqE,SAASrE,KAAK6pD,QAAS9sD,EAAM,CAC9BstD,SAAU4F,EAAQ,GAClB1F,gBAAiB0F,EAAQ,GACzB9B,YAAa7E;AACbuD,SAAU7C,GAbb,CAeJ,IAoBL,IAAIoG,GAAkB,CAClBZ,WAvlBc,EAwlBdC,UAvlBa,EAwlBbC,SAvlBY,EAwlBZC,YAvlBe,GA0lBfU,GAAsB,4CAO1B,SAASC,KACLtwD,KAAKwtD,SAAW6C,GAChBrwD,KAAKuwD,UAAY,GAEjB3G,EAAMhlD,MAAM5E,KAAM6E,UACrB,CAyBD,SAAS2rD,GAAWxG,EAAIjtD,GACpB,IAAI0zD,EAAa9H,EAAQqB,EAAGiG,SACxBM,EAAYvwD,KAAKuwD,UAGrB,GAAY,EAARxzD,GAA2D,IAAtB0zD,EAAWrvD,OAEhD,OADAmvD,EAAUE,EAAW,GAAGvwB,aAAc,EAC/B,CAACuwB,EAAYA,GAGxB,IAAItrD,EACAurD,EACAP,EAAiBxH,EAAQqB,EAAGmG,gBAC5BQ,EAAuB,GACvBxyD,EAAS6B,KAAK7B,OAQlB,GALAuyD,EAAgBD,EAAW15C,QAAO,SAAS65C,GACvC,OAAOrI,EAAUqI,EAAMzyD,OAAQA,EACvC,IArpBkB,IAwpBVpB,EAEA,IADAoI,EAAI,EACGA,EAAIurD,EAActvD,QACrBmvD,EAAUG,EAAcvrD,GAAG+6B,aAAc,EACzC/6B,IAMR,IADAA,EAAI,EACGA,EAAIgrD,EAAe/uD,QAClBmvD,EAAUJ,EAAehrD,GAAG+6B,aAC5BywB,EAAqBpsD,KAAK4rD,EAAehrD,IAIrC,GAAJpI,UACOwzD,EAAUJ,EAAehrD,GAAG+6B,YAEvC/6B,IAGJ,OAAKwrD,EAAqBvvD,OAInB,CAEHwnD,EAAY8H,EAAc1N,OAAO2N,GAAuB,cAAc,GACtEA,QAPJ,CASH,CA5EDjJ,EAAQ4I,GAAY1G,EAAO,CACvBthD,QAAS,SAAoB0hD,GACzB,IAAIjtD,EAAOqzD,GAAgBpG,EAAGjtD,MAC1BkzD,EAAUO,GAAWvrD,KAAKjF,KAAMgqD,EAAIjtD,GACnCkzD,GAILjwD,KAAKqE,SAASrE,KAAK6pD,QAAS9sD,EAAM,CAC9BstD,SAAU4F,EAAQ,GAClB1F,gBAAiB0F,EAAQ,GACzB9B,YAAa7E,EACbuD,SAAU7C,GAEjB,IA6EL,SAAS6G,KACLjH,EAAMhlD,MAAM5E,KAAM6E,WAElB,IAAIyD,EAAUy+C,EAAO/mD,KAAKsI,QAAStI,MACnCA,KAAK4wD,MAAQ,IAAIN,GAAWtwD,KAAK6pD,QAASvhD,GAC1CtI,KAAK8wD,MAAQ,IAAI9C,EAAWhuD,KAAK6pD,QAASvhD,GAE1CtI,KAAK+wD,aAAe,KACpB/wD,KAAKgxD,YAAc,EACtB,CAoCD,SAASC,GAAc7wD,EAAW8wD,GAnvBhB,EAovBV9wD,GACAJ,KAAK+wD,aAAeG,EAAU3G,gBAAgB,GAAGrqB;AACjDixB,GAAalsD,KAAKjF,KAAMkxD,IACR,GAAT9wD,GACP+wD,GAAalsD,KAAKjF,KAAMkxD,EAE/B,CAED,SAASC,GAAaD,GAClB,IAAIN,EAAQM,EAAU3G,gBAAgB,GAEtC,GAAIqG,EAAM1wB,aAAelgC,KAAK+wD,aAAc,CACxC,IAAIK,EAAY,CAAC7+C,EAAGq+C,EAAM5D,QAASx6C,EAAGo+C,EAAM3D,SAC5CjtD,KAAKgxD,YAAYzsD,KAAK6sD,GACtB,IAAIC,EAAMrxD,KAAKgxD,YAOfzyD,YANsB,WAClB,IAAI4G,EAAIksD,EAAI3/C,QAAQ0/C,GAChBjsD,GAAK,GACLksD,EAAIh7C,OAAOlR,EAAG,EAE9B,GArEoB,KAuEf,CACJ,CAED,SAASmsD,GAAiBJ,GAEtB,IADA,IAAI3+C,EAAI2+C,EAAUrE,SAASG,QAASx6C,EAAI0+C,EAAUrE,SAASI,QAClD9nD,EAAI,EAAGA,EAAInF,KAAKgxD,YAAY5vD,OAAQ+D,IAAK,CAC9C,IAAI6K,EAAIhQ,KAAKgxD,YAAY7rD,GACrBosD,EAAKxwC,KAAKyU,IAAIjjB,EAAIvC,EAAEuC,GAAIi/C,EAAKzwC,KAAKyU,IAAIhjB,EAAIxC,EAAEwC,GAChD,GAAI++C,GA9ES,IA8EeC,GA9Ef,GA+ET,OAAO,CAEd,CACD,OAAO,CACV,CAtED9J,EAAQmJ,GAAiBjH,EAAO,CAO5BthD,QAAS,SAAoBuhD,EAAS4H,EAAYC,GAC9C,IAAItC,EAAWsC,EAAUvD,aAAe7E,EACpCqI,EAAWD,EAAUvD,aAAe5E,EAExC,KAAIoI,GAAWD,EAAUE,oBAAsBF,EAAUE,mBAAmBC,kBAA5E,CAKA,GAAIzC,EACA6B,GAAchsD,KAAKjF,KAAMyxD,EAAYC,QAClC,GAAIC,GAAWL,GAAiBrsD,KAAKjF,KAAM0xD,GAC9C,OAGJ1xD,KAAKqE,SAASwlD,EAAS4H,EAAYC,EATlC,CAUJ,EAKD1uD,QAAS,WACLhD,KAAK4wD,MAAM5tD,UACXhD,KAAK8wD,MAAM9tD,SACd,IAyCL,IAAI8uD,GAAwBjJ,EAASjC,EAAatzC,MAAO,eACrDy+C,GAAsBD,KAA0B/rD,EAGhDisD,GAAuB,UACvBC,GAAoB,OACpBC,GAA4B,eAC5BC,GAAoB,OACpBC,GAAqB,QACrBC,GAAqB,QACrBC,GA4IJ,WACI,IAAKP,GACD,OAAO,EAEX,IAAIQ,EAAW,CAAA,EACXC,EAAcn0D,EAAOo0D,KAAOp0D,EAAOo0D,IAAIC,SAO3C,MANA,CAAC,OAAQ,eAAgB,QAAS,QAAS,cAAe,QAAQ5xD,SAAQ,SAASG;AAI/EsxD,EAAStxD,IAAOuxD,GAAcn0D,EAAOo0D,IAAIC,SAAS,eAAgBzxD,EAC1E,IACWsxD,CACV,CAzJsBI,GASvB,SAASC,GAAY/I,EAASl/C,GAC1B3K,KAAK6pD,QAAUA,EACf7pD,KAAKS,IAAIkK,EACZ,CAEDioD,GAAY1uD,UAAY,CAKpBzD,IAAK,SAASkK,GAENA,GAASqnD,KACTrnD,EAAQ3K,KAAK6yD,WAGbd,IAAuB/xD,KAAK6pD,QAAQrrC,QAAQlL,OAASg/C,GAAiB3nD,KACtE3K,KAAK6pD,QAAQrrC,QAAQlL,MAAMw+C,IAAyBnnD,GAExD3K,KAAK8yD,QAAUnoD,EAAM5L,cAAc6L,MACtC,EAKD+iB,OAAQ,WACJ3tB,KAAKS,IAAIT,KAAK6pD,QAAQvpD,QAAQyyD,YACjC,EAMDF,QAAS,WACL,IAAIC,EAAU,GAMd,OALA7L,EAAKjnD,KAAK6pD,QAAQmJ,aAAa,SAASC,GAChCjL,EAASiL,EAAW3yD,QAAQ2pD,OAAQ,CAACgJ,MACrCH,EAAUA,EAAQ9P,OAAOiQ,EAAWC,kBAEpD,IA8DA,SAA2BJ,GAEvB,GAAItK,EAAMsK,EAASX,IACf,OAAOA,GAGX,IAAIgB,EAAU3K,EAAMsK,EAASV,IACzBgB,EAAU5K,EAAMsK,EAAST,IAM7B,GAAIc,GAAWC,EACX,OAAOjB,GAIX,GAAIgB,GAAWC,EACX,OAAOD,EAAUf,GAAqBC,GAI1C,GAAI7J,EAAMsK,EAASZ,IACf,OAAOA,GAGX,OAAOD,EACV,CAzFcoB,CAAkBP,EAAQhxD,KAAK,KACzC,EAMDwxD,gBAAiB,SAASjjC,GACtB,IAAIw8B,EAAWx8B,EAAMw8B,SACjBnwC,EAAY2T,EAAMw7B,gBAGtB,GAAI7rD,KAAK6pD,QAAQa,QAAQ6I,UACrB1G,EAAS2G,qBADb,CAKA,IAAIV,EAAU9yD,KAAK8yD,QACfW,EAAUjL,EAAMsK,EAASX,MAAuBG,GAAkC,KAClFc,EAAU5K,EAAMsK,EAAST,MAAwBC,GAAiBD,SAClEc,EAAU3K,EAAMsK,EAASV,MAAwBE,GAAiBF,SAEtE,GAAIqB,EAAS,CAGT,IAAIC,EAAyC,IAA1BrjC,EAAMg6B,SAASjpD,OAC9BuyD,EAAgBtjC,EAAMi7B,SAAW,EACjCsI,EAAiBvjC,EAAM86B,UAAY,IAEvC,GAAIuI,GAAgBC,GAAiBC,EACjC,MAEP,CAED,IAAIT,IAAWC,EAKf,OAAIK,GACCL,GAj3BcS,EAi3BHn3C,GACXy2C,GAAWz2C,EAAY8sC,EACjBxpD,KAAK8zD,WAAWjH,QAH3B,CAxBC,CA6BJ,EAMDiH,WAAY,SAASjH,GACjB7sD,KAAK6pD,QAAQa,QAAQ6I,WAAY;AACjC1G,EAAS2G,gBACZ,GAgFL,IAMIO,GAAe,GAQnB,SAASC,GAAW1zD,GAChBN,KAAKM,QAAUmL,EAAO,CAAE,EAAEzL,KAAKi0D,SAAU3zD,GAAW,CAAA,GAEpDN,KAAK6vB,GApgCEm5B,IAsgCPhpD,KAAK6pD,QAAU,KAGf7pD,KAAKM,QAAQ2pD,OAAShC,EAAYjoD,KAAKM,QAAQ2pD,QAAQ,GAEvDjqD,KAAKkU,MAxBY,EA0BjBlU,KAAKk0D,aAAe,GACpBl0D,KAAKm0D,YAAc,EACtB,CAoOD,SAASC,GAASlgD,GACd,OA5PkB,GA4PdA,EACO,SA/PG,EAgQHA,EACA,MAlQK,EAmQLA,EACA,OArQG,EAsQHA,EACA,QAEJ,EACV,CAOD,SAASmgD,GAAa33C,GAClB,OAnuCiB,IAmuCbA,EACO,OAruCI,GAsuCJA,EACA,KAzuCM,GA0uCNA,EACA,OA1uCO,GA2uCPA,EACA,QAEJ,EACV,CAQD,SAAS43C,GAA6BC,EAAiBtB,GACnD,IAAIpJ,EAAUoJ,EAAWpJ,QACzB,OAAIA,EACOA,EAAQlpD,IAAI4zD,GAEhBA,CACV,CAOD,SAASC,KACLR,GAAWpvD,MAAM5E,KAAM6E,UAC1B,CA4DD,SAAS4vD,KACLD,GAAe5vD,MAAM5E,KAAM6E,WAE3B7E,KAAK00D,GAAK,KACV10D,KAAK20D,GAAK,IACb,CA2ED,SAASC,KACLJ,GAAe5vD,MAAM5E,KAAM6E,UAC9B,CAqCD,SAASgwD,KACLb,GAAWpvD,MAAM5E,KAAM6E,WAEvB7E,KAAK80D,OAAS,KACd90D,KAAK+0D,OAAS,IACjB,CAkED,SAASC,KACLR,GAAe5vD,MAAM5E,KAAM6E,UAC9B,CA6BD,SAASowD,KACLT,GAAe5vD,MAAM5E,KAAM6E,UAC9B,CA0DD,SAASqwD,KACLlB,GAAWpvD,MAAM5E,KAAM6E,WAIvB7E,KAAKm1D,OAAQ,EACbn1D,KAAKo1D,SAAU,EAEfp1D,KAAK80D,OAAS,KACd90D,KAAK+0D,OAAS,KACd/0D,KAAKgpC,MAAQ,CAChB,CAoGD,SAASqsB,GAAO72C,EAASle,GAGrB,OAFAA,EAAUA,GAAW,IACb0yD,YAAc/K,EAAY3nD,EAAQ0yD,YAAaqC,GAAOpB,SAASqB,QAChE,IAAIC,GAAQ/2C,EAASle,EAC/B,CA9tBD0zD,GAAW9vD,UAAY,CAKnB+vD,SAAU,CAAE,EAOZxzD,IAAK,SAASH,GAKV,OAJAmL,EAAOzL,KAAKM,QAASA;AAGrBN,KAAK6pD,SAAW7pD,KAAK6pD,QAAQkJ,YAAYplC,SAClC3tB,IACV,EAODw1D,cAAe,SAASjB,GACpB,GAAIvN,EAAeuN,EAAiB,gBAAiBv0D,MACjD,OAAOA,KAGX,IAAIk0D,EAAel0D,KAAKk0D,aAMxB,OAJKA,GADLK,EAAkBD,GAA6BC,EAAiBv0D,OAC9B6vB,MAC9BqkC,EAAaK,EAAgB1kC,IAAM0kC,EACnCA,EAAgBiB,cAAcx1D,OAE3BA,IACV,EAODy1D,kBAAmB,SAASlB,GACxB,OAAIvN,EAAeuN,EAAiB,oBAAqBv0D,QAIzDu0D,EAAkBD,GAA6BC,EAAiBv0D,aACzDA,KAAKk0D,aAAaK,EAAgB1kC,KAJ9B7vB,IAMd,EAOD01D,eAAgB,SAASnB,GACrB,GAAIvN,EAAeuN,EAAiB,iBAAkBv0D,MAClD,OAAOA,KAGX,IAAIm0D,EAAcn0D,KAAKm0D,YAMvB,OAJ+C,IAA3C1L,EAAQ0L,EADZI,EAAkBD,GAA6BC,EAAiBv0D,SAE5Dm0D,EAAY5vD,KAAKgwD,GACjBA,EAAgBmB,eAAe11D,OAE5BA,IACV,EAOD21D,mBAAoB,SAASpB,GACzB,GAAIvN,EAAeuN,EAAiB,qBAAsBv0D,MACtD,OAAOA,KAGXu0D,EAAkBD,GAA6BC,EAAiBv0D,MAChE,IAAIq2B,EAAQoyB,EAAQzoD,KAAKm0D,YAAaI,GAItC,OAHIl+B,GAAS,GACTr2B,KAAKm0D,YAAY99C,OAAOggB,EAAO,GAE5Br2B,IACV,EAMD41D,mBAAoB,WAChB,OAAO51D,KAAKm0D,YAAY/yD,OAAS,CACpC,EAODy0D,iBAAkB,SAAStB,GACvB,QAASv0D,KAAKk0D,aAAaK,EAAgB1kC,GAC9C,EAOD9qB,KAAM,SAASsrB,GACX,IAAI3rB,EAAO1E,KACPkU,EAAQlU,KAAKkU,MAEjB,SAASnP,EAAKzF,GACVoF,EAAKmlD,QAAQ9kD,KAAKzF,EAAO+wB,EAC5B,CAGGnc,EArJM,GAsJNnP,EAAKL,EAAKpE,QAAQhB,MAAQ80D,GAASlgD,IAGvCnP,EAAKL,EAAKpE,QAAQhB,OAEd+wB,EAAMylC,iBACN/wD,EAAKsrB,EAAMylC,iBAIX5hD,GAhKM,GAiKNnP,EAAKL,EAAKpE,QAAQhB,MAAQ80D,GAASlgD,GAE1C,EAQD6hD,QAAS,SAAS1lC;AACd,GAAIrwB,KAAKg2D,UACL,OAAOh2D,KAAK+E,KAAKsrB,GAGrBrwB,KAAKkU,MAAQ6/C,EAChB,EAMDiC,QAAS,WAEL,IADA,IAAI7wD,EAAI,EACDA,EAAInF,KAAKm0D,YAAY/yD,QAAQ,CAChC,QAAMpB,KAAKm0D,YAAYhvD,GAAG+O,OACtB,OAAO,EAEX/O,GACH,CACD,OAAO,CACV,EAMD4nD,UAAW,SAAS2E,GAGhB,IAAIuE,EAAiBxqD,EAAO,CAAE,EAAEimD,GAGhC,IAAK1J,EAAShoD,KAAKM,QAAQ2pD,OAAQ,CAACjqD,KAAMi2D,IAGtC,OAFAj2D,KAAKsuB,aACLtuB,KAAKkU,MAAQ6/C,IAKH,GAAV/zD,KAAKkU,QACLlU,KAAKkU,MAvNI,GA0NblU,KAAKkU,MAAQlU,KAAKk2D,QAAQD,GAIR,GAAdj2D,KAAKkU,OACLlU,KAAK+1D,QAAQE,EAEpB,EASDC,QAAS,SAASxE,GAAc,EAOhCwB,eAAgB,WAAc,EAO9B5kC,MAAO,WAAc,GA8DzBo5B,EAAQ8M,GAAgBR,GAAY,CAKhCC,SAAU,CAKN5J,SAAU,GASd8L,SAAU,SAAS9lC,GACf,IAAI+lC,EAAiBp2D,KAAKM,QAAQ+pD,SAClC,OAA0B,IAAnB+L,GAAwB/lC,EAAMg6B,SAASjpD,SAAWg1D,CAC5D,EAQDF,QAAS,SAAS7lC,GACd,IAAInc,EAAQlU,KAAKkU,MACb9T,EAAYiwB,EAAMjwB,UAElBi2D,IAAeniD,EACfoiD,EAAUt2D,KAAKm2D,SAAS9lC,GAG5B,OAAIgmC,IAlzCO,EAkzCUj2D,IAA6Bk2D,GAvVpC,GAwVHpiD,EACAmiD,GAAgBC,EArzCnB,EAszCAl2D,EA5VE,EA6VK8T,EA/VL,EAgWOA,EA/VL,EAkWDA,EAnWD,EAqWH6/C,EACV,IAgBLrM,EAAQ+M,GAAeD,GAAgB,CAKnCP,SAAU,CACN30D,MAAO,MACPi3D,UAAW,GACXlM,SAAU,EACV3tC,UA50CY85C,IA+0ChBtD,eAAgB,WACZ,IAAIx2C,EAAY1c,KAAKM,QAAQoc,UACzBo2C,EAAU,GAOd,OA11CmBe,EAo1Cfn3C,GACAo2C,EAAQvuD,KAAK8tD,IAEb31C,EAAY8sC,GACZsJ,EAAQvuD,KAAK6tD,IAEVU,CACV,EAED2D,cAAe,SAASpmC,GACpB,IAAI/vB,EAAUN,KAAKM,QACfo2D,GAAW,EACXpL,EAAWj7B,EAAMi7B,SACjB5uC,EAAY2T,EAAM3T,UAClBnK,EAAI8d,EAAMq7B,OACVl5C,EAAI6d,EAAMs7B,OAed,OAZMjvC,EAAYpc,EAAQoc,YAt2CPm3C,EAu2CXvzD,EAAQoc,WACRA,EAAmB,IAANnK,EA92CR,EA82CqCA,EAAI,EA72CzC,EACC;AA62CNmkD,EAAWnkD,GAAKvS,KAAK00D,GACrBpJ,EAAWvqC,KAAKyU,IAAInF,EAAMq7B,UAE1BhvC,EAAmB,IAANlK,EAl3CR,EAk3CqCA,EAAI,EA/2C3C,EACE,GA+2CLkkD,EAAWlkD,GAAKxS,KAAK20D,GACrBrJ,EAAWvqC,KAAKyU,IAAInF,EAAMs7B,UAGlCt7B,EAAM3T,UAAYA,EACXg6C,GAAYpL,EAAWhrD,EAAQi2D,WAAa75C,EAAYpc,EAAQoc,SAC1E,EAEDy5C,SAAU,SAAS9lC,GACf,OAAOmkC,GAAetwD,UAAUiyD,SAASlxD,KAAKjF,KAAMqwB,KAva1C,EAwaLrwB,KAAKkU,SAxaA,EAwa0BlU,KAAKkU,QAAwBlU,KAAKy2D,cAAcpmC,GACvF,EAEDtrB,KAAM,SAASsrB,GAEXrwB,KAAK00D,GAAKrkC,EAAMq7B,OAChB1rD,KAAK20D,GAAKtkC,EAAMs7B,OAEhB,IAAIjvC,EAAY23C,GAAahkC,EAAM3T,WAE/BA,IACA2T,EAAMylC,gBAAkB91D,KAAKM,QAAQhB,MAAQod,GAEjD1c,KAAK+nD,OAAOhjD,KAAKE,KAAKjF,KAAMqwB,EAC/B,IAaLq3B,EAAQkN,GAAiBJ,GAAgB,CAKrCP,SAAU,CACN30D,MAAO,QACPi3D,UAAW,EACXlM,SAAU,GAGd6I,eAAgB,WACZ,MAAO,CAACf,GACX,EAEDgE,SAAU,SAAS9lC,GACf,OAAOrwB,KAAK+nD,OAAOoO,SAASlxD,KAAKjF,KAAMqwB,KAClCtP,KAAKyU,IAAInF,EAAM87B,MAAQ,GAAKnsD,KAAKM,QAAQi2D,WApdpC,EAodiDv2D,KAAKkU,MACnE,EAEDnP,KAAM,SAASsrB,GACX,GAAoB,IAAhBA,EAAM87B,MAAa,CACnB,IAAIwK,EAAQtmC,EAAM87B,MAAQ,EAAI,KAAO,MACrC97B,EAAMylC,gBAAkB91D,KAAKM,QAAQhB,MAAQq3D,CAChD,CACD32D,KAAK+nD,OAAOhjD,KAAKE,KAAKjF,KAAMqwB,EAC/B,IAgBLq3B,EAAQmN,GAAiBb,GAAY,CAKjCC,SAAU,CACN30D,MAAO,QACP+qD,SAAU,EACV9tD,KAAM,IACNg6D,UAAW,GAGfrD,eAAgB,WACZ,MAAO,CAACjB,GACX,EAEDiE,QAAS,SAAS7lC,GACd,IAAI/vB,EAAUN,KAAKM,QACfs2D,EAAgBvmC,EAAMg6B,SAASjpD,SAAWd,EAAQ+pD,SAClDwM,EAAgBxmC,EAAMi7B,SAAWhrD,EAAQi2D,UACzCO,EAAYzmC,EAAM86B,UAAY7qD,EAAQ/D,KAM1C,GAJAyD,KAAK+0D,OAAS1kC;CAITwmC,IAAkBD,GAAqC,GAAnBvmC,EAAMjwB,YAA2C02D,EACtF92D,KAAKsuB,aACF,GAn+CG,EAm+CC+B,EAAMjwB,UACbJ,KAAKsuB,QACLtuB,KAAK80D,OAAShO,GAAkB,WAC5B9mD,KAAKkU,MA1gBH,EA2gBFlU,KAAK+1D,SACrB,GAAez1D,EAAQ/D,KAAMyD,WACd,GAv+CC,EAu+CGqwB,EAAMjwB,UACb,OA9gBM,EAghBV,OAAO2zD,EACV,EAEDzlC,MAAO,WACHhwB,aAAa0B,KAAK80D,OACrB,EAED/vD,KAAM,SAASsrB,GAvhBD,IAwhBNrwB,KAAKkU,QAILmc,GAt/CI,EAs/CMA,EAAMjwB,UAChBJ,KAAK6pD,QAAQ9kD,KAAK/E,KAAKM,QAAQhB,MAAQ,KAAM+wB,IAE7CrwB,KAAK+0D,OAAO7J,UAAYxvB,IACxB17B,KAAK6pD,QAAQ9kD,KAAK/E,KAAKM,QAAQhB,MAAOU,KAAK+0D,SAElD,IAaLrN,EAAQsN,GAAkBR,GAAgB,CAKtCP,SAAU,CACN30D,MAAO,SACPi3D,UAAW,EACXlM,SAAU,GAGd6I,eAAgB,WACZ,MAAO,CAACf,GACX,EAEDgE,SAAU,SAAS9lC,GACf,OAAOrwB,KAAK+nD,OAAOoO,SAASlxD,KAAKjF,KAAMqwB,KAClCtP,KAAKyU,IAAInF,EAAM+7B,UAAYpsD,KAAKM,QAAQi2D,WAlkBnC,EAkkBgDv2D,KAAKkU,MAClE,IAaLwzC,EAAQuN,GAAiBT,GAAgB,CAKrCP,SAAU,CACN30D,MAAO,QACPi3D,UAAW,GACXhK,SAAU,GACV7vC,UAAW85C,GACXnM,SAAU,GAGd6I,eAAgB,WACZ,OAAOuB,GAAcvwD,UAAUgvD,eAAejuD,KAAKjF,KACtD,EAEDm2D,SAAU,SAAS9lC,GACf,IACIk8B,EADA7vC,EAAY1c,KAAKM,QAAQoc,UAW7B,OARa,GAATA,EACA6vC,EAAWl8B,EAAM07B,gBArjDF8H,EAsjDRn3C,EACP6vC,EAAWl8B,EAAM47B,iBACVvvC,EAAY8sC,IACnB+C,EAAWl8B,EAAM67B;AAGdlsD,KAAK+nD,OAAOoO,SAASlxD,KAAKjF,KAAMqwB,IACnC3T,EAAY2T,EAAMw7B,iBAClBx7B,EAAMi7B,SAAWtrD,KAAKM,QAAQi2D,WAC9BlmC,EAAMi8B,aAAetsD,KAAKM,QAAQ+pD,UAClC70B,EAAI+2B,GAAYvsD,KAAKM,QAAQisD,UAzkDzB,EAykDqCl8B,EAAMjwB,SACtD,EAED2E,KAAM,SAASsrB,GACX,IAAI3T,EAAY23C,GAAahkC,EAAMw7B,iBAC/BnvC,GACA1c,KAAK6pD,QAAQ9kD,KAAK/E,KAAKM,QAAQhB,MAAQod,EAAW2T,GAGtDrwB,KAAK6pD,QAAQ9kD,KAAK/E,KAAKM,QAAQhB,MAAO+wB,EACzC,IA0BLq3B,EAAQwN,GAAelB,GAAY,CAK/BC,SAAU,CACN30D,MAAO,MACP+qD,SAAU,EACV0M,KAAM,EACNC,SAAU,IACVz6D,KAAM,IACNg6D,UAAW,EACXU,aAAc,IAGlB/D,eAAgB,WACZ,MAAO,CAAChB,GACX,EAEDgE,QAAS,SAAS7lC,GACd,IAAI/vB,EAAUN,KAAKM,QAEfs2D,EAAgBvmC,EAAMg6B,SAASjpD,SAAWd,EAAQ+pD,SAClDwM,EAAgBxmC,EAAMi7B,SAAWhrD,EAAQi2D,UACzCW,EAAiB7mC,EAAM86B,UAAY7qD,EAAQ/D,KAI/C,GAFAyD,KAAKsuB,QAzoDK,EA2oDL+B,EAAMjwB,WAA4C,IAAfJ,KAAKgpC,MACzC,OAAOhpC,KAAKm3D,cAKhB,GAAIN,GAAiBK,GAAkBN,EAAe,CAClD,GAhpDI,GAgpDAvmC,EAAMjwB,UACN,OAAOJ,KAAKm3D,cAGhB,IAAIC,GAAgBp3D,KAAKm1D,OAAS9kC,EAAM66B,UAAYlrD,KAAKm1D,MAAQ70D,EAAQ02D,SACrEK,GAAiBr3D,KAAKo1D,SAAW7J,EAAYvrD,KAAKo1D,QAAS/kC,EAAM26B,QAAU1qD,EAAQ22D,aAgBvF,GAdAj3D,KAAKm1D,MAAQ9kC,EAAM66B,UACnBlrD,KAAKo1D,QAAU/kC,EAAM26B,OAEhBqM,GAAkBD,EAGnBp3D,KAAKgpC,OAAS,EAFdhpC,KAAKgpC,MAAQ,EAKjBhpC,KAAK+0D,OAAS1kC,EAKG,IADFrwB,KAAKgpC,MAAQ1oC,EAAQy2D,KAIhC,OAAK/2D,KAAK41D,sBAGN51D,KAAK80D,OAAShO,GAAkB,WAC5B9mD,KAAKkU,MAltBX,EAmtBMlU,KAAK+1D,SAC7B,GAAuBz1D,EAAQ02D,SAAUh3D;AAttBvB,GAEA,CAwtBT,CACD,OAAO+zD,EACV,EAEDoD,YAAa,WAIT,OAHAn3D,KAAK80D,OAAShO,GAAkB,WAC5B9mD,KAAKkU,MAAQ6/C,EAChB,GAAE/zD,KAAKM,QAAQ02D,SAAUh3D,MACnB+zD,EACV,EAEDzlC,MAAO,WACHhwB,aAAa0B,KAAK80D,OACrB,EAED/vD,KAAM,WAvuBQ,GAwuBN/E,KAAKkU,QACLlU,KAAK+0D,OAAOuC,SAAWt3D,KAAKgpC,MAC5BhpC,KAAK6pD,QAAQ9kD,KAAK/E,KAAKM,QAAQhB,MAAOU,KAAK+0D,QAElD,IAkBLM,GAAO9sD,QAAU,QAMjB8sD,GAAOpB,SAAW,CAOdsD,WAAW,EAQXxE,YAAaf,GAMb/H,QAAQ,EASRH,YAAa,KAOb0N,WAAY,KAOZlC,OAAQ,CAEJ,CAACN,GAAkB,CAAC/K,QAAQ,IAC5B,CAAC2K,GAAiB,CAAC3K,QAAQ,GAAQ,CAAC,WACpC,CAACgL,GAAiB,CAACv4C,UArwDAm3C,IAswDnB,CAACY,GAAe,CAAC/3C,UAtwDEm3C,GAswDgC,CAAC,UACpD,CAACqB,IACD,CAACA,GAAe,CAAC51D,MAAO,YAAay3D,KAAM,GAAI,CAAC,QAChD,CAAClC,KAQL4C,SAAU,CAMNC,WAAY,OAOZC,YAAa,OASbC,aAAc,OAOdC,eAAgB,OAOhBC,SAAU,OAQVC,kBAAmB,kBAa3B,SAASxC,GAAQ/2C,EAASle,GAzwD1B,IAA6BupD,EA0wDzB7pD,KAAKM,QAAUmL,EAAO,CAAE,EAAE4pD,GAAOpB,SAAU3zD,GAAW,CAAA,GAEtDN,KAAKM,QAAQwpD,YAAc9pD,KAAKM,QAAQwpD,aAAetrC,EAEvDxe,KAAKg4D,SAAW,GAChBh4D,KAAK0qD,QAAU,GACf1qD,KAAKgzD,YAAc,GACnBhzD,KAAKi4D,YAAc,GAEnBj4D,KAAKwe,QAAUA,EACfxe,KAAKqwB,MArwDE,KAfkBw5B,EAoxDQ7pD,MAlxDRM,QAAQk3D,aAItBpO,EACAyF,GACAxF,EACAiH,GACCnH,EAGD0H,GAFA7C,IAIOnE,EAASM,GAswD3BnqD,KAAK+yD,YAAc,IAAIH,GAAY5yD,KAAMA,KAAKM,QAAQyyD,aAEtDmF,GAAel4D,MAAM;AAErBinD,EAAKjnD,KAAKM,QAAQ0yD,aAAa,SAASzkB,GACpC,IAAI0kB,EAAajzD,KAAK3C,IAAI,IAAKkxC,EAAK,GAAIA,EAAK,KAC7CA,EAAK,IAAM0kB,EAAWuC,cAAcjnB,EAAK,IACzCA,EAAK,IAAM0kB,EAAWyC,eAAennB,EAAK,GAC7C,GAAEvuC,KACN,CA2PD,SAASk4D,GAAerO,EAASxsD,GAC7B,IAIIyrD,EAJAtqC,EAAUqrC,EAAQrrC,QACjBA,EAAQlL,QAIb2zC,EAAK4C,EAAQvpD,QAAQm3D,UAAU,SAAS9sD,EAAOvG,GAC3C0kD,EAAOD,EAASrqC,EAAQlL,MAAOlP,GAC3B/G,GACAwsD,EAAQoO,YAAYnP,GAAQtqC,EAAQlL,MAAMw1C,GAC1CtqC,EAAQlL,MAAMw1C,GAAQn+C,GAEtB6T,EAAQlL,MAAMw1C,GAAQe,EAAQoO,YAAYnP,IAAS,EAE/D,IACSzrD,IACDwsD,EAAQoO,YAAc,IAE7B,CA3QD1C,GAAQrxD,UAAY,CAMhBzD,IAAK,SAASH,GAaV,OAZAmL,EAAOzL,KAAKM,QAASA,GAGjBA,EAAQyyD,aACR/yD,KAAK+yD,YAAYplC,SAEjBrtB,EAAQwpD,cAER9pD,KAAKqwB,MAAMrtB,UACXhD,KAAKqwB,MAAMlyB,OAASmC,EAAQwpD,YAC5B9pD,KAAKqwB,MAAM65B,QAERlqD,IACV,EAQDm4D,KAAM,SAASC,GACXp4D,KAAK0qD,QAAQ2N,QAAUD,EA5Db,EADP,CA8DN,EAQDrL,UAAW,SAAS2E,GAChB,IAAIhH,EAAU1qD,KAAK0qD,QACnB,IAAIA,EAAQ2N,QAAZ,CAOA,IAAIpF,EAFJjzD,KAAK+yD,YAAYO,gBAAgB5B,GAGjC,IAAIsB,EAAchzD,KAAKgzD,YAKnBsF,EAAgB5N,EAAQ4N,gBAIvBA,GAAkBA,GAz8Bb,EAy8B8BA,EAAcpkD,SAClDokD,EAAgB5N,EAAQ4N,cAAgB,MAI5C,IADA,IAAInzD,EAAI,EACDA,EAAI6tD,EAAY5xD,QACnB6xD,EAAaD,EAAY7tD,GA9FnB,IAsGFulD,EAAQ2N,SACHC,GAAiBrF,GAAcqF,IAChCrF,EAAW4C,iBAAiByC,GAGhCrF,EAAW3kC,QAFX2kC,EAAWlG,UAAU2E,IAOpB4G,GAAqC,GAApBrF,EAAW/+C,QAC7BokD,EAAgB5N,EAAQ4N,cAAgBrF,GAE5C9tD,GA1CH,CA4CJ,EAODxE,IAAK,SAASsyD,GACV,GAAIA,aAAsBe,GACtB,OAAOf;CAIX,IADA,IAAID,EAAchzD,KAAKgzD,YACd7tD,EAAI,EAAGA,EAAI6tD,EAAY5xD,OAAQ+D,IACpC,GAAI6tD,EAAY7tD,GAAG7E,QAAQhB,OAAS2zD,EAChC,OAAOD,EAAY7tD,GAG3B,OAAO,IACV,EAQD9H,IAAK,SAAS41D,GACV,GAAIjM,EAAeiM,EAAY,MAAOjzD,MAClC,OAAOA,KAIX,IAAIu4D,EAAWv4D,KAAKW,IAAIsyD,EAAW3yD,QAAQhB,OAS3C,OARIi5D,GACAv4D,KAAKvC,OAAO86D,GAGhBv4D,KAAKgzD,YAAYzuD,KAAK0uD,GACtBA,EAAWpJ,QAAU7pD,KAErBA,KAAK+yD,YAAYplC,SACVslC,CACV,EAODx1D,OAAQ,SAASw1D,GACb,GAAIjM,EAAeiM,EAAY,SAAUjzD,MACrC,OAAOA,KAMX,GAHAizD,EAAajzD,KAAKW,IAAIsyD,GAGN,CACZ,IAAID,EAAchzD,KAAKgzD,YACnB38B,EAAQoyB,EAAQuK,EAAaC,IAElB,IAAX58B,IACA28B,EAAY38C,OAAOggB,EAAO,GAC1Br2B,KAAK+yD,YAAYplC,SAExB,CAED,OAAO3tB,IACV,EAQDmE,GAAI,SAASq0D,EAAQlwD,GACjB,GAAIkwD,IAAWzyD,GAGXuC,IAAYvC,EAAhB,CAIA,IAAIiyD,EAAWh4D,KAAKg4D,SAKpB,OAJA/Q,EAAKoB,EAASmQ,IAAS,SAASl5D,GAC5B04D,EAAS14D,GAAS04D,EAAS14D,IAAU,GACrC04D,EAAS14D,GAAOiF,KAAK+D,EACjC,IACetI,IAPN,CAQJ,EAQD2E,IAAK,SAAS6zD,EAAQlwD,GAClB,GAAIkwD,IAAWzyD,EAAf,CAIA,IAAIiyD,EAAWh4D,KAAKg4D,SAQpB,OAPA/Q,EAAKoB,EAASmQ,IAAS,SAASl5D,GACvBgJ,EAGD0vD,EAAS14D,IAAU04D,EAAS14D,GAAO+W,OAAOoyC,EAAQuP,EAAS14D,GAAQgJ,GAAU,UAFtE0vD,EAAS14D,EAIhC,IACeU,IAVN,CAWJ,EAOD+E,KAAM,SAASzF,EAAO0C,GAEdhC,KAAKM,QAAQi3D,WAkEzB,SAAyBj4D,EAAO0C,GAC5B,IAAIy2D,EAAe97D,EAAS8C,YAAY,SACxCg5D,EAAaC,UAAUp5D,GAAO,GAAM,GACpCm5D,EAAaE,QAAU32D,EACvBA,EAAK7D,OAAOwB,cAAc84D,EAC7B,CAtEWG,CAAgBt5D,EAAO0C,GAI3B,IAAIg2D,EAAWh4D,KAAKg4D,SAAS14D,IAAUU,KAAKg4D,SAAS14D,GAAO0F,QAC5D,GAAKgzD,GAAaA,EAAS52D,OAA3B,CAIAY,EAAKjF,KAAOuC,EACZ0C,EAAKwxD,eAAiB,WAClBxxD,EAAK6qD,SAAS2G,gBAC1B,EAGQ,IADA,IAAIruD,EAAI,EACDA,EAAI6yD,EAAS52D,QAChB42D,EAAS7yD,GAAGnD,GACZmD,GAVH,CAYJ,EAMDnC,QAAS;AACLhD,KAAKwe,SAAW05C,GAAel4D,MAAM,GAErCA,KAAKg4D,SAAW,GAChBh4D,KAAK0qD,QAAU,GACf1qD,KAAKqwB,MAAMrtB,UACXhD,KAAKwe,QAAU,IAClB,GAwCL/S,EAAO4pD,GAAQ,CACXwD,YAtoEc,EAuoEdC,WAtoEa,EAuoEbC,UAtoEY,EAuoEZC,aAtoEe,EAwoEfC,eAlrCiB,EAmrCjBC,YAlrCc,EAmrCdC,cAlrCgB,EAmrChBC,YAlrCc,EAmrCdC,iBAnrCc,EAorCdC,gBAlrCkB,GAmrClBvF,aAAcA,GAEdwF,eA9oEiB,EA+oEjB1F,eA9oEiB,EA+oEjB2F,gBA9oEkB,EA+oElB/P,aA9oEe,EA+oEfgQ,eA9oEiB,GA+oEjBjD,qBA7oEuB3C,EA8oEvBrK,mBAAoBA,EACpBkQ,cA7oEgBlD,GA+oEhBjB,QAASA,GACT3L,MAAOA,EACPgJ,YAAaA,GAEbtC,WAAYA,GACZtC,WAAYA,EACZa,kBAAmBA,GACnBgC,gBAAiBA,GACjBf,iBAAkBA,GAElBkE,WAAYA,GACZQ,eAAgBA,GAChBmF,IAAKzE,GACL0E,IAAKnF,GACLoF,MAAO5E,GACP6E,MAAOlF,GACPmF,OAAQ/E,GACRgF,MAAOnF,GAEP1wD,GAAIikD,EACJzjD,IAAK2jD,EACLrB,KAAMA,EACNQ,MAAOA,EACPF,OAAQA,EACR97C,OAAQA,EACRi8C,QAASA,EACTX,OAAQA,EACR8B,SAAUA,UAKsB,IAAXxqD,EAAyBA,EAA0B,oBAATqG,KAAuBA,KAAO,CAAE,GACxF2wD,OAASA,GAMuB36C,EAAOnV,QAC9CmV,EAAAnV,QAAiB8vD,GAEjBh3D,EAAiB,OAAIg3D,EAGxB,CA7kFD,CA6kFGh3D,OAAQ1B,eCziFI,SAASs9D,IAAQC,MAC9BA,EAAKC,MACLA,EAAKC,QACLA,EAAOC,mBACPA,EAAkBC,iCAClBA,EAAgCC,oBAChCA,IAEA,MAAMC,EAAmBN,EAAMz6B,KAAKpkB,KAAO,EACrCo/C,EAAqBN,EAAM16B,KAAKpkB,KAAO,EAE7C,OACE8B,GAAA,KAAA;AACEjC,UAAWC,GAKT,wCAEA,6CAGA,uBACA5J,SAAA,CAEDipD,GACC39C,GAAA,KAAA,CACE3B,UAAU,kDACV5H,MAAO,CAAE4L,IAAKg7C,EAAMj7C,UAAW1N,SAE/BsL,GAAC69C,GAAa,CACZ,cAAY,uBACZh+C,UAAU,KACVQ,QAASA,IACPo9C,EAAiC,IAAIJ,EAAMz6B,MAAO,MAEpDrhC,OAAQA,IAAMi8D,EAAmB,IACjCn8D,QAASA,IAAMm8D,EAAmB,IAAIH,EAAMz6B,OAC5Ck7B,aAAcA,IAAMN,EAAmB,IAAIH,EAAMz6B,OACjDm7B,WAAYA,IAAMP,EAAmB,IACrC3+C,MAAQ,8BAA6Bw+C,EAAMz6B,KAAKpkB,QAAQ9J,SAEvD2oD,EAAMz6B,KAAKpkB,SAIjB++C,EAAQv4D,KAAI,CAACg5D,EAAQxkC,IACpBxZ,GAAA,KAAA,CACE3B,UAAU,iDAEV5H,MAAO,CAAE4L,IAAK27C,EAAO57C,UAAW1N,SAEhCsL,GAAC69C,GAAa,CACZh+C,UAAU,OACVQ,QAAS5d,GACPi7D,EACE,IAAIM,EAAOp7B,MACXngC,EAAMzB,SAAWyB,EAAMvB,SAG3BK,OAAQA,IAAMi8D,EAAmB,IACjCn8D,QAASA,IAAMm8D,EAAmB,IAAIQ,EAAOp7B,OAC7Ck7B,aAAcA,IAAMN,EAAmB,IAAIQ,EAAOp7B,OAClDm7B,WAAYA,IAAMP,EAAmB,IACrC3+C,MAAQ,8BAA6Bm/C,EAAOp7B,KAAKpkB,QAAQ9J,SAExDspD,EAAOp7B,KAAKpkB,QAjBVgb,KAqBRokC,GACC59C,GAAA,KAAA,CACE3B,UAAU,uCACV5H,MAAO,CAAE4L,IAAKi7C,EAAMl7C,UAAW1N,SAE/BsL,GAAC69C,GAAa,CACZ,cAAY,yBACZh+C,UAAU;AACVQ,QAASA,IACPo9C,EAAiC,IAAIH,EAAM16B,MAAO,QAEpDrhC,OAAQA,IAAMi8D,EAAmB,IACjCn8D,QAASA,IAAMm8D,EAAmB,IAAIF,EAAM16B,OAC5Ck7B,aAAcA,IAAMN,EAAmB,IAAIF,EAAM16B,OACjDm7B,WAAYA,IAAMP,EAAmB,IACrC3+C,MAAQ,8BAA6By+C,EAAM16B,KAAKpkB,QAAQ9J,SAEvD4oD,EAAM16B,KAAKpkB,WAMxB,CCpHO,MAAMy/C,GAMXh7D,YACEke,GACAq8C,mBACEA,EAAkBC,iCAClBA,EAAgCC,oBAChCA,IAEFx6D,EAAAC,KAAA,yBAAA,GAAAD,EAAAC,KAAA,2BAAA,GAAAD,EAAAC,KAAA,yCAAA,GAAAD,EAAAC,KAAA,4BAAA,GACAA,KAAK+6D,kBAAoBp+D,SAASyY,cAAc,OAChD4I,EAAUhL,YAAYhT,KAAK+6D,mBAE3B/6D,KAAKg7D,oBAAsBX,EAC3Br6D,KAAKi7D,kCAAoCX,EACzCt6D,KAAKk7D,qBAAuBX,EAG5Bv6D,KAAK2tB,OAAO,GACd,CAEA3qB,UACE+Q,GAAO,KAAM/T,KAAK+6D,mBAClB/6D,KAAK+6D,kBAAkBt9D,QACzB,CAEAkwB,OAAOE,GACL,MAAMusC,E3CyFH,SAAwBe,GAE7B,MAAMC,EAAY,IAAIt0D,IAEhBu0D,EAAY,IAAIv0D,IAEhBszD,EAAU,GAIhB,IAAIkB,EAAgB,KAQpB,SAASC,GAAU7vC,OAAEA,EAAMqC,IAAEA,EAAG7O,IAAEA,IAGhC,MAAO,CACLwM,SACAzM,SAHqBC,GADFwM,EAASxM,GACc,EAI1CugB,KAAM,IAAI34B,IAAI,CAACinB,IACf7O,MAEJ,CAkEA,OA/DAi8C,EAAgBr6D,SAAQ06D,IACtB,GAAIA,EAAKt8C,IAjIgB,IAmIvB,YADAk8C,EAAU/9D,IAAIm+D,EAAKztC;CAEd,GAAIytC,EAAKt8C,IAAM7gB,OAAO+iB,YAnID,GAqI1B,YADAi6C,EAAUh+D,IAAIm+D,EAAKztC,KAIrB,IAAKutC,EAIH,YADAA,EAAgBC,EAAUC,IAK5B,MAAMC,EACJD,EAAKt8C,IAAMo8C,EAAcp8C,KAAOs8C,EAAK9vC,OAAS4vC,EAAc5vC,OAM9D,GAFmB8vC,EAAKt8C,IAAMo8C,EAAc5vC,OAlJxB,KAoJD+vC,EAGjBrB,EAAQ71D,KAAK+2D,GACbA,EAAgBC,EAAUC,OACrB,CAQL,MAAME,EACJF,EAAK9vC,OAAS4vC,EAAc5vC,OAAS8vC,EAAK9vC,OAAS4vC,EAAc5vC,OAC7DiwC,EAAgBD,EAAgBJ,EAAcp8C,IAEpDo8C,EAAc77B,KAAKpiC,IAAIm+D,EAAKztC,KAC5ButC,EAAc5vC,OAASgwC,EACvBJ,EAAcr8C,SAAWq8C,EAAcp8C,IAAMy8C,EAAgB,CAC/D,KAGEL,GACFlB,EAAQ71D,KAAK+2D,GAeR,CACLpB,MAZY,CACZz6B,KAAM27B,EACNn8C,SAtLyB,KAiMzBk7C,MAPY,CACZ16B,KAAM47B,EACNp8C,SAAU5gB,OAAO+iB,YA3LW,IAiM5Bg5C,UAEJ,C2C3LoBwB,CAAe/tC,GAC/B9Z,GACE8I,GAACo9C,GAAO,CACNC,MAAOE,EAAQF,MACfC,MAAOC,EAAQD,MACfC,QAASA,EAAQA,QACjBC,mBAAoB56B,GAAQz/B,KAAKg7D,oBAAoBv7B,GACrD66B,iCAAkCA,CAAC76B,EAAM/iB,IACvC1c,KAAKi7D,kCAAkCx7B,EAAM/iB,GAE/C69C,oBAAqBA,CAAC96B,EAAMo8B,IAC1B77D,KAAKk7D,qBAAqBz7B,EAAMo8B,KAGpC77D,KAAK+6D,kBAET,ECtCF,SAASe,IAAiB35D,QAAEA,EAAO45D,UAAEA,IAGnC,MAAM5mC,EACa,WAAjBhzB,EAAQpF,KACH,GAAEoF,EAAQpF,KAAKwlB,OAAO,GAAG+T,cAAgBn0B,EAAQpF,KAAKiI,MAAM,OAC7D,GAEN,IAAI+W,EACJ,OAAQ5Z,EAAQpF,MACd,IAAK,UACHgf,EAAOlC,GACP,MACF,IAAK,QACHkC,EAAOxC,GACP,MAEF,QACEwC,EAAOnC,GAWX,OAEEuD,GAACsT,GAAI,CACHpW,QAASc,GAAW,OAAQ,CAC1B,UAAWhZ,EAAQ65D,eACnB,mBAAqC,UAAjB75D,EAAQpF,KAC5B,uBAAyC,WAAjBoF,EAAQpF;AAChC,uBAAyC,YAAjBoF,EAAQpF,OAElCmgB,QAASA,IAAM6+C,EAAU55D,EAAQ0tB,IAAIte,UAErCsL,GAAA,MAAA,CACE3B,UAAWC,GAAW,mCAAoC,CACxD,eAAiC,UAAjBhZ,EAAQpF,KACxB,mBAAqC,WAAjBoF,EAAQpF,KAC5B,mBAAqC,YAAjBoF,EAAQpF,OAC3BwU,SAEHsL,GAACd,EAAI,CACHb,UAAWC,GAET,gBAINgC,GAAA,MAAA,CAAKjC,UAAU,WAAW,cAAY,qBAAoB3J,UACxDsL,GAAA,SAAA,CAAAtL,SAAS4jB,IACRhzB,EAAQA,QACRA,EAAQ85D,aACPp/C,GAAA,MAAA,CAAK3B,UAAU,aAAY3J,SACzBsL,GAAC6xB,GAAI,CACHxiC,KAAM/J,EAAQ85D,YACd/+C,QACE5d,GACEA,EAAMmf,kBAEVtgB,OAAO,OAAMoT,SACd,qBAQb,CAWe,SAAS2qD,IAAkBC,SACxCA,EAAQC,iBACRA,IAKA,OACEv/C,GAAA,MAAA,CAAAtL,SACEsL,GAAA,KAAA,CACE,YAAU,SACV,gBAAc,YACd3B,UAAU,6BAA4B3J,SAErC4qD,EAASt6D,KAAIM,GACZ0a,GAAA,KAAA,CACE3B,UAAWC,GACT,iDACA,CAOE,QAAShZ,EAAQ65D,eAGjB,8DACG75D,EAAQk6D,YAEX,iCAAkCl6D,EAAQk6D,YAC1C,mBAAoBl6D,EAAQk6D,cAE9B9qD,SAGFsL,GAACi/C,GAAgB;AAAC35D,QAASA,EAAS45D,UAAWK,KAF1Cj6D,EAAQ0tB,SAQzB,CC7Ie,SAASysC,IAAcvW,QAAEA,IACtC,MAAOoW,EAAUI,GAAe/rC,GAAyB,IACnDgsC,EAAarsC,IAChBssC,GAA6BF,GAAYG,GAAQ,IAAIA,EAAMD,MAC5D,IAEIE,EAAiBxsC,IACpBysC,GACCL,GAAYG,GAAQA,EAAK3lD,QAAO5U,GAAWA,EAAQ0tB,KAAO+sC,OAC5D,IAaF,OAVAzkD,IAAU,KACR4tC,EAAQE,UAAU,oBAAqBuW,GACvCzW,EAAQE,UAAU,wBAAyB0W,GAEpC,KACL5W,EAAQhR,YAAY,oBAAqBynB,GACzCzW,EAAQhR,YAAY,wBAAyB4nB,EAAe,IAE7D,CAAC5W,EAAS4W,EAAgBH,IAG3B3/C,GAACq/C,GAAiB,CAACC,SAAUA,EAAUC,iBAAkBO,GAE7D,CCXA,SAAS3/C,IAAgBlB,KAAMC,KAAS8gD,IACtC,OACEhgD,GAACb,GAAU,CACT3B,QAASc,GACP,oBACA,aACA,mCACA,gDACA,+BAEE0hD,EAAWtrD,SAEfsL,GAACd,EAAI,KAGX,CASA,SAAS+gD,IAAejZ,kBAAEA,IACxB,OACEhnC,GAAA,MAAA,CAAK3B,UAAU,UAAUS,KAAK,SAAS,cAAY,iBAAgBpK,SAChEsyC,EAAoB,qBAAuB,qBAGlD,CAwDe,SAASkZ,IAAQC,aAC9BA,EAAYrd,iBACZA,EAAgBsd,cAChBA,EAAaC,kBACbA,EAAiB5vD,eACjBA,EAAc6vD,iBACdA,EAAgBC,cAChBA,EAAaC,iBACbA,EAAgBC,mBAChBA,GAAqB,IAErB,OACEngD,GAAA,MAAA;AACEjC,UAAWC,GACT,qCACA,6BACA5J,UAOD+rD,GAAsBL,GACrBpgD,GAACb,GAAU,CACT3B,QAASc,GACP,yCACA,mDACA,kDAEA,aAGA,kBAEFO,MAAM,2BACNwB,QAAS8/C,EAAazrD,SAEtBsL,GAACtD,GAAU,OAGb+jD,GACAngD,GAAAI,EAAA,CAAAhM,SAAA,CACEsL,GAACb,GAAU,CACT3B,QAASc,GAEP,6BACA,yCAGA,qBAEFL,WAAYuiD,EACZ3hD,MAAM,qBACNF,SAAUyhD,EACVxhD,QAASwhD,EACT//C,QAASkgD,EAAc7rD,SAENsL,GAAhBogD,EAAiBtjD,GAAqBD,GAAJ,CAAA,KAErCyD,GAAA,MAAA,CAAKjC,UAAU,yBAAwB3J,SAAA,CACrCsL,GAACG,GAAa,CACZtB,MAAM,kBACNI,KAAMxO,EAAiB6M,GAAWL,GAClCyjD,SAAUjwD,EACV4P,QAASigD,IAEXtgD,GAACG,GAAa,CACZtB,MACwB,SAAtBwhD,EACI,gBACA,iBAENphD,KAA4B,SAAtBohD,EAA+BljD,GAAWnB,GAChDqE,QAASyiC,OAGb9iC,GAACigD,GAAc,CAACjZ,kBAAmBv2C,SAK7C,CCpLO,MAAMkwD,GAeX19D,YAAYke,EAAwB1d,GAAyBP,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,2BAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,oBAAA;AAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,sBAAA,GAAAD,EAAAC,KAAA,yBAAA,GAAAD,EAAAC,KAAA,yBAAA,GAAAD,EAAAC,KAAA,4BAAA,GAC3D,MAAM2/C,iBAAEA,EAAgB8d,eAAEA,EAAcpb,qBAAEA,GAAyB/hD,EAEnEN,KAAK09D,WAAa1/C,EAClBhe,KAAK29D,qBAAsB,EAC3B39D,KAAK49D,mBAAqB,OAC1B59D,KAAKs/C,oBAAqB,EAC1Bt/C,KAAK69D,cAAe,EAEpB79D,KAAK89D,cAAgB,IAAML,GAAe,GAC1Cz9D,KAAK+9D,eAAiB,IAAMN,GAAgBz9D,KAAK69D,cACjD79D,KAAKg+D,kBAAoB,IACvB3b,GAAsBriD,KAAKs/C,oBAC7Bt/C,KAAKi+D,kBAAoB,KACvBte,IACA8d,GAAe,EAAK,EAItBz9D,KAAKk+D,qBxFnDmsB,CAACtoD,QAAQ,MwFqDjtB5V,KAAK+T,QACP,CAEAoqD,WAEE,OADgBn+D,KAAK09D,WAAWznD,WACjB0K,wBAAwB3H,KACzC,CAMIskD,uBAAmBc,GACrBp+D,KAAK29D,oBAAsBS,EAC3Bp+D,KAAK+T,QACP,CAEIupD,yBACF,OAAOt9D,KAAK29D,mBACd,CAKIU,gBAAYC,GACdt+D,KAAK69D,aAAeS,EACpBt+D,KAAK+T,QACP,CAEIsqD,kBACF,OAAOr+D,KAAK69D,YACd,CAOIX,sBAAkBngE,GACpBiD,KAAK49D,mBAAqB7gE,EAC1BiD,KAAK+T,QACP,CAEImpD,wBACF,OAAOl9D,KAAK49D,kBACd;AAKI/Z,sBAAkBF,GACpB3jD,KAAKs/C,mBAAqBqE,EAC1B3jD,KAAK+T,QACP,CAEI8vC,wBACF,OAAO7jD,KAAKs/C,kBACd,CAKIif,0BACF,OAAOv+D,KAAKk+D,qBAAqBtoD,OACnC,CAEA7B,SACEA,GACE8I,GAACkgD,GAAO,CACNC,aAAch9D,KAAK89D,cACnBne,iBAAkB3/C,KAAKi+D,kBACvBf,kBAAmBl9D,KAAK49D,mBACxBX,cAAej9D,KAAK69D,aACpBvwD,eAAgBtN,KAAKs/C,mBACrB6d,iBAAkBn9D,KAAKg+D,kBACvBZ,cAAep9D,KAAK+9D,eACpBV,iBAAkBr9D,KAAKk+D,qBACvBZ,mBAAoBt9D,KAAKs9D,qBAE3Bt9D,KAAK09D,WAET,ECvGK,MAAMc,GAAa,IAmEnB,MAAMC,GA8CX3+D,YACE0e,EACA6rB,EACAl/B,GAWA,GAVApL,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,kBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,sBAAA,GAAAD,EAAAC,KAAA,0BAAA,GAAAD,EAAAC,KAAA,wBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,oBAAA,GAAAD,EAAAC,KAAA,2BAAA,GAAAD,EAAAC,KAAA,mBAAA,GAAAD,EAAAC,KAAA,iBAAA;AAAAD,EAAAC,KAAA,iBAAA,GAAAD,EAAAC,KAAA,gBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,eAAA,GAAAD,EAAAC,KAAA,sBAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,uBAAA,GAAAD,EAAAC,KAAA,wBAAA,GAAAD,EAAAC,KAAA,qBAAA,GAAAD,EAAAC,KAAA,sBAAA,GAAAD,EAAAC,KAAA,cAAA,GACAA,KAAK4G,SAAWyjC,EAAS2b,gBACzBhmD,KAAK0+D,oBAAsB,KAC3B1+D,KAAK2+D,UAAY,GACjB3+D,KAAKygD,YAAc,IAAIr3C,EACvBpJ,KAAK4+D,OArFT,SAA6BzzD,GAC3B,MAAM0zD,EAAa1zD,EAAOoC,cACpBuxD,EAAgB9a,GACpB6a,EACAxa,GAAgBwa,EAAY1zD,IAGxB4zD,EAAepiE,SAASyY,cAAc,UAS5C,OANA2pD,EAAazhE,aAAa,kBAAmB,IAE7CyhE,EAAapwB,IAAMmwB,EACnBC,EAAarjD,MAAQ,+BACrBqjD,EAAa7jD,UAAY,gBAElB6jD,CACT,CAoEkBC,CAAoB7zD,GAClCnL,KAAKq2C,QAAUlrC,EACfnL,KAAKi/D,UAAY,KACjBj/D,KAAKyxB,SAAW,IAAIjD,GAEhBrjB,EAAO2D,0BAA2B,CAAA,IAAAsP,EACpCpe,KAAKk/D,cACqD,QADxC9gD,EAChBzhB,SAASsP,cAAcd,EAAO2D,kCAA0BsP,IAAAA,EAAAA,EAAII,EAC9Dxe,KAAKk/D,cAAclsD,YAAYhT,KAAK4+D,OACtC,KAAO,CACL5+D,KAAKm/D,gBAAkBxiE,SAASyY,cAAc,OAC9CpV,KAAKm/D,gBAAgB7rD,MAAMulC,QAAU;AACrC74C,KAAKm/D,gBAAgBjkD,UAAY,oBAEZ,UAAjB/P,EAAOmD,MACTtO,KAAKm/D,gBAAgBtiE,UAAUQ,IAAI,eAEnC2C,KAAKi/D,UAAY,IAAInE,GAAU96D,KAAKm/D,gBAAiB,CACnD9E,mBAAoB56B,GAClBz/B,KAAK2+D,UAAU79D,SAAQs+D,GAAOA,EAAIn6D,KAAK,mBAAoBw6B,KAC7D66B,iCAAkCA,CAAC76B,EAAM/iB,IACvC1c,KAAK2+D,UAAU79D,SAAQs+D,GACrBA,EAAIn6D,KAAK,iCAAkCw6B,EAAM/iB,KAErD69C,oBAAqBA,CAAC96B,EAAMpU,IAC1BrrB,KAAK2+D,UAAU79D,SAAQs+D,GACrBA,EAAIn6D,KAAK,oBAAqBw6B,EAAMpU,OAK5CrrB,KAAKm/D,gBAAgBnsD,YAAYhT,KAAK4+D,QAItC5+D,KAAKq/D,mBAAqB1iE,SAASyY,cAAc,sBACjD,MAAM6I,EAAaF,GAAiB/d,KAAKq/D,oBACzCphD,EAAWjL,YAAYhT,KAAKm/D,iBAE5B3gD,EAAQxL,YAAYhT,KAAKq/D,oBAIzBr/D,KAAKs/D,iBAAmB3iE,SAASyY,cAAc,OAC/C6I,EAAWjL,YAAYhT,KAAKs/D,kBAC5BvrD,GAAO8I,GAACy/C,GAAa,CAACvW,QAAS/lD,KAAK4G,WAAc5G,KAAKs/D,iBACzD,CAGIt/D,KAAK4+D,OAAOjqB,eACdpuC,EAAavG,KAAK4+D,OAAOjqB,eAG3B30C,KAAKC,WAAa,IAAIJ,EAGtB,MAAM0/D,EAAmB5iE,SAASyY,cAAc,OAChDpV,KAAKw/D,QAAU,IAAIhC,GAAkB+B,EAAkB,CACrD5f,iBAAkBA,KAAM,IAAA8f,EACtB,GAA8B,IAA1Bz/D,KAAK2+D,UAAUv9D,OACjB;EAGkC,QAA3Bq+D,EAAGz/D,KAAK0+D,2BAAmB,IAAAe,EAAAA,EAAIz/D,KAAK2+D,UAAU,IACnD15D,KAAK,mBAAmB,EAE9Bw4D,eAAgBa,GAASA,EAAOt+D,KAAKs+D,OAASt+D,KAAKiK,QACnDo4C,qBAAsBjiC,GAAQpgB,KAAKqiD,qBAAqBjiC,KAGrC,UAAjBjV,EAAOmD,MACTtO,KAAKw/D,QAAQlC,oBAAqB,EAElCt9D,KAAKw/D,QAAQlC,oBAAqB,EAGhCt9D,KAAKm/D,iBAEPn/D,KAAKm/D,gBAAgBzsB,QAAQ6sB,GAC7Bv/D,KAAK0/D,cAAgB1/D,KAAKw/D,QAAQrB,YAIlCn+D,KAAK0/D,cAAgB,EAGvB1/D,KAAKC,WAAW5C,IAAIgB,OAAQ,UAAU,IAAM2B,KAAK2/D,cAEjD3/D,KAAK4/D,cAAgB,CACnBC,QAAS,KACTC,MAAO,MAET9/D,KAAK+/D,iBACL//D,KAAKiK,QAGL,MAAO+1D,GAAiB70D,EAAOyD,UAAY,GACvCoxD,IACFhgE,KAAK0kD,eAAiBsb,EAActb,eACpC1kD,KAAK4kD,gBAAkBob,EAAcpb,gBACrC5kD,KAAK8kD,gBAAkBkb,EAAclb,gBACrC9kD,KAAKglD,iBAAmBgb,EAAchb,iBACtChlD,KAAKklD,cAAgB8a,EAAc9a,eAGrCllD,KAAKwO,eAAiBrD,EAAOqD,eAE7BxO,KAAKigE,aAAe,CAClBzkD,UAAU,EACVxC,MAAO,EACPC,OAAQ,EACRi6B,aAAc,GAIhBlzC,KAAKkgE,oBAAmB,GACxBlgE,KAAKmgE,qBACP,CAEAn9D,UAAU,IAAAo9D,EAAAC,EACRrgE,KAAK2+D,UAAU79D,SAAQs+D,GAAOA,EAAIp8D,YAClChD,KAAKygD,YAAYz9C;AACH,QAAdo9D,EAAIpgE,KAACi/D,iBAALmB,IAAcA,GAAdA,EAAgBp9D,UAChBhD,KAAKC,WAAWY,YACG,QAAnBw/D,EAAIrgE,KAACsgE,sBAALD,IAAmBA,GAAnBA,EAAqBr9D,UACjBhD,KAAKq/D,oBAEPtrD,GAAO,KAAM/T,KAAKs/D,kBAClBt/D,KAAKq/D,mBAAmB5hE,UAExBuC,KAAK4+D,OAAOnhE,SAEduC,KAAK4G,SAAS5D,UAGduD,EAAa,KACf,CAKAg6D,iBAAiB59D,EAA6B+F,GAC5C,OAAQ/F,GACN,IAAK,QACH3C,KAAKwgE,cAAc93D,GACnB,MACF,IAAK,UACH1I,KAAKygD,YAAY32C,QAAQpB,GAG/B,CAEA83D,cAAc93D,GACZ,MAAM+3D,EAAW,IAAIr3D,EAErBq3D,EAASt8D,GAAG,gBAAgB,KAC1BnE,KAAK0+D,oBAAsB+B,EAC3BzgE,KAAKw/D,QAAQtC,kBAAoB,aACjCl9D,KAAK2+D,UACF5nD,QAAOrO,GAAQA,IAAS+3D,IACxB3/D,SAAQs+D,GAAOA,EAAIn6D,KAAK,mBAAkB,IAG/Cw7D,EAASt8D,GAAG,kBAAkB,KAC5BnE,KAAK0+D,oBAAsB,KAC3B1+D,KAAKw/D,QAAQtC,kBAAoB,OACjCl9D,KAAK2+D,UACF5nD,QAAOrO,GAAQA,IAAS+3D,IACxB3/D,SAAQs+D,GAAOA,EAAIn6D,KAAK,mBAAkB,IAG/Cw7D,EAASt8D,GAAG,4BAA6Bw/C,IACvC3jD,KAAKqiD,qBAAqBsB,EAAQ,IAKpC,MAAMsb,EAAYj/D,KAAKi/D,UAEnBA,GACFwB,EAASt8D,GAAG,kBAAmB0pB,IACY,IAArC7tB,KAAK2+D,UAAUjtD,QAAQ+uD,IACzBxB,EAAUtxC,OAAOE,EACnB,IAIJ4yC,EAASt8D,GAAG,SAAS,KACnBs8D,EAASz9D;AACLy9D,IAAazgE,KAAK0+D,sBACpB1+D,KAAK0+D,oBAAsB,MAE7B1+D,KAAK2+D,UAAY3+D,KAAK2+D,UAAU5nD,QAAOqoD,GAAOA,IAAQqB,GAAS,IAGjEA,EAAS32D,QAAQpB,GACjB1I,KAAK2+D,UAAUp6D,KAAKk8D,GAEpBA,EAASx7D,KAAK,uBAAwBjF,KAAKigE,aAC7C,CAEAE,sBCjVK,IACLO,IDiVmB/jE,SAAS+5B,KAAM12B,KAAKygD,YC9UnCt8C,GAAG,gCAEP,SAAoCw8D,GAClC,MAAMC,EAAQF,EAAOr1D,iBAAkB,sCACvC1J,MAAMC,KAAKg/D,GAAO9/D,SAAQq1B,IACxBA,EAAK3qB,YAAcm1D,EAASx/D,UAAU,GAE1C,ICnBK,SAAwBu/D,EAAiBG,GAC9C,MAAMC,EAAeJ,EAAOr1D,iBAC1B,6BAGF1J,MAAMC,KAAKk/D,GAAchgE,SAAQigE,IAC/BA,EAAYpiE,iBAAiB,SAASf,IACpCijE,IACAjjE,EAAE6gB,iBAAiB,GACnB,GAEN,CFgVIuiD,CAAerkE,SAAS+5B,MAAM,IAAM12B,KAAKs+D,SAEzCt+D,KAAKygD,YAAYt8C,GACf,uBACC0qB,GAAmC7uB,KAAKyxB,SAAS9D,OAAOkB,KAG3D7uB,KAAKygD,YAAYt8C,GAAG,WAAW,KAEzBnE,KAAKm/D,kBACPn/D,KAAKm/D,gBAAgB7rD,MAAMulC,QAAU,IAGvC,MAAMvrC,EAAiD,WAAhCtN,KAAKq2C,QAAQ/oC,eACpCtN,KAAKqiD,qBAAqB/0C,IAGxBtN,KAAKq2C,QAAQ5nC,aACbzO,KAAKq2C,QAAQzpC,aACb5M,KAAKq2C,QAAQ7oC,OACbxN,KAAKq2C,QAAQppC,QAEbjN,KAAKs+D,MACP;AAGFt+D,KAAKygD,YAAYt8C,GAAG,kBAAkB,IACpCnE,KAAKqiD,sBAAqB,KAG5BriD,KAAKygD,YAAYt8C,GAAG,eAAe,IAAMnE,KAAKs+D,SAE9Ct+D,KAAKygD,YAAYt8C,GAAG,gBAAgB,IAAMnE,KAAKiK,UAK/CjK,KAAKygD,YAAYt8C,GAAG,gBAAiBkhD,IACnCrlD,KAAKmgB,OACLngB,KAAK4G,SAAS0/C,QAAQ,eAAgBjB,EAAQ,IAEhDrlD,KAAKygD,YAAYt8C,GAAG,eAAe,KACjCnE,KAAKmgB,OACLngB,KAAK4G,SAAS0/C,QAAQ,cAAc,IAEtCtmD,KAAK4G,SAASq/C,UAAU,gBAAgB,KACtCjmD,KAAKogB,MAAM,IAGbpgB,KAAK4G,SAASq/C,UAAU,iBAAiB,KACvCjmD,KAAKogB,MAAM,IAMbpgB,KAAKygD,YAAYt8C,GAAG,qBAAsBs4D,IACxCz8D,KAAK4G,SAAS0/C,QAAQ,oBAAqBmW,EAAW,IAExDz8D,KAAKygD,YAAYt8C,GAAG,yBAA0By4D,IAC5C58D,KAAK4G,SAAS0/C,QAAQ,wBAAyBsW,EAAU,IAMc,CACvE,CAAC,iBAAkB58D,KAAK0kD,gBACxB,CAAC,kBAAmB1kD,KAAK4kD,iBACzB,CAAC,kBAAmB5kD,KAAK8kD,iBACzB,CAAC,mBAAoB9kD,KAAKglD,kBAC1B,CAAC,gBAAiBhlD,KAAKklD,gBAEXpkD,SAAQ,EAAExB,EAAOgJ,MACzBA,GACFtI,KAAKygD,YAAYt8C,GAAG7E,GAAO,IAAMgJ,KACnC,GAEJ,CAEA24D,qBACEjhE,KAAK4/D,cAAgB,CAAEC,QAAS,KAAMC,MAAO,KAC/C;AAEAC,iBACE,MAAMmB,EAAelhE,KAAKw/D,QAAQjB,oBAC9B2C,IACFlhE,KAAKsgE,eAAiB,IAAIjL,GAAcE,QAAC2L,GACzClhE,KAAKsgE,eAAen8D,GAClB,oCAEA7E,GAASU,KAAKmhE,OAAO7hE,KAEvBU,KAAKsgE,eAAejjE,IAClB,IAAIg4D,OAAW,CAAE34C,UAAW24C,GAAOmB,wBAGzC,CAGA4K,gBAEMphE,KAAKqhE,eAKTrhE,KAAKqhE,aAAepqD,uBAAsB,KAGxC,GAFAjX,KAAKqhE,kBAAet7D,EAGlB/F,KAAK4/D,cAAcE,QAAU9/D,KAAK4/D,cAAcC,SAChD7/D,KAAKm/D,gBACL,CACA,MAAMmC,EAAiBthE,KAAK4/D,cAAcE,MACpC9mD,GAASsoD,EACfthE,KAAKm/D,gBAAgB7rD,MAAMwxB,WAAc,GAAEw8B,MACvCtoD,GAASwlD,KACXx+D,KAAKm/D,gBAAgB7rD,MAAM0F,MAAS,GAAEA,OAExChZ,KAAKkgE,oBACP,KAEJ,CAaAA,mBAAmB1kD,GAAoB,IAAA+lD,EAAAC,EAUrC,MAAMtuB,EAAgBlzC,KAAKm/D,iBAAmBn/D,KAAKw/D,QAAQrB,YAAe,EACpE1pB,EAAqC8sB,QAAvBA,EAAGvhE,KAAKm/D,uBAAeoC,IAAAA,EAAAA,EAAIvhE,KAAKk/D,eAC9CjmD,OAAEA,GAAWw7B,EAAM9zB,wBACnB8gD,EAAgBpjE,OAAOqjB,iBAAiB+yB,GACxCz7B,EAAQ7P,SAASs4D,EAAczoD,OAC/B2sB,EAAax8B,SAASs4D,EAAc38B,YAI1C,IAAI48B,EAAoBxuB,EAEA,kBAAb13B,EACLA,IACFkmD,GAAqB1oD,IAGnB2sB,EAAa64B,GACfkD,GAAqB/7B,EAErB+7B,GAAqB1oD,EAKvBwC,EAAWkmD,EAAoBxuB,GAGjC,MAAMyuB,EAA6B,CACjCnmD,WACAxC,MAAOwC,EAAWkmD,EAAoBxuB,EACtCj6B,SACAi6B,gBAGFlzC,KAAKigE,aAAe0B;AACDH,QAAnBA,EAAAxhE,KAAKwO,sBAALgzD,IAAmBA,GAAnBA,EAAAv8D,KAAIjF,KAAkB2hE,GAEtB3hE,KAAK2+D,UAAU79D,SAAQs+D,GACrBA,EAAIn6D,KAAK,uBAAwB08D,IAErC,CAKAhC,aACmC,IAA7B3/D,KAAKw/D,QAAQnB,cACXhgE,OAAOijB,WAAak9C,GACtBx+D,KAAKiK,QAELjK,KAAKs+D,OAGX,CAEA6C,OAAO7hE,GACL,MAAMm1C,EAAQz0C,KAAKm/D,gBACnB,GAAK1qB,EAIL,OAAQn1C,EAAMvC,MACZ,IAAK,WACHiD,KAAKihE,qBAGLxsB,EAAM53C,UAAUQ,IAAI,yBAGpBo3C,EAAMnhC,MAAMy7C,cAAgB,OAE5B/uD,KAAK4/D,cAAcC,QAAU12D,SAC3BuY,iBAAiB+yB,GAAO3P,YAG1B,MACF,IAAK,SACH2P,EAAM53C,UAAUY,OAAO,yBAGvBg3C,EAAMnhC,MAAMy7C,cAAgB,GAIG,OAA7B/uD,KAAK4/D,cAAcE,OACnB9/D,KAAK4/D,cAAcE,QAAS,IAE5B9/D,KAAKs+D,OAELt+D,KAAKiK,QAEPjK,KAAKihE,qBACL,MACF,IAAK,UACL,IAAK,WAAY,CACf,GAA0C,iBAA/BjhE,KAAK4/D,cAAcC,QAC5B,OAGF,MAAMyB,EAASthE,KAAK4/D,cAAcC,QAC5B+B,EAAQtiE,EAAMosD,OACpB1rD,KAAK4/D,cAAcE,MAAQ/+C,KAAKC,IAAID,KAAK8lC,MAAMya,EAASM,GAAQ,GAChE5hE,KAAKohE,gBACL,KACF,EAEJ,CAEA9C,OAGE,GAFAt+D,KAAKygD,YAAYx7C,KAAK,iBAElBjF,KAAKm/D,gBAAiB,CACxB,MAAMnmD,EAAQhZ,KAAKm/D,gBAAgBx+C,wBAAwB3H;CAC3DhZ,KAAKm/D,gBAAgB7rD,MAAMwxB,YAAiB,EAAI9rB,EAAP,KACzChZ,KAAKm/D,gBAAgBtiE,UAAUY,OAAO,oBACxC,CAEAuC,KAAKw/D,QAAQnB,aAAc,EAES,oBAAhCr+D,KAAKq2C,QAAQ/oC,gBACftN,KAAKqiD,sBAAqB,GAG5BriD,KAAKkgE,oBAAmB,EAC1B,CAEAj2D,QACEjK,KAAKygD,YAAYx7C,KAAK,iBAElBjF,KAAKm/D,kBACPn/D,KAAKm/D,gBAAgB7rD,MAAMwxB,WAAa,GACxC9kC,KAAKm/D,gBAAgBtiE,UAAUQ,IAAI,sBAGrC2C,KAAKw/D,QAAQnB,aAAc,EAES,oBAAhCr+D,KAAKq2C,QAAQ/oC,gBACftN,KAAKqiD,sBAAqB,GAG5BriD,KAAKkgE,oBAAmB,EAC1B,CAKA7d,qBAAqBsB,GACnB3jD,KAAKw/D,QAAQ3b,kBAAoBF,EAGjC3jD,KAAKygD,YAAYx7C,KAAK,uBAAwB0+C,EAChD,CAKAvjC,OAAO,IAAAyhD,UACLA,EAAA7hE,KAAKm/D,uBAAe,IAAA0C,GAApBA,EAAsBhlE,UAAUY,OAAO,YACzC,CAKA0iB,OAAO,IAAA2hD,UACLA,EAAA9hE,KAAKm/D,uBAAe,IAAA2C,GAApBA,EAAsBjlE,UAAUQ,IAAI,YACtC,EG/oBK,MAAM0kE,GAIXjiE,YAAYimD,GACV/lD,KAAK4G,SAAWm/C,EAGhB/lD,KAAKgiE,eAAiB,EACxB,CAQA1b,QAAQhnD,KAAU8I,GAChBpI,KAAK4G,SAAS7B,KAAKzF,KAAU8I,EAC/B,CAQA69C,UAAU3mD,EAAO+E,GACfrE,KAAK4G,SAASzC,GAAG7E,EAAO+E,GACxBrE,KAAKgiE,eAAez9D,KAAK,CAACjF,EAAO+E,GACnC,CAQA0wC,YAAYz1C,EAAO+E;AACjBrE,KAAK4G,SAASjC,IAAIrF,EAAO+E,GACzBrE,KAAKgiE,eAAiBhiE,KAAKgiE,eAAejrD,QACxC,EAAEkrD,EAAUC,KACVD,IAAa3iE,GAAS4iE,IAAgB79D,GAE5C,CAKArB,UACE,IAAK,IAAK1D,EAAO+E,KAAarE,KAAKgiE,eACjChiE,KAAK4G,SAASjC,IAAIrF,EAAO+E,GAE3BrE,KAAKgiE,eAAiB,EACxB,EAGK,MAAMG,GACXriE,cACEE,KAAK4G,SAAW,IAAIpB,CACtB,CAEAwgD,gBACE,OAAO,IAAI+b,GAAQ/hE,KAAK4G,SAC1B,EC5CF,MAAMw7D,GAAqBzlE,SAASsP,cAClC,0DAiGO,IAAI5I,SAAQC,IACW,YAAxB3G,SAASk5C,YACXvyC,IAIF3G,SAASgC,iBAAiB,oBAAoB,IAAM2E,KAAU,IAIlDoT,MA5FhB,WACE,MAAM2rD,EAAkBtzD,EAAU,aAElC,IAAIuzD,EAAyBA,OAC7B,MAAMC,EAAkB,IAAIl/D,SAAcC,IACxCg/D,EAAyBh/D,CAAO,IAElC8+D,GAAmBzjE,iBAAiB,UAAW2jE,GAE/C,MAAM5/D,EAAY2/D,EAAgBxzD,mBAAqBxQ,OAAOsL,OAAStL,OAEjEmkE,EAAe,GAErB,GAAI9/D,IAAcrE,OAAQ,CAExB,MAAMokE,EtGqBH,SAELz5D,EAAYK,UAAUL,WAEtB,IAAKD,EAA0BC,GAC7B,MAAO,OAIT,MAAMV,EAAUhJ,IAAS,IAAAojE,EACvB,GAAyB,0BAAX,QAAVA,EAAApjE,EAAM0C,YAAN0gE,IAAUA,OAAVA,EAAAA,EAAY3lE,OAAmCuC,EAAM0E,MAAM,GAAI,CACjE,MAAM0E,EAAOpJ,EAAM0E,MAAM,GACzByE,EAASC,EAAM,SACfA,EAAKuB,OACP,GAIF,OADA5L,OAAOM,iBAAiB,UAAW2J,GAC5B,IAAMjK,OAAOS,oBAAoB,UAAWwJ,EACrD,CsGxC6Bq6D,GACzBH,EAAaj+D,KAAK,CAAEvB,QAASy/D;CAE7B,MAAMG,EAAgB7zD,EAAU,WAE1BrI,EAAuB,IAAI23B,IAAIukC,EAAcr1D,eAAe/F,OAC5Dq7D,EAAe,IAAIp8D,EAAaC,GAEhC2jC,EAAW,IAAI83B,GACfhzD,EAAU,IAAIsvD,GAAQ9hE,SAAS+5B,KAAM2T,EAAUu4B,GAC/CxzD,EAAW,IAAIm3C,GACnB5pD,SAAS+5B,KACT2T,EACAt7B,EAAU,aAENM,EAAU,IAAIo3C,GAClB9pD,SAAS+5B,KACT2T,EACAt7B,EAAU,YAGZ8zD,EAAa1+D,GAAG,kBAAkB,CAACxB,EAAQ+F,IACzCyG,EAAQoxD,iBAAiB59D,EAAQ+F,KAEnC85D,EAAaj+D,KAAKs+D,EAAc1zD,EAASC,EAAUC,EACrD,CAGA,GAAoB,cADA6qC,KACa,CAC/B,MAAM4oB,EAAsB,IAAIxoB,GAAoB+nB,GACpDG,EAAaj+D,KAAKu+D,EACpB,KAAO,CAEL,MAAMC,EAAqB,IAAI3sB,GAC7Bz5C,SAAS+5B,KACT2rC,GAIIW,EAAQ,IAAIhkB,GAAMriD,SAAS+5B,KAAM2rC,EAAiB3/D,GAIxDsgE,EAAM7+D,GAAG,mBAAoBm+D,GAE7BE,EAAaj+D,KAAKw+D,EAAoBC,EACxC,CAEAT,EAAgB7rD,MAAK,KACnB8rD,EAAa1hE,SAAQmiE,GAAYA,EAASjgE,YAIrBrG,SAAS0O,iBAAiB,2BAClCvK,SAAQpE,GAAMA,EAAGe,WxB5D3B,SAAqCw8C,EAAsBt9C,UAC1CgF,MAAMC,KAC1Bq4C,EAAU5uC,iBACR,uDAGUvK,SAAQpE,GAAMA,EAAGe,UACjC,CwByDIylE,EAA6B,GAEjC"}